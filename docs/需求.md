# War3地图编辑器需求文档

## 1. 概述

本文档详细描述了War3地图编辑器的各项功能需求，特别关注可视化交互、地图数据结构转换以及地图打包功能。

## 2. 可视化交互部分

### 2.1 主界面布局

主界面采用经典的四区域布局设计：

```
+----------------------------------------------------------+
| 菜单栏 (文件、编辑、视图、工具、帮助)                     |
+------------------+---------------------------------------+
| 工具面板         |                                       |
| (左侧)           |        3D视图窗口                      |
|                  |                                       |
| - 选择工具        |                                       |
| - 地形编辑工具     |                                       |
| - 放置物工具      |                                       |
| - 单位编辑工具     |                                       |
| - 触发器编辑器     |                                       |
| - 区域编辑工具     |                                       |
|                  |                                       |
| 对象属性面板      |                                       |
| (可折叠)         |                                       |
+------------------+---------------------------------------+
| 状态栏 (坐标、选中对象信息、FPS等)                        |
+----------------------------------------------------------+
```

### 2.2 核心交互功能

#### 2.2.1 视图控制
- 鼠标左键拖拽：旋转视角
- 鼠标右键拖拽：平移视角
- 鼠标滚轮：缩放视角
- 键盘WASD：在平面内移动视角
- 空格键：上升视角
- Ctrl键：下降视角
- F键：聚焦选中对象
- 数字键1-9：快速切换工具

#### 2.2.2 选择交互
- 单击选择：点击对象进行选择
- 框选选择：按住Shift键拖拽进行框选
- 多选：按住Ctrl键进行多选
- 取消选择：点击空白区域或按ESC键

#### 2.2.3 对象操作
- 移动：选中对象后拖拽或使用方向键微调
- 旋转：选中对象后使用R键进入旋转模式，拖拽进行旋转
- 缩放：选中对象后使用S键进入缩放模式，拖拽进行缩放
- 删除：选中对象后按Delete键
- 复制/粘贴：Ctrl+C复制，Ctrl+V粘贴

### 2.3 工具系统

#### 2.3.1 选择工具
- 基本选择功能
- 对象信息显示
- 快捷属性编辑

#### 2.3.2 地形编辑工具
- 笔刷模式：不同大小和强度的笔刷
- 平整工具：将地形平整到指定高度
- 噪声工具：添加自然的地形噪声
- 材质刷：更改地表材质

#### 2.3.3 放置物工具
- 对象库浏览：分类显示所有可用的放置物
- 预览功能：在放置前预览对象效果
- 随机化：随机变换对象的旋转和缩放

#### 2.3.4 单位编辑工具
- 单位库浏览：显示所有可用单位和物品
- 队伍分配：为单位分配所属队伍
- 属性编辑：编辑单位的生命值、魔法值等属性

### 2.4 属性面板

属性面板分为多个标签页：
- 基础属性：名称、位置、旋转、缩放等
- 高级属性：根据对象类型显示特定属性
- 自定义属性：用户自定义的属性字段

面板支持实时预览，修改属性后立即在3D视图中反映。

## 3. 地图转换成可编辑结构

### 3.1 数据结构设计

地图数据将被转换为统一的JSON结构，便于编辑和保存：

```json
{
  "metadata": {
    "name": "地图名称",
    "author": "作者",
    "description": "描述",
    "version": "版本号"
  },
  "terrain": {
    "size": [256, 256],
    "tileset": "A",
    "corners": [
      [
        {
          "layerHeight": 0,
          "waterLevel": 0,
          "groundHeight": 0,
          "waterHeight": 0,
          "flags": 0,
          "texture": 0,
          "variation": 0
        }
      ]
    ]
  },
  "doodads": [
    {
      "id": "DOOB",
      "variation": 0,
      "location": [0, 0, 0],
      "angle": 0,
      "scale": [1, 1, 1],
      "skinId": 0,
      "flags": 0,
      "life": 100,
      "editorId": 1
    }
  ],
  "units": [
    {
      "id": "hfoo",
      "variation": 0,
      "location": [0, 0, 0],
      "angle": 0,
      "scale": [1, 1, 1],
      "skinId": 0,
      "flags": 0,
      "editorId": 1,
      "life": 100,
      "mana": 0,
      "playerId": 0
    }
  ],
  "triggers": [
    {
      "name": "触发器名称",
      "isEnabled": true,
      "conditions": [],
      "actions": []
    }
  ]
}
```

### 3.2 转换流程

1. **文件解析**：使用现有的解析器读取.w3x/.w3m文件
2. **数据提取**：从二进制格式中提取各种地图组件数据
3. **结构转换**：将提取的数据转换为统一的JSON结构
4. **内存映射**：建立二进制数据与JSON结构之间的映射关系
5. **编辑准备**：初始化编辑状态，准备接受用户修改

### 3.3 实时同步机制

- 当用户在界面中进行修改时，实时更新内存中的JSON结构
- 保持JSON结构与内部二进制表示的同步
- 提供撤销/重做功能，基于JSON结构的快照

## 4. 地图打包功能

### 4.1 打包流程

1. **数据验证**：检查地图数据的完整性和有效性
2. **结构转换**：将JSON结构转换回二进制格式
3. **资源收集**：收集所有依赖的外部资源文件
4. **MPQ打包**：将所有文件打包为MPQ归档格式
5. **头部信息**：添加必要的地图头部信息
6. **校验和生成**：生成校验和确保文件完整性

### 4.2 打包选项

#### 4.2.1 压缩选项
- 无压缩：保持原始大小，加载速度快
- 标准压缩：平衡大小和加载速度
- 最大压缩：最小文件大小，加载速度较慢

#### 4.2.2 兼容性选项
- RoC兼容：仅使用Reign of Chaos支持的特性
- TFT兼容：支持The Frozen Throne的所有特性
- Reforged兼容：支持Reforged的新特性

#### 4.2.3 优化选项
- 资源去重：移除重复的资源文件
- 未使用资源清理：移除地图中未使用的资源
- 路径优化：优化资源路径以减少加载时间

### 4.3 输出格式

支持以下输出格式：
- .w3x：扩展格式，支持更多特性
- .w3m：经典格式，更好的兼容性
- .zip：包含所有文件的ZIP归档，用于调试

## 5. 性能要求

### 5.1 响应时间
- 界面操作响应时间：< 100ms
- 视图更新时间：< 50ms
- 大型操作（如地形编辑）：< 1s

### 5.2 内存使用
- 128x128地图：< 500MB
- 256x256地图：< 1GB
- 512x512地图：< 2GB

### 5.3 加载时间
- 小型地图（< 5MB）：< 2s
- 中型地图（5-20MB）：< 5s
- 大型地图（> 20MB）：< 10s

## 6. 兼容性要求

### 6.1 游戏版本兼容
- 支持RoC、TFT和Reforged版本的地图
- 正确处理版本特定的特性和限制

### 6.2 浏览器兼容
- Chrome最新版本
- Firefox最新版本
- Edge最新版本
- Safari最新版本

### 6.3 操作系统兼容
- Windows 10及以上
- macOS 10.15及以上
- Linux主流发行版

## 7. 安全性要求

### 7.1 文件安全
- 防止恶意文件造成的安全问题
- 验证文件格式和内容的合法性
- 限制资源文件的访问权限

### 7.2 数据安全
- 提供自动保存功能防止数据丢失
- 支持备份和恢复功能
- 实现版本控制系统跟踪修改历史

## 8. 可扩展性要求

### 8.1 插件系统
- 支持第三方插件扩展功能
- 提供标准API供插件使用
- 实现插件管理界面

### 8.2 主题系统
- 支持深色/浅色主题
- 允许自定义界面样式
- 提供主题编辑器

### 8.3 国际化支持
- 支持多语言界面
- 实现RTL布局支持
- 提供翻译工具