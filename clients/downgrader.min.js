(function(v,U){typeof exports=="object"&&typeof module<"u"?U(require("pako")):typeof define=="function"&&define.amd?define(["pako"],U):(v=typeof globalThis<"u"?globalThis:v||self,U(v.pako))})(this,(function(v){"use strict";const U=new TextDecoder,Nt=new TextEncoder;function _(a){return U.decode(a)}function D(a){return Nt.encode(a)}function f(a){let t=a.length;for(let e=a.length-1;e>=0;e--){const i=a.charCodeAt(e);i>127&&i<=2047?t++:i>2047&&i<=65535&&(t+=2),i>=56320&&i<=57343&&e--}return t}function $(a){return a instanceof Uint8Array?a:typeof a=="string"?D(a):new Uint8Array(a)}function zt(a,t,e=0,i=1/0){const n=Math.max(e,0),r=Math.min(n+i,a.length);for(let s=n;s<r;s++)if(a[s]===t)return s;return-1}const A=new ArrayBuffer(8),O=new Int8Array(A),R=new Int16Array(A),V=new Int32Array(A),l=new Uint8Array(A),H=new Uint16Array(A),S=new Uint32Array(A),j=new Float32Array(A),G=new Float64Array(A);function K(a){return l[0]=a,O[0]}function q(a,t){return l[0]=a,l[1]=t,R[0]}function Z(a,t,e,i){return l[0]=a,l[1]=t,l[2]=e,l[3]=i,V[0]}function Y(a,t){return l[0]=a,l[1]=t,H[0]}function Q(a,t,e,i){return l[0]=a,l[1]=t,l[2]=e,l[3]=i,S[0]}function X(a,t,e,i){return l[0]=a,l[1]=t,l[2]=e,l[3]=i,j[0]}function J(a,t,e,i,n,r,s,o){return l[0]=a,l[1]=t,l[2]=e,l[3]=i,l[4]=n,l[5]=r,l[6]=s,l[7]=o,G[0]}function W(a){return l[0]=a,O[0]}function tt(a,t){return R[0]=t,a[0]=l[0],a[1]=l[1],a}function et(a,t){return V[0]=t,a[0]=l[0],a[1]=l[1],a[2]=l[2],a[3]=l[3],a}function it(a,t){return H[0]=t,a[0]=l[0],a[1]=l[1],a}function nt(a,t){return S[0]=t,a[0]=l[0],a[1]=l[1],a[2]=l[2],a[3]=l[3],a}function rt(a,t){return j[0]=t,a[0]=l[0],a[1]=l[1],a[2]=l[2],a[3]=l[3],a}function st(a,t){return G[0]=t,a[0]=l[0],a[1]=l[1],a[2]=l[2],a[3]=l[3],a[4]=l[4],a[5]=l[5],a[6]=l[6],a[7]=l[7],a}function at(a){return S[0]=a,S[0]}const h=new Uint8Array(8);class w{buffer;uint8array;index=0;byteLength;remaining;constructor(t,e,i){const n=$(t);e=e||0,i=i||n.length,this.buffer=t,this.uint8array=n.subarray(e,e+i),this.byteLength=i,this.remaining=i}substream(t){if(this.remaining<t)throw new Error(`ByteStream: substream: want ${t} bytes but have ${this.remaining}`);const e=this.index;return this.index+=t,new w(this.uint8array.subarray(e,e+t))}skip(t){if(this.remaining<t)throw new Error(`ByteStream: skip: premature end - want ${t} bytes but have ${this.remaining}`);this.index+=t,this.remaining-=t}seek(t){this.index=t,this.remaining=this.byteLength-t}read(t){if(this.remaining<t)throw new Error(`ByteStream: read: premature end - want ${t} bytes but have ${this.remaining}`);const e=this.uint8array,i=this.index;let n=zt(e,0,i,t);return n===-1&&(n=i+t),this.index+=t,this.remaining-=t,_(e.subarray(i,n))}readNull(){if(this.remaining<1)throw new Error("ByteStream: readNull: premature end - want at least 1 byte but have 0");const t=this.uint8array,e=this.index;let i=t.indexOf(0,e);i===-1&&(i=t.length-1);const n=i-e+1;return this.index+=n,this.remaining-=n,_(t.subarray(e,i))}readBinary(t){if(this.remaining<t)throw new Error(`ByteStream: readBinary: premature end - want ${t} bytes but have ${this.remaining}`);const e=this.uint8array,i=this.index;let n="";for(let r=0;r<t;r++)n+=String.fromCharCode(e[i+r]);return this.index+=t,this.remaining-=t,n}readInt8(){if(this.remaining<1)throw new Error(`ByteStream: readInt8: premature end - want 1 byte but have ${this.remaining}`);const t=this.index,e=this.uint8array,i=K(e[t]);return this.index+=1,this.remaining-=1,i}readInt16(){if(this.remaining<2)throw new Error(`ByteStream: readInt16: premature end - want 2 bytes but have ${this.remaining}`);const t=this.index,e=this.uint8array,i=q(e[t],e[t+1]);return this.index+=2,this.remaining-=2,i}readInt32(){if(this.remaining<4)throw new Error(`ByteStream: readInt32: premature end - want 4 bytes but have ${this.remaining}`);const t=this.index,e=this.uint8array,i=Z(e[t],e[t+1],e[t+2],e[t+3]);return this.index+=4,this.remaining-=4,i}readUint8(){if(this.remaining<1)throw new Error(`ByteStream: readUint8: premature end - want 1 byte but have ${this.remaining}`);const t=this.uint8array[this.index];return this.index+=1,this.remaining-=1,t}readUint16(){if(this.remaining<2)throw new Error(`ByteStream: readUint16: premature end - want 2 bytes but have ${this.remaining}`);const t=this.index,e=this.uint8array,i=Y(e[t],e[t+1]);return this.index+=2,this.remaining-=2,i}readUint32(){if(this.remaining<4)throw new Error(`ByteStream: readUint32: premature end - want 4 bytes but have ${this.remaining}`);const t=this.index,e=this.uint8array,i=Q(e[t],e[t+1],e[t+2],e[t+3]);return this.index+=4,this.remaining-=4,i}readFloat32(){if(this.remaining<4)throw new Error(`ByteStream: readFloat32: premature end - want 4 bytes but have ${this.remaining}`);const t=this.index,e=this.uint8array,i=X(e[t],e[t+1],e[t+2],e[t+3]);return this.index+=4,this.remaining-=4,i}readFloat64(){if(this.remaining<8)throw new Error(`ByteStream: readFloat64: premature end - want 8 bytes but have ${this.remaining}`);const t=this.index,e=this.uint8array,i=J(e[t],e[t+1],e[t+2],e[t+3],e[t+4],e[t+5],e[t+6],e[t+7]);return this.index+=8,this.remaining-=8,i}readInt8Array(t){if(ArrayBuffer.isView(t)||(t=new Int8Array(t)),this.remaining<t.byteLength)throw new Error(`ByteStream: readInt8Array: premature end - want ${t.byteLength} bytes but have ${this.remaining}`);const e=this.index,i=this.uint8array;for(let n=0,r=t.length;n<r;n++)t[n]=K(i[e+n]);return this.index+=t.byteLength,this.remaining-=t.byteLength,t}readInt16Array(t){if(ArrayBuffer.isView(t)||(t=new Int16Array(t)),this.remaining<t.byteLength)throw new Error(`ByteStream: readInt16Array: premature end - want ${t.byteLength} bytes but have ${this.remaining}`);const e=this.index,i=this.uint8array;for(let n=0,r=t.length;n<r;n++){const s=e+n*2;t[n]=q(i[s],i[s+1])}return this.index+=t.byteLength,this.remaining-=t.byteLength,t}readInt32Array(t){if(ArrayBuffer.isView(t)||(t=new Int32Array(t)),this.remaining<t.byteLength)throw new Error(`ByteStream: readInt32Array: premature end - want ${t.byteLength} bytes but have ${this.remaining}`);const e=this.index,i=this.uint8array;for(let n=0,r=t.length;n<r;n++){const s=e+n*4;t[n]=Z(i[s],i[s+1],i[s+2],i[s+3])}return this.index+=t.byteLength,this.remaining-=t.byteLength,t}readUint8Array(t){if(ArrayBuffer.isView(t)||(t=new Uint8Array(t)),this.remaining<t.byteLength)throw new Error(`ByteStream: readUint8Array: premature end - want ${t.byteLength} bytes but have ${this.remaining}`);const e=this.index,i=this.uint8array;for(let n=0,r=t.length;n<r;n++)t[n]=i[e+n];return this.index+=t.byteLength,this.remaining-=t.byteLength,t}readUint16Array(t){if(ArrayBuffer.isView(t)||(t=new Uint16Array(t)),this.remaining<t.byteLength)throw new Error(`ByteStream: readUint16Array: premature end - want ${t.byteLength} bytes but have ${this.remaining}`);const e=this.index,i=this.uint8array;for(let n=0,r=t.length;n<r;n++){const s=e+n*2;t[n]=Y(i[s],i[s+1])}return this.index+=t.byteLength,this.remaining-=t.byteLength,t}readUint32Array(t){if(ArrayBuffer.isView(t)||(t=new Uint32Array(t)),this.remaining<t.byteLength)throw new Error(`ByteStream: readUint32Array: premature end - want ${t.byteLength} bytes but have ${this.remaining}`);const e=this.index,i=this.uint8array;for(let n=0,r=t.length;n<r;n++){const s=e+n*4;t[n]=Q(i[s],i[s+1],i[s+2],i[s+3])}return this.index+=t.byteLength,this.remaining-=t.byteLength,t}readFloat32Array(t){if(ArrayBuffer.isView(t)||(t=new Float32Array(t)),this.remaining<t.byteLength)throw new Error(`ByteStream: readFloat32Array: premature end - want ${t.byteLength} bytes but have ${this.remaining}`);const e=this.index,i=this.uint8array;for(let n=0,r=t.length;n<r;n++){const s=e+n*4;t[n]=X(i[s],i[s+1],i[s+2],i[s+3])}return this.index+=t.byteLength,this.remaining-=t.byteLength,t}readFloat64Array(t){if(ArrayBuffer.isView(t)||(t=new Float64Array(t)),this.remaining<t.byteLength)throw new Error(`ByteStream: readFloat64Array: premature end - want ${t.byteLength} bytes but have ${this.remaining}`);const e=this.index,i=this.uint8array;for(let n=0,r=t.length;n<r;n++){const s=e+n*8;t[n]=J(i[s],i[s+1],i[s+2],i[s+3],i[s+4],i[s+5],i[s+6],i[s+7])}return this.index+=t.byteLength,this.remaining-=t.byteLength,t}write(t){const e=D(t);return this.writeUint8Array(e),e.length}writeNull(t){const e=this.write(t);return this.index++,this.remaining--,e+1}writeBinary(t){const e=this.index,i=this.uint8array,n=t.length;for(let r=0;r<n;r++)i[e+r]=t.charCodeAt(r);this.index+=n}writeInt8(t){this.uint8array[this.index]=W(t),this.index+=1}writeInt16(t){const e=this.index,i=this.uint8array;tt(h,t),i[e]=h[0],i[e+1]=h[1],this.index+=2}writeInt32(t){const e=this.index,i=this.uint8array;et(h,t),i[e]=h[0],i[e+1]=h[1],i[e+2]=h[2],i[e+3]=h[3],this.index+=4}writeUint8(t){this.uint8array[this.index]=t,this.index+=1}writeUint16(t){const e=this.index,i=this.uint8array;it(h,t),i[e]=h[0],i[e+1]=h[1],this.index+=2}writeUint32(t){const e=this.index,i=this.uint8array;nt(h,t),i[e]=h[0],i[e+1]=h[1],i[e+2]=h[2],i[e+3]=h[3],this.index+=4}writeFloat32(t){const e=this.index,i=this.uint8array;rt(h,t),i[e]=h[0],i[e+1]=h[1],i[e+2]=h[2],i[e+3]=h[3],this.index+=4}writeFloat64(t){const e=this.index,i=this.uint8array;st(h,t),i[e]=h[0],i[e+1]=h[1],i[e+2]=h[2],i[e+3]=h[3],i[e+4]=h[4],i[e+5]=h[5],i[e+6]=h[6],i[e+7]=h[7],this.index+=8}writeInt8Array(t){const e=this.index,i=this.uint8array;for(let n=0,r=t.length;n<r;n++)i[e+n]=W(t[n]);this.index+=t.byteLength}writeInt16Array(t){const e=this.index,i=this.uint8array;for(let n=0,r=t.length;n<r;n++){const s=e+n*2;tt(h,t[n]),i[s]=h[0],i[s+1]=h[1]}this.index+=t.byteLength}writeInt32Array(t){const e=this.index,i=this.uint8array;for(let n=0,r=t.length;n<r;n++){const s=e+n*4;et(h,t[n]),i[s]=h[0],i[s+1]=h[1],i[s+2]=h[2],i[s+3]=h[3]}this.index+=t.byteLength}writeUint8Array(t){const e=this.index,i=this.uint8array;for(let n=0,r=t.length;n<r;n++)i[e+n]=t[n];this.index+=t.byteLength}writeUint16Array(t){const e=this.index,i=this.uint8array;for(let n=0,r=t.length;n<r;n++){const s=e+n*2;it(h,t[n]),i[s]=h[0],i[s+1]=h[1]}this.index+=t.byteLength}writeUint32Array(t){const e=this.index,i=this.uint8array;for(let n=0,r=t.length;n<r;n++){const s=e+n*4;nt(h,t[n]),i[s]=h[0],i[s+1]=h[1],i[s+2]=h[2],i[s+3]=h[3]}this.index+=t.byteLength}writeFloat32Array(t){const e=this.index,i=this.uint8array;for(let n=0,r=t.length;n<r;n++){const s=e+n*4;rt(h,t[n]),i[s]=h[0],i[s+1]=h[1],i[s+2]=h[2],i[s+3]=h[3]}this.index+=t.byteLength}writeFloat64Array(t){const e=this.index,i=this.uint8array;for(let n=0,r=t.length;n<r;n++){const s=e+n*8;st(h,t[n]),i[s]=h[0],i[s+1]=h[1],i[s+2]=h[2],i[s+3]=h[3],i[s+4]=h[4],i[s+5]=h[5],i[s+6]=h[6],i[s+7]=h[7]}this.index+=t.byteLength}}function Mt(a){return a--,a|=a>>1,a|=a>>2,a|=a>>4,a|=a>>8,a|=a>>16,a++,a}class ot{offset=0;compressedSize=0;normalSize=0;flags=0;load(t){this.offset=t[0],this.compressedSize=t[1],this.normalSize=t[2],this.flags=t[3]}save(t){t[0]=this.offset,t[1]=this.compressedSize,t[2]=this.normalSize,t[3]=this.flags}}const kt=441536589,ht=3283040112,lt=0,dt=1,ct=2,Pt=3,T=4294967294,ft=4294967295,ut=3968054179,Dt=256,N=512,z=65536,yt=131072,gt=16777216,L=2147483648,Ot=1,Rt=2,Vt=8,Ht=16,jt=64,Gt=128;class Kt{c;entries;constructor(t){this.c=t,this.entries=[]}add(t){const e=new ot;return e.normalSize=t.byteLength,this.entries.push(e),e}clear(){this.entries.length=0}addEmpties(t){for(let e=0;e<t;e++)this.entries.push(new ot)}load(t){const e=t.byteLength/16,i=new Uint32Array(this.c.decryptBlock(t,ut).buffer);let n=0;this.clear(),this.addEmpties(e);for(const r of this.entries)r.load(i.subarray(n,n+4)),n+=4}save(t){const e=new Uint32Array(this.entries.length*4);let i=0;for(const r of this.entries)r.save(e.subarray(i,i+4)),i+=4;const n=new Uint8Array(e.buffer);this.c.encryptBlock(n,ut),t.set(n)}}const p=new Uint8Array(4),E=new Uint32Array(p.buffer);class qt{cryptTable=new Uint32Array(1280);constructor(){let t=1048577,e=0,i=0;for(let n=0;n<256;n++)for(let r=n,s=0;s<5;s+=1,r+=256)t=(t*125+3)%2796203,e=(t&65535)<<16,t=(t*125+3)%2796203,i=t&65535,this.cryptTable[r]=e|i}hash(t,e){const i=this.cryptTable;let n=2146271213,r=4008636142;t=t.toUpperCase();for(let s=0;s<t.length;s++){const o=t.charCodeAt(s);n=i[(e<<8)+o]^n+r,r=o+n+r+(r<<5)+3}return n>>>0}decryptBlock(t,e){const i=this.cryptTable;let n=4008636142;const r=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);for(let s=0,o=t.byteLength>>>2;s<o;s++)n+=i[1024+(e&255)],p[0]=r[s*4],p[1]=r[s*4+1],p[2]=r[s*4+2],p[3]=r[s*4+3],E[0]^=e+n,e=(~e<<21)+286331153|e>>>11,n=E[0]+n+(n<<5)+3,r[s*4]=p[0],r[s*4+1]=p[1],r[s*4+2]=p[2],r[s*4+3]=p[3];return t}encryptBlock(t,e){const i=this.cryptTable;let n=4008636142;const r=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);for(let s=0,o=t.byteLength>>>2;s<o;s++){n+=i[1024+(e&255)],p[0]=r[s*4],p[1]=r[s*4+1],p[2]=r[s*4+2],p[3]=r[s*4+3];const d=E[0];E[0]^=e+n,e=(~e<<21)+286331153|e>>>11,n=d+n+(n<<5)+3,r[s*4]=p[0],r[s*4+1]=p[1],r[s*4+2]=p[2],r[s*4+3]=p[3]}return t}computeFileKey(t,e){const i=t.lastIndexOf("\\"),n=t.substring(i+1);let r=this.hash(n,Pt);return e.flags&yt&&(r=r+e.offset^e.normalSize),r}}const wt=0,Zt=1;class Yt{ctype=0;outputPos=0;dsize_bits=0;dsize_mask=0;bit_buff=0;extra_bits=0;in_pos=0;in_buff;out_buff=[];constructor(t){this.in_buff=t}}const bt=0,Qt=1,pt=new Uint8Array([2,4,4,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8]),Xt=new Uint8Array([3,13,5,25,9,17,1,62,30,46,14,54,22,38,6,58,26,42,10,50,18,34,66,2,124,60,92,28,108,44,76,12,116,52,84,20,100,36,68,4,120,56,88,24,104,40,72,8,240,112,176,48,208,80,144,16,224,96,160,32,192,64,128,0]),Jt=new Uint8Array([0,0,0,0,0,0,0,0,1,2,3,4,5,6,7,8]),Wt=new Uint16Array([0,1,2,3,4,5,6,7,8,10,14,22,38,70,134,262]),mt=new Uint8Array([3,2,3,3,4,4,4,5,5,5,5,6,6,6,7,7]),te=new Uint8Array([5,3,1,6,10,2,12,20,4,24,8,48,16,32,64,0]),x=new Uint8Array([11,12,12,12,12,12,12,12,12,8,7,12,12,7,12,12,12,12,12,12,12,12,12,12,12,12,13,12,12,12,12,12,4,10,8,12,10,12,10,8,7,7,8,9,7,6,7,8,7,6,7,7,7,7,8,7,7,8,8,12,11,7,9,11,12,6,7,6,6,5,7,8,8,6,11,9,6,7,6,6,7,11,6,6,6,7,9,8,9,9,11,8,11,9,12,8,12,5,6,6,6,5,6,6,6,5,11,7,5,6,5,5,6,10,5,5,5,5,8,7,8,8,10,11,11,12,12,12,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,13,12,13,13,13,12,13,13,13,12,13,13,13,13,12,13,13,13,12,12,12,13,13,13,13,13,13,13,13,13,13,13]),B=new Uint16Array([1168,4064,2016,3040,992,3552,1504,2528,480,184,98,3808,1760,34,2784,736,3296,1248,2272,224,3936,1888,2912,864,3424,1376,4672,2400,352,3680,1632,2656,15,592,56,608,80,3168,912,216,66,2,88,432,124,41,60,152,92,9,28,108,44,76,24,12,116,232,104,1120,144,52,176,1808,2144,49,84,17,33,23,20,168,40,1,784,304,62,100,30,46,36,1296,14,54,22,68,48,200,464,208,272,72,1552,336,96,136,4e3,7,38,6,58,27,26,42,10,11,528,4,19,50,3,29,18,400,13,21,5,25,8,120,240,112,656,1040,16,1952,2976,928,576,7232,3136,5184,1088,6208,2112,4160,64,8064,3968,6016,1920,7040,2944,4992,896,7552,3456,5504,1408,6528,2432,4480,384,7808,3712,5760,1664,6784,2688,4736,640,7296,3200,5248,1152,6272,2176,4224,128,7936,3840,5888,1792,6912,2816,4864,3488,1440,2464,416,3744,1696,2720,672,3232,1184,2208,160,3872,1824,2848,800,3360,1312,2336,288,3616,1568,2592,544,3104,1056,2080,32,4032,1984,3008,960,3520,1472,2496,448,3776,1728,2752,704,3264,1216,2240,192,3904,1856,2880,832,768,3392,7424,3328,5376,1344,1280,6400,2304,2368,4352,256,7680,3584,320,5632,1536,6656,3648,1600,2624,2560,4608,512,7168,3072,5120,1024,6144,2048,4096,0]);let It=!1;const At=new Uint8Array(256),vt=new Uint8Array(256);let Bt=!1;const M=new Uint8Array(256),Ut=new Uint8Array(256),xt=new Uint8Array(128),St=new Uint8Array(256);function Tt(a,t,e){for(let i=0,n=t.length;i<n;i++){const r=1<<e[i];for(let s=t[i];s<256;s+=r)a[s]=i}}function ee(){let a=255,t,e;for(let i=255;a>=0;a--,i--){const n=i;let r=x[n];if(r<=8){e=1<<r,t=B[a];do M[t]=i,t+=e;while(t<256)}else if((t=B[a]&255)!=0)if(M[t]=255,B[a]&63){r-=4,x[n]=r,e=1<<r,t=B[a]>>4;do Ut[t]=i,t+=e;while(t<256)}else{r-=6,x[n]=r,e=1<<r,t=B[a]>>6;do xt[t]=i,t+=e;while(t<128)}else{r-=8,x[n]=r,e=1<<r,t=B[a]>>8;do St[t]=i,t+=e;while(t<256)}}}function m(a,t){return t<=a.extra_bits?(a.extra_bits-=t,a.bit_buff>>=t,bt):(a.bit_buff>>=a.extra_bits,a.in_pos===a.in_buff.byteLength?Qt:(a.bit_buff|=a.in_buff[a.in_pos++]<<8,a.bit_buff>>=t-a.extra_bits,a.extra_bits=a.extra_bits-t+8,bt))}function ie(a){if(a.bit_buff&1){if(m(a,1))return 774;let e=vt[a.bit_buff&255];if(m(a,mt[e]))return 774;let i;if((i=Jt[e])!=0){const n=a.bit_buff&(1<<i)-1;if(m(a,i)&&e+n!=270)return 774;e=Wt[e]+n}return e+256}if(m(a,1))return 774;if(a.ctype==wt){const e=a.bit_buff&255;return m(a,8)?774:e}let t;if(a.bit_buff&255){if(t=M[a.bit_buff&255],t==255)if(a.bit_buff&63){if(m(a,4))return 774;t=Ut[a.bit_buff&255]}else{if(m(a,6))return 774;t=xt[a.bit_buff&127]}}else{if(m(a,8))return 774;t=St[a.bit_buff&255]}return m(a,x[t])?774:t}function ne(a,t){const e=At[a.bit_buff&255],i=pt[e];if(m(a,i))return 0;let n;if(t==2){if(n=e<<2|a.bit_buff&3,m(a,2))return 0}else if(n=e<<a.dsize_bits|a.bit_buff&a.dsize_mask,m(a,a.dsize_bits))return 0;return n+1}function re(a){let t;for(;(t=ie(a))<773;)if(t>=256){let e=t-254,i;if((i=ne(a,e))==0)return 774;let n=a.outputPos,r=n-i;for(a.outputPos+=e;e-- >0;)a.out_buff[n++]=a.out_buff[r++]}else a.out_buff[a.outputPos++]=t;return t}function Lt(a){const t=new Yt(a);if(t.in_buff.byteLength<=4)throw new Error("Bad data");if(t.ctype=t.in_buff[0],t.dsize_bits=t.in_buff[1],t.bit_buff=t.in_buff[2],t.extra_bits=0,t.in_pos=3,4>t.dsize_bits||t.dsize_bits>6)throw new Error("Invalid dictionary size");if(t.dsize_mask=65535>>16-t.dsize_bits,t.ctype!==wt){if(t.ctype!==Zt)throw new Error("Invalid mode");Bt||(ee(),Bt=!0)}if(It||(Tt(vt,te,mt),Tt(At,Xt,pt),It=!0),re(t)===774)throw new Error("Error while expanding");return new Uint8Array(t.out_buff)}function Et(a){let t=-1;for(let e=0,i=Math.ceil(a.byteLength/512);e<i;e++){const n=e*512;a[n]===77&&a[n+1]===80&&a[n+2]===81&&a[n+3]===26&&(t=n)}return t}function se(a){return a[0]===72&&a[1]===77&&a[2]===51&&a[3]===87?!0:Et(a)!==-1}class Ft{archive;c;name;nameResolved;hash;block;rawBuffer=null;buffer=null;constructor(t,e,i,n,r){const s=t.headerOffset;this.archive=t,this.c=t.c,this.name=`File${`${e.blockIndex}`.padStart(8,"0")}`,this.nameResolved=!1,this.hash=e,this.block=i,n&&(this.rawBuffer=n.slice(s+i.offset,s+i.offset+i.compressedSize)),r&&(this.buffer=r)}bytes(){return this.buffer===null&&this.decode(),this.buffer}arrayBuffer(){return this.bytes().buffer}text(){return _(this.bytes())}set(t){if(this.archive.readonly)return!1;const e=this.hash,i=this.block;return e.locale=0,e.platform=0,i.compressedSize=0,i.normalSize=t.byteLength,i.flags=0,this.buffer=t,this.rawBuffer=null,!0}delete(){if(this.archive.readonly)return!1;const t=this.archive,e=this.hash,i=e.blockIndex;e.delete();for(const n of t.hashTable.entries)n.blockIndex<T&&n.blockIndex>i&&(n.blockIndex-=1);return t.blockTable.entries.splice(i,1),t.files.splice(i,1),!0}rename(t){if(this.archive.readonly)return!1;const e=this.hash,i=e.locale,n=e.platform,r=e.blockIndex;e.delete();const s=this.archive.hashTable.add(t,r);return s.locale=i,s.platform=n,this.name=t,this.nameResolved=!0,this.hash=s,!0}decode(){if(!this.rawBuffer)throw new Error(`File ${this.name}: Nothing to decode`);const t=this.archive,e=this.block,i=t.c,n=i.computeFileKey(this.name,e),r=this.rawBuffer,s=e.flags;if(s===L)this.buffer=r.slice(0,e.normalSize);else if(s&gt){let o;s&z?o=i.decryptBlock(r.slice(0,e.compressedSize),n):o=r.subarray(0,e.compressedSize),s&N?o=this.decompressSector(o,e.normalSize):o=o.slice(),this.buffer=o}else{const o=Math.ceil(e.normalSize/t.sectorSize),d=new Uint8Array(e.normalSize);let c=new Uint32Array(r.buffer,0,o+1);s&z&&(c=i.decryptBlock(c.slice(),n-1));let y=c[0],b=c[1],g=0;for(let u=0;u<o;u++){let I;if(s&z?I=i.decryptBlock(r.slice(y,b),n+u):I=r.subarray(y,b),s&N){let P=t.sectorSize;e.normalSize-g<P&&(P=e.normalSize-g),I=this.decompressSector(I,P)}s&Dt&&(I=Lt(I)),d.set(I,g),g+=I.byteLength,u<o&&(y=b,b=c[u+2])}this.buffer=d}t.readonly&&(this.rawBuffer=null)}decompressSector(t,e){if(t.byteLength===e)return t;{const i=t[0];if(i&Ht)throw new Error(`File ${this.name}: compression type 'bzip2' not supported`);if(i&Vt)try{t=Lt(t.subarray(1))}catch(n){throw new Error(`File ${this.name}: failed to decompress with 'explode': ${n}`)}if(i&Rt)try{t=v.inflate(t.subarray(1))}catch(n){throw new Error(`File ${this.name}: failed to decompress with 'zlib': ${n}`)}if(i&Ot)throw new Error(`File ${this.name}: compression type 'huffman' not supported`);if(i&Gt)throw new Error(`File ${this.name}: compression type 'adpcm stereo' not supported`);if(i&jt)throw new Error(`File ${this.name}: compression type 'adpcm mono' not supported`);return t}}encode(){if(this.buffer!==null&&this.rawBuffer===null){const t=this.buffer;if(se(t))this.rawBuffer=this.buffer,this.block.compressedSize=this.buffer.byteLength,this.block.flags=L;else{const e=this.archive.sectorSize,i=Math.ceil(t.byteLength/e),n=new Uint32Array(i+1);let r=n.byteLength;const s=[],o=[];n[0]=r;for(let d=0;d<i;d++){const c=d*e;let y=t.subarray(c,c+e),b=y.byteLength;const g=v.deflate(y);let u=!1;g.byteLength+1<b&&(y=g,b=g.byteLength+1,u=!0),r+=b,n[d+1]=r,s[d]=y,o[d]=u}if(r<t.byteLength){const d=new Uint8Array(r);d.set(new Uint8Array(n.buffer)),r=n.byteLength;for(let c=0;c<i;c++){o[c]&&(d[r]=2,r+=1);const y=s[c];d.set(y,r),r+=y.byteLength}this.rawBuffer=d,this.block.compressedSize=d.byteLength,this.block.flags=(L|N)>>>0}else this.rawBuffer=this.buffer,this.block.compressedSize=this.buffer.byteLength,this.block.flags=L}}}reEncrypt(t){if(!this.rawBuffer)return!1;const e=this.archive,i=this.block,n=e.c,r=this.rawBuffer,s=i.flags,o=n.computeFileKey(this.name,i);i.offset=t;const d=n.computeFileKey(this.name,i);if(s&gt)n.decryptBlock(r,o),n.encryptBlock(r,d);else{const c=Math.ceil(i.normalSize/e.sectorSize),y=new Uint32Array(r.buffer,0,c+1);n.decryptBlock(y,o-1);let b=y[0],g=y[1];for(let u=0;u<c;u++){const I=r.subarray(b,g);n.decryptBlock(I,o+u),n.encryptBlock(I,d+u),u<c&&(b=g,g=y[u+2])}n.encryptBlock(y,d-1)}return!0}offsetChanged(t){const e=this.block;return e.offset!==t&&e.flags&yt?this.nameResolved?this.reEncrypt(t):!1:(e.offset=t,!0)}}class ae{nameA=4294967295;nameB=4294967295;locale=65535;platform=65535;blockIndex=ft;load(t){const e=t[2];this.nameA=t[0],this.nameB=t[1],this.locale=e&65535,this.platform=e>>>16,this.blockIndex=t[3]}copy(t){this.nameA=t.nameA,this.nameB=t.nameB,this.locale=t.locale,this.platform=t.platform,this.blockIndex=t.blockIndex}save(t){t[0]=this.nameA,t[1]=this.nameB,t[2]=this.locale<<16|this.platform,t[3]=this.blockIndex}delete(){this.nameA=4294967295,this.nameB=4294967295,this.locale=65535,this.platform=65535,this.blockIndex=T}}class oe{c;entries;constructor(t){this.c=t,this.entries=[],this.addEmpties(4)}clear(){this.entries.length=0}addEmpties(t){for(let e=0;e<t;e++)this.entries.push(new ae)}getInsertionIndex(t){const e=this.entries,i=this.c.hash(t,lt)&e.length-1;for(let n=0,r=e.length;n<r;n++){const s=(n+i)%r;if(e[s].platform===65535)return s}return-1}add(t,e){const i=this.getInsertionIndex(t);if(i!==-1){const n=this.entries[i];return n.nameA=this.c.hash(t,dt),n.nameB=this.c.hash(t,ct),n.locale=0,n.platform=0,n.blockIndex=e,n}}load(t){const e=t.byteLength/16,i=new Uint32Array(this.c.decryptBlock(t,ht).buffer);let n=0;this.clear(),this.addEmpties(e);for(const r of this.entries)r.load(i.subarray(n,n+4)),n+=4}save(t){const e=new Uint32Array(this.entries.length*4);let i=0;for(const r of this.entries)r.save(e.subarray(i,i+4)),i+=4;const n=new Uint8Array(e.buffer);this.c.encryptBlock(n,ht),t.set(n)}get(t){const e=this.c,i=this.entries,n=e.hash(t,lt)&i.length-1,r=e.hash(t,dt),s=e.hash(t,ct);for(let o=0,d=i.length;o<d;o++){const c=i[(o+n)%d];if(r===c.nameA&&s===c.nameB)return c;if(c.blockIndex===4294967295)return null}return null}}class he{headerOffset;sectorSize;c;hashTable;blockTable;files;readonly=!1;constructor(){this.headerOffset=0,this.sectorSize=4096,this.c=new qt,this.hashTable=new oe(this.c),this.blockTable=new Kt(this.c),this.files=[]}load(t,e=!1){const i=$(t);this.readonly=e;const n=Et(i);if(n===-1)throw new Error("No MPQ header");const r=new Uint32Array(i.buffer,n,8),s=r[3],o=at(r[4]+n),d=at(r[5]+n),c=r[6];let y=r[7];y>c&&(y=c),this.headerOffset=n,this.sectorSize=512*(1<<(s>>>16)),this.hashTable.load(i.slice(o,o+c*16)),this.blockTable.load(i.slice(d,d+y*16)),this.files.length=0;for(const g of this.hashTable.entries){const u=g.blockIndex;u<this.blockTable.entries.length&&(this.files[u]=new Ft(this,g,this.blockTable.entries[u],i,null))}const b=this.get("(listfile)");if(b){const g=b.text();if(g)for(const u of g.split(`\r
`))this.get(u)}}save(){if(this.readonly)return null;const t=32;this.delete("(attributes)"),this.saveMemory(),this.set("(listfile)",this.getFileNames().join(`\r
`));let e=t;for(const u of this.files)if(u){if(!u.offsetChanged(e))return null;u.encode(),e+=u.block.compressedSize}const i=this.hashTable,n=this.blockTable,r=i.entries.length,s=n.entries.length,o=e-t,d=t+o+r*16+s*16,c=t+o,y=c+r*16,b=new Uint8Array(d),g=new Uint32Array(b.buffer,0,8);g[0]=kt,g[1]=t,g[2]=d,g[3]=Math.log2(this.sectorSize/512)<<16,g[4]=c,g[5]=y,g[6]=r,g[7]=s,e=t;for(const u of this.files)u&&(u.rawBuffer&&b.set(u.rawBuffer,e),e+=u.block.compressedSize);return i.save(b.subarray(e,e+i.entries.length*16)),e+=i.entries.length*16,n.save(b.subarray(e,e+n.entries.length*16)),b}saveMemory(){if(this.readonly)return 0;const t=this.blockTable.entries,e=this.hashTable.entries;let i=t.length,n=0;for(;i--;){const r=t[i];if(r.normalSize===0)this.removeBlock(i),n+=r.compressedSize;else{let s=!1;for(const o of e)if(o.blockIndex===i){s=!0;break}s||(this.removeBlock(i),n+=r.compressedSize)}}return n}removeBlock(t){for(const e of this.hashTable.entries)e.blockIndex<T&&e.blockIndex>t&&(e.blockIndex-=1);this.blockTable.entries.splice(t,1)}getFileNames(){const t=[];for(const e of this.files)e&&e.name!==""&&t.push(e.name);return t}countUnresolved(){let t=0;for(const e of this.files)e.nameResolved||t++;return t}applyListfile(t){for(const e of t)this.get(e)}set(t,e){if(this.readonly)return!1;const i=$(e);let n=this.get(t);if(n)n.set(i);else{const r=this.blockTable.entries.length,s=this.hashTable.add(t,r);if(!s)return!1;const o=this.blockTable.add(i);n=new Ft(this,s,o,null,i),n.name=t,n.nameResolved=!0,this.files[r]=n}return!0}get(t){const e=this.hashTable.get(t);if(e){const i=e.blockIndex;if(i<T){const n=this.files[i];if(n)return n.name=t,n.nameResolved=!0,n}}return null}has(t){return!!this.get(t)}delete(t){if(this.readonly)return!1;const e=this.get(t);return e?(e.delete(),!0):!1}rename(t,e){if(this.readonly)return!1;const i=this.get(t);return i?(i.rename(e),!0):!1}resizeHashtable(t){if(this.readonly)return!1;t=Math.max(4,Mt(t));const e=this.files;if(e.length>t)return!1;for(const s of e)if(!s.nameResolved)return!1;const i=this.hashTable,n=i.entries,r=n.slice();i.clear(),i.addEmpties(t);for(const s of r)if(s.blockIndex!==ft){const o=e[s.blockIndex],d=i.getInsertionIndex(o.name);n[d].copy(s)}return!0}}class Ct{isCustom=0;path="";load(t){this.isCustom=t.readUint8(),this.path=t.readNull()}save(t){t.writeUint8(this.isCustom),t.writeNull(this.path)}getByteLength(){return 2+f(this.path)}}class le{version=1;entries=new Map;load(t){const e=new w(t);this.version=e.readUint32();for(let i=0,n=e.readUint32();i<n;i++){const r=new Ct;r.load(e),r.isCustom?this.entries.set(r.path,r):this.entries.set(`war3mapimported\\${r.path}`,r)}}save(){const t=new w(new ArrayBuffer(this.getByteLength()));t.writeUint32(this.version),t.writeUint32(this.entries.size);for(const e of this.entries.values())e.save(t);return t.uint8array}getByteLength(){let t=8;for(const e of this.entries.values())t+=e.getByteLength();return t}set(t){if(!this.entries.has(t)){const e=new Ct;return e.isCustom=10,e.path=t,this.entries.set(t,e),!0}return!1}has(t){return this.entries.has(t)}delete(t){return this.entries.delete(t)}rename(t,e){const i=this.entries.get(t);return i?(i.isCustom=10,i.path=e,!0):!1}}class de{id="\0\0\0\0";variableType=0;levelOrVariation=0;dataPointer=0;value=0;u1=0;load(t,e){if(this.id=t.readBinary(4),this.variableType=t.readInt32(),e&&(this.levelOrVariation=t.readInt32(),this.dataPointer=t.readInt32()),this.variableType===0)this.value=t.readInt32();else if(this.variableType===1||this.variableType===2)this.value=t.readFloat32();else if(this.variableType===3)this.value=t.readNull();else throw new Error(`Modification: unknown variable type ${this.variableType}`);this.u1=t.readInt32()}save(t,e){if(t.writeBinary(this.id),t.writeInt32(this.variableType),e&&(t.writeInt32(this.levelOrVariation),t.writeInt32(this.dataPointer)),this.variableType===0)t.writeInt32(this.value);else if(this.variableType===1||this.variableType===2)t.writeFloat32(this.value);else if(this.variableType===3)t.writeNull(this.value);else throw new Error(`Modification: unknown variable type ${this.variableType}`);t.writeInt32(this.u1)}getByteLength(t){let e=12;return t&&(e+=8),this.variableType===3?e+=f(this.value)+1:e+=4,e}}class ce{oldId="\0\0\0\0";newId="\0\0\0\0";sets=1;setsFlag=[];modifications=[];load(t,e,i){this.oldId=t.readBinary(4),this.newId=t.readBinary(4),i>=3&&(this.sets=t.readUint32());for(let n=0;n<this.sets;n++){i>=3&&(this.setsFlag[n]=t.readUint32());for(let r=0,s=t.readUint32();r<s;r++){const o=new de;o.load(t,e),this.modifications[r]=o}}}save(t,e,i){this.oldId!=="\0\0\0\0"?t.writeBinary(this.oldId):t.writeUint32(0),this.newId!=="\0\0\0\0"?t.writeBinary(this.newId):t.writeUint32(0),i>=3&&t.writeUint32(this.sets),t.writeUint32(this.modifications.length);for(let n=0;n<this.sets;n++){i>=3&&t.writeUint32(this.setsFlag[n]);for(const r of this.modifications)r.save(t,e)}}getByteLength(t,e){let i=e>=3?16:12;for(let n=0;n<this.sets;n++){e>=3&&(i+=4);for(const r of this.modifications)i+=r.getByteLength(t)}return i}}class F{objects=[];load(t,e,i){for(let n=0,r=t.readUint32();n<r;n++){const s=new ce;s.load(t,e,i),this.objects[n]=s}}save(t,e,i){t.writeUint32(this.objects.length);for(const n of this.objects)n.save(t,e,i)}getByteLength(t,e){let i=4;for(const n of this.objects)i+=n.getByteLength(t,e);return i}}class fe{version=0;originalTable=new F;customTable=new F;load(t){let e;t instanceof w?e=t:e=new w(t),this.version=e.readInt32(),this.originalTable.load(e,!0,this.version),this.customTable.load(e,!0,this.version)}save(){const t=new w(new ArrayBuffer(this.getByteLength()));return t.writeInt32(this.version),this.originalTable.save(t,!0,this.version),this.customTable.save(t,!0,this.version),t.uint8array}getByteLength(){return 4+this.originalTable.getByteLength(!0,this.version)+this.customTable.getByteLength(!0,this.version)}}class ue{version=0;originalTable=new F;customTable=new F;load(t){let e;t instanceof w?e=t:e=new w(t),this.version=e.readInt32(),this.originalTable.load(e,!1,this.version),this.customTable.load(e,!1,this.version)}save(){const t=new w(new ArrayBuffer(this.getByteLength()));return t.writeInt32(this.version),this.originalTable.save(t,!1,this.version),this.customTable.save(t,!1,this.version),t.uint8array}getByteLength(){return 4+this.originalTable.getByteLength(!1,this.version)+this.customTable.getByteLength(!1,this.version)}}class _t{text="";load(t){const e=t.readInt32();e&&(this.text=t.read(e-1),t.skip(1))}save(t){this.text.length?(t.writeInt32(f(this.text)+1),t.write(this.text),t.skip(1)):t.writeInt32(0)}getByteLength(){let t=4;return this.text.length&&(t+=f(this.text)+1),t}}class ye{version=0;comment="";trigger=new _t;triggers=[];load(t){const e=new w(t);this.version=e.readInt32(),this.version===1&&(this.comment=e.readNull(),this.trigger.load(e));for(let i=0,n=e.readUint32();i<n;i++){const r=new _t;r.load(e),this.triggers[i]=r}}save(){const t=new w(new ArrayBuffer(this.getByteLength()));t.writeInt32(this.version),this.version===1&&(t.writeNull(this.comment),this.trigger.save(t)),t.writeUint32(this.triggers.length);for(const e of this.triggers)e.save(t);return t.uint8array}getByteLength(){let t=8;this.version===1&&(t+=f(this.comment)+1+this.trigger.getByteLength());for(const e of this.triggers)t+=e.getByteLength();return t}}class ge{id=0;name="";isComment=0;load(t,e){this.id=t.readInt32(),this.name=t.readNull(),e===7&&(this.isComment=t.readInt32())}save(t,e){t.writeInt32(this.id),t.writeNull(this.name),e===7&&t.writeInt32(this.isComment)}getByteLength(t){let e=5+f(this.name);return t===7&&(e+=4),e}}class we{name="";type="";u1=0;isArray=0;arraySize=0;isInitialized=0;initialValue="";load(t,e){this.name=t.readNull(),this.type=t.readNull(),this.u1=t.readInt32(),this.isArray=t.readInt32(),e===7&&(this.arraySize=t.readInt32()),this.isInitialized=t.readInt32(),this.initialValue=t.readNull()}save(t,e){t.writeNull(this.name),t.writeNull(this.type),t.writeInt32(this.u1),t.writeInt32(this.isArray),e===7&&t.writeInt32(this.arraySize),t.writeInt32(this.isInitialized),t.writeNull(this.initialValue)}getByteLength(t){let e=15+f(this.name)+f(this.type)+f(this.initialValue);return t===7&&(e+=4),e}}class be{type=0;name="";beginParameters=0;parameters=[];load(t,e,i){if(this.type=t.readInt32(),this.type<0||this.type>3)throw new Error(`SubParameters: Bad type: ${this.type}`);if(this.name=t.readNull(),this.name.length===0)throw new Error("SubParameters: Empty name");if(this.beginParameters=t.readInt32(),this.beginParameters){const n=i.getFunction(this.type,this.name);if(!n)throw new Error(`SubParameters "${this.name}:${this.type}": Unknown signature`);const r=n.args;for(let s=0,o=r.length;s<o;s++){const d=new C;try{d.load(t,e,i)}catch(c){throw new Error(`SubParameters "${this.name}": Parameter ${s}: ${c}`)}this.parameters[s]=d}}}save(t,e){t.writeInt32(this.type),t.writeNull(this.name),t.writeInt32(this.beginParameters);for(const i of this.parameters)i.save(t,e)}getByteLength(t){let e=9+f(this.name);if(this.parameters.length)for(const i of this.parameters)e+=i.getByteLength(t);return e}}class C{type=0;value="";subParameters=null;u1=0;isArray=0;arrayIndex=null;load(t,e,i){if(this.type=t.readInt32(),this.type<-1||this.type>3)throw new Error(`Parameter: Bad type: ${this.type}`);if(this.value=t.readNull(),t.readInt32()){const n=new be;try{n.load(t,e,i)}catch(r){throw new Error(`Parameter "${this.value}": SubParameters ${r}`)}this.subParameters=n}if((e===4&&this.type===2||e===7&&this.subParameters)&&(this.u1=t.readInt32()),(e===4&&this.type!==2||e===7)&&(this.isArray=t.readInt32()),this.isArray){const n=new C;try{n.load(t,e,i)}catch(r){throw new Error(`Parameter "${this.value}": ArrayIndex: ${r}`)}this.arrayIndex=n}}save(t,e){t.writeInt32(this.type),t.writeNull(this.value),this.subParameters?(t.writeInt32(1),this.subParameters.save(t,e)):t.writeInt32(0),(e===4&&this.type===2||e===7&&this.subParameters)&&t.writeInt32(this.u1),(e===4&&this.type!==2||e===7)&&t.writeInt32(this.isArray),this.isArray&&this.arrayIndex&&this.arrayIndex.save(t,e)}getByteLength(t){let e=9+f(this.value);return this.subParameters&&(e+=this.subParameters.getByteLength(t)),(t===4&&this.type===2||t===7&&this.subParameters)&&(e+=4),(t===4&&this.type!==2||t===7)&&(e+=4),this.isArray&&this.arrayIndex&&(e+=this.arrayIndex.getByteLength(t)),e}}class k{type=-1;group=-1;name="";isEnabled=0;parameters=[];ecas=[];load(t,e,i,n){if(this.type=t.readInt32(),this.type<0||this.type>3)throw new Error(`ECA: Bad type: ${this.type}`);if(i&&(this.group=t.readUint32()),this.name=t.readNull(),this.name.length===0)throw new Error("ECA: Empty name");this.isEnabled=t.readInt32();const r=n.getFunction(this.type,this.name);if(!r)throw new Error(`ECA "${this.name}:${this.type}": Unknown signature`);const s=r.args;for(let o=0,d=s.length;o<d;o++){const c=new C;try{c.load(t,e,n)}catch(y){throw new Error(`ECA "${this.name}": Parameter ${o}: ${y}`)}this.parameters[o]=c}if(e===7)for(let o=0,d=t.readUint32();o<d;o++){const c=new k;try{c.load(t,e,!0,n)}catch(y){throw new Error(`ECA "${this.name}": Child ECA ${o} ${y}`)}this.ecas[o]=c}}save(t,e){t.writeInt32(this.type),this.group!==-1&&t.writeInt32(this.group),t.writeNull(this.name),t.writeInt32(this.isEnabled);for(const i of this.parameters)i.save(t,e);if(e===7){t.writeUint32(this.ecas.length);for(const i of this.ecas)i.save(t,e)}}getByteLength(t){let e=9+f(this.name);this.group!==-1&&(e+=4);for(const i of this.parameters)e+=i.getByteLength(t);if(t===7){e+=4;for(const i of this.ecas)e+=i.getByteLength(t)}return e}}class pe{name="";description="";isComment=0;isEnabled=0;isCustom=0;isInitiallyOff=0;runOnInitialization=0;category=0;ecas=[];load(t,e,i){this.name=t.readNull(),this.description=t.readNull(),e===7&&(this.isComment=t.readInt32()),this.isEnabled=t.readInt32(),this.isCustom=t.readInt32(),this.isInitiallyOff=t.readInt32(),this.runOnInitialization=t.readInt32(),this.category=t.readInt32();for(let n=0,r=t.readUint32();n<r;n++){const s=new k;try{s.load(t,e,!1,i)}catch(o){throw new Error(`Trigger "${this.name}": ECA ${n}: ${o}`)}this.ecas[n]=s}}save(t,e){t.writeNull(this.name),t.writeNull(this.description),e===7&&t.writeInt32(this.isComment),t.writeInt32(this.isEnabled),t.writeInt32(this.isCustom),t.writeInt32(this.isInitiallyOff),t.writeInt32(this.runOnInitialization),t.writeInt32(this.category),t.writeUint32(this.ecas.length);for(const i of this.ecas)i.save(t,e)}getByteLength(t){let e=26+f(this.name)+f(this.description);t===7&&(e+=4);for(const i of this.ecas)e+=i.getByteLength(t);return e}}class me{version=0;categories=[];u1=0;variables=[];triggers=[];load(t,e){const i=new w(t);if(i.readBinary(4)!=="WTG!")throw new Error("Not a WTG file");this.version=i.readInt32();for(let n=0,r=i.readUint32();n<r;n++){const s=new ge;s.load(i,this.version),this.categories[n]=s}this.u1=i.readInt32();for(let n=0,r=i.readUint32();n<r;n++){const s=new we;s.load(i,this.version),this.variables[n]=s}for(let n=0,r=i.readUint32();n<r;n++){const s=new pe;try{s.load(i,this.version,e)}catch(o){throw new Error(`Trigger ${n}: ${o}`)}this.triggers[n]=s}}save(){const t=new w(new ArrayBuffer(this.getByteLength()));t.writeBinary("WTG!"),t.writeInt32(this.version),t.writeUint32(this.categories.length);for(const e of this.categories)e.save(t,this.version);t.writeInt32(this.u1),t.writeUint32(this.variables.length);for(const e of this.variables)e.save(t,this.version);t.writeUint32(this.triggers.length);for(const e of this.triggers)e.save(t,this.version);return t.uint8array}getByteLength(){let t=24;const e=this.version;for(const i of this.categories)t+=i.getByteLength(e);for(const i of this.variables)t+=i.getByteLength(e);for(const i of this.triggers)t+=i.getByteLength(e);return t}}class Ie{buffer;index=0;ident=0;indentSpaces=4;precision=1e6;constructor(t){this.buffer=t||""}clear(){this.buffer="",this.index=0,this.ident=0}readToken(){const t=this.buffer,e=t.length;let i=!1,n=!1,r="";for(;this.index<e;){const s=t[this.index++];if(i)s===`
`&&(i=!1);else if(n)if(s==="\\")r+=s+t[this.index++];else if(s===`
`)r+="\\n";else if(s==="\r")r+="\\r";else{if(s==='"')return r;r+=s}else if(s===" "||s===","||s==="	"||s===`
`||s===":"||s==="\r"){if(r.length)return r}else{if(s==="{"||s==="}")return r.length?(this.index--,r):s;if(s==="/"&&t[this.index]==="/"){if(r.length)return this.index--,r;i=!0}else if(s==='"'){if(r.length)return this.index--,r;n=!0}else r+=s}}}read(){const t=this.readToken();if(t===void 0)throw new Error("End of stream reached prematurely");return t}peek(){const t=this.index,e=this.read();return this.index=t,e}readInt(){return parseInt(this.read())}readFloat(){return parseFloat(this.read())}readVector(t){this.read();for(let e=0,i=t.length;e<i;e++)t[e]=this.readFloat();return this.read(),t}readVectorsBlock(t,e){this.read();for(let i=0,n=t.length;i<n;i+=e)this.readVector(t.subarray(i,i+e));return this.read(),t}readColor(t){return this.read(),t[2]=this.readFloat(),t[1]=this.readFloat(),t[0]=this.readFloat(),this.read(),t}*readBlock(){this.read();let t=this.read();for(;t!=="}";)yield t,t=this.read()}writeLine(t){this.buffer+=`${" ".repeat(this.ident*this.indentSpaces)}${t}
`}writeFlag(t){this.writeLine(`${t},`)}writeFlagAttrib(t,e){this.writeLine(`${t} ${e},`)}writeNumberAttrib(t,e){this.writeLine(`${t} ${this.floatDecimals(e)},`)}writeStringAttrib(t,e){this.writeLine(`${t} "${e}",`)}writeVectorAttrib(t,e){this.writeLine(`${t} { ${this.floatArrayDecimals(e)} },`)}writeColor(t,e){const i=this.floatDecimals(e[0]),n=this.floatDecimals(e[1]),r=this.floatDecimals(e[2]);this.writeLine(`${t} { ${r}, ${n}, ${i} },`)}writeVector(t){this.writeLine(`{ ${this.floatArrayDecimals(t)} },`)}writeVectorArrayBlock(t,e,i){this.startBlock(t,e.length/i);for(let n=0,r=e.length;n<r;n+=i)this.writeVector(e.subarray(n,n+i));this.endBlock()}startBlock(t,...e){e.length&&(t=`${t} ${e.join(" ")}`),this.writeLine(`${t} {`),this.ident+=1}startObjectBlock(t,e){this.writeLine(`${t} "${e.replace(/"/g,'\\"')}" {`),this.ident+=1}endBlock(){this.ident-=1,this.writeLine("}")}endBlockComma(){this.ident-=1,this.writeLine("},")}indent(){this.ident+=1}unindent(){this.ident-=1}floatDecimals(t){return`${Math.trunc(t*this.precision)/this.precision}`}floatArrayDecimals(t){if(t instanceof Float32Array){const e=[];for(let i=0,n=t.length;i<n;i++)e[i]=this.floatDecimals(t[i]);return e.join(", ")}else return t.join(", ")}}class Ae{stringMap=new Map;load(t){const e=new Ie(t);let i;const n=t.indexOf("STRING");if(n===-1)throw new Error("Not a valid war3map.wts buffer");for(e.index=n;i=e.readToken();)if(i==="STRING"){const r=e.readInt();e.read();const s=t.indexOf("}",e.index);if(s===-1)throw this.stringMap.set(r,t.slice(e.index,t.length).trim()),new Error(`WTS: missing data in string ${this.stringMap.size} (and maybe more)`);this.stringMap.set(r,t.slice(e.index,s).trim()),e.index=s}}save(){let t="";for(const[e,i]of this.stringMap)t+=`STRING ${e}\r
{\r
${i}\r
}\r
\r
`;return t}getString(t){if(typeof t=="string"){if(t.startsWith("TRIGSTR_"))return this.stringMap.get(parseInt(t.slice(8)))}else return this.stringMap.get(t)}setString(t,e){typeof t=="string"?t.startsWith("TRIGSTR_")&&this.stringMap.set(parseInt(t.slice(8)),e):this.stringMap.set(t,e)}}class ve{flags=0;playerMasks=0;name="";load(t){this.flags=t.readUint32(),this.playerMasks=t.readUint32(),this.name=t.readNull()}save(t){t.writeUint32(this.flags),t.writeUint32(this.playerMasks),t.writeNull(this.name)}getByteLength(){return 9+f(this.name)}}class Be{id=0;type=0;race=0;isFixedStartPosition=0;name="";startLocation=new Float32Array(2);allyLowPriorities=0;allyHighPriorities=0;unknown1=new Uint8Array(8);load(t,e){this.id=t.readInt32(),this.type=t.readInt32(),this.race=t.readInt32(),this.isFixedStartPosition=t.readInt32(),this.name=t.readNull(),t.readFloat32Array(this.startLocation),this.allyLowPriorities=t.readUint32(),this.allyHighPriorities=t.readUint32(),e>30&&t.readUint8Array(this.unknown1)}save(t,e){t.writeInt32(this.id),t.writeInt32(this.type),t.writeInt32(this.race),t.writeInt32(this.isFixedStartPosition),t.writeNull(this.name),t.writeFloat32Array(this.startLocation),t.writeUint32(this.allyLowPriorities),t.writeUint32(this.allyHighPriorities),e>30&&t.writeUint8Array(this.unknown1)}getByteLength(t){let e=33+f(this.name);return t>30&&(e+=8),e}}let Ue=class{chance=0;id="\0\0\0\0";load(t){this.chance=t.readInt32(),this.id=t.readBinary(4)}save(t){t.writeInt32(this.chance),t.writeBinary(this.id)}},xe=class{items=[];load(t){for(let e=0,i=t.readUint32();e<i;e++){const n=new Ue;n.load(t),this.items[e]=n}}save(t){t.writeUint32(this.items.length);for(const e of this.items)e.save(t)}getByteLength(){return 4+this.items.length*8}};class Se{id=0;name="";sets=[];load(t){this.id=t.readInt32(),this.name=t.readNull();for(let e=0,i=t.readUint32();e<i;e++){const n=new xe;n.load(t),this.sets[e]=n}}save(t){t.writeInt32(this.id),t.writeNull(this.name),t.writeUint32(this.sets.length);for(const e of this.sets)e.save(t)}getByteLength(){let t=9+f(this.name);for(const e of this.sets)t+=e.getByteLength();return t}}let Te=class{chance=0;ids=[];load(t,e){this.chance=t.readInt32();for(let i=0;i<e;i++)this.ids[i]=t.readBinary(4)}save(t){t.writeInt32(this.chance);for(const e of this.ids)t.writeBinary(e)}};class Le{id=0;name="";positions=0;columnTypes=new Int32Array(0);units=[];load(t){this.id=t.readInt32(),this.name=t.readNull(),this.positions=t.readInt32(),this.columnTypes=t.readInt32Array(this.positions);for(let e=0,i=t.readUint32();e<i;e++){const n=new Te;n.load(t,this.positions),this.units[e]=n}}save(t){t.writeInt32(this.id),t.writeNull(this.name),t.writeInt32(this.positions),t.writeInt32Array(this.columnTypes),t.writeUint32(this.units.length);for(const e of this.units)e.save(t)}getByteLength(){return 13+f(this.name)+this.columnTypes.byteLength+this.units.length*(4+4*this.positions)}}class Ee{playerFlags=0;id="\0\0\0\0";load(t){this.playerFlags=t.readUint32(),this.id=t.readBinary(4)}save(t){t.writeUint32(this.playerFlags),t.writeBinary(this.id)}}class Fe{playerFlags=0;id="\0\0\0\0";levelAffected=0;availability=0;load(t){this.playerFlags=t.readUint32(),this.id=t.readBinary(4),this.levelAffected=t.readInt32(),this.availability=t.readInt32()}save(t){t.writeUint32(this.playerFlags),t.writeBinary(this.id),t.writeInt32(this.levelAffected),t.writeInt32(this.availability)}}class $t{version=0;saves=0;editorVersion=0;buildVersion=new Uint32Array(4);name="";author="";description="";recommendedPlayers="";cameraBounds=new Float32Array(8);cameraBoundsComplements=new Int32Array(4);playableSize=new Int32Array(2);flags=0;tileset="A";campaignBackground=0;loadingScreenModel="";loadingScreenText="";loadingScreenTitle="";loadingScreenSubtitle="";loadingScreen=0;prologueScreenModel="";prologueScreenText="";prologueScreenTitle="";prologueScreenSubtitle="";useTerrainFog=0;fogHeight=new Float32Array(2);fogDensity=0;fogColor=new Uint8Array(4);globalWeather=0;soundEnvironment="";lightEnvironmentTileset="\0";waterVertexColor=new Uint8Array(4);scriptMode=0;graphicsMode=0;defaultCameraZoom=0;maxCameraZoom=0;minCameraZoom=0;players=[];forces=[];upgradeAvailabilityChanges=[];techAvailabilityChanges=[];randomUnitTables=[];randomItemTables=[];unknown1=0;load(t){const e=new w(t);this.version=e.readInt32(),this.saves=e.readInt32(),this.editorVersion=e.readInt32(),this.version>27&&e.readUint32Array(this.buildVersion),this.name=e.readNull(),this.author=e.readNull(),this.description=e.readNull(),this.recommendedPlayers=e.readNull(),e.readFloat32Array(this.cameraBounds),e.readInt32Array(this.cameraBoundsComplements),e.readInt32Array(this.playableSize),this.flags=e.readUint32(),this.tileset=e.readBinary(1),this.campaignBackground=e.readInt32(),this.version>24&&(this.loadingScreenModel=e.readNull()),this.loadingScreenText=e.readNull(),this.loadingScreenTitle=e.readNull(),this.loadingScreenSubtitle=e.readNull(),this.loadingScreen=e.readInt32(),this.version>24&&(this.prologueScreenModel=e.readNull()),this.prologueScreenText=e.readNull(),this.prologueScreenTitle=e.readNull(),this.prologueScreenSubtitle=e.readNull(),this.version>24&&(this.useTerrainFog=e.readInt32(),e.readFloat32Array(this.fogHeight),this.fogDensity=e.readFloat32(),e.readUint8Array(this.fogColor),this.globalWeather=e.readInt32(),this.soundEnvironment=e.readNull(),this.lightEnvironmentTileset=e.readBinary(1),e.readUint8Array(this.waterVertexColor)),this.version>27&&(this.scriptMode=e.readUint32()),this.version>30&&(this.graphicsMode=e.readUint32(),this.unknown1=e.readUint32()),this.version>32&&(this.defaultCameraZoom=e.readUint32(),this.maxCameraZoom=e.readUint32(),this.minCameraZoom=e.readUint32());for(let i=0,n=e.readInt32();i<n;i++){const r=new Be;r.load(e,this.version),this.players[i]=r}for(let i=0,n=e.readInt32();i<n;i++){const r=new ve;r.load(e),this.forces[i]=r}for(let i=0,n=e.readInt32();i<n;i++){const r=new Fe;r.load(e),this.upgradeAvailabilityChanges[i]=r}for(let i=0,n=e.readInt32();i<n;i++){const r=new Ee;r.load(e),this.techAvailabilityChanges[i]=r}for(let i=0,n=e.readInt32();i<n;i++){const r=new Le;r.load(e),this.randomUnitTables[i]=r}if(this.version>24)for(let i=0,n=e.readInt32();i<n;i++){const r=new Se;r.load(e),this.randomItemTables[i]=r}}save(){const t=new w(new ArrayBuffer(this.getByteLength()));t.writeInt32(this.version),t.writeInt32(this.saves),t.writeInt32(this.editorVersion),this.version>27&&t.writeUint32Array(this.buildVersion),t.writeNull(this.name),t.writeNull(this.author),t.writeNull(this.description),t.writeNull(this.recommendedPlayers),t.writeFloat32Array(this.cameraBounds),t.writeInt32Array(this.cameraBoundsComplements),t.writeInt32Array(this.playableSize),t.writeUint32(this.flags),t.writeBinary(this.tileset),t.writeInt32(this.campaignBackground),this.version>24&&t.writeNull(this.loadingScreenModel),t.writeNull(this.loadingScreenText),t.writeNull(this.loadingScreenTitle),t.writeNull(this.loadingScreenSubtitle),t.writeInt32(this.loadingScreen),this.version>24&&t.writeNull(this.prologueScreenModel),t.writeNull(this.prologueScreenText),t.writeNull(this.prologueScreenTitle),t.writeNull(this.prologueScreenSubtitle),this.version>24&&(t.writeInt32(this.useTerrainFog),t.writeFloat32Array(this.fogHeight),t.writeFloat32(this.fogDensity),t.writeUint8Array(this.fogColor),t.writeInt32(this.globalWeather),t.writeNull(this.soundEnvironment),t.writeBinary(this.lightEnvironmentTileset),t.writeUint8Array(this.waterVertexColor)),this.version>27&&t.writeUint32(this.scriptMode),this.version>30&&(t.writeUint32(this.graphicsMode),t.writeUint32(this.unknown1)),this.version>32&&(t.writeUint32(this.defaultCameraZoom),t.writeUint32(this.maxCameraZoom),t.writeUint32(this.minCameraZoom)),t.writeUint32(this.players.length);for(const e of this.players)e.save(t,this.version);t.writeUint32(this.forces.length);for(const e of this.forces)e.save(t);t.writeUint32(this.upgradeAvailabilityChanges.length);for(const e of this.upgradeAvailabilityChanges)e.save(t);t.writeUint32(this.techAvailabilityChanges.length);for(const e of this.techAvailabilityChanges)e.save(t);t.writeUint32(this.randomUnitTables.length);for(const e of this.randomUnitTables)e.save(t);if(this.version>24){t.writeUint32(this.randomItemTables.length);for(const e of this.randomItemTables)e.save(t)}return t.uint8array}getByteLength(){let t=111+f(this.name)+f(this.author)+f(this.description)+f(this.recommendedPlayers)+f(this.loadingScreenText)+f(this.loadingScreenTitle)+f(this.loadingScreenSubtitle)+f(this.prologueScreenText)+f(this.prologueScreenTitle)+f(this.prologueScreenSubtitle);for(const e of this.players)t+=e.getByteLength(this.version);for(const e of this.forces)t+=e.getByteLength();t+=this.upgradeAvailabilityChanges.length*16,t+=this.techAvailabilityChanges.length*8;for(const e of this.randomUnitTables)t+=e.getByteLength();if(this.version>24){t+=36+f(this.loadingScreenModel)+f(this.prologueScreenModel)+f(this.soundEnvironment);for(const e of this.randomItemTables)t+=e.getByteLength()}return this.version>27&&(t+=20),this.version>30&&(t+=8),t}getBuildVersion(){return this.buildVersion[0]*100+this.buildVersion[1]}}class Ce{u1=0;name="";flags=0;maxPlayers=0;archive=new he;imports=new le;readonly=!1;load(t,e=!1){const i=new w(t);i.readBinary(4)==="HM3W"&&(this.u1=i.readUint32(),this.name=i.readNull(),this.flags=i.readUint32(),this.maxPlayers=i.readUint32()),this.readonly=e,this.archive.load(t,e),this.readImports()}save(){this.setImportsFile();const t=this.archive.save();if(!t)throw Error("Failed to save the map MPQ archive");const e=this.getMapInformation();if(!e||e.getBuildVersion()<131){const i=new Uint8Array(512+t.byteLength),n=new w(i);return n.writeBinary("HM3W"),n.writeUint32(this.u1),n.writeNull(this.name),n.writeUint32(this.flags),n.writeUint32(this.maxPlayers),i.set(t,512),i}else return t}getFileNames(){return this.archive.getFileNames()}getImportNames(){const t=[];for(const e of this.imports.entries.values()){const i=e.isCustom;i===10||i===13?t.push(e.path):t.push(`war3mapImported\\${e.path}`)}return t}setImportsFile(){return this.readonly?!1:this.imports.entries.size>0?this.set("war3map.imp",this.imports.save()):!1}import(t,e){return this.readonly?!1:this.archive.set(t,e)?(this.imports.set(t),!0):!1}set(t,e){return this.readonly?!1:this.archive.set(t,e)}get(t){return this.archive.get(t)}getScriptFile(){return this.get("war3map.j")||this.get("scripts\\war3map.j")||this.get("war3map.lua")||this.get("scripts\\war3map.lua")}has(t){return this.archive.has(t)}delete(t){return this.readonly?!1:(this.imports.delete(t),this.archive.delete(t))}rename(t,e){return this.readonly?!1:this.archive.rename(t,e)?(this.imports.rename(t,e),!0):!1}getMapInformation(){const t=this.archive.get("war3map.w3i");if(!t)throw new Error("File does not exist");const e=new $t;return e.load(t.bytes()),e}readImports(){const t=this.archive.get("war3map.imp");if(t){const e=t.arrayBuffer();e&&this.imports.load(e)}}readTriggers(t){const e=this.archive.get("war3map.wtg");if(e){const i=e.arrayBuffer();if(i){const n=new me;return n.load(i,t),n}}}readCustomTextTriggers(){const t=this.archive.get("war3map.wct");if(t){const e=t.arrayBuffer();if(e){const i=new ye;return i.load(e),i}}}readStringTable(){const t=this.archive.get("war3map.wts");if(t){const e=t.text();if(e){const i=new Ae;return i.load(e),i}}}readModifications(){const t={},e=["w3u","w3t","w3b","w3d","w3a","w3h","w3q"],i=[!1,!1,!1,!0,!0,!1,!0];for(let n=0,r=e.length;n<r;n++){const s=this.archive.get(`war3map.${e[n]}`);if(s){const o=s.arrayBuffer();if(o){let d;i[n]?d=new fe:d=new ue,d.load(o),t[e[n]]=d}}}return t}}class _e{id="\0\0\0\0";chance=0;load(t){this.id=t.readBinary(4),this.chance=t.readInt32()}save(t){t.writeBinary(this.id),t.writeInt32(this.chance)}}class $e{items=[];load(t){for(let e=0,i=t.readUint32();e<i;e++){const n=new _e;n.load(t),this.items.push(n)}}save(t){t.writeUint32(this.items.length);for(const e of this.items)e.save(t)}getByteLength(){return 4+this.items.length*8}}class Ne{id="\0\0\0\0";variation=0;location=new Float32Array(3);angle=0;scale=new Float32Array([1,1,1]);skin="\0\0\0\0";flags=0;life=0;itemTable=-1;itemSets=[];editorId=0;u1=new Uint8Array(8);load(t,e,i){if(this.id=t.readBinary(4),this.variation=t.readInt32(),t.readFloat32Array(this.location),this.angle=t.readFloat32(),t.readFloat32Array(this.scale),i>131&&(this.skin=t.readBinary(4)),this.flags=t.readUint8(),this.life=t.readUint8(),e>7){this.itemTable=t.readUint32();for(let n=0,r=t.readUint32();n<r;n++){const s=new $e;s.load(t),this.itemSets.push(s)}}this.editorId=t.readInt32()}save(t,e,i){if(t.writeBinary(this.id),t.writeInt32(this.variation),t.writeFloat32Array(this.location),t.writeFloat32(this.angle),t.writeFloat32Array(this.scale),i>131&&t.writeBinary(this.skin),t.writeUint8(this.flags),t.writeUint8(this.life),e>7){t.writeUint32(this.itemTable),t.writeUint32(this.itemSets.length);for(const n of this.itemSets)n.save(t)}t.writeInt32(this.editorId)}getByteLength(t,e){let i=42;if(e>131&&(i+=4),t>7){i+=8;for(const n of this.itemSets)i+=n.getByteLength()}return i}}class ze{id="\0\0\0\0";u1=0;location=new Uint32Array(2);load(t,e){this.id=t.readBinary(4),this.u1=t.readUint32(),t.readUint32Array(this.location)}save(t,e){t.writeBinary(this.id),t.writeUint32(this.u1),t.writeUint32Array(this.location)}}class Me{version=0;u1=new Uint8Array(4);doodads=[];u2=new Uint8Array(4);terrainDoodads=[];load(t,e){const i=new w(t);if(i.readBinary(4)!=="W3do")throw new Error("Not a valid war3map.doo buffer");this.version=i.readInt32(),i.readUint8Array(this.u1);for(let n=0,r=i.readInt32();n<r;n++){const s=new Ne;s.load(i,this.version,e),this.doodads.push(s)}i.readUint8Array(this.u2);for(let n=0,r=i.readInt32();n<r;n++){const s=new ze;s.load(i,this.version),this.terrainDoodads.push(s)}}save(t){const e=new w(new ArrayBuffer(this.getByteLength(t)));e.writeBinary("W3do"),e.writeInt32(this.version),e.writeUint8Array(this.u1),e.writeUint32(this.doodads.length);for(const i of this.doodads)i.save(e,this.version,t);e.writeUint8Array(this.u2),e.writeUint32(this.terrainDoodads.length);for(const i of this.terrainDoodads)i.save(e,this.version);return e.uint8array}getByteLength(t){let e=24+this.terrainDoodads.length*16;for(const i of this.doodads)e+=i.getByteLength(this.version,t);return e}}class ke{id="\0\0\0\0";chance=0;load(t){this.id=t.readBinary(4),this.chance=t.readInt32()}save(t){t.writeBinary(this.id),t.writeInt32(this.chance)}}class Pe{items=[];load(t){for(let e=0,i=t.readInt32();e<i;e++){const n=new ke;n.load(t),this.items[e]=n}}save(t){t.writeInt32(this.items.length);for(const e of this.items)e.save(t)}getByteLength(){return 4+this.items.length*8}}class De{slot=0;id="\0\0\0\0";load(t){this.slot=t.readInt32(),this.id=t.readBinary(4)}save(t){t.writeInt32(this.slot),t.writeBinary(this.id)}}class Oe{id="\0\0\0\0";activeForAutocast=0;heroLevel=1;load(t){this.id=t.readBinary(4),this.activeForAutocast=t.readInt32(),this.heroLevel=t.readInt32()}save(t){t.writeBinary(this.id),t.writeInt32(this.activeForAutocast),t.writeInt32(this.heroLevel)}}class Re{id="\0\0\0\0";chance=0;load(t){this.id=t.readBinary(4),this.chance=t.readInt32()}save(t){t.writeBinary(this.id),t.writeInt32(this.chance)}}class Ve{id="\0\0\0\0";variation=0;location=new Float32Array(3);angle=0;scale=new Float32Array([1,1,1]);skin="\0\0\0\0";flags=0;player=0;unknown=0;hitpoints=-1;mana=-1;droppedItemTable=0;droppedItemSets=[];goldAmount=0;targetAcquisition=0;heroLevel=0;heroStrength=0;heroAgility=0;heroIntelligence=0;itemsInInventory=[];modifiedAbilities=[];randomFlag=0;level=new Uint8Array(3);itemClass=0;unitGroup=0;positionInGroup=0;randomUnitTables=[];customTeamColor=0;waygate=0;creationNumber=0;load(t,e,i,n){this.id=t.readBinary(4),this.variation=t.readInt32(),t.readFloat32Array(this.location),this.angle=t.readFloat32(),t.readFloat32Array(this.scale),n>131&&(this.skin=t.readBinary(4)),this.flags=t.readUint8(),this.player=t.readInt32(),this.unknown=t.readUint16(),this.hitpoints=t.readInt32(),this.mana=t.readInt32(),i>10&&(this.droppedItemTable=t.readInt32());for(let r=0,s=t.readInt32();r<s;r++){const o=new Pe;o.load(t),this.droppedItemSets[r]=o}this.goldAmount=t.readInt32(),this.targetAcquisition=t.readFloat32(),this.heroLevel=t.readInt32(),i>10&&(this.heroStrength=t.readInt32(),this.heroAgility=t.readInt32(),this.heroIntelligence=t.readInt32());for(let r=0,s=t.readInt32();r<s;r++){const o=new De;o.load(t),this.itemsInInventory[r]=o}for(let r=0,s=t.readInt32();r<s;r++){const o=new Oe;o.load(t),this.modifiedAbilities[r]=o}if(this.randomFlag=t.readInt32(),this.randomFlag===0)t.readUint8Array(this.level),this.itemClass=t.readUint8();else if(this.randomFlag===1)this.unitGroup=t.readUint32(),this.positionInGroup=t.readUint32();else if(this.randomFlag===2)for(let r=0,s=t.readInt32();r<s;r++){const o=new Re;o.load(t),this.randomUnitTables[r]=o}this.customTeamColor=t.readInt32(),this.waygate=t.readInt32(),this.creationNumber=t.readInt32()}save(t,e,i,n){t.writeBinary(this.id),t.writeInt32(this.variation),t.writeFloat32Array(this.location),t.writeFloat32(this.angle),t.writeFloat32Array(this.scale),n>131&&t.writeBinary(this.skin),t.writeUint8(this.flags),t.writeInt32(this.player),t.writeUint16(this.unknown),t.writeInt32(this.hitpoints),t.writeInt32(this.mana),i>10&&t.writeInt32(this.droppedItemTable),t.writeInt32(this.droppedItemSets.length);for(const r of this.droppedItemSets)r.save(t);t.writeInt32(this.goldAmount),t.writeFloat32(this.targetAcquisition),t.writeInt32(this.heroLevel),i>10&&(t.writeInt32(this.heroStrength),t.writeInt32(this.heroAgility),t.writeInt32(this.heroIntelligence)),t.writeInt32(this.itemsInInventory.length);for(const r of this.itemsInInventory)r.save(t);t.writeInt32(this.modifiedAbilities.length);for(const r of this.modifiedAbilities)r.save(t);if(t.writeInt32(this.randomFlag),this.randomFlag===0)t.writeUint8Array(this.level),t.writeUint8(this.itemClass);else if(this.randomFlag===1)t.writeUint32(this.unitGroup),t.writeUint32(this.positionInGroup);else if(this.randomFlag===2){t.writeInt32(this.randomUnitTables.length);for(const r of this.randomUnitTables)r.save(t)}t.writeInt32(this.customTeamColor),t.writeInt32(this.waygate),t.writeInt32(this.creationNumber)}getByteLength(t,e,i){let n=91;i>131&&(n+=4),e>10&&(n+=16);for(const r of this.droppedItemSets)n+=r.getByteLength();return n+=this.itemsInInventory.length*8,n+=this.modifiedAbilities.length*12,this.randomFlag===0?n+=4:this.randomFlag===1?n+=8:this.randomFlag===2&&(n+=4+this.randomUnitTables.length*8),n}}class He{version=8;subversion=11;units=[];load(t,e){const i=new w(t);if(i.readBinary(4)!=="W3do")throw new Error("Not a valid war3mapUnits.doo buffer");this.version=i.readInt32(),this.subversion=i.readUint32();for(let n=0,r=i.readInt32();n<r;n++){const s=new Ve;s.load(i,this.version,this.subversion,e),this.units[n]=s}}save(t){const e=new w(new ArrayBuffer(this.getByteLength(t)));e.writeBinary("W3do"),e.writeInt32(this.version),e.writeUint32(this.subversion),e.writeInt32(this.units.length);for(const i of this.units)i.save(e,this.version,this.subversion,t);return e.uint8array}getByteLength(t){let e=16;for(const i of this.units)e+=i.getByteLength(this.version,this.subversion,t);return e}}document.addEventListener("dragover",a=>{a.preventDefault()}),document.addEventListener("dragend",a=>{a.preventDefault()}),document.addEventListener("drop",a=>{a.preventDefault();const t=a.dataTransfer.files[0],e=new FileReader;e.addEventListener("loadend",i=>{const n=i.target.result,r=new Ce;r.load(n);const s=new $t;s.load(r.get("war3map.w3i").arrayBuffer()),s.version>25&&(console.log(`war3map.w3i version ${s.version} => 25`),s.version=25,r.set("war3map.w3i",s.save()));const o=s.getBuildVersion();if(o>131){console.log(`war3map.doo buildVersion ${o} => 0`);const d=new Me;d.load(r.get("war3map.doo").arrayBuffer(),o),console.log(d),r.set("war3map.doo",d.save(0)),console.log(`war3mapUnits.doo buildVersion ${o} => 0`);const c=new He;c.load(r.get("war3mapUnits.doo").arrayBuffer(),o),console.log(c),r.set("war3mapUnits.doo",c.save(0)),console.log("Deleting the triggers, because this is a Reforged map, and my code does not support Reforged triggers (yet?)"),r.delete("war3map.wtg")}saveAs(new Blob([r.save().buffer],{type:"application/octet-stream"}),"downgraded_"+t.name)}),e.readAsArrayBuffer(t)})}));
