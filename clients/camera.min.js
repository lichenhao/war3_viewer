import{c as m,e as z,l as c,t as f,o as p,n as M,g as u,p as E,q as y,r as I,u as P,v as D,w as L,x as O}from"./handler.min.js";function H(r,t={}){return new b(r,t)}const i=m(),o=m(),l=z(),w=new Float32Array(1);function C(r,t){let s=t.clientX-r.clientX,e=t.clientY-r.clientY;return Math.sqrt(s*s+e*e)}const d=-1,x=0,T=1;class b{constructor(t,s={}){this.scene=t,this.canvas=t.viewer.canvas,this.camera=t.camera,this.moveSpeed=s.moveSpeed||2,this.rotationSpeed=s.rotationSpeed||Math.PI/180,this.zoomFactor=s.zoomFactor||.1,this.horizontalAngle=s.horizontalAngle||Math.PI/2,this.verticalAngle=s.verticalAngle||Math.PI/4,this.distance=s.distance||500,this.position=s.position||m(),this.target=s.target||m(),this.twist=s.twist||0,this.mouse={buttons:[!1,!1,!1],x:0,y:0,x2:0,y2:0},this.touchMode=d,this.touches=[],this.instance=null,this.onManualChange=s.onManualChange||null,this.fov=s.fov||Math.PI/4,this.nearClipPlane=s.nearClipPlane||1,this.farClipPlane=s.farClipPlane||2e5,this.update(),window.addEventListener("resize",e=>this.onResize()),setTimeout(()=>this.onResize(),0),this.canvas.addEventListener("contextmenu",e=>e.preventDefault()),this.canvas.addEventListener("selectstart",e=>e.preventDefault()),this.canvas.addEventListener("mousedown",e=>{e.preventDefault(),this.mouse.buttons[e.button]=!0}),document.addEventListener("mouseup",e=>{e.preventDefault(),this.mouse.buttons[e.button]=!1}),window.addEventListener("mousemove",e=>{this.mouse.x2=this.mouse.x,this.mouse.y2=this.mouse.y,this.mouse.x=e.clientX,this.mouse.y=e.clientY;let a=this.mouse.x-this.mouse.x2,n=this.mouse.y-this.mouse.y2;this.mouse.buttons[0]&&this.rotate(a,n),this.mouse.buttons[2]&&this.move(-a,n)}),this.canvas.addEventListener("wheel",e=>{e.preventDefault();let a=e.deltaY;e.deltaMode===1&&(a=a/3*100),this.zoom(a/100)}),this.canvas.addEventListener("touchstart",e=>{e.preventDefault();let a=e.targetTouches;a.length===1?this.touchMode=x:a.length==2?this.touchMode=T:this.touchMode=d,this.touches.length=0,this.touches.push(...a)}),this.canvas.addEventListener("touchend",e=>{e.preventDefault(),this.touchMode=d}),this.canvas.addEventListener("touchcancel",e=>{e.preventDefault(),this.touchMode=d}),this.canvas.addEventListener("touchmove",e=>{e.preventDefault();let a=e.targetTouches;if(this.touchMode===x){let n=this.touches[0],h=a[0],v=h.clientX-n.clientX,g=h.clientY-n.clientY;this.rotate(v,g)}else if(this.touchMode===T){let n=C(this.touches[0],this.touches[1]),h=C(a[0],a[1]);this.zoom((n-h)/50)}this.touches.length=0,this.touches.push(...a)})}update(){if(this.instance){let t=this.instance,s=t.model.cameras[0];s.getTranslation(i,t.sequence,t.frame,t.counter),c(i,i,s.position),s.getTargetTranslation(o,t.sequence,t.frame,t.counter),c(o,o,s.targetPosition),s.getRotation(w,t.sequence,t.frame,t.counter),this.twist=w[0],f(i,i,t.worldMatrix),f(o,o,t.worldMatrix),this.moveToAndFace(i,o)}else this.updateInternalCamera()}move(t,s){let e=this.camera.directionX,a=this.camera.directionY,n=this.canvas.width,h=this.canvas.height,v=n/h,g=t/n*this.distance*v,A=s/h*this.distance;c(this.target,this.target,p(i,M(i,u(i,e[0],e[1],0)),g)),c(this.target,this.target,p(i,M(i,u(i,a[0],a[1],0)),A)),this.manualChange()}rotate(t,s){this.horizontalAngle-=t*this.rotationSpeed,this.verticalAngle-=s*this.rotationSpeed,this.manualChange()}zoom(t){this.distance=Math.max(1,this.distance*(1+t*this.zoomFactor)),this.manualChange()}manualChange(){this.updateInternalCamera(),this.instance&&(this.instance=null,this.onManualChange&&this.onManualChange())}onResize(){let t=Math.max(this.canvas.clientWidth,1),s=Math.max(this.canvas.clientHeight,1);this.canvas.width=t,this.canvas.height=s,this.scene.viewport[2]=t,this.scene.viewport[3]=s,this.camera.perspective(this.fov,t/s,this.nearClipPlane,this.farClipPlane)}moveToAndFace(t,s){E(i,t,s);let e=y(i),a=Math.atan2(i[1],i[0]),n=Math.acos(i[2]/e);I(this.target,s),this.verticalAngle=n,this.horizontalAngle=a+Math.PI/2,this.distance=e,this.updateInternalCamera()}updateInternalCamera(){this.verticalAngle=Math.min(Math.max(.01,this.verticalAngle),Math.PI-.01),P(l),D(l,l,this.horizontalAngle),L(l,l,this.verticalAngle),u(this.position,0,0,1),O(this.position,this.position,l),p(this.position,this.position,this.distance),c(this.position,this.position,this.target);let t=this.twist-Math.PI/2;u(i,0,-Math.cos(t),-Math.sin(t)),this.camera.moveToAndFace(this.position,this.target,i)}applyInstanceCamera(t){this.instance=t,this.fov=t.model.cameras[0].fieldOfView,this.onResize(),this.update()}}export{H as s};
