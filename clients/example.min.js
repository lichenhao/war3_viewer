(function(d,Qe){typeof exports=="object"&&typeof module<"u"?Qe(require("gl-matrix"),require("pako"),require("tga-js"),require("events"),require("fengari-web")):typeof define=="function"&&define.amd?define(["gl-matrix","pako","tga-js","events","fengari-web"],Qe):(d=typeof globalThis<"u"?globalThis:d||self,Qe(d.glMatrix,d.pako,d.TGA,d.EventEmitter,d.fengariWeb))})(this,(function(d,Qe,wo,$n,Xn){"use strict";function zn(s){const e=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(s){for(const t in s)if(t!=="default"){const i=Object.getOwnPropertyDescriptor(s,t);Object.defineProperty(e,t,i.get?i:{enumerable:!0,get:()=>s[t]})}}return e.default=s,Object.freeze(e)}const Ge=zn(Xn),At=d.vec3.fromValues(1,0,0),$t=d.vec3.fromValues(0,1,0),je=d.vec3.fromValues(0,0,1),Le=d.vec3.create(),Tt=d.vec3.fromValues(1,1,1);d.quat.fromValues(0,0,0,0);const xt=d.quat.create(),ge=d.vec4.create();function Xt(s,e,t,i){const n=2*(e[0]-i[0])/i[2]-1,r=1-2*(e[1]-i[1])/i[3],o=2*e[2]-1;return d.vec4.set(ge,n,r,o,1),d.vec4.transformMat4(ge,ge,t),d.vec3.set(s,ge[0]/ge[3],ge[1]/ge[3],ge[2]/ge[3]),s}function Je(s,e,t){return s[0]*e+s[1]*t+s[3]}function zt(s,e,t,i){return s[0]*e+s[1]*t+s[2]*i+s[3]}function Yn(s,e,t,i,n,r){r===-1&&(r=0);for(let o=0;o<6;o++){const a=(r+o)%6;if(zt(s[a],e,t,i)<=-n)return a}return-1}function Wn(s,e,t,i,n,r){r===-1&&(r=0);for(let o=0;o<6;o++){const a=(r+o)%6,l=s[a];if(Je(l,e,i)<0&&Je(l,e,n)<0&&Je(l,t,n)<0&&Je(l,t,i)<0)return a}return-1}function Zn(s){return Math.hypot(s[0],s[1],s[2])}function Ce(s,e){const t=Zn(e);s[0]=e[0]/t,s[1]=e[1]/t,s[2]=e[2]/t,s[3]=e[3]/t}function Qn(s,e){const t=e[0],i=e[4],n=e[8],r=e[12],o=e[1],a=e[5],l=e[9],c=e[13],u=e[2],h=e[6],v=e[10],f=e[14],p=e[3],b=e[7],g=e[11],m=e[15];let w;w=s[0],w[0]=p+t,w[1]=b+i,w[2]=g+n,w[3]=m+r,w=s[1],w[0]=p-t,w[1]=b-i,w[2]=g-n,w[3]=m-r,w=s[2],w[0]=p-o,w[1]=b-a,w[2]=g-l,w[3]=m-c,w=s[3],w[0]=p+o,w[1]=b+a,w[2]=g+l,w[3]=m+c,w=s[4],w[0]=p+u,w[1]=b+h,w[2]=g+v,w[3]=m+f,w=s[5],w[0]=p-u,w[1]=b-h,w[2]=g-v,w[3]=m-f,Ce(s[0],s[0]),Ce(s[1],s[1]),Ce(s[2],s[2]),Ce(s[3],s[3]),Ce(s[4],s[4]),Ce(s[5],s[5])}const z=d.vec3.create(),Z=d.vec3.create(),te=d.vec3.create();function Yt(s,e,t,i){d.vec3.normalize(z,d.vec3.sub(z,t,e)),d.vec3.normalize(Z,d.vec3.cross(Z,i,z)),d.vec3.cross(te,Z,z);const n=Z[0]+te[2]+z[1];if(n>0){const r=.5/Math.sqrt(n+1);s[3]=.25/r,s[0]=(te[1]-z[2])*r,s[2]=(z[0]-Z[1])*r,s[1]=(Z[2]-te[0])*r}else if(Z[0]>te[2]&&Z[0]>z[1]){const r=2*Math.sqrt(1+Z[0]-te[2]-z[1]);s[3]=(te[1]-z[2])/r,s[0]=.25*r,s[2]=(te[0]+Z[2])/r,s[1]=(z[0]+Z[1])/r}else if(te[2]>z[1]){const r=2*Math.sqrt(1+te[2]-Z[0]-z[1]);s[3]=(z[0]-Z[1])/r,s[0]=(te[0]+Z[2])/r,s[2]=.25*r,s[1]=(z[2]+te[1])/r}else{const r=2*Math.sqrt(1+z[1]-Z[0]-te[2]);s[3]=(Z[2]-te[0])/r,s[0]=(z[0]+Z[1])/r,s[2]=(z[2]+te[1])/r,s[1]=.25*r}return s}function Jn(s){return s*(Math.PI/180)}function Te(s,e){return s+Math.random()*(e-s)}function es(s,e,t){return s+t*(e-s)}function ts(s,e,t,i,n){const r=n*n,o=r*(2*n-3)+1,a=r*(n-2)+n,l=r*(n-1),c=r*(3-2*n);return s*o+e*a+t*l+i*c}function is(s,e,t,i,n){const r=1-n,o=n*n,a=r*r,l=a*r,c=3*n*a,u=3*o*r,h=o*n;return s*l+e*c+t*u+i*h}function et(s){return s===0?!1:(s&s-1)===0}let Wt,Zt;typeof window=="object"&&(Wt=document.createElement("canvas"),Wt.getContext("2d"),Zt=document.createElement("canvas"),Zt.getContext("2d"));function ns(s){return new Promise((e,t)=>{const i=URL.createObjectURL(s),n=new Image;n.onload=()=>{e(n)},n.onerror=r=>{t(r)},n.src=i})}const ss=new TextDecoder,rs=new TextEncoder;function Et(s){return ss.decode(s)}function St(s){return rs.encode(s)}function _t(s){return s instanceof Uint8Array?s:typeof s=="string"?St(s):new Uint8Array(s)}function os(s,e,t=0,i=1/0){const n=Math.max(t,0),r=Math.min(n+i,s.length);let o=0,a=e.charCodeAt(0);for(let l=n;l<r;l++)if(s[l]===a){if(o+=1,o===e.length)return!0;a=e.charCodeAt(o)}else o>0&&(o=0,a=e.charCodeAt(0));return!1}function as(s,e,t=0,i=1/0){const n=Math.max(t,0),r=Math.min(n+i,s.length);let o=0,a=e[0];for(let l=n;l<r;l++)if(s[l]===a){if(o+=1,o===e.length)return!0;a=e[o]}else o>0&&(o=0,a=e[0]);return!1}function ls(s,e,t=0,i=1/0){const n=Math.max(t,0),r=Math.min(n+i,s.length);for(let o=n;o<r;o++)if(s[o]===e)return o;return-1}const xe=new ArrayBuffer(8),Qt=new Int8Array(xe),Jt=new Int16Array(xe),ei=new Int32Array(xe),L=new Uint8Array(xe),ti=new Uint16Array(xe),ii=new Uint32Array(xe),ni=new Float32Array(xe),si=new Float64Array(xe);function ri(s){return L[0]=s,Qt[0]}function oi(s,e){return L[0]=s,L[1]=e,Jt[0]}function ai(s,e,t,i){return L[0]=s,L[1]=e,L[2]=t,L[3]=i,ei[0]}function li(s,e){return L[0]=s,L[1]=e,ti[0]}function ci(s,e,t,i){return L[0]=s,L[1]=e,L[2]=t,L[3]=i,ii[0]}function hi(s,e,t,i){return L[0]=s,L[1]=e,L[2]=t,L[3]=i,ni[0]}function di(s,e,t,i,n,r,o,a){return L[0]=s,L[1]=e,L[2]=t,L[3]=i,L[4]=n,L[5]=r,L[6]=o,L[7]=a,si[0]}function ui(s){return L[0]=s,Qt[0]}function fi(s,e){return Jt[0]=e,s[0]=L[0],s[1]=L[1],s}function pi(s,e){return ei[0]=e,s[0]=L[0],s[1]=L[1],s[2]=L[2],s[3]=L[3],s}function vi(s,e){return ti[0]=e,s[0]=L[0],s[1]=L[1],s}function bi(s,e){return ii[0]=e,s[0]=L[0],s[1]=L[1],s[2]=L[2],s[3]=L[3],s}function mi(s,e){return ni[0]=e,s[0]=L[0],s[1]=L[1],s[2]=L[2],s[3]=L[3],s}function gi(s,e){return si[0]=e,s[0]=L[0],s[1]=L[1],s[2]=L[2],s[3]=L[3],s[4]=L[4],s[5]=L[5],s[6]=L[6],s[7]=L[7],s}const x=new Uint8Array(8);class tt{buffer;uint8array;index=0;byteLength;remaining;constructor(e,t,i){const n=_t(e);t=t||0,i=i||n.length,this.buffer=e,this.uint8array=n.subarray(t,t+i),this.byteLength=i,this.remaining=i}substream(e){if(this.remaining<e)throw new Error(`ByteStream: substream: want ${e} bytes but have ${this.remaining}`);const t=this.index;return this.index+=e,new tt(this.uint8array.subarray(t,t+e))}skip(e){if(this.remaining<e)throw new Error(`ByteStream: skip: premature end - want ${e} bytes but have ${this.remaining}`);this.index+=e,this.remaining-=e}seek(e){this.index=e,this.remaining=this.byteLength-e}read(e){if(this.remaining<e)throw new Error(`ByteStream: read: premature end - want ${e} bytes but have ${this.remaining}`);const t=this.uint8array,i=this.index;let n=ls(t,0,i,e);return n===-1&&(n=i+e),this.index+=e,this.remaining-=e,Et(t.subarray(i,n))}readNull(){if(this.remaining<1)throw new Error("ByteStream: readNull: premature end - want at least 1 byte but have 0");const e=this.uint8array,t=this.index;let i=e.indexOf(0,t);i===-1&&(i=e.length-1);const n=i-t+1;return this.index+=n,this.remaining-=n,Et(e.subarray(t,i))}readBinary(e){if(this.remaining<e)throw new Error(`ByteStream: readBinary: premature end - want ${e} bytes but have ${this.remaining}`);const t=this.uint8array,i=this.index;let n="";for(let r=0;r<e;r++)n+=String.fromCharCode(t[i+r]);return this.index+=e,this.remaining-=e,n}readInt8(){if(this.remaining<1)throw new Error(`ByteStream: readInt8: premature end - want 1 byte but have ${this.remaining}`);const e=this.index,t=this.uint8array,i=ri(t[e]);return this.index+=1,this.remaining-=1,i}readInt16(){if(this.remaining<2)throw new Error(`ByteStream: readInt16: premature end - want 2 bytes but have ${this.remaining}`);const e=this.index,t=this.uint8array,i=oi(t[e],t[e+1]);return this.index+=2,this.remaining-=2,i}readInt32(){if(this.remaining<4)throw new Error(`ByteStream: readInt32: premature end - want 4 bytes but have ${this.remaining}`);const e=this.index,t=this.uint8array,i=ai(t[e],t[e+1],t[e+2],t[e+3]);return this.index+=4,this.remaining-=4,i}readUint8(){if(this.remaining<1)throw new Error(`ByteStream: readUint8: premature end - want 1 byte but have ${this.remaining}`);const e=this.uint8array[this.index];return this.index+=1,this.remaining-=1,e}readUint16(){if(this.remaining<2)throw new Error(`ByteStream: readUint16: premature end - want 2 bytes but have ${this.remaining}`);const e=this.index,t=this.uint8array,i=li(t[e],t[e+1]);return this.index+=2,this.remaining-=2,i}readUint32(){if(this.remaining<4)throw new Error(`ByteStream: readUint32: premature end - want 4 bytes but have ${this.remaining}`);const e=this.index,t=this.uint8array,i=ci(t[e],t[e+1],t[e+2],t[e+3]);return this.index+=4,this.remaining-=4,i}readFloat32(){if(this.remaining<4)throw new Error(`ByteStream: readFloat32: premature end - want 4 bytes but have ${this.remaining}`);const e=this.index,t=this.uint8array,i=hi(t[e],t[e+1],t[e+2],t[e+3]);return this.index+=4,this.remaining-=4,i}readFloat64(){if(this.remaining<8)throw new Error(`ByteStream: readFloat64: premature end - want 8 bytes but have ${this.remaining}`);const e=this.index,t=this.uint8array,i=di(t[e],t[e+1],t[e+2],t[e+3],t[e+4],t[e+5],t[e+6],t[e+7]);return this.index+=8,this.remaining-=8,i}readInt8Array(e){if(ArrayBuffer.isView(e)||(e=new Int8Array(e)),this.remaining<e.byteLength)throw new Error(`ByteStream: readInt8Array: premature end - want ${e.byteLength} bytes but have ${this.remaining}`);const t=this.index,i=this.uint8array;for(let n=0,r=e.length;n<r;n++)e[n]=ri(i[t+n]);return this.index+=e.byteLength,this.remaining-=e.byteLength,e}readInt16Array(e){if(ArrayBuffer.isView(e)||(e=new Int16Array(e)),this.remaining<e.byteLength)throw new Error(`ByteStream: readInt16Array: premature end - want ${e.byteLength} bytes but have ${this.remaining}`);const t=this.index,i=this.uint8array;for(let n=0,r=e.length;n<r;n++){const o=t+n*2;e[n]=oi(i[o],i[o+1])}return this.index+=e.byteLength,this.remaining-=e.byteLength,e}readInt32Array(e){if(ArrayBuffer.isView(e)||(e=new Int32Array(e)),this.remaining<e.byteLength)throw new Error(`ByteStream: readInt32Array: premature end - want ${e.byteLength} bytes but have ${this.remaining}`);const t=this.index,i=this.uint8array;for(let n=0,r=e.length;n<r;n++){const o=t+n*4;e[n]=ai(i[o],i[o+1],i[o+2],i[o+3])}return this.index+=e.byteLength,this.remaining-=e.byteLength,e}readUint8Array(e){if(ArrayBuffer.isView(e)||(e=new Uint8Array(e)),this.remaining<e.byteLength)throw new Error(`ByteStream: readUint8Array: premature end - want ${e.byteLength} bytes but have ${this.remaining}`);const t=this.index,i=this.uint8array;for(let n=0,r=e.length;n<r;n++)e[n]=i[t+n];return this.index+=e.byteLength,this.remaining-=e.byteLength,e}readUint16Array(e){if(ArrayBuffer.isView(e)||(e=new Uint16Array(e)),this.remaining<e.byteLength)throw new Error(`ByteStream: readUint16Array: premature end - want ${e.byteLength} bytes but have ${this.remaining}`);const t=this.index,i=this.uint8array;for(let n=0,r=e.length;n<r;n++){const o=t+n*2;e[n]=li(i[o],i[o+1])}return this.index+=e.byteLength,this.remaining-=e.byteLength,e}readUint32Array(e){if(ArrayBuffer.isView(e)||(e=new Uint32Array(e)),this.remaining<e.byteLength)throw new Error(`ByteStream: readUint32Array: premature end - want ${e.byteLength} bytes but have ${this.remaining}`);const t=this.index,i=this.uint8array;for(let n=0,r=e.length;n<r;n++){const o=t+n*4;e[n]=ci(i[o],i[o+1],i[o+2],i[o+3])}return this.index+=e.byteLength,this.remaining-=e.byteLength,e}readFloat32Array(e){if(ArrayBuffer.isView(e)||(e=new Float32Array(e)),this.remaining<e.byteLength)throw new Error(`ByteStream: readFloat32Array: premature end - want ${e.byteLength} bytes but have ${this.remaining}`);const t=this.index,i=this.uint8array;for(let n=0,r=e.length;n<r;n++){const o=t+n*4;e[n]=hi(i[o],i[o+1],i[o+2],i[o+3])}return this.index+=e.byteLength,this.remaining-=e.byteLength,e}readFloat64Array(e){if(ArrayBuffer.isView(e)||(e=new Float64Array(e)),this.remaining<e.byteLength)throw new Error(`ByteStream: readFloat64Array: premature end - want ${e.byteLength} bytes but have ${this.remaining}`);const t=this.index,i=this.uint8array;for(let n=0,r=e.length;n<r;n++){const o=t+n*8;e[n]=di(i[o],i[o+1],i[o+2],i[o+3],i[o+4],i[o+5],i[o+6],i[o+7])}return this.index+=e.byteLength,this.remaining-=e.byteLength,e}write(e){const t=St(e);return this.writeUint8Array(t),t.length}writeNull(e){const t=this.write(e);return this.index++,this.remaining--,t+1}writeBinary(e){const t=this.index,i=this.uint8array,n=e.length;for(let r=0;r<n;r++)i[t+r]=e.charCodeAt(r);this.index+=n}writeInt8(e){this.uint8array[this.index]=ui(e),this.index+=1}writeInt16(e){const t=this.index,i=this.uint8array;fi(x,e),i[t]=x[0],i[t+1]=x[1],this.index+=2}writeInt32(e){const t=this.index,i=this.uint8array;pi(x,e),i[t]=x[0],i[t+1]=x[1],i[t+2]=x[2],i[t+3]=x[3],this.index+=4}writeUint8(e){this.uint8array[this.index]=e,this.index+=1}writeUint16(e){const t=this.index,i=this.uint8array;vi(x,e),i[t]=x[0],i[t+1]=x[1],this.index+=2}writeUint32(e){const t=this.index,i=this.uint8array;bi(x,e),i[t]=x[0],i[t+1]=x[1],i[t+2]=x[2],i[t+3]=x[3],this.index+=4}writeFloat32(e){const t=this.index,i=this.uint8array;mi(x,e),i[t]=x[0],i[t+1]=x[1],i[t+2]=x[2],i[t+3]=x[3],this.index+=4}writeFloat64(e){const t=this.index,i=this.uint8array;gi(x,e),i[t]=x[0],i[t+1]=x[1],i[t+2]=x[2],i[t+3]=x[3],i[t+4]=x[4],i[t+5]=x[5],i[t+6]=x[6],i[t+7]=x[7],this.index+=8}writeInt8Array(e){const t=this.index,i=this.uint8array;for(let n=0,r=e.length;n<r;n++)i[t+n]=ui(e[n]);this.index+=e.byteLength}writeInt16Array(e){const t=this.index,i=this.uint8array;for(let n=0,r=e.length;n<r;n++){const o=t+n*2;fi(x,e[n]),i[o]=x[0],i[o+1]=x[1]}this.index+=e.byteLength}writeInt32Array(e){const t=this.index,i=this.uint8array;for(let n=0,r=e.length;n<r;n++){const o=t+n*4;pi(x,e[n]),i[o]=x[0],i[o+1]=x[1],i[o+2]=x[2],i[o+3]=x[3]}this.index+=e.byteLength}writeUint8Array(e){const t=this.index,i=this.uint8array;for(let n=0,r=e.length;n<r;n++)i[t+n]=e[n];this.index+=e.byteLength}writeUint16Array(e){const t=this.index,i=this.uint8array;for(let n=0,r=e.length;n<r;n++){const o=t+n*2;vi(x,e[n]),i[o]=x[0],i[o+1]=x[1]}this.index+=e.byteLength}writeUint32Array(e){const t=this.index,i=this.uint8array;for(let n=0,r=e.length;n<r;n++){const o=t+n*4;bi(x,e[n]),i[o]=x[0],i[o+1]=x[1],i[o+2]=x[2],i[o+3]=x[3]}this.index+=e.byteLength}writeFloat32Array(e){const t=this.index,i=this.uint8array;for(let n=0,r=e.length;n<r;n++){const o=t+n*4;mi(x,e[n]),i[o]=x[0],i[o+1]=x[1],i[o+2]=x[2],i[o+3]=x[3]}this.index+=e.byteLength}writeFloat64Array(e){const t=this.index,i=this.uint8array;for(let n=0,r=e.length;n<r;n++){const o=t+n*8;gi(x,e[n]),i[o]=x[0],i[o+1]=x[1],i[o+2]=x[2],i[o+3]=x[3],i[o+4]=x[4],i[o+5]=x[5],i[o+6]=x[6],i[o+7]=x[7]}this.index+=e.byteLength}}class cs{buffer;uint8array;index=0;byteLength;bitBuffer=0;bits=0;constructor(e,t,i){const n=_t(e);t=t||0,i=i||n.length,this.buffer=e,this.uint8array=n.subarray(t,t+i),this.byteLength=e.byteLength}peekBits(e){return this.loadBits(e),this.bitBuffer&(1<<e)-1}readBits(e){const t=this.peekBits(e);return this.bitBuffer>>>=e,this.bits-=e,t}skipBits(e){this.loadBits(e),this.bitBuffer>>>=e,this.bits-=e}loadBits(e){for(;this.bits<e;)this.bitBuffer+=this.uint8array[this.index]<<this.bits,this.bits+=8,this.index+=1}}function hs(s){if(s&&s.length){const e=s.lastIndexOf(".");return e!==-1&&(s=s.slice(e).toLowerCase()),s}return""}function ds(s){return s instanceof ArrayBuffer&&(s=new Uint8Array(s)),s instanceof Uint8Array&&s[0]===137&&s[1]===80&&s[2]===78&&s[3]===71&&s[4]===13&&s[5]===10&&s[6]===26&&s[7]===10}function us(s){return s instanceof ArrayBuffer&&(s=new Uint8Array(s)),s instanceof Uint8Array&&s[0]===255&&s[1]===216&&s[s.length-2]===255&&s[s.length-1]===217}function fs(s){return s instanceof ArrayBuffer&&(s=new Uint8Array(s)),s instanceof Uint8Array&&s[0]===71&&s[1]===73&&s[2]===70&&s[3]===56&&(s[4]===55||s[4]===57)&&s[5]===97}function ps(s){return s instanceof ArrayBuffer&&(s=new Uint8Array(s)),s instanceof Uint8Array&&s[0]===82&&s[1]===73&&s[2]===70&&s[3]===70&&s[8]===87&&s[9]===69&&s[10]===66&&s[11]===80}class vs{properties=new Map;sections=new Map;load(e){let t=this.properties;const i=this.sections;for(const n of e.split(`\r
`))if(n.length&&!n.startsWith("//")&&!n.startsWith(";")){let r=n.match(/^\[(.+?)\]/);if(r){const o=r[1].trim();t=i.get(o),t||(t=new Map,i.set(o,t))}else if(r=n.match(/^(.+?)=(.*?)$/),r){let o=r[2];o[0]==='"'&&(o=o.slice(1,-1)),t.set(r[1],o)}}}save(){const e=[];for(const[t,i]of this.properties)e.push(`${t}=${i}`);for(const[t,i]of this.sections){e.push(`[${t}]`);for(const[n,r]of i)e.push(`${n}=${r}`)}return e.join(`\r
`)}getSection(e){return this.sections.get(e)}}class bs{rows=[];load(e){if(!e.startsWith("ID"))throw new Error("WrongMagicNumber");const t=this.rows;let i=0,n=0;for(const r of e.split(`
`))if(r[0]!=="B")for(const o of r.split(";")){const a=o[0],l=o.substring(1).trim();let c;a==="X"?i=parseInt(l,10)-1:a==="Y"?n=parseInt(l,10)-1:a==="K"&&(t[n]||(t[n]=[]),l[0]==='"'?c=l.slice(1,-1):c=l,t[n][i]=c)}}save(){const e=this.rows,t=e.length,i=[];let n=0;for(let r=0;r<t;r++){const o=e[r],a=o.length;a>n&&(n=a);let l=!0;for(let c=0;c<a;c++){const u=o[c];if(u!==void 0){let h;typeof u=="string"?h=`"${u}"`:typeof u=="boolean"?u?h="TRUE":h="FALSE":h=`${u}`,l?(l=!1,i.push(`C;X${c+1};Y${r+1};K${h}`)):i.push(`C;X${c+1};K${h}`)}}}return`ID;P\r
B;X${n};Y${t}\r
${i.join(`\r
`)}\r
E`}}class wi{buffer;index=0;ident=0;indentSpaces=4;precision=1e6;constructor(e){this.buffer=e||""}clear(){this.buffer="",this.index=0,this.ident=0}readToken(){const e=this.buffer,t=e.length;let i=!1,n=!1,r="";for(;this.index<t;){const o=e[this.index++];if(i)o===`
`&&(i=!1);else if(n)if(o==="\\")r+=o+e[this.index++];else if(o===`
`)r+="\\n";else if(o==="\r")r+="\\r";else{if(o==='"')return r;r+=o}else if(o===" "||o===","||o==="	"||o===`
`||o===":"||o==="\r"){if(r.length)return r}else{if(o==="{"||o==="}")return r.length?(this.index--,r):o;if(o==="/"&&e[this.index]==="/"){if(r.length)return this.index--,r;i=!0}else if(o==='"'){if(r.length)return this.index--,r;n=!0}else r+=o}}}read(){const e=this.readToken();if(e===void 0)throw new Error("End of stream reached prematurely");return e}peek(){const e=this.index,t=this.read();return this.index=e,t}readInt(){return parseInt(this.read())}readFloat(){return parseFloat(this.read())}readVector(e){this.read();for(let t=0,i=e.length;t<i;t++)e[t]=this.readFloat();return this.read(),e}readVectorsBlock(e,t){this.read();for(let i=0,n=e.length;i<n;i+=t)this.readVector(e.subarray(i,i+t));return this.read(),e}readColor(e){return this.read(),e[2]=this.readFloat(),e[1]=this.readFloat(),e[0]=this.readFloat(),this.read(),e}*readBlock(){this.read();let e=this.read();for(;e!=="}";)yield e,e=this.read()}writeLine(e){this.buffer+=`${" ".repeat(this.ident*this.indentSpaces)}${e}
`}writeFlag(e){this.writeLine(`${e},`)}writeFlagAttrib(e,t){this.writeLine(`${e} ${t},`)}writeNumberAttrib(e,t){this.writeLine(`${e} ${this.floatDecimals(t)},`)}writeStringAttrib(e,t){this.writeLine(`${e} "${t}",`)}writeVectorAttrib(e,t){this.writeLine(`${e} { ${this.floatArrayDecimals(t)} },`)}writeColor(e,t){const i=this.floatDecimals(t[0]),n=this.floatDecimals(t[1]),r=this.floatDecimals(t[2]);this.writeLine(`${e} { ${r}, ${n}, ${i} },`)}writeVector(e){this.writeLine(`{ ${this.floatArrayDecimals(e)} },`)}writeVectorArrayBlock(e,t,i){this.startBlock(e,t.length/i);for(let n=0,r=t.length;n<r;n+=i)this.writeVector(t.subarray(n,n+i));this.endBlock()}startBlock(e,...t){t.length&&(e=`${e} ${t.join(" ")}`),this.writeLine(`${e} {`),this.ident+=1}startObjectBlock(e,t){this.writeLine(`${e} "${t.replace(/"/g,'\\"')}" {`),this.ident+=1}endBlock(){this.ident-=1,this.writeLine("}")}endBlockComma(){this.ident-=1,this.writeLine("},")}indent(){this.ident+=1}unindent(){this.ident-=1}floatDecimals(e){return`${Math.trunc(e*this.precision)/this.precision}`}floatArrayDecimals(e){if(e instanceof Float32Array){const t=[];for(let i=0,n=e.length;i<n;i++)t[i]=this.floatDecimals(e[i]);return t.join(", ")}else return e.join(", ")}}class Ke{boundsRadius=0;min=new Float32Array(3);max=new Float32Array(3);readMdx(e){this.boundsRadius=e.readFloat32(),e.readFloat32Array(this.min),e.readFloat32Array(this.max)}writeMdx(e){e.writeFloat32(this.boundsRadius),e.writeFloat32Array(this.min),e.writeFloat32Array(this.max)}writeMdl(e){(this.min[0]!==0||this.min[1]!==0||this.min[2]!==0)&&e.writeVectorAttrib("MinimumExtent",this.min),(this.max[0]!==0||this.max[1]!==0||this.max[2]!==0)&&e.writeVectorAttrib("MaximumExtent",this.max),this.boundsRadius!==0&&e.writeNumberAttrib("BoundsRadius",this.boundsRadius)}}let yi=class{name="";interval=new Uint32Array(2);moveSpeed=0;nonLooping=0;rarity=0;syncPoint=0;extent=new Ke;readMdx(e){this.name=e.read(80),e.readUint32Array(this.interval),this.moveSpeed=e.readFloat32(),this.nonLooping=e.readUint32(),this.rarity=e.readFloat32(),this.syncPoint=e.readUint32(),this.extent.readMdx(e)}writeMdx(e){e.skip(80-e.write(this.name)),e.writeUint32Array(this.interval),e.writeFloat32(this.moveSpeed),e.writeUint32(this.nonLooping),e.writeFloat32(this.rarity),e.writeUint32(this.syncPoint),this.extent.writeMdx(e)}readMdl(e){this.name=e.read();for(const t of e.readBlock())if(t==="Interval")e.readVector(this.interval);else if(t==="NonLooping")this.nonLooping=1;else if(t==="MoveSpeed")this.moveSpeed=e.readFloat();else if(t==="Rarity")this.rarity=e.readFloat();else if(t==="MinimumExtent")e.readVector(this.extent.min);else if(t==="MaximumExtent")e.readVector(this.extent.max);else if(t==="BoundsRadius")this.extent.boundsRadius=e.readFloat();else throw new Error(`Unknown token in Sequence: "${t}"`)}writeMdl(e){e.startObjectBlock("Anim",this.name),e.writeVectorAttrib("Interval",this.interval),this.nonLooping===1&&e.writeFlag("NonLooping"),this.moveSpeed!==0&&e.writeNumberAttrib("MoveSpeed",this.moveSpeed),this.rarity!==0&&e.writeNumberAttrib("Rarity",this.rarity),this.extent.writeMdl(e),e.endBlock()}};var Y=(s=>(s[s.DontInterp=0]="DontInterp",s[s.Linear=1]="Linear",s[s.Hermite=2]="Hermite",s[s.Bezier=3]="Bezier",s))(Y||{});class it{name="";interpolationType=0;globalSequenceId=-1;frames=[];values=[];inTans=[];outTans=[];readMdx(e,t){const i=this.frames,n=this.values,r=this.inTans,o=this.outTans,a=e.readUint32(),l=e.readUint32();this.name=t,this.interpolationType=l,this.globalSequenceId=e.readInt32();for(let c=0;c<a;c++)i.push(e.readInt32()),n.push(this.readMdxValue(e)),l>1&&(r.push(this.readMdxValue(e)),o.push(this.readMdxValue(e)))}writeMdx(e){const t=this.interpolationType,i=this.frames,n=this.values,r=this.inTans,o=this.outTans,a=i.length;e.writeBinary(this.name),e.writeUint32(a),e.writeUint32(t),e.writeInt32(this.globalSequenceId);for(let l=0;l<a;l++)e.writeInt32(i[l]),this.writeMdxValue(e,n[l]),t>1&&(this.writeMdxValue(e,r[l]),this.writeMdxValue(e,o[l]))}readMdl(e,t){const i=this.frames,n=this.values,r=this.inTans,o=this.outTans;this.name=t;const a=e.readInt();e.read();let l=0;const c=e.read();c==="DontInterp"?l=0:c==="Linear"?l=1:c==="Hermite"?l=2:c==="Bezier"&&(l=3),this.interpolationType=l,e.peek()==="GlobalSeqId"&&(e.read(),this.globalSequenceId=e.readInt());for(let u=0;u<a;u++)i[u]=e.readInt(),n[u]=this.readMdlValue(e),l>1&&(e.read(),r[u]=this.readMdlValue(e),e.read(),o[u]=this.readMdlValue(e));e.read()}writeMdl(e,t){const i=this.interpolationType,n=this.frames,r=this.values,o=this.inTans,a=this.outTans,l=n.length;e.startBlock(t,this.frames.length);let c="";this.interpolationType===0?c="DontInterp":this.interpolationType===1?c="Linear":this.interpolationType===2?c="Hermite":this.interpolationType===3&&(c="Bezier"),e.writeFlag(c),this.globalSequenceId!==-1&&e.writeNumberAttrib("GlobalSeqId",this.globalSequenceId);for(let u=0;u<l;u++)this.writeMdlValue(e,`${n[u]}:`,r[u]),i>1&&(e.indent(),this.writeMdlValue(e,"InTan",o[u]),this.writeMdlValue(e,"OutTan",a[u]),e.unindent());e.endBlock()}getByteLength(){const e=this.frames.length;let t=16;if(e){const i=this.values[0].byteLength;let n=1;this.interpolationType>1&&(n=3),t+=(4+n*i)*e}return t}}class nt extends it{readMdxValue(e){return e.readUint32Array(1)}writeMdxValue(e,t){e.writeUint32(t[0])}readMdlValue(e){return new Uint32Array([e.readInt()])}writeMdlValue(e,t,i){e.writeNumberAttrib(t,i[0])}}class P extends it{readMdxValue(e){return e.readFloat32Array(1)}writeMdxValue(e,t){e.writeFloat32(t[0])}readMdlValue(e){return new Float32Array([e.readFloat()])}writeMdlValue(e,t,i){e.writeNumberAttrib(t,i[0])}}class se extends it{readMdxValue(e){return e.readFloat32Array(3)}writeMdxValue(e,t){e.writeFloat32Array(t)}readMdlValue(e){return e.readVector(new Float32Array(3))}writeMdlValue(e,t,i){e.writeVectorAttrib(t,i)}}class Ai extends it{readMdxValue(e){return e.readFloat32Array(4)}writeMdxValue(e,t){e.writeFloat32Array(t)}readMdlValue(e){return e.readVector(new Float32Array(4))}writeMdlValue(e,t,i){e.writeVectorAttrib(t,i)}}const It={KMTF:["TextureID",nt],KMTA:["Alpha",P],KMTE:["EmissiveGain",P],KFC3:["FresnelColor",se],KFCA:["FresnelOpacity",P],KFTC:["FresnelTeamColor",nt],KTAT:["Translation",se],KTAR:["Rotation",Ai],KTAS:["Scaling",se],KGAO:["Alpha",P],KGAC:["Color",se],KGTR:["Translation",se],KGRT:["Rotation",Ai],KGSC:["Scaling",se],KLAS:["AttenuationStart",P],KLAE:["AttenuationEnd",P],KLAC:["Color",se],KLAI:["Intensity",P],KLBI:["AmbIntensity",P],KLBC:["AmbColor",se],KLAV:["Visibility",P],KATV:["Visibility",P],KPEE:["EmissionRate",P],KPEG:["Gravity",P],KPLN:["Longitude",P],KPLT:["Latitude",P],KPEL:["LifeSpan",P],KPES:["InitVelocity",P],KPEV:["Visibility",P],KP2S:["Speed",P],KP2R:["Variation",P],KP2L:["Latitude",P],KP2G:["Gravity",P],KP2E:["EmissionRate",P],KP2N:["Width",P],KP2W:["Length",P],KP2V:["Visibility",P],KPPA:["Alpha",P],KPPC:["Color",se],KPPE:["EmissionRate",P],KPPL:["LifeSpan",P],KPPS:["Speed",P],KPPV:["Visibility",P],KRHA:["HeightAbove",P],KRHB:["HeightBelow",P],KRAL:["Alpha",P],KRCO:["Color",se],KRTX:["TextureSlot",nt],KRVS:["Visibility",P],KCTR:["Translation",se],KTTR:["Translation",se],KCRL:["Rotation",P]};let qe=class{animations=[];readAnimations(e,t){const i=e.index+t;for(;e.index<i;){const n=e.readBinary(4),r=new It[n][1];r.readMdx(e,n),this.animations.push(r)}}writeAnimations(e){for(const t of this.animations)t.writeMdx(e)}*readAnimatedBlock(e){for(const t of e.readBlock())t==="static"?yield`static ${e.read()}`:yield t}readAnimation(e,t){const i=new It[t][1];i.readMdl(e,t),this.animations.push(i)}writeAnimation(e,t){for(const i of this.animations)if(i.name===t)return i.writeMdl(e,It[t][0]),!0;return!1}getByteLength(e=0){let t=0;for(const i of this.animations)t+=i.getByteLength();return t}};var de=(s=>(s[s.None=0]="None",s[s.Transparent=1]="Transparent",s[s.Blend=2]="Blend",s[s.Additive=3]="Additive",s[s.AddAlpha=4]="AddAlpha",s[s.Modulate=5]="Modulate",s[s.Modulate2x=6]="Modulate2x",s))(de||{}),Ee=(s=>(s[s.None=0]="None",s[s.Unshaded=1]="Unshaded",s[s.SphereEnvMap=2]="SphereEnvMap",s[s.TwoSided=16]="TwoSided",s[s.Unfogged=32]="Unfogged",s[s.NoDepthTest=64]="NoDepthTest",s[s.NoDepthSet=128]="NoDepthSet",s[s.Unlit=256]="Unlit",s))(Ee||{});function ms(s){return s==="None"?0:s==="Transparent"?1:s==="Blend"?2:s==="Additive"?3:s==="AddAlpha"?4:s==="Modulate"?5:s==="Modulate2x"?6:0}function gs(s){return s===0?"None":s===1?"Transparent":s===2?"Blend":s===3?"Additive":s===4?"AddAlpha":s===5?"Modulate":s===6?"Modulate2x":"None"}let Ti=class extends qe{filterMode=0;flags=0;textureId=-1;textureAnimationId=-1;coordId=0;alpha=1;emissiveGain=1;fresnelColor=new Float32Array([1,1,1]);fresnelOpacity=0;fresnelTeamColor=0;readMdx(e,t){const i=e.index,n=e.readUint32();this.filterMode=e.readUint32(),this.flags=e.readUint32(),this.textureId=e.readInt32(),this.textureAnimationId=e.readInt32(),this.coordId=e.readUint32(),this.alpha=e.readFloat32(),t>800&&(this.emissiveGain=e.readFloat32(),e.readFloat32Array(this.fresnelColor),this.fresnelOpacity=e.readFloat32(),this.fresnelTeamColor=e.readFloat32()),this.readAnimations(e,n-(e.index-i))}writeMdx(e,t){e.writeUint32(this.getByteLength(t)),e.writeUint32(this.filterMode),e.writeUint32(this.flags),e.writeInt32(this.textureId),e.writeInt32(this.textureAnimationId),e.writeUint32(this.coordId),e.writeFloat32(this.alpha),t>800&&(e.writeFloat32(this.emissiveGain),e.writeFloat32Array(this.fresnelColor),e.writeFloat32(this.fresnelOpacity),e.writeFloat32(this.fresnelTeamColor)),this.writeAnimations(e)}readMdl(e){for(const t of super.readAnimatedBlock(e))if(t==="FilterMode")this.filterMode=ms(e.read());else if(t==="Unshaded")this.flags|=1;else if(t==="SphereEnvMap")this.flags|=2;else if(t==="TwoSided")this.flags|=16;else if(t==="Unfogged")this.flags|=32;else if(t==="NoDepthTest")this.flags|=64;else if(t==="NoDepthSet")this.flags|=128;else if(t==="Unlit")this.flags|=256;else if(t==="static TextureID")this.textureId=e.readInt();else if(t==="TextureID")this.readAnimation(e,"KMTF");else if(t==="TVertexAnimId")this.textureAnimationId=e.readInt();else if(t==="CoordId")this.coordId=e.readInt();else if(t==="static Alpha")this.alpha=e.readFloat();else if(t==="Alpha")this.readAnimation(e,"KMTA");else if(t==="static EmissiveGain")this.emissiveGain=e.readFloat();else if(t==="EmissiveGain")this.readAnimation(e,"KMTE");else if(t==="static FresnelColor")e.readVector(this.fresnelColor);else if(t==="FresnelColor")this.readAnimation(e,"KFC3");else if(t==="static FresnelOpacity")this.fresnelOpacity=e.readFloat();else if(t==="FresnelOpacity")this.readAnimation(e,"KFCA");else if(t==="static FresnelTeamColor")this.fresnelTeamColor=e.readFloat();else if(t==="FresnelTeamColor")this.readAnimation(e,"KFTC");else throw new Error(`Unknown token in Layer: "${t}"`)}writeMdl(e,t){e.startBlock("Layer"),e.writeFlagAttrib("FilterMode",gs(this.filterMode)),this.flags&1&&e.writeFlag("Unshaded"),this.flags&2&&e.writeFlag("SphereEnvMap"),this.flags&16&&e.writeFlag("TwoSided"),this.flags&32&&e.writeFlag("Unfogged"),this.flags&64&&e.writeFlag("NoDepthTest"),this.flags&128&&e.writeFlag("NoDepthSet"),t>800&&this.flags&256&&e.writeFlag("Unlit"),this.writeAnimation(e,"KMTF")||e.writeNumberAttrib("static TextureID",this.textureId),this.textureAnimationId!==-1&&e.writeNumberAttrib("TVertexAnimId",this.textureAnimationId),this.coordId!==0&&e.writeNumberAttrib("CoordId",this.coordId),!this.writeAnimation(e,"KMTA")&&this.alpha!==1&&e.writeNumberAttrib("static Alpha",this.alpha),t>800&&(!this.writeAnimation(e,"KMTE")&&this.emissiveGain!==1&&e.writeNumberAttrib("static EmissiveGain",this.emissiveGain),!this.writeAnimation(e,"KFC3")&&(this.fresnelColor[0]!==1||this.fresnelColor[1]!==1||this.fresnelColor[2]!==1)&&e.writeVectorAttrib("static FresnelColor",this.fresnelColor),!this.writeAnimation(e,"KFCA")&&this.fresnelOpacity!==0&&e.writeNumberAttrib("static FresnelOpacity",this.fresnelOpacity),!this.writeAnimation(e,"KFTC")&&this.fresnelTeamColor!==0&&e.writeNumberAttrib("static FresnelTeamColor",this.fresnelTeamColor)),e.endBlock()}getByteLength(e){let t=28+super.getByteLength();return e>800&&(t+=24),t}},xi=class{priorityPlane=0;flags=0;shader="";layers=[];readMdx(e,t){e.readUint32(),this.priorityPlane=e.readInt32(),this.flags=e.readUint32(),t>800&&(this.shader=e.read(80)),e.skip(4);for(let i=0,n=e.readUint32();i<n;i++){const r=new Ti;r.readMdx(e,t),this.layers.push(r)}}writeMdx(e,t){e.writeUint32(this.getByteLength(t)),e.writeInt32(this.priorityPlane),e.writeUint32(this.flags),t>800&&e.skip(80-e.write(this.shader)),e.writeBinary("LAYS"),e.writeUint32(this.layers.length);for(const i of this.layers)i.writeMdx(e,t)}readMdl(e){for(const t of e.readBlock())if(t==="ConstantColor")this.flags|=1;else if(t==="TwoSided")this.flags|=2;else if(t==="SortPrimsNearZ")this.flags|=8;else if(t==="SortPrimsFarZ")this.flags|=16;else if(t==="FullResolution")this.flags|=32;else if(t==="PriorityPlane")this.priorityPlane=e.readInt();else if(t==="Shader")this.shader=e.read();else if(t==="Layer"){const i=new Ti;i.readMdl(e),this.layers.push(i)}else throw new Error(`Unknown token in Material: "${t}"`)}writeMdl(e,t){e.startBlock("Material"),this.flags&1&&e.writeFlag("ConstantColor"),t>800&&this.flags&2&&e.writeFlag("TwoSided"),this.flags&8&&e.writeFlag("SortPrimsNearZ"),this.flags&16&&e.writeFlag("SortPrimsFarZ"),this.flags&32&&e.writeFlag("FullResolution"),this.priorityPlane!==0&&e.writeNumberAttrib("PriorityPlane",this.priorityPlane),t>800&&e.writeStringAttrib("Shader",this.shader);for(const i of this.layers)i.writeMdl(e,t);e.endBlock()}getByteLength(e){let t=20;e>800&&(t+=80);for(const i of this.layers)t+=i.getByteLength(e);return t}};var Se=(s=>(s[s.RepeatBoth=0]="RepeatBoth",s[s.WrapWidth=1]="WrapWidth",s[s.WrapHeight=2]="WrapHeight",s[s.WrapBoth=3]="WrapBoth",s))(Se||{});let Ei=class{replaceableId=0;path="";wrapMode=0;readMdx(e){this.replaceableId=e.readUint32(),this.path=e.read(260),this.wrapMode=e.readUint32()}writeMdx(e){e.writeUint32(this.replaceableId),e.skip(260-e.write(this.path)),e.writeUint32(this.wrapMode)}readMdl(e){for(const t of e.readBlock())if(t==="Image")this.path=e.read();else if(t==="ReplaceableId")this.replaceableId=e.readInt();else if(t==="WrapWidth")this.wrapMode|=1;else if(t==="WrapHeight")this.wrapMode|=2;else throw new Error(`Unknown token in Texture: "${t}"`)}writeMdl(e){e.startBlock("Bitmap"),this.path.length&&e.writeStringAttrib("Image",this.path),this.replaceableId!==0&&e.writeNumberAttrib("ReplaceableId",this.replaceableId),this.wrapMode&1&&e.writeFlag("WrapWidth"),this.wrapMode&2&&e.writeFlag("WrapHeight"),e.endBlock()}},Si=class extends qe{readMdx(e){const t=e.readUint32();this.readAnimations(e,t-4)}writeMdx(e){e.writeUint32(this.getByteLength()),this.writeAnimations(e)}readMdl(e){for(const t of e.readBlock())if(t==="Translation")this.readAnimation(e,"KTAT");else if(t==="Rotation")this.readAnimation(e,"KTAR");else if(t==="Scaling")this.readAnimation(e,"KTAS");else throw new Error(`Unknown token in TextureAnimation: "${t}"`)}writeMdl(e){e.startBlock("TVertexAnim "),this.writeAnimation(e,"KTAT"),this.writeAnimation(e,"KTAR"),this.writeAnimation(e,"KTAS"),e.endBlock()}getByteLength(){return 4+super.getByteLength()}},_i=class{vertices=new Float32Array(0);normals=new Float32Array(0);faceTypeGroups=new Uint32Array(0);faceGroups=new Uint32Array(0);faces=new Uint16Array(0);vertexGroups=new Uint8Array(0);matrixGroups=new Uint32Array(0);matrixIndices=new Uint32Array(0);materialId=0;selectionGroup=0;selectionFlags=0;lod=-1;lodName="";extent=new Ke;sequenceExtents=[];tangents=new Float32Array(0);skin=new Uint8Array(0);uvSets=[];readMdx(e,t){e.readUint32(),e.skip(4),this.vertices=e.readFloat32Array(e.readUint32()*3),e.skip(4),this.normals=e.readFloat32Array(e.readUint32()*3),e.skip(4),this.faceTypeGroups=e.readUint32Array(e.readUint32()),e.skip(4),this.faceGroups=e.readUint32Array(e.readUint32()),e.skip(4),this.faces=e.readUint16Array(e.readUint32()),e.skip(4),this.vertexGroups=e.readUint8Array(e.readUint32()),e.skip(4),this.matrixGroups=e.readUint32Array(e.readUint32()),e.skip(4),this.matrixIndices=e.readUint32Array(e.readUint32()),this.materialId=e.readUint32(),this.selectionGroup=e.readUint32(),this.selectionFlags=e.readUint32(),t>800&&(this.lod=e.readInt32(),this.lodName=e.read(80)),this.extent.readMdx(e);for(let i=0,n=e.readUint32();i<n;i++){const r=new Ke;r.readMdx(e),this.sequenceExtents.push(r)}t>800&&(e.readBinary(4)==="TANG"?this.tangents=e.readFloat32Array(e.readUint32()*4):e.skip(-4),e.readBinary(4)==="SKIN"?this.skin=e.readUint8Array(e.readUint32()):e.skip(-4)),e.skip(4);for(let i=0,n=e.readUint32();i<n;i++)e.skip(4),this.uvSets.push(e.readFloat32Array(e.readUint32()*2))}writeMdx(e,t){e.writeUint32(this.getByteLength(t)),e.writeBinary("VRTX"),e.writeUint32(this.vertices.length/3),e.writeFloat32Array(this.vertices),e.writeBinary("NRMS"),e.writeUint32(this.normals.length/3),e.writeFloat32Array(this.normals),e.writeBinary("PTYP"),e.writeUint32(this.faceTypeGroups.length),e.writeUint32Array(this.faceTypeGroups),e.writeBinary("PCNT"),e.writeUint32(this.faceGroups.length),e.writeUint32Array(this.faceGroups),e.writeBinary("PVTX"),e.writeUint32(this.faces.length),e.writeUint16Array(this.faces),e.writeBinary("GNDX"),e.writeUint32(this.vertexGroups.length),e.writeUint8Array(this.vertexGroups),e.writeBinary("MTGC"),e.writeUint32(this.matrixGroups.length),e.writeUint32Array(this.matrixGroups),e.writeBinary("MATS"),e.writeUint32(this.matrixIndices.length),e.writeUint32Array(this.matrixIndices),e.writeUint32(this.materialId),e.writeUint32(this.selectionGroup),e.writeUint32(this.selectionFlags),t>800&&(e.writeInt32(this.lod),e.skip(80-e.write(this.lodName))),this.extent.writeMdx(e),e.writeUint32(this.sequenceExtents.length);for(const i of this.sequenceExtents)i.writeMdx(e);t>800&&(this.tangents.length&&(e.writeBinary("TANG"),e.writeUint32(this.tangents.length/4),e.writeFloat32Array(this.tangents)),this.skin.length&&(e.writeBinary("SKIN"),e.writeUint32(this.skin.length),e.writeUint8Array(this.skin))),e.writeBinary("UVAS"),e.writeUint32(this.uvSets.length);for(const i of this.uvSets)e.writeBinary("UVBS"),e.writeUint32(i.length/2),e.writeFloat32Array(i)}readMdl(e){for(let t of e.readBlock())if(t==="Vertices")this.vertices=e.readVectorsBlock(new Float32Array(e.readInt()*3),3);else if(t==="Normals")this.normals=e.readVectorsBlock(new Float32Array(e.readInt()*3),3);else if(t==="TVertices")this.uvSets.push(e.readVectorsBlock(new Float32Array(e.readInt()*2),2));else if(t==="VertexGroup"){const i=[];for(const n of e.readBlock())i.push(parseInt(n));this.vertexGroups=new Uint8Array(i)}else if(t==="Tangents")this.tangents=e.readVectorsBlock(new Float32Array(e.readInt()*4),4);else if(t==="SkinWeights")this.skin=e.readVector(new Uint8Array(e.readInt()*8));else if(t==="Faces"){this.faceTypeGroups=new Uint32Array([4]);const i=e.readInt(),n=e.readInt();e.read(),e.read(),this.faces=e.readVectorsBlock(new Uint16Array(n),n/i),this.faceGroups=new Uint32Array([n]),e.read()}else if(t==="Groups"){const i=[],n=[];e.readInt(),e.readInt();for(const r of e.readBlock()){let o=0;for(const a of e.readBlock())i.push(parseInt(a)),o+=1;n.push(o)}this.matrixIndices=new Uint32Array(i),this.matrixGroups=new Uint32Array(n)}else if(t==="MinimumExtent")e.readVector(this.extent.min);else if(t==="MaximumExtent")e.readVector(this.extent.max);else if(t==="BoundsRadius")this.extent.boundsRadius=e.readFloat();else if(t==="Anim"){const i=new Ke;for(t of e.readBlock())t==="MinimumExtent"?e.readVector(i.min):t==="MaximumExtent"?e.readVector(i.max):t==="BoundsRadius"&&(i.boundsRadius=e.readFloat());this.sequenceExtents.push(i)}else if(t==="MaterialID")this.materialId=e.readInt();else if(t==="SelectionGroup")this.selectionGroup=e.readInt();else if(t==="Unselectable")this.selectionFlags=4;else if(t==="LevelOfDetail")this.lod=e.readInt();else if(t==="Name")this.lodName=e.read();else throw new Error(`Unknown token in Geoset: "${t}"`)}writeMdl(e,t){e.startBlock("Geoset"),e.writeVectorArrayBlock("Vertices",this.vertices,3),e.writeVectorArrayBlock("Normals",this.normals,3);for(const n of this.uvSets)e.writeVectorArrayBlock("TVertices",n,2);if(t>800&&this.tangents.length&&e.writeVectorArrayBlock("Tangents",this.tangents,4),this.vertexGroups.length){e.startBlock("VertexGroup");for(let n=0,r=this.vertexGroups.length;n<r;n++)e.writeLine(`${this.vertexGroups[n]},`);e.endBlock()}if(t>800&&this.skin.length){e.startBlock("SkinWeights",this.skin.length/8);for(let n=0,r=this.skin.length;n<r;n+=8)e.writeLine(`${this.skin.subarray(n,n+8).join(", ")},`);e.endBlock()}e.startBlock("Faces",1,this.faces.length),e.startBlock("Triangles"),e.writeVector(this.faces),e.endBlock(),e.endBlock(),e.startBlock("Groups",this.matrixGroups.length,this.matrixIndices.length);let i=0;for(const n of this.matrixGroups)e.writeVectorAttrib("Matrices",this.matrixIndices.subarray(i,i+n)),i+=n;e.endBlock(),this.extent.writeMdl(e);for(const n of this.sequenceExtents)e.startBlock("Anim"),n.writeMdl(e),e.endBlock();e.writeNumberAttrib("MaterialID",this.materialId),e.writeNumberAttrib("SelectionGroup",this.selectionGroup),this.selectionFlags===4&&e.writeFlag("Unselectable"),t>800&&(e.writeNumberAttrib("LevelOfDetail",this.lod),this.lodName.length&&e.writeStringAttrib("Name",this.lodName)),e.endBlock()}getByteLength(e){let t=120+this.vertices.byteLength+this.normals.byteLength+this.faceTypeGroups.byteLength+this.faceGroups.byteLength+this.faces.byteLength+this.vertexGroups.byteLength+this.matrixGroups.byteLength+this.matrixIndices.byteLength+this.sequenceExtents.length*28;e>800&&(t+=84,this.tangents.length&&(t+=8+this.tangents.byteLength),this.skin.length&&(t+=8+this.skin.byteLength));for(const i of this.uvSets)t+=8+i.byteLength;return t}},Ii=class extends qe{alpha=1;flags=0;color=new Float32Array([1,1,1]);geosetId=-1;readMdx(e){const t=e.readUint32();this.alpha=e.readFloat32(),this.flags=e.readUint32(),e.readFloat32Array(this.color),this.geosetId=e.readInt32(),this.readAnimations(e,t-28)}writeMdx(e){e.writeUint32(this.getByteLength()),e.writeFloat32(this.alpha),e.writeUint32(this.flags),e.writeFloat32Array(this.color),e.writeInt32(this.geosetId),this.writeAnimations(e)}readMdl(e){for(const t of super.readAnimatedBlock(e))if(t==="DropShadow")this.flags|=1;else if(t==="static Alpha")this.alpha=e.readFloat();else if(t==="Alpha")this.readAnimation(e,"KGAO");else if(t==="static Color")this.flags|=2,e.readColor(this.color);else if(t==="Color")this.flags|=2,this.readAnimation(e,"KGAC");else if(t==="GeosetId")this.geosetId=e.readInt();else throw new Error(`Unknown token in GeosetAnimation: "${t}"`)}writeMdl(e){e.startBlock("GeosetAnim"),this.flags&1&&e.writeFlag("DropShadow"),this.writeAnimation(e,"KGAO")||e.writeNumberAttrib("static Alpha",this.alpha),this.flags&2&&!this.writeAnimation(e,"KGAC")&&(this.color[0]!==1||this.color[1]!==1||this.color[2]!==1)&&e.writeColor("static Color ",this.color),e.writeNumberAttrib("GeosetId",this.geosetId),e.endBlock()}getByteLength(){return 28+super.getByteLength()}};var we=(s=>(s[s.None=0]="None",s[s.DontInheritTranslation=1]="DontInheritTranslation",s[s.DontInheritScaling=2]="DontInheritScaling",s[s.DontInheritRotation=4]="DontInheritRotation",s[s.Billboarded=8]="Billboarded",s[s.BillboardedLockX=16]="BillboardedLockX",s[s.BillboardedLockY=32]="BillboardedLockY",s[s.BillboardedLockZ=64]="BillboardedLockZ",s[s.CameraAnchored=128]="CameraAnchored",s))(we||{});let fe=class extends qe{name="";objectId=-1;parentId=-1;flags;constructor(e=0){super(),this.flags=e}readMdx(e){const t=e.readUint32();this.name=e.read(80),this.objectId=e.readInt32(),this.parentId=e.readInt32(),this.flags=e.readUint32(),this.readAnimations(e,t-96)}writeMdx(e){e.writeUint32(this.getGenericByteLength()),e.skip(80-e.write(this.name)),e.writeInt32(this.objectId),e.writeInt32(this.parentId),e.writeUint32(this.flags);for(const t of this.eachAnimation(!0))t.writeMdx(e)}writeNonGenericAnimationChunks(e){for(const t of this.eachAnimation(!1))t.writeMdx(e)}*readGenericBlock(e){this.name=e.read();for(let t of this.readAnimatedBlock(e))if(t==="ObjectId")this.objectId=e.readInt();else if(t==="Parent")this.parentId=e.readInt();else if(t==="BillboardedLockZ")this.flags|=64;else if(t==="BillboardedLockY")this.flags|=32;else if(t==="BillboardedLockX")this.flags|=16;else if(t==="Billboarded")this.flags|=8;else if(t==="CameraAnchored")this.flags|=128;else if(t==="DontInherit")for(t of e.readBlock())t==="Rotation"?this.flags|=4:t==="Translation"?this.flags|=1:t==="Scaling"&&(this.flags|=2);else t==="Translation"?this.readAnimation(e,"KGTR"):t==="Rotation"?this.readAnimation(e,"KGRT"):t==="Scaling"?this.readAnimation(e,"KGSC"):yield t}writeGenericHeader(e){e.writeNumberAttrib("ObjectId",this.objectId),this.parentId!==-1&&e.writeNumberAttrib("Parent",this.parentId),this.flags&64&&e.writeFlag("BillboardedLockZ"),this.flags&32&&e.writeFlag("BillboardedLockY"),this.flags&16&&e.writeFlag("BillboardedLockX"),this.flags&8&&e.writeFlag("Billboarded"),this.flags&128&&e.writeFlag("CameraAnchored"),this.flags&4&&e.writeFlag("DontInherit { Rotation }"),this.flags&1&&e.writeFlag("DontInherit { Translation }"),this.flags&2&&e.writeFlag("DontInherit { Scaling }")}writeGenericAnimations(e){this.writeAnimation(e,"KGTR"),this.writeAnimation(e,"KGRT"),this.writeAnimation(e,"KGSC")}*eachAnimation(e){for(const t of this.animations){const i=t.name,n=i==="KGTR"||i==="KGRT"||i==="KGSC";(e&&n||!e&&!n)&&(yield t)}}getGenericByteLength(){let e=96;for(const t of this.eachAnimation(!0))e+=t.getByteLength();return e}getByteLength(){return 96+super.getByteLength()}},Li=class extends fe{geosetId=-1;geosetAnimationId=-1;constructor(){super(256)}readMdx(e){super.readMdx(e),this.geosetId=e.readInt32(),this.geosetAnimationId=e.readInt32()}writeMdx(e){super.writeMdx(e),e.writeInt32(this.geosetId),e.writeInt32(this.geosetAnimationId)}readMdl(e){for(let t of super.readGenericBlock(e))if(t==="GeosetId")t=e.read(),t==="Multiple"?this.geosetId=-1:this.geosetId=parseInt(t);else if(t==="GeosetAnimId")t=e.read(),t==="None"?this.geosetAnimationId=-1:this.geosetAnimationId=parseInt(t);else throw new Error(`Unknown token in Bone ${this.name}: "${t}"`)}writeMdl(e){e.startObjectBlock("Bone",this.name),this.writeGenericHeader(e),this.geosetId===-1?e.writeFlagAttrib("GeosetId","Multiple"):e.writeNumberAttrib("GeosetId",this.geosetId),this.geosetAnimationId===-1?e.writeFlagAttrib("GeosetAnimId","None"):e.writeNumberAttrib("GeosetAnimId",this.geosetAnimationId),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 8+super.getByteLength()}},Ci=class extends fe{type=-1;attenuation=new Float32Array(2);color=new Float32Array(3);intensity=0;ambientColor=new Float32Array(3);ambientIntensity=0;constructor(){super(512)}readMdx(e){const t=e.index,i=e.readUint32();super.readMdx(e),this.type=e.readUint32(),e.readFloat32Array(this.attenuation),e.readFloat32Array(this.color),this.intensity=e.readFloat32(),e.readFloat32Array(this.ambientColor),this.ambientIntensity=e.readFloat32(),this.readAnimations(e,i-(e.index-t))}writeMdx(e){e.writeUint32(this.getByteLength()),super.writeMdx(e),e.writeUint32(this.type),e.writeFloat32Array(this.attenuation),e.writeFloat32Array(this.color),e.writeFloat32(this.intensity),e.writeFloat32Array(this.ambientColor),e.writeFloat32(this.ambientIntensity),this.writeNonGenericAnimationChunks(e)}readMdl(e){for(const t of super.readGenericBlock(e))if(t==="Omnidirectional")this.type=0;else if(t==="Directional")this.type=1;else if(t==="Ambient")this.type=2;else if(t==="static AttenuationStart")this.attenuation[0]=e.readFloat();else if(t==="AttenuationStart")this.readAnimation(e,"KLAS");else if(t==="static AttenuationEnd")this.attenuation[1]=e.readFloat();else if(t==="AttenuationEnd")this.readAnimation(e,"KLAE");else if(t==="static Intensity")this.intensity=e.readFloat();else if(t==="Intensity")this.readAnimation(e,"KLAI");else if(t==="static Color")e.readColor(this.color);else if(t==="Color")this.readAnimation(e,"KLAC");else if(t==="static AmbIntensity")this.ambientIntensity=e.readFloat();else if(t==="AmbIntensity")this.readAnimation(e,"KLBI");else if(t==="static AmbColor")e.readColor(this.ambientColor);else if(t==="AmbColor")this.readAnimation(e,"KLBC");else if(t==="Visibility")this.readAnimation(e,"KLAV");else throw new Error(`Unknown token in Light: "${t}"`)}writeMdl(e){e.startObjectBlock("Light",this.name),this.writeGenericHeader(e),this.type===0?e.writeFlag("Omnidirectional"):this.type===1?e.writeFlag("Directional"):this.type===2&&e.writeFlag("Ambient"),this.writeAnimation(e,"KLAS")||e.writeNumberAttrib("static AttenuationStart",this.attenuation[0]),this.writeAnimation(e,"KLAE")||e.writeNumberAttrib("static AttenuationEnd",this.attenuation[1]),this.writeAnimation(e,"KLAI")||e.writeNumberAttrib("static Intensity",this.intensity),this.writeAnimation(e,"KLAC")||e.writeColor("static Color",this.color),this.writeAnimation(e,"KLBI")||e.writeNumberAttrib("static AmbIntensity",this.ambientIntensity),this.writeAnimation(e,"KLBC")||e.writeColor("static AmbColor",this.ambientColor),this.writeAnimation(e,"KLAV"),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 48+super.getByteLength()}},Ri=class extends fe{readMdl(e){for(const t of super.readGenericBlock(e))throw new Error(`Unknown token in Helper: "${t}"`)}writeMdl(e){e.startObjectBlock("Helper",this.name),this.writeGenericHeader(e),this.writeGenericAnimations(e),e.endBlock()}},Bi=class extends fe{path="";attachmentId=0;constructor(){super(2048)}readMdx(e){const t=e.index,i=e.readUint32();super.readMdx(e),this.path=e.read(260),this.attachmentId=e.readInt32(),this.readAnimations(e,i-(e.index-t))}writeMdx(e){e.writeUint32(this.getByteLength()),super.writeMdx(e),e.skip(260-e.write(this.path)),e.writeInt32(this.attachmentId),this.writeNonGenericAnimationChunks(e)}readMdl(e){for(const t of super.readGenericBlock(e))if(t==="AttachmentID")this.attachmentId=e.readInt();else if(t==="Path")this.path=e.read();else if(t==="Visibility")this.readAnimation(e,"KATV");else throw new Error(`Unknown token in Attachment ${this.name}: "${t}"`)}writeMdl(e){e.startObjectBlock("Attachment",this.name),this.writeGenericHeader(e),e.writeNumberAttrib("AttachmentID",this.attachmentId),this.path.length&&e.writeStringAttrib("Path",this.path),this.writeAnimation(e,"KATV"),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 268+super.getByteLength()}},Pi=class extends fe{emissionRate=0;gravity=0;longitude=0;latitude=0;path="";lifeSpan=0;speed=0;constructor(){super(4096)}readMdx(e){const t=e.index,i=e.readUint32();super.readMdx(e),this.emissionRate=e.readFloat32(),this.gravity=e.readFloat32(),this.longitude=e.readFloat32(),this.latitude=e.readFloat32(),this.path=e.read(260),this.lifeSpan=e.readFloat32(),this.speed=e.readFloat32(),this.readAnimations(e,i-(e.index-t))}writeMdx(e){e.writeUint32(this.getByteLength()),super.writeMdx(e),e.writeFloat32(this.emissionRate),e.writeFloat32(this.gravity),e.writeFloat32(this.longitude),e.writeFloat32(this.latitude),e.skip(260-e.write(this.path)),e.writeFloat32(this.lifeSpan),e.writeFloat32(this.speed),this.writeNonGenericAnimationChunks(e)}readMdl(e){for(let t of super.readGenericBlock(e))if(t==="EmitterUsesMDL")this.flags|=32768;else if(t==="EmitterUsesTGA")this.flags|=65536;else if(t==="static EmissionRate")this.emissionRate=e.readFloat();else if(t==="EmissionRate")this.readAnimation(e,"KPEE");else if(t==="static Gravity")this.gravity=e.readFloat();else if(t==="Gravity")this.readAnimation(e,"KPEG");else if(t==="static Longitude")this.longitude=e.readFloat();else if(t==="Longitude")this.readAnimation(e,"KPLN");else if(t==="static Latitude")this.latitude=e.readFloat();else if(t==="Latitude")this.readAnimation(e,"KPLT");else if(t==="Visibility")this.readAnimation(e,"KPEV");else if(t==="Particle")for(t of this.readAnimatedBlock(e))t==="static LifeSpan"?this.lifeSpan=e.readFloat():t==="LifeSpan"?this.readAnimation(e,"KPEL"):t==="static InitVelocity"?this.speed=e.readFloat():t==="InitVelocity"?this.readAnimation(e,"KPES"):t==="Path"&&(this.path=e.read());else throw new Error(`Unknown token in ParticleEmitter: "${t}"`)}writeMdl(e){e.startObjectBlock("ParticleEmitter",this.name),this.writeGenericHeader(e),this.flags&32768&&e.writeFlag("EmitterUsesMDL"),this.flags&65536&&e.writeFlag("EmitterUsesTGA"),this.writeAnimation(e,"KPEE")||e.writeNumberAttrib("static EmissionRate",this.emissionRate),this.writeAnimation(e,"KPEG")||e.writeNumberAttrib("static Gravity",this.gravity),this.writeAnimation(e,"KPLN")||e.writeNumberAttrib("static Longitude",this.longitude),this.writeAnimation(e,"KPLT")||e.writeNumberAttrib("static Latitude",this.latitude),this.writeAnimation(e,"KPEV"),e.startBlock("Particle"),this.writeAnimation(e,"KPEL")||e.writeNumberAttrib("static LifeSpan",this.lifeSpan),this.writeAnimation(e,"KPES")||e.writeNumberAttrib("static InitVelocity",this.speed),(this.flags&32768||this.flags&65536)&&e.writeStringAttrib("Path",this.path),e.endBlock(),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 288+super.getByteLength()}};var He=(s=>(s[s.Unshaded=32768]="Unshaded",s[s.SortPrimsFarZ=65536]="SortPrimsFarZ",s[s.LineEmitter=131072]="LineEmitter",s[s.Unfogged=262144]="Unfogged",s[s.ModelSpace=524288]="ModelSpace",s[s.XYQuad=1048576]="XYQuad",s))(He||{}),Re=(s=>(s[s.Blend=0]="Blend",s[s.Additive=1]="Additive",s[s.Modulate=2]="Modulate",s[s.Modulate2x=3]="Modulate2x",s[s.AlphaKey=4]="AlphaKey",s))(Re||{}),Be=(s=>(s[s.Head=0]="Head",s[s.Tail=1]="Tail",s[s.Both=2]="Both",s))(Be||{});let Fi=class extends fe{speed=0;variation=0;latitude=0;gravity=0;lifeSpan=0;emissionRate=0;width=0;length=0;filterMode=0;rows=0;columns=0;headOrTail=0;tailLength=0;timeMiddle=0;segmentColors=[new Float32Array(3),new Float32Array(3),new Float32Array(3)];segmentAlphas=new Uint8Array(3);segmentScaling=new Float32Array(3);headIntervals=[new Uint32Array(3),new Uint32Array(3)];tailIntervals=[new Uint32Array(3),new Uint32Array(3)];textureId=-1;squirt=0;priorityPlane=0;replaceableId=0;readMdx(e){const t=e.index,i=e.readUint32();super.readMdx(e),this.speed=e.readFloat32(),this.variation=e.readFloat32(),this.latitude=e.readFloat32(),this.gravity=e.readFloat32(),this.lifeSpan=e.readFloat32(),this.emissionRate=e.readFloat32(),this.width=e.readFloat32(),this.length=e.readFloat32(),this.filterMode=e.readUint32(),this.rows=e.readUint32(),this.columns=e.readUint32(),this.headOrTail=e.readUint32(),this.tailLength=e.readFloat32(),this.timeMiddle=e.readFloat32(),e.readFloat32Array(this.segmentColors[0]),e.readFloat32Array(this.segmentColors[1]),e.readFloat32Array(this.segmentColors[2]),e.readUint8Array(this.segmentAlphas),e.readFloat32Array(this.segmentScaling),e.readUint32Array(this.headIntervals[0]),e.readUint32Array(this.headIntervals[1]),e.readUint32Array(this.tailIntervals[0]),e.readUint32Array(this.tailIntervals[1]),this.textureId=e.readInt32(),this.squirt=e.readUint32(),this.priorityPlane=e.readInt32(),this.replaceableId=e.readUint32(),this.readAnimations(e,i-(e.index-t))}writeMdx(e){e.writeUint32(this.getByteLength()),super.writeMdx(e),e.writeFloat32(this.speed),e.writeFloat32(this.variation),e.writeFloat32(this.latitude),e.writeFloat32(this.gravity),e.writeFloat32(this.lifeSpan),e.writeFloat32(this.emissionRate),e.writeFloat32(this.width),e.writeFloat32(this.length),e.writeUint32(this.filterMode),e.writeUint32(this.rows),e.writeUint32(this.columns),e.writeUint32(this.headOrTail),e.writeFloat32(this.tailLength),e.writeFloat32(this.timeMiddle),e.writeFloat32Array(this.segmentColors[0]),e.writeFloat32Array(this.segmentColors[1]),e.writeFloat32Array(this.segmentColors[2]),e.writeUint8Array(this.segmentAlphas),e.writeFloat32Array(this.segmentScaling),e.writeUint32Array(this.headIntervals[0]),e.writeUint32Array(this.headIntervals[1]),e.writeUint32Array(this.tailIntervals[0]),e.writeUint32Array(this.tailIntervals[1]),e.writeInt32(this.textureId),e.writeUint32(this.squirt),e.writeInt32(this.priorityPlane),e.writeUint32(this.replaceableId),this.writeNonGenericAnimationChunks(e)}readMdl(e){for(const t of super.readGenericBlock(e))if(t==="SortPrimsFarZ")this.flags|=65536;else if(t==="Unshaded")this.flags|=32768;else if(t==="LineEmitter")this.flags|=131072;else if(t==="Unfogged")this.flags|=262144;else if(t==="ModelSpace")this.flags|=524288;else if(t==="XYQuad")this.flags|=1048576;else if(t==="static Speed")this.speed=e.readFloat();else if(t==="Speed")this.readAnimation(e,"KP2S");else if(t==="static Variation")this.variation=e.readFloat();else if(t==="Variation")this.readAnimation(e,"KP2R");else if(t==="static Latitude")this.latitude=e.readFloat();else if(t==="Latitude")this.readAnimation(e,"KP2L");else if(t==="static Gravity")this.gravity=e.readFloat();else if(t==="Gravity")this.readAnimation(e,"KP2G");else if(t==="Visibility")this.readAnimation(e,"KP2V");else if(t==="Squirt")this.squirt=1;else if(t==="LifeSpan")this.lifeSpan=e.readFloat();else if(t==="static EmissionRate")this.emissionRate=e.readFloat();else if(t==="EmissionRate")this.readAnimation(e,"KP2E");else if(t==="static Width")this.width=e.readFloat();else if(t==="Width")this.readAnimation(e,"KP2N");else if(t==="static Length")this.length=e.readFloat();else if(t==="Length")this.readAnimation(e,"KP2W");else if(t==="Blend")this.filterMode=0;else if(t==="Additive")this.filterMode=1;else if(t==="Modulate")this.filterMode=2;else if(t==="Modulate2x")this.filterMode=3;else if(t==="AlphaKey")this.filterMode=4;else if(t==="Rows")this.rows=e.readInt();else if(t==="Columns")this.columns=e.readInt();else if(t==="Head")this.headOrTail=0;else if(t==="Tail")this.headOrTail=1;else if(t==="Both")this.headOrTail=2;else if(t==="TailLength")this.tailLength=e.readFloat();else if(t==="Time")this.timeMiddle=e.readFloat();else if(t==="SegmentColor"){e.read();for(let i=0;i<3;i++)e.read(),e.readColor(this.segmentColors[i]);e.read()}else if(t==="Alpha")e.readVector(this.segmentAlphas);else if(t==="ParticleScaling")e.readVector(this.segmentScaling);else if(t==="LifeSpanUVAnim")e.readVector(this.headIntervals[0]);else if(t==="DecayUVAnim")e.readVector(this.headIntervals[1]);else if(t==="TailUVAnim")e.readVector(this.tailIntervals[0]);else if(t==="TailDecayUVAnim")e.readVector(this.tailIntervals[1]);else if(t==="TextureID")this.textureId=e.readInt();else if(t==="ReplaceableId")this.replaceableId=e.readInt();else if(t==="PriorityPlane")this.priorityPlane=e.readInt();else throw new Error(`Unknown token in ParticleEmitter2: "${t}"`)}writeMdl(e){e.startObjectBlock("ParticleEmitter2",this.name),this.writeGenericHeader(e),this.flags&65536&&e.writeFlag("SortPrimsFarZ"),this.flags&32768&&e.writeFlag("Unshaded"),this.flags&131072&&e.writeFlag("LineEmitter"),this.flags&262144&&e.writeFlag("Unfogged"),this.flags&524288&&e.writeFlag("ModelSpace"),this.flags&1048576&&e.writeFlag("XYQuad"),this.writeAnimation(e,"KP2S")||e.writeNumberAttrib("static Speed",this.speed),this.writeAnimation(e,"KP2R")||e.writeNumberAttrib("static Variation",this.variation),this.writeAnimation(e,"KP2L")||e.writeNumberAttrib("static Latitude",this.latitude),this.writeAnimation(e,"KP2G")||e.writeNumberAttrib("static Gravity",this.gravity),this.writeAnimation(e,"KP2V"),this.squirt&&e.writeFlag("Squirt"),e.writeNumberAttrib("LifeSpan",this.lifeSpan),this.writeAnimation(e,"KP2E")||e.writeNumberAttrib("static EmissionRate",this.emissionRate),this.writeAnimation(e,"KP2N")||e.writeNumberAttrib("static Width",this.width),this.writeAnimation(e,"KP2W")||e.writeNumberAttrib("static Length",this.length),this.filterMode===0?e.writeFlag("Blend"):this.filterMode===1?e.writeFlag("Additive"):this.filterMode===2?e.writeFlag("Modulate"):this.filterMode===3?e.writeFlag("Modulate2x"):this.filterMode===4&&e.writeFlag("AlphaKey"),e.writeNumberAttrib("Rows",this.rows),e.writeNumberAttrib("Columns",this.columns),this.headOrTail===0?e.writeFlag("Head"):this.headOrTail===1?e.writeFlag("Tail"):this.headOrTail===2&&e.writeFlag("Both"),e.writeNumberAttrib("TailLength",this.tailLength),e.writeNumberAttrib("Time",this.timeMiddle),e.startBlock("SegmentColor"),e.writeColor("Color",this.segmentColors[0]),e.writeColor("Color",this.segmentColors[1]),e.writeColor("Color",this.segmentColors[2]),e.endBlockComma(),e.writeVectorAttrib("Alpha",this.segmentAlphas),e.writeVectorAttrib("ParticleScaling",this.segmentScaling),e.writeVectorAttrib("LifeSpanUVAnim",this.headIntervals[0]),e.writeVectorAttrib("DecayUVAnim",this.headIntervals[1]),e.writeVectorAttrib("TailUVAnim",this.tailIntervals[0]),e.writeVectorAttrib("TailDecayUVAnim",this.tailIntervals[1]),e.writeNumberAttrib("TextureID",this.textureId),this.replaceableId!==0&&e.writeNumberAttrib("ReplaceableId",this.replaceableId),this.priorityPlane!==0&&e.writeNumberAttrib("PriorityPlane",this.priorityPlane),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 175+super.getByteLength()}};class ki extends fe{lifeSpan=0;emissionRate=0;speed=0;color=new Float32Array(3);alpha=1;replaceableId=0;path="";animationVisiblityGuide="";readMdx(e){const t=e.index,i=e.readUint32();super.readMdx(e),this.lifeSpan=e.readFloat32(),this.emissionRate=e.readFloat32(),this.speed=e.readFloat32(),e.readFloat32Array(this.color),this.alpha=e.readFloat32(),this.replaceableId=e.readUint32(),this.path=e.read(260),this.animationVisiblityGuide=e.read(260),this.readAnimations(e,i-(e.index-t))}writeMdx(e){e.writeUint32(this.getByteLength()),super.writeMdx(e),e.writeFloat32(this.lifeSpan),e.writeFloat32(this.emissionRate),e.writeFloat32(this.speed),e.writeFloat32Array(this.color),e.writeFloat32(this.alpha),e.writeUint32(this.replaceableId),e.skip(260-e.write(this.path)),e.skip(260-e.write(this.animationVisiblityGuide)),this.writeNonGenericAnimationChunks(e)}readMdl(e){for(const t of super.readGenericBlock(e))if(t==="SortPrimsFarZ")this.flags|=65536;else if(t==="Unshaded")this.flags|=32768;else if(t==="Unfogged")this.flags|=262144;else if(t==="static LifeSpan")this.lifeSpan=e.readFloat();else if(t==="LifeSpan")this.readAnimation(e,"KPPL");else if(t==="static EmissionRate")this.emissionRate=e.readFloat();else if(t==="EmissionRate")this.readAnimation(e,"KPPE");else if(t==="static Speed")this.speed=e.readFloat();else if(t==="Speed")this.readAnimation(e,"KPPS");else if(t==="static Color")e.readVector(this.color);else if(t==="Color")this.readAnimation(e,"KPPC");else if(t==="static Alpha")this.alpha=e.readFloat();else if(t==="Alpha")this.readAnimation(e,"KPPA");else if(t==="Visibility")this.readAnimation(e,"KPPV");else if(t==="ReplaceableId")this.replaceableId=e.readInt();else if(t==="Path")this.path=e.read();else if(t==="AnimVisibilityGuide")this.animationVisiblityGuide=e.read();else throw new Error(`Unknown token in ParticleEmitterPopcorn: "${t}"`)}writeMdl(e){e.startObjectBlock("ParticleEmitterPopcorn",this.name),this.writeGenericHeader(e),this.flags&65536&&e.writeFlag("SortPrimsFarZ"),this.flags&32768&&e.writeFlag("Unshaded"),this.flags&262144&&e.writeFlag("Unfogged"),this.writeAnimation(e,"KPPL")||e.writeNumberAttrib("static LifeSpan",this.lifeSpan),this.writeAnimation(e,"KPPE")||e.writeNumberAttrib("static EmissionRate",this.emissionRate),this.writeAnimation(e,"KPPS")||e.writeNumberAttrib("static Speed",this.speed),this.writeAnimation(e,"KPPC")||e.writeVectorAttrib("static Color",this.color),this.writeAnimation(e,"KPPA")||e.writeNumberAttrib("static Alpha",this.alpha),this.writeAnimation(e,"KPPV"),this.replaceableId!==0&&e.writeNumberAttrib("ReplaceableId",this.replaceableId),this.path.length&&e.writeStringAttrib("Path",this.path),this.animationVisiblityGuide.length&&e.writeStringAttrib("AnimVisibilityGuide",this.animationVisiblityGuide),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 556+super.getByteLength()}}let Oi=class extends fe{heightAbove=0;heightBelow=0;alpha=0;color=new Float32Array(3);lifeSpan=0;textureSlot=0;emissionRate=0;rows=0;columns=0;materialId=0;gravity=0;constructor(){super(16384)}readMdx(e){const t=e.index,i=e.readUint32();super.readMdx(e),this.heightAbove=e.readFloat32(),this.heightBelow=e.readFloat32(),this.alpha=e.readFloat32(),e.readFloat32Array(this.color),this.lifeSpan=e.readFloat32(),this.textureSlot=e.readUint32(),this.emissionRate=e.readUint32(),this.rows=e.readUint32(),this.columns=e.readUint32(),this.materialId=e.readInt32(),this.gravity=e.readFloat32(),this.readAnimations(e,i-(e.index-t))}writeMdx(e){e.writeUint32(this.getByteLength()),super.writeMdx(e),e.writeFloat32(this.heightAbove),e.writeFloat32(this.heightBelow),e.writeFloat32(this.alpha),e.writeFloat32Array(this.color),e.writeFloat32(this.lifeSpan),e.writeUint32(this.textureSlot),e.writeUint32(this.emissionRate),e.writeUint32(this.rows),e.writeUint32(this.columns),e.writeInt32(this.materialId),e.writeFloat32(this.gravity),this.writeNonGenericAnimationChunks(e)}readMdl(e){for(const t of super.readGenericBlock(e))if(t==="static HeightAbove")this.heightAbove=e.readFloat();else if(t==="HeightAbove")this.readAnimation(e,"KRHA");else if(t==="static HeightBelow")this.heightBelow=e.readFloat();else if(t==="HeightBelow")this.readAnimation(e,"KRHB");else if(t==="static Alpha")this.alpha=e.readFloat();else if(t==="Alpha")this.readAnimation(e,"KRAL");else if(t==="static Color")e.readColor(this.color);else if(t==="Color")this.readAnimation(e,"KRCO");else if(t==="static TextureSlot")this.textureSlot=e.readInt();else if(t==="TextureSlot")this.readAnimation(e,"KRTX");else if(t==="Visibility")this.readAnimation(e,"KRVS");else if(t==="EmissionRate")this.emissionRate=e.readInt();else if(t==="LifeSpan")this.lifeSpan=e.readFloat();else if(t==="Gravity")this.gravity=e.readFloat();else if(t==="Rows")this.rows=e.readInt();else if(t==="Columns")this.columns=e.readInt();else if(t==="MaterialID")this.materialId=e.readInt();else throw new Error(`Unknown token in RibbonEmitter: "${t}"`)}writeMdl(e){e.startObjectBlock("RibbonEmitter",this.name),this.writeGenericHeader(e),this.writeAnimation(e,"KRHA")||e.writeNumberAttrib("static HeightAbove",this.heightAbove),this.writeAnimation(e,"KRHB")||e.writeNumberAttrib("static HeightBelow",this.heightBelow),this.writeAnimation(e,"KRAL")||e.writeNumberAttrib("static Alpha",this.alpha),this.writeAnimation(e,"KRCO")||e.writeColor("static Color",this.color),this.writeAnimation(e,"KRTX")||e.writeNumberAttrib("static TextureSlot",this.textureSlot),this.writeAnimation(e,"KRVS"),e.writeNumberAttrib("EmissionRate",this.emissionRate),e.writeNumberAttrib("LifeSpan",this.lifeSpan),this.gravity!==0&&e.writeNumberAttrib("Gravity",this.gravity),e.writeNumberAttrib("Rows",this.rows),e.writeNumberAttrib("Columns",this.columns),e.writeNumberAttrib("MaterialID",this.materialId),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 56+super.getByteLength()}},Ui=class extends qe{name="";position=new Float32Array(3);fieldOfView=0;farClippingPlane=0;nearClippingPlane=0;targetPosition=new Float32Array(3);readMdx(e){const t=e.readUint32();this.name=e.read(80),e.readFloat32Array(this.position),this.fieldOfView=e.readFloat32(),this.farClippingPlane=e.readFloat32(),this.nearClippingPlane=e.readFloat32(),e.readFloat32Array(this.targetPosition),this.readAnimations(e,t-120)}writeMdx(e){e.writeUint32(this.getByteLength()),e.skip(80-e.write(this.name)),e.writeFloat32Array(this.position),e.writeFloat32(this.fieldOfView),e.writeFloat32(this.farClippingPlane),e.writeFloat32(this.nearClippingPlane),e.writeFloat32Array(this.targetPosition),this.writeAnimations(e)}readMdl(e){this.name=e.read();for(let t of e.readBlock())if(t==="Position")e.readVector(this.position);else if(t==="Translation")this.readAnimation(e,"KCTR");else if(t==="Rotation")this.readAnimation(e,"KCRL");else if(t==="FieldOfView")this.fieldOfView=e.readFloat();else if(t==="FarClip")this.farClippingPlane=e.readFloat();else if(t==="NearClip")this.nearClippingPlane=e.readFloat();else if(t==="Target")for(t of e.readBlock())if(t==="Position")e.readVector(this.targetPosition);else if(t==="Translation")this.readAnimation(e,"KTTR");else throw new Error(`Unknown token in Camera ${this.name}'s Target: "${t}"`);else throw new Error(`Unknown token in Camera ${this.name}: "${t}"`)}writeMdl(e){e.startObjectBlock("Camera",this.name),e.writeVectorAttrib("Position",this.position),this.writeAnimation(e,"KCTR"),this.writeAnimation(e,"KCRL"),e.writeNumberAttrib("FieldOfView",this.fieldOfView),e.writeNumberAttrib("FarClip",this.farClippingPlane),e.writeNumberAttrib("NearClip",this.nearClippingPlane),e.startBlock("Target"),e.writeVectorAttrib("Position",this.targetPosition),this.writeAnimation(e,"KTTR"),e.endBlock(),e.endBlock()}getByteLength(){return 120+super.getByteLength()}};class Vi extends fe{globalSequenceId=-1;tracks=new Uint32Array(0);constructor(){super(1024)}readMdx(e){super.readMdx(e),e.skip(4);const t=e.readUint32();this.globalSequenceId=e.readInt32(),this.tracks=e.readUint32Array(t)}writeMdx(e){super.writeMdx(e),e.writeBinary("KEVT"),e.writeUint32(this.tracks.length),e.writeInt32(this.globalSequenceId),e.writeUint32Array(this.tracks)}readMdl(e){for(const t of super.readGenericBlock(e))if(t==="EventTrack"){const i=e.readInt();this.tracks=new Uint32Array(i),e.read(),e.peek()==="GlobalSeqId"&&(e.read(),this.globalSequenceId=e.readInt());for(let n=0;n<i;n++)this.tracks[n]=e.readInt();e.read()}else throw new Error(`Unknown token in EventObject: "${t}"`)}writeMdl(e){e.startObjectBlock("EventObject",this.name),this.writeGenericHeader(e),e.startBlock("EventTrack",this.tracks.length),this.globalSequenceId!==-1&&e.writeNumberAttrib("GlobalSeqId",this.globalSequenceId);for(const t of this.tracks)e.writeFlag(`${t}`);e.endBlock(),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 12+this.tracks.byteLength+super.getByteLength()}}let Mi=class extends fe{type=0;vertices=[new Float32Array(3),new Float32Array(3)];boundsRadius=0;constructor(){super(8192)}readMdx(e){super.readMdx(e),this.type=e.readUint32(),e.readFloat32Array(this.vertices[0]),this.type!==2&&e.readFloat32Array(this.vertices[1]),(this.type===2||this.type===3)&&(this.boundsRadius=e.readFloat32())}writeMdx(e){super.writeMdx(e),e.writeUint32(this.type),e.writeFloat32Array(this.vertices[0]),this.type!==2&&e.writeFloat32Array(this.vertices[1]),(this.type===2||this.type===3)&&e.writeFloat32(this.boundsRadius)}readMdl(e){for(const t of super.readGenericBlock(e))if(t==="Box")this.type=0;else if(t==="Plane")this.type=1;else if(t==="Sphere")this.type=2;else if(t==="Cylinder")this.type=3;else if(t==="Vertices"){const i=e.readInt();e.read(),e.readVector(this.vertices[0]),i===2&&e.readVector(this.vertices[1]),e.read()}else if(t==="BoundsRadius")this.boundsRadius=e.readFloat();else throw new Error(`Unknown token in CollisionShape: "${t}"`)}writeMdl(e){e.startObjectBlock("CollisionShape",this.name),this.writeGenericHeader(e);let t="",i=2,n=!1;this.type===0?t="Box":this.type===1?t="Plane":this.type===2?(t="Sphere",i=1,n=!0):this.type===3&&(t="Cylinder",n=!0),e.writeFlag(t),e.startBlock("Vertices",i),e.writeVector(this.vertices[0]),i===2&&e.writeVector(this.vertices[1]),e.endBlock(),n&&e.writeNumberAttrib("BoundsRadius",this.boundsRadius),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){let e=16+super.getByteLength();return this.type!==2&&(e+=12),(this.type===2||this.type===3)&&(e+=4),e}};class Di{type="";path="";readMdx(e){this.type=e.read(80),this.path=e.read(260)}writeMdx(e){e.skip(80-e.write(this.type)),e.skip(260-e.write(this.path))}readMdl(e){this.type=e.read();for(const t of e.readBlock())if(t==="Path")this.path=e.read();else throw new Error(`Unknown token in FaceEffect: "${t}"`)}writeMdl(e){e.startObjectBlock("FaceFX",this.type),e.writeStringAttrib("Path",this.path),e.endBlock()}}class ws{tag;chunk;constructor(e,t,i){this.tag=i,this.chunk=e.readUint8Array(new Uint8Array(t))}writeMdx(e){e.writeBinary(this.tag),e.writeUint32(this.chunk.byteLength),e.writeUint8Array(this.chunk)}getByteLength(){return 8+this.chunk.byteLength}}function Ni(s){return s instanceof ArrayBuffer&&(s=new Uint8Array(s)),!!(s instanceof Uint8Array&&s[0]===77&&s[1]===68&&s[2]===76&&s[3]===88||typeof s=="string"&&s.startsWith("MDLX"))}function Gi(s){return s instanceof ArrayBuffer&&(s=new Uint8Array(s)),!!(s instanceof Uint8Array&&os(s,"FormatVersion",0,4096)||typeof s=="string"&&as(s,"FormatVersion",0,4096))}let Lt=class{version=800;name="";animationFile="";extent=new Ke;blendTime=0;sequences=[];globalSequences=[];materials=[];textures=[];textureAnimations=[];geosets=[];geosetAnimations=[];bones=[];lights=[];helpers=[];attachments=[];pivotPoints=[];particleEmitters=[];particleEmitters2=[];particleEmittersPopcorn=[];ribbonEmitters=[];cameras=[];eventObjects=[];collisionShapes=[];faceEffects=[];bindPose=[];unknownChunks=[];load(e){if(Ni(e))typeof e=="string"&&(e=St(e)),this.loadMdx(e);else if(Gi(e))typeof e!="string"&&(e=Et(e)),this.loadMdl(e);else throw new Error("Not a valid MDX/MDL buffer")}loadMdx(e){const t=new tt(e);let i,n;for(t.skip(4);t.remaining>0;)i=t.readBinary(4),n=t.readUint32(),i==="VERS"?this.loadVersionChunk(t):i==="MODL"?this.loadModelChunk(t):i==="SEQS"?this.loadStaticObjects(this.sequences,yi,t,n/132):i==="GLBS"?this.loadGlobalSequenceChunk(t,n):i==="MTLS"?this.loadDynamicObjects(this.materials,xi,t,n):i==="TEXS"?this.loadStaticObjects(this.textures,Ei,t,n/268):i==="TXAN"?this.loadDynamicObjects(this.textureAnimations,Si,t,n):i==="GEOS"?this.loadDynamicObjects(this.geosets,_i,t,n):i==="GEOA"?this.loadDynamicObjects(this.geosetAnimations,Ii,t,n):i==="BONE"?this.loadDynamicObjects(this.bones,Li,t,n):i==="LITE"?this.loadDynamicObjects(this.lights,Ci,t,n):i==="HELP"?this.loadDynamicObjects(this.helpers,Ri,t,n):i==="ATCH"?this.loadDynamicObjects(this.attachments,Bi,t,n):i==="PIVT"?this.loadPivotPointChunk(t,n):i==="PREM"?this.loadDynamicObjects(this.particleEmitters,Pi,t,n):i==="PRE2"?this.loadDynamicObjects(this.particleEmitters2,Fi,t,n):i==="CORN"?this.loadDynamicObjects(this.particleEmittersPopcorn,ki,t,n):i==="RIBB"?this.loadDynamicObjects(this.ribbonEmitters,Oi,t,n):i==="CAMS"?this.loadDynamicObjects(this.cameras,Ui,t,n):i==="EVTS"?this.loadDynamicObjects(this.eventObjects,Vi,t,n):i==="CLID"?this.loadDynamicObjects(this.collisionShapes,Mi,t,n):i==="FAFX"?this.loadStaticObjects(this.faceEffects,Di,t,n/340):i==="BPOS"?this.loadBindPoseChunk(t,n):this.unknownChunks.push(new ws(t,n,i))}loadVersionChunk(e){this.version=e.readUint32()}loadModelChunk(e){this.name=e.read(80),this.animationFile=e.read(260),this.extent.readMdx(e),this.blendTime=e.readUint32()}loadStaticObjects(e,t,i,n){for(let r=0;r<n;r++){const o=new t;o.readMdx(i),e.push(o)}}loadGlobalSequenceChunk(e,t){for(let i=0,n=t/4;i<n;i++)this.globalSequences.push(e.readUint32())}loadDynamicObjects(e,t,i,n){const r=i.index+n;for(;i.index<r;){const o=new t;o.readMdx(i,this.version),e.push(o)}}loadPivotPointChunk(e,t){for(let i=0,n=t/12;i<n;i++)this.pivotPoints.push(e.readFloat32Array(3))}loadBindPoseChunk(e,t){for(let i=0,n=e.readUint32();i<n;i++)this.bindPose[i]=e.readFloat32Array(12)}saveMdx(){const e=new tt(new ArrayBuffer(this.getByteLength()));e.writeBinary("MDLX"),this.saveVersionChunk(e),this.saveModelChunk(e),this.saveStaticObjectChunk(e,"SEQS",this.sequences,132),this.saveGlobalSequenceChunk(e),this.saveDynamicObjectChunk(e,"MTLS",this.materials),this.saveStaticObjectChunk(e,"TEXS",this.textures,268),this.saveDynamicObjectChunk(e,"TXAN",this.textureAnimations),this.saveDynamicObjectChunk(e,"GEOS",this.geosets),this.saveDynamicObjectChunk(e,"GEOA",this.geosetAnimations),this.saveDynamicObjectChunk(e,"BONE",this.bones),this.saveDynamicObjectChunk(e,"LITE",this.lights),this.saveDynamicObjectChunk(e,"HELP",this.helpers),this.saveDynamicObjectChunk(e,"ATCH",this.attachments),this.savePivotPointChunk(e),this.saveDynamicObjectChunk(e,"PREM",this.particleEmitters),this.saveDynamicObjectChunk(e,"PRE2",this.particleEmitters2),this.version>800&&this.saveDynamicObjectChunk(e,"CORN",this.particleEmittersPopcorn),this.saveDynamicObjectChunk(e,"RIBB",this.ribbonEmitters),this.saveDynamicObjectChunk(e,"CAMS",this.cameras),this.saveDynamicObjectChunk(e,"EVTS",this.eventObjects),this.saveDynamicObjectChunk(e,"CLID",this.collisionShapes),this.version>800&&(this.saveStaticObjectChunk(e,"FAFX",this.faceEffects,340),this.saveBindPoseChunk(e));for(const t of this.unknownChunks)t.writeMdx(e);return e.uint8array}saveVersionChunk(e){e.writeBinary("VERS"),e.writeUint32(4),e.writeUint32(this.version)}saveModelChunk(e){e.writeBinary("MODL"),e.writeUint32(372),e.skip(80-e.write(this.name)),e.skip(260-e.write(this.animationFile)),this.extent.writeMdx(e),e.writeUint32(this.blendTime)}saveStaticObjectChunk(e,t,i,n){if(i.length){e.writeBinary(t),e.writeUint32(i.length*n);for(const r of i)r.writeMdx(e)}}saveGlobalSequenceChunk(e){if(this.globalSequences.length){e.writeBinary("GLBS"),e.writeUint32(this.globalSequences.length*4);for(const t of this.globalSequences)e.writeUint32(t)}}saveDynamicObjectChunk(e,t,i){if(i.length){e.writeBinary(t),e.writeUint32(this.getObjectsByteLength(i));for(const n of i)n.writeMdx(e,this.version)}}savePivotPointChunk(e){if(this.pivotPoints.length){e.writeBinary("PIVT"),e.writeUint32(this.pivotPoints.length*12);for(const t of this.pivotPoints)e.writeFloat32Array(t)}}saveBindPoseChunk(e){if(this.bindPose.length){e.writeBinary("BPOS"),e.writeUint32(4+this.bindPose.length*48),e.writeUint32(this.bindPose.length);for(const t of this.bindPose)e.writeFloat32Array(t)}}loadMdl(e){let t;const i=new wi(e);for(;t=i.readToken();)if(t==="Version")this.loadVersionBlock(i);else if(t==="Model")this.loadModelBlock(i);else if(t==="Sequences")this.loadNumberedObjectBlock(this.sequences,yi,"Anim",i);else if(t==="GlobalSequences")this.loadGlobalSequenceBlock(i);else if(t==="Textures")this.loadNumberedObjectBlock(this.textures,Ei,"Bitmap",i);else if(t==="Materials")this.loadNumberedObjectBlock(this.materials,xi,"Material",i);else if(t==="TextureAnims")this.loadNumberedObjectBlock(this.textureAnimations,Si,"TVertexAnim",i);else if(t==="Geoset")this.loadObject(this.geosets,_i,i);else if(t==="GeosetAnim")this.loadObject(this.geosetAnimations,Ii,i);else if(t==="Bone")this.loadObject(this.bones,Li,i);else if(t==="Light")this.loadObject(this.lights,Ci,i);else if(t==="Helper")this.loadObject(this.helpers,Ri,i);else if(t==="Attachment")this.loadObject(this.attachments,Bi,i);else if(t==="PivotPoints")this.loadPivotPointBlock(i);else if(t==="ParticleEmitter")this.loadObject(this.particleEmitters,Pi,i);else if(t==="ParticleEmitter2")this.loadObject(this.particleEmitters2,Fi,i);else if(t==="ParticleEmitterPopcorn")this.loadObject(this.particleEmittersPopcorn,ki,i);else if(t==="RibbonEmitter")this.loadObject(this.ribbonEmitters,Oi,i);else if(t==="Camera")this.loadObject(this.cameras,Ui,i);else if(t==="EventObject")this.loadObject(this.eventObjects,Vi,i);else if(t==="CollisionShape")this.loadObject(this.collisionShapes,Mi,i);else if(t==="FaceFX")this.loadObject(this.faceEffects,Di,i);else if(t==="BindPose")this.loadBindPoseBlock(i);else throw new Error(`Unsupported block: ${t}`)}loadVersionBlock(e){for(const t of e.readBlock())if(t==="FormatVersion")this.version=e.readInt();else throw new Error(`Unknown token in Version: "${t}"`)}loadModelBlock(e){this.name=e.read();for(const t of e.readBlock())if(t.startsWith("Num"))e.read();else if(t==="BlendTime")this.blendTime=e.readInt();else if(t==="MinimumExtent")e.readVector(this.extent.min);else if(t==="MaximumExtent")e.readVector(this.extent.max);else if(t==="BoundsRadius")this.extent.boundsRadius=e.readFloat();else if(t==="AnimationFile")this.animationFile=e.read();else throw new Error(`Unknown token in Model: "${t}"`)}loadNumberedObjectBlock(e,t,i,n){n.read();for(const r of n.readBlock())if(r===i){const o=new t;o.readMdl(n),e.push(o)}else throw new Error(`Unknown token in ${i}: "${r}"`)}loadGlobalSequenceBlock(e){e.read();for(const t of e.readBlock())if(t==="Duration")this.globalSequences.push(e.readInt());else throw new Error(`Unknown token in GlobalSequences: "${t}"`)}loadObject(e,t,i){const n=new t;n.readMdl(i),e.push(n)}loadPivotPointBlock(e){const t=e.readInt();e.read();for(let i=0;i<t;i++)this.pivotPoints.push(e.readVector(new Float32Array(3)));e.read()}loadBindPoseBlock(e){for(const t of e.readBlock())if(t==="Matrices"){const i=e.readInt();e.read();for(let n=0;n<i;n++)this.bindPose[n]=e.readVector(new Float32Array(12));e.read()}else throw new Error(`Unknown token in BindPose: "${t}"`)}saveMdl(){const e=new wi;return this.saveVersionBlock(e),this.saveModelBlock(e),this.saveStaticObjectsBlock(e,"Sequences",this.sequences),this.saveGlobalSequenceBlock(e),this.saveStaticObjectsBlock(e,"Textures",this.textures),this.saveStaticObjectsBlock(e,"Materials",this.materials),this.saveStaticObjectsBlock(e,"TextureAnims",this.textureAnimations),this.saveObjects(e,this.geosets),this.saveObjects(e,this.geosetAnimations),this.saveObjects(e,this.bones),this.saveObjects(e,this.lights),this.saveObjects(e,this.helpers),this.saveObjects(e,this.attachments),this.savePivotPointBlock(e),this.saveObjects(e,this.particleEmitters),this.saveObjects(e,this.particleEmitters2),this.version>800&&this.saveObjects(e,this.particleEmittersPopcorn),this.saveObjects(e,this.ribbonEmitters),this.saveObjects(e,this.cameras),this.saveObjects(e,this.eventObjects),this.saveObjects(e,this.collisionShapes),this.version>800&&(this.saveObjects(e,this.faceEffects),this.saveBindPoseBlock(e)),e.buffer}saveVersionBlock(e){e.startBlock("Version"),e.writeNumberAttrib("FormatVersion",this.version),e.endBlock()}saveModelBlock(e){e.startObjectBlock("Model",this.name),e.writeNumberAttrib("BlendTime",this.blendTime),this.extent.writeMdl(e),this.animationFile.length&&e.writeStringAttrib("AnimationFile",this.animationFile),e.endBlock()}saveStaticObjectsBlock(e,t,i){if(i.length){e.startBlock(t,i.length);for(const n of i)n.writeMdl(e,this.version);e.endBlock()}}saveGlobalSequenceBlock(e){if(this.globalSequences.length){e.startBlock("GlobalSequences",this.globalSequences.length);for(const t of this.globalSequences)e.writeNumberAttrib("Duration",t);e.endBlock()}}saveObjects(e,t){for(const i of t)i.writeMdl(e,this.version)}savePivotPointBlock(e){if(this.pivotPoints.length){e.startBlock("PivotPoints",this.pivotPoints.length);for(const t of this.pivotPoints)e.writeVector(t);e.endBlock()}}saveBindPoseBlock(e){if(this.bindPose.length){e.startBlock("BindPose"),e.startBlock("Matrices",this.bindPose.length);for(const t of this.bindPose)e.writeVector(t);e.endBlock(),e.endBlock()}}getByteLength(){let e=396;return e+=this.getStaticObjectsChunkByteLength(this.sequences,132),e+=this.getStaticObjectsChunkByteLength(this.globalSequences,4),e+=this.getDynamicObjectsChunkByteLength(this.materials),e+=this.getStaticObjectsChunkByteLength(this.textures,268),e+=this.getDynamicObjectsChunkByteLength(this.textureAnimations),e+=this.getDynamicObjectsChunkByteLength(this.geosets),e+=this.getDynamicObjectsChunkByteLength(this.geosetAnimations),e+=this.getDynamicObjectsChunkByteLength(this.bones),e+=this.getDynamicObjectsChunkByteLength(this.lights),e+=this.getDynamicObjectsChunkByteLength(this.helpers),e+=this.getDynamicObjectsChunkByteLength(this.attachments),e+=this.getStaticObjectsChunkByteLength(this.pivotPoints,12),e+=this.getDynamicObjectsChunkByteLength(this.particleEmitters),e+=this.getDynamicObjectsChunkByteLength(this.particleEmitters2),this.version>800&&(e+=this.getDynamicObjectsChunkByteLength(this.particleEmittersPopcorn)),e+=this.getDynamicObjectsChunkByteLength(this.ribbonEmitters),e+=this.getDynamicObjectsChunkByteLength(this.cameras),e+=this.getDynamicObjectsChunkByteLength(this.eventObjects),e+=this.getDynamicObjectsChunkByteLength(this.collisionShapes),this.version>800&&(e+=this.getStaticObjectsChunkByteLength(this.faceEffects,340),e+=this.getBindPoseChunkByteLength()),e+=this.getObjectsByteLength(this.unknownChunks),e}getObjectsByteLength(e){let t=0;for(const i of e)t+=i.getByteLength(this.version);return t}getDynamicObjectsChunkByteLength(e){return e.length?8+this.getObjectsByteLength(e):0}getStaticObjectsChunkByteLength(e,t){return e.length?8+e.length*t:0}getBindPoseChunkByteLength(){return this.bindPose.length?12+this.bindPose.length*48:0}};const ys=new Uint8Array(4);new Uint32Array(ys.buffer);function As(s,e){return((1<<e)-1)/((1<<s)-1)}const Ts=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(s){return typeof s}:function(s){return s&&typeof Symbol=="function"&&s.constructor===Symbol&&s!==Symbol.prototype?"symbol":typeof s},ye=(function(){function e(t){this.message="JPEG error: "+t}return e.prototype=new Error,e.prototype.name="JpegError",e.constructor=e,e})(),$e=new Uint8Array([0,1,8,16,9,2,3,10,17,24,32,25,18,11,4,5,12,19,26,33,40,48,41,34,27,20,13,6,7,14,21,28,35,42,49,56,57,50,43,36,29,22,15,23,30,37,44,51,58,59,52,45,38,31,39,46,53,60,61,54,47,55,62,63]),st=4017,rt=799,ot=3406,at=2276,lt=1567,ct=3784,Pe=5793,ht=2896;function xs(s,e){let t=0,i=[],n,r,o=16;for(;o>0&&!s[o-1];)o--;i.push({children:[],index:0});let a=i[0],l;for(n=0;n<o;n++){for(r=0;r<s[n];r++){for(a=i.pop(),a.children[a.index]=e[t];a.index>0;)a=i.pop();for(a.index++,i.push(a);i.length<=n;)i.push(l={children:[],index:0}),a.children[a.index]=l.children,a=l;t++}n+1<o&&(i.push(l={children:[],index:0}),a.children[a.index]=l.children,a=l)}return i[0].children}function dt(s,e,t){return 64*((s.blocksPerLine+1)*e+t)}function Es(s,e,t,i,n,r,o,a,l){const c=t.mcusPerLine,u=t.progressive;let h=e,v=0,f=0;function p(){if(f>0)return f--,v>>f&1;if(v=s[e++],v===255){const S=s[e++];if(S)throw new ye("unexpected marker "+(v<<8|S).toString(16))}return f=7,v>>>7}function b(S){let C=S;for(;;){if(C=C[p()],typeof C=="number")return C;if((typeof C>"u"?"undefined":Ts(C))!=="object")throw new ye("invalid huffman sequence")}}function g(S){let C=0;for(;S>0;)C=C<<1|p(),S--;return C}function m(S){if(S===1)return p()===1?1:-1;const C=g(S);return C>=1<<S-1?C:C+(-1<<S)+1}function w(S,C){const D=b(S.huffmanTableDC),ae=D===0?0:m(D);S.blockData[C]=S.pred+=ae;let j=1;for(;j<64;){const J=b(S.huffmanTableAC),ie=J&15,ee=J>>4;if(ie===0){if(ee<15)break;j+=16;continue}j+=ee;const Ze=$e[j];S.blockData[C+Ze]=m(ie),j++}}function I(S,C){const D=b(S.huffmanTableDC),ae=D===0?0:m(D)<<l;S.blockData[C]=S.pred+=ae}function T(S,C){S.blockData[C]|=p()<<l}let A=0;function y(S,C){if(A>0){A--;return}let D=r,ae=o;for(;D<=ae;){const j=b(S.huffmanTableAC),J=j&15,ie=j>>4;if(J===0){if(ie<15){A=g(ie)+(1<<ie)-1;break}D+=16;continue}D+=ie;const ee=$e[D];S.blockData[C+ee]=m(J)*(1<<l),D++}}let O=0,V;function K(S,C){let D=r;const ae=o;let j=0,J,ie;for(;D<=ae;){const ee=$e[D];switch(O){case 0:if(ie=b(S.huffmanTableAC),J=ie&15,j=ie>>4,J===0)j<15?(A=g(j)+(1<<j),O=4):(j=16,O=1);else{if(J!==1)throw new ye("invalid ACn encoding");V=m(J),O=j?2:3}continue;case 1:case 2:S.blockData[C+ee]?S.blockData[C+ee]+=p()<<l:(j--,j===0&&(O=O===2?3:0));break;case 3:S.blockData[C+ee]?S.blockData[C+ee]+=p()<<l:(S.blockData[C+ee]=V<<l,O=0);break;case 4:S.blockData[C+ee]&&(S.blockData[C+ee]+=p()<<l);break}D++}O===4&&(A--,A===0&&(O=0))}function G(S,C,D,ae,j){const J=D/c|0,ie=D%c,ee=J*S.v+ae,Ze=ie*S.h+j,go=dt(S,ee,Ze);C(S,go)}function ne(S,C,D){const ae=D/S.blocksPerLine|0,j=D%S.blocksPerLine,J=dt(S,ae,j);C(S,J)}const B=i.length;let H,M,E,N,_,F;u?r===0?F=a===0?I:T:F=a===0?y:K:F=w;let U=0,k,X;B===1?X=i[0].blocksPerLine*i[0].blocksPerColumn:X=c*t.mcusPerColumn;let he,ue;for(;U<X;){const S=n?Math.min(X-U,n):X;for(M=0;M<B;M++)i[M].pred=0;if(A=0,B===1)for(H=i[0],_=0;_<S;_++)ne(H,F,U),U++;else for(_=0;_<S;_++){for(M=0;M<B;M++)for(H=i[M],he=H.h,ue=H.v,E=0;E<ue;E++)for(N=0;N<he;N++)G(H,F,U,E,N);U++}f=0,k=Ct(s,e),k&&k.invalid&&(e=k.offset);const C=k&&k.marker;if(!C||C<=65280)throw new ye("marker was not found");if(C>=65488&&C<=65495)e+=2;else break}return k=Ct(s,e),k&&k.invalid&&(e=k.offset),e-h}function Ss(s,e,t){const i=s.quantizationTable,n=s.blockData;let r,o,a,l,c,u,h,v,f,p,b,g,m,w,I,T,A;if(!i)throw new ye("missing required Quantization Table.");for(let y=0;y<64;y+=8){if(f=n[e+y],p=n[e+y+1],b=n[e+y+2],g=n[e+y+3],m=n[e+y+4],w=n[e+y+5],I=n[e+y+6],T=n[e+y+7],f*=i[y],(p|b|g|m|w|I|T)===0){A=Pe*f+512>>10,t[y]=A,t[y+1]=A,t[y+2]=A,t[y+3]=A,t[y+4]=A,t[y+5]=A,t[y+6]=A,t[y+7]=A;continue}p*=i[y+1],b*=i[y+2],g*=i[y+3],m*=i[y+4],w*=i[y+5],I*=i[y+6],T*=i[y+7],r=Pe*f+128>>8,o=Pe*m+128>>8,a=b,l=I,c=ht*(p-T)+128>>8,v=ht*(p+T)+128>>8,u=g<<4,h=w<<4,r=r+o+1>>1,o=r-o,A=a*ct+l*lt+128>>8,a=a*lt-l*ct+128>>8,l=A,c=c+h+1>>1,h=c-h,v=v+u+1>>1,u=v-u,r=r+l+1>>1,l=r-l,o=o+a+1>>1,a=o-a,A=c*at+v*ot+2048>>12,c=c*ot-v*at+2048>>12,v=A,A=u*rt+h*st+2048>>12,u=u*st-h*rt+2048>>12,h=A,t[y]=r+v,t[y+7]=r-v,t[y+1]=o+h,t[y+6]=o-h,t[y+2]=a+u,t[y+5]=a-u,t[y+3]=l+c,t[y+4]=l-c}for(let y=0;y<8;++y){if(f=t[y],p=t[y+8],b=t[y+16],g=t[y+24],m=t[y+32],w=t[y+40],I=t[y+48],T=t[y+56],(p|b|g|m|w|I|T)===0){A=Pe*f+8192>>14,A=A<-2040?0:A>=2024?255:A+2056>>4,n[e+y]=A,n[e+y+8]=A,n[e+y+16]=A,n[e+y+24]=A,n[e+y+32]=A,n[e+y+40]=A,n[e+y+48]=A,n[e+y+56]=A;continue}r=Pe*f+2048>>12,o=Pe*m+2048>>12,a=b,l=I,c=ht*(p-T)+2048>>12,v=ht*(p+T)+2048>>12,u=g,h=w,r=(r+o+1>>1)+4112,o=r-o,A=a*ct+l*lt+2048>>12,a=a*lt-l*ct+2048>>12,l=A,c=c+h+1>>1,h=c-h,v=v+u+1>>1,u=v-u,r=r+l+1>>1,l=r-l,o=o+a+1>>1,a=o-a,A=c*at+v*ot+2048>>12,c=c*ot-v*at+2048>>12,v=A,A=u*rt+h*st+2048>>12,u=u*st-h*rt+2048>>12,h=A,f=r+v,T=r-v,p=o+h,I=o-h,b=a+u,w=a-u,g=l+c,m=l-c,f=f<16?0:f>=4080?255:f>>4,p=p<16?0:p>=4080?255:p>>4,b=b<16?0:b>=4080?255:b>>4,g=g<16?0:g>=4080?255:g>>4,m=m<16?0:m>=4080?255:m>>4,w=w<16?0:w>=4080?255:w>>4,I=I<16?0:I>=4080?255:I>>4,T=T<16?0:T>=4080?255:T>>4,n[e+y]=f,n[e+y+8]=p,n[e+y+16]=b,n[e+y+24]=g,n[e+y+32]=m,n[e+y+40]=w,n[e+y+48]=I,n[e+y+56]=T}}function _s(s,e){const t=e.blocksPerLine,i=e.blocksPerColumn,n=new Int16Array(64);for(let r=0;r<i;r++)for(let o=0;o<t;o++){const a=dt(e,r,o);Ss(e,a,n)}return e.blockData}function Ct(s,e,t){function i(l){return s[l]<<8|s[l+1]}const n=s.length-1;let r=t<e?t:e;if(e>=n)return null;const o=i(e);if(o>=65472&&o<=65534)return{invalid:null,marker:o,offset:e};let a=i(r);for(;!(a>=65472&&a<=65534);){if(++r>=n)return null;a=i(r)}return{invalid:o.toString(16),marker:a,offset:r}}class Is{constructor(){this.decodeTransform=null,this.colorTransform=-1,this.width=0,this.height=0}parse(e){function t(){const _=e[r]<<8|e[r+1];return r+=2,_}function i(){const _=t();let F=r+_-2;const U=Ct(e,F,r);U&&U.invalid&&(F=U.offset);const k=e.subarray(r,F);return r+=k.length,k}function n(_){const F=Math.ceil(_.samplesPerLine/8/_.maxH),U=Math.ceil(_.scanLines/8/_.maxV);for(let k=0;k<_.components.length;k++){B=_.components[k];const X=Math.ceil(Math.ceil(_.samplesPerLine/8)*B.h/_.maxH),he=Math.ceil(Math.ceil(_.scanLines/8)*B.v/_.maxV),ue=F*B.h,C=64*(U*B.v)*(ue+1);B.blockData=new Int16Array(C),B.blocksPerLine=X,B.blocksPerColumn=he}_.mcusPerLine=F,_.mcusPerColumn=U}var r=0;let o=null,a=null,l,c;const u=[],h=[],v=[];let f=t();if(f!==65496)throw new ye("SOI not found");for(f=t();f!==65497;){var p,b,g;switch(f){case 65504:case 65505:case 65506:case 65507:case 65508:case 65509:case 65510:case 65511:case 65512:case 65513:case 65514:case 65515:case 65516:case 65517:case 65518:case 65519:case 65534:var m=i();f===65504&&m[0]===74&&m[1]===70&&m[2]===73&&m[3]===70&&m[4]===0&&(o={version:{major:m[5],minor:m[6]},densityUnits:m[7],xDensity:m[8]<<8|m[9],yDensity:m[10]<<8|m[11],thumbWidth:m[12],thumbHeight:m[13],thumbData:m.subarray(14,14+3*m[12]*m[13])}),f===65518&&m[0]===65&&m[1]===100&&m[2]===111&&m[3]===98&&m[4]===101&&(a={version:m[5]<<8|m[6],flags0:m[7]<<8|m[8],flags1:m[9]<<8|m[10],transformCode:m[11]});break;case 65499:for(var w=t(),I=w+r-2,T;r<I;){const _=e[r++],F=new Uint16Array(64);if(_>>4===0)for(b=0;b<64;b++)T=$e[b],F[T]=e[r++];else if(_>>4===1)for(b=0;b<64;b++)T=$e[b],F[T]=t();else throw new ye("DQT - invalid table spec");u[_&15]=F}break;case 65472:case 65473:case 65474:if(l)throw new ye("Only single frame JPEGs supported");t(),l={},l.extended=f===65473,l.progressive=f===65474,l.precision=e[r++],l.scanLines=t(),l.samplesPerLine=t(),l.components=[],l.componentIds={};var A=e[r++],y,O=0,V=0;for(p=0;p<A;p++){y=e[r];const _=e[r+1]>>4,F=e[r+1]&15;O<_&&(O=_),V<F&&(V=F);const U=e[r+2];g=l.components.push({h:_,v:F,quantizationId:U,quantizationTable:null}),l.componentIds[y]=g-1,r+=3}l.maxH=O,l.maxV=V,n(l);break;case 65476:var K=t();for(p=2;p<K;){const _=e[r++],F=new Uint8Array(16);let U=0;for(b=0;b<16;b++,r++)U+=F[b]=e[r];const k=new Uint8Array(U);for(b=0;b<U;b++,r++)k[b]=e[r];p+=17+U,(_>>4===0?v:h)[_&15]=xs(F,k)}break;case 65501:t(),c=t();break;case 65498:t();var G=e[r++],ne=[],B;for(p=0;p<G;p++){const _=l.componentIds[e[r++]];B=l.components[_];const F=e[r++];B.huffmanTableDC=v[F>>4],B.huffmanTableAC=h[F&15],ne.push(B)}var H=e[r++],M=e[r++],E=e[r++],N=Es(e,r,l,ne,c,H,M,E>>4,E&15);r+=N;break;case 65535:e[r]!==255&&r--;break;default:if(e[r-3]===255&&e[r-2]>=192&&e[r-2]<=254){r-=3;break}throw new ye("unknown marker "+f.toString(16))}f=t()}for(this.width=l.samplesPerLine,this.height=l.scanLines,this.jfif=o,this.adobe=a,this.components=[],p=0;p<l.components.length;p++){B=l.components[p];const _=u[B.quantizationId];_&&(B.quantizationTable=_),this.components.push({output:_s(l,B),scaleX:B.h/l.maxH,scaleY:B.v/l.maxV,blocksPerLine:B.blocksPerLine,blocksPerColumn:B.blocksPerColumn})}this.numComponents=this.components.length}getData(e){const t=e.data,i=this.components,n=new Uint8Array((i[0].blocksPerLine<<3)*i[0].blocksPerColumn*8);[i[0],i[2]]=[i[2],i[0]];for(let l=0,c=i.length;l<c;l++){const u=i[l],h=u.blocksPerLine,v=u.blocksPerColumn,f=h<<3;var r,o,a=0;for(let b=0;b<v;b++){const g=b<<3;for(let m=0;m<h;m++){const w=dt(u,b,m);let I=0,T=m<<3;for(r=0;r<8;r++){var a=(g+r)*f;for(o=0;o<8;o++)n[a+T+o]=u.output[w+I++]}}}let p=l;for(let b=0;b<this.height;b++)for(let g=0;g<this.width;g++)t[p]=n[b*f+g],p+=c}return t}}const Ls=827345986,ji=0;class Rt{content=0;alphaBits=0;width=0;height=0;type=0;hasMipmaps=!1;mipmapOffsets=new Uint32Array(16);mipmapSizes=new Uint32Array(16);uint8array=null;jpgHeader=null;pallete=null;load(e){const t=_t(e),i=new Int32Array(t.buffer,0,40);if(i[0]!==Ls)throw new Error("WrongMagicNumber");this.content=i[1],this.alphaBits=i[2],this.width=i[3],this.height=i[4],this.type=i[5],this.hasMipmaps=i[6]!==0;for(let n=0;n<16;n++)this.mipmapOffsets[n]=i[7+n],this.mipmapSizes[n]=i[23+n];this.uint8array=t,this.content===ji?this.jpgHeader=t.subarray(160,160+i[39]):this.pallete=t.subarray(156,1180)}getMipmap(e){const t=this.uint8array,i=this.mipmapOffsets[e],n=this.mipmapSizes[e];let r;if(this.content===ji){const o=this.jpgHeader,a=new Uint8Array(o.length+n),l=new Is;a.set(o),a.set(t.subarray(i,i+n),o.length),l.parse(a),r=new ImageData(l.width,l.height),l.getData(r)}else{const o=this.pallete,a=Math.max(this.width/(1<<e),1),l=Math.max(this.height/(1<<e),1),c=a*l;let u=this.alphaBits,h,v=0;r=new ImageData(a,l),u>0&&(u>8&&(u=8),h=new cs(t.buffer,i+c,Math.ceil(c*u/8)),v=As(u,8));const f=r.data;for(let p=0;p<c;p++){const b=p*4,g=t[i+p]*4;f[b]=o[g+2],f[b+1]=o[g+1],f[b+2]=o[g],u>0?f[b+3]=h.readBits(u)*v:f[b+3]=255}}return r}mipmaps(){let e=0;for(const t of this.mipmapSizes)t>0&&(e+=1);return e}fakeMipmaps(){const e=this.mipmapOffsets;let t=0;for(let i=0;i<16;i++){const n=e[i];if(n>0){for(let r=i+1;r<16;r++)if(n===e[r]){t+=1;break}}}return t}}async function Ki(s,e){if(e==="image")return new Promise(t=>{const i=new Image;i.onload=()=>{t({ok:!0,data:i})},i.onerror=n=>{t({ok:!1,error:"Image Error",data:n})},i.src=s});{let t;try{t=await fetch(s)}catch(i){return{ok:!1,error:"Network Error",data:i}}if(!t.ok)return{ok:!1,error:"Http Error",data:t};try{let i=null;return e==="text"?i=await t.text():e==="arrayBuffer"||e==="bytes"?i=await t.arrayBuffer():e==="blob"&&(i=await t.blob()),e==="bytes"&&(i=new Uint8Array(i)),{ok:!0,data:i}}catch(i){return{ok:!1,error:"Data Error",data:i}}}}class Cs{gl;buffer;size=0;arrayBuffer=null;byteView=null;floatView=null;constructor(e,t=4){this.gl=e,this.buffer=e.createBuffer(),this.reserve(t)}reserve(e){if(this.size<e){const t=this.gl;this.size=Math.ceil(e/4)*4,t.bindBuffer(t.ARRAY_BUFFER,this.buffer),t.bufferData(t.ARRAY_BUFFER,this.size,t.DYNAMIC_DRAW),this.arrayBuffer=new ArrayBuffer(this.size),this.byteView=new Uint8Array(this.arrayBuffer),this.floatView=new Float32Array(this.arrayBuffer)}}bindAndUpdate(e=this.size){const t=this.gl,i=this.byteView;t.bindBuffer(t.ARRAY_BUFFER,this.buffer),t.bufferSubData(t.ARRAY_BUFFER,0,i.subarray(0,e))}}class Rs{gl;texture;width=0;height=0;arrayBuffer=new ArrayBuffer(0);byteView=null;floatView=null;constructor(e,t=1,i=1){this.gl=e,this.texture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),this.reserve(t,i)}reserve(e,t){if(this.width<e||this.height<t){const i=this.gl;this.width=Math.max(this.width,e),this.height=Math.max(this.height,t),i.bindTexture(i.TEXTURE_2D,this.texture),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,this.width,this.height,0,i.RGBA,i.FLOAT,null),this.arrayBuffer=new ArrayBuffer(this.width*this.height*16),this.byteView=new Uint8Array(this.arrayBuffer),this.floatView=new Float32Array(this.arrayBuffer)}}bindAndUpdate(e=this.width,t=this.height){const i=this.gl;i.bindTexture(i.TEXTURE_2D,this.texture),i.texSubImage2D(i.TEXTURE_2D,0,0,0,e,t,i.RGBA,i.FLOAT,this.byteView)}}class qi{gl;texture;format;width=0;height=0;constructor(e,t=4,i=1,n=1){this.gl=e,this.texture=e.createTexture(),this.format=t===3?e.RGB:e.RGBA,e.bindTexture(e.TEXTURE_2D,this.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),this.reserve(i,n)}reserve(e,t){if(this.width<e||this.height<t){const i=this.gl;this.width=Math.max(this.width,e),this.height=Math.max(this.height,t),i.bindTexture(i.TEXTURE_2D,this.texture),i.texImage2D(i.TEXTURE_2D,0,this.format,this.width,this.height,0,this.format,i.FLOAT,null)}}bindAndUpdate(e,t=this.width,i=this.height){const n=this.gl;n.bindTexture(n.TEXTURE_2D,this.texture),n.texSubImage2D(n.TEXTURE_2D,0,0,0,t,i,this.format,n.FLOAT,e)}bind(e){const t=this.gl;t.activeTexture(t.TEXTURE0+e),t.bindTexture(t.TEXTURE_2D,this.texture)}}class Bs{webgl;program;uniforms={};attribs={};attribsCount=0;constructor(e,t){this.webgl=e,this.program=t;const i=e.gl;for(let n=0,r=i.getProgramParameter(t,i.ACTIVE_UNIFORMS);n<r;n++){const o=i.getActiveUniform(t,n);if(o)if(o.size===1)this.uniforms[o.name]=i.getUniformLocation(t,o.name);else{const a=o.name.substr(0,o.name.length-3);for(let l=0;l<o.size;l++){const c=a+"["+l+"]";this.uniforms[c]=i.getUniformLocation(t,c)}}}for(let n=0,r=i.getProgramParameter(t,i.ACTIVE_ATTRIBUTES);n<r;n++){const o=i.getActiveAttrib(t,n);if(o)if(this.attribsCount+=o.size,o.size===1)this.attribs[o.name]=i.getAttribLocation(t,o.name);else{const a=o.name.substr(0,o.name.length-3);for(let l=0;l<o.size;l++){const c=a+"["+l+"]";this.attribs[c]=i.getAttribLocation(t,c)}}}}use(){this.webgl.useShader(this)}}class Ps{gl;currentShader=null;emptyTexture;extensions={};constructor(e,t={alpha:!1}){let i=e.getContext("webgl",t);if(i||(i=e.getContext("experimental-webgl",t)),!i)throw new Error("WebGL: Failed to create a WebGL context!");const n=new Uint8ClampedArray(16).fill(255),r=i.createTexture();i.bindTexture(i.TEXTURE_2D,r),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,2,2,0,i.RGBA,i.UNSIGNED_BYTE,n),this.gl=i,this.emptyTexture=r}ensureExtension(e){const t=this.gl.getExtension(e);return t?(this.extensions[e]=t,!0):!1}createShader(e,t){const i=this.gl,n=i.createShader(i.VERTEX_SHADER);i.shaderSource(n,e),i.compileShader(n);const r=i.createShader(i.FRAGMENT_SHADER);i.shaderSource(r,t),i.compileShader(r);const o=i.createProgram();if(i.attachShader(o,n),i.attachShader(o,r),i.linkProgram(o),!i.getProgramParameter(o,i.LINK_STATUS)){let a="Shader failed to link:";const l=i.getShaderInfoLog(n);l&&l.length&&(a+=` Vertex shader: ${l}`);const c=i.getShaderInfoLog(r);throw c&&c.length&&(a+=` Fragment shader: ${c}`),new Error(a)}return new Bs(this,o)}enableVertexAttribs(e,t){const i=this.gl;for(let n=e;n<t;n++)i.enableVertexAttribArray(n)}disableVertexAttribs(e,t){const i=this.gl;for(let n=e;n<t;n++)i.disableVertexAttribArray(n)}useShader(e){if(e&&e!==this.currentShader){let t=0;const i=e.attribsCount;this.currentShader&&(t=this.currentShader.attribsCount),this.gl.useProgram(e.program),i>t?this.enableVertexAttribs(t,i):i<t&&this.disableVertexAttribs(i,t),this.currentShader=e}}bindTexture(e,t){const i=this.gl;i.activeTexture(i.TEXTURE0+t),e?i.bindTexture(i.TEXTURE_2D,e.webglResource):i.bindTexture(i.TEXTURE_2D,this.emptyTexture)}bindTextureAndWrap(e,t,i,n){const r=this.gl;r.activeTexture(r.TEXTURE0+t),e?r.bindTexture(r.TEXTURE_2D,e.webglResource):r.bindTexture(r.TEXTURE_2D,this.emptyTexture),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,i),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,n)}setTextureMode(e,t,i,n){const r=this.gl;r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,e),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,t),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,i),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,n)}createClientBuffer(e=4){return new Cs(this.gl,e)}createDataTexture(e=4,t=1,i=1){return new qi(this.gl,e,t,i)}createClientDataTexture(e=1,t=1){return new Rs(this.gl,e,t)}}const Xe=d.vec3.create(),Fs=d.vec3.create(),ks=d.vec3.create(),Os=d.quat.create(),Us=d.quat.setAxisAngle(d.quat.create(),At,Math.PI/2);let Vs=class{isPerspective=!0;fov=0;aspect=0;isOrtho=!1;leftClipPlane=0;rightClipPlane=0;bottomClipPlane=0;topClipPlane=0;nearClipPlane=0;farClipPlane=0;location=d.vec3.create();rotation=d.quat.create();inverseRotation=d.quat.create();viewMatrix=d.mat4.create();projectionMatrix=d.mat4.create();viewProjectionMatrix=d.mat4.create();inverseViewMatrix=d.mat4.create();inverseViewProjectionMatrix=d.mat4.create();directionX=d.vec3.create();directionY=d.vec3.create();directionZ=d.vec3.create();vectors=[d.vec3.fromValues(-1,-1,0),d.vec3.fromValues(-1,1,0),d.vec3.fromValues(1,1,0),d.vec3.fromValues(1,-1,0),d.vec3.fromValues(1,0,0),d.vec3.fromValues(0,1,0),d.vec3.fromValues(0,0,1)];billboardedVectors=[d.vec3.create(),d.vec3.create(),d.vec3.create(),d.vec3.create(),d.vec3.create(),d.vec3.create(),d.vec3.create()];planes=[d.vec4.create(),d.vec4.create(),d.vec4.create(),d.vec4.create(),d.vec4.create(),d.vec4.create()];perspective(e,t,i,n){this.isPerspective=!0,this.isOrtho=!1,this.fov=e,this.aspect=t,this.nearClipPlane=i,this.farClipPlane=n,this.update()}ortho(e,t,i,n,r,o){this.isPerspective=!1,this.isOrtho=!0,this.leftClipPlane=e,this.rightClipPlane=t,this.bottomClipPlane=i,this.topClipPlane=n,this.nearClipPlane=r,this.farClipPlane=o,this.update()}setLocation(e){d.vec3.copy(this.location,e),this.update()}move(e){d.vec3.add(this.location,this.location,e),this.update()}setRotation(e){d.quat.copy(this.rotation,e),this.update()}rotate(e){d.quat.mul(this.rotation,this.rotation,e),this.update()}face(e,t){d.quat.mul(this.rotation,Us,Yt(Os,e,this.location,t)),this.update()}moveToAndFace(e,t,i){d.vec3.copy(this.location,e),this.face(t,i)}reset(){d.vec3.set(this.location,0,0,0),d.quat.identity(this.rotation),this.update()}update(){const e=this.location,t=this.rotation,i=this.inverseRotation,n=this.viewMatrix,r=this.projectionMatrix,o=this.viewProjectionMatrix,a=this.vectors,l=this.billboardedVectors;this.isPerspective?d.mat4.perspective(r,this.fov,this.aspect,this.nearClipPlane,this.farClipPlane):d.mat4.ortho(r,this.leftClipPlane,this.rightClipPlane,this.bottomClipPlane,this.topClipPlane,this.nearClipPlane,this.farClipPlane),d.mat4.fromQuat(n,t),d.mat4.translate(n,n,d.vec3.negate(Xe,e)),d.mat4.mul(o,r,n),d.mat4.invert(this.inverseViewMatrix,n),d.mat4.invert(this.inverseViewProjectionMatrix,o),Qn(this.planes,o),d.quat.conjugate(i,t),d.vec3.transformQuat(this.directionX,At,i),d.vec3.transformQuat(this.directionY,$t,i),d.vec3.transformQuat(this.directionZ,je,i);for(let c=0;c<7;c++)d.vec3.transformQuat(l[c],a[c],i)}cameraToWorld(e,t){return d.vec3.transformMat4(e,t,this.inverseViewMatrix)}worldToCamera(e,t){return d.vec3.transformMat4(e,t,this.viewMatrix)}worldToScreen(e,t,i){return d.vec3.transformMat4(Xe,t,this.viewProjectionMatrix),e[0]=Math.round((Xe[0]+1)/2*i[2]),e[1]=Math.round((Xe[1]+1)/2*i[3]),e}screenToWorldRay(e,t,i){const n=Xe,r=Fs,o=ks,a=t[0],l=t[1],c=this.inverseViewProjectionMatrix;return Xt(n,d.vec3.set(o,a,l,0),c,i),Xt(r,d.vec3.set(o,a,l,1),c,i),e.set(n,0),e.set(r,3),e}};class Ms{left;right;bottom;top;plane=-1;instances=[];visible=!1;constructor(e,t,i,n){this.left=e,this.right=t,this.bottom=i,this.top=n}add(e){this.instances.push(e)}remove(e){const t=this.instances.indexOf(e);this.instances.splice(t,1)}clear(){this.instances.length=0}isVisible(e){return this.plane=Wn(e.planes,this.left,this.right,this.bottom,this.top,this.plane),this.plane===-1}}class Ds{x;y;width;depth;cellWidth;cellDepth;columns;rows;cells=[];constructor(e,t,i,n,r,o){const a=i/r,l=n/o;this.x=e,this.y=t,this.width=i,this.depth=n,this.cellWidth=r,this.cellDepth=o,this.columns=a,this.rows=l;for(let c=0;c<l;c++)for(let u=0;u<a;u++){const h=e+u*r,v=h+r,f=t+c*o,p=f+o;this.cells[c*a+u]=new Ms(h,v,f,p)}}add(e){const t=this.cells,i=this.columns,n=e.left,r=e.right+1,o=e.bottom,a=e.top+1;if(n!==-1)for(let l=o;l<a;l++)for(let c=n;c<r;c++)t[l*i+c].add(e)}remove(e){const t=this.cells,i=this.columns,n=e.left,r=e.right+1,o=e.bottom,a=e.top+1;if(n!==-1){e.left=-1;for(let l=o;l<a;l++)for(let c=n;c<r;c++)t[l*i+c].remove(e)}}moved(e){const t=this.cellWidth,i=this.cellDepth,n=e.model.bounds,r=e.worldLocation[0]+n.x-this.x,o=e.worldLocation[1]+n.y-this.y,a=n.r,l=e.worldScale;let c=Math.floor((r-a*l[0])/t),u=Math.floor((r+a*l[0])/t),h=Math.floor((o-a*l[1])/i),v=Math.floor((o+a*l[1])/i);u<0||c>this.columns-1||v<0||h>this.rows-1?this.remove(e):(c=Math.max(c,0),u=Math.min(u,this.columns-1),h=Math.max(h,0),v=Math.min(v,this.rows-1),(c!==e.left||u!==e.right||h!==e.bottom||v!==e.top)&&(this.remove(e),e.left=c,e.right=u,e.bottom=h,e.top=v,this.add(e)))}clear(){for(const e of this.cells)e.clear()}}class Ns{objects=[];alive=0;add(e){this.objects[this.alive++]=e}update(e){const t=this.objects;for(let i=0;i<this.alive;i++){const n=t[i];n.update(e*n.emitter.instance.timeScale),n.health<=0&&(this.alive-=1,n.emitter.kill(n),i!==this.alive&&(t[i]=t[this.alive],i-=1))}}}class Gs{viewer;camera=new Vs;grid=new Ds(-1e5,-1e5,2e5,2e5,2e5,2e5);visibleCells=0;visibleInstances=0;updatedParticles=0;audioEnabled=!1;audioContext=null;instances=[];emittedObjectUpdater=new Ns;alpha=!1;color=d.vec3.create();viewport=d.vec4.create();lightPosition=d.vec3.fromValues(0,0,1e4);constructor(e){this.viewer=e;const t=e.canvas,i=t.width,n=t.height;this.viewport[2]=i,this.viewport[3]=n,this.camera.perspective(Math.PI/4,i/n,8,1e4)}async enableAudio(){return typeof AudioContext=="function"?(this.audioContext||(this.audioContext=new AudioContext),this.audioContext.state!=="suspended"&&await this.audioContext.resume(),this.audioEnabled=this.audioContext.state==="running",this.audioEnabled):!1}disableAudio(){this.audioContext&&this.audioContext.suspend(),this.audioEnabled=!1}addInstance(e){return e.scene!==this?(e.scene&&e.scene.removeInstance(e),e.scene=this,this.grid.moved(e),!0):!1}removeInstance(e){return e.scene===this?(this.grid.remove(e),e.scene=null,!0):!1}clear(){for(const e of this.grid.cells)for(const t of e.instances)t.scene=null;this.grid.clear()}detach(){return this.viewer?this.viewer.removeScene(this):!1}update(e){const t=this.camera;if(this.audioContext){const r=this.audioContext.listener,o=t.location,a=t.directionY,l=t.directionZ;r.positionX.value=-o[0],r.positionY.value=-o[1],r.positionZ.value=-o[2],r.forwardX.value=a[0],r.forwardY.value=a[1],r.forwardZ.value=a[2],r.upX.value=l[0],r.upY.value=l[1],r.upZ.value=l[2]}const i=this.viewer.frame,n=this.instances;this.visibleCells=0,this.visibleInstances=0;for(const r of this.grid.cells)if(r.isVisible(t)){this.visibleCells+=1;for(const o of r.instances)o.rendered&&o.updateFrame<i&&!o.parent&&(o.updateFrame=i,o.update(e))}n.length=this.visibleInstances,n.sort((r,o)=>r.depth-o.depth),this.emittedObjectUpdater.update(e),this.updatedParticles=this.emittedObjectUpdater.alive}renderInstance(e){this.instances[this.visibleInstances++]=e}startFrame(){const e=this.viewer.gl,t=this.viewport;if(e.viewport(t[0],t[1],t[2],t[3]),e.scissor(t[0],t[1],t[2],t[3]),!this.alpha){const i=this.color;e.depthMask(!0),e.clearColor(i[0],i[1],i[2],1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)}}renderOpaque(){const e=this.instances;for(let t=0,i=e.length;t<i;t++)e[t].renderOpaque()}renderTranslucent(){const e=this.instances;for(let t=e.length-1;t>=0;t--)e[t].renderTranslucent()}render(){this.startFrame(),this.renderOpaque(),this.renderTranslucent()}clearEmittedObjects(){for(const e of this.emittedObjectUpdater.objects)e.health=0}}class Bt{viewer;fetchUrl;blockers=[];constructor(e){this.viewer=e.viewer,this.fetchUrl=e.fetchUrl}detach(){return this.viewer.unload(this)}}class js extends Bt{data=null;constructor(e,t){super(t),this.data=e}}class Hi extends Bt{pathSolver;constructor(e){super(e),this.pathSolver=e.pathSolver}}class $i extends Hi{webglResource=null;width=0;height=0}function Ks(s){return s instanceof ImageData||s instanceof HTMLImageElement||s instanceof HTMLCanvasElement||s instanceof HTMLVideoElement}function qs(s){return ds(s)?"image/png":us(s)?"image/jpeg":fs(s)?"image/gif":ps(s)?"image/webp":""}class Xi extends $i{constructor(e,t){super(t);const i=this.viewer.gl;this.webglResource=i.createTexture(),i.bindTexture(i.TEXTURE_2D,this.webglResource),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),et(e.width)&&et(e.height)?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR_MIPMAP_LINEAR),i.generateMipmap(i.TEXTURE_2D)):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE)),this.width=e.width,this.height=e.height}}var R=(s=>(s[s.None=0]="None",s[s.Diffuse=1]="Diffuse",s[s.NormalMap=2]="NormalMap",s[s.Occlusion=3]="Occlusion",s[s.Roughness=4]="Roughness",s[s.Metallic=5]="Metallic",s[s.TCFactor=6]="TCFactor",s[s.Emissive=7]="Emissive",s[s.TexCoords=8]="TexCoords",s[s.Normals=9]="Normals",s[s.Tangents=10]="Tangents",s))(R||{});class Hs extends $n.EventEmitter{canvas;gl;webgl;resources=[];resourceMap=new Map;promiseMap=new Map;handlers=new Set;scenes=[];frame=0;visibleCells=0;visibleInstances=0;updatedParticles=0;audioEnabled=!1;buffer;sharedCache=new Map;debugRenderMode=0;directLoadId=0;constructor(e,t){super();const i=new Ps(e,t),n=i.gl;this.canvas=e,this.gl=n,this.webgl=i,this.buffer=i.createClientBuffer(),n.depthFunc(n.LEQUAL),n.enable(n.DEPTH_TEST),n.enable(n.SCISSOR_TEST)}enableAudio(){return typeof AudioContext=="function"?(this.audioEnabled=!0,!0):!1}addHandler(e,...t){if(e){const i=this.handlers;if(!i.has(e)){if(!e.isValidSource)return this.emit("error",{viewer:this,error:"Handler missing the isValidSource function",handler:e}),!1;if(e.load)try{e.load(this,...t)}catch(n){return this.emit("error",{viewer:this,error:"Handler failed to load",handler:e,reason:n}),!1}return i.add(e),!0}}return!1}addScene(){const e=new Gs(this);return this.scenes.push(e),e}removeScene(e){const t=this.scenes,i=t.indexOf(e);return i!==-1?(t.splice(i,1),!0):!1}clear(){this.scenes.length=0}async load(e,t,i){let n,r="",o;if(t)try{n=t(e,i)}catch(a){this.emit("error",{viewer:this,error:"Path solver failed",src:e,reason:a,pathSolver:t,solverParams:i});return}else n=e;if(n){if(n instanceof Promise&&(n=await n),n instanceof Bt)return n;if(typeof n=="string"&&!this.detectFormat(n)){if(r=n,o=this.promiseMap.get(r),o)return o;const a=this.resourceMap.get(r);if(a)return a;o=Ki(r,"arrayBuffer").then(l=>{if(l.ok)return l.data;this.emit("error",{viewer:this,error:`Failed to fetch a resource: ${l.error}`,fetchUrl:r,reason:l.data})})}else r=`__DIRECT_LOAD_${this.directLoadId++}`,o=Promise.resolve(n);return o=o.then(async a=>{if(a){if(a instanceof ArrayBuffer&&(a=new Uint8Array(a)),Ks(a))return new Xi(a,{viewer:this,fetchUrl:r,pathSolver:t});if(a instanceof Uint8Array){const c=qs(a);if(c.length)return new Xi(await ns(new Blob([a.buffer],{type:c})),{viewer:this,fetchUrl:r,pathSolver:t})}const l=this.detectFormat(a);if(l)try{const c=new l.resource(a,{viewer:this,fetchUrl:r,pathSolver:t});return await Promise.all(c.blockers),c.blockers.length=0,c}catch(c){this.emit("error",{viewer:this,error:"Failed to create a resource",fetchUrl:r,src:e,reason:c})}else this.emit("error",{viewer:this,error:"Source has no matching handler",fetchUrl:r,src:e})}}).then(a=>(this.promiseMap.delete(r),a&&(this.resourceMap.set(r,a),this.resources.push(a),this.emit("load",{viewer:this,fetchUrl:r,resource:a})),this.emit("loadend",{viewer:this,fetchUrl:r,resource:a}),this.checkLoadingStatus(),a)),this.promiseMap.set(r,o),this.emit("loadstart",{viewer:this,fetchUrl:r,promise:o}),o}}detectFormat(e){for(const t of this.handlers)if(t.isValidSource(e))return t}has(e){return this.resourceMap.has(e)}get(e){return this.resourceMap.get(e)}async loadGeneric(e,t,i){const n=this.promiseMap.get(e);if(n)return n;const r=this.resourceMap.get(e);if(r)return r;const o=Ki(e,t).then(async a=>{this.promiseMap.delete(e);let l;if(a.ok){let c=a.data;i&&(c=await i(c)),l=new js(c,{viewer:this,fetchUrl:e}),this.resourceMap.set(e,l),this.resources.push(l),this.emit("load",{viewer:this,fetchUrl:e,resource:l})}else this.emit("error",{viewer:this,error:"Failed to fetch a generic resource",fetchUrl:e});return this.emit("loadend",{viewer:this,fetchUrl:e,resource:l}),this.checkLoadingStatus(),l});return this.promiseMap.set(e,o),this.emit("loadstart",{viewer:this,fetchUrl:e}),o}unload(e){const t=e.fetchUrl;t!==""&&this.resourceMap.delete(t);const i=this.resources,n=i.indexOf(e);return n!==-1?(i.splice(n,1),!0):!1}promise(){const e=Promise.resolve(void 0),t=`${performance.now()}`;return this.promiseMap.set(t,e),()=>{this.promiseMap.delete(t),this.checkLoadingStatus()}}checkLoadingStatus(){this.promiseMap.size===0&&setTimeout(()=>this.emit("idle"),0)}whenAllLoaded(e){const t=new Promise(i=>{this.promiseMap.size===0?i(this):this.once("idle",()=>i(this))});if(e)t.then(()=>e(this));else return t}toBlob(e){const t=new Promise(i=>this.canvas.toBlob(n=>i(n)));if(e)t.then(i=>e(i));else return t}updateAndRender(e=1e3/60){this.update(e),this.startFrame(),this.render()}update(e=1e3/60){e*=.001,this.frame+=1,this.visibleCells=0,this.visibleInstances=0,this.updatedParticles=0;for(const t of this.scenes)t.update(e),this.visibleCells+=t.visibleCells,this.visibleInstances+=t.visibleInstances,this.updatedParticles+=t.updatedParticles}startFrame(){const e=this.gl;e.depthMask(!0),e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)}render(){for(const e of this.scenes)e.render()}clearEmittedObjects(){for(const e of this.scenes)e.clearEmittedObjects()}}const $s=d.vec3.create(),Xs=d.quat.create(),zs=d.vec3.create();class Ys{pivot=d.vec3.create();localLocation=d.vec3.create();localRotation=d.quat.create();localScale=d.vec3.fromValues(1,1,1);worldLocation=d.vec3.create();worldRotation=d.quat.create();worldScale=d.vec3.fromValues(1,1,1);inverseWorldLocation=d.vec3.create();inverseWorldRotation=d.quat.create();inverseWorldScale=d.vec3.fromValues(1,1,1);localMatrix=d.mat4.create();worldMatrix=d.mat4.create();dontInheritTranslation=!1;dontInheritRotation=!1;dontInheritScaling=!0;parent=null;children=[];setPivot(e){return d.vec3.copy(this.pivot,e),this.recalculateTransformation(),this}setLocation(e){return d.vec3.copy(this.localLocation,e),this.recalculateTransformation(),this}setRotation(e){return d.quat.copy(this.localRotation,e),this.recalculateTransformation(),this}setScale(e){return d.vec3.copy(this.localScale,e),this.recalculateTransformation(),this}setUniformScale(e){return d.vec3.set(this.localScale,e,e,e),this.recalculateTransformation(),this}setTransformation(e,t,i){const n=this.localLocation,r=this.localRotation,o=this.localScale;return n[0]=e[0],n[1]=e[1],n[2]=e[2],r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],o[0]=i[0],o[1]=i[1],o[2]=i[2],this.recalculateTransformation(),this}resetTransformation(){return d.vec3.copy(this.pivot,Le),d.vec3.copy(this.localLocation,Le),d.quat.copy(this.localRotation,xt),d.vec3.copy(this.localScale,Tt),this.recalculateTransformation(),this}movePivot(e){return d.vec3.add(this.pivot,this.pivot,e),this.recalculateTransformation(),this}move(e){return d.vec3.add(this.localLocation,this.localLocation,e),this.recalculateTransformation(),this}rotate(e){return d.quat.mul(this.localRotation,this.localRotation,e),this.recalculateTransformation(),this}rotateLocal(e){return d.quat.mul(this.localRotation,e,this.localRotation),this.recalculateTransformation(),this}scale(e){return d.vec3.mul(this.localScale,this.localScale,e),this.recalculateTransformation(),this}uniformScale(e){return d.vec3.scale(this.localScale,this.localScale,e),this.recalculateTransformation(),this}face(e,t){return d.quat.conjugate(this.localRotation,Yt(this.localRotation,this.localLocation,e,t)),this.recalculateTransformation(),this}setParent(e){if(this.parent){const t=this.parent.children,i=t.indexOf(this);i!==-1&&t.splice(i,1)}return this.parent=e||null,e&&e.children.push(this),this.recalculateTransformation(),this}recalculateTransformation(){const e=this.parent,t=this.localMatrix,i=this.localLocation,n=this.localRotation,r=this.localScale,o=this.worldMatrix,a=this.worldLocation,l=this.worldRotation,c=this.worldScale,u=this.inverseWorldLocation,h=this.inverseWorldRotation,v=this.inverseWorldScale;if(e){const f=$s,p=e.pivot;let b,g;if(f[0]=i[0]+p[0],f[1]=i[1]+p[1],f[2]=i[2]+p[2],this.dontInheritRotation?(b=Xs,d.quat.mul(b,n,e.inverseWorldRotation)):b=n,this.dontInheritScaling){g=zs;const m=e.inverseWorldScale;g[0]=m[0]*r[0],g[1]=m[1]*r[1],g[2]=m[2]*r[2],c[0]=r[0],c[1]=r[1],c[2]=r[2]}else{g=r;const m=e.worldScale;c[0]=m[0]*r[0],c[1]=m[1]*r[1],c[2]=m[2]*r[2]}d.mat4.fromRotationTranslationScale(t,b,f,g),d.mat4.mul(o,e.worldMatrix,t),d.quat.mul(l,e.worldRotation,b)}else d.mat4.fromRotationTranslationScale(t,n,i,r),o[0]=t[0],o[1]=t[1],o[2]=t[2],o[3]=t[3],o[4]=t[4],o[5]=t[5],o[6]=t[6],o[7]=t[7],o[8]=t[8],o[9]=t[9],o[10]=t[10],o[11]=t[11],o[12]=t[12],o[13]=t[13],o[14]=t[14],o[15]=t[15],l[0]=n[0],l[1]=n[1],l[2]=n[2],l[3]=n[3],c[0]=r[0],c[1]=r[1],c[2]=r[2];h[0]=-l[0],h[1]=-l[1],h[2]=-l[2],h[3]=l[3],v[0]=1/c[0],v[1]=1/c[1],v[2]=1/c[2],a[0]=o[12],a[1]=o[13],a[2]=o[14],u[0]=-a[0],u[1]=-a[1],u[2]=-a[2];for(const f of this.children)f.recalculateTransformation()}update(e){for(const t of this.children)t.update(e)}}class zi{x=0;y=0;z=0;r=0;fromExtents(e,t){const i=e[0],n=e[1],r=e[2],o=t[0]-i,a=t[1]-n,l=t[2]-r;this.x=i+o/2,this.y=n+a/2,this.z=r+l/2,this.r=Math.max(0,Math.max(o,a,l)/2)}}class Ws extends Hi{bounds=new zi}class Zs extends Ys{scene=null;left=-1;right=-1;bottom=-1;top=-1;plane=-1;depth=0;updateFrame=0;model;timeScale=1;rendered=!0;textureOverrides=new Map;constructor(e){super(),this.model=e}show(){this.rendered=!0}hide(){this.rendered=!1}shown(){return this.rendered}hidden(){return!this.rendered}detach(){return this.scene?this.scene.removeInstance(this):!1}overrideTexture(e,t){t?this.textureOverrides.set(e,t):this.textureOverrides.delete(e)}getBounds(){return this.model.bounds}clearEmittedObjects(){}setScene(e){return e.addInstance(this)}recalculateTransformation(){super.recalculateTransformation(),this.scene&&this.scene.grid.moved(this)}update(e){const t=this.scene;t&&this.rendered&&this.isVisible(t.camera)&&(t.renderInstance(this),this.updateAnimations(e*this.timeScale),super.update(e))}updateAnimations(e){}renderOpaque(){}renderTranslucent(){}isVisible(e){const[t,i,n]=this.worldLocation,[r,o,a]=this.worldScale,l=this.getBounds(),c=e.planes;let u=r;return o>u&&(u=o),a>u&&(u=a),this.plane=Yn(c,t+l.x,i+l.y,n+l.z,l.r*u,this.plane),this.plane===-1?(this.depth=zt(c[4],t,i,n),!0):!1}}function Qs(s){return s instanceof ArrayBuffer&&(s=new Uint8Array(s)),s instanceof Uint8Array&&s[0]===66&&s[1]===76&&s[2]===80&&s[3]===49}class Js extends $i{constructor(e,t){super(t);let i;e instanceof Rt?i=e:(i=new Rt,i.load(e));const r=this.viewer.gl,o=r.createTexture();r.bindTexture(r.TEXTURE_2D,o),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR);const a=et(i.width)&&et(i.height);a||(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE));const l=i.mipmaps();if(l===1||i.fakeMipmaps()||!a){const c=i.getMipmap(0);r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,c)}else{r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR_MIPMAP_LINEAR);let c=i.width,u=i.height;for(let h=0;h<l;h++){const v=i.getMipmap(h);r.texImage2D(r.TEXTURE_2D,h,r.RGBA,c,u,0,r.RGBA,r.UNSIGNED_BYTE,v.data),c=Math.ceil(c/2),u=Math.ceil(u/2)}}this.width=i.width,this.height=i.height,this.webglResource=o}}const er={isValidSource(s){return s instanceof Rt?!0:Qs(s)},resource:Js};d.vec3.create(),d.quat.create();const Fe=d.vec3.create(),Pt=d.quat.create(),tr=d.vec3.create(),_e=d.vec3.create(),le=d.quat.create();class Yi{pivot;localLocation;localRotation;localScale;worldLocation;worldRotation;worldScale;inverseWorldLocation;inverseWorldRotation;inverseWorldScale;localMatrix;worldMatrix;dontInheritTranslation=!1;dontInheritRotation=!1;dontInheritScaling=!1;billboarded=!1;billboardedX=!1;billboardedY=!1;billboardedZ=!1;dirty=!0;wasDirty=!1;parent=null;children=[];object=null;constructor(e,t,i,n,r,o,a,l,c,u,h,v){this.pivot=e,this.localLocation=t,this.localRotation=i,this.localScale=n,this.worldLocation=r,this.worldRotation=o,this.worldScale=a,this.inverseWorldLocation=l,this.inverseWorldRotation=c,this.inverseWorldScale=u,this.localMatrix=h,this.worldMatrix=v,this.localRotation[3]=1,this.localScale.fill(1),this.localMatrix[0]=1,this.localMatrix[5]=1,this.localMatrix[10]=1,this.localMatrix[15]=1}recalculateTransformation(e){const t=e.scene,i=this.localMatrix,n=this.localLocation,r=this.localRotation,o=this.localScale,a=this.worldMatrix,l=this.worldLocation,c=this.worldRotation,u=this.worldScale,h=this.pivot,v=this.inverseWorldLocation,f=this.inverseWorldRotation,p=this.inverseWorldScale,b=this.parent;let g,m,w;if(this.dontInheritTranslation?(d.vec3.add(Fe,b.inverseWorldLocation,l),g=d.vec3.add(Fe,Fe,n)):g=n,this.dontInheritScaling?(d.vec3.mul(Fe,b.inverseWorldScale,e.worldScale),w=d.vec3.mul(Fe,Fe,o)):w=o,this.billboarded)m=Pt,d.quat.copy(m,b.inverseWorldRotation),d.quat.mul(m,m,t.camera.inverseRotation),this.convertBasis(m),d.quat.mul(m,m,r);else{const{billboardedX:O,billboardedY:V,billboardedZ:K}=this;O||V||K?(O&&(w===o&&(w=tr,d.vec3.copy(w,o)),w[2]*=-1),le[0]=-r[0],le[1]=-r[1],le[2]=-r[2],d.quat.mul(le,le,b.inverseWorldRotation),d.vec3.transformQuat(_e,t.camera.billboardedVectors[6],le),O?d.quat.setAxisAngle(le,At,Math.atan2(_e[2],_e[1])):V?d.quat.setAxisAngle(le,$t,Math.atan2(-_e[2],_e[0])):d.quat.setAxisAngle(le,je,Math.atan2(_e[1],_e[0])),m=Pt,d.quat.mul(m,r,le)):m=r}this.dontInheritRotation&&(d.quat.mul(le,b.inverseWorldRotation,e.worldRotation),m=d.quat.mul(Pt,le,m)),d.mat4.fromRotationTranslationScaleOrigin(i,m,g,w,h),d.mat4.mul(a,b.worldMatrix,i);const I=h[0],T=h[1],A=h[2];l[0]=a[0]*I+a[4]*T+a[8]*A+a[12],l[1]=a[1]*I+a[5]*T+a[9]*A+a[13],l[2]=a[2]*I+a[6]*T+a[10]*A+a[14],v[0]=-l[0],v[1]=-l[1],v[2]=-l[2],d.quat.mul(c,b.worldRotation,m),f[0]=-c[0],f[1]=-c[1],f[2]=-c[2],f[3]=c[3];const y=b.worldScale;u[0]=y[0]*w[0],u[1]=y[1]*w[1],u[2]=y[2]*w[2],p[0]=1/u[0],p[1]=1/u[1],p[2]=1/u[2]}convertBasis(e){}}const ir=65;function nr(s,e=Yi){const t=new Float32Array(s*ir),i=[];let n=0;const r=s*3,o=s*4,a=s*16,l=t.subarray(n,n+r);n+=r;const c=t.subarray(n,n+r);n+=r;const u=t.subarray(n,n+o);n+=o;const h=t.subarray(n,n+r);n+=r;const v=t.subarray(n,n+r);n+=r;const f=t.subarray(n,n+o);n+=o;const p=t.subarray(n,n+r);n+=r;const b=t.subarray(n,n+r);n+=r;const g=t.subarray(n,n+o);n+=o;const m=t.subarray(n,n+r);n+=r;const w=t.subarray(n,n+a);n+=a;const I=t.subarray(n,n+a);for(let T=0;T<s;T++){const A=T*3,y=A+3,O=T*4,V=O+4,K=T*16,G=K+16;i[T]=new e(l.subarray(A,y),c.subarray(A,y),u.subarray(O,V),h.subarray(A,y),v.subarray(A,y),f.subarray(O,V),p.subarray(A,y),b.subarray(A,y),g.subarray(O,V),m.subarray(A,y),w.subarray(K,G),I.subarray(K,G))}return{data:t,nodes:i,pivots:l,localLocations:c,localRotations:u,localScales:h,worldLocations:v,worldRotations:f,worldScales:p,inverseWorldLocations:b,invereseWorldRotations:g,inverseWorldScales:m,localMatrices:w,worldMatrices:I}}d.mat4.create();const Wi=`
uniform sampler2D u_boneMap;
uniform float u_vectorSize;
uniform float u_rowSize;

mat4 fetchMatrix(float column, float row) {
  column *= u_vectorSize * 4.0;
  row *= u_rowSize;
  // Add in half a texel, to sample in the middle of the texel.
  // Otherwise, since the sample is directly on the boundary, floating point errors can cause the sample to get the wrong pixel.
  // This is most noticeable with NPOT textures, which the bone maps are.
  column += 0.5 * u_vectorSize;
  row += 0.5 * u_rowSize;

  return mat4(texture2D(u_boneMap, vec2(column, row)),
              texture2D(u_boneMap, vec2(column + u_vectorSize, row)),
              texture2D(u_boneMap, vec2(column + u_vectorSize * 2.0, row)),
              texture2D(u_boneMap, vec2(column + u_vectorSize * 3.0, row)));
}
`,Ft=`
#ifdef GL_FRAGMENT_PRECISION_HIGH
precision highp float;
#else
precision mediump float;
#endif
`;let kt;typeof OfflineAudioContext=="function"&&(kt=new OfflineAudioContext(1,1,48e3));async function sr(s){if(kt)return kt.decodeAudioData(s)}class Zi{map={};set(e,t){typeof t!="string"&&(t=t.toString()),this.map[e.toLowerCase()]=t}string(e){return this.map[e.toLowerCase()]}number(e){const t=this.string(e);return t?parseFloat(t):0}}class rr{map={};constructor(e){e&&this.load(e)}load(e){if(e.startsWith("ID;")){const t=new bs;t.load(e);const i=t.rows,n=i[0],r=this.map;for(let o=1,a=i.length;o<a;o++){const l=i[o];if(l){const c=l[0];if(c&&c!=="_"){r[c]||(r[c]=new Zi);const u=r[c];for(let h=0,v=n.length;h<v;h++){let f=n[h];f===void 0&&(f=`column${h}`),u.map[f.toLowerCase()]=l[h]}}}}}else{const t=new vs;t.load(e);const i=t.sections,n=this.map;for(const[r,o]of i.entries()){n[r]||(n[r]=new Zi);const a=n[r];for(const[l,c]of o)a.map[l.toLowerCase()]=c}}}getRow(e){return this.map[e]}getProperty(e,t){return this.map[e].map[t]}setRow(e,t){this.map[e]=t}findRow(e,t){for(const i of Object.values(this.map))if(i.string(e)===t)return i}}class or{name;interval;nonLooping;rarity;bounds;constructor(e){this.name=e.name,this.interval=e.interval,this.nonLooping=e.nonLooping,this.rarity=e.rarity,this.bounds=new zi;const t=e.extent;this.bounds.fromExtents(t.min,t.max)}}class Qi{sd;start;end;frames=[];values=[];inTans=[];outTans=[];constant=!1;constructor(e,t,i,n,r){this.sd=e,this.start=t,this.end=i;const o=e.interpolationType,a=n.frames,l=n.values,c=n.inTans,u=n.outTans,h=e.defval;r&&a[0]>i&&(this.frames[0]=a[0],this.values[0]=l[0]);for(let f=0,p=a.length;f<p;f++){const b=a[f];b>=t&&b<=i&&(this.frames.push(b),this.values.push(l[f]),o>1&&(this.inTans.push(c[f]),this.outTans.push(u[f])))}const v=this.frames.length;if(v===0)this.constant=!0,this.frames[0]=t,this.values[0]=h;else if(v===1)this.constant=!0;else{const f=this.values[0];this.constant=this.values.every(p=>f.every((b,g)=>b===p[g]))}}getValue(e,t){const n=this.frames.length;if(this.constant||t<this.start)return this.sd.copy(e,this.values[0]),-1;{let r=-1,o=-1;const a=n-1;if(t<this.frames[0]||t>=this.frames[a])r=a,o=0;else for(let v=1;v<n;v++)if(this.frames[v]>t){r=v-1,o=v;break}let l=this.frames[r];const c=this.frames[o];let u=c-l;u<0&&(u+=this.end-this.start,t<l&&(l=c));const h=u==0?0:(t-l)/u;return this.sd.interpolate(e,this.values,this.inTans,this.outTans,r,o,h),r}}}const ar={KLAV:Y.DontInterp,KATV:Y.DontInterp,KPEV:Y.DontInterp,KP2V:Y.DontInterp,KRVS:Y.DontInterp},q=new Float32Array(1),lr=new Uint32Array(1),ke=new Float32Array([1]),ze=d.vec3.create(),Ji=d.quat.create(),en=d.vec3.fromValues(1,1,1),tn=ke,ut=ze,cr={KMTF:q,KMTA:tn,KTAT:ze,KTAR:Ji,KTAS:en,KGAO:tn,KGAC:ut,KLAS:q,KLAE:q,KLAC:ut,KLAI:q,KLBI:q,KLBC:ut,KLAV:ke,KATV:ke,KPEE:q,KPEG:q,KPLN:q,KPLT:q,KPEL:q,KPES:q,KPEV:ke,KP2S:q,KP2R:q,KP2L:q,KP2G:q,KP2E:q,KP2N:q,KP2W:q,KP2V:ke,KRHA:q,KRHB:q,KRAL:new Float32Array([0]),KRCO:ut,KRTX:q,KRVS:ke,KCTR:ze,KTTR:ze,KCRL:lr,KGTR:ze,KGRT:Ji,KGSC:en};class Ot{defval;model;name;globalSequence=null;sequences=[];interpolationType;constructor(e,t){const i=e.globalSequences,n=t.globalSequenceId,r=ar[t.name];if(this.model=e,this.name=t.name,this.defval=cr[t.name],this.interpolationType=r!==void 0?r:t.interpolationType,n!==-1&&i)this.globalSequence=new Qi(this,0,i[n],t,!0);else for(const o of e.sequences){const a=o.interval;this.sequences.push(new Qi(this,a[0],a[1],t,!1))}}getValue(e,t,i,n){return this.globalSequence?this.globalSequence.getValue(e,n%this.globalSequence.end):this.sequences[t].getValue(e,i)}isVariant(e){return this.globalSequence?!this.globalSequence.constant:!this.sequences[e].constant}}class hr extends Ot{copy(e,t){e[0]=t[0]}interpolate(e,t,i,n,r,o,a){const l=this.interpolationType,c=t[r][0];l===Y.DontInterp?e[0]=c:l===Y.Linear?e[0]=es(c,t[o][0],a):l===Y.Hermite?e[0]=ts(c,n[r][0],i[o][0],t[o][0],a):l===Y.Bezier&&(e[0]=is(c,n[r][0],i[o][0],t[o][0],a))}}class dr extends Ot{copy(e,t){d.vec3.copy(e,t)}interpolate(e,t,i,n,r,o,a){const l=this.interpolationType;l===Y.DontInterp?d.vec3.copy(e,t[r]):l===Y.Linear?d.vec3.lerp(e,t[r],t[o],a):l===Y.Hermite?d.vec3.hermite(e,t[r],n[r],i[o],t[o],a):l===Y.Bezier&&d.vec3.bezier(e,t[r],n[r],i[o],t[o],a)}}class ur extends Ot{copy(e,t){d.quat.copy(e,t)}interpolate(e,t,i,n,r,o,a){const l=this.interpolationType;l===Y.DontInterp?d.quat.copy(e,t[r]):l===Y.Linear?d.quat.slerp(e,t[r],t[o],a):(l===Y.Hermite||l===Y.Bezier)&&d.quat.sqlerp(e,t[r],n[r],i[o],t[o],a)}}function fr(s,e){return e instanceof nt||e instanceof P?new hr(s,e):e instanceof se?new dr(s,e):new ur(s,e)}class Ye{model;animations=new Map;variants={};constructor(e,t){this.model=e;for(const i of t.animations)this.animations.set(i.name,fr(e,i))}getScalarValue(e,t,i,n,r,o){if(i!==-1){const a=this.animations.get(t);if(a)return a.getValue(e,i,n,r)}return e[0]=o,-1}getVectorValue(e,t,i,n,r,o){if(i!==-1){const a=this.animations.get(t);if(a)return a.getValue(e,i,n,r)}return e[0]=o[0],e[1]=o[1],e[2]=o[2],-1}getQuatValue(e,t,i,n,r,o){if(i!==-1){const a=this.animations.get(t);if(a)return a.getValue(e,i,n,r)}return e[0]=o[0],e[1]=o[1],e[2]=o[2],e[3]=o[3],-1}addVariants(e,t){const i=this.animations.get(e),n=this.model.sequences.length,r=new Uint8Array(n);if(i)for(let o=0;o<n;o++)i.isVariant(o)&&(r[o]=1);this.variants[t]=r}addVariantIntersection(e,t){const i=this.model.sequences.length,n=new Uint8Array(i);for(let r=0;r<i;r++)for(const o of e)this.variants[o][r]&&(n[r]=1);this.variants[t]=n}}class pr extends Ye{constructor(e,t){super(e,t),this.addVariants("KTAT","translation"),this.addVariants("KTAR","rotation"),this.addVariants("KTAS","scale")}getTranslation(e,t,i,n){return this.getVectorValue(e,"KTAT",t,i,n,Le)}getRotation(e,t,i,n){return this.getQuatValue(e,"KTAR",t,i,n,xt)}getScale(e,t,i,n){return this.getVectorValue(e,"KTAS",t,i,n,Tt)}}function vr(s,e){return s===de.Blend?[e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA]:s===de.Additive?[e.SRC_ALPHA,e.ONE]:s===de.AddAlpha?[e.SRC_ALPHA,e.ONE]:s===de.Modulate?[e.ZERO,e.SRC_COLOR]:s===de.Modulate2x?[e.DST_COLOR,e.SRC_COLOR]:[0,0]}function nn(s,e){return s===Re.Blend?[e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA]:s===Re.Additive?[e.SRC_ALPHA,e.ONE]:s===Re.Modulate?[e.ZERO,e.SRC_COLOR]:s===Re.Modulate2x?[e.DST_COLOR,e.SRC_COLOR]:s===Re.AlphaKey?[e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA]:[0,0]}class br extends Ye{index;priorityPlane;filterMode;textureId=0;coordId;alpha;unshaded;sphereEnvironmentMap;twoSided;unfogged;noDepthTest;noDepthSet;depthMaskValue;blendSrc=0;blendDst=0;blended=!1;textureAnimation=null;constructor(e,t,i,n){super(e,t);let r=t.filterMode;const o=t.textureAnimationId,a=e.viewer.gl;this.index=i,this.priorityPlane=n,r>de.Modulate2x&&(r=de.Blend),this.filterMode=r,t.textureId!==-1&&(this.textureId=t.textureId),this.coordId=t.coordId,this.alpha=t.alpha;const l=t.flags;if(this.unshaded=l&Ee.Unshaded,this.sphereEnvironmentMap=l&Ee.SphereEnvMap,this.twoSided=l&Ee.TwoSided,this.unfogged=l&Ee.Unfogged,this.noDepthTest=l&Ee.NoDepthTest,this.noDepthSet=l&Ee.NoDepthSet,this.depthMaskValue=r===de.None||r===de.Transparent,r>de.Transparent&&(this.blended=!0,[this.blendSrc,this.blendDst]=vr(r,a)),o!==-1){const c=e.textureAnimations[o];c&&(this.textureAnimation=c)}this.addVariants("KMTA","alpha"),this.addVariants("KMTF","textureId")}bind(e){const t=this.model.viewer.gl;t.uniform1f(e.uniforms.u_filterMode,this.filterMode),this.blended?(t.enable(t.BLEND),t.blendFunc(this.blendSrc,this.blendDst)):t.disable(t.BLEND),this.twoSided?t.disable(t.CULL_FACE):t.enable(t.CULL_FACE),this.noDepthTest?t.disable(t.DEPTH_TEST):t.enable(t.DEPTH_TEST),this.noDepthSet?t.depthMask(!1):t.depthMask(this.depthMaskValue)}getAlpha(e,t,i,n){return this.getScalarValue(e,"KMTA",t,i,n,this.alpha)}getTextureId(e,t,i,n){return this.getScalarValue(e,"KMTF",t,i,n,this.textureId)}}class mr{model;shader;layers;constructor(e,t,i){this.model=e,this.shader=t,this.layers=i}}class gr extends Ye{alpha;color;geosetId;constructor(e,t){super(e,t);const i=t.color;this.alpha=t.alpha,this.color=d.vec3.fromValues(i[2],i[1],i[0]),this.geosetId=t.geosetId,this.addVariants("KGAO","alpha"),this.addVariants("KGAC","color")}getAlpha(e,t,i,n){return this.getScalarValue(e,"KGAO",t,i,n,this.alpha)}getColor(e,t,i,n){return this.getVectorValue(e,"KGAC",t,i,n,this.color)}}const sn={1:"TeamColor/TeamColor00",2:"TeamGlow/TeamGlow00",11:"Cliff/Cliff0",21:"",31:"LordaeronTree/LordaeronSummerTree",32:"AshenvaleTree/AshenTree",33:"BarrensTree/BarrensTree",34:"NorthrendTree/NorthTree",35:"Mushroom/MushroomTree",36:"RuinsTree/RuinsTree",37:"OutlandMushroomTree/MushroomTree"};class pe extends Ye{index;name;objectId;parentId;pivot;dontInheritTranslation;dontInheritRotation;dontInheritScaling;billboarded;billboardedX;billboardedY;billboardedZ;cameraAnchored;anyBillboarding;constructor(e,t,i){super(e,t),this.index=i,this.name=t.name,this.objectId=t.objectId,this.parentId=t.parentId,this.pivot=e.pivotPoints[t.objectId]||d.vec3.create();const n=t.flags;this.dontInheritTranslation=(n&we.DontInheritTranslation)>0,this.dontInheritRotation=(n&we.DontInheritRotation)>0,this.dontInheritScaling=(n&we.DontInheritScaling)>0,this.billboarded=(n&we.Billboarded)>0,this.billboardedX=(n&we.BillboardedLockX)>0,this.billboardedY=(n&we.BillboardedLockY)>0,this.billboardedZ=(n&we.BillboardedLockZ)>0,this.cameraAnchored=(n&we.CameraAnchored)>0,this.anyBillboarding=this.billboarded||this.billboardedX||this.billboardedY||this.billboardedZ,t.objectId===t.parentId&&(this.parentId=-1),this.addVariants("KGTR","translation"),this.addVariants("KGRT","rotation"),this.addVariants("KGSC","scale"),this.addVariantIntersection(["translation","rotation","scale"],"generic")}getVisibility(e,t,i,n){return e[0]=1,-1}getTranslation(e,t,i,n){return this.getVectorValue(e,"KGTR",t,i,n,Le)}getRotation(e,t,i,n){return this.getQuatValue(e,"KGRT",t,i,n,xt)}getScale(e,t,i,n){return this.getVectorValue(e,"KGSC",t,i,n,Tt)}}class wr extends pe{geosetAnimation;constructor(e,t,i){super(e,t,i),this.geosetAnimation=e.geosetAnimations[t.geosetAnimationId]}getVisibility(e,t,i,n){return this.geosetAnimation?this.geosetAnimation.getAlpha(e,t,i,n):(e[0]=1,-1)}}class yr extends pe{type;attenuation;color;intensity;ambientColor;ambientIntensity;constructor(e,t,i){super(e,t,i),this.type=t.type,this.attenuation=t.attenuation,this.color=t.color,this.intensity=t.intensity,this.ambientColor=t.ambientColor,this.ambientIntensity=t.ambientIntensity}getAttenuationStart(e,t,i,n){return this.getScalarValue(e,"KLAS",t,i,n,this.attenuation[0])}getAttenuationEnd(e,t,i,n){return this.getScalarValue(e,"KLAE",t,i,n,this.attenuation[1])}getIntensity(e,t,i,n){return this.getScalarValue(e,"KLAI",t,i,n,this.intensity)}getColor(e,t,i,n){return this.getVectorValue(e,"KLAC",t,i,n,this.color)}getAmbientIntensity(e,t,i,n){return this.getScalarValue(e,"KLBI",t,i,n,this.ambientIntensity)}getAmbientColor(e,t,i,n){return this.getVectorValue(e,"KLBC",t,i,n,this.ambientColor)}}class Ar extends pe{}class Tr extends pe{path;attachmentId;internalModel=null;constructor(e,t,i){super(e,t,i);const n=t.path.replace(/\\/g,"/").toLowerCase().replace(".mdl",".mdx");if(this.path=n,this.attachmentId=t.attachmentId,n!==""&&n.indexOf(".mdx")!=-1){const r=e.viewer.load(n,e.pathSolver,e.solverParams);r.then(o=>{o&&(this.internalModel=o)}),e.blockers.push(r)}}getVisibility(e,t,i,n){return this.getScalarValue(e,"KATV",t,i,n,1)}}class xr extends pe{internalModel=null;speed;latitude;longitude;lifeSpan;gravity;emissionRate;ok=!1;constructor(e,t,i){super(e,t,i),this.speed=t.speed,this.latitude=t.latitude,this.longitude=t.longitude,this.lifeSpan=t.lifeSpan,this.gravity=t.gravity,this.emissionRate=t.emissionRate,e.viewer.load(t.path.replace(/\\/g,"/").toLowerCase().replace(".mdl",".mdx"),e.pathSolver,e.solverParams).then(n=>{n&&(this.internalModel=n,this.ok=!0)})}getSpeed(e,t,i,n){return this.getScalarValue(e,"KPES",t,i,n,this.speed)}getLatitude(e,t,i,n){return this.getScalarValue(e,"KPLTV",t,i,n,this.latitude)}getLongitude(e,t,i,n){return this.getScalarValue(e,"KPLN",t,i,n,this.longitude)}getLifeSpan(e,t,i,n){return this.getScalarValue(e,"KPEL",t,i,n,this.lifeSpan)}getGravity(e,t,i,n){return this.getScalarValue(e,"KPEG",t,i,n,this.gravity)}getEmissionRate(e,t,i,n){return this.getScalarValue(e,"KPEE",t,i,n,this.emissionRate)}getVisibility(e,t,i,n){return this.getScalarValue(e,"KPEV",t,i,n,1)}}const Er=d.vec3.create(),Sr=d.vec3.create(),_r=d.vec3.create(),ce=60,Ut=ce>>2,rn=0,Ir=12,Lr=24,Cr=36,on=48,an=52,ln=56,Vt=57,Mt=rn>>2,cn=on>>2,Rr=Vt,hn=0,Dt=1,dn=2,Br=3,un=1e3,Nt=1e4,fn=2;function Pr(s,e){const t=s.instance,i=s.objects,n=e.byteView,r=e.floatView,o=s.emitterObject,a=o.modelSpace,l=o.tailLength,c=s.node,u=t.teamColor;let h=0;for(const v of i){const f=h*ce,p=h*Ut,b=p+Mt;let g=v.location;const m=v.scale,w=v.tail;if(w===Be.Head)a&&(g=d.vec3.transformMat4(Er,g,c.worldMatrix)),r[b+0]=g[0],r[b+1]=g[1],r[b+2]=g[2],r[b+3]=v.facing;else{const I=v.velocity;let T=Sr,A=g;T[0]=A[0]-l*I[0],T[1]=A[1]-l*I[1],T[2]=A[2]-l*I[2],a&&(T=d.vec3.transformMat4(T,T,c.worldMatrix),A=d.vec3.transformMat4(_r,A,c.worldMatrix)),r[b+0]=T[0],r[b+1]=T[1],r[b+2]=T[2],r[b+3]=A[0],r[b+4]=A[1],r[b+5]=A[2]}r[b+6]=m[0],r[b+7]=m[0],r[b+8]=m[0],r[p+cn]=v.health,n[f+ln]=w,n[f+Rr]=u,h+=1}}function Fr(s,e){const t=s.instance,i=t.textureOverrides,r=t.scene.camera,o=s.emitterObject,a=o.model,l=a.viewer,c=l.gl,u=l.sharedCache.get("mdx"),h=e.uniforms,v=o.colors,f=o.intervals,p=o.replaceableId;let b,g=o.internalTexture;c.blendFunc(o.blendSrc,o.blendDst),c.uniform1f(h.u_filterMode,o.filterMode),o.internalTexture?g=o.internalTexture:p===1?g=u.teamColors[t.teamColor]:p===2?g=u.teamGlows[t.teamColor]:g=a.textures[o.textureId];let m=i.get(un+o.index);m||(p===0&&(m=i.get(o.textureId)),m||(m=g.texture)),l.webgl.bindTextureAndWrap(m,0,g.wrapS,g.wrapT),o.xYQuad?b=r.vectors:b=r.billboardedVectors,c.uniform1f(h.u_lifeSpan,o.lifeSpan),c.uniform1f(h.u_timeMiddle,o.timeMiddle),c.uniform1f(h.u_columns,o.columns),c.uniform1f(h.u_rows,o.rows),c.uniform1f(h.u_teamColored,o.teamColored),c.uniform3fv(h["u_intervals[0]"],f[0]),c.uniform3fv(h["u_intervals[1]"],f[1]),c.uniform3fv(h["u_intervals[2]"],f[2]),c.uniform3fv(h["u_intervals[3]"],f[3]),c.uniform4fv(h["u_colors[0]"],v[0]),c.uniform4fv(h["u_colors[1]"],v[1]),c.uniform4fv(h["u_colors[2]"],v[2]),c.uniform3fv(h.u_scaling,o.scaling),o.head&&(c.uniform3fv(h["u_vertices[0]"],b[0]),c.uniform3fv(h["u_vertices[1]"],b[1]),c.uniform3fv(h["u_vertices[2]"],b[2]),c.uniform3fv(h["u_vertices[3]"],b[3])),o.tail&&c.uniform3fv(h.u_cameraZ,r.directionZ)}function kr(s,e){let t=s.first;const i=e.byteView,n=e.floatView,o=s.emitterObject.columns,l=1/(s.alive-1);let c=0;for(;t.next;){const u=t.next.vertices,h=c*ce,f=c*Ut+Mt,p=h+an,b=h+Vt,g=(t.slot%o+(1-c*l-l))/o,m=t.slot/o,w=g+l,I=t.vertices,T=t.color;n[f+0]=I[0],n[f+1]=I[1],n[f+2]=I[2],n[f+3]=I[3],n[f+4]=I[4],n[f+5]=I[5],n[f+6]=u[3],n[f+7]=u[4],n[f+8]=u[5],n[f+9]=u[0],n[f+10]=u[1],n[f+11]=u[2],i[p+0]=T[0],i[p+1]=T[1],i[p+2]=T[2],i[p+3]=T[3],i[b+0]=g*255,i[b+1]=w*255,i[b+2]=m*255,t=t.next,c+=1}}function Or(s,e){const t=s.instance.textureOverrides,i=s.emitterObject,n=i.layer,r=i.model,o=r.viewer.gl,a=e.uniforms,l=r.textures[n.textureId],c=t.get(n.textureId)||l.texture;n.bind(e),o.uniform1f(a.u_filterMode,n.filterMode),r.viewer.webgl.bindTextureAndWrap(c,0,l.wrapS,l.wrapT),o.uniform1f(a.u_columns,i.columns),o.uniform1f(a.u_rows,i.rows)}function pn(s,e){const t=s.objects,i=e.floatView;let n=0;for(const r of t){const o=n*Ut,a=o+Mt,l=r.vertices;i[a+0]=l[0],i[a+1]=l[1],i[a+2]=l[2],i[a+3]=l[3],i[a+4]=l[4],i[a+5]=l[5],i[a+6]=l[6],i[a+7]=l[7],i[a+8]=l[8],i[a+9]=l[9],i[a+10]=l[10],i[a+11]=l[11],i[o+cn]=r.health,n+=1}}function Ur(s,e){const t=s.instance.textureOverrides,i=s.emitterObject,n=i.intervalTimes,r=i.intervals,o=i.colors,a=i.model,l=a.viewer.gl,c=e.uniforms,u=i.internalTexture,h=t.get(Nt+i.index)||u.texture;l.blendFunc(i.blendSrc,i.blendDst),a.viewer.webgl.bindTextureAndWrap(h,0,u.wrapS,u.wrapT),l.uniform1f(c.u_lifeSpan,i.lifeSpan),l.uniform1f(c.u_columns,i.columns),l.uniform1f(c.u_rows,i.rows),l.uniform3f(c.u_intervalTimes,n[0],n[1],0),l.uniform3fv(c["u_intervals[0]"],r[0]),l.uniform3fv(c["u_intervals[1]"],r[1]),l.uniform4fv(c["u_colors[0]"],o[0]),l.uniform4fv(c["u_colors[1]"],o[1]),l.uniform4fv(c["u_colors[2]"],o[2])}function Vr(s,e){const t=s.instance.textureOverrides,i=s.emitterObject,n=i.intervalTimes,r=i.colors,o=i.model,l=o.viewer.gl,c=e.uniforms,u=i.internalTexture,h=t.get(Nt+i.index)||u.texture;l.blendFunc(i.blendSrc,i.blendDst),o.viewer.webgl.bindTextureAndWrap(h,0,u.wrapS,u.wrapT),l.uniform1f(c.u_lifeSpan,i.lifeSpan),l.uniform1f(c.u_columns,i.columns),l.uniform1f(c.u_rows,i.rows),l.uniform3fv(c.u_intervalTimes,n),l.uniform4fv(c["u_colors[0]"],r[0]),l.uniform4fv(c["u_colors[1]"],r[1]),l.uniform4fv(c["u_colors[2]"],r[2])}function Mr(s,e){let t=s.alive;const n=s.emitterObject.geometryEmitterType;if(n===Dt&&(t-=1),t>0){const r=s.instance.model.viewer,o=r.buffer,a=r.gl,l=r.webgl.extensions.ANGLE_instanced_arrays,c=t*ce,u=e.attribs;o.reserve(c),n===hn?(Pr(s,o),Fr(s,e)):n===Dt?(kr(s,o),Or(s,e)):n===dn?(pn(s,o),Ur(s,e)):(pn(s,o),Vr(s,e)),o.bindAndUpdate(c),a.uniform1i(e.uniforms.u_emitter,n),a.vertexAttribPointer(u.a_p0,3,a.FLOAT,!1,ce,rn),a.vertexAttribPointer(u.a_p1,3,a.FLOAT,!1,ce,Ir),a.vertexAttribPointer(u.a_p2,3,a.FLOAT,!1,ce,Lr),a.vertexAttribPointer(u.a_p3,3,a.FLOAT,!1,ce,Cr),a.vertexAttribPointer(u.a_health,1,a.FLOAT,!1,ce,on),a.vertexAttribPointer(u.a_color,4,a.UNSIGNED_BYTE,!0,ce,an),a.vertexAttribPointer(u.a_tail,1,a.UNSIGNED_BYTE,!1,ce,ln),a.vertexAttribPointer(u.a_leftRightTop,3,a.UNSIGNED_BYTE,!1,ce,Vt),l.drawArraysInstancedANGLE(a.TRIANGLES,0,6,t)}}class We{texture=null;replaceableId;wrapS=33071;wrapT=33071;constructor(e,t){this.replaceableId=e,t&Se.WrapWidth&&(this.wrapS=10497),t&Se.WrapHeight&&(this.wrapT=10497)}}class vn extends pe{geometryEmitterType=hn;width;length;speed;latitude;gravity;emissionRate;squirt;lifeSpan;variation;tailLength;timeMiddle;columns;rows;teamColored=0;internalTexture=null;replaceableId;textureId;head;tail;cellWidth;cellHeight;colors=[];scaling;intervals;filterMode;blendSrc;blendDst;priorityPlane;lineEmitter;unfogged;modelSpace;xYQuad;ok=!0;constructor(e,t,i){super(e,t,i),this.width=t.width,this.length=t.length,this.speed=t.speed,this.latitude=t.latitude,this.gravity=t.gravity,this.emissionRate=t.emissionRate*fn,this.squirt=t.squirt,this.lifeSpan=t.lifeSpan,this.variation=t.variation,this.tailLength=t.tailLength,this.timeMiddle=t.timeMiddle;const n=t.flags;this.lineEmitter=n&He.LineEmitter,this.unfogged=n&He.Unfogged,this.modelSpace=n&He.ModelSpace,this.xYQuad=n&He.XYQuad;const r=t.replaceableId;if(this.columns=t.columns,this.rows=t.rows,r===1||r===2)this.teamColored=1;else if(r>2){const v=e.reforged?".dds":".blp";this.internalTexture=new We(r,Se.RepeatBoth),e.viewer.load(`ReplaceableTextures\\${sn[r]}${v}`,e.pathSolver,e.solverParams).then(f=>{f&&(this.internalTexture.texture=f)})}this.replaceableId=t.replaceableId,this.textureId=t.textureId;const o=t.headOrTail;this.head=o===Be.Head||o===Be.Both,this.tail=o===Be.Tail||o===Be.Both,this.cellWidth=1/t.columns,this.cellHeight=1/t.rows;const a=t.segmentColors,l=t.segmentAlphas;for(let v=0;v<3;v++){const f=a[v];this.colors[v]=new Float32Array([f[0],f[1],f[2],l[v]/255])}this.scaling=t.segmentScaling;const c=t.headIntervals,u=t.tailIntervals;this.intervals=[new Float32Array(c[0]),new Float32Array(c[1]),new Float32Array(u[0]),new Float32Array(u[1])];const h=nn(t.filterMode,this.model.viewer.gl);this.filterMode=t.filterMode,this.blendSrc=h[0],this.blendDst=h[1],this.priorityPlane=t.priorityPlane}getWidth(e,t,i,n){return this.getScalarValue(e,"KP2N",t,i,n,this.width)}getLength(e,t,i,n){return this.getScalarValue(e,"KP2W",t,i,n,this.length)}getSpeed(e,t,i,n){return this.getScalarValue(e,"KP2S",t,i,n,this.speed)}getLatitude(e,t,i,n){return this.getScalarValue(e,"KP2L",t,i,n,this.latitude)}getGravity(e,t,i,n){return this.getScalarValue(e,"KP2G",t,i,n,this.gravity)}getEmissionRate(e,t,i,n){return this.getScalarValue(e,"KP2E",t,i,n,this.emissionRate)}getVariation(e,t,i,n){return this.getScalarValue(e,"KP2R",t,i,n,this.variation)}getVisibility(e,t,i,n){return this.getScalarValue(e,"KP2V",t,i,n,1)}}class bn extends pe{geometryEmitterType=Dt;layer;heightAbove;heightBelow;alpha;color;lifeSpan;textureSlot;emissionRate;gravity;columns;rows;ok=!0;constructor(e,t,i){super(e,t,i),this.layer=e.materials[t.materialId].layers[0],this.heightAbove=t.heightAbove,this.heightBelow=t.heightBelow,this.alpha=t.alpha,this.color=t.color,this.lifeSpan=t.lifeSpan,this.textureSlot=t.textureSlot,this.emissionRate=t.emissionRate*fn,this.gravity=t.gravity,this.columns=t.columns,this.rows=t.rows}getHeightBelow(e,t,i,n){return this.getScalarValue(e,"KRHB",t,i,n,this.heightBelow)}getHeightAbove(e,t,i,n){return this.getScalarValue(e,"KRHA",t,i,n,this.heightAbove)}getTextureSlot(e,t,i,n){return this.getScalarValue(e,"KRTX",t,i,n,0)}getColor(e,t,i,n){return this.getVectorValue(e,"KRCO",t,i,n,this.color)}getAlpha(e,t,i,n){return this.getScalarValue(e,"KRAL",t,i,n,this.alpha)}getVisibility(e,t,i,n){const r=this.getAlpha(e,t,i,n);return e[0]===0?r:this.getScalarValue(e,"KRVS",t,i,n,1)}}class Dr extends Ye{name;position;fieldOfView;farClippingPlane;nearClippingPlane;targetPosition;constructor(e,t){super(e,t),this.name=t.name,this.position=t.position,this.fieldOfView=t.fieldOfView,this.farClippingPlane=t.farClippingPlane,this.nearClippingPlane=t.nearClippingPlane,this.targetPosition=t.targetPosition}getTranslation(e,t,i,n){return this.getVectorValue(e,"KCTR",t,i,n,Le)}getTargetTranslation(e,t,i,n){return this.getVectorValue(e,"KTTR",t,i,n,Le)}getRotation(e,t,i,n){return this.getScalarValue(e,"KCRL",t,i,n,0)}}class Nr extends pe{geometryEmitterType=-1;type;id;tracks;globalSequence=-1;defval=new Uint32Array(1);internalModel=null;internalTexture=null;colors=[];intervalTimes=new Float32Array(3);scale=0;columns=0;rows=0;lifeSpan=0;blendSrc=0;blendDst=0;intervals=[];distanceCutoff=0;maxDistance=0;minDistance=0;pitch=0;pitchVariance=0;volume=0;decodedBuffers=[];ok=!1;constructor(e,t,i){super(e,t,i);const n=e.viewer,r=t.name;let o=r.substring(0,3);const a=r.substring(4);o==="FPT"&&(o="SPL"),o==="SPL"?this.geometryEmitterType=dn:o==="UBR"&&(this.geometryEmitterType=Br),this.type=o,this.id=a,this.tracks=t.tracks;const l=t.globalSequenceId;if(l!==-1&&(this.globalSequence=e.globalSequences[l]),o==="SND"&&!n.audioEnabled)return;const c=n.promise();gt.getEventObjectData(n,o,a,e.hd).then(u=>{if(c(),u){const{row:h,resources:v}=u;if(this.ok=!0,o==="SPN")this.internalModel=v[0];else if(o==="SPL"||o==="UBR"){this.internalTexture=new We(0,Se.WrapBoth),this.internalTexture.texture=v[0],this.scale=h.number("Scale"),this.colors[0]=new Float32Array([h.number("StartR"),h.number("StartG"),h.number("StartB"),h.number("StartA")]),this.colors[1]=new Float32Array([h.number("MiddleR"),h.number("MiddleG"),h.number("MiddleB"),h.number("MiddleA")]),this.colors[2]=new Float32Array([h.number("EndR"),h.number("EndG"),h.number("EndB"),h.number("EndA")]),o==="SPL"?(this.columns=h.number("Columns"),this.rows=h.number("Rows"),this.lifeSpan=h.number("Lifespan")+h.number("Decay"),this.intervalTimes[0]=h.number("Lifespan"),this.intervalTimes[1]=h.number("Decay"),this.intervals[0]=new Float32Array([h.number("UVLifespanStart"),h.number("UVLifespanEnd"),h.number("LifespanRepeat")]),this.intervals[1]=new Float32Array([h.number("UVDecayStart"),h.number("UVDecayEnd"),h.number("DecayRepeat")])):(this.columns=1,this.rows=1,this.lifeSpan=h.number("BirthTime")+h.number("PauseTime")+h.number("Decay"),this.intervalTimes[0]=h.number("BirthTime"),this.intervalTimes[1]=h.number("PauseTime"),this.intervalTimes[2]=h.number("Decay"));const f=nn(h.number("BlendMode"),n.gl);this.blendSrc=f[0],this.blendDst=f[1]}else{this.distanceCutoff=h.number("DistanceCutoff"),this.maxDistance=h.number("MaxDistance"),this.minDistance=h.number("MinDistance"),this.pitch=h.number("Pitch"),this.pitchVariance=h.number("PitchVariance"),this.volume=h.number("Volume");for(const f of v)this.decodedBuffers.push(f.data)}}})}getValue(e,t){if(this.globalSequence!==-1){const i=this.globalSequence;return this.getValueAtTime(e,t.counter%i,0,i)}else if(t.sequence!==-1){const i=this.model.sequences[t.sequence].interval;return this.getValueAtTime(e,t.frame,i[0],i[1])}else return e[0]=this.defval[0],-1}getValueAtTime(e,t,i,n){const r=this.tracks;if(t>=i&&t<=n)for(let o=r.length-1;o>-1;o--){if(r[o]<i)return e[0]=0,o;if(r[o]<=t)return e[0]=1,o}return e[0]=0,-1}}class Gr extends pe{type;vertices;boundsRadius;constructor(e,t,i){super(e,t,i),this.type=t.type,this.vertices=t.vertices,this.boundsRadius=t.boundsRadius}}var W=(s=>(s[s.VertexGroups=0]="VertexGroups",s[s.ExtendedVertexGroups=1]="ExtendedVertexGroups",s[s.Skin=2]="Skin",s))(W||{});class Oe{index;geoset;layer;material;skinningType;isHd;constructor(e,t,i,n,r){let o,a;r?(o=i,a=o.layers[0]):(o=null,a=i),this.index=e,this.geoset=t,this.skinningType=n,this.isHd=r,this.layer=a,this.material=o}}class jr{model;index;positionOffset;normalOffset;uvOffset;tangentOffset;skinOffset;faceOffset;vertices;elements;faceType;geosetAnimation=null;constructor(e,t,i,n,r,o,a,l,c,u,h){this.model=e,this.index=t,this.positionOffset=i,this.normalOffset=n,this.uvOffset=r,this.tangentOffset=o,this.skinOffset=a,this.faceOffset=l,this.vertices=c,this.elements=u,this.faceType=h;for(const v of e.geosetAnimations)v.geosetId===t&&(this.geosetAnimation=v)}bindShared(e,t,i){e.vertexAttribPointer(t.a_position,3,e.FLOAT,!1,0,this.positionOffset),e.vertexAttribPointer(t.a_normal,3,e.FLOAT,!1,0,this.normalOffset),e.vertexAttribPointer(t.a_uv,2,e.FLOAT,!1,0,this.uvOffset+i*this.vertices*8)}bindVertexGroups(e,t){const i=this.model,n=i.skinDataType,r=i.bytesPerSkinElement;e.vertexAttribPointer(t.a_bones,4,n,!1,5*r,this.skinOffset),e.vertexAttribPointer(t.a_boneNumber,1,n,!1,5*r,this.skinOffset+4*r)}bindVertexGroupsExtended(e,t){const i=this.model,n=i.skinDataType,r=i.bytesPerSkinElement;e.vertexAttribPointer(t.a_bones,4,n,!1,9*r,this.skinOffset),e.vertexAttribPointer(t.a_extendedBones,4,n,!1,9*r,this.skinOffset+4*r),e.vertexAttribPointer(t.a_boneNumber,1,n,!1,9*r,this.skinOffset+8*r)}bindSkin(e,t){e.vertexAttribPointer(t.a_bones,4,e.UNSIGNED_BYTE,!1,8,this.skinOffset),e.vertexAttribPointer(t.a_weights,4,e.UNSIGNED_BYTE,!0,8,this.skinOffset+4)}bind(e,t){const i=this.model.viewer.gl,n=e.attribs;this.bindShared(i,n,t),n.a_weights!==void 0?this.bindSkin(i,n):this.bindVertexGroups(i,n)}bindExtended(e,t){const i=this.model.viewer.gl,n=e.attribs;this.bindShared(i,n,t),this.bindVertexGroupsExtended(i,n)}bindHd(e,t,i){const n=this.model.viewer.gl,r=e.attribs;this.bindShared(n,r,i),n.vertexAttribPointer(r.a_tangent,4,n.FLOAT,!1,0,this.tangentOffset),t===W.Skin?this.bindSkin(n,r):t===W.ExtendedVertexGroups?this.bindVertexGroupsExtended(n,r):this.bindVertexGroups(n,r)}render(){const e=this.model.viewer.gl;e.drawElements(this.faceType,this.elements,e.UNSIGNED_SHORT,this.faceOffset)}}function Kr(s,e){if(e.length>0){const t=s.viewer.gl;let i=0,n=0,r=0,o=0,a=0,l=0;const c=[];for(let w=0,I=e.length;w<I;w++){const T=e[w];if(T.lod===0||T.lod===-1){const A=T.vertices.length/3;if(i+=A*12,n+=A*12,r+=T.uvSets.length*A*8,T.tangents.length&&(o+=A*16),T.skin.length)a+=A*8,c[w]=W.Skin;else{let y=0;for(const O of T.matrixGroups)O>y&&(y=O);y>4?(a+=A*9,c[w]=W.ExtendedVertexGroups):(a+=A*5,c[w]=W.VertexGroups)}l+=T.faces.byteLength}}let u=0,h=u+i,v=h+n,f=v+r,p=f+o,b=0,g=Uint8Array,m=t.UNSIGNED_BYTE;s.bones.length>255&&(a*=2,g=Uint16Array,m=t.UNSIGNED_SHORT),s.skinDataType=m,s.bytesPerSkinElement=g.BYTES_PER_ELEMENT,s.arrayBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,s.arrayBuffer),t.bufferData(t.ARRAY_BUFFER,p+a,t.STATIC_DRAW),s.elementBuffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,s.elementBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,l,t.STATIC_DRAW);for(let w=0,I=e.length;w<I;w++){const T=e[w];if(T.lod===0||T.lod===-1){const A=T.vertices,y=T.normals,O=T.uvSets,V=T.tangents,K=T.faces;let G;const ne=T.vertices.length/3,B=c[w];if(B===W.Skin)G=T.skin;else{const N=T.matrixIndices,_=T.vertexGroups,F=[];let U=0,k=4;B===W.ExtendedVertexGroups&&(k=8),G=new g(ne*(k+1));for(const X of T.matrixGroups)F.push(N.subarray(U,U+X)),U+=X;for(let X=0;X<ne;X++){const he=F[_[X]];if(U=X*(k+1),he){const ue=Math.min(he.length,k);for(let S=0;S<ue;S++)G[U+S]=he[S]+1;G[U+k]=ue}}}const H=new jr(s,s.geosets.length,u,h,v,f,p,b,ne,K.length,T.faceTypeGroups[0]);s.geosets.push(H);const M=s.materials[T.materialId];if(M.shader==="Shader_HD_DefaultUnit")s.batches.push(new Oe(s.batches.length,H,M,B,!0));else for(const N of M.layers)s.batches.push(new Oe(s.batches.length,H,N,B,!1));t.bufferSubData(t.ARRAY_BUFFER,u,A),u+=A.byteLength,t.bufferSubData(t.ARRAY_BUFFER,h,y),h+=y.byteLength;for(const N of O)t.bufferSubData(t.ARRAY_BUFFER,v,N),v+=N.byteLength;V.length&&(t.bufferSubData(t.ARRAY_BUFFER,f,V),f+=V.byteLength),t.bufferSubData(t.ARRAY_BUFFER,p,G),p+=G.byteLength,t.bufferSubData(t.ELEMENT_ARRAY_BUFFER,b,K),b+=K.byteLength}}}}class mn{model;skinningType;isHd;objects=[];constructor(e,t,i){this.model=e,this.skinningType=t,this.isHd=i}render(e){const t=e.scene,i=t.camera,n=e.textureOverrides,r=e.layerAlphas,o=this.model,a=o.textures,l=o.batches,c=o.viewer,u=c.sharedCache.get("mdx"),h=c.gl,v=c.webgl,f=this.skinningType,p=this.isHd,b=u.teamColors,g=u.teamGlows,m=gt.getBatchShader(c,f,p);m.use();const w=m.uniforms;h.uniformMatrix4fv(w.u_VP,!1,i.viewProjectionMatrix);const I=e.boneTexture;if(I?(I.bind(15),h.uniform1f(w.u_hasBones,1),h.uniform1i(w.u_boneMap,15),h.uniform1f(w.u_vectorSize,1/I.width),h.uniform1f(w.u_rowSize,1)):h.uniform1f(w.u_hasBones,0),h.uniform3fv(w.u_lightPos,t.lightPosition),h.bindBuffer(h.ARRAY_BUFFER,o.arrayBuffer),h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,o.elementBuffer),p){h.uniform1i(w.u_diffuseMap,0),h.uniform1i(w.u_normalsMap,1),h.uniform1i(w.u_ormMap,2),h.uniform1i(w.u_emissiveMap,3),h.uniform1i(w.u_teamColorMap,4),h.uniform1i(w.u_environmentMap,5),h.disable(h.BLEND),h.enable(h.DEPTH_TEST),h.depthMask(!0),h.uniformMatrix4fv(w.u_MV,!1,i.viewMatrix),h.uniform3fv(w.u_eyePos,i.location);for(const T of this.objects){const A=l[T],y=A.geoset,O=A.material,[V,K,G,ne,B,H]=O.layers,M=r[V.index];if(M>0){h.uniform1f(w.u_layerAlpha,M),h.uniform1f(w.u_filterMode,V.filterMode);const E=V.textureId,N=K.textureId,_=G.textureId,F=ne.textureId,U=B.textureId,k=H.textureId,X=a[E],he=a[N],ue=a[_],S=a[F];let C=a[U];const D=a[k];(C.replaceableId===0||C.replaceableId===1)&&(C=b[e.teamColor]);const ae=n.get(E)||X.texture,j=n.get(N)||he.texture,J=n.get(_)||ue.texture,ie=n.get(F)||S.texture,ee=n.get(U)||C.texture,Ze=n.get(k)||D.texture;v.bindTextureAndWrap(ae,0,X.wrapS,X.wrapT),v.bindTextureAndWrap(j,1,he.wrapS,he.wrapT),v.bindTextureAndWrap(J,2,ue.wrapS,ue.wrapT),v.bindTextureAndWrap(ie,3,S.wrapS,S.wrapT),v.bindTextureAndWrap(ee,4,C.wrapS,C.wrapT),v.bindTextureAndWrap(Ze,5,D.wrapS,D.wrapT),y.bindHd(m,A.skinningType,V.coordId),y.render()}}}else{const T=e.geosetColors,A=e.layerTextures,y=e.uvAnims;h.uniform4fv(w.u_vertexColor,e.vertexColor),h.uniform1i(w.u_texture,0);for(const O of this.objects){const V=l[O],K=V.geoset,G=V.layer,ne=K.index,B=G.index,H=T[ne],M=r[B];if(H[3]>.01&&M>.01){const E=A[B],N=a[E],_=y[B];h.uniform4fv(w.u_geosetColor,H),h.uniform1f(w.u_layerAlpha,M),h.uniform1f(w.u_unshaded,G.unshaded),h.uniform2f(w.u_uvTrans,_[0],_[1]),h.uniform2f(w.u_uvRot,_[2],_[3]),h.uniform1f(w.u_uvScale,_[4]),G.bind(m);let F=n.get(E);if(!F){const U=N.replaceableId;let k;U===1?k=b[e.teamColor]:U===2?k=g[e.teamColor]:k=N,k&&(F=k.texture)}v.bindTextureAndWrap(F,0,N.wrapS,N.wrapT),f===W.ExtendedVertexGroups?K.bindExtended(m,G.coordId):K.bind(m,G.coordId),K.render()}}}}}class qr{model;objects=[];constructor(e){this.model=e}render(e){const t=e.scene,i=e.nodes,r=e.model.viewer,o=r.gl,a=r.webgl.extensions.ANGLE_instanced_arrays,l=r.sharedCache.get("mdx"),c=l.particlesShader,u=c.uniforms,h=c.attribs,v=l.rectBuffer;o.depthMask(!1),o.enable(o.BLEND),o.disable(o.CULL_FACE),o.enable(o.DEPTH_TEST),c.use(),o.uniformMatrix4fv(u.u_VP,!1,t.camera.viewProjectionMatrix),o.uniform1i(u.u_texture,0),a.vertexAttribDivisorANGLE(h.a_position,0),o.bindBuffer(o.ARRAY_BUFFER,v),o.vertexAttribPointer(h.a_position,1,o.UNSIGNED_BYTE,!1,0,0),a.vertexAttribDivisorANGLE(h.a_p0,1),a.vertexAttribDivisorANGLE(h.a_p1,1),a.vertexAttribDivisorANGLE(h.a_p2,1),a.vertexAttribDivisorANGLE(h.a_p3,1),a.vertexAttribDivisorANGLE(h.a_health,1),a.vertexAttribDivisorANGLE(h.a_color,1),a.vertexAttribDivisorANGLE(h.a_tail,1),a.vertexAttribDivisorANGLE(h.a_leftRightTop,1);for(const f of this.objects)Mr(i[f].object,c);a.vertexAttribDivisorANGLE(h.a_leftRightTop,0),a.vertexAttribDivisorANGLE(h.a_tail,0),a.vertexAttribDivisorANGLE(h.a_color,0),a.vertexAttribDivisorANGLE(h.a_health,0),a.vertexAttribDivisorANGLE(h.a_p3,0),a.vertexAttribDivisorANGLE(h.a_p2,0),a.vertexAttribDivisorANGLE(h.a_p1,0),a.vertexAttribDivisorANGLE(h.a_p0,0)}}function gn(s){return s instanceof Oe||s instanceof bn?s.layer.priorityPlane:s instanceof vn?s.priorityPlane:0}function wn(s,e){return s instanceof mn?e instanceof Oe&&e.skinningType===s.skinningType&&e.isHd===s.isHd:e instanceof pe}function yn(s,e){return e instanceof Oe?new mn(s,e.skinningType,e.isHd):new qr(s)}function Hr(s){const e=[];let t=[];for(const a of s.batches)a.layer.filterMode<2?e.push(a):t.push(a);const i=s.opaqueGroups,n=s.translucentGroups;let r=null;for(const a of e)(!r||!wn(r,a))&&(r=yn(s,a),i.push(r)),r.objects.push(a.index);t=t.sort((a,l)=>a.layer.filterMode-l.layer.filterMode);const o=[...t,...s.eventObjects,...s.particleEmitters2,...s.ribbonEmitters].sort((a,l)=>gn(a)-gn(l));r=null;for(const a of o)(a instanceof Oe||a.geometryEmitterType!==-1)&&((!r||!wn(r,a))&&(r=yn(s,a),n.push(r)),r.objects.push(a.index))}class $r extends Yi{convertBasis(e){d.quat.rotateY(e,e,-Math.PI/2),d.quat.rotateX(e,e,-Math.PI/2)}}const An=new Float32Array(1);class Xr{instance;attachment;internalInstance;constructor(e,t){const n=t.internalModel.addInstance();n.setSequenceLoopMode(2),n.dontInheritScaling=!1,n.hide(),n.setParent(e.nodes[t.objectId]),this.instance=e,this.attachment=t,this.internalInstance=n}update(){const e=this.instance,t=this.internalInstance;e.scene&&e.sequence!==-1&&(this.attachment.getVisibility(An,e.sequence,e.frame,e.counter),An[0]>.1?(e.scene.addInstance(t),t.hidden()&&(t.show(),t.setSequence(0))):t.hide())}}class zr{instance;objects=[];alive=0;currentEmission=0;constructor(e){this.instance=e}update(e){this.updateEmission(e);const t=this.currentEmission;if(t>=1)for(let i=0;i<t;i+=1)this.emit()}clear(){const e=this.objects;for(let t=0,i=this.alive;t<i;t++){const n=e[t];n.health=0}this.currentEmission=0}emitObject(e){const t=this.objects;this.alive===t.length&&t.push(this.createObject());const i=t[this.alive];return i.index=this.alive,i.bind(e),this.alive+=1,this.currentEmission-=1,this.instance.scene.emittedObjectUpdater.add(i),i}kill(e){const t=this.objects;this.alive-=1;const i=t[this.alive];t[e.index]=i,t[this.alive]=e,i.index=e.index,e.index=-1}}class ft extends zr{emitterObject;constructor(e,t){super(e),this.emitterObject=t}update(e){this.emitterObject.ok&&super.update(e)}}class Ue{emitter;index=-1;health=0;constructor(e){this.emitter=e}}const Ie=d.quat.create(),Yr=d.vec3.create(),Gt=new Float32Array(1),Tn=new Float32Array(1),xn=new Float32Array(1),En=new Float32Array(1);class Wr extends Ue{internalInstance;velocity=d.vec3.create();gravity=0;constructor(e){super(e);const i=e.emitterObject.internalModel;this.internalInstance=i.addInstance()}bind(){const e=this.emitter,t=e.instance,i=t.sequence,n=t.frame,r=t.counter,o=t.scene,a=e.emitterObject,l=t.nodes[a.index],c=this.internalInstance,u=l.worldScale,h=this.velocity;a.getLatitude(Gt,i,n,r),a.getLifeSpan(Tn,i,n,r),a.getGravity(xn,i,n,r),a.getSpeed(En,i,n,r),this.health=Tn[0],this.gravity=xn[0]*u[2],d.quat.identity(Ie),d.quat.rotateZ(Ie,Ie,Te(-Math.PI,Math.PI)),d.quat.rotateY(Ie,Ie,Te(-Gt[0],Gt[0])),d.vec3.transformQuat(h,je,Ie),d.vec3.transformQuat(h,h,l.worldRotation),d.vec3.scale(h,h,En[0]),d.vec3.mul(h,h,u),c.setScene(o),c.setSequence(0),c.setTransformation(l.worldLocation,d.quat.setAxisAngle(Ie,je,Te(0,Math.PI*2)),l.worldScale),c.show()}update(e){const t=this.internalInstance;if(this.health-=e,this.health>0){const i=this.velocity;i[2]-=this.gravity*e,t.move(d.vec3.scale(Yr,i,e))}else t.hide()}}const Sn=new Float32Array(1);class Zr extends ft{updateEmission(e){const t=this.instance;t.allowParticleSpawn&&(this.emitterObject.getEmissionRate(Sn,t.sequence,t.frame,t.counter),this.currentEmission+=Sn[0]*e)}emit(){this.emitObject()}createObject(){return new Wr(this)}}const ve=d.quat.create(),_n=new Float32Array(1),In=new Float32Array(1),Ln=new Float32Array(1),Cn=new Float32Array(1),Rn=new Float32Array(1),Bn=new Float32Array(1);class Qr extends Ue{tail=0;gravity=0;location=d.vec3.create();velocity=d.vec3.create();scale=d.vec3.create();facing=0;bind(e){const t=this.emitter,i=t.instance,n=i.sequence,r=i.frame,o=i.counter,a=t.emitterObject;a.getWidth(_n,n,r,o),a.getLength(In,n,r,o),a.getLatitude(Ln,n,r,o),a.getVariation(Cn,n,r,o),a.getSpeed(Rn,n,r,o),a.getGravity(Bn,n,r,o);const l=t.node,c=l.pivot,u=l.worldScale,h=_n[0]*.5,v=In[0]*.5,f=Jn(Ln[0]),p=Cn[0],b=Rn[0],g=this.location,m=this.velocity;this.health=a.lifeSpan,this.tail=e,this.gravity=Bn[0]*u[2],d.vec3.copy(this.scale,u),g[0]=c[0]+Te(-h,h),g[1]=c[1]+Te(-v,v),g[2]=c[2],a.modelSpace||d.vec3.transformMat4(g,g,l.worldMatrix),d.quat.identity(ve),d.quat.rotateZ(ve,ve,Math.PI/2),d.quat.rotateY(ve,ve,Te(-f,f)),a.lineEmitter||d.quat.rotateX(ve,ve,Te(-f,f)),a.modelSpace||d.quat.mul(ve,l.worldRotation,ve),d.vec3.transformQuat(m,je,ve),d.vec3.scale(m,m,b*(1+Te(-p,p))),a.modelSpace||d.vec3.mul(m,m,u),a.xYQuad&&(this.facing=Math.atan2(m[1],m[0])-Math.PI+Math.PI/8)}update(e){if(this.health-=e,this.health>0){const t=this.location,i=this.velocity;i[2]-=this.gravity*e,t[0]+=i[0]*e,t[1]+=i[1]*e,t[2]+=i[2]*e}}}const jt=new Float32Array(1);class Jr extends ft{node;lastEmissionKey=-1;constructor(e,t){super(e,t),this.node=e.nodes[t.index]}updateEmission(e){const t=this.instance;if(t.allowParticleSpawn){const i=this.emitterObject,n=i.getEmissionRate(jt,t.sequence,t.frame,t.counter);i.squirt?(n!==this.lastEmissionKey&&(this.currentEmission+=jt[0]),this.lastEmissionKey=n):this.currentEmission+=jt[0]*e}}emit(){const e=this.emitterObject;e.head&&this.emitObject(0),e.tail&&this.emitObject(1)}createObject(){return new Qr(this)}}const be=d.vec3.create(),me=d.vec3.create(),pt=new Float32Array(3),Pn=new Float32Array(1),Fn=new Uint32Array(1);class eo extends Ue{vertices=new Float32Array(6);color=new Uint8Array(4);slot=0;prev=null;next=null;bind(){const e=this.emitter,t=e.instance,i=t.sequence,n=t.frame,r=t.counter,o=e.emitterObject,a=t.nodes[o.index],[l,c,u]=a.pivot,h=a.worldMatrix,v=this.vertices;this.health=e.emitterObject.lifeSpan,o.getHeightBelow(be,i,n,r),o.getHeightAbove(me,i,n,r),be[1]=c-be[0],be[0]=l,be[2]=u,me[1]=c+me[0],me[0]=l,me[2]=u,d.vec3.transformMat4(be,be,h),d.vec3.transformMat4(me,me,h),v[0]=me[0],v[1]=me[1],v[2]=me[2],v[3]=be[0],v[4]=be[1],v[5]=be[2]}update(e){if(this.health-=e,this.health>0){const t=this.emitter,i=t.instance,n=i.sequence,r=i.frame,o=i.counter,a=t.emitterObject,l=this.color,c=this.vertices,u=a.gravity*e*e;a.getColor(pt,n,r,o),a.getAlpha(Pn,n,r,o),a.getTextureSlot(Fn,n,r,o),c[1]-=u,c[4]-=u,l[0]=pt[0]*255,l[1]=pt[1]*255,l[2]=pt[2]*255,l[3]=Pn[0]*255,this.slot=Fn[0]}}}class to extends ft{first=null;last=null;updateEmission(e){if(this.instance.allowParticleSpawn){const i=this.emitterObject;this.currentEmission+=i.emissionRate*e}}emit(){const e=this.emitObject(),t=this.last;t?(t.next=e,e.prev=t):this.first=e,this.last=e}kill(e){super.kill(e);const t=e.prev,i=e.next;e===this.first&&(this.first=i),e===this.last&&(this.first=null,this.last=null),t&&(t.next=i),i&&(i.prev=t),e.prev=null,e.next=null}createObject(){return new eo(this)}}const kn=new Uint32Array(1);class vt extends ft{lastValue=0;updateEmission(e){const t=this.instance;if(t.allowParticleSpawn){this.emitterObject.getValue(kn,t);const n=kn[0];n===1&&n!==this.lastValue&&(this.currentEmission+=1),this.lastValue=n}}emit(){this.emitObject()}}class io extends Ue{internalInstance;constructor(e){super(e);const i=e.emitterObject.internalModel;this.internalInstance=i.addInstance()}bind(){const e=this.emitter,t=e.instance,i=t.scene,n=t.nodes[e.emitterObject.index],r=this.internalInstance;r.setScene(i),r.setSequence(0),r.setTransformation(n.worldLocation,n.worldRotation,n.worldScale),r.show(),this.health=1}update(e){const t=this.internalInstance,i=t.model;t.frame>=i.sequences[0].interval[1]&&(this.health=0,t.hide())}}class no extends vt{createObject(){return new io(this)}}const Q=d.vec3.create();class On extends Ue{vertices=new Float32Array(12);bind(){const e=this.emitter,t=e.instance,i=e.emitterObject,n=this.vertices,r=i.scale,{worldLocation:o,worldRotation:a}=t.nodes[i.index];this.health=i.lifeSpan,d.vec3.set(Q,r,r,0),d.vec3.transformQuat(Q,Q,a),d.vec3.add(n.subarray(0,2),Q,o),d.vec3.set(Q,-r,r,0),d.vec3.transformQuat(Q,Q,a),d.vec3.add(n.subarray(3,5),Q,o),d.vec3.set(Q,-r,-r,0),d.vec3.transformQuat(Q,Q,a),d.vec3.add(n.subarray(6,8),Q,o),d.vec3.set(Q,r,-r,0),d.vec3.transformQuat(Q,Q,a),d.vec3.add(n.subarray(9,11),Q,o)}update(e){this.health-=e}}class so extends vt{createObject(){return new On(this)}}class ro extends vt{createObject(){return new On(this)}}class oo extends Ue{bind(){const e=this.emitter,t=e.instance,i=t.model.viewer,n=t.scene;if(i.audioEnabled&&n.audioEnabled){const r=e.emitterObject,o=t.nodes[r.index],a=n.audioContext,l=r.decodedBuffers,c=a.createPanner(),u=a.createBufferSource(),h=o.worldLocation;c.positionX.value=h[0],c.positionY.value=h[1],c.positionZ.value=h[2],c.maxDistance=r.distanceCutoff,c.refDistance=r.minDistance,c.connect(a.destination),u.buffer=l[Math.random()*l.length|0],u.connect(c),u.start(0)}}update(e){}}class ao extends vt{createObject(){return new oo(this)}}const Un=new Float32Array(1),Kt=d.vec3.create(),qt=d.quat.create(),Vn=d.vec3.create(),bt=new Float32Array(3),mt=new Float32Array(1),Mn=new Uint32Array(1);class lo extends Zs{attachments=[];particleEmitters=[];particleEmitters2=[];ribbonEmitters=[];eventObjectEmitters=[];nodes=[];sortedNodes=[];frame=0;counter=0;sequence=-1;sequenceLoopMode=0;sequenceEnded=!1;teamColor=0;vertexColor=new Float32Array([1,1,1,1]);allowParticleSpawn=!1;forced=!0;geosetColors=[];layerAlphas=[];layerTextures=[];uvAnims=[];worldMatrices=null;boneTexture=null;constructor(e){super(e);for(let o=0,a=e.geosets.length;o<a;o++)this.geosetColors[o]=new Float32Array(4);for(let o=0,a=e.layers.length;o<a;o++)this.layerAlphas[o]=0,this.layerTextures[o]=0,this.uvAnims[o]=new Float32Array(5);const t=nr(e.genericObjects.length,$r),i=t.nodes;let n=0;this.nodes.push(...i),this.worldMatrices=t.worldMatrices;for(const o of e.bones)this.initNode(i,i[n++],o);for(const o of e.lights)this.initNode(i,i[n++],o);for(const o of e.helpers)this.initNode(i,i[n++],o);for(const o of e.attachments){let a;o.internalModel&&(a=new Xr(this,o),this.attachments.push(a)),this.initNode(i,i[n++],o,a)}for(const o of e.particleEmitters){const a=new Zr(this,o);this.particleEmitters.push(a),this.initNode(i,i[n++],o,a)}for(const o of e.particleEmitters2){const a=new Jr(this,o);this.particleEmitters2.push(a),this.initNode(i,i[n++],o,a)}for(const o of e.ribbonEmitters){const a=new to(this,o);this.ribbonEmitters.push(a),this.initNode(i,i[n++],o,a)}for(const o of e.eventObjects){const a=o.type;let l;a==="SPN"?l=new no(this,o):a==="SPL"?l=new so(this,o):a==="UBR"?l=new ro(this,o):l=new ao(this,o),this.eventObjectEmitters.push(l),this.initNode(i,i[n++],o,l)}for(const o of e.collisionShapes)this.initNode(i,i[n++],o);const r=e.hierarchy;for(let o=0,a=i.length;o<a;o++)this.sortedNodes[o]=i[r[o]];e.bones.length&&(this.boneTexture=new qi(e.viewer.gl,4,e.bones.length*4,1))}setTexture(e,t){this.overrideTexture(e,t)}setParticle2Texture(e,t){this.overrideTexture(un+e,t)}setEventTexture(e,t){this.overrideTexture(Nt+e,t)}clearEmittedObjects(){for(const e of this.particleEmitters)e.clear();for(const e of this.particleEmitters2)e.clear();for(const e of this.ribbonEmitters)e.clear();for(const e of this.eventObjectEmitters)e.clear()}initNode(e,t,i,n){d.vec3.copy(t.pivot,i.pivot),i.parentId===-1?t.parent=this:t.parent=e[i.parentId],t.dontInheritTranslation=i.dontInheritTranslation,t.dontInheritRotation=i.dontInheritRotation,t.dontInheritScaling=i.dontInheritScaling,i.billboarded?t.billboarded=!0:i.billboardedX?t.billboardedX=!0:i.billboardedY?t.billboardedY=!0:i.billboardedZ&&(t.billboardedZ=!0),n&&(t.object=n)}hide(){super.hide(),this.resetAttachments()}updateNodes(e,t){const i=this.sequence,n=this.frame,r=this.counter,o=this.sortedNodes,l=this.model.sortedGenericObjects;for(let c=0,u=o.length;c<u;c++){const h=l[c],v=o[c],f=v.parent;let p=t||f.wasDirty||h.anyBillboarding;const b=h.variants;(t||b.generic[i])&&(p=!0,(t||b.translation[i])&&h.getTranslation(v.localLocation,i,n,r),(t||b.rotation[i])&&h.getRotation(v.localRotation,i,n,r),(t||b.scale[i])&&h.getScale(v.localScale,i,n,r)),v.wasDirty=p,p&&v.recalculateTransformation(this),v.object&&(h.getVisibility(Un,i,n,r),Un[0]>0&&v.object.update(e));for(const g of v.children)p&&g.recalculateTransformation(),g.update(e)}}recalculateTransformation(){super.recalculateTransformation(),this.forced=!0}updateBatches(e){const t=this.sequence,i=this.frame,n=this.counter,r=this.model,o=r.geosets,a=r.layers,l=this.geosetColors,c=this.layerAlphas,u=this.layerTextures,h=this.uvAnims;for(let v=0,f=o.length;v<f;v++){const b=o[v].geosetAnimation,g=l[v];b?((e||b.variants.color[t])&&(b.getColor(bt,t,i,n),g[0]=bt[0],g[1]=bt[1],g[2]=bt[2]),(e||b.variants.alpha[t])&&(b.getAlpha(mt,t,i,n),g[3]=mt[0])):e&&(g[0]=1,g[1]=1,g[2]=1,g[3]=1)}for(let v=0,f=a.length;v<f;v++){const p=a[v],b=p.textureAnimation,g=h[v];(e||p.variants.alpha[t])&&(p.getAlpha(mt,t,i,n),c[v]=mt[0]),(e||p.variants.textureId[t])&&(p.getTextureId(Mn,t,i,n),u[v]=Mn[0]),b?((e||b.variants.translation[t])&&(b.getTranslation(Kt,t,i,n),g[0]=Kt[0],g[1]=Kt[1]),(e||b.variants.rotation[t])&&(b.getRotation(qt,t,i,n),g[2]=qt[2],g[3]=qt[3]),(e||b.variants.scale[t])&&(b.getScale(Vn,t,i,n),g[4]=Vn[0])):e&&(g[0]=0,g[1]=0,g[2]=0,g[3]=1,g[4]=1)}}updateBoneTexture(){this.boneTexture&&this.boneTexture.bindAndUpdate(this.worldMatrices)}renderOpaque(){const e=this.model;for(const t of e.opaqueGroups)t.render(this)}renderTranslucent(){const e=this.model;for(const t of e.translucentGroups)t.render(this)}updateAnimations(e){const t=this.model,i=this.sequence;if(i!==-1){const r=t.sequences[i],o=r.interval,a=e*1e3;this.frame+=a,this.counter+=a,this.allowParticleSpawn=!0,this.frame>=o[1]?(this.sequenceLoopMode===2||this.sequenceLoopMode===0&&r.nonLooping===0?(this.frame=o[0],this.resetEventEmitters()):(this.frame=o[1],this.counter-=a,this.allowParticleSpawn=!1),this.sequenceEnded=!0):this.sequenceEnded=!1}const n=this.forced;(i!==-1||n)&&(this.updateNodes(e,n),this.updateBoneTexture(),this.updateBatches(n)),this.forced=!1}setTeamColor(e){return this.teamColor=e,this}setVertexColor(e){return this.vertexColor.set(e),this}setSequence(e){const i=this.model.sequences;return this.sequence=e,e<0||e>i.length-1?(this.sequence=-1,this.frame=0,this.allowParticleSpawn=!1):this.frame=i[e].interval[0],this.resetEventEmitters(),this.resetAttachments(),this.forced=!0,this}getBounds(){const e=this.model;if(this.sequence===-1)return e.bounds;const t=e.sequences[this.sequence].bounds;return t.r===0?e.bounds:t}setSequenceLoopMode(e){return this.sequenceLoopMode=e,this}getAttachment(e){const i=this.model.attachments[e];if(i)return this.nodes[i.index]}resetEventEmitters(){for(const e of this.eventObjectEmitters)e.lastValue=0}resetAttachments(){for(const e of this.attachments)e.internalInstance.hide()}}class co extends Ws{reforged=!1;hd=!1;solverParams={};name="";sequences=[];globalSequences=[];materials=[];layers=[];textures=[];textureAnimations=[];geosets=[];geosetAnimations=[];bones=[];lights=[];helpers=[];attachments=[];pivotPoints=[];particleEmitters=[];particleEmitters2=[];ribbonEmitters=[];cameras=[];eventObjects=[];collisionShapes=[];hasLayerAnims=!1;hasGeosetAnims=!1;batches=[];genericObjects=[];sortedGenericObjects=[];hierarchy=[];opaqueGroups=[];translucentGroups=[];arrayBuffer=null;elementBuffer=null;skinDataType=0;bytesPerSkinElement=1;constructor(e,t){super(t);let i;if(e instanceof Lt)i=e;else{i=new Lt;try{i.load(e)}catch{}}const n=this.viewer,r=this.pathSolver,o=this.solverParams,a=i.version>800,l=a?".dds":".blp";let c=!1;this.reforged=a,this.name=i.name;const u=i.extent;this.bounds.fromExtents(u.min,u.max);for(const p of i.sequences)this.sequences.push(new or(p));for(const p of i.globalSequences)this.globalSequences.push(p);for(const p of i.textureAnimations)this.textureAnimations.push(new pr(this,p));let h=0;for(const p of i.materials){const b=[];for(const g of p.layers){const m=new br(this,g,h++,p.priorityPlane);b.push(m),this.layers.push(m)}this.materials.push(new mr(this,p.shader,b)),p.shader!==""&&(this.hd=!0)}a&&(o.reforged=!0),this.hd&&(o.hd=!0);const v=i.textures;for(let p=0,b=v.length;p<b;p++){const g=v[p];let m=g.path;const w=g.replaceableId,I=g.wrapMode;m===""&&w!==0&&(m=`ReplaceableTextures\\${sn[w]}${l}`,(w===1||w===2)&&(c=!0));const T=new We(w,I);n.load(m,r,o).then(A=>{A&&(T.texture=A)}),this.textures[p]=T}for(const p of i.geosetAnimations)this.geosetAnimations.push(new gr(this,p));this.pivotPoints=i.pivotPoints;let f=0;for(const p of i.bones)this.bones.push(new wr(this,p,f++));for(const p of i.lights)this.lights.push(new yr(this,p,f++));for(const p of i.helpers)this.helpers.push(new Ar(this,p,f++));for(const p of i.attachments)this.attachments.push(new Tr(this,p,f++));for(const p of i.particleEmitters)this.particleEmitters.push(new xr(this,p,f++));for(const p of i.particleEmitters2){const b=new vn(this,p,f++);this.particleEmitters2.push(b),b.teamColored&&(c=!0)}for(const p of i.ribbonEmitters)this.ribbonEmitters.push(new bn(this,p,f++));for(const p of i.cameras)this.cameras.push(new Dr(this,p));for(const p of i.eventObjects)this.eventObjects.push(new Nr(this,p,f++));for(const p of i.collisionShapes)this.collisionShapes.push(new Gr(this,p,f++));this.genericObjects.push(...this.bones,...this.lights,...this.helpers,...this.attachments,...this.particleEmitters,...this.particleEmitters2,...this.ribbonEmitters,...this.eventObjects,...this.collisionShapes),Kr(this,i.geosets),Hr(this),this.setupHierarchy(-1);for(let p=0,b=this.genericObjects.length;p<b;p++)this.sortedGenericObjects[p]=this.genericObjects[this.hierarchy[p]];c&&gt.loadTeamTextures(n)}addInstance(){return new lo(this)}setupHierarchy(e){for(let t=0,i=this.genericObjects.length;t<i;t++){const n=this.genericObjects[t];n.parentId===e&&(this.hierarchy.push(t),this.setupHierarchy(n.objectId))}}}const Dn=`
#ifdef SKIN
attribute vec4 a_bones;
attribute vec4 a_weights;

void transformSkin(inout vec3 position, inout vec3 normal, inout vec3 tangent, inout vec3 binormal) {
  mat4 bone;

  bone += fetchMatrix(a_bones[0], 0.0) * a_weights[0];
  bone += fetchMatrix(a_bones[1], 0.0) * a_weights[1];
  bone += fetchMatrix(a_bones[2], 0.0) * a_weights[2];
  bone += fetchMatrix(a_bones[3], 0.0) * a_weights[3];

  mat3 rotation = mat3(bone);

  position = vec3(bone * vec4(position, 1.0));
  normal = rotation * normal;
  tangent = rotation * tangent;
  binormal = rotation * binormal;
}
#else
attribute vec4 a_bones;
#ifdef EXTENDED_BONES
attribute vec4 a_extendedBones;
#endif
attribute float a_boneNumber;

mat4 getVertexGroupMatrix() {
  mat4 bone;

  // For the broken models out there, since the game supports this.
  if (a_boneNumber > 0.0) {
    for (int i = 0; i < 4; i++) {
      if (a_bones[i] > 0.0) {
        bone += fetchMatrix(a_bones[i] - 1.0, 0.0);
      }
    }

    #ifdef EXTENDED_BONES
      for (int i = 0; i < 4; i++) {
        if (a_extendedBones[i] > 0.0) {
          bone += fetchMatrix(a_extendedBones[i] - 1.0, 0.0);
        }
      }
    #endif
  }

  return bone / a_boneNumber;
}

void transformVertexGroups(inout vec3 position, inout vec3 normal) {
  mat4 bone = getVertexGroupMatrix();
  mat3 rotation = mat3(bone);

  position = vec3(bone * vec4(position, 1.0));
  normal = normalize(rotation * normal);
}

void transformVertexGroupsHD(inout vec3 position, inout vec3 normal, inout vec3 tangent, inout vec3 binormal) {
  mat4 bone = getVertexGroupMatrix();
  mat3 rotation = mat3(bone);

  position = vec3(bone * vec4(position, 1.0));
  normal = normalize(rotation * normal);
  tangent = normalize(rotation * tangent);
  binormal = normalize(rotation * binormal);
}
#endif
`,Ve=`
uniform mat4 u_VP;
uniform vec3 u_lightPos;
uniform vec4 u_vertexColor;
uniform vec4 u_geosetColor;
uniform float u_layerAlpha;
uniform vec2 u_uvTrans;
uniform vec2 u_uvRot;
uniform float u_uvScale;
uniform bool u_hasBones;

attribute vec3 a_position;
attribute vec3 a_normal;
attribute vec2 a_uv;

varying vec2 v_uv;
varying vec3 v_normal;
varying vec4 v_color;
varying vec4 v_uvTransRot;
varying float v_uvScale;
varying vec3 v_lightDir;

${Wi}
${Dn}

void main() {
  vec3 position = a_position;
  vec3 normal = a_normal;

  if (u_hasBones) {
    #ifdef SKIN
      vec3 tangent = vec3(0.0);
      vec3 binormal = vec3(0.0);
      transformSkin(position, normal, tangent, binormal);
    #else
      transformVertexGroups(position, normal);
    #endif
  }

  v_uv = a_uv;
  v_normal = normal;
  v_color = u_vertexColor * u_geosetColor.bgra * vec4(1.0, 1.0, 1.0, u_layerAlpha);
  v_uvTransRot = vec4(u_uvTrans, u_uvRot);
  v_uvScale = u_uvScale;
  v_lightDir = normalize(u_lightPos - position);

  gl_Position = u_VP * vec4(position, 1.0);
}
`,Me=`
${Ft}


// A 2D quaternion*vector.
// q is the zw components of the original quaternion.
vec2 quat_transform(vec2 q, vec2 v) {
  vec2 uv = vec2(-q.x * v.y, q.x * v.x);
  vec2 uuv = vec2(-q.x * uv.y, q.x * uv.x);

  return v + 2.0 * (uv * q.y + uuv);
}


uniform sampler2D u_texture;
uniform float u_filterMode;
uniform bool u_unshaded;

varying vec2 v_uv;
varying vec3 v_normal;
varying vec4 v_color;
varying vec4 v_uvTransRot;
varying float v_uvScale;
varying vec3 v_lightDir;

vec4 getDiffuseColor() {
  vec2 uv = v_uv;

  // Translation animation
  uv += v_uvTransRot.xy;

  // Rotation animation
  uv = quat_transform(v_uvTransRot.zw, uv - 0.5) + 0.5;

  // Scale animation
  uv = v_uvScale * (uv - 0.5) + 0.5;

  vec4 texel = texture2D(u_texture, uv);
  vec4 color = texel * v_color;

  // 1bit Alpha
  if (u_filterMode == 1.0 && color.a < 0.75) {
    discard;
  }

  // "Close to 0 alpha"
  if (u_filterMode >= 5.0 && color.a < 0.02) {
    discard;
  }

  return color;
}

void onlyTexCoords() {
  gl_FragColor = vec4(v_uv, 0.0, 1.0);
}

void onlyNormals() {
  gl_FragColor = vec4(v_normal, 1.0);
}

void onlyDiffuse() {
  gl_FragColor = getDiffuseColor();
}

void lambert() {
  vec4 color = getDiffuseColor();

  if (!u_unshaded) {
    float lambertFactor = clamp(dot(v_normal, v_lightDir), 0.0, 1.0);
    lambertFactor = clamp(lambertFactor + 0.7, 0.0, 1.0);

    color.rgb *= lambertFactor;
  }

  gl_FragColor = color;
}

void main() {
  #if defined(ONLY_DIFFUSE)
  onlyDiffuse();
  #elif defined(ONLY_TEXCOORDS)
  onlyTexCoords();
  #elif defined(ONLY_NORMALS)
  onlyNormals();
  #else
  lambert();
  #endif
}
`,re=`
uniform mat4 u_VP;
uniform mat4 u_MV;
uniform vec3 u_eyePos;
uniform vec3 u_lightPos;
uniform float u_layerAlpha;
uniform bool u_hasBones;

attribute vec3 a_position;
attribute vec3 a_normal;
attribute vec2 a_uv;
attribute vec4 a_tangent;

varying vec2 v_uv;
varying float v_layerAlpha;
varying vec3 v_lightDir;
varying vec3 v_eyeVec;
varying vec3 v_normal;
// varying vec3 v_lightDirWorld;

#if defined(ONLY_TANGENTS)
varying vec3 v_tangent;
#endif

${Wi}
${Dn}

vec3 TBN(vec3 vector, vec3 tangent, vec3 binormal, vec3 normal) {
  return vec3(dot(vector, tangent), dot(vector, binormal), dot(vector, normal));
}

void main() {
  vec3 position = a_position;
  vec3 normal = a_normal;
  vec3 tangent = a_tangent.xyz;

  // Re-orthogonalize the tangent in case it wasnt normalized.
  // See "One last thing" at https://learnopengl.com/Advanced-Lighting/Normal-Mapping
  tangent = normalize(tangent - dot(tangent, normal) * normal);

  vec3 binormal = cross(normal, tangent) * a_tangent.w;

  if (u_hasBones) {
    #ifdef SKIN
      transformSkin(position, normal, tangent, binormal);
    #else
      transformVertexGroupsHD(position, normal, tangent, binormal);
    #endif
  }

  vec3 position_mv = vec3(u_MV * vec4(position, 1));

  mat3 mv = mat3(u_MV);
  vec3 t = normalize(mv * tangent);
  vec3 b = normalize(mv * binormal);
  vec3 n = normalize(mv * normal);

  v_eyeVec = normalize(u_eyePos - position_mv);

  vec3 lightDir = normalize(u_lightPos - position_mv);
  v_lightDir = normalize(TBN(lightDir, t, b, n));
  
  v_uv = a_uv;
  v_layerAlpha = u_layerAlpha;

  v_normal = normal;
  // v_lightDirWorld = normalize(lightDir);

  #if defined(ONLY_TANGENTS)
  v_tangent = tangent;
  #endif

  gl_Position = u_VP * vec4(position, 1.0);
}
`,oe=`
${Ft}

uniform sampler2D u_diffuseMap;
uniform sampler2D u_normalsMap;
uniform sampler2D u_ormMap;
uniform sampler2D u_emissiveMap;
uniform sampler2D u_teamColorMap;
uniform sampler2D u_environmentMap;
uniform float u_filterMode;

// uniform sampler2D u_lutMap;
// uniform sampler2D u_envDiffuseMap;
// uniform sampler2D u_envSpecularMap;

varying vec2 v_uv;
varying float v_layerAlpha;
varying vec3 v_lightDir;
varying vec3 v_eyeVec;
varying vec3 v_normal;
// varying vec3 v_lightDirWorld;

#if defined(ONLY_TANGENTS)
varying vec3 v_tangent;
#endif

vec3 decodeNormal() {
  vec2 xy = texture2D(u_normalsMap, v_uv).xy * 2.0 - 1.0;
  
  return vec3(xy, sqrt(1.0 - dot(xy, xy)));
}

const vec2 invAtan = vec2(0.1591, 0.3183);
vec2 sampleEnvironmentMap(vec3 normal) {
  vec2 uv = vec2(atan(normal.x, normal.y), -asin(normal.z));
  uv *= invAtan;
  uv += 0.5;
  return uv;
}

vec4 getDiffuseColor() {
  vec4 color = texture2D(u_diffuseMap, v_uv);

  // 1bit Alpha
  if (u_filterMode == 1.0 && color.a < 0.75) {
    discard;
  }

  return color;
}

vec4 getOrmColor() {
  return texture2D(u_ormMap, v_uv);
}

vec3 getEmissiveColor() {
  return texture2D(u_emissiveMap, v_uv).rgb;
}

vec3 getTeamColor() {
  return texture2D(u_teamColorMap, v_uv).rgb;
}

// const float PI = 3.14159265359;
// const float RECIPROCAL_PI = 0.31830988618;
// const float RECIPROCAL_PI2 = 0.15915494;
// const float LN2 = 0.6931472;
// const float ENV_LODS = 6.0;
// vec4 SRGBtoLinear(vec4 srgb) {
//     vec3 linOut = pow(srgb.xyz, vec3(2.2));
//     return vec4(linOut, srgb.w);;
// }
// vec4 RGBMToLinear(in vec4 value) {
//     float maxRange = 6.0;
//     return vec4(value.xyz * value.w * maxRange, 1.0);
// }
// vec3 linearToSRGB(vec3 color) {
//     return pow(color, vec3(1.0 / 2.2));
// }
// // vec3 getNormal() {
// //     vec3 pos_dx = dFdx(vMPos.xyz);
// //     vec3 pos_dy = dFdy(vMPos.xyz);
// //     vec2 tex_dx = dFdx(vUv);
// //     vec2 tex_dy = dFdy(vUv);
// //     vec3 t = normalize(pos_dx * tex_dy.t - pos_dy * tex_dx.t);
// //     vec3 b = normalize(-pos_dx * tex_dy.s + pos_dy * tex_dx.s);
// //     mat3 tbn = mat3(t, b, normalize(vNormal));
// //     vec3 n = texture2D(tNormal, vUv * uNormalUVScale).rgb * 2.0 - 1.0;
// //     n.xy *= uNormalScale;
// //     vec3 normal = normalize(tbn * n);
// //     // Get world normal from view normal (normalMatrix * normal)
// //     return normalize((vec4(normal, 0.0) * viewMatrix).xyz);
// // }
// vec3 specularReflection(vec3 specularEnvR0, vec3 specularEnvR90, float VdH) {
//     return specularEnvR0 + (specularEnvR90 - specularEnvR0) * pow(clamp(1.0 - VdH, 0.0, 1.0), 5.0);
// }
// float geometricOcclusion(float NdL, float NdV, float roughness) {
//     float r = roughness;
//     float attenuationL = 2.0 * NdL / (NdL + sqrt(r * r + (1.0 - r * r) * (NdL * NdL)));
//     float attenuationV = 2.0 * NdV / (NdV + sqrt(r * r + (1.0 - r * r) * (NdV * NdV)));
//     return attenuationL * attenuationV;
// }
// float microfacetDistribution(float roughness, float NdH) {
//     float roughnessSq = roughness * roughness;
//     float f = (NdH * roughnessSq - NdH) * NdH + 1.0;
//     return roughnessSq / (PI * f * f);
// }
// vec2 cartesianToPolar(vec3 n) {
//     vec2 uv;
//     uv.x = atan(n.z, n.x) * RECIPROCAL_PI2 + 0.5;
//     uv.y = asin(n.y) * RECIPROCAL_PI + 0.5;
//     return uv;
// }
// void getIBLContribution(inout vec3 diffuse, inout vec3 specular, float NdV, float roughness, vec3 n, vec3 reflection, vec3 diffuseColor, vec3 specularColor) {
//   vec3 brdf = SRGBtoLinear(texture2D(u_lutMap, vec2(NdV, roughness))).rgb;
//   vec3 diffuseLight = RGBMToLinear(texture2D(u_envDiffuseMap, sampleEnvironmentMap(n))).rgb;
//   // Sample 2 levels and mix between to get smoother degradation
//   float blend = roughness * ENV_LODS;
//   float level0 = floor(blend);
//   float level1 = min(ENV_LODS, level0 + 1.0);
//   blend -= level0;
  
//   // Sample the specular env map atlas depending on the roughness value
//   vec2 uvSpec = sampleEnvironmentMap(reflection);
//   uvSpec.y /= 2.0;
//   vec2 uv0 = uvSpec;
//   vec2 uv1 = uvSpec;
//   uv0 /= pow(2.0, level0);
//   uv0.y += 1.0 - exp(-LN2 * level0);
//   uv1 /= pow(2.0, level1);
//   uv1.y += 1.0 - exp(-LN2 * level1);
//   vec3 specular0 = RGBMToLinear(texture2D(u_envSpecularMap, uv0)).rgb;
//   vec3 specular1 = RGBMToLinear(texture2D(u_envSpecularMap, uv1)).rgb;
//   vec3 specularLight = mix(specular0, specular1, blend);
//   diffuse = diffuseLight * diffuseColor;
  
//   // Bit of extra reflection for smooth materials
//   float reflectivity = pow((1.0 - roughness), 2.0) * 0.05;
//   specular = specularLight * (specularColor * brdf.x + brdf.y + reflectivity);
//   // specular *= uEnvSpecular;
// }

// void PBR() {
//   vec4 baseDiffuseColor = getDiffuseColor();
//   vec3 baseColor = baseDiffuseColor.rgb;
//   vec4 orm = getOrmColor();
//   vec3 tc = getTeamColor();
//   float tcFactor = getOrmColor().a;

//   if (tcFactor > 0.1) {
//     baseColor *= tc * tcFactor;
//   }

//   float roughness = clamp(orm.g, 0.04, 1.0);
//   float metallic = clamp(orm.b, 0.04, 1.0);

//   vec3 f0 = vec3(0.04);
//   vec3 diffuseColor = baseColor * (vec3(1.0) - f0) * (1.0 - metallic);
//   vec3 specularColor = mix(f0, baseColor, metallic);
//   vec3 specularEnvR0 = specularColor;
//   vec3 specularEnvR90 = vec3(clamp(max(max(specularColor.r, specularColor.g), specularColor.b) * 25.0, 0.0, 1.0));

//   vec3 N = v_normal;
//   vec3 V = normalize(v_eyeVec);
//   vec3 L = normalize(v_lightDirWorld);
//   vec3 H = normalize(L + V);
//   vec3 reflection = normalize(reflect(-V, N));

//   float NdL = clamp(dot(N, L), 0.001, 1.0);
//   float NdV = clamp(abs(dot(N, V)), 0.001, 1.0);
//   float NdH = clamp(dot(N, H), 0.0, 1.0);
//   float LdH = clamp(dot(L, H), 0.0, 1.0);
//   float VdH = clamp(dot(V, H), 0.0, 1.0);

//   vec3 F = specularReflection(specularEnvR0, specularEnvR90, VdH);
//   float G = geometricOcclusion(NdL, NdV, roughness);
//   float D = microfacetDistribution(roughness, NdH);

//   vec3 diffuseContrib = (1.0 - F) * (diffuseColor / PI);
//   vec3 specContrib = F * G * D / (4.0 * NdL * NdV);
  
//   // Shading based off lights
//   // vec3 color = NdL * uLightColor * (diffuseContrib + specContrib);
//   vec3 color = NdL * (diffuseContrib + specContrib);

//   // Calculate IBL lighting
//   vec3 diffuseIBL;
//   vec3 specularIBL;
//   getIBLContribution(diffuseIBL, specularIBL, NdV, roughness, N, reflection, diffuseColor, specularColor);

//   // Add IBL on top of color
//   color +=  specularIBL;

//   color *= orm.r;

//   color += getEmissiveColor();

//   // Convert to sRGB to display
//   gl_FragColor.rgb = color;
//   gl_FragColor.a = baseDiffuseColor.a;
// }

void onlyDiffuse() {
  vec4 baseColor = getDiffuseColor();
  vec3 tc = getTeamColor();
  float tcFactor = getOrmColor().a;

  if (tcFactor > 0.1) {
    baseColor.rgb *= tc * tcFactor;
  }

  gl_FragColor = baseColor;
}

void onlyNormalMap() {
  gl_FragColor = vec4(decodeNormal(), 1.0);
}

void onlyOcclusion() {
  gl_FragColor = vec4(getOrmColor().rrr, 1.0);
}

void onlyRoughness() {
  gl_FragColor = vec4(getOrmColor().ggg, 1.0);
}

void onlyMetallic() {
  gl_FragColor = vec4(getOrmColor().bbb, 1.0);
}

void onlyTeamColorFactor() {
  gl_FragColor = vec4(getOrmColor().aaa, 1.0);
}

void onlyEmissiveMap() {
  gl_FragColor = vec4(getEmissiveColor(), 1.0);
}

void onlyTexCoords() {
  gl_FragColor = vec4(v_uv, 0.0, 1.0);
}

void onlyNormals() {
  gl_FragColor = vec4(v_normal, 1.0);
}

#if defined(ONLY_TANGENTS)
void onlyTangents() {
  gl_FragColor = vec4(v_tangent, 1.0);
}
#endif

void lambert() {
  vec4 baseColor = getDiffuseColor();
  vec3 normal = decodeNormal();
  vec4 orm = getOrmColor();
  vec3 emissive = getEmissiveColor();
  vec3 tc = getTeamColor();
  float aoFactor = orm.r;
  float tcFactor = orm.a;
  float lambertFactor = clamp(dot(normal, v_lightDir), 0.0, 1.0);
  vec3 color = baseColor.rgb;

  if (tcFactor > 0.1) {
    color *= tc * tcFactor;
  }
  
  color *= clamp(lambertFactor * aoFactor + 0.1, 0.0, 1.0);
  color += emissive;

  gl_FragColor = vec4(color, baseColor.a);
}

void main() {
  #if defined(ONLY_DIFFUSE)
  onlyDiffuse();
  #elif defined(ONLY_NORMAL_MAP)
  onlyNormalMap();
  #elif defined(ONLY_OCCLUSION)
  onlyOcclusion();
  #elif defined(ONLY_ROUGHNESS)
  onlyRoughness();
  #elif defined(ONLY_METALLIC)
  onlyMetallic();
  #elif defined(ONLY_TC_FACTOR)
  onlyTeamColorFactor();
  #elif defined(ONLY_EMISSIVE)
  onlyEmissiveMap();
  #elif defined(ONLY_TEXCOORDS)
  onlyTexCoords();
  #elif defined(ONLY_NORMALS)
  onlyNormals();
  #elif defined(ONLY_TANGENTS)
  onlyTangents();
  #else
  lambert();
  #endif
}
`,ho=`
#define EMITTER_PARTICLE2 0
#define EMITTER_RIBBON 1
#define EMITTER_SPLAT 2
#define EMITTER_UBERSPLAT 3
#define HEAD 0.0

uniform mat4 u_VP;
uniform int u_emitter;

// Shared
uniform vec4 u_colors[3];
uniform vec3 u_vertices[4];
uniform vec3 u_intervals[4];
uniform float u_lifeSpan;
uniform float u_columns;
uniform float u_rows;

// Particle2
uniform vec3 u_scaling;
uniform vec3 u_cameraZ;
uniform float u_timeMiddle;
uniform bool u_teamColored;

// Splat and Uber.
uniform vec3 u_intervalTimes;

// Vertices
attribute float a_position;

// Instances
attribute vec3 a_p0;
attribute vec3 a_p1;
attribute vec3 a_p2;
attribute vec3 a_p3;
attribute float a_health;
attribute vec4 a_color;
attribute float a_tail;
attribute vec3 a_leftRightTop;

varying vec2 v_texcoord;
varying vec4 v_color;

float getCell(vec3 interval, float factor) {
  float start = interval[0];
  float end = interval[1];
  float repeat = interval[2];
  float spriteCount = end - start;

  if (spriteCount > 0.0) {
    // Repeating speeds up the sprite animation, which makes it effectively run N times in its interval.
    // E.g. if repeat is 4, the sprite animation will be seen 4 times, and thus also run 4 times as fast.
    // The sprite index is limited to the number of actual sprites.
    return min(start + mod(floor(spriteCount * repeat * factor), spriteCount), u_columns * u_rows - 1.0);
  }

  return start;
}

void particle2() {
  float factor = (u_lifeSpan - a_health) / u_lifeSpan;
  int index = 0;

  if (factor < u_timeMiddle) {
    factor = factor / u_timeMiddle;
    index = 0;
  } else {
    factor = (factor - u_timeMiddle) / (1.0 - u_timeMiddle);
    index = 1;
  }

  factor = min(factor, 1.0);

  float scale = mix(u_scaling[index], u_scaling[index + 1], factor);
  vec4 color = mix(u_colors[index], u_colors[index + 1], factor);

  float cell = 0.0;

  if (u_teamColored) {
    cell = a_leftRightTop[0];
  } else {
    vec3 interval;

    if (a_tail == HEAD) {
      interval = u_intervals[index];
    } else {
      interval = u_intervals[index + 2];
    }

    cell = getCell(interval, factor);
  }

  float left = floor(mod(cell, u_columns));
  float top = floor(cell / u_columns);
  float right = left + 1.0;
  float bottom = top + 1.0;

  left /= u_columns;
  right /= u_columns;
  top /= u_rows;
  bottom /= u_rows;

  if (a_position == 0.0) {
    v_texcoord = vec2(right, top);
  } else if (a_position == 1.0) {
    v_texcoord = vec2(left, top);
  } else if (a_position == 2.0) {
    v_texcoord = vec2(left, bottom);
  } else if (a_position == 3.0) {
    v_texcoord = vec2(right, bottom);
  }

  v_color = color;
  
  if (a_tail == HEAD) {
    vec3 v = u_vertices[int(a_position)];
    float cs = cos(a_p1.x);
    float sn = sin(a_p1.x);

    float x = v.x * cs - v.y * sn;
    float y = v.x * sn + v.y * cs;

    vec3 fv = vec3(
      v.x * cs - v.y * sn,
      v.x * sn + v.y * cs,
      v.z);

    gl_Position = u_VP * vec4(a_p0 + fv * scale, 1.0);
  } else {
    // Get the normal to the tail in camera space.
    // This allows to build a 2D rectangle around the 3D tail.
    vec3 normal = cross(u_cameraZ, normalize(a_p1 - a_p0));
    vec3 boundary = normal * scale * a_p2[0];
    vec3 position;

    if (a_position == 0.0) {
      position = a_p0 - boundary;
    } else if (a_position == 1.0) {
      position = a_p1 - boundary;
    } else if (a_position == 2.0) {
      position = a_p1 + boundary;
    } else if (a_position == 3.0) {
      position = a_p0 + boundary;
    }

    gl_Position = u_VP * vec4(position, 1.0);
  }
}

void ribbon() {
  vec3 position;
  float left = a_leftRightTop[0] / 255.0;
  float right = a_leftRightTop[1] / 255.0;
  float top = a_leftRightTop[2] / 255.0;
  float bottom = top + 1.0;

  if (a_position == 0.0) {
    v_texcoord = vec2(right, top);
    position = a_p0;
  } else if (a_position == 1.0) {
    v_texcoord = vec2(right, bottom);
    position = a_p1;
  } else if (a_position == 2.0) {
    v_texcoord = vec2(left, bottom);
    position = a_p2;
  } else if (a_position == 3.0) {
    v_texcoord = vec2(left, top);
    position = a_p3;
  }

  v_texcoord[0] /= u_columns;
  v_texcoord[1] /= u_rows;

  v_color = a_color;

  gl_Position = u_VP * vec4(position, 1.0);
}

void splat() {
  float factor = u_lifeSpan - a_health;
  int index;

  if (factor < u_intervalTimes[0]) {
    factor = factor / u_intervalTimes[0];
    index = 0;
  } else {
    factor = (factor - u_intervalTimes[0]) / u_intervalTimes[1];
    index = 1;
  }

  float cell = getCell(u_intervals[index], factor);
  float left = floor(mod(cell, u_columns));
  float top = floor(cell / u_columns);
  float right = left + 1.0;
  float bottom = top + 1.0;
  vec3 position;

  if (a_position == 0.0) {
    v_texcoord = vec2(left, top);
    position = a_p0;
  } else if (a_position == 1.0) {
    v_texcoord = vec2(left, bottom);
    position = a_p1;
  } else if (a_position == 2.0) {
    v_texcoord = vec2(right, bottom);
    position = a_p2;
  } else if (a_position == 3.0) {
    v_texcoord = vec2(right, top);
    position = a_p3;
  }

  v_texcoord[0] /= u_columns;
  v_texcoord[1] /= u_rows;

  v_color = mix(u_colors[index], u_colors[index + 1], factor) / 255.0;

  gl_Position = u_VP * vec4(position, 1.0);
}

void ubersplat() {
  float factor = u_lifeSpan - a_health;
  vec4 color;

  if (factor < u_intervalTimes[0]) {
    color = mix(u_colors[0], u_colors[1], factor / u_intervalTimes[0]);
  } else if (factor < u_intervalTimes[0] + u_intervalTimes[1]) {
    color = u_colors[1];
  } else {
    color = mix(u_colors[1], u_colors[2], (factor - u_intervalTimes[0] - u_intervalTimes[1]) / u_intervalTimes[2]);
  }

  vec3 position;

  if (a_position == 0.0) {
    v_texcoord = vec2(0.0, 0.0);
    position = a_p0;
  } else if (a_position == 1.0) {
    v_texcoord = vec2(0.0, 1.0);
    position = a_p1;
  } else if (a_position == 2.0) {
    v_texcoord = vec2(1.0, 1.0);
    position = a_p2;
  } else if (a_position == 3.0) {
    v_texcoord = vec2(1.0, 0.0);
    position = a_p3;
  }

  v_color = color / 255.0;

  gl_Position = u_VP * vec4(position, 1.0);
}

void main() {
  if (u_emitter == EMITTER_PARTICLE2) {
    particle2();
  } else if (u_emitter == EMITTER_RIBBON) {
    ribbon();
  } else if (u_emitter == EMITTER_SPLAT) {
    splat();
  } else if (u_emitter == EMITTER_UBERSPLAT) {
    ubersplat();
  }
}
`,uo=`
${Ft}

#define EMITTER_PARTICLE2 0
#define EMITTER_RIBBON 1

uniform sampler2D u_texture;
uniform highp int u_emitter;
uniform float u_filterMode;

varying vec2 v_texcoord;
varying vec4 v_color;

void main() {
  vec4 texel = texture2D(u_texture, v_texcoord);
  vec4 color = texel * v_color;

  // 1bit Alpha, used by ribbon emitters.
  if (u_emitter == EMITTER_RIBBON && u_filterMode == 1.0 && color.a < 0.75) {
    discard;
  }

  // "Close to 0 alpha"
  if (u_emitter == EMITTER_PARTICLE2 && (u_filterMode == 2.0 || u_filterMode == 3.0) && color.a < 0.02) {
    discard;
  }

  // Alpha key.
  if (u_emitter == EMITTER_PARTICLE2 && (u_filterMode == 4.0) && color.a < 0.75) {
    discard;
  }

  gl_FragColor = color;
}
`,fo=s=>new rr(s),po=s=>sr(s),gt={load(s,e,t=!1){const i=s.gl,n=s.webgl;if(!n.ensureExtension("OES_texture_float"))throw new Error("MDX: No float texture support!");if(!n.ensureExtension("ANGLE_instanced_arrays"))throw new Error("MDX: No instanced rendering support!");const r=`#define EXTENDED_BONES
`+Ve,o=`#define ONLY_DIFFUSE
`+Me,a=`#define ONLY_TEXCOORDS
`+Me,l=`#define ONLY_NORMALS
`+Me,c=`#define EXTENDED_BONES
`+re,u=`#define SKIN
`+re,h=`#define ONLY_DIFFUSE
`+oe,v=`#define ONLY_NORMAL_MAP
`+oe,f=`#define ONLY_OCCLUSION
`+oe,p=`#define ONLY_ROUGHNESS
`+oe,b=`#define ONLY_METALLIC
`+oe,g=`#define ONLY_TC_FACTOR
`+oe,m=`#define ONLY_EMISSIVE
`+oe,w=`#define ONLY_TEXCOORDS
`+oe,I=`#define ONLY_NORMALS
`+oe,T=`#define ONLY_TANGENTS
`+oe,A=n.createShader(Ve,Me),y=n.createShader(r,Me),O=`#define SKIN
`+Ve,V=n.createShader(O,Me),K=n.createShader(re,oe),G=n.createShader(c,oe),ne=n.createShader(u,oe),B=n.createShader(ho,uo),H=[],M=[];let E=[];E[R.Diffuse]=n.createShader(Ve,o),E[R.TexCoords]=n.createShader(Ve,a),E[R.Normals]=n.createShader(Ve,l),H[W.VertexGroups]=E,E=[],E[R.Diffuse]=n.createShader(r,o),E[R.TexCoords]=n.createShader(r,a),E[R.Normals]=n.createShader(r,l),H[W.ExtendedVertexGroups]=E,E=[],E[R.Diffuse]=n.createShader(re,h),E[R.NormalMap]=n.createShader(re,v),E[R.Occlusion]=n.createShader(re,f),E[R.Roughness]=n.createShader(re,p),E[R.Metallic]=n.createShader(re,b),E[R.TCFactor]=n.createShader(re,g),E[R.Emissive]=n.createShader(re,m),E[R.TexCoords]=n.createShader(re,w),E[R.Normals]=n.createShader(re,I),E[R.Tangents]=n.createShader(`#define ONLY_TANGENTS
`+re,T),M[W.VertexGroups]=E,E=[],E[R.Diffuse]=n.createShader(c,h),E[R.NormalMap]=n.createShader(c,v),E[R.Occlusion]=n.createShader(c,f),E[R.Roughness]=n.createShader(c,p),E[R.Metallic]=n.createShader(c,b),E[R.TCFactor]=n.createShader(c,g),E[R.Emissive]=n.createShader(c,m),E[R.TexCoords]=n.createShader(c,w),E[R.Normals]=n.createShader(c,I),E[R.Tangents]=n.createShader(`#define ONLY_TANGENTS
`+c,T),M[W.ExtendedVertexGroups]=E,E=[],E[R.Diffuse]=n.createShader(u,h),E[R.NormalMap]=n.createShader(u,v),E[R.Occlusion]=n.createShader(u,f),E[R.Roughness]=n.createShader(u,p),E[R.Metallic]=n.createShader(u,b),E[R.TCFactor]=n.createShader(u,g),E[R.Emissive]=n.createShader(u,m),E[R.TexCoords]=n.createShader(u,w),E[R.Normals]=n.createShader(u,I),E[R.Tangents]=n.createShader(`#define ONLY_TANGENTS
`+u,T),M[W.Skin]=E;const N=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,N),i.bufferData(i.ARRAY_BUFFER,new Uint8Array([0,1,2,0,2,3]),i.STATIC_DRAW);const _={pathSolver:e,reforged:t,sdShader:A,sdSkinShader:V,sdExtendedShader:y,hdShader:K,hdExtendedShader:G,hdSkinShader:ne,particlesShader:B,sdDebugShaders:H,hdDebugShaders:M,rectBuffer:N,teamColors:[],teamGlows:[],eventObjectTables:{}};s.sharedCache.set("mdx",_)},isValidSource(s){return s instanceof Lt?!0:Ni(s)||Gi(s)},resource:co,loadTeamTextures(s){const{pathSolver:e,reforged:t,teamColors:i,teamGlows:n}=s.sharedCache.get("mdx");if(i.length===0){const r=t?28:16,o=t?"dds":"blp",a=t?{reforged:!0}:void 0;for(let l=0;l<r;l++){const u=`${`${l}`.padStart(2,"0")}.${o}`,h=new We(1,Se.WrapBoth),v=new We(2,Se.WrapBoth);s.load(`ReplaceableTextures\\TeamColor\\TeamColor${u}`,e,a).then(f=>h.texture=f),s.load(`ReplaceableTextures\\TeamGlow\\TeamGlow${u}`,e,a).then(f=>v.texture=f),i[l]=h,n[l]=v}}},getEventObjectSoundFile(s,e,t,i){if(!e||hs(s)===".flac")return s;for(let n=1,r=i.length;n<r;n++){const o=i[n].data.getRow(s);if(o){const a=o.string("Flags"),l=o.string("Filepath");if(a==="SD_ONLY"){if(!t)return l}else if(a==="HD_ONLY"){if(t)return l}else return l}}},async getEventObjectData(s,e,t,i){if(e!=="SPN"&&e!=="SPL"&&e!=="UBR"&&e!=="SND")return;const{pathSolver:n,reforged:r,eventObjectTables:o}=s.sharedCache.get("mdx"),a=r?{reforged:!0}:{},l=(f,p)=>n?n(f,p):f;if(!o[e]){const f=[];e==="SPN"?f.push("Splats\\SpawnData.slk"):e==="SPL"?f.push("Splats\\SplatData.slk"):e==="UBR"?f.push("Splats\\UberSplatData.slk"):e==="SND"&&(f.push("UI\\SoundInfo\\AnimSounds.slk"),r?f.push("UI\\SoundInfo\\DialogueHumanBase.slk","UI\\SoundInfo\\DialogueOrcBase.slk","UI\\SoundInfo\\DialogueUndeadBase.slk","UI\\SoundInfo\\DialogueNightElfBase.slk","UI\\SoundInfo\\DialogueNagaBase.slk","UI\\SoundInfo\\DialogueDemonBase.slk","UI\\SoundInfo\\DialogueCreepsBase.slk"):f.push("UI\\SoundInfo\\AnimLookups.slk"));const p=f.map(g=>s.loadGeneric(l(g,a),"text",fo)),b=await Promise.all(p);for(const g of b)if(!g)return;o[e]=b}const c=o[e],u=c[0].data;let h;const v=[];if(e==="SND"){if(r)h=u.findRow("AnimationEventCode",t);else{const f=c[1].data.getRow(t);f&&(h=u.getRow(f.string("SoundLabel")))}if(h)for(const f of h.string("FileNames").split(",")){const p=this.getEventObjectSoundFile(f,r,i,c);p&&v.push(s.loadGeneric(l(p,a),"arrayBuffer",po))}}else h=u.getRow(t),h&&(e==="SPN"?v.push(s.load(h.string("Model").replace(".mdl",".mdx"),l,a)):(e==="SPL"||e==="UBR")&&v.push(s.load(`ReplaceableTextures\\Splats\\${h.string("file")}${r?".dds":".blp"}`,l,a)));if(h&&v.length){const p=(await Promise.all(v)).filter(b=>b);if(p.length)return{row:h,resources:p}}},getBatchShader(s,e,t){const i=s.sharedCache.get("mdx"),n=s.debugRenderMode;if(t){if(n!==R.None){const r=i.hdDebugShaders[e];if(r){const o=r[n];if(o)return o}}return e===W.Skin?i.hdSkinShader:e===W.VertexGroups?i.hdShader:i.hdExtendedShader}else{if(n!==R.None){const r=i.sdDebugShaders[e];if(r){const o=r[n];if(o)return o}}return e===W.Skin?i.sdSkinShader:e===W.VertexGroups?i.sdShader:i.sdExtendedShader}}};d.vec3.create(),d.vec3.create(),d.vec3.create(),d.vec3.create();const Nn={ModelViewer:Hs,handlers:{blp:er,mdx:gt}},{LUA_ERRRUN:To,LUA_ERRSYNTAX:xo,LUA_OK:Eo,LUA_VERSION_MAJOR:So,LUA_VERSION_MINOR:_o,LUA_REGISTRYINDEX:Io,lua_Debug:Lo,lua_getinfo:Co,lua_getstack:Ro,lua_gettop:Bo,lua_insert:Po,lua_pcall:Fo,lua_pop:ko,lua_pushcfunction:Oo,lua_remove:Uo,lua_setglobal:Vo,lua_tojsstring:Mo,lua_atnativeerror:Do,lua_getglobal:No,lua_rawgeti:Go,thread_status:jo,to_jsstring:Ko,luastring:qo}=Ge.lua,{lua_register:Ho,lua_pushinteger:$o,lua_pushnumber:Xo,lua_pushstring:zo,lua_pushlightuserdata:Yo,lua_touserdata:Wo,lua_pushboolean:Zo,lua_pushnil:Qo,lua_toboolean:Jo,to_luastring:ea}=Ge.lua,{luaL_checknumber:ta,luaL_loadstring:ia,luaL_newstate:na,luaL_tolstring:sa,luaL_loadbuffer:ra,luaL_requiref:oa,luaL_checkstring:aa,luaL_checkinteger:la,luaL_ref:ca,luaL_unref:ha}=Ge.lauxlib,{lua_resume:da,lua_yield:ua}=Ge.lua,{lua_newthread:fa}=Ge.lua;function vo(s,e={}){return new bo(s,e)}const $=d.vec3.create(),De=d.vec3.create(),Ne=d.quat.create(),Gn=new Float32Array(1);function jn(s,e){let t=e.clientX-s.clientX,i=e.clientY-s.clientY;return Math.sqrt(t*t+i*i)}const wt=-1,Kn=0,qn=1;class bo{constructor(e,t={}){this.scene=e,this.canvas=e.viewer.canvas,this.camera=e.camera,this.moveSpeed=t.moveSpeed||2,this.rotationSpeed=t.rotationSpeed||Math.PI/180,this.zoomFactor=t.zoomFactor||.1,this.horizontalAngle=t.horizontalAngle||Math.PI/2,this.verticalAngle=t.verticalAngle||Math.PI/4,this.distance=t.distance||500,this.position=t.position||d.vec3.create(),this.target=t.target||d.vec3.create(),this.twist=t.twist||0,this.mouse={buttons:[!1,!1,!1],x:0,y:0,x2:0,y2:0},this.touchMode=wt,this.touches=[],this.instance=null,this.onManualChange=t.onManualChange||null,this.fov=t.fov||Math.PI/4,this.nearClipPlane=t.nearClipPlane||1,this.farClipPlane=t.farClipPlane||2e5,this.update(),window.addEventListener("resize",i=>this.onResize()),setTimeout(()=>this.onResize(),0),this.canvas.addEventListener("contextmenu",i=>i.preventDefault()),this.canvas.addEventListener("selectstart",i=>i.preventDefault()),this.canvas.addEventListener("mousedown",i=>{i.preventDefault(),this.mouse.buttons[i.button]=!0}),document.addEventListener("mouseup",i=>{i.preventDefault(),this.mouse.buttons[i.button]=!1}),window.addEventListener("mousemove",i=>{this.mouse.x2=this.mouse.x,this.mouse.y2=this.mouse.y,this.mouse.x=i.clientX,this.mouse.y=i.clientY;let n=this.mouse.x-this.mouse.x2,r=this.mouse.y-this.mouse.y2;this.mouse.buttons[0]&&this.rotate(n,r),this.mouse.buttons[2]&&this.move(-n,r)}),this.canvas.addEventListener("wheel",i=>{i.preventDefault();let n=i.deltaY;i.deltaMode===1&&(n=n/3*100),this.zoom(n/100)}),this.canvas.addEventListener("touchstart",i=>{i.preventDefault();let n=i.targetTouches;n.length===1?this.touchMode=Kn:n.length==2?this.touchMode=qn:this.touchMode=wt,this.touches.length=0,this.touches.push(...n)}),this.canvas.addEventListener("touchend",i=>{i.preventDefault(),this.touchMode=wt}),this.canvas.addEventListener("touchcancel",i=>{i.preventDefault(),this.touchMode=wt}),this.canvas.addEventListener("touchmove",i=>{i.preventDefault();let n=i.targetTouches;if(this.touchMode===Kn){let r=this.touches[0],o=n[0],a=o.clientX-r.clientX,l=o.clientY-r.clientY;this.rotate(a,l)}else if(this.touchMode===qn){let r=jn(this.touches[0],this.touches[1]),o=jn(n[0],n[1]);this.zoom((r-o)/50)}this.touches.length=0,this.touches.push(...n)})}update(){if(this.instance){let e=this.instance,t=e.model.cameras[0];t.getTranslation($,e.sequence,e.frame,e.counter),d.vec3.add($,$,t.position),t.getTargetTranslation(De,e.sequence,e.frame,e.counter),d.vec3.add(De,De,t.targetPosition),t.getRotation(Gn,e.sequence,e.frame,e.counter),this.twist=Gn[0],d.vec3.transformMat4($,$,e.worldMatrix),d.vec3.transformMat4(De,De,e.worldMatrix),this.moveToAndFace($,De)}else this.updateInternalCamera()}move(e,t){let i=this.camera.directionX,n=this.camera.directionY,r=this.canvas.width,o=this.canvas.height,a=r/o,l=e/r*this.distance*a,c=t/o*this.distance;d.vec3.add(this.target,this.target,d.vec3.scale($,d.vec3.normalize($,d.vec3.set($,i[0],i[1],0)),l)),d.vec3.add(this.target,this.target,d.vec3.scale($,d.vec3.normalize($,d.vec3.set($,n[0],n[1],0)),c)),this.manualChange()}rotate(e,t){this.horizontalAngle-=e*this.rotationSpeed,this.verticalAngle-=t*this.rotationSpeed,this.manualChange()}zoom(e){this.distance=Math.max(1,this.distance*(1+e*this.zoomFactor)),this.manualChange()}manualChange(){this.updateInternalCamera(),this.instance&&(this.instance=null,this.onManualChange&&this.onManualChange())}onResize(){let e=Math.max(this.canvas.clientWidth,1),t=Math.max(this.canvas.clientHeight,1);this.canvas.width=e,this.canvas.height=t,this.scene.viewport[2]=e,this.scene.viewport[3]=t,this.camera.perspective(this.fov,e/t,this.nearClipPlane,this.farClipPlane)}moveToAndFace(e,t){d.vec3.sub($,e,t);let i=d.vec3.length($),n=Math.atan2($[1],$[0]),r=Math.acos($[2]/i);d.vec3.copy(this.target,t),this.verticalAngle=r,this.horizontalAngle=n+Math.PI/2,this.distance=i,this.updateInternalCamera()}updateInternalCamera(){this.verticalAngle=Math.min(Math.max(.01,this.verticalAngle),Math.PI-.01),d.quat.identity(Ne),d.quat.rotateZ(Ne,Ne,this.horizontalAngle),d.quat.rotateX(Ne,Ne,this.verticalAngle),d.vec3.set(this.position,0,0,1),d.vec3.transformQuat(this.position,this.position,Ne),d.vec3.scale(this.position,this.position,this.distance),d.vec3.add(this.position,this.position,this.target);let e=this.twist-Math.PI/2;d.vec3.set($,0,-Math.cos(e),-Math.sin(e)),this.camera.moveToAndFace(this.position,this.target,$)}applyInstanceCamera(e){this.instance=e,this.fov=e.model.cameras[0].fieldOfView,this.onResize(),this.update()}}const Hn=Nn.handlers,Ht=document.getElementById("canvas");Ht.width=800,Ht.height=600;const Ae=new Nn.ModelViewer(Ht),yt=Ae.addScene();vo(yt),Ae.on("loadstart",s=>console.log(s)),Ae.on("load",s=>console.log("load",s)),Ae.on("loadend",s=>console.log("loadend",s)),Ae.on("error",s=>console.log("error",s)),Ae.addHandler(Hn.mdx),Ae.addHandler(Hn.blp);function mo(s){return"/clients/example/resources/"+s}Ae.load("SmileyGW_004.mdx",mo).then(s=>{if(s){const e=s.addInstance();e.setScene(yt),e.setSequence(1),e.setSequenceLoopMode(2);const t=s.addInstance();t.setScene(yt),t.setSequence(0),t.setSequenceLoopMode(2),t.move([100,100,0]),t.uniformScale(.5);const i=s.addInstance();i.setScene(yt),i.setSequence(2),i.setSequenceLoopMode(2),i.move([-100,-100,0])}}),(function s(){requestAnimationFrame(s),Ae.updateAndRender()})()}));
