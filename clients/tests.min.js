(function(Je,m){typeof exports=="object"&&typeof module<"u"?m(require("events"),require("gl-matrix"),require("tga-js")):typeof define=="function"&&define.amd?define(["events","gl-matrix","tga-js"],m):(Je=typeof globalThis<"u"?globalThis:Je||self,m(Je.EventEmitter,Je.glMatrix,Je.TGA))})(this,(function(Je,m,ir){"use strict";const Zi="5.13.0";(function(s,e){typeof define=="function"&&define.amd?define([],e):typeof module=="object"&&module.exports?module.exports=e():s.resemble=e()})(void 0,function(){var s,e;typeof Image<"u"?s=Image:s=e.Image;var t=typeof window<"u"?window.document:{createElement:function(){return new e}},i={},n=i;function r(l){var c="warning resemble.outputSettings mutates global state, and will be removed in 3.0.0";return console.warn(c),n=l,this}var o=function(l){var c=1,d={red:255,green:0,blue:255,alpha:255},h={r:0,g:0,b:0,a:0};function f(b,A){return(Math.abs(b.r-A.r)+Math.abs(b.g-A.g)+Math.abs(b.b-A.b))/3}function p(b,A,_,S,C){return b>(C.left||0)&&b<(C.right||_)&&A>(C.top||0)&&A<(C.bottom||S)}function u(b,A,_,S){var C=!0;return y!==void 0&&!p(b,A,_,S,y)&&(C=!1),R!==void 0&&p(b,A,_,S,R)&&(C=!1),C}var g={flat:function(b,A){b[A]=d.red,b[A+1]=d.green,b[A+2]=d.blue,b[A+3]=d.alpha},movement:function(b,A,_,S){b[A]=(S.r*(d.red/255)+d.red)/2,b[A+1]=(S.g*(d.green/255)+d.green)/2,b[A+2]=(S.b*(d.blue/255)+d.blue)/2,b[A+3]=S.a},flatDifferenceIntensity:function(b,A,_,S){b[A]=d.red,b[A+1]=d.green,b[A+2]=d.blue,b[A+3]=f(_,S)},movementDifferenceIntensity:function(b,A,_,S){var C=f(_,S)/255*.8;b[A]=(1-C)*(S.r*(d.red/255))+C*d.red,b[A+1]=(1-C)*(S.g*(d.green/255))+C*d.green,b[A+2]=(1-C)*(S.b*(d.blue/255))+C*d.blue,b[A+3]=S.a},diffOnly:function(b,A,_,S){b[A]=S.r,b[A+1]=S.g,b[A+2]=S.b,b[A+3]=S.a}},v=g.flat,w,y,R,E=1200,x=!0,T={},L=[],H=[],M={red:16,green:16,blue:16,alpha:16,minBrightness:16,maxBrightness:240},$=!1,ne=!1,D=!1;function ee(){var b=H.length,A;for(A=0;A<b;A++)typeof H[A]=="function"&&H[A](T)}function Y(b,A,_){var S,C;for(S=0;S<b;S++)for(C=0;C<A;C++)_(S,C)}function B(b,A,_){var S=0,C=0,Z=0,pe=0,te=0,re=0,oe=0,Ge=0;Y(A,_,function(xe,Ze){var yt=(Ze*A+xe)*4,Me=b[yt],Te=b[yt+1],ye=b[yt+2],ce=b[yt+3],ae=j(Me,Te,ye);Me===Te&&Me===ye&&ce&&(Me===0?Ge++:Me===255&&oe++),S++,C+=Me/255*100,Z+=Te/255*100,pe+=ye/255*100,te+=(255-ce)/255*100,re+=ae/255*100}),T.red=Math.floor(C/S),T.green=Math.floor(Z/S),T.blue=Math.floor(pe/S),T.alpha=Math.floor(te/S),T.brightness=Math.floor(re/S),T.white=Math.floor(oe/S*100),T.black=Math.floor(Ge/S*100),ee()}function z(b,A){var _,S=new s;S.setAttribute||(S.setAttribute=function(){}),x&&S.setAttribute("crossorigin","anonymous"),S.onerror=function(C){S.onload=null,S.onerror=null,L.push({error:C?C+"":"Image load error."}),A()},S.onload=function(){S.onload=null,S.onerror=null;var C=t.createElement("canvas"),Z,pe=S.width,te=S.height;D&&L.length===1&&(pe=L[0].width,te=L[0].height),C.width=pe,C.height=te,C.getContext("2d").drawImage(S,0,0,pe,te),Z=C.getContext("2d").getImageData(0,0,pe,te),L.push(Z),A(Z,pe,te)},typeof b=="string"?(S.src=b,S.complete&&S.naturalWidth>0&&S.onload()):typeof b.data<"u"&&typeof b.width=="number"&&typeof b.height=="number"?(L.push(b),A(b,b.width,b.height)):typeof Buffer<"u"&&b instanceof Buffer?S.src=b:(_=new FileReader,_.onload=function(C){S.src=C.target.result},_.readAsDataURL(b))}function P(b,A,_){var S=Math.abs(b-A);return typeof b>"u"||typeof A>"u"?!1:b===A?!0:S<M[_]}function V(b,A){var _=P(b.a,A.a,"alpha"),S=P(b.brightness,A.brightness,"minBrightness");return S&&_}function j(b,A,_){return .3*b+.59*A+.11*_}function G(b,A){var _=b.r===A.r,S=b.g===A.g,C=b.b===A.b;return _&&S&&C}function se(b,A){var _=P(b.r,A.r,"red"),S=P(b.g,A.g,"green"),C=P(b.b,A.b,"blue"),Z=P(b.a,A.a,"alpha");return _&&S&&C&&Z}function Ee(b,A){return Math.abs(b.brightness-A.brightness)>M.maxBrightness}function Re(b,A,_){var S=b/255,C=A/255,Z=_/255,pe=Math.max(S,C,Z),te=Math.min(S,C,Z),re,oe;if(pe===te)re=0;else switch(oe=pe-te,pe){case S:re=(C-Z)/oe+(C<Z?6:0);break;case C:re=(Z-S)/oe+2;break;case Z:re=(S-C)/oe+4;break;default:re/=6}return re}function F(b,A,_,S,C,Z){var pe,te=1,re,oe,Ge=0,xe=0,Ze=0;for(le(b),re=te*-1;re<=te;re++)for(oe=te*-1;oe<=te;oe++)if(!(re===0&&oe===0)){if(pe=((S+oe)*Z+(C+re))*4,!ve(h,A,pe))continue;if(X(h),le(h),Ee(b,h)&&Ge++,G(b,h)&&Ze++,Math.abs(h.h-b.h)>.3&&xe++,xe>1||Ge>1)return!0}return Ze<2}function U(b,A,_){w!=="diffOnly"&&(b[A]=_.r,b[A+1]=_.g,b[A+2]=_.b,b[A+3]=_.a*c)}function W(b,A,_){w!=="diffOnly"&&(b[A]=_.brightness,b[A+1]=_.brightness,b[A+2]=_.brightness,b[A+3]=_.a*c)}function ve(b,A,_){return A.length>_?(b.r=A[_],b.g=A[_+1],b.b=A[_+2],b.a=A[_+3],!0):!1}function X(b){b.brightness=j(b.r,b.g,b.b)}function le(b){b.h=Re(b.r,b.g,b.b)}function be(b,A,_,S){var C=t.createElement("canvas"),Z=b.data,pe=A.data;C.width=_,C.height=S;var te=C.getContext("2d"),re=te.createImageData(_,S),oe=re.data,Ge=0,xe={top:S,left:_,bottom:0,right:0},Ze=function(ce,ae){xe.left=Math.min(ce,xe.left),xe.right=Math.max(ce,xe.right),xe.top=Math.min(ae,xe.top),xe.bottom=Math.max(ae,xe.bottom)},yt=Date.now(),Me;E&&$&&(_>E||S>E)&&(Me=6);var Te={r:0,g:0,b:0,a:0},ye={r:0,g:0,b:0,a:0};Y(_,S,function(ce,ae){if(!(Me&&(ae%Me===0||ce%Me===0))){var Qe=(ae*_+ce)*4,Wi=u(ce,ae,_,S);if(!(!ve(Te,Z,Qe)||!ve(ye,pe,Qe))){if(ne){X(Te),X(ye),V(Te,ye)||!Wi?W(oe,Qe,ye):(v(oe,Qe,Te,ye),Ge++,Ze(ce,ae));return}se(Te,ye)||!Wi?U(oe,Qe,Te):$&&(X(Te),X(ye),F(Te,Z,1,ae,ce,_)||F(ye,pe,2,ae,ce,_))&&(V(Te,ye)||!Wi)?W(oe,Qe,ye):(v(oe,Qe,Te,ye),Ge++,Ze(ce,ae))}}}),T.rawMisMatchPercentage=Ge/(S*_)*100,T.misMatchPercentage=T.rawMisMatchPercentage.toFixed(2),T.diffBounds=xe,T.analysisTime=Date.now()-yt,T.getImageDataUrl=function(ce){var ae=0;return ce&&(ae=fe(ce,te,C)),te.putImageData(re,0,ae),C.toDataURL("image/png")},C.toBuffer&&(T.getBuffer=function(ce){if(ce){var ae=C.width+2;C.width=ae*3,te.putImageData(b,0,0),te.putImageData(A,ae,0),te.putImageData(re,ae*2,0)}else te.putImageData(re,0,0);return C.toBuffer()})}function fe(b,A,_){var S=2;A.font="12px sans-serif";var C=A.measureText(b).width+S*2,Z=22;return C>_.width&&(_.width=C),_.height+=Z,A.fillStyle="#666",A.fillRect(0,0,_.width,Z-4),A.fillStyle="#fff",A.fillRect(0,Z-4,_.width,4),A.fillStyle="#fff",A.textBaseline="top",A.font="12px sans-serif",A.fillText(b,S,1),Z}function We(b,A,_){var S,C;return b.height<_||b.width<A?(S=t.createElement("canvas"),S.width=A,S.height=_,C=S.getContext("2d"),C.putImageData(b,0,0),C.getImageData(0,0,A,_)):b}function jt(b){var A;if(b.errorColor)for(A in b.errorColor)b.errorColor.hasOwnProperty(A)&&(d[A]=b.errorColor[A]===void 0?d[A]:b.errorColor[A]);b.errorType&&g[b.errorType]&&(v=g[b.errorType],w=b.errorType),b.errorPixel&&typeof b.errorPixel=="function"&&(v=b.errorPixel),c=isNaN(Number(b.transparency))?c:b.transparency,b.largeImageThreshold!==void 0&&(E=b.largeImageThreshold),b.useCrossOrigin!==void 0&&(x=b.useCrossOrigin),b.boundingBox!==void 0&&(y=b.boundingBox),b.ignoredBox!==void 0&&(R=b.ignoredBox)}function ql(b,A){n!==i&&jt(n);function _(){var S,C;if(L.length===2){if(L[0].error||L[1].error){T={},T.error=L[0].error?L[0].error:L[1].error,ee();return}S=L[0].width>L[1].width?L[0].width:L[1].width,C=L[0].height>L[1].height?L[0].height:L[1].height,L[0].width===L[1].width&&L[0].height===L[1].height?T.isSameDimensions=!0:T.isSameDimensions=!1,T.dimensionDifference={width:L[0].width-L[1].width,height:L[0].height-L[1].height},be(We(L[0],S,C),We(L[1],S,C),S,C),ee()}}L=[],z(b,_),z(A,_)}function er(b){var A,_=typeof b=="function";_||(A=b);var S={scaleToSameSize:function(){return D=!0,_&&b(),S},useOriginalSize:function(){return D=!1,_&&b(),S},ignoreNothing:function(){return M.red=0,M.green=0,M.blue=0,M.alpha=0,M.minBrightness=0,M.maxBrightness=255,$=!1,ne=!1,_&&b(),S},ignoreLess:function(){return M.red=16,M.green=16,M.blue=16,M.alpha=16,M.minBrightness=16,M.maxBrightness=240,$=!1,ne=!1,_&&b(),S},ignoreAntialiasing:function(){return M.red=32,M.green=32,M.blue=32,M.alpha=32,M.minBrightness=64,M.maxBrightness=96,$=!0,ne=!1,_&&b(),S},ignoreColors:function(){return M.alpha=16,M.minBrightness=16,M.maxBrightness=240,$=!1,ne=!0,_&&b(),S},ignoreAlpha:function(){return M.red=16,M.green=16,M.blue=16,M.alpha=255,M.minBrightness=16,M.maxBrightness=240,$=!1,ne=!1,_&&b(),S},repaint:function(){return _&&b(),S},outputSettings:function(C){return jt(C),S},onComplete:function(C){H.push(C);var Z=function(){ql(l,A)};return Z(),er(Z)}};return S}var tr={onComplete:function(b){H.push(b),z(l,function(A,_,S){B(A.data,_,S)})},compareTo:function(b){return er(b)},outputSettings:function(b){return jt(b),tr}};return tr};function a(l,c){switch(c){case"nothing":l.ignoreNothing();break;case"less":l.ignoreLess();break;case"antialiasing":l.ignoreAntialiasing();break;case"colors":l.ignoreColors();break;case"alpha":l.ignoreAlpha();break;default:throw new Error("Invalid ignore: "+c)}}return o.compare=function(l,c,d,h){var f,p;typeof d=="function"?(f=d,p={}):(f=h,p=d||{});var u=o(l),g;p.output&&u.outputSettings(p.output),g=u.compareTo(c),p.scaleToSameSize&&g.scaleToSameSize(),typeof p.ignore=="string"?a(g,p.ignore):p.ignore&&p.ignore.forEach&&p.ignore.forEach(function(v){a(g,v)}),g.onComplete(function(v){v.error?f(v.error):f(null,v)})},o.outputSettings=r,o});const nr=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));function sr(s){return()=>(s=(s*9301+49297)%233280,s/233280)}let Qi,Ji;typeof window=="object"&&(Qi=document.createElement("canvas"),Qi.getContext("2d"),Ji=document.createElement("canvas"),Ji.getContext("2d"));function At(s){return new Promise((e,t)=>{const i=URL.createObjectURL(s),n=new Image;n.onload=()=>{e(n)},n.onerror=r=>{t(r)},n.src=i})}async function en(s,e){if(e==="image")return new Promise(t=>{const i=new Image;i.onload=()=>{t({ok:!0,data:i})},i.onerror=n=>{t({ok:!1,error:"Image Error",data:n})},i.src=s});{let t;try{t=await fetch(s)}catch(i){return{ok:!1,error:"Network Error",data:i}}if(!t.ok)return{ok:!1,error:"Http Error",data:t};try{let i=null;return e==="text"?i=await t.text():e==="arrayBuffer"||e==="bytes"?i=await t.arrayBuffer():e==="blob"&&(i=await t.blob()),e==="bytes"&&(i=new Uint8Array(i)),{ok:!0,data:i}}catch(i){return{ok:!1,error:"Data Error",data:i}}}}class rr{gl;buffer;size=0;arrayBuffer=null;byteView=null;floatView=null;constructor(e,t=4){this.gl=e,this.buffer=e.createBuffer(),this.reserve(t)}reserve(e){if(this.size<e){const t=this.gl;this.size=Math.ceil(e/4)*4,t.bindBuffer(t.ARRAY_BUFFER,this.buffer),t.bufferData(t.ARRAY_BUFFER,this.size,t.DYNAMIC_DRAW),this.arrayBuffer=new ArrayBuffer(this.size),this.byteView=new Uint8Array(this.arrayBuffer),this.floatView=new Float32Array(this.arrayBuffer)}}bindAndUpdate(e=this.size){const t=this.gl,i=this.byteView;t.bindBuffer(t.ARRAY_BUFFER,this.buffer),t.bufferSubData(t.ARRAY_BUFFER,0,i.subarray(0,e))}}class or{gl;texture;width=0;height=0;arrayBuffer=new ArrayBuffer(0);byteView=null;floatView=null;constructor(e,t=1,i=1){this.gl=e,this.texture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),this.reserve(t,i)}reserve(e,t){if(this.width<e||this.height<t){const i=this.gl;this.width=Math.max(this.width,e),this.height=Math.max(this.height,t),i.bindTexture(i.TEXTURE_2D,this.texture),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,this.width,this.height,0,i.RGBA,i.FLOAT,null),this.arrayBuffer=new ArrayBuffer(this.width*this.height*16),this.byteView=new Uint8Array(this.arrayBuffer),this.floatView=new Float32Array(this.arrayBuffer)}}bindAndUpdate(e=this.width,t=this.height){const i=this.gl;i.bindTexture(i.TEXTURE_2D,this.texture),i.texSubImage2D(i.TEXTURE_2D,0,0,0,e,t,i.RGBA,i.FLOAT,this.byteView)}}class pi{gl;texture;format;width=0;height=0;constructor(e,t=4,i=1,n=1){this.gl=e,this.texture=e.createTexture(),this.format=t===3?e.RGB:e.RGBA,e.bindTexture(e.TEXTURE_2D,this.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),this.reserve(i,n)}reserve(e,t){if(this.width<e||this.height<t){const i=this.gl;this.width=Math.max(this.width,e),this.height=Math.max(this.height,t),i.bindTexture(i.TEXTURE_2D,this.texture),i.texImage2D(i.TEXTURE_2D,0,this.format,this.width,this.height,0,this.format,i.FLOAT,null)}}bindAndUpdate(e,t=this.width,i=this.height){const n=this.gl;n.bindTexture(n.TEXTURE_2D,this.texture),n.texSubImage2D(n.TEXTURE_2D,0,0,0,t,i,this.format,n.FLOAT,e)}bind(e){const t=this.gl;t.activeTexture(t.TEXTURE0+e),t.bindTexture(t.TEXTURE_2D,this.texture)}}class ar{webgl;program;uniforms={};attribs={};attribsCount=0;constructor(e,t){this.webgl=e,this.program=t;const i=e.gl;for(let n=0,r=i.getProgramParameter(t,i.ACTIVE_UNIFORMS);n<r;n++){const o=i.getActiveUniform(t,n);if(o)if(o.size===1)this.uniforms[o.name]=i.getUniformLocation(t,o.name);else{const a=o.name.substr(0,o.name.length-3);for(let l=0;l<o.size;l++){const c=a+"["+l+"]";this.uniforms[c]=i.getUniformLocation(t,c)}}}for(let n=0,r=i.getProgramParameter(t,i.ACTIVE_ATTRIBUTES);n<r;n++){const o=i.getActiveAttrib(t,n);if(o)if(this.attribsCount+=o.size,o.size===1)this.attribs[o.name]=i.getAttribLocation(t,o.name);else{const a=o.name.substr(0,o.name.length-3);for(let l=0;l<o.size;l++){const c=a+"["+l+"]";this.attribs[c]=i.getAttribLocation(t,c)}}}}use(){this.webgl.useShader(this)}}class lr{gl;currentShader=null;emptyTexture;extensions={};constructor(e,t={alpha:!1}){let i=e.getContext("webgl",t);if(i||(i=e.getContext("experimental-webgl",t)),!i)throw new Error("WebGL: Failed to create a WebGL context!");const n=new Uint8ClampedArray(16).fill(255),r=i.createTexture();i.bindTexture(i.TEXTURE_2D,r),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,2,2,0,i.RGBA,i.UNSIGNED_BYTE,n),this.gl=i,this.emptyTexture=r}ensureExtension(e){const t=this.gl.getExtension(e);return t?(this.extensions[e]=t,!0):!1}createShader(e,t){const i=this.gl,n=i.createShader(i.VERTEX_SHADER);i.shaderSource(n,e),i.compileShader(n);const r=i.createShader(i.FRAGMENT_SHADER);i.shaderSource(r,t),i.compileShader(r);const o=i.createProgram();if(i.attachShader(o,n),i.attachShader(o,r),i.linkProgram(o),!i.getProgramParameter(o,i.LINK_STATUS)){let a="Shader failed to link:";const l=i.getShaderInfoLog(n);l&&l.length&&(a+=` Vertex shader: ${l}`);const c=i.getShaderInfoLog(r);throw c&&c.length&&(a+=` Fragment shader: ${c}`),new Error(a)}return new ar(this,o)}enableVertexAttribs(e,t){const i=this.gl;for(let n=e;n<t;n++)i.enableVertexAttribArray(n)}disableVertexAttribs(e,t){const i=this.gl;for(let n=e;n<t;n++)i.disableVertexAttribArray(n)}useShader(e){if(e&&e!==this.currentShader){let t=0;const i=e.attribsCount;this.currentShader&&(t=this.currentShader.attribsCount),this.gl.useProgram(e.program),i>t?this.enableVertexAttribs(t,i):i<t&&this.disableVertexAttribs(i,t),this.currentShader=e}}bindTexture(e,t){const i=this.gl;i.activeTexture(i.TEXTURE0+t),e?i.bindTexture(i.TEXTURE_2D,e.webglResource):i.bindTexture(i.TEXTURE_2D,this.emptyTexture)}bindTextureAndWrap(e,t,i,n){const r=this.gl;r.activeTexture(r.TEXTURE0+t),e?r.bindTexture(r.TEXTURE_2D,e.webglResource):r.bindTexture(r.TEXTURE_2D,this.emptyTexture),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,i),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,n)}setTextureMode(e,t,i,n){const r=this.gl;r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,e),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,t),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,i),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,n)}createClientBuffer(e=4){return new rr(this.gl,e)}createDataTexture(e=4,t=1,i=1){return new pi(this.gl,e,t,i)}createClientDataTexture(e=1,t=1){return new or(this.gl,e,t)}}const mi=m.vec3.fromValues(1,0,0),tn=m.vec3.fromValues(0,1,0),Tt=m.vec3.fromValues(0,0,1),at=m.vec3.create(),gi=m.vec3.fromValues(1,1,1);m.quat.fromValues(0,0,0,0);const vi=m.quat.create(),qe=m.vec4.create();function nn(s,e,t,i){const n=2*(e[0]-i[0])/i[2]-1,r=1-2*(e[1]-i[1])/i[3],o=2*e[2]-1;return m.vec4.set(qe,n,r,o,1),m.vec4.transformMat4(qe,qe,t),m.vec3.set(s,qe[0]/qe[3],qe[1]/qe[3],qe[2]/qe[3]),s}function Kt(s,e,t){return s[0]*e+s[1]*t+s[3]}function sn(s,e,t,i){return s[0]*e+s[1]*t+s[2]*i+s[3]}function cr(s,e,t,i,n,r){r===-1&&(r=0);for(let o=0;o<6;o++){const a=(r+o)%6;if(sn(s[a],e,t,i)<=-n)return a}return-1}function hr(s,e,t,i,n,r){r===-1&&(r=0);for(let o=0;o<6;o++){const a=(r+o)%6,l=s[a];if(Kt(l,e,i)<0&&Kt(l,e,n)<0&&Kt(l,t,n)<0&&Kt(l,t,i)<0)return a}return-1}function dr(s){return Math.hypot(s[0],s[1],s[2])}function lt(s,e){const t=dr(e);s[0]=e[0]/t,s[1]=e[1]/t,s[2]=e[2]/t,s[3]=e[3]/t}function ur(s,e){const t=e[0],i=e[4],n=e[8],r=e[12],o=e[1],a=e[5],l=e[9],c=e[13],d=e[2],h=e[6],f=e[10],p=e[14],u=e[3],g=e[7],v=e[11],w=e[15];let y;y=s[0],y[0]=u+t,y[1]=g+i,y[2]=v+n,y[3]=w+r,y=s[1],y[0]=u-t,y[1]=g-i,y[2]=v-n,y[3]=w-r,y=s[2],y[0]=u-o,y[1]=g-a,y[2]=v-l,y[3]=w-c,y=s[3],y[0]=u+o,y[1]=g+a,y[2]=v+l,y[3]=w+c,y=s[4],y[0]=u+d,y[1]=g+h,y[2]=v+f,y[3]=w+p,y=s[5],y[0]=u-d,y[1]=g-h,y[2]=v-f,y[3]=w-p,lt(s[0],s[0]),lt(s[1],s[1]),lt(s[2],s[2]),lt(s[3],s[3]),lt(s[4],s[4]),lt(s[5],s[5])}const he=m.vec3.create(),me=m.vec3.create(),Ae=m.vec3.create();function rn(s,e,t,i){m.vec3.normalize(he,m.vec3.sub(he,t,e)),m.vec3.normalize(me,m.vec3.cross(me,i,he)),m.vec3.cross(Ae,me,he);const n=me[0]+Ae[2]+he[1];if(n>0){const r=.5/Math.sqrt(n+1);s[3]=.25/r,s[0]=(Ae[1]-he[2])*r,s[2]=(he[0]-me[1])*r,s[1]=(me[2]-Ae[0])*r}else if(me[0]>Ae[2]&&me[0]>he[1]){const r=2*Math.sqrt(1+me[0]-Ae[2]-he[1]);s[3]=(Ae[1]-he[2])/r,s[0]=.25*r,s[2]=(Ae[0]+me[2])/r,s[1]=(he[0]+me[1])/r}else if(Ae[2]>he[1]){const r=2*Math.sqrt(1+Ae[2]-me[0]-he[1]);s[3]=(he[0]-me[1])/r,s[0]=(Ae[0]+me[2])/r,s[2]=.25*r,s[1]=(he[2]+Ae[1])/r}else{const r=2*Math.sqrt(1+he[1]-me[0]-Ae[2]);s[3]=(me[2]-Ae[0])/r,s[0]=(he[0]+me[1])/r,s[2]=(he[2]+Ae[1])/r,s[1]=.25*r}return s}const St=m.vec3.create(),fr=m.vec3.create(),pr=m.vec3.create(),mr=m.quat.create(),gr=m.quat.setAxisAngle(m.quat.create(),mi,Math.PI/2);let vr=class{isPerspective=!0;fov=0;aspect=0;isOrtho=!1;leftClipPlane=0;rightClipPlane=0;bottomClipPlane=0;topClipPlane=0;nearClipPlane=0;farClipPlane=0;location=m.vec3.create();rotation=m.quat.create();inverseRotation=m.quat.create();viewMatrix=m.mat4.create();projectionMatrix=m.mat4.create();viewProjectionMatrix=m.mat4.create();inverseViewMatrix=m.mat4.create();inverseViewProjectionMatrix=m.mat4.create();directionX=m.vec3.create();directionY=m.vec3.create();directionZ=m.vec3.create();vectors=[m.vec3.fromValues(-1,-1,0),m.vec3.fromValues(-1,1,0),m.vec3.fromValues(1,1,0),m.vec3.fromValues(1,-1,0),m.vec3.fromValues(1,0,0),m.vec3.fromValues(0,1,0),m.vec3.fromValues(0,0,1)];billboardedVectors=[m.vec3.create(),m.vec3.create(),m.vec3.create(),m.vec3.create(),m.vec3.create(),m.vec3.create(),m.vec3.create()];planes=[m.vec4.create(),m.vec4.create(),m.vec4.create(),m.vec4.create(),m.vec4.create(),m.vec4.create()];perspective(e,t,i,n){this.isPerspective=!0,this.isOrtho=!1,this.fov=e,this.aspect=t,this.nearClipPlane=i,this.farClipPlane=n,this.update()}ortho(e,t,i,n,r,o){this.isPerspective=!1,this.isOrtho=!0,this.leftClipPlane=e,this.rightClipPlane=t,this.bottomClipPlane=i,this.topClipPlane=n,this.nearClipPlane=r,this.farClipPlane=o,this.update()}setLocation(e){m.vec3.copy(this.location,e),this.update()}move(e){m.vec3.add(this.location,this.location,e),this.update()}setRotation(e){m.quat.copy(this.rotation,e),this.update()}rotate(e){m.quat.mul(this.rotation,this.rotation,e),this.update()}face(e,t){m.quat.mul(this.rotation,gr,rn(mr,e,this.location,t)),this.update()}moveToAndFace(e,t,i){m.vec3.copy(this.location,e),this.face(t,i)}reset(){m.vec3.set(this.location,0,0,0),m.quat.identity(this.rotation),this.update()}update(){const e=this.location,t=this.rotation,i=this.inverseRotation,n=this.viewMatrix,r=this.projectionMatrix,o=this.viewProjectionMatrix,a=this.vectors,l=this.billboardedVectors;this.isPerspective?m.mat4.perspective(r,this.fov,this.aspect,this.nearClipPlane,this.farClipPlane):m.mat4.ortho(r,this.leftClipPlane,this.rightClipPlane,this.bottomClipPlane,this.topClipPlane,this.nearClipPlane,this.farClipPlane),m.mat4.fromQuat(n,t),m.mat4.translate(n,n,m.vec3.negate(St,e)),m.mat4.mul(o,r,n),m.mat4.invert(this.inverseViewMatrix,n),m.mat4.invert(this.inverseViewProjectionMatrix,o),ur(this.planes,o),m.quat.conjugate(i,t),m.vec3.transformQuat(this.directionX,mi,i),m.vec3.transformQuat(this.directionY,tn,i),m.vec3.transformQuat(this.directionZ,Tt,i);for(let c=0;c<7;c++)m.vec3.transformQuat(l[c],a[c],i)}cameraToWorld(e,t){return m.vec3.transformMat4(e,t,this.inverseViewMatrix)}worldToCamera(e,t){return m.vec3.transformMat4(e,t,this.viewMatrix)}worldToScreen(e,t,i){return m.vec3.transformMat4(St,t,this.viewProjectionMatrix),e[0]=Math.round((St[0]+1)/2*i[2]),e[1]=Math.round((St[1]+1)/2*i[3]),e}screenToWorldRay(e,t,i){const n=St,r=fr,o=pr,a=t[0],l=t[1],c=this.inverseViewProjectionMatrix;return nn(n,m.vec3.set(o,a,l,0),c,i),nn(r,m.vec3.set(o,a,l,1),c,i),e.set(n,0),e.set(r,3),e}};class br{left;right;bottom;top;plane=-1;instances=[];visible=!1;constructor(e,t,i,n){this.left=e,this.right=t,this.bottom=i,this.top=n}add(e){this.instances.push(e)}remove(e){const t=this.instances.indexOf(e);this.instances.splice(t,1)}clear(){this.instances.length=0}isVisible(e){return this.plane=hr(e.planes,this.left,this.right,this.bottom,this.top,this.plane),this.plane===-1}}class wr{x;y;width;depth;cellWidth;cellDepth;columns;rows;cells=[];constructor(e,t,i,n,r,o){const a=i/r,l=n/o;this.x=e,this.y=t,this.width=i,this.depth=n,this.cellWidth=r,this.cellDepth=o,this.columns=a,this.rows=l;for(let c=0;c<l;c++)for(let d=0;d<a;d++){const h=e+d*r,f=h+r,p=t+c*o,u=p+o;this.cells[c*a+d]=new br(h,f,p,u)}}add(e){const t=this.cells,i=this.columns,n=e.left,r=e.right+1,o=e.bottom,a=e.top+1;if(n!==-1)for(let l=o;l<a;l++)for(let c=n;c<r;c++)t[l*i+c].add(e)}remove(e){const t=this.cells,i=this.columns,n=e.left,r=e.right+1,o=e.bottom,a=e.top+1;if(n!==-1){e.left=-1;for(let l=o;l<a;l++)for(let c=n;c<r;c++)t[l*i+c].remove(e)}}moved(e){const t=this.cellWidth,i=this.cellDepth,n=e.model.bounds,r=e.worldLocation[0]+n.x-this.x,o=e.worldLocation[1]+n.y-this.y,a=n.r,l=e.worldScale;let c=Math.floor((r-a*l[0])/t),d=Math.floor((r+a*l[0])/t),h=Math.floor((o-a*l[1])/i),f=Math.floor((o+a*l[1])/i);d<0||c>this.columns-1||f<0||h>this.rows-1?this.remove(e):(c=Math.max(c,0),d=Math.min(d,this.columns-1),h=Math.max(h,0),f=Math.min(f,this.rows-1),(c!==e.left||d!==e.right||h!==e.bottom||f!==e.top)&&(this.remove(e),e.left=c,e.right=d,e.bottom=h,e.top=f,this.add(e)))}clear(){for(const e of this.cells)e.clear()}}class yr{objects=[];alive=0;add(e){this.objects[this.alive++]=e}update(e){const t=this.objects;for(let i=0;i<this.alive;i++){const n=t[i];n.update(e*n.emitter.instance.timeScale),n.health<=0&&(this.alive-=1,n.emitter.kill(n),i!==this.alive&&(t[i]=t[this.alive],i-=1))}}}class Ar{viewer;camera=new vr;grid=new wr(-1e5,-1e5,2e5,2e5,2e5,2e5);visibleCells=0;visibleInstances=0;updatedParticles=0;audioEnabled=!1;audioContext=null;instances=[];emittedObjectUpdater=new yr;alpha=!1;color=m.vec3.create();viewport=m.vec4.create();lightPosition=m.vec3.fromValues(0,0,1e4);constructor(e){this.viewer=e;const t=e.canvas,i=t.width,n=t.height;this.viewport[2]=i,this.viewport[3]=n,this.camera.perspective(Math.PI/4,i/n,8,1e4)}async enableAudio(){return typeof AudioContext=="function"?(this.audioContext||(this.audioContext=new AudioContext),this.audioContext.state!=="suspended"&&await this.audioContext.resume(),this.audioEnabled=this.audioContext.state==="running",this.audioEnabled):!1}disableAudio(){this.audioContext&&this.audioContext.suspend(),this.audioEnabled=!1}addInstance(e){return e.scene!==this?(e.scene&&e.scene.removeInstance(e),e.scene=this,this.grid.moved(e),!0):!1}removeInstance(e){return e.scene===this?(this.grid.remove(e),e.scene=null,!0):!1}clear(){for(const e of this.grid.cells)for(const t of e.instances)t.scene=null;this.grid.clear()}detach(){return this.viewer?this.viewer.removeScene(this):!1}update(e){const t=this.camera;if(this.audioContext){const r=this.audioContext.listener,o=t.location,a=t.directionY,l=t.directionZ;r.positionX.value=-o[0],r.positionY.value=-o[1],r.positionZ.value=-o[2],r.forwardX.value=a[0],r.forwardY.value=a[1],r.forwardZ.value=a[2],r.upX.value=l[0],r.upY.value=l[1],r.upZ.value=l[2]}const i=this.viewer.frame,n=this.instances;this.visibleCells=0,this.visibleInstances=0;for(const r of this.grid.cells)if(r.isVisible(t)){this.visibleCells+=1;for(const o of r.instances)o.rendered&&o.updateFrame<i&&!o.parent&&(o.updateFrame=i,o.update(e))}n.length=this.visibleInstances,n.sort((r,o)=>r.depth-o.depth),this.emittedObjectUpdater.update(e),this.updatedParticles=this.emittedObjectUpdater.alive}renderInstance(e){this.instances[this.visibleInstances++]=e}startFrame(){const e=this.viewer.gl,t=this.viewport;if(e.viewport(t[0],t[1],t[2],t[3]),e.scissor(t[0],t[1],t[2],t[3]),!this.alpha){const i=this.color;e.depthMask(!0),e.clearColor(i[0],i[1],i[2],1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)}}renderOpaque(){const e=this.instances;for(let t=0,i=e.length;t<i;t++)e[t].renderOpaque()}renderTranslucent(){const e=this.instances;for(let t=e.length-1;t>=0;t--)e[t].renderTranslucent()}render(){this.startFrame(),this.renderOpaque(),this.renderTranslucent()}clearEmittedObjects(){for(const e of this.emittedObjectUpdater.objects)e.health=0}}class bi{viewer;fetchUrl;blockers=[];constructor(e){this.viewer=e.viewer,this.fetchUrl=e.fetchUrl}detach(){return this.viewer.unload(this)}}class Tr extends bi{data=null;constructor(e,t){super(t),this.data=e}}function Sr(s){return s*(Math.PI/180)}function $e(s,e){return s+Math.random()*(e-s)}function Er(s,e,t){return Math.min(Math.max(s,e),t)}function on(s,e,t){return s+t*(e-s)}function xr(s,e,t,i,n){const r=n*n,o=r*(2*n-3)+1,a=r*(n-2)+n,l=r*(n-1),c=r*(3-2*n);return s*o+e*a+t*l+i*c}function _r(s,e,t,i,n){const r=1-n,o=n*n,a=r*r,l=a*r,c=3*n*a,d=3*o*r,h=o*n;return s*l+e*c+t*d+i*h}function ct(s){return s===0?!1:(s&s-1)===0}function Ir(s){return s instanceof ArrayBuffer&&(s=new Uint8Array(s)),s instanceof Uint8Array&&s[0]===137&&s[1]===80&&s[2]===78&&s[3]===71&&s[4]===13&&s[5]===10&&s[6]===26&&s[7]===10}function Cr(s){return s instanceof ArrayBuffer&&(s=new Uint8Array(s)),s instanceof Uint8Array&&s[0]===255&&s[1]===216&&s[s.length-2]===255&&s[s.length-1]===217}function Lr(s){return s instanceof ArrayBuffer&&(s=new Uint8Array(s)),s instanceof Uint8Array&&s[0]===71&&s[1]===73&&s[2]===70&&s[3]===56&&(s[4]===55||s[4]===57)&&s[5]===97}function Rr(s){return s instanceof ArrayBuffer&&(s=new Uint8Array(s)),s instanceof Uint8Array&&s[0]===82&&s[1]===73&&s[2]===70&&s[3]===70&&s[8]===87&&s[9]===69&&s[10]===66&&s[11]===80}class an extends bi{pathSolver;constructor(e){super(e),this.pathSolver=e.pathSolver}}let Ht=class extends an{webglResource=null;width=0;height=0};function Br(s){return s instanceof ImageData||s instanceof HTMLImageElement||s instanceof HTMLCanvasElement||s instanceof HTMLVideoElement}function Fr(s){return Ir(s)?"image/png":Cr(s)?"image/jpeg":Lr(s)?"image/gif":Rr(s)?"image/webp":""}class ln extends Ht{constructor(e,t){super(t);const i=this.viewer.gl;this.webglResource=i.createTexture(),i.bindTexture(i.TEXTURE_2D,this.webglResource),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),ct(e.width)&&ct(e.height)?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR_MIPMAP_LINEAR),i.generateMipmap(i.TEXTURE_2D)):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE)),this.width=e.width,this.height=e.height}}var N=(s=>(s[s.None=0]="None",s[s.Diffuse=1]="Diffuse",s[s.NormalMap=2]="NormalMap",s[s.Occlusion=3]="Occlusion",s[s.Roughness=4]="Roughness",s[s.Metallic=5]="Metallic",s[s.TCFactor=6]="TCFactor",s[s.Emissive=7]="Emissive",s[s.TexCoords=8]="TexCoords",s[s.Normals=9]="Normals",s[s.Tangents=10]="Tangents",s))(N||{});class kr extends Je.EventEmitter{canvas;gl;webgl;resources=[];resourceMap=new Map;promiseMap=new Map;handlers=new Set;scenes=[];frame=0;visibleCells=0;visibleInstances=0;updatedParticles=0;audioEnabled=!1;buffer;sharedCache=new Map;debugRenderMode=0;directLoadId=0;constructor(e,t){super();const i=new lr(e,t),n=i.gl;this.canvas=e,this.gl=n,this.webgl=i,this.buffer=i.createClientBuffer(),n.depthFunc(n.LEQUAL),n.enable(n.DEPTH_TEST),n.enable(n.SCISSOR_TEST)}enableAudio(){return typeof AudioContext=="function"?(this.audioEnabled=!0,!0):!1}addHandler(e,...t){if(e){const i=this.handlers;if(!i.has(e)){if(!e.isValidSource)return this.emit("error",{viewer:this,error:"Handler missing the isValidSource function",handler:e}),!1;if(e.load)try{e.load(this,...t)}catch(n){return this.emit("error",{viewer:this,error:"Handler failed to load",handler:e,reason:n}),!1}return i.add(e),!0}}return!1}addScene(){const e=new Ar(this);return this.scenes.push(e),e}removeScene(e){const t=this.scenes,i=t.indexOf(e);return i!==-1?(t.splice(i,1),!0):!1}clear(){this.scenes.length=0}async load(e,t,i){let n,r="",o;if(t)try{n=t(e,i)}catch(a){this.emit("error",{viewer:this,error:"Path solver failed",src:e,reason:a,pathSolver:t,solverParams:i});return}else n=e;if(n){if(n instanceof Promise&&(n=await n),n instanceof bi)return n;if(typeof n=="string"&&!this.detectFormat(n)){if(r=n,o=this.promiseMap.get(r),o)return o;const a=this.resourceMap.get(r);if(a)return a;o=en(r,"arrayBuffer").then(l=>{if(l.ok)return l.data;this.emit("error",{viewer:this,error:`Failed to fetch a resource: ${l.error}`,fetchUrl:r,reason:l.data})})}else r=`__DIRECT_LOAD_${this.directLoadId++}`,o=Promise.resolve(n);return o=o.then(async a=>{if(a){if(a instanceof ArrayBuffer&&(a=new Uint8Array(a)),Br(a))return new ln(a,{viewer:this,fetchUrl:r,pathSolver:t});if(a instanceof Uint8Array){const c=Fr(a);if(c.length)return new ln(await At(new Blob([a.buffer],{type:c})),{viewer:this,fetchUrl:r,pathSolver:t})}const l=this.detectFormat(a);if(l)try{const c=new l.resource(a,{viewer:this,fetchUrl:r,pathSolver:t});return await Promise.all(c.blockers),c.blockers.length=0,c}catch(c){this.emit("error",{viewer:this,error:"Failed to create a resource",fetchUrl:r,src:e,reason:c})}else this.emit("error",{viewer:this,error:"Source has no matching handler",fetchUrl:r,src:e})}}).then(a=>(this.promiseMap.delete(r),a&&(this.resourceMap.set(r,a),this.resources.push(a),this.emit("load",{viewer:this,fetchUrl:r,resource:a})),this.emit("loadend",{viewer:this,fetchUrl:r,resource:a}),this.checkLoadingStatus(),a)),this.promiseMap.set(r,o),this.emit("loadstart",{viewer:this,fetchUrl:r,promise:o}),o}}detectFormat(e){for(const t of this.handlers)if(t.isValidSource(e))return t}has(e){return this.resourceMap.has(e)}get(e){return this.resourceMap.get(e)}async loadGeneric(e,t,i){const n=this.promiseMap.get(e);if(n)return n;const r=this.resourceMap.get(e);if(r)return r;const o=en(e,t).then(async a=>{this.promiseMap.delete(e);let l;if(a.ok){let c=a.data;i&&(c=await i(c)),l=new Tr(c,{viewer:this,fetchUrl:e}),this.resourceMap.set(e,l),this.resources.push(l),this.emit("load",{viewer:this,fetchUrl:e,resource:l})}else this.emit("error",{viewer:this,error:"Failed to fetch a generic resource",fetchUrl:e});return this.emit("loadend",{viewer:this,fetchUrl:e,resource:l}),this.checkLoadingStatus(),l});return this.promiseMap.set(e,o),this.emit("loadstart",{viewer:this,fetchUrl:e}),o}unload(e){const t=e.fetchUrl;t!==""&&this.resourceMap.delete(t);const i=this.resources,n=i.indexOf(e);return n!==-1?(i.splice(n,1),!0):!1}promise(){const e=Promise.resolve(void 0),t=`${performance.now()}`;return this.promiseMap.set(t,e),()=>{this.promiseMap.delete(t),this.checkLoadingStatus()}}checkLoadingStatus(){this.promiseMap.size===0&&setTimeout(()=>this.emit("idle"),0)}whenAllLoaded(e){const t=new Promise(i=>{this.promiseMap.size===0?i(this):this.once("idle",()=>i(this))});if(e)t.then(()=>e(this));else return t}toBlob(e){const t=new Promise(i=>this.canvas.toBlob(n=>i(n)));if(e)t.then(i=>e(i));else return t}updateAndRender(e=1e3/60){this.update(e),this.startFrame(),this.render()}update(e=1e3/60){e*=.001,this.frame+=1,this.visibleCells=0,this.visibleInstances=0,this.updatedParticles=0;for(const t of this.scenes)t.update(e),this.visibleCells+=t.visibleCells,this.visibleInstances+=t.visibleInstances,this.updatedParticles+=t.updatedParticles}startFrame(){const e=this.gl;e.depthMask(!0),e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)}render(){for(const e of this.scenes)e.render()}clearEmittedObjects(){for(const e of this.scenes)e.clearEmittedObjects()}}function Pr(s){if(s&&s.length){const e=s.lastIndexOf(".");return e!==-1&&(s=s.slice(e).toLowerCase()),s}return""}let wi;typeof OfflineAudioContext=="function"&&(wi=new OfflineAudioContext(1,1,48e3));async function Mr(s){if(wi)return wi.decodeAudioData(s)}const Ur=new TextDecoder,Or=new TextEncoder;function yi(s){return Ur.decode(s)}function Ai(s){return Or.encode(s)}function Et(s){return s instanceof Uint8Array?s:typeof s=="string"?Ai(s):new Uint8Array(s)}function cn(s,e,t=0,i=1/0){const n=Math.max(t,0),r=Math.min(n+i,s.length);let o=0,a=e.charCodeAt(0);for(let l=n;l<r;l++)if(s[l]===a){if(o+=1,o===e.length)return!0;a=e.charCodeAt(o)}else o>0&&(o=0,a=e.charCodeAt(0));return!1}function Dr(s,e,t=0,i=1/0){const n=Math.max(t,0),r=Math.min(n+i,s.length);let o=0,a=e[0];for(let l=n;l<r;l++)if(s[l]===a){if(o+=1,o===e.length)return!0;a=e[o]}else o>0&&(o=0,a=e[0]);return!1}function Nr(s,e,t=0,i=1/0){const n=Math.max(t,0),r=Math.min(n+i,s.length);for(let o=n;o<r;o++)if(s[o]===e)return o;return-1}const Xe=new ArrayBuffer(8),hn=new Int8Array(Xe),dn=new Int16Array(Xe),un=new Int32Array(Xe),O=new Uint8Array(Xe),fn=new Uint16Array(Xe),pn=new Uint32Array(Xe),mn=new Float32Array(Xe),gn=new Float64Array(Xe);function vn(s){return O[0]=s,hn[0]}function bn(s,e){return O[0]=s,O[1]=e,dn[0]}function wn(s,e,t,i){return O[0]=s,O[1]=e,O[2]=t,O[3]=i,un[0]}function yn(s,e){return O[0]=s,O[1]=e,fn[0]}function An(s,e,t,i){return O[0]=s,O[1]=e,O[2]=t,O[3]=i,pn[0]}function Tn(s,e,t,i){return O[0]=s,O[1]=e,O[2]=t,O[3]=i,mn[0]}function Sn(s,e,t,i,n,r,o,a){return O[0]=s,O[1]=e,O[2]=t,O[3]=i,O[4]=n,O[5]=r,O[6]=o,O[7]=a,gn[0]}function En(s){return O[0]=s,hn[0]}function xn(s,e){return dn[0]=e,s[0]=O[0],s[1]=O[1],s}function _n(s,e){return un[0]=e,s[0]=O[0],s[1]=O[1],s[2]=O[2],s[3]=O[3],s}function In(s,e){return fn[0]=e,s[0]=O[0],s[1]=O[1],s}function Cn(s,e){return pn[0]=e,s[0]=O[0],s[1]=O[1],s[2]=O[2],s[3]=O[3],s}function Ln(s,e){return mn[0]=e,s[0]=O[0],s[1]=O[1],s[2]=O[2],s[3]=O[3],s}function Rn(s,e){return gn[0]=e,s[0]=O[0],s[1]=O[1],s[2]=O[2],s[3]=O[3],s[4]=O[4],s[5]=O[5],s[6]=O[6],s[7]=O[7],s}function Vr(s){const e=[];for(;s>0;)e.push(String.fromCharCode(s%256)),s=Math.floor(s/256);return e.reverse().join("")}const k=new Uint8Array(8);class xt{buffer;uint8array;index=0;byteLength;remaining;constructor(e,t,i){const n=Et(e);t=t||0,i=i||n.length,this.buffer=e,this.uint8array=n.subarray(t,t+i),this.byteLength=i,this.remaining=i}substream(e){if(this.remaining<e)throw new Error(`ByteStream: substream: want ${e} bytes but have ${this.remaining}`);const t=this.index;return this.index+=e,new xt(this.uint8array.subarray(t,t+e))}skip(e){if(this.remaining<e)throw new Error(`ByteStream: skip: premature end - want ${e} bytes but have ${this.remaining}`);this.index+=e,this.remaining-=e}seek(e){this.index=e,this.remaining=this.byteLength-e}read(e){if(this.remaining<e)throw new Error(`ByteStream: read: premature end - want ${e} bytes but have ${this.remaining}`);const t=this.uint8array,i=this.index;let n=Nr(t,0,i,e);return n===-1&&(n=i+e),this.index+=e,this.remaining-=e,yi(t.subarray(i,n))}readNull(){if(this.remaining<1)throw new Error("ByteStream: readNull: premature end - want at least 1 byte but have 0");const e=this.uint8array,t=this.index;let i=e.indexOf(0,t);i===-1&&(i=e.length-1);const n=i-t+1;return this.index+=n,this.remaining-=n,yi(e.subarray(t,i))}readBinary(e){if(this.remaining<e)throw new Error(`ByteStream: readBinary: premature end - want ${e} bytes but have ${this.remaining}`);const t=this.uint8array,i=this.index;let n="";for(let r=0;r<e;r++)n+=String.fromCharCode(t[i+r]);return this.index+=e,this.remaining-=e,n}readInt8(){if(this.remaining<1)throw new Error(`ByteStream: readInt8: premature end - want 1 byte but have ${this.remaining}`);const e=this.index,t=this.uint8array,i=vn(t[e]);return this.index+=1,this.remaining-=1,i}readInt16(){if(this.remaining<2)throw new Error(`ByteStream: readInt16: premature end - want 2 bytes but have ${this.remaining}`);const e=this.index,t=this.uint8array,i=bn(t[e],t[e+1]);return this.index+=2,this.remaining-=2,i}readInt32(){if(this.remaining<4)throw new Error(`ByteStream: readInt32: premature end - want 4 bytes but have ${this.remaining}`);const e=this.index,t=this.uint8array,i=wn(t[e],t[e+1],t[e+2],t[e+3]);return this.index+=4,this.remaining-=4,i}readUint8(){if(this.remaining<1)throw new Error(`ByteStream: readUint8: premature end - want 1 byte but have ${this.remaining}`);const e=this.uint8array[this.index];return this.index+=1,this.remaining-=1,e}readUint16(){if(this.remaining<2)throw new Error(`ByteStream: readUint16: premature end - want 2 bytes but have ${this.remaining}`);const e=this.index,t=this.uint8array,i=yn(t[e],t[e+1]);return this.index+=2,this.remaining-=2,i}readUint32(){if(this.remaining<4)throw new Error(`ByteStream: readUint32: premature end - want 4 bytes but have ${this.remaining}`);const e=this.index,t=this.uint8array,i=An(t[e],t[e+1],t[e+2],t[e+3]);return this.index+=4,this.remaining-=4,i}readFloat32(){if(this.remaining<4)throw new Error(`ByteStream: readFloat32: premature end - want 4 bytes but have ${this.remaining}`);const e=this.index,t=this.uint8array,i=Tn(t[e],t[e+1],t[e+2],t[e+3]);return this.index+=4,this.remaining-=4,i}readFloat64(){if(this.remaining<8)throw new Error(`ByteStream: readFloat64: premature end - want 8 bytes but have ${this.remaining}`);const e=this.index,t=this.uint8array,i=Sn(t[e],t[e+1],t[e+2],t[e+3],t[e+4],t[e+5],t[e+6],t[e+7]);return this.index+=8,this.remaining-=8,i}readInt8Array(e){if(ArrayBuffer.isView(e)||(e=new Int8Array(e)),this.remaining<e.byteLength)throw new Error(`ByteStream: readInt8Array: premature end - want ${e.byteLength} bytes but have ${this.remaining}`);const t=this.index,i=this.uint8array;for(let n=0,r=e.length;n<r;n++)e[n]=vn(i[t+n]);return this.index+=e.byteLength,this.remaining-=e.byteLength,e}readInt16Array(e){if(ArrayBuffer.isView(e)||(e=new Int16Array(e)),this.remaining<e.byteLength)throw new Error(`ByteStream: readInt16Array: premature end - want ${e.byteLength} bytes but have ${this.remaining}`);const t=this.index,i=this.uint8array;for(let n=0,r=e.length;n<r;n++){const o=t+n*2;e[n]=bn(i[o],i[o+1])}return this.index+=e.byteLength,this.remaining-=e.byteLength,e}readInt32Array(e){if(ArrayBuffer.isView(e)||(e=new Int32Array(e)),this.remaining<e.byteLength)throw new Error(`ByteStream: readInt32Array: premature end - want ${e.byteLength} bytes but have ${this.remaining}`);const t=this.index,i=this.uint8array;for(let n=0,r=e.length;n<r;n++){const o=t+n*4;e[n]=wn(i[o],i[o+1],i[o+2],i[o+3])}return this.index+=e.byteLength,this.remaining-=e.byteLength,e}readUint8Array(e){if(ArrayBuffer.isView(e)||(e=new Uint8Array(e)),this.remaining<e.byteLength)throw new Error(`ByteStream: readUint8Array: premature end - want ${e.byteLength} bytes but have ${this.remaining}`);const t=this.index,i=this.uint8array;for(let n=0,r=e.length;n<r;n++)e[n]=i[t+n];return this.index+=e.byteLength,this.remaining-=e.byteLength,e}readUint16Array(e){if(ArrayBuffer.isView(e)||(e=new Uint16Array(e)),this.remaining<e.byteLength)throw new Error(`ByteStream: readUint16Array: premature end - want ${e.byteLength} bytes but have ${this.remaining}`);const t=this.index,i=this.uint8array;for(let n=0,r=e.length;n<r;n++){const o=t+n*2;e[n]=yn(i[o],i[o+1])}return this.index+=e.byteLength,this.remaining-=e.byteLength,e}readUint32Array(e){if(ArrayBuffer.isView(e)||(e=new Uint32Array(e)),this.remaining<e.byteLength)throw new Error(`ByteStream: readUint32Array: premature end - want ${e.byteLength} bytes but have ${this.remaining}`);const t=this.index,i=this.uint8array;for(let n=0,r=e.length;n<r;n++){const o=t+n*4;e[n]=An(i[o],i[o+1],i[o+2],i[o+3])}return this.index+=e.byteLength,this.remaining-=e.byteLength,e}readFloat32Array(e){if(ArrayBuffer.isView(e)||(e=new Float32Array(e)),this.remaining<e.byteLength)throw new Error(`ByteStream: readFloat32Array: premature end - want ${e.byteLength} bytes but have ${this.remaining}`);const t=this.index,i=this.uint8array;for(let n=0,r=e.length;n<r;n++){const o=t+n*4;e[n]=Tn(i[o],i[o+1],i[o+2],i[o+3])}return this.index+=e.byteLength,this.remaining-=e.byteLength,e}readFloat64Array(e){if(ArrayBuffer.isView(e)||(e=new Float64Array(e)),this.remaining<e.byteLength)throw new Error(`ByteStream: readFloat64Array: premature end - want ${e.byteLength} bytes but have ${this.remaining}`);const t=this.index,i=this.uint8array;for(let n=0,r=e.length;n<r;n++){const o=t+n*8;e[n]=Sn(i[o],i[o+1],i[o+2],i[o+3],i[o+4],i[o+5],i[o+6],i[o+7])}return this.index+=e.byteLength,this.remaining-=e.byteLength,e}write(e){const t=Ai(e);return this.writeUint8Array(t),t.length}writeNull(e){const t=this.write(e);return this.index++,this.remaining--,t+1}writeBinary(e){const t=this.index,i=this.uint8array,n=e.length;for(let r=0;r<n;r++)i[t+r]=e.charCodeAt(r);this.index+=n}writeInt8(e){this.uint8array[this.index]=En(e),this.index+=1}writeInt16(e){const t=this.index,i=this.uint8array;xn(k,e),i[t]=k[0],i[t+1]=k[1],this.index+=2}writeInt32(e){const t=this.index,i=this.uint8array;_n(k,e),i[t]=k[0],i[t+1]=k[1],i[t+2]=k[2],i[t+3]=k[3],this.index+=4}writeUint8(e){this.uint8array[this.index]=e,this.index+=1}writeUint16(e){const t=this.index,i=this.uint8array;In(k,e),i[t]=k[0],i[t+1]=k[1],this.index+=2}writeUint32(e){const t=this.index,i=this.uint8array;Cn(k,e),i[t]=k[0],i[t+1]=k[1],i[t+2]=k[2],i[t+3]=k[3],this.index+=4}writeFloat32(e){const t=this.index,i=this.uint8array;Ln(k,e),i[t]=k[0],i[t+1]=k[1],i[t+2]=k[2],i[t+3]=k[3],this.index+=4}writeFloat64(e){const t=this.index,i=this.uint8array;Rn(k,e),i[t]=k[0],i[t+1]=k[1],i[t+2]=k[2],i[t+3]=k[3],i[t+4]=k[4],i[t+5]=k[5],i[t+6]=k[6],i[t+7]=k[7],this.index+=8}writeInt8Array(e){const t=this.index,i=this.uint8array;for(let n=0,r=e.length;n<r;n++)i[t+n]=En(e[n]);this.index+=e.byteLength}writeInt16Array(e){const t=this.index,i=this.uint8array;for(let n=0,r=e.length;n<r;n++){const o=t+n*2;xn(k,e[n]),i[o]=k[0],i[o+1]=k[1]}this.index+=e.byteLength}writeInt32Array(e){const t=this.index,i=this.uint8array;for(let n=0,r=e.length;n<r;n++){const o=t+n*4;_n(k,e[n]),i[o]=k[0],i[o+1]=k[1],i[o+2]=k[2],i[o+3]=k[3]}this.index+=e.byteLength}writeUint8Array(e){const t=this.index,i=this.uint8array;for(let n=0,r=e.length;n<r;n++)i[t+n]=e[n];this.index+=e.byteLength}writeUint16Array(e){const t=this.index,i=this.uint8array;for(let n=0,r=e.length;n<r;n++){const o=t+n*2;In(k,e[n]),i[o]=k[0],i[o+1]=k[1]}this.index+=e.byteLength}writeUint32Array(e){const t=this.index,i=this.uint8array;for(let n=0,r=e.length;n<r;n++){const o=t+n*4;Cn(k,e[n]),i[o]=k[0],i[o+1]=k[1],i[o+2]=k[2],i[o+3]=k[3]}this.index+=e.byteLength}writeFloat32Array(e){const t=this.index,i=this.uint8array;for(let n=0,r=e.length;n<r;n++){const o=t+n*4;Ln(k,e[n]),i[o]=k[0],i[o+1]=k[1],i[o+2]=k[2],i[o+3]=k[3]}this.index+=e.byteLength}writeFloat64Array(e){const t=this.index,i=this.uint8array;for(let n=0,r=e.length;n<r;n++){const o=t+n*8;Rn(k,e[n]),i[o]=k[0],i[o+1]=k[1],i[o+2]=k[2],i[o+3]=k[3],i[o+4]=k[4],i[o+5]=k[5],i[o+6]=k[6],i[o+7]=k[7]}this.index+=e.byteLength}}class Bn{buffer;index=0;ident=0;indentSpaces=4;precision=1e6;constructor(e){this.buffer=e||""}clear(){this.buffer="",this.index=0,this.ident=0}readToken(){const e=this.buffer,t=e.length;let i=!1,n=!1,r="";for(;this.index<t;){const o=e[this.index++];if(i)o===`
`&&(i=!1);else if(n)if(o==="\\")r+=o+e[this.index++];else if(o===`
`)r+="\\n";else if(o==="\r")r+="\\r";else{if(o==='"')return r;r+=o}else if(o===" "||o===","||o==="	"||o===`
`||o===":"||o==="\r"){if(r.length)return r}else{if(o==="{"||o==="}")return r.length?(this.index--,r):o;if(o==="/"&&e[this.index]==="/"){if(r.length)return this.index--,r;i=!0}else if(o==='"'){if(r.length)return this.index--,r;n=!0}else r+=o}}}read(){const e=this.readToken();if(e===void 0)throw new Error("End of stream reached prematurely");return e}peek(){const e=this.index,t=this.read();return this.index=e,t}readInt(){return parseInt(this.read())}readFloat(){return parseFloat(this.read())}readVector(e){this.read();for(let t=0,i=e.length;t<i;t++)e[t]=this.readFloat();return this.read(),e}readVectorsBlock(e,t){this.read();for(let i=0,n=e.length;i<n;i+=t)this.readVector(e.subarray(i,i+t));return this.read(),e}readColor(e){return this.read(),e[2]=this.readFloat(),e[1]=this.readFloat(),e[0]=this.readFloat(),this.read(),e}*readBlock(){this.read();let e=this.read();for(;e!=="}";)yield e,e=this.read()}writeLine(e){this.buffer+=`${" ".repeat(this.ident*this.indentSpaces)}${e}
`}writeFlag(e){this.writeLine(`${e},`)}writeFlagAttrib(e,t){this.writeLine(`${e} ${t},`)}writeNumberAttrib(e,t){this.writeLine(`${e} ${this.floatDecimals(t)},`)}writeStringAttrib(e,t){this.writeLine(`${e} "${t}",`)}writeVectorAttrib(e,t){this.writeLine(`${e} { ${this.floatArrayDecimals(t)} },`)}writeColor(e,t){const i=this.floatDecimals(t[0]),n=this.floatDecimals(t[1]),r=this.floatDecimals(t[2]);this.writeLine(`${e} { ${r}, ${n}, ${i} },`)}writeVector(e){this.writeLine(`{ ${this.floatArrayDecimals(e)} },`)}writeVectorArrayBlock(e,t,i){this.startBlock(e,t.length/i);for(let n=0,r=t.length;n<r;n+=i)this.writeVector(t.subarray(n,n+i));this.endBlock()}startBlock(e,...t){t.length&&(e=`${e} ${t.join(" ")}`),this.writeLine(`${e} {`),this.ident+=1}startObjectBlock(e,t){this.writeLine(`${e} "${t.replace(/"/g,'\\"')}" {`),this.ident+=1}endBlock(){this.ident-=1,this.writeLine("}")}endBlockComma(){this.ident-=1,this.writeLine("},")}indent(){this.ident+=1}unindent(){this.ident-=1}floatDecimals(e){return`${Math.trunc(e*this.precision)/this.precision}`}floatArrayDecimals(e){if(e instanceof Float32Array){const t=[];for(let i=0,n=e.length;i<n;i++)t[i]=this.floatDecimals(e[i]);return t.join(", ")}else return e.join(", ")}}class _t{boundsRadius=0;min=new Float32Array(3);max=new Float32Array(3);readMdx(e){this.boundsRadius=e.readFloat32(),e.readFloat32Array(this.min),e.readFloat32Array(this.max)}writeMdx(e){e.writeFloat32(this.boundsRadius),e.writeFloat32Array(this.min),e.writeFloat32Array(this.max)}writeMdl(e){(this.min[0]!==0||this.min[1]!==0||this.min[2]!==0)&&e.writeVectorAttrib("MinimumExtent",this.min),(this.max[0]!==0||this.max[1]!==0||this.max[2]!==0)&&e.writeVectorAttrib("MaximumExtent",this.max),this.boundsRadius!==0&&e.writeNumberAttrib("BoundsRadius",this.boundsRadius)}}let Fn=class{name="";interval=new Uint32Array(2);moveSpeed=0;nonLooping=0;rarity=0;syncPoint=0;extent=new _t;readMdx(e){this.name=e.read(80),e.readUint32Array(this.interval),this.moveSpeed=e.readFloat32(),this.nonLooping=e.readUint32(),this.rarity=e.readFloat32(),this.syncPoint=e.readUint32(),this.extent.readMdx(e)}writeMdx(e){e.skip(80-e.write(this.name)),e.writeUint32Array(this.interval),e.writeFloat32(this.moveSpeed),e.writeUint32(this.nonLooping),e.writeFloat32(this.rarity),e.writeUint32(this.syncPoint),this.extent.writeMdx(e)}readMdl(e){this.name=e.read();for(const t of e.readBlock())if(t==="Interval")e.readVector(this.interval);else if(t==="NonLooping")this.nonLooping=1;else if(t==="MoveSpeed")this.moveSpeed=e.readFloat();else if(t==="Rarity")this.rarity=e.readFloat();else if(t==="MinimumExtent")e.readVector(this.extent.min);else if(t==="MaximumExtent")e.readVector(this.extent.max);else if(t==="BoundsRadius")this.extent.boundsRadius=e.readFloat();else throw new Error(`Unknown token in Sequence: "${t}"`)}writeMdl(e){e.startObjectBlock("Anim",this.name),e.writeVectorAttrib("Interval",this.interval),this.nonLooping===1&&e.writeFlag("NonLooping"),this.moveSpeed!==0&&e.writeNumberAttrib("MoveSpeed",this.moveSpeed),this.rarity!==0&&e.writeNumberAttrib("Rarity",this.rarity),this.extent.writeMdl(e),e.endBlock()}};var de=(s=>(s[s.DontInterp=0]="DontInterp",s[s.Linear=1]="Linear",s[s.Hermite=2]="Hermite",s[s.Bezier=3]="Bezier",s))(de||{});class $t{name="";interpolationType=0;globalSequenceId=-1;frames=[];values=[];inTans=[];outTans=[];readMdx(e,t){const i=this.frames,n=this.values,r=this.inTans,o=this.outTans,a=e.readUint32(),l=e.readUint32();this.name=t,this.interpolationType=l,this.globalSequenceId=e.readInt32();for(let c=0;c<a;c++)i.push(e.readInt32()),n.push(this.readMdxValue(e)),l>1&&(r.push(this.readMdxValue(e)),o.push(this.readMdxValue(e)))}writeMdx(e){const t=this.interpolationType,i=this.frames,n=this.values,r=this.inTans,o=this.outTans,a=i.length;e.writeBinary(this.name),e.writeUint32(a),e.writeUint32(t),e.writeInt32(this.globalSequenceId);for(let l=0;l<a;l++)e.writeInt32(i[l]),this.writeMdxValue(e,n[l]),t>1&&(this.writeMdxValue(e,r[l]),this.writeMdxValue(e,o[l]))}readMdl(e,t){const i=this.frames,n=this.values,r=this.inTans,o=this.outTans;this.name=t;const a=e.readInt();e.read();let l=0;const c=e.read();c==="DontInterp"?l=0:c==="Linear"?l=1:c==="Hermite"?l=2:c==="Bezier"&&(l=3),this.interpolationType=l,e.peek()==="GlobalSeqId"&&(e.read(),this.globalSequenceId=e.readInt());for(let d=0;d<a;d++)i[d]=e.readInt(),n[d]=this.readMdlValue(e),l>1&&(e.read(),r[d]=this.readMdlValue(e),e.read(),o[d]=this.readMdlValue(e));e.read()}writeMdl(e,t){const i=this.interpolationType,n=this.frames,r=this.values,o=this.inTans,a=this.outTans,l=n.length;e.startBlock(t,this.frames.length);let c="";this.interpolationType===0?c="DontInterp":this.interpolationType===1?c="Linear":this.interpolationType===2?c="Hermite":this.interpolationType===3&&(c="Bezier"),e.writeFlag(c),this.globalSequenceId!==-1&&e.writeNumberAttrib("GlobalSeqId",this.globalSequenceId);for(let d=0;d<l;d++)this.writeMdlValue(e,`${n[d]}:`,r[d]),i>1&&(e.indent(),this.writeMdlValue(e,"InTan",o[d]),this.writeMdlValue(e,"OutTan",a[d]),e.unindent());e.endBlock()}getByteLength(){const e=this.frames.length;let t=16;if(e){const i=this.values[0].byteLength;let n=1;this.interpolationType>1&&(n=3),t+=(4+n*i)*e}return t}}class Xt extends $t{readMdxValue(e){return e.readUint32Array(1)}writeMdxValue(e,t){e.writeUint32(t[0])}readMdlValue(e){return new Uint32Array([e.readInt()])}writeMdlValue(e,t,i){e.writeNumberAttrib(t,i[0])}}class q extends $t{readMdxValue(e){return e.readFloat32Array(1)}writeMdxValue(e,t){e.writeFloat32(t[0])}readMdlValue(e){return new Float32Array([e.readFloat()])}writeMdlValue(e,t,i){e.writeNumberAttrib(t,i[0])}}class _e extends $t{readMdxValue(e){return e.readFloat32Array(3)}writeMdxValue(e,t){e.writeFloat32Array(t)}readMdlValue(e){return e.readVector(new Float32Array(3))}writeMdlValue(e,t,i){e.writeVectorAttrib(t,i)}}class kn extends $t{readMdxValue(e){return e.readFloat32Array(4)}writeMdxValue(e,t){e.writeFloat32Array(t)}readMdlValue(e){return e.readVector(new Float32Array(4))}writeMdlValue(e,t,i){e.writeVectorAttrib(t,i)}}const Ti={KMTF:["TextureID",Xt],KMTA:["Alpha",q],KMTE:["EmissiveGain",q],KFC3:["FresnelColor",_e],KFCA:["FresnelOpacity",q],KFTC:["FresnelTeamColor",Xt],KTAT:["Translation",_e],KTAR:["Rotation",kn],KTAS:["Scaling",_e],KGAO:["Alpha",q],KGAC:["Color",_e],KGTR:["Translation",_e],KGRT:["Rotation",kn],KGSC:["Scaling",_e],KLAS:["AttenuationStart",q],KLAE:["AttenuationEnd",q],KLAC:["Color",_e],KLAI:["Intensity",q],KLBI:["AmbIntensity",q],KLBC:["AmbColor",_e],KLAV:["Visibility",q],KATV:["Visibility",q],KPEE:["EmissionRate",q],KPEG:["Gravity",q],KPLN:["Longitude",q],KPLT:["Latitude",q],KPEL:["LifeSpan",q],KPES:["InitVelocity",q],KPEV:["Visibility",q],KP2S:["Speed",q],KP2R:["Variation",q],KP2L:["Latitude",q],KP2G:["Gravity",q],KP2E:["EmissionRate",q],KP2N:["Width",q],KP2W:["Length",q],KP2V:["Visibility",q],KPPA:["Alpha",q],KPPC:["Color",_e],KPPE:["EmissionRate",q],KPPL:["LifeSpan",q],KPPS:["Speed",q],KPPV:["Visibility",q],KRHA:["HeightAbove",q],KRHB:["HeightBelow",q],KRAL:["Alpha",q],KRCO:["Color",_e],KRTX:["TextureSlot",Xt],KRVS:["Visibility",q],KCTR:["Translation",_e],KTTR:["Translation",_e],KCRL:["Rotation",q]};let It=class{animations=[];readAnimations(e,t){const i=e.index+t;for(;e.index<i;){const n=e.readBinary(4),r=new Ti[n][1];r.readMdx(e,n),this.animations.push(r)}}writeAnimations(e){for(const t of this.animations)t.writeMdx(e)}*readAnimatedBlock(e){for(const t of e.readBlock())t==="static"?yield`static ${e.read()}`:yield t}readAnimation(e,t){const i=new Ti[t][1];i.readMdl(e,t),this.animations.push(i)}writeAnimation(e,t){for(const i of this.animations)if(i.name===t)return i.writeMdl(e,Ti[t][0]),!0;return!1}getByteLength(e=0){let t=0;for(const i of this.animations)t+=i.getByteLength();return t}};var ke=(s=>(s[s.None=0]="None",s[s.Transparent=1]="Transparent",s[s.Blend=2]="Blend",s[s.Additive=3]="Additive",s[s.AddAlpha=4]="AddAlpha",s[s.Modulate=5]="Modulate",s[s.Modulate2x=6]="Modulate2x",s))(ke||{}),je=(s=>(s[s.None=0]="None",s[s.Unshaded=1]="Unshaded",s[s.SphereEnvMap=2]="SphereEnvMap",s[s.TwoSided=16]="TwoSided",s[s.Unfogged=32]="Unfogged",s[s.NoDepthTest=64]="NoDepthTest",s[s.NoDepthSet=128]="NoDepthSet",s[s.Unlit=256]="Unlit",s))(je||{});function Gr(s){return s==="None"?0:s==="Transparent"?1:s==="Blend"?2:s==="Additive"?3:s==="AddAlpha"?4:s==="Modulate"?5:s==="Modulate2x"?6:0}function qr(s){return s===0?"None":s===1?"Transparent":s===2?"Blend":s===3?"Additive":s===4?"AddAlpha":s===5?"Modulate":s===6?"Modulate2x":"None"}let Si=class extends It{filterMode=0;flags=0;textureId=-1;textureAnimationId=-1;coordId=0;alpha=1;emissiveGain=1;fresnelColor=new Float32Array([1,1,1]);fresnelOpacity=0;fresnelTeamColor=0;readMdx(e,t){const i=e.index,n=e.readUint32();this.filterMode=e.readUint32(),this.flags=e.readUint32(),this.textureId=e.readInt32(),this.textureAnimationId=e.readInt32(),this.coordId=e.readUint32(),this.alpha=e.readFloat32(),t>800&&(this.emissiveGain=e.readFloat32(),e.readFloat32Array(this.fresnelColor),this.fresnelOpacity=e.readFloat32(),this.fresnelTeamColor=e.readFloat32()),this.readAnimations(e,n-(e.index-i))}writeMdx(e,t){e.writeUint32(this.getByteLength(t)),e.writeUint32(this.filterMode),e.writeUint32(this.flags),e.writeInt32(this.textureId),e.writeInt32(this.textureAnimationId),e.writeUint32(this.coordId),e.writeFloat32(this.alpha),t>800&&(e.writeFloat32(this.emissiveGain),e.writeFloat32Array(this.fresnelColor),e.writeFloat32(this.fresnelOpacity),e.writeFloat32(this.fresnelTeamColor)),this.writeAnimations(e)}readMdl(e){for(const t of super.readAnimatedBlock(e))if(t==="FilterMode")this.filterMode=Gr(e.read());else if(t==="Unshaded")this.flags|=1;else if(t==="SphereEnvMap")this.flags|=2;else if(t==="TwoSided")this.flags|=16;else if(t==="Unfogged")this.flags|=32;else if(t==="NoDepthTest")this.flags|=64;else if(t==="NoDepthSet")this.flags|=128;else if(t==="Unlit")this.flags|=256;else if(t==="static TextureID")this.textureId=e.readInt();else if(t==="TextureID")this.readAnimation(e,"KMTF");else if(t==="TVertexAnimId")this.textureAnimationId=e.readInt();else if(t==="CoordId")this.coordId=e.readInt();else if(t==="static Alpha")this.alpha=e.readFloat();else if(t==="Alpha")this.readAnimation(e,"KMTA");else if(t==="static EmissiveGain")this.emissiveGain=e.readFloat();else if(t==="EmissiveGain")this.readAnimation(e,"KMTE");else if(t==="static FresnelColor")e.readVector(this.fresnelColor);else if(t==="FresnelColor")this.readAnimation(e,"KFC3");else if(t==="static FresnelOpacity")this.fresnelOpacity=e.readFloat();else if(t==="FresnelOpacity")this.readAnimation(e,"KFCA");else if(t==="static FresnelTeamColor")this.fresnelTeamColor=e.readFloat();else if(t==="FresnelTeamColor")this.readAnimation(e,"KFTC");else throw new Error(`Unknown token in Layer: "${t}"`)}writeMdl(e,t){e.startBlock("Layer"),e.writeFlagAttrib("FilterMode",qr(this.filterMode)),this.flags&1&&e.writeFlag("Unshaded"),this.flags&2&&e.writeFlag("SphereEnvMap"),this.flags&16&&e.writeFlag("TwoSided"),this.flags&32&&e.writeFlag("Unfogged"),this.flags&64&&e.writeFlag("NoDepthTest"),this.flags&128&&e.writeFlag("NoDepthSet"),t>800&&this.flags&256&&e.writeFlag("Unlit"),this.writeAnimation(e,"KMTF")||e.writeNumberAttrib("static TextureID",this.textureId),this.textureAnimationId!==-1&&e.writeNumberAttrib("TVertexAnimId",this.textureAnimationId),this.coordId!==0&&e.writeNumberAttrib("CoordId",this.coordId),!this.writeAnimation(e,"KMTA")&&this.alpha!==1&&e.writeNumberAttrib("static Alpha",this.alpha),t>800&&(!this.writeAnimation(e,"KMTE")&&this.emissiveGain!==1&&e.writeNumberAttrib("static EmissiveGain",this.emissiveGain),!this.writeAnimation(e,"KFC3")&&(this.fresnelColor[0]!==1||this.fresnelColor[1]!==1||this.fresnelColor[2]!==1)&&e.writeVectorAttrib("static FresnelColor",this.fresnelColor),!this.writeAnimation(e,"KFCA")&&this.fresnelOpacity!==0&&e.writeNumberAttrib("static FresnelOpacity",this.fresnelOpacity),!this.writeAnimation(e,"KFTC")&&this.fresnelTeamColor!==0&&e.writeNumberAttrib("static FresnelTeamColor",this.fresnelTeamColor)),e.endBlock()}getByteLength(e){let t=28+super.getByteLength();return e>800&&(t+=24),t}},Ei=class{priorityPlane=0;flags=0;shader="";layers=[];readMdx(e,t){e.readUint32(),this.priorityPlane=e.readInt32(),this.flags=e.readUint32(),t>800&&(this.shader=e.read(80)),e.skip(4);for(let i=0,n=e.readUint32();i<n;i++){const r=new Si;r.readMdx(e,t),this.layers.push(r)}}writeMdx(e,t){e.writeUint32(this.getByteLength(t)),e.writeInt32(this.priorityPlane),e.writeUint32(this.flags),t>800&&e.skip(80-e.write(this.shader)),e.writeBinary("LAYS"),e.writeUint32(this.layers.length);for(const i of this.layers)i.writeMdx(e,t)}readMdl(e){for(const t of e.readBlock())if(t==="ConstantColor")this.flags|=1;else if(t==="TwoSided")this.flags|=2;else if(t==="SortPrimsNearZ")this.flags|=8;else if(t==="SortPrimsFarZ")this.flags|=16;else if(t==="FullResolution")this.flags|=32;else if(t==="PriorityPlane")this.priorityPlane=e.readInt();else if(t==="Shader")this.shader=e.read();else if(t==="Layer"){const i=new Si;i.readMdl(e),this.layers.push(i)}else throw new Error(`Unknown token in Material: "${t}"`)}writeMdl(e,t){e.startBlock("Material"),this.flags&1&&e.writeFlag("ConstantColor"),t>800&&this.flags&2&&e.writeFlag("TwoSided"),this.flags&8&&e.writeFlag("SortPrimsNearZ"),this.flags&16&&e.writeFlag("SortPrimsFarZ"),this.flags&32&&e.writeFlag("FullResolution"),this.priorityPlane!==0&&e.writeNumberAttrib("PriorityPlane",this.priorityPlane),t>800&&e.writeStringAttrib("Shader",this.shader);for(const i of this.layers)i.writeMdl(e,t);e.endBlock()}getByteLength(e){let t=20;e>800&&(t+=80);for(const i of this.layers)t+=i.getByteLength(e);return t}};var et=(s=>(s[s.RepeatBoth=0]="RepeatBoth",s[s.WrapWidth=1]="WrapWidth",s[s.WrapHeight=2]="WrapHeight",s[s.WrapBoth=3]="WrapBoth",s))(et||{});class xi{replaceableId=0;path="";wrapMode=0;readMdx(e){this.replaceableId=e.readUint32(),this.path=e.read(260),this.wrapMode=e.readUint32()}writeMdx(e){e.writeUint32(this.replaceableId),e.skip(260-e.write(this.path)),e.writeUint32(this.wrapMode)}readMdl(e){for(const t of e.readBlock())if(t==="Image")this.path=e.read();else if(t==="ReplaceableId")this.replaceableId=e.readInt();else if(t==="WrapWidth")this.wrapMode|=1;else if(t==="WrapHeight")this.wrapMode|=2;else throw new Error(`Unknown token in Texture: "${t}"`)}writeMdl(e){e.startBlock("Bitmap"),this.path.length&&e.writeStringAttrib("Image",this.path),this.replaceableId!==0&&e.writeNumberAttrib("ReplaceableId",this.replaceableId),this.wrapMode&1&&e.writeFlag("WrapWidth"),this.wrapMode&2&&e.writeFlag("WrapHeight"),e.endBlock()}}let Pn=class extends It{readMdx(e){const t=e.readUint32();this.readAnimations(e,t-4)}writeMdx(e){e.writeUint32(this.getByteLength()),this.writeAnimations(e)}readMdl(e){for(const t of e.readBlock())if(t==="Translation")this.readAnimation(e,"KTAT");else if(t==="Rotation")this.readAnimation(e,"KTAR");else if(t==="Scaling")this.readAnimation(e,"KTAS");else throw new Error(`Unknown token in TextureAnimation: "${t}"`)}writeMdl(e){e.startBlock("TVertexAnim "),this.writeAnimation(e,"KTAT"),this.writeAnimation(e,"KTAR"),this.writeAnimation(e,"KTAS"),e.endBlock()}getByteLength(){return 4+super.getByteLength()}},_i=class{vertices=new Float32Array(0);normals=new Float32Array(0);faceTypeGroups=new Uint32Array(0);faceGroups=new Uint32Array(0);faces=new Uint16Array(0);vertexGroups=new Uint8Array(0);matrixGroups=new Uint32Array(0);matrixIndices=new Uint32Array(0);materialId=0;selectionGroup=0;selectionFlags=0;lod=-1;lodName="";extent=new _t;sequenceExtents=[];tangents=new Float32Array(0);skin=new Uint8Array(0);uvSets=[];readMdx(e,t){e.readUint32(),e.skip(4),this.vertices=e.readFloat32Array(e.readUint32()*3),e.skip(4),this.normals=e.readFloat32Array(e.readUint32()*3),e.skip(4),this.faceTypeGroups=e.readUint32Array(e.readUint32()),e.skip(4),this.faceGroups=e.readUint32Array(e.readUint32()),e.skip(4),this.faces=e.readUint16Array(e.readUint32()),e.skip(4),this.vertexGroups=e.readUint8Array(e.readUint32()),e.skip(4),this.matrixGroups=e.readUint32Array(e.readUint32()),e.skip(4),this.matrixIndices=e.readUint32Array(e.readUint32()),this.materialId=e.readUint32(),this.selectionGroup=e.readUint32(),this.selectionFlags=e.readUint32(),t>800&&(this.lod=e.readInt32(),this.lodName=e.read(80)),this.extent.readMdx(e);for(let i=0,n=e.readUint32();i<n;i++){const r=new _t;r.readMdx(e),this.sequenceExtents.push(r)}t>800&&(e.readBinary(4)==="TANG"?this.tangents=e.readFloat32Array(e.readUint32()*4):e.skip(-4),e.readBinary(4)==="SKIN"?this.skin=e.readUint8Array(e.readUint32()):e.skip(-4)),e.skip(4);for(let i=0,n=e.readUint32();i<n;i++)e.skip(4),this.uvSets.push(e.readFloat32Array(e.readUint32()*2))}writeMdx(e,t){e.writeUint32(this.getByteLength(t)),e.writeBinary("VRTX"),e.writeUint32(this.vertices.length/3),e.writeFloat32Array(this.vertices),e.writeBinary("NRMS"),e.writeUint32(this.normals.length/3),e.writeFloat32Array(this.normals),e.writeBinary("PTYP"),e.writeUint32(this.faceTypeGroups.length),e.writeUint32Array(this.faceTypeGroups),e.writeBinary("PCNT"),e.writeUint32(this.faceGroups.length),e.writeUint32Array(this.faceGroups),e.writeBinary("PVTX"),e.writeUint32(this.faces.length),e.writeUint16Array(this.faces),e.writeBinary("GNDX"),e.writeUint32(this.vertexGroups.length),e.writeUint8Array(this.vertexGroups),e.writeBinary("MTGC"),e.writeUint32(this.matrixGroups.length),e.writeUint32Array(this.matrixGroups),e.writeBinary("MATS"),e.writeUint32(this.matrixIndices.length),e.writeUint32Array(this.matrixIndices),e.writeUint32(this.materialId),e.writeUint32(this.selectionGroup),e.writeUint32(this.selectionFlags),t>800&&(e.writeInt32(this.lod),e.skip(80-e.write(this.lodName))),this.extent.writeMdx(e),e.writeUint32(this.sequenceExtents.length);for(const i of this.sequenceExtents)i.writeMdx(e);t>800&&(this.tangents.length&&(e.writeBinary("TANG"),e.writeUint32(this.tangents.length/4),e.writeFloat32Array(this.tangents)),this.skin.length&&(e.writeBinary("SKIN"),e.writeUint32(this.skin.length),e.writeUint8Array(this.skin))),e.writeBinary("UVAS"),e.writeUint32(this.uvSets.length);for(const i of this.uvSets)e.writeBinary("UVBS"),e.writeUint32(i.length/2),e.writeFloat32Array(i)}readMdl(e){for(let t of e.readBlock())if(t==="Vertices")this.vertices=e.readVectorsBlock(new Float32Array(e.readInt()*3),3);else if(t==="Normals")this.normals=e.readVectorsBlock(new Float32Array(e.readInt()*3),3);else if(t==="TVertices")this.uvSets.push(e.readVectorsBlock(new Float32Array(e.readInt()*2),2));else if(t==="VertexGroup"){const i=[];for(const n of e.readBlock())i.push(parseInt(n));this.vertexGroups=new Uint8Array(i)}else if(t==="Tangents")this.tangents=e.readVectorsBlock(new Float32Array(e.readInt()*4),4);else if(t==="SkinWeights")this.skin=e.readVector(new Uint8Array(e.readInt()*8));else if(t==="Faces"){this.faceTypeGroups=new Uint32Array([4]);const i=e.readInt(),n=e.readInt();e.read(),e.read(),this.faces=e.readVectorsBlock(new Uint16Array(n),n/i),this.faceGroups=new Uint32Array([n]),e.read()}else if(t==="Groups"){const i=[],n=[];e.readInt(),e.readInt();for(const r of e.readBlock()){let o=0;for(const a of e.readBlock())i.push(parseInt(a)),o+=1;n.push(o)}this.matrixIndices=new Uint32Array(i),this.matrixGroups=new Uint32Array(n)}else if(t==="MinimumExtent")e.readVector(this.extent.min);else if(t==="MaximumExtent")e.readVector(this.extent.max);else if(t==="BoundsRadius")this.extent.boundsRadius=e.readFloat();else if(t==="Anim"){const i=new _t;for(t of e.readBlock())t==="MinimumExtent"?e.readVector(i.min):t==="MaximumExtent"?e.readVector(i.max):t==="BoundsRadius"&&(i.boundsRadius=e.readFloat());this.sequenceExtents.push(i)}else if(t==="MaterialID")this.materialId=e.readInt();else if(t==="SelectionGroup")this.selectionGroup=e.readInt();else if(t==="Unselectable")this.selectionFlags=4;else if(t==="LevelOfDetail")this.lod=e.readInt();else if(t==="Name")this.lodName=e.read();else throw new Error(`Unknown token in Geoset: "${t}"`)}writeMdl(e,t){e.startBlock("Geoset"),e.writeVectorArrayBlock("Vertices",this.vertices,3),e.writeVectorArrayBlock("Normals",this.normals,3);for(const n of this.uvSets)e.writeVectorArrayBlock("TVertices",n,2);if(t>800&&this.tangents.length&&e.writeVectorArrayBlock("Tangents",this.tangents,4),this.vertexGroups.length){e.startBlock("VertexGroup");for(let n=0,r=this.vertexGroups.length;n<r;n++)e.writeLine(`${this.vertexGroups[n]},`);e.endBlock()}if(t>800&&this.skin.length){e.startBlock("SkinWeights",this.skin.length/8);for(let n=0,r=this.skin.length;n<r;n+=8)e.writeLine(`${this.skin.subarray(n,n+8).join(", ")},`);e.endBlock()}e.startBlock("Faces",1,this.faces.length),e.startBlock("Triangles"),e.writeVector(this.faces),e.endBlock(),e.endBlock(),e.startBlock("Groups",this.matrixGroups.length,this.matrixIndices.length);let i=0;for(const n of this.matrixGroups)e.writeVectorAttrib("Matrices",this.matrixIndices.subarray(i,i+n)),i+=n;e.endBlock(),this.extent.writeMdl(e);for(const n of this.sequenceExtents)e.startBlock("Anim"),n.writeMdl(e),e.endBlock();e.writeNumberAttrib("MaterialID",this.materialId),e.writeNumberAttrib("SelectionGroup",this.selectionGroup),this.selectionFlags===4&&e.writeFlag("Unselectable"),t>800&&(e.writeNumberAttrib("LevelOfDetail",this.lod),this.lodName.length&&e.writeStringAttrib("Name",this.lodName)),e.endBlock()}getByteLength(e){let t=120+this.vertices.byteLength+this.normals.byteLength+this.faceTypeGroups.byteLength+this.faceGroups.byteLength+this.faces.byteLength+this.vertexGroups.byteLength+this.matrixGroups.byteLength+this.matrixIndices.byteLength+this.sequenceExtents.length*28;e>800&&(t+=84,this.tangents.length&&(t+=8+this.tangents.byteLength),this.skin.length&&(t+=8+this.skin.byteLength));for(const i of this.uvSets)t+=8+i.byteLength;return t}},Ii=class extends It{alpha=1;flags=0;color=new Float32Array([1,1,1]);geosetId=-1;readMdx(e){const t=e.readUint32();this.alpha=e.readFloat32(),this.flags=e.readUint32(),e.readFloat32Array(this.color),this.geosetId=e.readInt32(),this.readAnimations(e,t-28)}writeMdx(e){e.writeUint32(this.getByteLength()),e.writeFloat32(this.alpha),e.writeUint32(this.flags),e.writeFloat32Array(this.color),e.writeInt32(this.geosetId),this.writeAnimations(e)}readMdl(e){for(const t of super.readAnimatedBlock(e))if(t==="DropShadow")this.flags|=1;else if(t==="static Alpha")this.alpha=e.readFloat();else if(t==="Alpha")this.readAnimation(e,"KGAO");else if(t==="static Color")this.flags|=2,e.readColor(this.color);else if(t==="Color")this.flags|=2,this.readAnimation(e,"KGAC");else if(t==="GeosetId")this.geosetId=e.readInt();else throw new Error(`Unknown token in GeosetAnimation: "${t}"`)}writeMdl(e){e.startBlock("GeosetAnim"),this.flags&1&&e.writeFlag("DropShadow"),this.writeAnimation(e,"KGAO")||e.writeNumberAttrib("static Alpha",this.alpha),this.flags&2&&!this.writeAnimation(e,"KGAC")&&(this.color[0]!==1||this.color[1]!==1||this.color[2]!==1)&&e.writeColor("static Color ",this.color),e.writeNumberAttrib("GeosetId",this.geosetId),e.endBlock()}getByteLength(){return 28+super.getByteLength()}};var Ke=(s=>(s[s.None=0]="None",s[s.DontInheritTranslation=1]="DontInheritTranslation",s[s.DontInheritScaling=2]="DontInheritScaling",s[s.DontInheritRotation=4]="DontInheritRotation",s[s.Billboarded=8]="Billboarded",s[s.BillboardedLockX=16]="BillboardedLockX",s[s.BillboardedLockY=32]="BillboardedLockY",s[s.BillboardedLockZ=64]="BillboardedLockZ",s[s.CameraAnchored=128]="CameraAnchored",s))(Ke||{});let Ue=class extends It{name="";objectId=-1;parentId=-1;flags;constructor(e=0){super(),this.flags=e}readMdx(e){const t=e.readUint32();this.name=e.read(80),this.objectId=e.readInt32(),this.parentId=e.readInt32(),this.flags=e.readUint32(),this.readAnimations(e,t-96)}writeMdx(e){e.writeUint32(this.getGenericByteLength()),e.skip(80-e.write(this.name)),e.writeInt32(this.objectId),e.writeInt32(this.parentId),e.writeUint32(this.flags);for(const t of this.eachAnimation(!0))t.writeMdx(e)}writeNonGenericAnimationChunks(e){for(const t of this.eachAnimation(!1))t.writeMdx(e)}*readGenericBlock(e){this.name=e.read();for(let t of this.readAnimatedBlock(e))if(t==="ObjectId")this.objectId=e.readInt();else if(t==="Parent")this.parentId=e.readInt();else if(t==="BillboardedLockZ")this.flags|=64;else if(t==="BillboardedLockY")this.flags|=32;else if(t==="BillboardedLockX")this.flags|=16;else if(t==="Billboarded")this.flags|=8;else if(t==="CameraAnchored")this.flags|=128;else if(t==="DontInherit")for(t of e.readBlock())t==="Rotation"?this.flags|=4:t==="Translation"?this.flags|=1:t==="Scaling"&&(this.flags|=2);else t==="Translation"?this.readAnimation(e,"KGTR"):t==="Rotation"?this.readAnimation(e,"KGRT"):t==="Scaling"?this.readAnimation(e,"KGSC"):yield t}writeGenericHeader(e){e.writeNumberAttrib("ObjectId",this.objectId),this.parentId!==-1&&e.writeNumberAttrib("Parent",this.parentId),this.flags&64&&e.writeFlag("BillboardedLockZ"),this.flags&32&&e.writeFlag("BillboardedLockY"),this.flags&16&&e.writeFlag("BillboardedLockX"),this.flags&8&&e.writeFlag("Billboarded"),this.flags&128&&e.writeFlag("CameraAnchored"),this.flags&4&&e.writeFlag("DontInherit { Rotation }"),this.flags&1&&e.writeFlag("DontInherit { Translation }"),this.flags&2&&e.writeFlag("DontInherit { Scaling }")}writeGenericAnimations(e){this.writeAnimation(e,"KGTR"),this.writeAnimation(e,"KGRT"),this.writeAnimation(e,"KGSC")}*eachAnimation(e){for(const t of this.animations){const i=t.name,n=i==="KGTR"||i==="KGRT"||i==="KGSC";(e&&n||!e&&!n)&&(yield t)}}getGenericByteLength(){let e=96;for(const t of this.eachAnimation(!0))e+=t.getByteLength();return e}getByteLength(){return 96+super.getByteLength()}},Ci=class extends Ue{geosetId=-1;geosetAnimationId=-1;constructor(){super(256)}readMdx(e){super.readMdx(e),this.geosetId=e.readInt32(),this.geosetAnimationId=e.readInt32()}writeMdx(e){super.writeMdx(e),e.writeInt32(this.geosetId),e.writeInt32(this.geosetAnimationId)}readMdl(e){for(let t of super.readGenericBlock(e))if(t==="GeosetId")t=e.read(),t==="Multiple"?this.geosetId=-1:this.geosetId=parseInt(t);else if(t==="GeosetAnimId")t=e.read(),t==="None"?this.geosetAnimationId=-1:this.geosetAnimationId=parseInt(t);else throw new Error(`Unknown token in Bone ${this.name}: "${t}"`)}writeMdl(e){e.startObjectBlock("Bone",this.name),this.writeGenericHeader(e),this.geosetId===-1?e.writeFlagAttrib("GeosetId","Multiple"):e.writeNumberAttrib("GeosetId",this.geosetId),this.geosetAnimationId===-1?e.writeFlagAttrib("GeosetAnimId","None"):e.writeNumberAttrib("GeosetAnimId",this.geosetAnimationId),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 8+super.getByteLength()}},Mn=class extends Ue{type=-1;attenuation=new Float32Array(2);color=new Float32Array(3);intensity=0;ambientColor=new Float32Array(3);ambientIntensity=0;constructor(){super(512)}readMdx(e){const t=e.index,i=e.readUint32();super.readMdx(e),this.type=e.readUint32(),e.readFloat32Array(this.attenuation),e.readFloat32Array(this.color),this.intensity=e.readFloat32(),e.readFloat32Array(this.ambientColor),this.ambientIntensity=e.readFloat32(),this.readAnimations(e,i-(e.index-t))}writeMdx(e){e.writeUint32(this.getByteLength()),super.writeMdx(e),e.writeUint32(this.type),e.writeFloat32Array(this.attenuation),e.writeFloat32Array(this.color),e.writeFloat32(this.intensity),e.writeFloat32Array(this.ambientColor),e.writeFloat32(this.ambientIntensity),this.writeNonGenericAnimationChunks(e)}readMdl(e){for(const t of super.readGenericBlock(e))if(t==="Omnidirectional")this.type=0;else if(t==="Directional")this.type=1;else if(t==="Ambient")this.type=2;else if(t==="static AttenuationStart")this.attenuation[0]=e.readFloat();else if(t==="AttenuationStart")this.readAnimation(e,"KLAS");else if(t==="static AttenuationEnd")this.attenuation[1]=e.readFloat();else if(t==="AttenuationEnd")this.readAnimation(e,"KLAE");else if(t==="static Intensity")this.intensity=e.readFloat();else if(t==="Intensity")this.readAnimation(e,"KLAI");else if(t==="static Color")e.readColor(this.color);else if(t==="Color")this.readAnimation(e,"KLAC");else if(t==="static AmbIntensity")this.ambientIntensity=e.readFloat();else if(t==="AmbIntensity")this.readAnimation(e,"KLBI");else if(t==="static AmbColor")e.readColor(this.ambientColor);else if(t==="AmbColor")this.readAnimation(e,"KLBC");else if(t==="Visibility")this.readAnimation(e,"KLAV");else throw new Error(`Unknown token in Light: "${t}"`)}writeMdl(e){e.startObjectBlock("Light",this.name),this.writeGenericHeader(e),this.type===0?e.writeFlag("Omnidirectional"):this.type===1?e.writeFlag("Directional"):this.type===2&&e.writeFlag("Ambient"),this.writeAnimation(e,"KLAS")||e.writeNumberAttrib("static AttenuationStart",this.attenuation[0]),this.writeAnimation(e,"KLAE")||e.writeNumberAttrib("static AttenuationEnd",this.attenuation[1]),this.writeAnimation(e,"KLAI")||e.writeNumberAttrib("static Intensity",this.intensity),this.writeAnimation(e,"KLAC")||e.writeColor("static Color",this.color),this.writeAnimation(e,"KLBI")||e.writeNumberAttrib("static AmbIntensity",this.ambientIntensity),this.writeAnimation(e,"KLBC")||e.writeColor("static AmbColor",this.ambientColor),this.writeAnimation(e,"KLAV"),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 48+super.getByteLength()}},Un=class extends Ue{readMdl(e){for(const t of super.readGenericBlock(e))throw new Error(`Unknown token in Helper: "${t}"`)}writeMdl(e){e.startObjectBlock("Helper",this.name),this.writeGenericHeader(e),this.writeGenericAnimations(e),e.endBlock()}},On=class extends Ue{path="";attachmentId=0;constructor(){super(2048)}readMdx(e){const t=e.index,i=e.readUint32();super.readMdx(e),this.path=e.read(260),this.attachmentId=e.readInt32(),this.readAnimations(e,i-(e.index-t))}writeMdx(e){e.writeUint32(this.getByteLength()),super.writeMdx(e),e.skip(260-e.write(this.path)),e.writeInt32(this.attachmentId),this.writeNonGenericAnimationChunks(e)}readMdl(e){for(const t of super.readGenericBlock(e))if(t==="AttachmentID")this.attachmentId=e.readInt();else if(t==="Path")this.path=e.read();else if(t==="Visibility")this.readAnimation(e,"KATV");else throw new Error(`Unknown token in Attachment ${this.name}: "${t}"`)}writeMdl(e){e.startObjectBlock("Attachment",this.name),this.writeGenericHeader(e),e.writeNumberAttrib("AttachmentID",this.attachmentId),this.path.length&&e.writeStringAttrib("Path",this.path),this.writeAnimation(e,"KATV"),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 268+super.getByteLength()}},Dn=class extends Ue{emissionRate=0;gravity=0;longitude=0;latitude=0;path="";lifeSpan=0;speed=0;constructor(){super(4096)}readMdx(e){const t=e.index,i=e.readUint32();super.readMdx(e),this.emissionRate=e.readFloat32(),this.gravity=e.readFloat32(),this.longitude=e.readFloat32(),this.latitude=e.readFloat32(),this.path=e.read(260),this.lifeSpan=e.readFloat32(),this.speed=e.readFloat32(),this.readAnimations(e,i-(e.index-t))}writeMdx(e){e.writeUint32(this.getByteLength()),super.writeMdx(e),e.writeFloat32(this.emissionRate),e.writeFloat32(this.gravity),e.writeFloat32(this.longitude),e.writeFloat32(this.latitude),e.skip(260-e.write(this.path)),e.writeFloat32(this.lifeSpan),e.writeFloat32(this.speed),this.writeNonGenericAnimationChunks(e)}readMdl(e){for(let t of super.readGenericBlock(e))if(t==="EmitterUsesMDL")this.flags|=32768;else if(t==="EmitterUsesTGA")this.flags|=65536;else if(t==="static EmissionRate")this.emissionRate=e.readFloat();else if(t==="EmissionRate")this.readAnimation(e,"KPEE");else if(t==="static Gravity")this.gravity=e.readFloat();else if(t==="Gravity")this.readAnimation(e,"KPEG");else if(t==="static Longitude")this.longitude=e.readFloat();else if(t==="Longitude")this.readAnimation(e,"KPLN");else if(t==="static Latitude")this.latitude=e.readFloat();else if(t==="Latitude")this.readAnimation(e,"KPLT");else if(t==="Visibility")this.readAnimation(e,"KPEV");else if(t==="Particle")for(t of this.readAnimatedBlock(e))t==="static LifeSpan"?this.lifeSpan=e.readFloat():t==="LifeSpan"?this.readAnimation(e,"KPEL"):t==="static InitVelocity"?this.speed=e.readFloat():t==="InitVelocity"?this.readAnimation(e,"KPES"):t==="Path"&&(this.path=e.read());else throw new Error(`Unknown token in ParticleEmitter: "${t}"`)}writeMdl(e){e.startObjectBlock("ParticleEmitter",this.name),this.writeGenericHeader(e),this.flags&32768&&e.writeFlag("EmitterUsesMDL"),this.flags&65536&&e.writeFlag("EmitterUsesTGA"),this.writeAnimation(e,"KPEE")||e.writeNumberAttrib("static EmissionRate",this.emissionRate),this.writeAnimation(e,"KPEG")||e.writeNumberAttrib("static Gravity",this.gravity),this.writeAnimation(e,"KPLN")||e.writeNumberAttrib("static Longitude",this.longitude),this.writeAnimation(e,"KPLT")||e.writeNumberAttrib("static Latitude",this.latitude),this.writeAnimation(e,"KPEV"),e.startBlock("Particle"),this.writeAnimation(e,"KPEL")||e.writeNumberAttrib("static LifeSpan",this.lifeSpan),this.writeAnimation(e,"KPES")||e.writeNumberAttrib("static InitVelocity",this.speed),(this.flags&32768||this.flags&65536)&&e.writeStringAttrib("Path",this.path),e.endBlock(),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 288+super.getByteLength()}};var Ct=(s=>(s[s.Unshaded=32768]="Unshaded",s[s.SortPrimsFarZ=65536]="SortPrimsFarZ",s[s.LineEmitter=131072]="LineEmitter",s[s.Unfogged=262144]="Unfogged",s[s.ModelSpace=524288]="ModelSpace",s[s.XYQuad=1048576]="XYQuad",s))(Ct||{}),ht=(s=>(s[s.Blend=0]="Blend",s[s.Additive=1]="Additive",s[s.Modulate=2]="Modulate",s[s.Modulate2x=3]="Modulate2x",s[s.AlphaKey=4]="AlphaKey",s))(ht||{}),dt=(s=>(s[s.Head=0]="Head",s[s.Tail=1]="Tail",s[s.Both=2]="Both",s))(dt||{});let Nn=class extends Ue{speed=0;variation=0;latitude=0;gravity=0;lifeSpan=0;emissionRate=0;width=0;length=0;filterMode=0;rows=0;columns=0;headOrTail=0;tailLength=0;timeMiddle=0;segmentColors=[new Float32Array(3),new Float32Array(3),new Float32Array(3)];segmentAlphas=new Uint8Array(3);segmentScaling=new Float32Array(3);headIntervals=[new Uint32Array(3),new Uint32Array(3)];tailIntervals=[new Uint32Array(3),new Uint32Array(3)];textureId=-1;squirt=0;priorityPlane=0;replaceableId=0;readMdx(e){const t=e.index,i=e.readUint32();super.readMdx(e),this.speed=e.readFloat32(),this.variation=e.readFloat32(),this.latitude=e.readFloat32(),this.gravity=e.readFloat32(),this.lifeSpan=e.readFloat32(),this.emissionRate=e.readFloat32(),this.width=e.readFloat32(),this.length=e.readFloat32(),this.filterMode=e.readUint32(),this.rows=e.readUint32(),this.columns=e.readUint32(),this.headOrTail=e.readUint32(),this.tailLength=e.readFloat32(),this.timeMiddle=e.readFloat32(),e.readFloat32Array(this.segmentColors[0]),e.readFloat32Array(this.segmentColors[1]),e.readFloat32Array(this.segmentColors[2]),e.readUint8Array(this.segmentAlphas),e.readFloat32Array(this.segmentScaling),e.readUint32Array(this.headIntervals[0]),e.readUint32Array(this.headIntervals[1]),e.readUint32Array(this.tailIntervals[0]),e.readUint32Array(this.tailIntervals[1]),this.textureId=e.readInt32(),this.squirt=e.readUint32(),this.priorityPlane=e.readInt32(),this.replaceableId=e.readUint32(),this.readAnimations(e,i-(e.index-t))}writeMdx(e){e.writeUint32(this.getByteLength()),super.writeMdx(e),e.writeFloat32(this.speed),e.writeFloat32(this.variation),e.writeFloat32(this.latitude),e.writeFloat32(this.gravity),e.writeFloat32(this.lifeSpan),e.writeFloat32(this.emissionRate),e.writeFloat32(this.width),e.writeFloat32(this.length),e.writeUint32(this.filterMode),e.writeUint32(this.rows),e.writeUint32(this.columns),e.writeUint32(this.headOrTail),e.writeFloat32(this.tailLength),e.writeFloat32(this.timeMiddle),e.writeFloat32Array(this.segmentColors[0]),e.writeFloat32Array(this.segmentColors[1]),e.writeFloat32Array(this.segmentColors[2]),e.writeUint8Array(this.segmentAlphas),e.writeFloat32Array(this.segmentScaling),e.writeUint32Array(this.headIntervals[0]),e.writeUint32Array(this.headIntervals[1]),e.writeUint32Array(this.tailIntervals[0]),e.writeUint32Array(this.tailIntervals[1]),e.writeInt32(this.textureId),e.writeUint32(this.squirt),e.writeInt32(this.priorityPlane),e.writeUint32(this.replaceableId),this.writeNonGenericAnimationChunks(e)}readMdl(e){for(const t of super.readGenericBlock(e))if(t==="SortPrimsFarZ")this.flags|=65536;else if(t==="Unshaded")this.flags|=32768;else if(t==="LineEmitter")this.flags|=131072;else if(t==="Unfogged")this.flags|=262144;else if(t==="ModelSpace")this.flags|=524288;else if(t==="XYQuad")this.flags|=1048576;else if(t==="static Speed")this.speed=e.readFloat();else if(t==="Speed")this.readAnimation(e,"KP2S");else if(t==="static Variation")this.variation=e.readFloat();else if(t==="Variation")this.readAnimation(e,"KP2R");else if(t==="static Latitude")this.latitude=e.readFloat();else if(t==="Latitude")this.readAnimation(e,"KP2L");else if(t==="static Gravity")this.gravity=e.readFloat();else if(t==="Gravity")this.readAnimation(e,"KP2G");else if(t==="Visibility")this.readAnimation(e,"KP2V");else if(t==="Squirt")this.squirt=1;else if(t==="LifeSpan")this.lifeSpan=e.readFloat();else if(t==="static EmissionRate")this.emissionRate=e.readFloat();else if(t==="EmissionRate")this.readAnimation(e,"KP2E");else if(t==="static Width")this.width=e.readFloat();else if(t==="Width")this.readAnimation(e,"KP2N");else if(t==="static Length")this.length=e.readFloat();else if(t==="Length")this.readAnimation(e,"KP2W");else if(t==="Blend")this.filterMode=0;else if(t==="Additive")this.filterMode=1;else if(t==="Modulate")this.filterMode=2;else if(t==="Modulate2x")this.filterMode=3;else if(t==="AlphaKey")this.filterMode=4;else if(t==="Rows")this.rows=e.readInt();else if(t==="Columns")this.columns=e.readInt();else if(t==="Head")this.headOrTail=0;else if(t==="Tail")this.headOrTail=1;else if(t==="Both")this.headOrTail=2;else if(t==="TailLength")this.tailLength=e.readFloat();else if(t==="Time")this.timeMiddle=e.readFloat();else if(t==="SegmentColor"){e.read();for(let i=0;i<3;i++)e.read(),e.readColor(this.segmentColors[i]);e.read()}else if(t==="Alpha")e.readVector(this.segmentAlphas);else if(t==="ParticleScaling")e.readVector(this.segmentScaling);else if(t==="LifeSpanUVAnim")e.readVector(this.headIntervals[0]);else if(t==="DecayUVAnim")e.readVector(this.headIntervals[1]);else if(t==="TailUVAnim")e.readVector(this.tailIntervals[0]);else if(t==="TailDecayUVAnim")e.readVector(this.tailIntervals[1]);else if(t==="TextureID")this.textureId=e.readInt();else if(t==="ReplaceableId")this.replaceableId=e.readInt();else if(t==="PriorityPlane")this.priorityPlane=e.readInt();else throw new Error(`Unknown token in ParticleEmitter2: "${t}"`)}writeMdl(e){e.startObjectBlock("ParticleEmitter2",this.name),this.writeGenericHeader(e),this.flags&65536&&e.writeFlag("SortPrimsFarZ"),this.flags&32768&&e.writeFlag("Unshaded"),this.flags&131072&&e.writeFlag("LineEmitter"),this.flags&262144&&e.writeFlag("Unfogged"),this.flags&524288&&e.writeFlag("ModelSpace"),this.flags&1048576&&e.writeFlag("XYQuad"),this.writeAnimation(e,"KP2S")||e.writeNumberAttrib("static Speed",this.speed),this.writeAnimation(e,"KP2R")||e.writeNumberAttrib("static Variation",this.variation),this.writeAnimation(e,"KP2L")||e.writeNumberAttrib("static Latitude",this.latitude),this.writeAnimation(e,"KP2G")||e.writeNumberAttrib("static Gravity",this.gravity),this.writeAnimation(e,"KP2V"),this.squirt&&e.writeFlag("Squirt"),e.writeNumberAttrib("LifeSpan",this.lifeSpan),this.writeAnimation(e,"KP2E")||e.writeNumberAttrib("static EmissionRate",this.emissionRate),this.writeAnimation(e,"KP2N")||e.writeNumberAttrib("static Width",this.width),this.writeAnimation(e,"KP2W")||e.writeNumberAttrib("static Length",this.length),this.filterMode===0?e.writeFlag("Blend"):this.filterMode===1?e.writeFlag("Additive"):this.filterMode===2?e.writeFlag("Modulate"):this.filterMode===3?e.writeFlag("Modulate2x"):this.filterMode===4&&e.writeFlag("AlphaKey"),e.writeNumberAttrib("Rows",this.rows),e.writeNumberAttrib("Columns",this.columns),this.headOrTail===0?e.writeFlag("Head"):this.headOrTail===1?e.writeFlag("Tail"):this.headOrTail===2&&e.writeFlag("Both"),e.writeNumberAttrib("TailLength",this.tailLength),e.writeNumberAttrib("Time",this.timeMiddle),e.startBlock("SegmentColor"),e.writeColor("Color",this.segmentColors[0]),e.writeColor("Color",this.segmentColors[1]),e.writeColor("Color",this.segmentColors[2]),e.endBlockComma(),e.writeVectorAttrib("Alpha",this.segmentAlphas),e.writeVectorAttrib("ParticleScaling",this.segmentScaling),e.writeVectorAttrib("LifeSpanUVAnim",this.headIntervals[0]),e.writeVectorAttrib("DecayUVAnim",this.headIntervals[1]),e.writeVectorAttrib("TailUVAnim",this.tailIntervals[0]),e.writeVectorAttrib("TailDecayUVAnim",this.tailIntervals[1]),e.writeNumberAttrib("TextureID",this.textureId),this.replaceableId!==0&&e.writeNumberAttrib("ReplaceableId",this.replaceableId),this.priorityPlane!==0&&e.writeNumberAttrib("PriorityPlane",this.priorityPlane),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 175+super.getByteLength()}};class Vn extends Ue{lifeSpan=0;emissionRate=0;speed=0;color=new Float32Array(3);alpha=1;replaceableId=0;path="";animationVisiblityGuide="";readMdx(e){const t=e.index,i=e.readUint32();super.readMdx(e),this.lifeSpan=e.readFloat32(),this.emissionRate=e.readFloat32(),this.speed=e.readFloat32(),e.readFloat32Array(this.color),this.alpha=e.readFloat32(),this.replaceableId=e.readUint32(),this.path=e.read(260),this.animationVisiblityGuide=e.read(260),this.readAnimations(e,i-(e.index-t))}writeMdx(e){e.writeUint32(this.getByteLength()),super.writeMdx(e),e.writeFloat32(this.lifeSpan),e.writeFloat32(this.emissionRate),e.writeFloat32(this.speed),e.writeFloat32Array(this.color),e.writeFloat32(this.alpha),e.writeUint32(this.replaceableId),e.skip(260-e.write(this.path)),e.skip(260-e.write(this.animationVisiblityGuide)),this.writeNonGenericAnimationChunks(e)}readMdl(e){for(const t of super.readGenericBlock(e))if(t==="SortPrimsFarZ")this.flags|=65536;else if(t==="Unshaded")this.flags|=32768;else if(t==="Unfogged")this.flags|=262144;else if(t==="static LifeSpan")this.lifeSpan=e.readFloat();else if(t==="LifeSpan")this.readAnimation(e,"KPPL");else if(t==="static EmissionRate")this.emissionRate=e.readFloat();else if(t==="EmissionRate")this.readAnimation(e,"KPPE");else if(t==="static Speed")this.speed=e.readFloat();else if(t==="Speed")this.readAnimation(e,"KPPS");else if(t==="static Color")e.readVector(this.color);else if(t==="Color")this.readAnimation(e,"KPPC");else if(t==="static Alpha")this.alpha=e.readFloat();else if(t==="Alpha")this.readAnimation(e,"KPPA");else if(t==="Visibility")this.readAnimation(e,"KPPV");else if(t==="ReplaceableId")this.replaceableId=e.readInt();else if(t==="Path")this.path=e.read();else if(t==="AnimVisibilityGuide")this.animationVisiblityGuide=e.read();else throw new Error(`Unknown token in ParticleEmitterPopcorn: "${t}"`)}writeMdl(e){e.startObjectBlock("ParticleEmitterPopcorn",this.name),this.writeGenericHeader(e),this.flags&65536&&e.writeFlag("SortPrimsFarZ"),this.flags&32768&&e.writeFlag("Unshaded"),this.flags&262144&&e.writeFlag("Unfogged"),this.writeAnimation(e,"KPPL")||e.writeNumberAttrib("static LifeSpan",this.lifeSpan),this.writeAnimation(e,"KPPE")||e.writeNumberAttrib("static EmissionRate",this.emissionRate),this.writeAnimation(e,"KPPS")||e.writeNumberAttrib("static Speed",this.speed),this.writeAnimation(e,"KPPC")||e.writeVectorAttrib("static Color",this.color),this.writeAnimation(e,"KPPA")||e.writeNumberAttrib("static Alpha",this.alpha),this.writeAnimation(e,"KPPV"),this.replaceableId!==0&&e.writeNumberAttrib("ReplaceableId",this.replaceableId),this.path.length&&e.writeStringAttrib("Path",this.path),this.animationVisiblityGuide.length&&e.writeStringAttrib("AnimVisibilityGuide",this.animationVisiblityGuide),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 556+super.getByteLength()}}let Gn=class extends Ue{heightAbove=0;heightBelow=0;alpha=0;color=new Float32Array(3);lifeSpan=0;textureSlot=0;emissionRate=0;rows=0;columns=0;materialId=0;gravity=0;constructor(){super(16384)}readMdx(e){const t=e.index,i=e.readUint32();super.readMdx(e),this.heightAbove=e.readFloat32(),this.heightBelow=e.readFloat32(),this.alpha=e.readFloat32(),e.readFloat32Array(this.color),this.lifeSpan=e.readFloat32(),this.textureSlot=e.readUint32(),this.emissionRate=e.readUint32(),this.rows=e.readUint32(),this.columns=e.readUint32(),this.materialId=e.readInt32(),this.gravity=e.readFloat32(),this.readAnimations(e,i-(e.index-t))}writeMdx(e){e.writeUint32(this.getByteLength()),super.writeMdx(e),e.writeFloat32(this.heightAbove),e.writeFloat32(this.heightBelow),e.writeFloat32(this.alpha),e.writeFloat32Array(this.color),e.writeFloat32(this.lifeSpan),e.writeUint32(this.textureSlot),e.writeUint32(this.emissionRate),e.writeUint32(this.rows),e.writeUint32(this.columns),e.writeInt32(this.materialId),e.writeFloat32(this.gravity),this.writeNonGenericAnimationChunks(e)}readMdl(e){for(const t of super.readGenericBlock(e))if(t==="static HeightAbove")this.heightAbove=e.readFloat();else if(t==="HeightAbove")this.readAnimation(e,"KRHA");else if(t==="static HeightBelow")this.heightBelow=e.readFloat();else if(t==="HeightBelow")this.readAnimation(e,"KRHB");else if(t==="static Alpha")this.alpha=e.readFloat();else if(t==="Alpha")this.readAnimation(e,"KRAL");else if(t==="static Color")e.readColor(this.color);else if(t==="Color")this.readAnimation(e,"KRCO");else if(t==="static TextureSlot")this.textureSlot=e.readInt();else if(t==="TextureSlot")this.readAnimation(e,"KRTX");else if(t==="Visibility")this.readAnimation(e,"KRVS");else if(t==="EmissionRate")this.emissionRate=e.readInt();else if(t==="LifeSpan")this.lifeSpan=e.readFloat();else if(t==="Gravity")this.gravity=e.readFloat();else if(t==="Rows")this.rows=e.readInt();else if(t==="Columns")this.columns=e.readInt();else if(t==="MaterialID")this.materialId=e.readInt();else throw new Error(`Unknown token in RibbonEmitter: "${t}"`)}writeMdl(e){e.startObjectBlock("RibbonEmitter",this.name),this.writeGenericHeader(e),this.writeAnimation(e,"KRHA")||e.writeNumberAttrib("static HeightAbove",this.heightAbove),this.writeAnimation(e,"KRHB")||e.writeNumberAttrib("static HeightBelow",this.heightBelow),this.writeAnimation(e,"KRAL")||e.writeNumberAttrib("static Alpha",this.alpha),this.writeAnimation(e,"KRCO")||e.writeColor("static Color",this.color),this.writeAnimation(e,"KRTX")||e.writeNumberAttrib("static TextureSlot",this.textureSlot),this.writeAnimation(e,"KRVS"),e.writeNumberAttrib("EmissionRate",this.emissionRate),e.writeNumberAttrib("LifeSpan",this.lifeSpan),this.gravity!==0&&e.writeNumberAttrib("Gravity",this.gravity),e.writeNumberAttrib("Rows",this.rows),e.writeNumberAttrib("Columns",this.columns),e.writeNumberAttrib("MaterialID",this.materialId),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 56+super.getByteLength()}},qn=class extends It{name="";position=new Float32Array(3);fieldOfView=0;farClippingPlane=0;nearClippingPlane=0;targetPosition=new Float32Array(3);readMdx(e){const t=e.readUint32();this.name=e.read(80),e.readFloat32Array(this.position),this.fieldOfView=e.readFloat32(),this.farClippingPlane=e.readFloat32(),this.nearClippingPlane=e.readFloat32(),e.readFloat32Array(this.targetPosition),this.readAnimations(e,t-120)}writeMdx(e){e.writeUint32(this.getByteLength()),e.skip(80-e.write(this.name)),e.writeFloat32Array(this.position),e.writeFloat32(this.fieldOfView),e.writeFloat32(this.farClippingPlane),e.writeFloat32(this.nearClippingPlane),e.writeFloat32Array(this.targetPosition),this.writeAnimations(e)}readMdl(e){this.name=e.read();for(let t of e.readBlock())if(t==="Position")e.readVector(this.position);else if(t==="Translation")this.readAnimation(e,"KCTR");else if(t==="Rotation")this.readAnimation(e,"KCRL");else if(t==="FieldOfView")this.fieldOfView=e.readFloat();else if(t==="FarClip")this.farClippingPlane=e.readFloat();else if(t==="NearClip")this.nearClippingPlane=e.readFloat();else if(t==="Target")for(t of e.readBlock())if(t==="Position")e.readVector(this.targetPosition);else if(t==="Translation")this.readAnimation(e,"KTTR");else throw new Error(`Unknown token in Camera ${this.name}'s Target: "${t}"`);else throw new Error(`Unknown token in Camera ${this.name}: "${t}"`)}writeMdl(e){e.startObjectBlock("Camera",this.name),e.writeVectorAttrib("Position",this.position),this.writeAnimation(e,"KCTR"),this.writeAnimation(e,"KCRL"),e.writeNumberAttrib("FieldOfView",this.fieldOfView),e.writeNumberAttrib("FarClip",this.farClippingPlane),e.writeNumberAttrib("NearClip",this.nearClippingPlane),e.startBlock("Target"),e.writeVectorAttrib("Position",this.targetPosition),this.writeAnimation(e,"KTTR"),e.endBlock(),e.endBlock()}getByteLength(){return 120+super.getByteLength()}};class jn extends Ue{globalSequenceId=-1;tracks=new Uint32Array(0);constructor(){super(1024)}readMdx(e){super.readMdx(e),e.skip(4);const t=e.readUint32();this.globalSequenceId=e.readInt32(),this.tracks=e.readUint32Array(t)}writeMdx(e){super.writeMdx(e),e.writeBinary("KEVT"),e.writeUint32(this.tracks.length),e.writeInt32(this.globalSequenceId),e.writeUint32Array(this.tracks)}readMdl(e){for(const t of super.readGenericBlock(e))if(t==="EventTrack"){const i=e.readInt();this.tracks=new Uint32Array(i),e.read(),e.peek()==="GlobalSeqId"&&(e.read(),this.globalSequenceId=e.readInt());for(let n=0;n<i;n++)this.tracks[n]=e.readInt();e.read()}else throw new Error(`Unknown token in EventObject: "${t}"`)}writeMdl(e){e.startObjectBlock("EventObject",this.name),this.writeGenericHeader(e),e.startBlock("EventTrack",this.tracks.length),this.globalSequenceId!==-1&&e.writeNumberAttrib("GlobalSeqId",this.globalSequenceId);for(const t of this.tracks)e.writeFlag(`${t}`);e.endBlock(),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 12+this.tracks.byteLength+super.getByteLength()}}let Kn=class extends Ue{type=0;vertices=[new Float32Array(3),new Float32Array(3)];boundsRadius=0;constructor(){super(8192)}readMdx(e){super.readMdx(e),this.type=e.readUint32(),e.readFloat32Array(this.vertices[0]),this.type!==2&&e.readFloat32Array(this.vertices[1]),(this.type===2||this.type===3)&&(this.boundsRadius=e.readFloat32())}writeMdx(e){super.writeMdx(e),e.writeUint32(this.type),e.writeFloat32Array(this.vertices[0]),this.type!==2&&e.writeFloat32Array(this.vertices[1]),(this.type===2||this.type===3)&&e.writeFloat32(this.boundsRadius)}readMdl(e){for(const t of super.readGenericBlock(e))if(t==="Box")this.type=0;else if(t==="Plane")this.type=1;else if(t==="Sphere")this.type=2;else if(t==="Cylinder")this.type=3;else if(t==="Vertices"){const i=e.readInt();e.read(),e.readVector(this.vertices[0]),i===2&&e.readVector(this.vertices[1]),e.read()}else if(t==="BoundsRadius")this.boundsRadius=e.readFloat();else throw new Error(`Unknown token in CollisionShape: "${t}"`)}writeMdl(e){e.startObjectBlock("CollisionShape",this.name),this.writeGenericHeader(e);let t="",i=2,n=!1;this.type===0?t="Box":this.type===1?t="Plane":this.type===2?(t="Sphere",i=1,n=!0):this.type===3&&(t="Cylinder",n=!0),e.writeFlag(t),e.startBlock("Vertices",i),e.writeVector(this.vertices[0]),i===2&&e.writeVector(this.vertices[1]),e.endBlock(),n&&e.writeNumberAttrib("BoundsRadius",this.boundsRadius),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){let e=16+super.getByteLength();return this.type!==2&&(e+=12),(this.type===2||this.type===3)&&(e+=4),e}};class Hn{type="";path="";readMdx(e){this.type=e.read(80),this.path=e.read(260)}writeMdx(e){e.skip(80-e.write(this.type)),e.skip(260-e.write(this.path))}readMdl(e){this.type=e.read();for(const t of e.readBlock())if(t==="Path")this.path=e.read();else throw new Error(`Unknown token in FaceEffect: "${t}"`)}writeMdl(e){e.startObjectBlock("FaceFX",this.type),e.writeStringAttrib("Path",this.path),e.endBlock()}}class jr{tag;chunk;constructor(e,t,i){this.tag=i,this.chunk=e.readUint8Array(new Uint8Array(t))}writeMdx(e){e.writeBinary(this.tag),e.writeUint32(this.chunk.byteLength),e.writeUint8Array(this.chunk)}getByteLength(){return 8+this.chunk.byteLength}}function $n(s){return s instanceof ArrayBuffer&&(s=new Uint8Array(s)),!!(s instanceof Uint8Array&&s[0]===77&&s[1]===68&&s[2]===76&&s[3]===88||typeof s=="string"&&s.startsWith("MDLX"))}function Xn(s){return s instanceof ArrayBuffer&&(s=new Uint8Array(s)),!!(s instanceof Uint8Array&&cn(s,"FormatVersion",0,4096)||typeof s=="string"&&Dr(s,"FormatVersion",0,4096))}let Yt=class{version=800;name="";animationFile="";extent=new _t;blendTime=0;sequences=[];globalSequences=[];materials=[];textures=[];textureAnimations=[];geosets=[];geosetAnimations=[];bones=[];lights=[];helpers=[];attachments=[];pivotPoints=[];particleEmitters=[];particleEmitters2=[];particleEmittersPopcorn=[];ribbonEmitters=[];cameras=[];eventObjects=[];collisionShapes=[];faceEffects=[];bindPose=[];unknownChunks=[];load(e){if($n(e))typeof e=="string"&&(e=Ai(e)),this.loadMdx(e);else if(Xn(e))typeof e!="string"&&(e=yi(e)),this.loadMdl(e);else throw new Error("Not a valid MDX/MDL buffer")}loadMdx(e){const t=new xt(e);let i,n;for(t.skip(4);t.remaining>0;)i=t.readBinary(4),n=t.readUint32(),i==="VERS"?this.loadVersionChunk(t):i==="MODL"?this.loadModelChunk(t):i==="SEQS"?this.loadStaticObjects(this.sequences,Fn,t,n/132):i==="GLBS"?this.loadGlobalSequenceChunk(t,n):i==="MTLS"?this.loadDynamicObjects(this.materials,Ei,t,n):i==="TEXS"?this.loadStaticObjects(this.textures,xi,t,n/268):i==="TXAN"?this.loadDynamicObjects(this.textureAnimations,Pn,t,n):i==="GEOS"?this.loadDynamicObjects(this.geosets,_i,t,n):i==="GEOA"?this.loadDynamicObjects(this.geosetAnimations,Ii,t,n):i==="BONE"?this.loadDynamicObjects(this.bones,Ci,t,n):i==="LITE"?this.loadDynamicObjects(this.lights,Mn,t,n):i==="HELP"?this.loadDynamicObjects(this.helpers,Un,t,n):i==="ATCH"?this.loadDynamicObjects(this.attachments,On,t,n):i==="PIVT"?this.loadPivotPointChunk(t,n):i==="PREM"?this.loadDynamicObjects(this.particleEmitters,Dn,t,n):i==="PRE2"?this.loadDynamicObjects(this.particleEmitters2,Nn,t,n):i==="CORN"?this.loadDynamicObjects(this.particleEmittersPopcorn,Vn,t,n):i==="RIBB"?this.loadDynamicObjects(this.ribbonEmitters,Gn,t,n):i==="CAMS"?this.loadDynamicObjects(this.cameras,qn,t,n):i==="EVTS"?this.loadDynamicObjects(this.eventObjects,jn,t,n):i==="CLID"?this.loadDynamicObjects(this.collisionShapes,Kn,t,n):i==="FAFX"?this.loadStaticObjects(this.faceEffects,Hn,t,n/340):i==="BPOS"?this.loadBindPoseChunk(t,n):this.unknownChunks.push(new jr(t,n,i))}loadVersionChunk(e){this.version=e.readUint32()}loadModelChunk(e){this.name=e.read(80),this.animationFile=e.read(260),this.extent.readMdx(e),this.blendTime=e.readUint32()}loadStaticObjects(e,t,i,n){for(let r=0;r<n;r++){const o=new t;o.readMdx(i),e.push(o)}}loadGlobalSequenceChunk(e,t){for(let i=0,n=t/4;i<n;i++)this.globalSequences.push(e.readUint32())}loadDynamicObjects(e,t,i,n){const r=i.index+n;for(;i.index<r;){const o=new t;o.readMdx(i,this.version),e.push(o)}}loadPivotPointChunk(e,t){for(let i=0,n=t/12;i<n;i++)this.pivotPoints.push(e.readFloat32Array(3))}loadBindPoseChunk(e,t){for(let i=0,n=e.readUint32();i<n;i++)this.bindPose[i]=e.readFloat32Array(12)}saveMdx(){const e=new xt(new ArrayBuffer(this.getByteLength()));e.writeBinary("MDLX"),this.saveVersionChunk(e),this.saveModelChunk(e),this.saveStaticObjectChunk(e,"SEQS",this.sequences,132),this.saveGlobalSequenceChunk(e),this.saveDynamicObjectChunk(e,"MTLS",this.materials),this.saveStaticObjectChunk(e,"TEXS",this.textures,268),this.saveDynamicObjectChunk(e,"TXAN",this.textureAnimations),this.saveDynamicObjectChunk(e,"GEOS",this.geosets),this.saveDynamicObjectChunk(e,"GEOA",this.geosetAnimations),this.saveDynamicObjectChunk(e,"BONE",this.bones),this.saveDynamicObjectChunk(e,"LITE",this.lights),this.saveDynamicObjectChunk(e,"HELP",this.helpers),this.saveDynamicObjectChunk(e,"ATCH",this.attachments),this.savePivotPointChunk(e),this.saveDynamicObjectChunk(e,"PREM",this.particleEmitters),this.saveDynamicObjectChunk(e,"PRE2",this.particleEmitters2),this.version>800&&this.saveDynamicObjectChunk(e,"CORN",this.particleEmittersPopcorn),this.saveDynamicObjectChunk(e,"RIBB",this.ribbonEmitters),this.saveDynamicObjectChunk(e,"CAMS",this.cameras),this.saveDynamicObjectChunk(e,"EVTS",this.eventObjects),this.saveDynamicObjectChunk(e,"CLID",this.collisionShapes),this.version>800&&(this.saveStaticObjectChunk(e,"FAFX",this.faceEffects,340),this.saveBindPoseChunk(e));for(const t of this.unknownChunks)t.writeMdx(e);return e.uint8array}saveVersionChunk(e){e.writeBinary("VERS"),e.writeUint32(4),e.writeUint32(this.version)}saveModelChunk(e){e.writeBinary("MODL"),e.writeUint32(372),e.skip(80-e.write(this.name)),e.skip(260-e.write(this.animationFile)),this.extent.writeMdx(e),e.writeUint32(this.blendTime)}saveStaticObjectChunk(e,t,i,n){if(i.length){e.writeBinary(t),e.writeUint32(i.length*n);for(const r of i)r.writeMdx(e)}}saveGlobalSequenceChunk(e){if(this.globalSequences.length){e.writeBinary("GLBS"),e.writeUint32(this.globalSequences.length*4);for(const t of this.globalSequences)e.writeUint32(t)}}saveDynamicObjectChunk(e,t,i){if(i.length){e.writeBinary(t),e.writeUint32(this.getObjectsByteLength(i));for(const n of i)n.writeMdx(e,this.version)}}savePivotPointChunk(e){if(this.pivotPoints.length){e.writeBinary("PIVT"),e.writeUint32(this.pivotPoints.length*12);for(const t of this.pivotPoints)e.writeFloat32Array(t)}}saveBindPoseChunk(e){if(this.bindPose.length){e.writeBinary("BPOS"),e.writeUint32(4+this.bindPose.length*48),e.writeUint32(this.bindPose.length);for(const t of this.bindPose)e.writeFloat32Array(t)}}loadMdl(e){let t;const i=new Bn(e);for(;t=i.readToken();)if(t==="Version")this.loadVersionBlock(i);else if(t==="Model")this.loadModelBlock(i);else if(t==="Sequences")this.loadNumberedObjectBlock(this.sequences,Fn,"Anim",i);else if(t==="GlobalSequences")this.loadGlobalSequenceBlock(i);else if(t==="Textures")this.loadNumberedObjectBlock(this.textures,xi,"Bitmap",i);else if(t==="Materials")this.loadNumberedObjectBlock(this.materials,Ei,"Material",i);else if(t==="TextureAnims")this.loadNumberedObjectBlock(this.textureAnimations,Pn,"TVertexAnim",i);else if(t==="Geoset")this.loadObject(this.geosets,_i,i);else if(t==="GeosetAnim")this.loadObject(this.geosetAnimations,Ii,i);else if(t==="Bone")this.loadObject(this.bones,Ci,i);else if(t==="Light")this.loadObject(this.lights,Mn,i);else if(t==="Helper")this.loadObject(this.helpers,Un,i);else if(t==="Attachment")this.loadObject(this.attachments,On,i);else if(t==="PivotPoints")this.loadPivotPointBlock(i);else if(t==="ParticleEmitter")this.loadObject(this.particleEmitters,Dn,i);else if(t==="ParticleEmitter2")this.loadObject(this.particleEmitters2,Nn,i);else if(t==="ParticleEmitterPopcorn")this.loadObject(this.particleEmittersPopcorn,Vn,i);else if(t==="RibbonEmitter")this.loadObject(this.ribbonEmitters,Gn,i);else if(t==="Camera")this.loadObject(this.cameras,qn,i);else if(t==="EventObject")this.loadObject(this.eventObjects,jn,i);else if(t==="CollisionShape")this.loadObject(this.collisionShapes,Kn,i);else if(t==="FaceFX")this.loadObject(this.faceEffects,Hn,i);else if(t==="BindPose")this.loadBindPoseBlock(i);else throw new Error(`Unsupported block: ${t}`)}loadVersionBlock(e){for(const t of e.readBlock())if(t==="FormatVersion")this.version=e.readInt();else throw new Error(`Unknown token in Version: "${t}"`)}loadModelBlock(e){this.name=e.read();for(const t of e.readBlock())if(t.startsWith("Num"))e.read();else if(t==="BlendTime")this.blendTime=e.readInt();else if(t==="MinimumExtent")e.readVector(this.extent.min);else if(t==="MaximumExtent")e.readVector(this.extent.max);else if(t==="BoundsRadius")this.extent.boundsRadius=e.readFloat();else if(t==="AnimationFile")this.animationFile=e.read();else throw new Error(`Unknown token in Model: "${t}"`)}loadNumberedObjectBlock(e,t,i,n){n.read();for(const r of n.readBlock())if(r===i){const o=new t;o.readMdl(n),e.push(o)}else throw new Error(`Unknown token in ${i}: "${r}"`)}loadGlobalSequenceBlock(e){e.read();for(const t of e.readBlock())if(t==="Duration")this.globalSequences.push(e.readInt());else throw new Error(`Unknown token in GlobalSequences: "${t}"`)}loadObject(e,t,i){const n=new t;n.readMdl(i),e.push(n)}loadPivotPointBlock(e){const t=e.readInt();e.read();for(let i=0;i<t;i++)this.pivotPoints.push(e.readVector(new Float32Array(3)));e.read()}loadBindPoseBlock(e){for(const t of e.readBlock())if(t==="Matrices"){const i=e.readInt();e.read();for(let n=0;n<i;n++)this.bindPose[n]=e.readVector(new Float32Array(12));e.read()}else throw new Error(`Unknown token in BindPose: "${t}"`)}saveMdl(){const e=new Bn;return this.saveVersionBlock(e),this.saveModelBlock(e),this.saveStaticObjectsBlock(e,"Sequences",this.sequences),this.saveGlobalSequenceBlock(e),this.saveStaticObjectsBlock(e,"Textures",this.textures),this.saveStaticObjectsBlock(e,"Materials",this.materials),this.saveStaticObjectsBlock(e,"TextureAnims",this.textureAnimations),this.saveObjects(e,this.geosets),this.saveObjects(e,this.geosetAnimations),this.saveObjects(e,this.bones),this.saveObjects(e,this.lights),this.saveObjects(e,this.helpers),this.saveObjects(e,this.attachments),this.savePivotPointBlock(e),this.saveObjects(e,this.particleEmitters),this.saveObjects(e,this.particleEmitters2),this.version>800&&this.saveObjects(e,this.particleEmittersPopcorn),this.saveObjects(e,this.ribbonEmitters),this.saveObjects(e,this.cameras),this.saveObjects(e,this.eventObjects),this.saveObjects(e,this.collisionShapes),this.version>800&&(this.saveObjects(e,this.faceEffects),this.saveBindPoseBlock(e)),e.buffer}saveVersionBlock(e){e.startBlock("Version"),e.writeNumberAttrib("FormatVersion",this.version),e.endBlock()}saveModelBlock(e){e.startObjectBlock("Model",this.name),e.writeNumberAttrib("BlendTime",this.blendTime),this.extent.writeMdl(e),this.animationFile.length&&e.writeStringAttrib("AnimationFile",this.animationFile),e.endBlock()}saveStaticObjectsBlock(e,t,i){if(i.length){e.startBlock(t,i.length);for(const n of i)n.writeMdl(e,this.version);e.endBlock()}}saveGlobalSequenceBlock(e){if(this.globalSequences.length){e.startBlock("GlobalSequences",this.globalSequences.length);for(const t of this.globalSequences)e.writeNumberAttrib("Duration",t);e.endBlock()}}saveObjects(e,t){for(const i of t)i.writeMdl(e,this.version)}savePivotPointBlock(e){if(this.pivotPoints.length){e.startBlock("PivotPoints",this.pivotPoints.length);for(const t of this.pivotPoints)e.writeVector(t);e.endBlock()}}saveBindPoseBlock(e){if(this.bindPose.length){e.startBlock("BindPose"),e.startBlock("Matrices",this.bindPose.length);for(const t of this.bindPose)e.writeVector(t);e.endBlock(),e.endBlock()}}getByteLength(){let e=396;return e+=this.getStaticObjectsChunkByteLength(this.sequences,132),e+=this.getStaticObjectsChunkByteLength(this.globalSequences,4),e+=this.getDynamicObjectsChunkByteLength(this.materials),e+=this.getStaticObjectsChunkByteLength(this.textures,268),e+=this.getDynamicObjectsChunkByteLength(this.textureAnimations),e+=this.getDynamicObjectsChunkByteLength(this.geosets),e+=this.getDynamicObjectsChunkByteLength(this.geosetAnimations),e+=this.getDynamicObjectsChunkByteLength(this.bones),e+=this.getDynamicObjectsChunkByteLength(this.lights),e+=this.getDynamicObjectsChunkByteLength(this.helpers),e+=this.getDynamicObjectsChunkByteLength(this.attachments),e+=this.getStaticObjectsChunkByteLength(this.pivotPoints,12),e+=this.getDynamicObjectsChunkByteLength(this.particleEmitters),e+=this.getDynamicObjectsChunkByteLength(this.particleEmitters2),this.version>800&&(e+=this.getDynamicObjectsChunkByteLength(this.particleEmittersPopcorn)),e+=this.getDynamicObjectsChunkByteLength(this.ribbonEmitters),e+=this.getDynamicObjectsChunkByteLength(this.cameras),e+=this.getDynamicObjectsChunkByteLength(this.eventObjects),e+=this.getDynamicObjectsChunkByteLength(this.collisionShapes),this.version>800&&(e+=this.getStaticObjectsChunkByteLength(this.faceEffects,340),e+=this.getBindPoseChunkByteLength()),e+=this.getObjectsByteLength(this.unknownChunks),e}getObjectsByteLength(e){let t=0;for(const i of e)t+=i.getByteLength(this.version);return t}getDynamicObjectsChunkByteLength(e){return e.length?8+this.getObjectsByteLength(e):0}getStaticObjectsChunkByteLength(e,t){return e.length?8+e.length*t:0}getBindPoseChunkByteLength(){return this.bindPose.length?12+this.bindPose.length*48:0}};class Kr{rows=[];load(e){if(!e.startsWith("ID"))throw new Error("WrongMagicNumber");const t=this.rows;let i=0,n=0;for(const r of e.split(`
`))if(r[0]!=="B")for(const o of r.split(";")){const a=o[0],l=o.substring(1).trim();let c;a==="X"?i=parseInt(l,10)-1:a==="Y"?n=parseInt(l,10)-1:a==="K"&&(t[n]||(t[n]=[]),l[0]==='"'?c=l.slice(1,-1):c=l,t[n][i]=c)}}save(){const e=this.rows,t=e.length,i=[];let n=0;for(let r=0;r<t;r++){const o=e[r],a=o.length;a>n&&(n=a);let l=!0;for(let c=0;c<a;c++){const d=o[c];if(d!==void 0){let h;typeof d=="string"?h=`"${d}"`:typeof d=="boolean"?d?h="TRUE":h="FALSE":h=`${d}`,l?(l=!1,i.push(`C;X${c+1};Y${r+1};K${h}`)):i.push(`C;X${c+1};K${h}`)}}}return`ID;P\r
B;X${n};Y${t}\r
${i.join(`\r
`)}\r
E`}}class Hr{properties=new Map;sections=new Map;load(e){let t=this.properties;const i=this.sections;for(const n of e.split(`\r
`))if(n.length&&!n.startsWith("//")&&!n.startsWith(";")){let r=n.match(/^\[(.+?)\]/);if(r){const o=r[1].trim();t=i.get(o),t||(t=new Map,i.set(o,t))}else if(r=n.match(/^(.+?)=(.*?)$/),r){let o=r[2];o[0]==='"'&&(o=o.slice(1,-1)),t.set(r[1],o)}}}save(){const e=[];for(const[t,i]of this.properties)e.push(`${t}=${i}`);for(const[t,i]of this.sections){e.push(`[${t}]`);for(const[n,r]of i)e.push(`${n}=${r}`)}return e.join(`\r
`)}getSection(e){return this.sections.get(e)}}class Yn{map={};set(e,t){typeof t!="string"&&(t=t.toString()),this.map[e.toLowerCase()]=t}string(e){return this.map[e.toLowerCase()]}number(e){const t=this.string(e);return t?parseFloat(t):0}}class $r{map={};constructor(e){e&&this.load(e)}load(e){if(e.startsWith("ID;")){const t=new Kr;t.load(e);const i=t.rows,n=i[0],r=this.map;for(let o=1,a=i.length;o<a;o++){const l=i[o];if(l){const c=l[0];if(c&&c!=="_"){r[c]||(r[c]=new Yn);const d=r[c];for(let h=0,f=n.length;h<f;h++){let p=n[h];p===void 0&&(p=`column${h}`),d.map[p.toLowerCase()]=l[h]}}}}}else{const t=new Hr;t.load(e);const i=t.sections,n=this.map;for(const[r,o]of i.entries()){n[r]||(n[r]=new Yn);const a=n[r];for(const[l,c]of o)a.map[l.toLowerCase()]=c}}}getRow(e){return this.map[e]}getProperty(e,t){return this.map[e].map[t]}setRow(e,t){this.map[e]=t}findRow(e,t){for(const i of Object.values(this.map))if(i.string(e)===t)return i}}class zn{x=0;y=0;z=0;r=0;fromExtents(e,t){const i=e[0],n=e[1],r=e[2],o=t[0]-i,a=t[1]-n,l=t[2]-r;this.x=i+o/2,this.y=n+a/2,this.z=r+l/2,this.r=Math.max(0,Math.max(o,a,l)/2)}}let Xr=class{name;interval;nonLooping;rarity;bounds;constructor(e){this.name=e.name,this.interval=e.interval,this.nonLooping=e.nonLooping,this.rarity=e.rarity,this.bounds=new zn;const t=e.extent;this.bounds.fromExtents(t.min,t.max)}},Wn=class extends an{bounds=new zn};class Zn{sd;start;end;frames=[];values=[];inTans=[];outTans=[];constant=!1;constructor(e,t,i,n,r){this.sd=e,this.start=t,this.end=i;const o=e.interpolationType,a=n.frames,l=n.values,c=n.inTans,d=n.outTans,h=e.defval;r&&a[0]>i&&(this.frames[0]=a[0],this.values[0]=l[0]);for(let p=0,u=a.length;p<u;p++){const g=a[p];g>=t&&g<=i&&(this.frames.push(g),this.values.push(l[p]),o>1&&(this.inTans.push(c[p]),this.outTans.push(d[p])))}const f=this.frames.length;if(f===0)this.constant=!0,this.frames[0]=t,this.values[0]=h;else if(f===1)this.constant=!0;else{const p=this.values[0];this.constant=this.values.every(u=>p.every((g,v)=>g===u[v]))}}getValue(e,t){const n=this.frames.length;if(this.constant||t<this.start)return this.sd.copy(e,this.values[0]),-1;{let r=-1,o=-1;const a=n-1;if(t<this.frames[0]||t>=this.frames[a])r=a,o=0;else for(let f=1;f<n;f++)if(this.frames[f]>t){r=f-1,o=f;break}let l=this.frames[r];const c=this.frames[o];let d=c-l;d<0&&(d+=this.end-this.start,t<l&&(l=c));const h=d==0?0:(t-l)/d;return this.sd.interpolate(e,this.values,this.inTans,this.outTans,r,o,h),r}}}const Yr={KLAV:de.DontInterp,KATV:de.DontInterp,KPEV:de.DontInterp,KP2V:de.DontInterp,KRVS:de.DontInterp},ie=new Float32Array(1),zr=new Uint32Array(1),ut=new Float32Array([1]),Lt=m.vec3.create(),Qn=m.quat.create(),Jn=m.vec3.fromValues(1,1,1),es=ut,zt=Lt,Wr={KMTF:ie,KMTA:es,KTAT:Lt,KTAR:Qn,KTAS:Jn,KGAO:es,KGAC:zt,KLAS:ie,KLAE:ie,KLAC:zt,KLAI:ie,KLBI:ie,KLBC:zt,KLAV:ut,KATV:ut,KPEE:ie,KPEG:ie,KPLN:ie,KPLT:ie,KPEL:ie,KPES:ie,KPEV:ut,KP2S:ie,KP2R:ie,KP2L:ie,KP2G:ie,KP2E:ie,KP2N:ie,KP2W:ie,KP2V:ut,KRHA:ie,KRHB:ie,KRAL:new Float32Array([0]),KRCO:zt,KRTX:ie,KRVS:ut,KCTR:Lt,KTTR:Lt,KCRL:zr,KGTR:Lt,KGRT:Qn,KGSC:Jn};let Li=class{defval;model;name;globalSequence=null;sequences=[];interpolationType;constructor(e,t){const i=e.globalSequences,n=t.globalSequenceId,r=Yr[t.name];if(this.model=e,this.name=t.name,this.defval=Wr[t.name],this.interpolationType=r!==void 0?r:t.interpolationType,n!==-1&&i)this.globalSequence=new Zn(this,0,i[n],t,!0);else for(const o of e.sequences){const a=o.interval;this.sequences.push(new Zn(this,a[0],a[1],t,!1))}}getValue(e,t,i,n){return this.globalSequence?this.globalSequence.getValue(e,n%this.globalSequence.end):this.sequences[t].getValue(e,i)}isVariant(e){return this.globalSequence?!this.globalSequence.constant:!this.sequences[e].constant}};class Zr extends Li{copy(e,t){e[0]=t[0]}interpolate(e,t,i,n,r,o,a){const l=this.interpolationType,c=t[r][0];l===de.DontInterp?e[0]=c:l===de.Linear?e[0]=on(c,t[o][0],a):l===de.Hermite?e[0]=xr(c,n[r][0],i[o][0],t[o][0],a):l===de.Bezier&&(e[0]=_r(c,n[r][0],i[o][0],t[o][0],a))}}class Qr extends Li{copy(e,t){m.vec3.copy(e,t)}interpolate(e,t,i,n,r,o,a){const l=this.interpolationType;l===de.DontInterp?m.vec3.copy(e,t[r]):l===de.Linear?m.vec3.lerp(e,t[r],t[o],a):l===de.Hermite?m.vec3.hermite(e,t[r],n[r],i[o],t[o],a):l===de.Bezier&&m.vec3.bezier(e,t[r],n[r],i[o],t[o],a)}}class Jr extends Li{copy(e,t){m.quat.copy(e,t)}interpolate(e,t,i,n,r,o,a){const l=this.interpolationType;l===de.DontInterp?m.quat.copy(e,t[r]):l===de.Linear?m.quat.slerp(e,t[r],t[o],a):(l===de.Hermite||l===de.Bezier)&&m.quat.sqlerp(e,t[r],n[r],i[o],t[o],a)}}function eo(s,e){return e instanceof Xt||e instanceof q?new Zr(s,e):e instanceof _e?new Qr(s,e):new Jr(s,e)}class Rt{model;animations=new Map;variants={};constructor(e,t){this.model=e;for(const i of t.animations)this.animations.set(i.name,eo(e,i))}getScalarValue(e,t,i,n,r,o){if(i!==-1){const a=this.animations.get(t);if(a)return a.getValue(e,i,n,r)}return e[0]=o,-1}getVectorValue(e,t,i,n,r,o){if(i!==-1){const a=this.animations.get(t);if(a)return a.getValue(e,i,n,r)}return e[0]=o[0],e[1]=o[1],e[2]=o[2],-1}getQuatValue(e,t,i,n,r,o){if(i!==-1){const a=this.animations.get(t);if(a)return a.getValue(e,i,n,r)}return e[0]=o[0],e[1]=o[1],e[2]=o[2],e[3]=o[3],-1}addVariants(e,t){const i=this.animations.get(e),n=this.model.sequences.length,r=new Uint8Array(n);if(i)for(let o=0;o<n;o++)i.isVariant(o)&&(r[o]=1);this.variants[t]=r}addVariantIntersection(e,t){const i=this.model.sequences.length,n=new Uint8Array(i);for(let r=0;r<i;r++)for(const o of e)this.variants[o][r]&&(n[r]=1);this.variants[t]=n}}class to extends Rt{constructor(e,t){super(e,t),this.addVariants("KTAT","translation"),this.addVariants("KTAR","rotation"),this.addVariants("KTAS","scale")}getTranslation(e,t,i,n){return this.getVectorValue(e,"KTAT",t,i,n,at)}getRotation(e,t,i,n){return this.getQuatValue(e,"KTAR",t,i,n,vi)}getScale(e,t,i,n){return this.getVectorValue(e,"KTAS",t,i,n,gi)}}function io(s,e){return s===ke.Blend?[e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA]:s===ke.Additive?[e.SRC_ALPHA,e.ONE]:s===ke.AddAlpha?[e.SRC_ALPHA,e.ONE]:s===ke.Modulate?[e.ZERO,e.SRC_COLOR]:s===ke.Modulate2x?[e.DST_COLOR,e.SRC_COLOR]:[0,0]}function ts(s,e){return s===ht.Blend?[e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA]:s===ht.Additive?[e.SRC_ALPHA,e.ONE]:s===ht.Modulate?[e.ZERO,e.SRC_COLOR]:s===ht.Modulate2x?[e.DST_COLOR,e.SRC_COLOR]:s===ht.AlphaKey?[e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA]:[0,0]}let no=class extends Rt{index;priorityPlane;filterMode;textureId=0;coordId;alpha;unshaded;sphereEnvironmentMap;twoSided;unfogged;noDepthTest;noDepthSet;depthMaskValue;blendSrc=0;blendDst=0;blended=!1;textureAnimation=null;constructor(e,t,i,n){super(e,t);let r=t.filterMode;const o=t.textureAnimationId,a=e.viewer.gl;this.index=i,this.priorityPlane=n,r>ke.Modulate2x&&(r=ke.Blend),this.filterMode=r,t.textureId!==-1&&(this.textureId=t.textureId),this.coordId=t.coordId,this.alpha=t.alpha;const l=t.flags;if(this.unshaded=l&je.Unshaded,this.sphereEnvironmentMap=l&je.SphereEnvMap,this.twoSided=l&je.TwoSided,this.unfogged=l&je.Unfogged,this.noDepthTest=l&je.NoDepthTest,this.noDepthSet=l&je.NoDepthSet,this.depthMaskValue=r===ke.None||r===ke.Transparent,r>ke.Transparent&&(this.blended=!0,[this.blendSrc,this.blendDst]=io(r,a)),o!==-1){const c=e.textureAnimations[o];c&&(this.textureAnimation=c)}this.addVariants("KMTA","alpha"),this.addVariants("KMTF","textureId")}bind(e){const t=this.model.viewer.gl;t.uniform1f(e.uniforms.u_filterMode,this.filterMode),this.blended?(t.enable(t.BLEND),t.blendFunc(this.blendSrc,this.blendDst)):t.disable(t.BLEND),this.twoSided?t.disable(t.CULL_FACE):t.enable(t.CULL_FACE),this.noDepthTest?t.disable(t.DEPTH_TEST):t.enable(t.DEPTH_TEST),this.noDepthSet?t.depthMask(!1):t.depthMask(this.depthMaskValue)}getAlpha(e,t,i,n){return this.getScalarValue(e,"KMTA",t,i,n,this.alpha)}getTextureId(e,t,i,n){return this.getScalarValue(e,"KMTF",t,i,n,this.textureId)}};class so{model;shader;layers;constructor(e,t,i){this.model=e,this.shader=t,this.layers=i}}class ro extends Rt{alpha;color;geosetId;constructor(e,t){super(e,t);const i=t.color;this.alpha=t.alpha,this.color=m.vec3.fromValues(i[2],i[1],i[0]),this.geosetId=t.geosetId,this.addVariants("KGAO","alpha"),this.addVariants("KGAC","color")}getAlpha(e,t,i,n){return this.getScalarValue(e,"KGAO",t,i,n,this.alpha)}getColor(e,t,i,n){return this.getVectorValue(e,"KGAC",t,i,n,this.color)}}const is={1:"TeamColor/TeamColor00",2:"TeamGlow/TeamGlow00",11:"Cliff/Cliff0",21:"",31:"LordaeronTree/LordaeronSummerTree",32:"AshenvaleTree/AshenTree",33:"BarrensTree/BarrensTree",34:"NorthrendTree/NorthTree",35:"Mushroom/MushroomTree",36:"RuinsTree/RuinsTree",37:"OutlandMushroomTree/MushroomTree"};class Oe extends Rt{index;name;objectId;parentId;pivot;dontInheritTranslation;dontInheritRotation;dontInheritScaling;billboarded;billboardedX;billboardedY;billboardedZ;cameraAnchored;anyBillboarding;constructor(e,t,i){super(e,t),this.index=i,this.name=t.name,this.objectId=t.objectId,this.parentId=t.parentId,this.pivot=e.pivotPoints[t.objectId]||m.vec3.create();const n=t.flags;this.dontInheritTranslation=(n&Ke.DontInheritTranslation)>0,this.dontInheritRotation=(n&Ke.DontInheritRotation)>0,this.dontInheritScaling=(n&Ke.DontInheritScaling)>0,this.billboarded=(n&Ke.Billboarded)>0,this.billboardedX=(n&Ke.BillboardedLockX)>0,this.billboardedY=(n&Ke.BillboardedLockY)>0,this.billboardedZ=(n&Ke.BillboardedLockZ)>0,this.cameraAnchored=(n&Ke.CameraAnchored)>0,this.anyBillboarding=this.billboarded||this.billboardedX||this.billboardedY||this.billboardedZ,t.objectId===t.parentId&&(this.parentId=-1),this.addVariants("KGTR","translation"),this.addVariants("KGRT","rotation"),this.addVariants("KGSC","scale"),this.addVariantIntersection(["translation","rotation","scale"],"generic")}getVisibility(e,t,i,n){return e[0]=1,-1}getTranslation(e,t,i,n){return this.getVectorValue(e,"KGTR",t,i,n,at)}getRotation(e,t,i,n){return this.getQuatValue(e,"KGRT",t,i,n,vi)}getScale(e,t,i,n){return this.getVectorValue(e,"KGSC",t,i,n,gi)}}let oo=class extends Oe{geosetAnimation;constructor(e,t,i){super(e,t,i),this.geosetAnimation=e.geosetAnimations[t.geosetAnimationId]}getVisibility(e,t,i,n){return this.geosetAnimation?this.geosetAnimation.getAlpha(e,t,i,n):(e[0]=1,-1)}};class ao extends Oe{type;attenuation;color;intensity;ambientColor;ambientIntensity;constructor(e,t,i){super(e,t,i),this.type=t.type,this.attenuation=t.attenuation,this.color=t.color,this.intensity=t.intensity,this.ambientColor=t.ambientColor,this.ambientIntensity=t.ambientIntensity}getAttenuationStart(e,t,i,n){return this.getScalarValue(e,"KLAS",t,i,n,this.attenuation[0])}getAttenuationEnd(e,t,i,n){return this.getScalarValue(e,"KLAE",t,i,n,this.attenuation[1])}getIntensity(e,t,i,n){return this.getScalarValue(e,"KLAI",t,i,n,this.intensity)}getColor(e,t,i,n){return this.getVectorValue(e,"KLAC",t,i,n,this.color)}getAmbientIntensity(e,t,i,n){return this.getScalarValue(e,"KLBI",t,i,n,this.ambientIntensity)}getAmbientColor(e,t,i,n){return this.getVectorValue(e,"KLBC",t,i,n,this.ambientColor)}}class lo extends Oe{}class co extends Oe{path;attachmentId;internalModel=null;constructor(e,t,i){super(e,t,i);const n=t.path.replace(/\\/g,"/").toLowerCase().replace(".mdl",".mdx");if(this.path=n,this.attachmentId=t.attachmentId,n!==""&&n.indexOf(".mdx")!=-1){const r=e.viewer.load(n,e.pathSolver,e.solverParams);r.then(o=>{o&&(this.internalModel=o)}),e.blockers.push(r)}}getVisibility(e,t,i,n){return this.getScalarValue(e,"KATV",t,i,n,1)}}class ho extends Oe{internalModel=null;speed;latitude;longitude;lifeSpan;gravity;emissionRate;ok=!1;constructor(e,t,i){super(e,t,i),this.speed=t.speed,this.latitude=t.latitude,this.longitude=t.longitude,this.lifeSpan=t.lifeSpan,this.gravity=t.gravity,this.emissionRate=t.emissionRate,e.viewer.load(t.path.replace(/\\/g,"/").toLowerCase().replace(".mdl",".mdx"),e.pathSolver,e.solverParams).then(n=>{n&&(this.internalModel=n,this.ok=!0)})}getSpeed(e,t,i,n){return this.getScalarValue(e,"KPES",t,i,n,this.speed)}getLatitude(e,t,i,n){return this.getScalarValue(e,"KPLTV",t,i,n,this.latitude)}getLongitude(e,t,i,n){return this.getScalarValue(e,"KPLN",t,i,n,this.longitude)}getLifeSpan(e,t,i,n){return this.getScalarValue(e,"KPEL",t,i,n,this.lifeSpan)}getGravity(e,t,i,n){return this.getScalarValue(e,"KPEG",t,i,n,this.gravity)}getEmissionRate(e,t,i,n){return this.getScalarValue(e,"KPEE",t,i,n,this.emissionRate)}getVisibility(e,t,i,n){return this.getScalarValue(e,"KPEV",t,i,n,1)}}const uo=m.vec3.create(),fo=m.vec3.create(),po=m.vec3.create(),Be=60,Ri=Be>>2,ns=0,mo=12,go=24,vo=36,ss=48,rs=52,os=56,Bi=57,Fi=ns>>2,as=ss>>2,bo=Bi,ls=0,ki=1,cs=2,wo=3,hs=1e3,Pi=1e4,ds=2;function yo(s,e){const t=s.instance,i=s.objects,n=e.byteView,r=e.floatView,o=s.emitterObject,a=o.modelSpace,l=o.tailLength,c=s.node,d=t.teamColor;let h=0;for(const f of i){const p=h*Be,u=h*Ri,g=u+Fi;let v=f.location;const w=f.scale,y=f.tail;if(y===dt.Head)a&&(v=m.vec3.transformMat4(uo,v,c.worldMatrix)),r[g+0]=v[0],r[g+1]=v[1],r[g+2]=v[2],r[g+3]=f.facing;else{const R=f.velocity;let E=fo,x=v;E[0]=x[0]-l*R[0],E[1]=x[1]-l*R[1],E[2]=x[2]-l*R[2],a&&(E=m.vec3.transformMat4(E,E,c.worldMatrix),x=m.vec3.transformMat4(po,x,c.worldMatrix)),r[g+0]=E[0],r[g+1]=E[1],r[g+2]=E[2],r[g+3]=x[0],r[g+4]=x[1],r[g+5]=x[2]}r[g+6]=w[0],r[g+7]=w[0],r[g+8]=w[0],r[u+as]=f.health,n[p+os]=y,n[p+bo]=d,h+=1}}function Ao(s,e){const t=s.instance,i=t.textureOverrides,r=t.scene.camera,o=s.emitterObject,a=o.model,l=a.viewer,c=l.gl,d=l.sharedCache.get("mdx"),h=e.uniforms,f=o.colors,p=o.intervals,u=o.replaceableId;let g,v=o.internalTexture;c.blendFunc(o.blendSrc,o.blendDst),c.uniform1f(h.u_filterMode,o.filterMode),o.internalTexture?v=o.internalTexture:u===1?v=d.teamColors[t.teamColor]:u===2?v=d.teamGlows[t.teamColor]:v=a.textures[o.textureId];let w=i.get(hs+o.index);w||(u===0&&(w=i.get(o.textureId)),w||(w=v.texture)),l.webgl.bindTextureAndWrap(w,0,v.wrapS,v.wrapT),o.xYQuad?g=r.vectors:g=r.billboardedVectors,c.uniform1f(h.u_lifeSpan,o.lifeSpan),c.uniform1f(h.u_timeMiddle,o.timeMiddle),c.uniform1f(h.u_columns,o.columns),c.uniform1f(h.u_rows,o.rows),c.uniform1f(h.u_teamColored,o.teamColored),c.uniform3fv(h["u_intervals[0]"],p[0]),c.uniform3fv(h["u_intervals[1]"],p[1]),c.uniform3fv(h["u_intervals[2]"],p[2]),c.uniform3fv(h["u_intervals[3]"],p[3]),c.uniform4fv(h["u_colors[0]"],f[0]),c.uniform4fv(h["u_colors[1]"],f[1]),c.uniform4fv(h["u_colors[2]"],f[2]),c.uniform3fv(h.u_scaling,o.scaling),o.head&&(c.uniform3fv(h["u_vertices[0]"],g[0]),c.uniform3fv(h["u_vertices[1]"],g[1]),c.uniform3fv(h["u_vertices[2]"],g[2]),c.uniform3fv(h["u_vertices[3]"],g[3])),o.tail&&c.uniform3fv(h.u_cameraZ,r.directionZ)}function To(s,e){let t=s.first;const i=e.byteView,n=e.floatView,o=s.emitterObject.columns,l=1/(s.alive-1);let c=0;for(;t.next;){const d=t.next.vertices,h=c*Be,p=c*Ri+Fi,u=h+rs,g=h+Bi,v=(t.slot%o+(1-c*l-l))/o,w=t.slot/o,y=v+l,R=t.vertices,E=t.color;n[p+0]=R[0],n[p+1]=R[1],n[p+2]=R[2],n[p+3]=R[3],n[p+4]=R[4],n[p+5]=R[5],n[p+6]=d[3],n[p+7]=d[4],n[p+8]=d[5],n[p+9]=d[0],n[p+10]=d[1],n[p+11]=d[2],i[u+0]=E[0],i[u+1]=E[1],i[u+2]=E[2],i[u+3]=E[3],i[g+0]=v*255,i[g+1]=y*255,i[g+2]=w*255,t=t.next,c+=1}}function So(s,e){const t=s.instance.textureOverrides,i=s.emitterObject,n=i.layer,r=i.model,o=r.viewer.gl,a=e.uniforms,l=r.textures[n.textureId],c=t.get(n.textureId)||l.texture;n.bind(e),o.uniform1f(a.u_filterMode,n.filterMode),r.viewer.webgl.bindTextureAndWrap(c,0,l.wrapS,l.wrapT),o.uniform1f(a.u_columns,i.columns),o.uniform1f(a.u_rows,i.rows)}function us(s,e){const t=s.objects,i=e.floatView;let n=0;for(const r of t){const o=n*Ri,a=o+Fi,l=r.vertices;i[a+0]=l[0],i[a+1]=l[1],i[a+2]=l[2],i[a+3]=l[3],i[a+4]=l[4],i[a+5]=l[5],i[a+6]=l[6],i[a+7]=l[7],i[a+8]=l[8],i[a+9]=l[9],i[a+10]=l[10],i[a+11]=l[11],i[o+as]=r.health,n+=1}}function Eo(s,e){const t=s.instance.textureOverrides,i=s.emitterObject,n=i.intervalTimes,r=i.intervals,o=i.colors,a=i.model,l=a.viewer.gl,c=e.uniforms,d=i.internalTexture,h=t.get(Pi+i.index)||d.texture;l.blendFunc(i.blendSrc,i.blendDst),a.viewer.webgl.bindTextureAndWrap(h,0,d.wrapS,d.wrapT),l.uniform1f(c.u_lifeSpan,i.lifeSpan),l.uniform1f(c.u_columns,i.columns),l.uniform1f(c.u_rows,i.rows),l.uniform3f(c.u_intervalTimes,n[0],n[1],0),l.uniform3fv(c["u_intervals[0]"],r[0]),l.uniform3fv(c["u_intervals[1]"],r[1]),l.uniform4fv(c["u_colors[0]"],o[0]),l.uniform4fv(c["u_colors[1]"],o[1]),l.uniform4fv(c["u_colors[2]"],o[2])}function xo(s,e){const t=s.instance.textureOverrides,i=s.emitterObject,n=i.intervalTimes,r=i.colors,o=i.model,l=o.viewer.gl,c=e.uniforms,d=i.internalTexture,h=t.get(Pi+i.index)||d.texture;l.blendFunc(i.blendSrc,i.blendDst),o.viewer.webgl.bindTextureAndWrap(h,0,d.wrapS,d.wrapT),l.uniform1f(c.u_lifeSpan,i.lifeSpan),l.uniform1f(c.u_columns,i.columns),l.uniform1f(c.u_rows,i.rows),l.uniform3fv(c.u_intervalTimes,n),l.uniform4fv(c["u_colors[0]"],r[0]),l.uniform4fv(c["u_colors[1]"],r[1]),l.uniform4fv(c["u_colors[2]"],r[2])}function _o(s,e){let t=s.alive;const n=s.emitterObject.geometryEmitterType;if(n===ki&&(t-=1),t>0){const r=s.instance.model.viewer,o=r.buffer,a=r.gl,l=r.webgl.extensions.ANGLE_instanced_arrays,c=t*Be,d=e.attribs;o.reserve(c),n===ls?(yo(s,o),Ao(s,e)):n===ki?(To(s,o),So(s,e)):n===cs?(us(s,o),Eo(s,e)):(us(s,o),xo(s,e)),o.bindAndUpdate(c),a.uniform1i(e.uniforms.u_emitter,n),a.vertexAttribPointer(d.a_p0,3,a.FLOAT,!1,Be,ns),a.vertexAttribPointer(d.a_p1,3,a.FLOAT,!1,Be,mo),a.vertexAttribPointer(d.a_p2,3,a.FLOAT,!1,Be,go),a.vertexAttribPointer(d.a_p3,3,a.FLOAT,!1,Be,vo),a.vertexAttribPointer(d.a_health,1,a.FLOAT,!1,Be,ss),a.vertexAttribPointer(d.a_color,4,a.UNSIGNED_BYTE,!0,Be,rs),a.vertexAttribPointer(d.a_tail,1,a.UNSIGNED_BYTE,!1,Be,os),a.vertexAttribPointer(d.a_leftRightTop,3,a.UNSIGNED_BYTE,!1,Be,Bi),l.drawArraysInstancedANGLE(a.TRIANGLES,0,6,t)}}class Bt{texture=null;replaceableId;wrapS=33071;wrapT=33071;constructor(e,t){this.replaceableId=e,t&et.WrapWidth&&(this.wrapS=10497),t&et.WrapHeight&&(this.wrapT=10497)}}class fs extends Oe{geometryEmitterType=ls;width;length;speed;latitude;gravity;emissionRate;squirt;lifeSpan;variation;tailLength;timeMiddle;columns;rows;teamColored=0;internalTexture=null;replaceableId;textureId;head;tail;cellWidth;cellHeight;colors=[];scaling;intervals;filterMode;blendSrc;blendDst;priorityPlane;lineEmitter;unfogged;modelSpace;xYQuad;ok=!0;constructor(e,t,i){super(e,t,i),this.width=t.width,this.length=t.length,this.speed=t.speed,this.latitude=t.latitude,this.gravity=t.gravity,this.emissionRate=t.emissionRate*ds,this.squirt=t.squirt,this.lifeSpan=t.lifeSpan,this.variation=t.variation,this.tailLength=t.tailLength,this.timeMiddle=t.timeMiddle;const n=t.flags;this.lineEmitter=n&Ct.LineEmitter,this.unfogged=n&Ct.Unfogged,this.modelSpace=n&Ct.ModelSpace,this.xYQuad=n&Ct.XYQuad;const r=t.replaceableId;if(this.columns=t.columns,this.rows=t.rows,r===1||r===2)this.teamColored=1;else if(r>2){const f=e.reforged?".dds":".blp";this.internalTexture=new Bt(r,et.RepeatBoth),e.viewer.load(`ReplaceableTextures\\${is[r]}${f}`,e.pathSolver,e.solverParams).then(p=>{p&&(this.internalTexture.texture=p)})}this.replaceableId=t.replaceableId,this.textureId=t.textureId;const o=t.headOrTail;this.head=o===dt.Head||o===dt.Both,this.tail=o===dt.Tail||o===dt.Both,this.cellWidth=1/t.columns,this.cellHeight=1/t.rows;const a=t.segmentColors,l=t.segmentAlphas;for(let f=0;f<3;f++){const p=a[f];this.colors[f]=new Float32Array([p[0],p[1],p[2],l[f]/255])}this.scaling=t.segmentScaling;const c=t.headIntervals,d=t.tailIntervals;this.intervals=[new Float32Array(c[0]),new Float32Array(c[1]),new Float32Array(d[0]),new Float32Array(d[1])];const h=ts(t.filterMode,this.model.viewer.gl);this.filterMode=t.filterMode,this.blendSrc=h[0],this.blendDst=h[1],this.priorityPlane=t.priorityPlane}getWidth(e,t,i,n){return this.getScalarValue(e,"KP2N",t,i,n,this.width)}getLength(e,t,i,n){return this.getScalarValue(e,"KP2W",t,i,n,this.length)}getSpeed(e,t,i,n){return this.getScalarValue(e,"KP2S",t,i,n,this.speed)}getLatitude(e,t,i,n){return this.getScalarValue(e,"KP2L",t,i,n,this.latitude)}getGravity(e,t,i,n){return this.getScalarValue(e,"KP2G",t,i,n,this.gravity)}getEmissionRate(e,t,i,n){return this.getScalarValue(e,"KP2E",t,i,n,this.emissionRate)}getVariation(e,t,i,n){return this.getScalarValue(e,"KP2R",t,i,n,this.variation)}getVisibility(e,t,i,n){return this.getScalarValue(e,"KP2V",t,i,n,1)}}class ps extends Oe{geometryEmitterType=ki;layer;heightAbove;heightBelow;alpha;color;lifeSpan;textureSlot;emissionRate;gravity;columns;rows;ok=!0;constructor(e,t,i){super(e,t,i),this.layer=e.materials[t.materialId].layers[0],this.heightAbove=t.heightAbove,this.heightBelow=t.heightBelow,this.alpha=t.alpha,this.color=t.color,this.lifeSpan=t.lifeSpan,this.textureSlot=t.textureSlot,this.emissionRate=t.emissionRate*ds,this.gravity=t.gravity,this.columns=t.columns,this.rows=t.rows}getHeightBelow(e,t,i,n){return this.getScalarValue(e,"KRHB",t,i,n,this.heightBelow)}getHeightAbove(e,t,i,n){return this.getScalarValue(e,"KRHA",t,i,n,this.heightAbove)}getTextureSlot(e,t,i,n){return this.getScalarValue(e,"KRTX",t,i,n,0)}getColor(e,t,i,n){return this.getVectorValue(e,"KRCO",t,i,n,this.color)}getAlpha(e,t,i,n){return this.getScalarValue(e,"KRAL",t,i,n,this.alpha)}getVisibility(e,t,i,n){const r=this.getAlpha(e,t,i,n);return e[0]===0?r:this.getScalarValue(e,"KRVS",t,i,n,1)}}let Io=class extends Rt{name;position;fieldOfView;farClippingPlane;nearClippingPlane;targetPosition;constructor(e,t){super(e,t),this.name=t.name,this.position=t.position,this.fieldOfView=t.fieldOfView,this.farClippingPlane=t.farClippingPlane,this.nearClippingPlane=t.nearClippingPlane,this.targetPosition=t.targetPosition}getTranslation(e,t,i,n){return this.getVectorValue(e,"KCTR",t,i,n,at)}getTargetTranslation(e,t,i,n){return this.getVectorValue(e,"KTTR",t,i,n,at)}getRotation(e,t,i,n){return this.getScalarValue(e,"KCRL",t,i,n,0)}};class Co extends Oe{geometryEmitterType=-1;type;id;tracks;globalSequence=-1;defval=new Uint32Array(1);internalModel=null;internalTexture=null;colors=[];intervalTimes=new Float32Array(3);scale=0;columns=0;rows=0;lifeSpan=0;blendSrc=0;blendDst=0;intervals=[];distanceCutoff=0;maxDistance=0;minDistance=0;pitch=0;pitchVariance=0;volume=0;decodedBuffers=[];ok=!1;constructor(e,t,i){super(e,t,i);const n=e.viewer,r=t.name;let o=r.substring(0,3);const a=r.substring(4);o==="FPT"&&(o="SPL"),o==="SPL"?this.geometryEmitterType=cs:o==="UBR"&&(this.geometryEmitterType=wo),this.type=o,this.id=a,this.tracks=t.tracks;const l=t.globalSequenceId;if(l!==-1&&(this.globalSequence=e.globalSequences[l]),o==="SND"&&!n.audioEnabled)return;const c=n.promise();ii.getEventObjectData(n,o,a,e.hd).then(d=>{if(c(),d){const{row:h,resources:f}=d;if(this.ok=!0,o==="SPN")this.internalModel=f[0];else if(o==="SPL"||o==="UBR"){this.internalTexture=new Bt(0,et.WrapBoth),this.internalTexture.texture=f[0],this.scale=h.number("Scale"),this.colors[0]=new Float32Array([h.number("StartR"),h.number("StartG"),h.number("StartB"),h.number("StartA")]),this.colors[1]=new Float32Array([h.number("MiddleR"),h.number("MiddleG"),h.number("MiddleB"),h.number("MiddleA")]),this.colors[2]=new Float32Array([h.number("EndR"),h.number("EndG"),h.number("EndB"),h.number("EndA")]),o==="SPL"?(this.columns=h.number("Columns"),this.rows=h.number("Rows"),this.lifeSpan=h.number("Lifespan")+h.number("Decay"),this.intervalTimes[0]=h.number("Lifespan"),this.intervalTimes[1]=h.number("Decay"),this.intervals[0]=new Float32Array([h.number("UVLifespanStart"),h.number("UVLifespanEnd"),h.number("LifespanRepeat")]),this.intervals[1]=new Float32Array([h.number("UVDecayStart"),h.number("UVDecayEnd"),h.number("DecayRepeat")])):(this.columns=1,this.rows=1,this.lifeSpan=h.number("BirthTime")+h.number("PauseTime")+h.number("Decay"),this.intervalTimes[0]=h.number("BirthTime"),this.intervalTimes[1]=h.number("PauseTime"),this.intervalTimes[2]=h.number("Decay"));const p=ts(h.number("BlendMode"),n.gl);this.blendSrc=p[0],this.blendDst=p[1]}else{this.distanceCutoff=h.number("DistanceCutoff"),this.maxDistance=h.number("MaxDistance"),this.minDistance=h.number("MinDistance"),this.pitch=h.number("Pitch"),this.pitchVariance=h.number("PitchVariance"),this.volume=h.number("Volume");for(const p of f)this.decodedBuffers.push(p.data)}}})}getValue(e,t){if(this.globalSequence!==-1){const i=this.globalSequence;return this.getValueAtTime(e,t.counter%i,0,i)}else if(t.sequence!==-1){const i=this.model.sequences[t.sequence].interval;return this.getValueAtTime(e,t.frame,i[0],i[1])}else return e[0]=this.defval[0],-1}getValueAtTime(e,t,i,n){const r=this.tracks;if(t>=i&&t<=n)for(let o=r.length-1;o>-1;o--){if(r[o]<i)return e[0]=0,o;if(r[o]<=t)return e[0]=1,o}return e[0]=0,-1}}class Lo extends Oe{type;vertices;boundsRadius;constructor(e,t,i){super(e,t,i),this.type=t.type,this.vertices=t.vertices,this.boundsRadius=t.boundsRadius}}var ue=(s=>(s[s.VertexGroups=0]="VertexGroups",s[s.ExtendedVertexGroups=1]="ExtendedVertexGroups",s[s.Skin=2]="Skin",s))(ue||{});let ft=class{index;geoset;layer;material;skinningType;isHd;constructor(e,t,i,n,r){let o,a;r?(o=i,a=o.layers[0]):(o=null,a=i),this.index=e,this.geoset=t,this.skinningType=n,this.isHd=r,this.layer=a,this.material=o}};class Ro{model;index;positionOffset;normalOffset;uvOffset;tangentOffset;skinOffset;faceOffset;vertices;elements;faceType;geosetAnimation=null;constructor(e,t,i,n,r,o,a,l,c,d,h){this.model=e,this.index=t,this.positionOffset=i,this.normalOffset=n,this.uvOffset=r,this.tangentOffset=o,this.skinOffset=a,this.faceOffset=l,this.vertices=c,this.elements=d,this.faceType=h;for(const f of e.geosetAnimations)f.geosetId===t&&(this.geosetAnimation=f)}bindShared(e,t,i){e.vertexAttribPointer(t.a_position,3,e.FLOAT,!1,0,this.positionOffset),e.vertexAttribPointer(t.a_normal,3,e.FLOAT,!1,0,this.normalOffset),e.vertexAttribPointer(t.a_uv,2,e.FLOAT,!1,0,this.uvOffset+i*this.vertices*8)}bindVertexGroups(e,t){const i=this.model,n=i.skinDataType,r=i.bytesPerSkinElement;e.vertexAttribPointer(t.a_bones,4,n,!1,5*r,this.skinOffset),e.vertexAttribPointer(t.a_boneNumber,1,n,!1,5*r,this.skinOffset+4*r)}bindVertexGroupsExtended(e,t){const i=this.model,n=i.skinDataType,r=i.bytesPerSkinElement;e.vertexAttribPointer(t.a_bones,4,n,!1,9*r,this.skinOffset),e.vertexAttribPointer(t.a_extendedBones,4,n,!1,9*r,this.skinOffset+4*r),e.vertexAttribPointer(t.a_boneNumber,1,n,!1,9*r,this.skinOffset+8*r)}bindSkin(e,t){e.vertexAttribPointer(t.a_bones,4,e.UNSIGNED_BYTE,!1,8,this.skinOffset),e.vertexAttribPointer(t.a_weights,4,e.UNSIGNED_BYTE,!0,8,this.skinOffset+4)}bind(e,t){const i=this.model.viewer.gl,n=e.attribs;this.bindShared(i,n,t),n.a_weights!==void 0?this.bindSkin(i,n):this.bindVertexGroups(i,n)}bindExtended(e,t){const i=this.model.viewer.gl,n=e.attribs;this.bindShared(i,n,t),this.bindVertexGroupsExtended(i,n)}bindHd(e,t,i){const n=this.model.viewer.gl,r=e.attribs;this.bindShared(n,r,i),n.vertexAttribPointer(r.a_tangent,4,n.FLOAT,!1,0,this.tangentOffset),t===ue.Skin?this.bindSkin(n,r):t===ue.ExtendedVertexGroups?this.bindVertexGroupsExtended(n,r):this.bindVertexGroups(n,r)}render(){const e=this.model.viewer.gl;e.drawElements(this.faceType,this.elements,e.UNSIGNED_SHORT,this.faceOffset)}}function Bo(s,e){if(e.length>0){const t=s.viewer.gl;let i=0,n=0,r=0,o=0,a=0,l=0;const c=[];for(let y=0,R=e.length;y<R;y++){const E=e[y];if(E.lod===0||E.lod===-1){const x=E.vertices.length/3;if(i+=x*12,n+=x*12,r+=E.uvSets.length*x*8,E.tangents.length&&(o+=x*16),E.skin.length)a+=x*8,c[y]=ue.Skin;else{let T=0;for(const L of E.matrixGroups)L>T&&(T=L);T>4?(a+=x*9,c[y]=ue.ExtendedVertexGroups):(a+=x*5,c[y]=ue.VertexGroups)}l+=E.faces.byteLength}}let d=0,h=d+i,f=h+n,p=f+r,u=p+o,g=0,v=Uint8Array,w=t.UNSIGNED_BYTE;s.bones.length>255&&(a*=2,v=Uint16Array,w=t.UNSIGNED_SHORT),s.skinDataType=w,s.bytesPerSkinElement=v.BYTES_PER_ELEMENT,s.arrayBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,s.arrayBuffer),t.bufferData(t.ARRAY_BUFFER,u+a,t.STATIC_DRAW),s.elementBuffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,s.elementBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,l,t.STATIC_DRAW);for(let y=0,R=e.length;y<R;y++){const E=e[y];if(E.lod===0||E.lod===-1){const x=E.vertices,T=E.normals,L=E.uvSets,H=E.tangents,M=E.faces;let $;const ne=E.vertices.length/3,D=c[y];if(D===ue.Skin)$=E.skin;else{const z=E.matrixIndices,P=E.vertexGroups,V=[];let j=0,G=4;D===ue.ExtendedVertexGroups&&(G=8),$=new v(ne*(G+1));for(const se of E.matrixGroups)V.push(z.subarray(j,j+se)),j+=se;for(let se=0;se<ne;se++){const Ee=V[P[se]];if(j=se*(G+1),Ee){const Re=Math.min(Ee.length,G);for(let F=0;F<Re;F++)$[j+F]=Ee[F]+1;$[j+G]=Re}}}const ee=new Ro(s,s.geosets.length,d,h,f,p,u,g,ne,M.length,E.faceTypeGroups[0]);s.geosets.push(ee);const Y=s.materials[E.materialId];if(Y.shader==="Shader_HD_DefaultUnit")s.batches.push(new ft(s.batches.length,ee,Y,D,!0));else for(const z of Y.layers)s.batches.push(new ft(s.batches.length,ee,z,D,!1));t.bufferSubData(t.ARRAY_BUFFER,d,x),d+=x.byteLength,t.bufferSubData(t.ARRAY_BUFFER,h,T),h+=T.byteLength;for(const z of L)t.bufferSubData(t.ARRAY_BUFFER,f,z),f+=z.byteLength;H.length&&(t.bufferSubData(t.ARRAY_BUFFER,p,H),p+=H.byteLength),t.bufferSubData(t.ARRAY_BUFFER,u,$),u+=$.byteLength,t.bufferSubData(t.ELEMENT_ARRAY_BUFFER,g,M),g+=M.byteLength}}}}class ms{model;skinningType;isHd;objects=[];constructor(e,t,i){this.model=e,this.skinningType=t,this.isHd=i}render(e){const t=e.scene,i=t.camera,n=e.textureOverrides,r=e.layerAlphas,o=this.model,a=o.textures,l=o.batches,c=o.viewer,d=c.sharedCache.get("mdx"),h=c.gl,f=c.webgl,p=this.skinningType,u=this.isHd,g=d.teamColors,v=d.teamGlows,w=ii.getBatchShader(c,p,u);w.use();const y=w.uniforms;h.uniformMatrix4fv(y.u_VP,!1,i.viewProjectionMatrix);const R=e.boneTexture;if(R?(R.bind(15),h.uniform1f(y.u_hasBones,1),h.uniform1i(y.u_boneMap,15),h.uniform1f(y.u_vectorSize,1/R.width),h.uniform1f(y.u_rowSize,1)):h.uniform1f(y.u_hasBones,0),h.uniform3fv(y.u_lightPos,t.lightPosition),h.bindBuffer(h.ARRAY_BUFFER,o.arrayBuffer),h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,o.elementBuffer),u){h.uniform1i(y.u_diffuseMap,0),h.uniform1i(y.u_normalsMap,1),h.uniform1i(y.u_ormMap,2),h.uniform1i(y.u_emissiveMap,3),h.uniform1i(y.u_teamColorMap,4),h.uniform1i(y.u_environmentMap,5),h.disable(h.BLEND),h.enable(h.DEPTH_TEST),h.depthMask(!0),h.uniformMatrix4fv(y.u_MV,!1,i.viewMatrix),h.uniform3fv(y.u_eyePos,i.location);for(const E of this.objects){const x=l[E],T=x.geoset,L=x.material,[H,M,$,ne,D,ee]=L.layers,Y=r[H.index];if(Y>0){h.uniform1f(y.u_layerAlpha,Y),h.uniform1f(y.u_filterMode,H.filterMode);const B=H.textureId,z=M.textureId,P=$.textureId,V=ne.textureId,j=D.textureId,G=ee.textureId,se=a[B],Ee=a[z],Re=a[P],F=a[V];let U=a[j];const W=a[G];(U.replaceableId===0||U.replaceableId===1)&&(U=g[e.teamColor]);const ve=n.get(B)||se.texture,X=n.get(z)||Ee.texture,le=n.get(P)||Re.texture,be=n.get(V)||F.texture,fe=n.get(j)||U.texture,We=n.get(G)||W.texture;f.bindTextureAndWrap(ve,0,se.wrapS,se.wrapT),f.bindTextureAndWrap(X,1,Ee.wrapS,Ee.wrapT),f.bindTextureAndWrap(le,2,Re.wrapS,Re.wrapT),f.bindTextureAndWrap(be,3,F.wrapS,F.wrapT),f.bindTextureAndWrap(fe,4,U.wrapS,U.wrapT),f.bindTextureAndWrap(We,5,W.wrapS,W.wrapT),T.bindHd(w,x.skinningType,H.coordId),T.render()}}}else{const E=e.geosetColors,x=e.layerTextures,T=e.uvAnims;h.uniform4fv(y.u_vertexColor,e.vertexColor),h.uniform1i(y.u_texture,0);for(const L of this.objects){const H=l[L],M=H.geoset,$=H.layer,ne=M.index,D=$.index,ee=E[ne],Y=r[D];if(ee[3]>.01&&Y>.01){const B=x[D],z=a[B],P=T[D];h.uniform4fv(y.u_geosetColor,ee),h.uniform1f(y.u_layerAlpha,Y),h.uniform1f(y.u_unshaded,$.unshaded),h.uniform2f(y.u_uvTrans,P[0],P[1]),h.uniform2f(y.u_uvRot,P[2],P[3]),h.uniform1f(y.u_uvScale,P[4]),$.bind(w);let V=n.get(B);if(!V){const j=z.replaceableId;let G;j===1?G=g[e.teamColor]:j===2?G=v[e.teamColor]:G=z,G&&(V=G.texture)}f.bindTextureAndWrap(V,0,z.wrapS,z.wrapT),p===ue.ExtendedVertexGroups?M.bindExtended(w,$.coordId):M.bind(w,$.coordId),M.render()}}}}}class Fo{model;objects=[];constructor(e){this.model=e}render(e){const t=e.scene,i=e.nodes,r=e.model.viewer,o=r.gl,a=r.webgl.extensions.ANGLE_instanced_arrays,l=r.sharedCache.get("mdx"),c=l.particlesShader,d=c.uniforms,h=c.attribs,f=l.rectBuffer;o.depthMask(!1),o.enable(o.BLEND),o.disable(o.CULL_FACE),o.enable(o.DEPTH_TEST),c.use(),o.uniformMatrix4fv(d.u_VP,!1,t.camera.viewProjectionMatrix),o.uniform1i(d.u_texture,0),a.vertexAttribDivisorANGLE(h.a_position,0),o.bindBuffer(o.ARRAY_BUFFER,f),o.vertexAttribPointer(h.a_position,1,o.UNSIGNED_BYTE,!1,0,0),a.vertexAttribDivisorANGLE(h.a_p0,1),a.vertexAttribDivisorANGLE(h.a_p1,1),a.vertexAttribDivisorANGLE(h.a_p2,1),a.vertexAttribDivisorANGLE(h.a_p3,1),a.vertexAttribDivisorANGLE(h.a_health,1),a.vertexAttribDivisorANGLE(h.a_color,1),a.vertexAttribDivisorANGLE(h.a_tail,1),a.vertexAttribDivisorANGLE(h.a_leftRightTop,1);for(const p of this.objects)_o(i[p].object,c);a.vertexAttribDivisorANGLE(h.a_leftRightTop,0),a.vertexAttribDivisorANGLE(h.a_tail,0),a.vertexAttribDivisorANGLE(h.a_color,0),a.vertexAttribDivisorANGLE(h.a_health,0),a.vertexAttribDivisorANGLE(h.a_p3,0),a.vertexAttribDivisorANGLE(h.a_p2,0),a.vertexAttribDivisorANGLE(h.a_p1,0),a.vertexAttribDivisorANGLE(h.a_p0,0)}}function gs(s){return s instanceof ft||s instanceof ps?s.layer.priorityPlane:s instanceof fs?s.priorityPlane:0}function vs(s,e){return s instanceof ms?e instanceof ft&&e.skinningType===s.skinningType&&e.isHd===s.isHd:e instanceof Oe}function bs(s,e){return e instanceof ft?new ms(s,e.skinningType,e.isHd):new Fo(s)}function ko(s){const e=[];let t=[];for(const a of s.batches)a.layer.filterMode<2?e.push(a):t.push(a);const i=s.opaqueGroups,n=s.translucentGroups;let r=null;for(const a of e)(!r||!vs(r,a))&&(r=bs(s,a),i.push(r)),r.objects.push(a.index);t=t.sort((a,l)=>a.layer.filterMode-l.layer.filterMode);const o=[...t,...s.eventObjects,...s.particleEmitters2,...s.ribbonEmitters].sort((a,l)=>gs(a)-gs(l));r=null;for(const a of o)(a instanceof ft||a.geometryEmitterType!==-1)&&((!r||!vs(r,a))&&(r=bs(s,a),n.push(r)),r.objects.push(a.index))}const Po=m.vec3.create(),Mo=m.quat.create(),Uo=m.vec3.create();class Oo{pivot=m.vec3.create();localLocation=m.vec3.create();localRotation=m.quat.create();localScale=m.vec3.fromValues(1,1,1);worldLocation=m.vec3.create();worldRotation=m.quat.create();worldScale=m.vec3.fromValues(1,1,1);inverseWorldLocation=m.vec3.create();inverseWorldRotation=m.quat.create();inverseWorldScale=m.vec3.fromValues(1,1,1);localMatrix=m.mat4.create();worldMatrix=m.mat4.create();dontInheritTranslation=!1;dontInheritRotation=!1;dontInheritScaling=!0;parent=null;children=[];setPivot(e){return m.vec3.copy(this.pivot,e),this.recalculateTransformation(),this}setLocation(e){return m.vec3.copy(this.localLocation,e),this.recalculateTransformation(),this}setRotation(e){return m.quat.copy(this.localRotation,e),this.recalculateTransformation(),this}setScale(e){return m.vec3.copy(this.localScale,e),this.recalculateTransformation(),this}setUniformScale(e){return m.vec3.set(this.localScale,e,e,e),this.recalculateTransformation(),this}setTransformation(e,t,i){const n=this.localLocation,r=this.localRotation,o=this.localScale;return n[0]=e[0],n[1]=e[1],n[2]=e[2],r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],o[0]=i[0],o[1]=i[1],o[2]=i[2],this.recalculateTransformation(),this}resetTransformation(){return m.vec3.copy(this.pivot,at),m.vec3.copy(this.localLocation,at),m.quat.copy(this.localRotation,vi),m.vec3.copy(this.localScale,gi),this.recalculateTransformation(),this}movePivot(e){return m.vec3.add(this.pivot,this.pivot,e),this.recalculateTransformation(),this}move(e){return m.vec3.add(this.localLocation,this.localLocation,e),this.recalculateTransformation(),this}rotate(e){return m.quat.mul(this.localRotation,this.localRotation,e),this.recalculateTransformation(),this}rotateLocal(e){return m.quat.mul(this.localRotation,e,this.localRotation),this.recalculateTransformation(),this}scale(e){return m.vec3.mul(this.localScale,this.localScale,e),this.recalculateTransformation(),this}uniformScale(e){return m.vec3.scale(this.localScale,this.localScale,e),this.recalculateTransformation(),this}face(e,t){return m.quat.conjugate(this.localRotation,rn(this.localRotation,this.localLocation,e,t)),this.recalculateTransformation(),this}setParent(e){if(this.parent){const t=this.parent.children,i=t.indexOf(this);i!==-1&&t.splice(i,1)}return this.parent=e||null,e&&e.children.push(this),this.recalculateTransformation(),this}recalculateTransformation(){const e=this.parent,t=this.localMatrix,i=this.localLocation,n=this.localRotation,r=this.localScale,o=this.worldMatrix,a=this.worldLocation,l=this.worldRotation,c=this.worldScale,d=this.inverseWorldLocation,h=this.inverseWorldRotation,f=this.inverseWorldScale;if(e){const p=Po,u=e.pivot;let g,v;if(p[0]=i[0]+u[0],p[1]=i[1]+u[1],p[2]=i[2]+u[2],this.dontInheritRotation?(g=Mo,m.quat.mul(g,n,e.inverseWorldRotation)):g=n,this.dontInheritScaling){v=Uo;const w=e.inverseWorldScale;v[0]=w[0]*r[0],v[1]=w[1]*r[1],v[2]=w[2]*r[2],c[0]=r[0],c[1]=r[1],c[2]=r[2]}else{v=r;const w=e.worldScale;c[0]=w[0]*r[0],c[1]=w[1]*r[1],c[2]=w[2]*r[2]}m.mat4.fromRotationTranslationScale(t,g,p,v),m.mat4.mul(o,e.worldMatrix,t),m.quat.mul(l,e.worldRotation,g)}else m.mat4.fromRotationTranslationScale(t,n,i,r),o[0]=t[0],o[1]=t[1],o[2]=t[2],o[3]=t[3],o[4]=t[4],o[5]=t[5],o[6]=t[6],o[7]=t[7],o[8]=t[8],o[9]=t[9],o[10]=t[10],o[11]=t[11],o[12]=t[12],o[13]=t[13],o[14]=t[14],o[15]=t[15],l[0]=n[0],l[1]=n[1],l[2]=n[2],l[3]=n[3],c[0]=r[0],c[1]=r[1],c[2]=r[2];h[0]=-l[0],h[1]=-l[1],h[2]=-l[2],h[3]=l[3],f[0]=1/c[0],f[1]=1/c[1],f[2]=1/c[2],a[0]=o[12],a[1]=o[13],a[2]=o[14],d[0]=-a[0],d[1]=-a[1],d[2]=-a[2];for(const p of this.children)p.recalculateTransformation()}update(e){for(const t of this.children)t.update(e)}}class ws extends Oo{scene=null;left=-1;right=-1;bottom=-1;top=-1;plane=-1;depth=0;updateFrame=0;model;timeScale=1;rendered=!0;textureOverrides=new Map;constructor(e){super(),this.model=e}show(){this.rendered=!0}hide(){this.rendered=!1}shown(){return this.rendered}hidden(){return!this.rendered}detach(){return this.scene?this.scene.removeInstance(this):!1}overrideTexture(e,t){t?this.textureOverrides.set(e,t):this.textureOverrides.delete(e)}getBounds(){return this.model.bounds}clearEmittedObjects(){}setScene(e){return e.addInstance(this)}recalculateTransformation(){super.recalculateTransformation(),this.scene&&this.scene.grid.moved(this)}update(e){const t=this.scene;t&&this.rendered&&this.isVisible(t.camera)&&(t.renderInstance(this),this.updateAnimations(e*this.timeScale),super.update(e))}updateAnimations(e){}renderOpaque(){}renderTranslucent(){}isVisible(e){const[t,i,n]=this.worldLocation,[r,o,a]=this.worldScale,l=this.getBounds(),c=e.planes;let d=r;return o>d&&(d=o),a>d&&(d=a),this.plane=cr(c,t+l.x,i+l.y,n+l.z,l.r*d,this.plane),this.plane===-1?(this.depth=sn(c[4],t,i,n),!0):!1}}const pt=m.vec3.create(),Mi=m.quat.create(),Do=m.vec3.create(),tt=m.vec3.create(),Fe=m.quat.create();class Ui{pivot;localLocation;localRotation;localScale;worldLocation;worldRotation;worldScale;inverseWorldLocation;inverseWorldRotation;inverseWorldScale;localMatrix;worldMatrix;dontInheritTranslation=!1;dontInheritRotation=!1;dontInheritScaling=!1;billboarded=!1;billboardedX=!1;billboardedY=!1;billboardedZ=!1;dirty=!0;wasDirty=!1;parent=null;children=[];object=null;constructor(e,t,i,n,r,o,a,l,c,d,h,f){this.pivot=e,this.localLocation=t,this.localRotation=i,this.localScale=n,this.worldLocation=r,this.worldRotation=o,this.worldScale=a,this.inverseWorldLocation=l,this.inverseWorldRotation=c,this.inverseWorldScale=d,this.localMatrix=h,this.worldMatrix=f,this.localRotation[3]=1,this.localScale.fill(1),this.localMatrix[0]=1,this.localMatrix[5]=1,this.localMatrix[10]=1,this.localMatrix[15]=1}recalculateTransformation(e){const t=e.scene,i=this.localMatrix,n=this.localLocation,r=this.localRotation,o=this.localScale,a=this.worldMatrix,l=this.worldLocation,c=this.worldRotation,d=this.worldScale,h=this.pivot,f=this.inverseWorldLocation,p=this.inverseWorldRotation,u=this.inverseWorldScale,g=this.parent;let v,w,y;if(this.dontInheritTranslation?(m.vec3.add(pt,g.inverseWorldLocation,l),v=m.vec3.add(pt,pt,n)):v=n,this.dontInheritScaling?(m.vec3.mul(pt,g.inverseWorldScale,e.worldScale),y=m.vec3.mul(pt,pt,o)):y=o,this.billboarded)w=Mi,m.quat.copy(w,g.inverseWorldRotation),m.quat.mul(w,w,t.camera.inverseRotation),this.convertBasis(w),m.quat.mul(w,w,r);else{const{billboardedX:L,billboardedY:H,billboardedZ:M}=this;L||H||M?(L&&(y===o&&(y=Do,m.vec3.copy(y,o)),y[2]*=-1),Fe[0]=-r[0],Fe[1]=-r[1],Fe[2]=-r[2],m.quat.mul(Fe,Fe,g.inverseWorldRotation),m.vec3.transformQuat(tt,t.camera.billboardedVectors[6],Fe),L?m.quat.setAxisAngle(Fe,mi,Math.atan2(tt[2],tt[1])):H?m.quat.setAxisAngle(Fe,tn,Math.atan2(-tt[2],tt[0])):m.quat.setAxisAngle(Fe,Tt,Math.atan2(tt[1],tt[0])),w=Mi,m.quat.mul(w,r,Fe)):w=r}this.dontInheritRotation&&(m.quat.mul(Fe,g.inverseWorldRotation,e.worldRotation),w=m.quat.mul(Mi,Fe,w)),m.mat4.fromRotationTranslationScaleOrigin(i,w,v,y,h),m.mat4.mul(a,g.worldMatrix,i);const R=h[0],E=h[1],x=h[2];l[0]=a[0]*R+a[4]*E+a[8]*x+a[12],l[1]=a[1]*R+a[5]*E+a[9]*x+a[13],l[2]=a[2]*R+a[6]*E+a[10]*x+a[14],f[0]=-l[0],f[1]=-l[1],f[2]=-l[2],m.quat.mul(c,g.worldRotation,w),p[0]=-c[0],p[1]=-c[1],p[2]=-c[2],p[3]=c[3];const T=g.worldScale;d[0]=T[0]*y[0],d[1]=T[1]*y[1],d[2]=T[2]*y[2],u[0]=1/d[0],u[1]=1/d[1],u[2]=1/d[2]}convertBasis(e){}}const No=65;function ys(s,e=Ui){const t=new Float32Array(s*No),i=[];let n=0;const r=s*3,o=s*4,a=s*16,l=t.subarray(n,n+r);n+=r;const c=t.subarray(n,n+r);n+=r;const d=t.subarray(n,n+o);n+=o;const h=t.subarray(n,n+r);n+=r;const f=t.subarray(n,n+r);n+=r;const p=t.subarray(n,n+o);n+=o;const u=t.subarray(n,n+r);n+=r;const g=t.subarray(n,n+r);n+=r;const v=t.subarray(n,n+o);n+=o;const w=t.subarray(n,n+r);n+=r;const y=t.subarray(n,n+a);n+=a;const R=t.subarray(n,n+a);for(let E=0;E<s;E++){const x=E*3,T=x+3,L=E*4,H=L+4,M=E*16,$=M+16;i[E]=new e(l.subarray(x,T),c.subarray(x,T),d.subarray(L,H),h.subarray(x,T),f.subarray(x,T),p.subarray(L,H),u.subarray(x,T),g.subarray(x,T),v.subarray(L,H),w.subarray(x,T),y.subarray(M,$),R.subarray(M,$))}return{data:t,nodes:i,pivots:l,localLocations:c,localRotations:d,localScales:h,worldLocations:f,worldRotations:p,worldScales:u,inverseWorldLocations:g,invereseWorldRotations:v,inverseWorldScales:w,localMatrices:y,worldMatrices:R}}class Vo extends Ui{convertBasis(e){m.quat.rotateY(e,e,-Math.PI/2),m.quat.rotateX(e,e,-Math.PI/2)}}const As=new Float32Array(1);class Go{instance;attachment;internalInstance;constructor(e,t){const n=t.internalModel.addInstance();n.setSequenceLoopMode(2),n.dontInheritScaling=!1,n.hide(),n.setParent(e.nodes[t.objectId]),this.instance=e,this.attachment=t,this.internalInstance=n}update(){const e=this.instance,t=this.internalInstance;e.scene&&e.sequence!==-1&&(this.attachment.getVisibility(As,e.sequence,e.frame,e.counter),As[0]>.1?(e.scene.addInstance(t),t.hidden()&&(t.show(),t.setSequence(0))):t.hide())}}class qo{instance;objects=[];alive=0;currentEmission=0;constructor(e){this.instance=e}update(e){this.updateEmission(e);const t=this.currentEmission;if(t>=1)for(let i=0;i<t;i+=1)this.emit()}clear(){const e=this.objects;for(let t=0,i=this.alive;t<i;t++){const n=e[t];n.health=0}this.currentEmission=0}emitObject(e){const t=this.objects;this.alive===t.length&&t.push(this.createObject());const i=t[this.alive];return i.index=this.alive,i.bind(e),this.alive+=1,this.currentEmission-=1,this.instance.scene.emittedObjectUpdater.add(i),i}kill(e){const t=this.objects;this.alive-=1;const i=t[this.alive];t[e.index]=i,t[this.alive]=e,i.index=e.index,e.index=-1}}class Wt extends qo{emitterObject;constructor(e,t){super(e),this.emitterObject=t}update(e){this.emitterObject.ok&&super.update(e)}}class mt{emitter;index=-1;health=0;constructor(e){this.emitter=e}}const it=m.quat.create(),jo=m.vec3.create(),Oi=new Float32Array(1),Ts=new Float32Array(1),Ss=new Float32Array(1),Es=new Float32Array(1);class Ko extends mt{internalInstance;velocity=m.vec3.create();gravity=0;constructor(e){super(e);const i=e.emitterObject.internalModel;this.internalInstance=i.addInstance()}bind(){const e=this.emitter,t=e.instance,i=t.sequence,n=t.frame,r=t.counter,o=t.scene,a=e.emitterObject,l=t.nodes[a.index],c=this.internalInstance,d=l.worldScale,h=this.velocity;a.getLatitude(Oi,i,n,r),a.getLifeSpan(Ts,i,n,r),a.getGravity(Ss,i,n,r),a.getSpeed(Es,i,n,r),this.health=Ts[0],this.gravity=Ss[0]*d[2],m.quat.identity(it),m.quat.rotateZ(it,it,$e(-Math.PI,Math.PI)),m.quat.rotateY(it,it,$e(-Oi[0],Oi[0])),m.vec3.transformQuat(h,Tt,it),m.vec3.transformQuat(h,h,l.worldRotation),m.vec3.scale(h,h,Es[0]),m.vec3.mul(h,h,d),c.setScene(o),c.setSequence(0),c.setTransformation(l.worldLocation,m.quat.setAxisAngle(it,Tt,$e(0,Math.PI*2)),l.worldScale),c.show()}update(e){const t=this.internalInstance;if(this.health-=e,this.health>0){const i=this.velocity;i[2]-=this.gravity*e,t.move(m.vec3.scale(jo,i,e))}else t.hide()}}const xs=new Float32Array(1);class Ho extends Wt{updateEmission(e){const t=this.instance;t.allowParticleSpawn&&(this.emitterObject.getEmissionRate(xs,t.sequence,t.frame,t.counter),this.currentEmission+=xs[0]*e)}emit(){this.emitObject()}createObject(){return new Ko(this)}}const De=m.quat.create(),_s=new Float32Array(1),Is=new Float32Array(1),Cs=new Float32Array(1),Ls=new Float32Array(1),Rs=new Float32Array(1),Bs=new Float32Array(1);class $o extends mt{tail=0;gravity=0;location=m.vec3.create();velocity=m.vec3.create();scale=m.vec3.create();facing=0;bind(e){const t=this.emitter,i=t.instance,n=i.sequence,r=i.frame,o=i.counter,a=t.emitterObject;a.getWidth(_s,n,r,o),a.getLength(Is,n,r,o),a.getLatitude(Cs,n,r,o),a.getVariation(Ls,n,r,o),a.getSpeed(Rs,n,r,o),a.getGravity(Bs,n,r,o);const l=t.node,c=l.pivot,d=l.worldScale,h=_s[0]*.5,f=Is[0]*.5,p=Sr(Cs[0]),u=Ls[0],g=Rs[0],v=this.location,w=this.velocity;this.health=a.lifeSpan,this.tail=e,this.gravity=Bs[0]*d[2],m.vec3.copy(this.scale,d),v[0]=c[0]+$e(-h,h),v[1]=c[1]+$e(-f,f),v[2]=c[2],a.modelSpace||m.vec3.transformMat4(v,v,l.worldMatrix),m.quat.identity(De),m.quat.rotateZ(De,De,Math.PI/2),m.quat.rotateY(De,De,$e(-p,p)),a.lineEmitter||m.quat.rotateX(De,De,$e(-p,p)),a.modelSpace||m.quat.mul(De,l.worldRotation,De),m.vec3.transformQuat(w,Tt,De),m.vec3.scale(w,w,g*(1+$e(-u,u))),a.modelSpace||m.vec3.mul(w,w,d),a.xYQuad&&(this.facing=Math.atan2(w[1],w[0])-Math.PI+Math.PI/8)}update(e){if(this.health-=e,this.health>0){const t=this.location,i=this.velocity;i[2]-=this.gravity*e,t[0]+=i[0]*e,t[1]+=i[1]*e,t[2]+=i[2]*e}}}const Di=new Float32Array(1);class Xo extends Wt{node;lastEmissionKey=-1;constructor(e,t){super(e,t),this.node=e.nodes[t.index]}updateEmission(e){const t=this.instance;if(t.allowParticleSpawn){const i=this.emitterObject,n=i.getEmissionRate(Di,t.sequence,t.frame,t.counter);i.squirt?(n!==this.lastEmissionKey&&(this.currentEmission+=Di[0]),this.lastEmissionKey=n):this.currentEmission+=Di[0]*e}}emit(){const e=this.emitterObject;e.head&&this.emitObject(0),e.tail&&this.emitObject(1)}createObject(){return new $o(this)}}const Ne=m.vec3.create(),Ve=m.vec3.create(),Zt=new Float32Array(3),Fs=new Float32Array(1),ks=new Uint32Array(1);class Yo extends mt{vertices=new Float32Array(6);color=new Uint8Array(4);slot=0;prev=null;next=null;bind(){const e=this.emitter,t=e.instance,i=t.sequence,n=t.frame,r=t.counter,o=e.emitterObject,a=t.nodes[o.index],[l,c,d]=a.pivot,h=a.worldMatrix,f=this.vertices;this.health=e.emitterObject.lifeSpan,o.getHeightBelow(Ne,i,n,r),o.getHeightAbove(Ve,i,n,r),Ne[1]=c-Ne[0],Ne[0]=l,Ne[2]=d,Ve[1]=c+Ve[0],Ve[0]=l,Ve[2]=d,m.vec3.transformMat4(Ne,Ne,h),m.vec3.transformMat4(Ve,Ve,h),f[0]=Ve[0],f[1]=Ve[1],f[2]=Ve[2],f[3]=Ne[0],f[4]=Ne[1],f[5]=Ne[2]}update(e){if(this.health-=e,this.health>0){const t=this.emitter,i=t.instance,n=i.sequence,r=i.frame,o=i.counter,a=t.emitterObject,l=this.color,c=this.vertices,d=a.gravity*e*e;a.getColor(Zt,n,r,o),a.getAlpha(Fs,n,r,o),a.getTextureSlot(ks,n,r,o),c[1]-=d,c[4]-=d,l[0]=Zt[0]*255,l[1]=Zt[1]*255,l[2]=Zt[2]*255,l[3]=Fs[0]*255,this.slot=ks[0]}}}class zo extends Wt{first=null;last=null;updateEmission(e){if(this.instance.allowParticleSpawn){const i=this.emitterObject;this.currentEmission+=i.emissionRate*e}}emit(){const e=this.emitObject(),t=this.last;t?(t.next=e,e.prev=t):this.first=e,this.last=e}kill(e){super.kill(e);const t=e.prev,i=e.next;e===this.first&&(this.first=i),e===this.last&&(this.first=null,this.last=null),t&&(t.next=i),i&&(i.prev=t),e.prev=null,e.next=null}createObject(){return new Yo(this)}}const Ps=new Uint32Array(1);class Qt extends Wt{lastValue=0;updateEmission(e){const t=this.instance;if(t.allowParticleSpawn){this.emitterObject.getValue(Ps,t);const n=Ps[0];n===1&&n!==this.lastValue&&(this.currentEmission+=1),this.lastValue=n}}emit(){this.emitObject()}}class Wo extends mt{internalInstance;constructor(e){super(e);const i=e.emitterObject.internalModel;this.internalInstance=i.addInstance()}bind(){const e=this.emitter,t=e.instance,i=t.scene,n=t.nodes[e.emitterObject.index],r=this.internalInstance;r.setScene(i),r.setSequence(0),r.setTransformation(n.worldLocation,n.worldRotation,n.worldScale),r.show(),this.health=1}update(e){const t=this.internalInstance,i=t.model;t.frame>=i.sequences[0].interval[1]&&(this.health=0,t.hide())}}class Zo extends Qt{createObject(){return new Wo(this)}}const we=m.vec3.create();class Ms extends mt{vertices=new Float32Array(12);bind(){const e=this.emitter,t=e.instance,i=e.emitterObject,n=this.vertices,r=i.scale,{worldLocation:o,worldRotation:a}=t.nodes[i.index];this.health=i.lifeSpan,m.vec3.set(we,r,r,0),m.vec3.transformQuat(we,we,a),m.vec3.add(n.subarray(0,2),we,o),m.vec3.set(we,-r,r,0),m.vec3.transformQuat(we,we,a),m.vec3.add(n.subarray(3,5),we,o),m.vec3.set(we,-r,-r,0),m.vec3.transformQuat(we,we,a),m.vec3.add(n.subarray(6,8),we,o),m.vec3.set(we,r,-r,0),m.vec3.transformQuat(we,we,a),m.vec3.add(n.subarray(9,11),we,o)}update(e){this.health-=e}}class Qo extends Qt{createObject(){return new Ms(this)}}class Jo extends Qt{createObject(){return new Ms(this)}}class ea extends mt{bind(){const e=this.emitter,t=e.instance,i=t.model.viewer,n=t.scene;if(i.audioEnabled&&n.audioEnabled){const r=e.emitterObject,o=t.nodes[r.index],a=n.audioContext,l=r.decodedBuffers,c=a.createPanner(),d=a.createBufferSource(),h=o.worldLocation;c.positionX.value=h[0],c.positionY.value=h[1],c.positionZ.value=h[2],c.maxDistance=r.distanceCutoff,c.refDistance=r.minDistance,c.connect(a.destination),d.buffer=l[Math.random()*l.length|0],d.connect(c),d.start(0)}}update(e){}}class ta extends Qt{createObject(){return new ea(this)}}const Us=new Float32Array(1),Ni=m.vec3.create(),Vi=m.quat.create(),Os=m.vec3.create(),Jt=new Float32Array(3),ei=new Float32Array(1),Ds=new Uint32Array(1);class ia extends ws{attachments=[];particleEmitters=[];particleEmitters2=[];ribbonEmitters=[];eventObjectEmitters=[];nodes=[];sortedNodes=[];frame=0;counter=0;sequence=-1;sequenceLoopMode=0;sequenceEnded=!1;teamColor=0;vertexColor=new Float32Array([1,1,1,1]);allowParticleSpawn=!1;forced=!0;geosetColors=[];layerAlphas=[];layerTextures=[];uvAnims=[];worldMatrices=null;boneTexture=null;constructor(e){super(e);for(let o=0,a=e.geosets.length;o<a;o++)this.geosetColors[o]=new Float32Array(4);for(let o=0,a=e.layers.length;o<a;o++)this.layerAlphas[o]=0,this.layerTextures[o]=0,this.uvAnims[o]=new Float32Array(5);const t=ys(e.genericObjects.length,Vo),i=t.nodes;let n=0;this.nodes.push(...i),this.worldMatrices=t.worldMatrices;for(const o of e.bones)this.initNode(i,i[n++],o);for(const o of e.lights)this.initNode(i,i[n++],o);for(const o of e.helpers)this.initNode(i,i[n++],o);for(const o of e.attachments){let a;o.internalModel&&(a=new Go(this,o),this.attachments.push(a)),this.initNode(i,i[n++],o,a)}for(const o of e.particleEmitters){const a=new Ho(this,o);this.particleEmitters.push(a),this.initNode(i,i[n++],o,a)}for(const o of e.particleEmitters2){const a=new Xo(this,o);this.particleEmitters2.push(a),this.initNode(i,i[n++],o,a)}for(const o of e.ribbonEmitters){const a=new zo(this,o);this.ribbonEmitters.push(a),this.initNode(i,i[n++],o,a)}for(const o of e.eventObjects){const a=o.type;let l;a==="SPN"?l=new Zo(this,o):a==="SPL"?l=new Qo(this,o):a==="UBR"?l=new Jo(this,o):l=new ta(this,o),this.eventObjectEmitters.push(l),this.initNode(i,i[n++],o,l)}for(const o of e.collisionShapes)this.initNode(i,i[n++],o);const r=e.hierarchy;for(let o=0,a=i.length;o<a;o++)this.sortedNodes[o]=i[r[o]];e.bones.length&&(this.boneTexture=new pi(e.viewer.gl,4,e.bones.length*4,1))}setTexture(e,t){this.overrideTexture(e,t)}setParticle2Texture(e,t){this.overrideTexture(hs+e,t)}setEventTexture(e,t){this.overrideTexture(Pi+e,t)}clearEmittedObjects(){for(const e of this.particleEmitters)e.clear();for(const e of this.particleEmitters2)e.clear();for(const e of this.ribbonEmitters)e.clear();for(const e of this.eventObjectEmitters)e.clear()}initNode(e,t,i,n){m.vec3.copy(t.pivot,i.pivot),i.parentId===-1?t.parent=this:t.parent=e[i.parentId],t.dontInheritTranslation=i.dontInheritTranslation,t.dontInheritRotation=i.dontInheritRotation,t.dontInheritScaling=i.dontInheritScaling,i.billboarded?t.billboarded=!0:i.billboardedX?t.billboardedX=!0:i.billboardedY?t.billboardedY=!0:i.billboardedZ&&(t.billboardedZ=!0),n&&(t.object=n)}hide(){super.hide(),this.resetAttachments()}updateNodes(e,t){const i=this.sequence,n=this.frame,r=this.counter,o=this.sortedNodes,l=this.model.sortedGenericObjects;for(let c=0,d=o.length;c<d;c++){const h=l[c],f=o[c],p=f.parent;let u=t||p.wasDirty||h.anyBillboarding;const g=h.variants;(t||g.generic[i])&&(u=!0,(t||g.translation[i])&&h.getTranslation(f.localLocation,i,n,r),(t||g.rotation[i])&&h.getRotation(f.localRotation,i,n,r),(t||g.scale[i])&&h.getScale(f.localScale,i,n,r)),f.wasDirty=u,u&&f.recalculateTransformation(this),f.object&&(h.getVisibility(Us,i,n,r),Us[0]>0&&f.object.update(e));for(const v of f.children)u&&v.recalculateTransformation(),v.update(e)}}recalculateTransformation(){super.recalculateTransformation(),this.forced=!0}updateBatches(e){const t=this.sequence,i=this.frame,n=this.counter,r=this.model,o=r.geosets,a=r.layers,l=this.geosetColors,c=this.layerAlphas,d=this.layerTextures,h=this.uvAnims;for(let f=0,p=o.length;f<p;f++){const g=o[f].geosetAnimation,v=l[f];g?((e||g.variants.color[t])&&(g.getColor(Jt,t,i,n),v[0]=Jt[0],v[1]=Jt[1],v[2]=Jt[2]),(e||g.variants.alpha[t])&&(g.getAlpha(ei,t,i,n),v[3]=ei[0])):e&&(v[0]=1,v[1]=1,v[2]=1,v[3]=1)}for(let f=0,p=a.length;f<p;f++){const u=a[f],g=u.textureAnimation,v=h[f];(e||u.variants.alpha[t])&&(u.getAlpha(ei,t,i,n),c[f]=ei[0]),(e||u.variants.textureId[t])&&(u.getTextureId(Ds,t,i,n),d[f]=Ds[0]),g?((e||g.variants.translation[t])&&(g.getTranslation(Ni,t,i,n),v[0]=Ni[0],v[1]=Ni[1]),(e||g.variants.rotation[t])&&(g.getRotation(Vi,t,i,n),v[2]=Vi[2],v[3]=Vi[3]),(e||g.variants.scale[t])&&(g.getScale(Os,t,i,n),v[4]=Os[0])):e&&(v[0]=0,v[1]=0,v[2]=0,v[3]=1,v[4]=1)}}updateBoneTexture(){this.boneTexture&&this.boneTexture.bindAndUpdate(this.worldMatrices)}renderOpaque(){const e=this.model;for(const t of e.opaqueGroups)t.render(this)}renderTranslucent(){const e=this.model;for(const t of e.translucentGroups)t.render(this)}updateAnimations(e){const t=this.model,i=this.sequence;if(i!==-1){const r=t.sequences[i],o=r.interval,a=e*1e3;this.frame+=a,this.counter+=a,this.allowParticleSpawn=!0,this.frame>=o[1]?(this.sequenceLoopMode===2||this.sequenceLoopMode===0&&r.nonLooping===0?(this.frame=o[0],this.resetEventEmitters()):(this.frame=o[1],this.counter-=a,this.allowParticleSpawn=!1),this.sequenceEnded=!0):this.sequenceEnded=!1}const n=this.forced;(i!==-1||n)&&(this.updateNodes(e,n),this.updateBoneTexture(),this.updateBatches(n)),this.forced=!1}setTeamColor(e){return this.teamColor=e,this}setVertexColor(e){return this.vertexColor.set(e),this}setSequence(e){const i=this.model.sequences;return this.sequence=e,e<0||e>i.length-1?(this.sequence=-1,this.frame=0,this.allowParticleSpawn=!1):this.frame=i[e].interval[0],this.resetEventEmitters(),this.resetAttachments(),this.forced=!0,this}getBounds(){const e=this.model;if(this.sequence===-1)return e.bounds;const t=e.sequences[this.sequence].bounds;return t.r===0?e.bounds:t}setSequenceLoopMode(e){return this.sequenceLoopMode=e,this}getAttachment(e){const i=this.model.attachments[e];if(i)return this.nodes[i.index]}resetEventEmitters(){for(const e of this.eventObjectEmitters)e.lastValue=0}resetAttachments(){for(const e of this.attachments)e.internalInstance.hide()}}class na extends Wn{reforged=!1;hd=!1;solverParams={};name="";sequences=[];globalSequences=[];materials=[];layers=[];textures=[];textureAnimations=[];geosets=[];geosetAnimations=[];bones=[];lights=[];helpers=[];attachments=[];pivotPoints=[];particleEmitters=[];particleEmitters2=[];ribbonEmitters=[];cameras=[];eventObjects=[];collisionShapes=[];hasLayerAnims=!1;hasGeosetAnims=!1;batches=[];genericObjects=[];sortedGenericObjects=[];hierarchy=[];opaqueGroups=[];translucentGroups=[];arrayBuffer=null;elementBuffer=null;skinDataType=0;bytesPerSkinElement=1;constructor(e,t){super(t);let i;if(e instanceof Yt)i=e;else{i=new Yt;try{i.load(e)}catch{}}const n=this.viewer,r=this.pathSolver,o=this.solverParams,a=i.version>800,l=a?".dds":".blp";let c=!1;this.reforged=a,this.name=i.name;const d=i.extent;this.bounds.fromExtents(d.min,d.max);for(const u of i.sequences)this.sequences.push(new Xr(u));for(const u of i.globalSequences)this.globalSequences.push(u);for(const u of i.textureAnimations)this.textureAnimations.push(new to(this,u));let h=0;for(const u of i.materials){const g=[];for(const v of u.layers){const w=new no(this,v,h++,u.priorityPlane);g.push(w),this.layers.push(w)}this.materials.push(new so(this,u.shader,g)),u.shader!==""&&(this.hd=!0)}a&&(o.reforged=!0),this.hd&&(o.hd=!0);const f=i.textures;for(let u=0,g=f.length;u<g;u++){const v=f[u];let w=v.path;const y=v.replaceableId,R=v.wrapMode;w===""&&y!==0&&(w=`ReplaceableTextures\\${is[y]}${l}`,(y===1||y===2)&&(c=!0));const E=new Bt(y,R);n.load(w,r,o).then(x=>{x&&(E.texture=x)}),this.textures[u]=E}for(const u of i.geosetAnimations)this.geosetAnimations.push(new ro(this,u));this.pivotPoints=i.pivotPoints;let p=0;for(const u of i.bones)this.bones.push(new oo(this,u,p++));for(const u of i.lights)this.lights.push(new ao(this,u,p++));for(const u of i.helpers)this.helpers.push(new lo(this,u,p++));for(const u of i.attachments)this.attachments.push(new co(this,u,p++));for(const u of i.particleEmitters)this.particleEmitters.push(new ho(this,u,p++));for(const u of i.particleEmitters2){const g=new fs(this,u,p++);this.particleEmitters2.push(g),g.teamColored&&(c=!0)}for(const u of i.ribbonEmitters)this.ribbonEmitters.push(new ps(this,u,p++));for(const u of i.cameras)this.cameras.push(new Io(this,u));for(const u of i.eventObjects)this.eventObjects.push(new Co(this,u,p++));for(const u of i.collisionShapes)this.collisionShapes.push(new Lo(this,u,p++));this.genericObjects.push(...this.bones,...this.lights,...this.helpers,...this.attachments,...this.particleEmitters,...this.particleEmitters2,...this.ribbonEmitters,...this.eventObjects,...this.collisionShapes),Bo(this,i.geosets),ko(this),this.setupHierarchy(-1);for(let u=0,g=this.genericObjects.length;u<g;u++)this.sortedGenericObjects[u]=this.genericObjects[this.hierarchy[u]];c&&ii.loadTeamTextures(n)}addInstance(){return new ia(this)}setupHierarchy(e){for(let t=0,i=this.genericObjects.length;t<i;t++){const n=this.genericObjects[t];n.parentId===e&&(this.hierarchy.push(t),this.setupHierarchy(n.objectId))}}}const Gi=`
uniform sampler2D u_boneMap;
uniform float u_vectorSize;
uniform float u_rowSize;

mat4 fetchMatrix(float column, float row) {
  column *= u_vectorSize * 4.0;
  row *= u_rowSize;
  // Add in half a texel, to sample in the middle of the texel.
  // Otherwise, since the sample is directly on the boundary, floating point errors can cause the sample to get the wrong pixel.
  // This is most noticeable with NPOT textures, which the bone maps are.
  column += 0.5 * u_vectorSize;
  row += 0.5 * u_rowSize;

  return mat4(texture2D(u_boneMap, vec2(column, row)),
              texture2D(u_boneMap, vec2(column + u_vectorSize, row)),
              texture2D(u_boneMap, vec2(column + u_vectorSize * 2.0, row)),
              texture2D(u_boneMap, vec2(column + u_vectorSize * 3.0, row)));
}
`,Ns=`
#ifdef SKIN
attribute vec4 a_bones;
attribute vec4 a_weights;

void transformSkin(inout vec3 position, inout vec3 normal, inout vec3 tangent, inout vec3 binormal) {
  mat4 bone;

  bone += fetchMatrix(a_bones[0], 0.0) * a_weights[0];
  bone += fetchMatrix(a_bones[1], 0.0) * a_weights[1];
  bone += fetchMatrix(a_bones[2], 0.0) * a_weights[2];
  bone += fetchMatrix(a_bones[3], 0.0) * a_weights[3];

  mat3 rotation = mat3(bone);

  position = vec3(bone * vec4(position, 1.0));
  normal = rotation * normal;
  tangent = rotation * tangent;
  binormal = rotation * binormal;
}
#else
attribute vec4 a_bones;
#ifdef EXTENDED_BONES
attribute vec4 a_extendedBones;
#endif
attribute float a_boneNumber;

mat4 getVertexGroupMatrix() {
  mat4 bone;

  // For the broken models out there, since the game supports this.
  if (a_boneNumber > 0.0) {
    for (int i = 0; i < 4; i++) {
      if (a_bones[i] > 0.0) {
        bone += fetchMatrix(a_bones[i] - 1.0, 0.0);
      }
    }

    #ifdef EXTENDED_BONES
      for (int i = 0; i < 4; i++) {
        if (a_extendedBones[i] > 0.0) {
          bone += fetchMatrix(a_extendedBones[i] - 1.0, 0.0);
        }
      }
    #endif
  }

  return bone / a_boneNumber;
}

void transformVertexGroups(inout vec3 position, inout vec3 normal) {
  mat4 bone = getVertexGroupMatrix();
  mat3 rotation = mat3(bone);

  position = vec3(bone * vec4(position, 1.0));
  normal = normalize(rotation * normal);
}

void transformVertexGroupsHD(inout vec3 position, inout vec3 normal, inout vec3 tangent, inout vec3 binormal) {
  mat4 bone = getVertexGroupMatrix();
  mat3 rotation = mat3(bone);

  position = vec3(bone * vec4(position, 1.0));
  normal = normalize(rotation * normal);
  tangent = normalize(rotation * tangent);
  binormal = normalize(rotation * binormal);
}
#endif
`,gt=`
uniform mat4 u_VP;
uniform vec3 u_lightPos;
uniform vec4 u_vertexColor;
uniform vec4 u_geosetColor;
uniform float u_layerAlpha;
uniform vec2 u_uvTrans;
uniform vec2 u_uvRot;
uniform float u_uvScale;
uniform bool u_hasBones;

attribute vec3 a_position;
attribute vec3 a_normal;
attribute vec2 a_uv;

varying vec2 v_uv;
varying vec3 v_normal;
varying vec4 v_color;
varying vec4 v_uvTransRot;
varying float v_uvScale;
varying vec3 v_lightDir;

${Gi}
${Ns}

void main() {
  vec3 position = a_position;
  vec3 normal = a_normal;

  if (u_hasBones) {
    #ifdef SKIN
      vec3 tangent = vec3(0.0);
      vec3 binormal = vec3(0.0);
      transformSkin(position, normal, tangent, binormal);
    #else
      transformVertexGroups(position, normal);
    #endif
  }

  v_uv = a_uv;
  v_normal = normal;
  v_color = u_vertexColor * u_geosetColor.bgra * vec4(1.0, 1.0, 1.0, u_layerAlpha);
  v_uvTransRot = vec4(u_uvTrans, u_uvRot);
  v_uvScale = u_uvScale;
  v_lightDir = normalize(u_lightPos - position);

  gl_Position = u_VP * vec4(position, 1.0);
}
`,ti=`
#ifdef GL_FRAGMENT_PRECISION_HIGH
precision highp float;
#else
precision mediump float;
#endif
`,vt=`
${ti}


// A 2D quaternion*vector.
// q is the zw components of the original quaternion.
vec2 quat_transform(vec2 q, vec2 v) {
  vec2 uv = vec2(-q.x * v.y, q.x * v.x);
  vec2 uuv = vec2(-q.x * uv.y, q.x * uv.x);

  return v + 2.0 * (uv * q.y + uuv);
}


uniform sampler2D u_texture;
uniform float u_filterMode;
uniform bool u_unshaded;

varying vec2 v_uv;
varying vec3 v_normal;
varying vec4 v_color;
varying vec4 v_uvTransRot;
varying float v_uvScale;
varying vec3 v_lightDir;

vec4 getDiffuseColor() {
  vec2 uv = v_uv;

  // Translation animation
  uv += v_uvTransRot.xy;

  // Rotation animation
  uv = quat_transform(v_uvTransRot.zw, uv - 0.5) + 0.5;

  // Scale animation
  uv = v_uvScale * (uv - 0.5) + 0.5;

  vec4 texel = texture2D(u_texture, uv);
  vec4 color = texel * v_color;

  // 1bit Alpha
  if (u_filterMode == 1.0 && color.a < 0.75) {
    discard;
  }

  // "Close to 0 alpha"
  if (u_filterMode >= 5.0 && color.a < 0.02) {
    discard;
  }

  return color;
}

void onlyTexCoords() {
  gl_FragColor = vec4(v_uv, 0.0, 1.0);
}

void onlyNormals() {
  gl_FragColor = vec4(v_normal, 1.0);
}

void onlyDiffuse() {
  gl_FragColor = getDiffuseColor();
}

void lambert() {
  vec4 color = getDiffuseColor();

  if (!u_unshaded) {
    float lambertFactor = clamp(dot(v_normal, v_lightDir), 0.0, 1.0);
    lambertFactor = clamp(lambertFactor + 0.7, 0.0, 1.0);

    color.rgb *= lambertFactor;
  }

  gl_FragColor = color;
}

void main() {
  #if defined(ONLY_DIFFUSE)
  onlyDiffuse();
  #elif defined(ONLY_TEXCOORDS)
  onlyTexCoords();
  #elif defined(ONLY_NORMALS)
  onlyNormals();
  #else
  lambert();
  #endif
}
`,Ie=`
uniform mat4 u_VP;
uniform mat4 u_MV;
uniform vec3 u_eyePos;
uniform vec3 u_lightPos;
uniform float u_layerAlpha;
uniform bool u_hasBones;

attribute vec3 a_position;
attribute vec3 a_normal;
attribute vec2 a_uv;
attribute vec4 a_tangent;

varying vec2 v_uv;
varying float v_layerAlpha;
varying vec3 v_lightDir;
varying vec3 v_eyeVec;
varying vec3 v_normal;
// varying vec3 v_lightDirWorld;

#if defined(ONLY_TANGENTS)
varying vec3 v_tangent;
#endif

${Gi}
${Ns}

vec3 TBN(vec3 vector, vec3 tangent, vec3 binormal, vec3 normal) {
  return vec3(dot(vector, tangent), dot(vector, binormal), dot(vector, normal));
}

void main() {
  vec3 position = a_position;
  vec3 normal = a_normal;
  vec3 tangent = a_tangent.xyz;

  // Re-orthogonalize the tangent in case it wasnt normalized.
  // See "One last thing" at https://learnopengl.com/Advanced-Lighting/Normal-Mapping
  tangent = normalize(tangent - dot(tangent, normal) * normal);

  vec3 binormal = cross(normal, tangent) * a_tangent.w;

  if (u_hasBones) {
    #ifdef SKIN
      transformSkin(position, normal, tangent, binormal);
    #else
      transformVertexGroupsHD(position, normal, tangent, binormal);
    #endif
  }

  vec3 position_mv = vec3(u_MV * vec4(position, 1));

  mat3 mv = mat3(u_MV);
  vec3 t = normalize(mv * tangent);
  vec3 b = normalize(mv * binormal);
  vec3 n = normalize(mv * normal);

  v_eyeVec = normalize(u_eyePos - position_mv);

  vec3 lightDir = normalize(u_lightPos - position_mv);
  v_lightDir = normalize(TBN(lightDir, t, b, n));
  
  v_uv = a_uv;
  v_layerAlpha = u_layerAlpha;

  v_normal = normal;
  // v_lightDirWorld = normalize(lightDir);

  #if defined(ONLY_TANGENTS)
  v_tangent = tangent;
  #endif

  gl_Position = u_VP * vec4(position, 1.0);
}
`,Ce=`
${ti}

uniform sampler2D u_diffuseMap;
uniform sampler2D u_normalsMap;
uniform sampler2D u_ormMap;
uniform sampler2D u_emissiveMap;
uniform sampler2D u_teamColorMap;
uniform sampler2D u_environmentMap;
uniform float u_filterMode;

// uniform sampler2D u_lutMap;
// uniform sampler2D u_envDiffuseMap;
// uniform sampler2D u_envSpecularMap;

varying vec2 v_uv;
varying float v_layerAlpha;
varying vec3 v_lightDir;
varying vec3 v_eyeVec;
varying vec3 v_normal;
// varying vec3 v_lightDirWorld;

#if defined(ONLY_TANGENTS)
varying vec3 v_tangent;
#endif

vec3 decodeNormal() {
  vec2 xy = texture2D(u_normalsMap, v_uv).xy * 2.0 - 1.0;
  
  return vec3(xy, sqrt(1.0 - dot(xy, xy)));
}

const vec2 invAtan = vec2(0.1591, 0.3183);
vec2 sampleEnvironmentMap(vec3 normal) {
  vec2 uv = vec2(atan(normal.x, normal.y), -asin(normal.z));
  uv *= invAtan;
  uv += 0.5;
  return uv;
}

vec4 getDiffuseColor() {
  vec4 color = texture2D(u_diffuseMap, v_uv);

  // 1bit Alpha
  if (u_filterMode == 1.0 && color.a < 0.75) {
    discard;
  }

  return color;
}

vec4 getOrmColor() {
  return texture2D(u_ormMap, v_uv);
}

vec3 getEmissiveColor() {
  return texture2D(u_emissiveMap, v_uv).rgb;
}

vec3 getTeamColor() {
  return texture2D(u_teamColorMap, v_uv).rgb;
}

// const float PI = 3.14159265359;
// const float RECIPROCAL_PI = 0.31830988618;
// const float RECIPROCAL_PI2 = 0.15915494;
// const float LN2 = 0.6931472;
// const float ENV_LODS = 6.0;
// vec4 SRGBtoLinear(vec4 srgb) {
//     vec3 linOut = pow(srgb.xyz, vec3(2.2));
//     return vec4(linOut, srgb.w);;
// }
// vec4 RGBMToLinear(in vec4 value) {
//     float maxRange = 6.0;
//     return vec4(value.xyz * value.w * maxRange, 1.0);
// }
// vec3 linearToSRGB(vec3 color) {
//     return pow(color, vec3(1.0 / 2.2));
// }
// // vec3 getNormal() {
// //     vec3 pos_dx = dFdx(vMPos.xyz);
// //     vec3 pos_dy = dFdy(vMPos.xyz);
// //     vec2 tex_dx = dFdx(vUv);
// //     vec2 tex_dy = dFdy(vUv);
// //     vec3 t = normalize(pos_dx * tex_dy.t - pos_dy * tex_dx.t);
// //     vec3 b = normalize(-pos_dx * tex_dy.s + pos_dy * tex_dx.s);
// //     mat3 tbn = mat3(t, b, normalize(vNormal));
// //     vec3 n = texture2D(tNormal, vUv * uNormalUVScale).rgb * 2.0 - 1.0;
// //     n.xy *= uNormalScale;
// //     vec3 normal = normalize(tbn * n);
// //     // Get world normal from view normal (normalMatrix * normal)
// //     return normalize((vec4(normal, 0.0) * viewMatrix).xyz);
// // }
// vec3 specularReflection(vec3 specularEnvR0, vec3 specularEnvR90, float VdH) {
//     return specularEnvR0 + (specularEnvR90 - specularEnvR0) * pow(clamp(1.0 - VdH, 0.0, 1.0), 5.0);
// }
// float geometricOcclusion(float NdL, float NdV, float roughness) {
//     float r = roughness;
//     float attenuationL = 2.0 * NdL / (NdL + sqrt(r * r + (1.0 - r * r) * (NdL * NdL)));
//     float attenuationV = 2.0 * NdV / (NdV + sqrt(r * r + (1.0 - r * r) * (NdV * NdV)));
//     return attenuationL * attenuationV;
// }
// float microfacetDistribution(float roughness, float NdH) {
//     float roughnessSq = roughness * roughness;
//     float f = (NdH * roughnessSq - NdH) * NdH + 1.0;
//     return roughnessSq / (PI * f * f);
// }
// vec2 cartesianToPolar(vec3 n) {
//     vec2 uv;
//     uv.x = atan(n.z, n.x) * RECIPROCAL_PI2 + 0.5;
//     uv.y = asin(n.y) * RECIPROCAL_PI + 0.5;
//     return uv;
// }
// void getIBLContribution(inout vec3 diffuse, inout vec3 specular, float NdV, float roughness, vec3 n, vec3 reflection, vec3 diffuseColor, vec3 specularColor) {
//   vec3 brdf = SRGBtoLinear(texture2D(u_lutMap, vec2(NdV, roughness))).rgb;
//   vec3 diffuseLight = RGBMToLinear(texture2D(u_envDiffuseMap, sampleEnvironmentMap(n))).rgb;
//   // Sample 2 levels and mix between to get smoother degradation
//   float blend = roughness * ENV_LODS;
//   float level0 = floor(blend);
//   float level1 = min(ENV_LODS, level0 + 1.0);
//   blend -= level0;
  
//   // Sample the specular env map atlas depending on the roughness value
//   vec2 uvSpec = sampleEnvironmentMap(reflection);
//   uvSpec.y /= 2.0;
//   vec2 uv0 = uvSpec;
//   vec2 uv1 = uvSpec;
//   uv0 /= pow(2.0, level0);
//   uv0.y += 1.0 - exp(-LN2 * level0);
//   uv1 /= pow(2.0, level1);
//   uv1.y += 1.0 - exp(-LN2 * level1);
//   vec3 specular0 = RGBMToLinear(texture2D(u_envSpecularMap, uv0)).rgb;
//   vec3 specular1 = RGBMToLinear(texture2D(u_envSpecularMap, uv1)).rgb;
//   vec3 specularLight = mix(specular0, specular1, blend);
//   diffuse = diffuseLight * diffuseColor;
  
//   // Bit of extra reflection for smooth materials
//   float reflectivity = pow((1.0 - roughness), 2.0) * 0.05;
//   specular = specularLight * (specularColor * brdf.x + brdf.y + reflectivity);
//   // specular *= uEnvSpecular;
// }

// void PBR() {
//   vec4 baseDiffuseColor = getDiffuseColor();
//   vec3 baseColor = baseDiffuseColor.rgb;
//   vec4 orm = getOrmColor();
//   vec3 tc = getTeamColor();
//   float tcFactor = getOrmColor().a;

//   if (tcFactor > 0.1) {
//     baseColor *= tc * tcFactor;
//   }

//   float roughness = clamp(orm.g, 0.04, 1.0);
//   float metallic = clamp(orm.b, 0.04, 1.0);

//   vec3 f0 = vec3(0.04);
//   vec3 diffuseColor = baseColor * (vec3(1.0) - f0) * (1.0 - metallic);
//   vec3 specularColor = mix(f0, baseColor, metallic);
//   vec3 specularEnvR0 = specularColor;
//   vec3 specularEnvR90 = vec3(clamp(max(max(specularColor.r, specularColor.g), specularColor.b) * 25.0, 0.0, 1.0));

//   vec3 N = v_normal;
//   vec3 V = normalize(v_eyeVec);
//   vec3 L = normalize(v_lightDirWorld);
//   vec3 H = normalize(L + V);
//   vec3 reflection = normalize(reflect(-V, N));

//   float NdL = clamp(dot(N, L), 0.001, 1.0);
//   float NdV = clamp(abs(dot(N, V)), 0.001, 1.0);
//   float NdH = clamp(dot(N, H), 0.0, 1.0);
//   float LdH = clamp(dot(L, H), 0.0, 1.0);
//   float VdH = clamp(dot(V, H), 0.0, 1.0);

//   vec3 F = specularReflection(specularEnvR0, specularEnvR90, VdH);
//   float G = geometricOcclusion(NdL, NdV, roughness);
//   float D = microfacetDistribution(roughness, NdH);

//   vec3 diffuseContrib = (1.0 - F) * (diffuseColor / PI);
//   vec3 specContrib = F * G * D / (4.0 * NdL * NdV);
  
//   // Shading based off lights
//   // vec3 color = NdL * uLightColor * (diffuseContrib + specContrib);
//   vec3 color = NdL * (diffuseContrib + specContrib);

//   // Calculate IBL lighting
//   vec3 diffuseIBL;
//   vec3 specularIBL;
//   getIBLContribution(diffuseIBL, specularIBL, NdV, roughness, N, reflection, diffuseColor, specularColor);

//   // Add IBL on top of color
//   color +=  specularIBL;

//   color *= orm.r;

//   color += getEmissiveColor();

//   // Convert to sRGB to display
//   gl_FragColor.rgb = color;
//   gl_FragColor.a = baseDiffuseColor.a;
// }

void onlyDiffuse() {
  vec4 baseColor = getDiffuseColor();
  vec3 tc = getTeamColor();
  float tcFactor = getOrmColor().a;

  if (tcFactor > 0.1) {
    baseColor.rgb *= tc * tcFactor;
  }

  gl_FragColor = baseColor;
}

void onlyNormalMap() {
  gl_FragColor = vec4(decodeNormal(), 1.0);
}

void onlyOcclusion() {
  gl_FragColor = vec4(getOrmColor().rrr, 1.0);
}

void onlyRoughness() {
  gl_FragColor = vec4(getOrmColor().ggg, 1.0);
}

void onlyMetallic() {
  gl_FragColor = vec4(getOrmColor().bbb, 1.0);
}

void onlyTeamColorFactor() {
  gl_FragColor = vec4(getOrmColor().aaa, 1.0);
}

void onlyEmissiveMap() {
  gl_FragColor = vec4(getEmissiveColor(), 1.0);
}

void onlyTexCoords() {
  gl_FragColor = vec4(v_uv, 0.0, 1.0);
}

void onlyNormals() {
  gl_FragColor = vec4(v_normal, 1.0);
}

#if defined(ONLY_TANGENTS)
void onlyTangents() {
  gl_FragColor = vec4(v_tangent, 1.0);
}
#endif

void lambert() {
  vec4 baseColor = getDiffuseColor();
  vec3 normal = decodeNormal();
  vec4 orm = getOrmColor();
  vec3 emissive = getEmissiveColor();
  vec3 tc = getTeamColor();
  float aoFactor = orm.r;
  float tcFactor = orm.a;
  float lambertFactor = clamp(dot(normal, v_lightDir), 0.0, 1.0);
  vec3 color = baseColor.rgb;

  if (tcFactor > 0.1) {
    color *= tc * tcFactor;
  }
  
  color *= clamp(lambertFactor * aoFactor + 0.1, 0.0, 1.0);
  color += emissive;

  gl_FragColor = vec4(color, baseColor.a);
}

void main() {
  #if defined(ONLY_DIFFUSE)
  onlyDiffuse();
  #elif defined(ONLY_NORMAL_MAP)
  onlyNormalMap();
  #elif defined(ONLY_OCCLUSION)
  onlyOcclusion();
  #elif defined(ONLY_ROUGHNESS)
  onlyRoughness();
  #elif defined(ONLY_METALLIC)
  onlyMetallic();
  #elif defined(ONLY_TC_FACTOR)
  onlyTeamColorFactor();
  #elif defined(ONLY_EMISSIVE)
  onlyEmissiveMap();
  #elif defined(ONLY_TEXCOORDS)
  onlyTexCoords();
  #elif defined(ONLY_NORMALS)
  onlyNormals();
  #elif defined(ONLY_TANGENTS)
  onlyTangents();
  #else
  lambert();
  #endif
}
`,sa=`
#define EMITTER_PARTICLE2 0
#define EMITTER_RIBBON 1
#define EMITTER_SPLAT 2
#define EMITTER_UBERSPLAT 3
#define HEAD 0.0

uniform mat4 u_VP;
uniform int u_emitter;

// Shared
uniform vec4 u_colors[3];
uniform vec3 u_vertices[4];
uniform vec3 u_intervals[4];
uniform float u_lifeSpan;
uniform float u_columns;
uniform float u_rows;

// Particle2
uniform vec3 u_scaling;
uniform vec3 u_cameraZ;
uniform float u_timeMiddle;
uniform bool u_teamColored;

// Splat and Uber.
uniform vec3 u_intervalTimes;

// Vertices
attribute float a_position;

// Instances
attribute vec3 a_p0;
attribute vec3 a_p1;
attribute vec3 a_p2;
attribute vec3 a_p3;
attribute float a_health;
attribute vec4 a_color;
attribute float a_tail;
attribute vec3 a_leftRightTop;

varying vec2 v_texcoord;
varying vec4 v_color;

float getCell(vec3 interval, float factor) {
  float start = interval[0];
  float end = interval[1];
  float repeat = interval[2];
  float spriteCount = end - start;

  if (spriteCount > 0.0) {
    // Repeating speeds up the sprite animation, which makes it effectively run N times in its interval.
    // E.g. if repeat is 4, the sprite animation will be seen 4 times, and thus also run 4 times as fast.
    // The sprite index is limited to the number of actual sprites.
    return min(start + mod(floor(spriteCount * repeat * factor), spriteCount), u_columns * u_rows - 1.0);
  }

  return start;
}

void particle2() {
  float factor = (u_lifeSpan - a_health) / u_lifeSpan;
  int index = 0;

  if (factor < u_timeMiddle) {
    factor = factor / u_timeMiddle;
    index = 0;
  } else {
    factor = (factor - u_timeMiddle) / (1.0 - u_timeMiddle);
    index = 1;
  }

  factor = min(factor, 1.0);

  float scale = mix(u_scaling[index], u_scaling[index + 1], factor);
  vec4 color = mix(u_colors[index], u_colors[index + 1], factor);

  float cell = 0.0;

  if (u_teamColored) {
    cell = a_leftRightTop[0];
  } else {
    vec3 interval;

    if (a_tail == HEAD) {
      interval = u_intervals[index];
    } else {
      interval = u_intervals[index + 2];
    }

    cell = getCell(interval, factor);
  }

  float left = floor(mod(cell, u_columns));
  float top = floor(cell / u_columns);
  float right = left + 1.0;
  float bottom = top + 1.0;

  left /= u_columns;
  right /= u_columns;
  top /= u_rows;
  bottom /= u_rows;

  if (a_position == 0.0) {
    v_texcoord = vec2(right, top);
  } else if (a_position == 1.0) {
    v_texcoord = vec2(left, top);
  } else if (a_position == 2.0) {
    v_texcoord = vec2(left, bottom);
  } else if (a_position == 3.0) {
    v_texcoord = vec2(right, bottom);
  }

  v_color = color;
  
  if (a_tail == HEAD) {
    vec3 v = u_vertices[int(a_position)];
    float cs = cos(a_p1.x);
    float sn = sin(a_p1.x);

    float x = v.x * cs - v.y * sn;
    float y = v.x * sn + v.y * cs;

    vec3 fv = vec3(
      v.x * cs - v.y * sn,
      v.x * sn + v.y * cs,
      v.z);

    gl_Position = u_VP * vec4(a_p0 + fv * scale, 1.0);
  } else {
    // Get the normal to the tail in camera space.
    // This allows to build a 2D rectangle around the 3D tail.
    vec3 normal = cross(u_cameraZ, normalize(a_p1 - a_p0));
    vec3 boundary = normal * scale * a_p2[0];
    vec3 position;

    if (a_position == 0.0) {
      position = a_p0 - boundary;
    } else if (a_position == 1.0) {
      position = a_p1 - boundary;
    } else if (a_position == 2.0) {
      position = a_p1 + boundary;
    } else if (a_position == 3.0) {
      position = a_p0 + boundary;
    }

    gl_Position = u_VP * vec4(position, 1.0);
  }
}

void ribbon() {
  vec3 position;
  float left = a_leftRightTop[0] / 255.0;
  float right = a_leftRightTop[1] / 255.0;
  float top = a_leftRightTop[2] / 255.0;
  float bottom = top + 1.0;

  if (a_position == 0.0) {
    v_texcoord = vec2(right, top);
    position = a_p0;
  } else if (a_position == 1.0) {
    v_texcoord = vec2(right, bottom);
    position = a_p1;
  } else if (a_position == 2.0) {
    v_texcoord = vec2(left, bottom);
    position = a_p2;
  } else if (a_position == 3.0) {
    v_texcoord = vec2(left, top);
    position = a_p3;
  }

  v_texcoord[0] /= u_columns;
  v_texcoord[1] /= u_rows;

  v_color = a_color;

  gl_Position = u_VP * vec4(position, 1.0);
}

void splat() {
  float factor = u_lifeSpan - a_health;
  int index;

  if (factor < u_intervalTimes[0]) {
    factor = factor / u_intervalTimes[0];
    index = 0;
  } else {
    factor = (factor - u_intervalTimes[0]) / u_intervalTimes[1];
    index = 1;
  }

  float cell = getCell(u_intervals[index], factor);
  float left = floor(mod(cell, u_columns));
  float top = floor(cell / u_columns);
  float right = left + 1.0;
  float bottom = top + 1.0;
  vec3 position;

  if (a_position == 0.0) {
    v_texcoord = vec2(left, top);
    position = a_p0;
  } else if (a_position == 1.0) {
    v_texcoord = vec2(left, bottom);
    position = a_p1;
  } else if (a_position == 2.0) {
    v_texcoord = vec2(right, bottom);
    position = a_p2;
  } else if (a_position == 3.0) {
    v_texcoord = vec2(right, top);
    position = a_p3;
  }

  v_texcoord[0] /= u_columns;
  v_texcoord[1] /= u_rows;

  v_color = mix(u_colors[index], u_colors[index + 1], factor) / 255.0;

  gl_Position = u_VP * vec4(position, 1.0);
}

void ubersplat() {
  float factor = u_lifeSpan - a_health;
  vec4 color;

  if (factor < u_intervalTimes[0]) {
    color = mix(u_colors[0], u_colors[1], factor / u_intervalTimes[0]);
  } else if (factor < u_intervalTimes[0] + u_intervalTimes[1]) {
    color = u_colors[1];
  } else {
    color = mix(u_colors[1], u_colors[2], (factor - u_intervalTimes[0] - u_intervalTimes[1]) / u_intervalTimes[2]);
  }

  vec3 position;

  if (a_position == 0.0) {
    v_texcoord = vec2(0.0, 0.0);
    position = a_p0;
  } else if (a_position == 1.0) {
    v_texcoord = vec2(0.0, 1.0);
    position = a_p1;
  } else if (a_position == 2.0) {
    v_texcoord = vec2(1.0, 1.0);
    position = a_p2;
  } else if (a_position == 3.0) {
    v_texcoord = vec2(1.0, 0.0);
    position = a_p3;
  }

  v_color = color / 255.0;

  gl_Position = u_VP * vec4(position, 1.0);
}

void main() {
  if (u_emitter == EMITTER_PARTICLE2) {
    particle2();
  } else if (u_emitter == EMITTER_RIBBON) {
    ribbon();
  } else if (u_emitter == EMITTER_SPLAT) {
    splat();
  } else if (u_emitter == EMITTER_UBERSPLAT) {
    ubersplat();
  }
}
`,ra=`
${ti}

#define EMITTER_PARTICLE2 0
#define EMITTER_RIBBON 1

uniform sampler2D u_texture;
uniform highp int u_emitter;
uniform float u_filterMode;

varying vec2 v_texcoord;
varying vec4 v_color;

void main() {
  vec4 texel = texture2D(u_texture, v_texcoord);
  vec4 color = texel * v_color;

  // 1bit Alpha, used by ribbon emitters.
  if (u_emitter == EMITTER_RIBBON && u_filterMode == 1.0 && color.a < 0.75) {
    discard;
  }

  // "Close to 0 alpha"
  if (u_emitter == EMITTER_PARTICLE2 && (u_filterMode == 2.0 || u_filterMode == 3.0) && color.a < 0.02) {
    discard;
  }

  // Alpha key.
  if (u_emitter == EMITTER_PARTICLE2 && (u_filterMode == 4.0) && color.a < 0.75) {
    discard;
  }

  gl_FragColor = color;
}
`,oa=s=>new $r(s),aa=s=>Mr(s),ii={load(s,e,t=!1){const i=s.gl,n=s.webgl;if(!n.ensureExtension("OES_texture_float"))throw new Error("MDX: No float texture support!");if(!n.ensureExtension("ANGLE_instanced_arrays"))throw new Error("MDX: No instanced rendering support!");const r=`#define EXTENDED_BONES
`+gt,o=`#define ONLY_DIFFUSE
`+vt,a=`#define ONLY_TEXCOORDS
`+vt,l=`#define ONLY_NORMALS
`+vt,c=`#define EXTENDED_BONES
`+Ie,d=`#define SKIN
`+Ie,h=`#define ONLY_DIFFUSE
`+Ce,f=`#define ONLY_NORMAL_MAP
`+Ce,p=`#define ONLY_OCCLUSION
`+Ce,u=`#define ONLY_ROUGHNESS
`+Ce,g=`#define ONLY_METALLIC
`+Ce,v=`#define ONLY_TC_FACTOR
`+Ce,w=`#define ONLY_EMISSIVE
`+Ce,y=`#define ONLY_TEXCOORDS
`+Ce,R=`#define ONLY_NORMALS
`+Ce,E=`#define ONLY_TANGENTS
`+Ce,x=n.createShader(gt,vt),T=n.createShader(r,vt),L=`#define SKIN
`+gt,H=n.createShader(L,vt),M=n.createShader(Ie,Ce),$=n.createShader(c,Ce),ne=n.createShader(d,Ce),D=n.createShader(sa,ra),ee=[],Y=[];let B=[];B[N.Diffuse]=n.createShader(gt,o),B[N.TexCoords]=n.createShader(gt,a),B[N.Normals]=n.createShader(gt,l),ee[ue.VertexGroups]=B,B=[],B[N.Diffuse]=n.createShader(r,o),B[N.TexCoords]=n.createShader(r,a),B[N.Normals]=n.createShader(r,l),ee[ue.ExtendedVertexGroups]=B,B=[],B[N.Diffuse]=n.createShader(Ie,h),B[N.NormalMap]=n.createShader(Ie,f),B[N.Occlusion]=n.createShader(Ie,p),B[N.Roughness]=n.createShader(Ie,u),B[N.Metallic]=n.createShader(Ie,g),B[N.TCFactor]=n.createShader(Ie,v),B[N.Emissive]=n.createShader(Ie,w),B[N.TexCoords]=n.createShader(Ie,y),B[N.Normals]=n.createShader(Ie,R),B[N.Tangents]=n.createShader(`#define ONLY_TANGENTS
`+Ie,E),Y[ue.VertexGroups]=B,B=[],B[N.Diffuse]=n.createShader(c,h),B[N.NormalMap]=n.createShader(c,f),B[N.Occlusion]=n.createShader(c,p),B[N.Roughness]=n.createShader(c,u),B[N.Metallic]=n.createShader(c,g),B[N.TCFactor]=n.createShader(c,v),B[N.Emissive]=n.createShader(c,w),B[N.TexCoords]=n.createShader(c,y),B[N.Normals]=n.createShader(c,R),B[N.Tangents]=n.createShader(`#define ONLY_TANGENTS
`+c,E),Y[ue.ExtendedVertexGroups]=B,B=[],B[N.Diffuse]=n.createShader(d,h),B[N.NormalMap]=n.createShader(d,f),B[N.Occlusion]=n.createShader(d,p),B[N.Roughness]=n.createShader(d,u),B[N.Metallic]=n.createShader(d,g),B[N.TCFactor]=n.createShader(d,v),B[N.Emissive]=n.createShader(d,w),B[N.TexCoords]=n.createShader(d,y),B[N.Normals]=n.createShader(d,R),B[N.Tangents]=n.createShader(`#define ONLY_TANGENTS
`+d,E),Y[ue.Skin]=B;const z=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,z),i.bufferData(i.ARRAY_BUFFER,new Uint8Array([0,1,2,0,2,3]),i.STATIC_DRAW);const P={pathSolver:e,reforged:t,sdShader:x,sdSkinShader:H,sdExtendedShader:T,hdShader:M,hdExtendedShader:$,hdSkinShader:ne,particlesShader:D,sdDebugShaders:ee,hdDebugShaders:Y,rectBuffer:z,teamColors:[],teamGlows:[],eventObjectTables:{}};s.sharedCache.set("mdx",P)},isValidSource(s){return s instanceof Yt?!0:$n(s)||Xn(s)},resource:na,loadTeamTextures(s){const{pathSolver:e,reforged:t,teamColors:i,teamGlows:n}=s.sharedCache.get("mdx");if(i.length===0){const r=t?28:16,o=t?"dds":"blp",a=t?{reforged:!0}:void 0;for(let l=0;l<r;l++){const d=`${`${l}`.padStart(2,"0")}.${o}`,h=new Bt(1,et.WrapBoth),f=new Bt(2,et.WrapBoth);s.load(`ReplaceableTextures\\TeamColor\\TeamColor${d}`,e,a).then(p=>h.texture=p),s.load(`ReplaceableTextures\\TeamGlow\\TeamGlow${d}`,e,a).then(p=>f.texture=p),i[l]=h,n[l]=f}}},getEventObjectSoundFile(s,e,t,i){if(!e||Pr(s)===".flac")return s;for(let n=1,r=i.length;n<r;n++){const o=i[n].data.getRow(s);if(o){const a=o.string("Flags"),l=o.string("Filepath");if(a==="SD_ONLY"){if(!t)return l}else if(a==="HD_ONLY"){if(t)return l}else return l}}},async getEventObjectData(s,e,t,i){if(e!=="SPN"&&e!=="SPL"&&e!=="UBR"&&e!=="SND")return;const{pathSolver:n,reforged:r,eventObjectTables:o}=s.sharedCache.get("mdx"),a=r?{reforged:!0}:{},l=(p,u)=>n?n(p,u):p;if(!o[e]){const p=[];e==="SPN"?p.push("Splats\\SpawnData.slk"):e==="SPL"?p.push("Splats\\SplatData.slk"):e==="UBR"?p.push("Splats\\UberSplatData.slk"):e==="SND"&&(p.push("UI\\SoundInfo\\AnimSounds.slk"),r?p.push("UI\\SoundInfo\\DialogueHumanBase.slk","UI\\SoundInfo\\DialogueOrcBase.slk","UI\\SoundInfo\\DialogueUndeadBase.slk","UI\\SoundInfo\\DialogueNightElfBase.slk","UI\\SoundInfo\\DialogueNagaBase.slk","UI\\SoundInfo\\DialogueDemonBase.slk","UI\\SoundInfo\\DialogueCreepsBase.slk"):p.push("UI\\SoundInfo\\AnimLookups.slk"));const u=p.map(v=>s.loadGeneric(l(v,a),"text",oa)),g=await Promise.all(u);for(const v of g)if(!v)return;o[e]=g}const c=o[e],d=c[0].data;let h;const f=[];if(e==="SND"){if(r)h=d.findRow("AnimationEventCode",t);else{const p=c[1].data.getRow(t);p&&(h=d.getRow(p.string("SoundLabel")))}if(h)for(const p of h.string("FileNames").split(",")){const u=this.getEventObjectSoundFile(p,r,i,c);u&&f.push(s.loadGeneric(l(u,a),"arrayBuffer",aa))}}else h=d.getRow(t),h&&(e==="SPN"?f.push(s.load(h.string("Model").replace(".mdl",".mdx"),l,a)):(e==="SPL"||e==="UBR")&&f.push(s.load(`ReplaceableTextures\\Splats\\${h.string("file")}${r?".dds":".blp"}`,l,a)));if(h&&f.length){const u=(await Promise.all(f)).filter(g=>g);if(u.length)return{row:h,resources:u}}},getBatchShader(s,e,t){const i=s.sharedCache.get("mdx"),n=s.debugRenderMode;if(t){if(n!==N.None){const r=i.hdDebugShaders[e];if(r){const o=r[n];if(o)return o}}return e===ue.Skin?i.hdSkinShader:e===ue.VertexGroups?i.hdShader:i.hdExtendedShader}else{if(n!==N.None){const r=i.sdDebugShaders[e];if(r){const o=r[n];if(o)return o}}return e===ue.Skin?i.sdSkinShader:e===ue.VertexGroups?i.sdShader:i.sdExtendedShader}}};class la{buffer;uint8array;index=0;byteLength;bitBuffer=0;bits=0;constructor(e,t,i){const n=Et(e);t=t||0,i=i||n.length,this.buffer=e,this.uint8array=n.subarray(t,t+i),this.byteLength=e.byteLength}peekBits(e){return this.loadBits(e),this.bitBuffer&(1<<e)-1}readBits(e){const t=this.peekBits(e);return this.bitBuffer>>>=e,this.bits-=e,t}skipBits(e){this.loadBits(e),this.bitBuffer>>>=e,this.bits-=e}loadBits(e){for(;this.bits<e;)this.bitBuffer+=this.uint8array[this.index]<<this.bits,this.bits+=8,this.index+=1}}function ni(s,e){return((1<<e)-1)/((1<<s)-1)}const ca=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(s){return typeof s}:function(s){return s&&typeof Symbol=="function"&&s.constructor===Symbol&&s!==Symbol.prototype?"symbol":typeof s},He=(function(){function e(t){this.message="JPEG error: "+t}return e.prototype=new Error,e.prototype.name="JpegError",e.constructor=e,e})(),Ft=new Uint8Array([0,1,8,16,9,2,3,10,17,24,32,25,18,11,4,5,12,19,26,33,40,48,41,34,27,20,13,6,7,14,21,28,35,42,49,56,57,50,43,36,29,22,15,23,30,37,44,51,58,59,52,45,38,31,39,46,53,60,61,54,47,55,62,63]),si=4017,ri=799,oi=3406,ai=2276,li=1567,ci=3784,bt=5793,hi=2896;function ha(s,e){let t=0,i=[],n,r,o=16;for(;o>0&&!s[o-1];)o--;i.push({children:[],index:0});let a=i[0],l;for(n=0;n<o;n++){for(r=0;r<s[n];r++){for(a=i.pop(),a.children[a.index]=e[t];a.index>0;)a=i.pop();for(a.index++,i.push(a);i.length<=n;)i.push(l={children:[],index:0}),a.children[a.index]=l.children,a=l;t++}n+1<o&&(i.push(l={children:[],index:0}),a.children[a.index]=l.children,a=l)}return i[0].children}function di(s,e,t){return 64*((s.blocksPerLine+1)*e+t)}function da(s,e,t,i,n,r,o,a,l){const c=t.mcusPerLine,d=t.progressive;let h=e,f=0,p=0;function u(){if(p>0)return p--,f>>p&1;if(f=s[e++],f===255){const F=s[e++];if(F)throw new He("unexpected marker "+(f<<8|F).toString(16))}return p=7,f>>>7}function g(F){let U=F;for(;;){if(U=U[u()],typeof U=="number")return U;if((typeof U>"u"?"undefined":ca(U))!=="object")throw new He("invalid huffman sequence")}}function v(F){let U=0;for(;F>0;)U=U<<1|u(),F--;return U}function w(F){if(F===1)return u()===1?1:-1;const U=v(F);return U>=1<<F-1?U:U+(-1<<F)+1}function y(F,U){const W=g(F.huffmanTableDC),ve=W===0?0:w(W);F.blockData[U]=F.pred+=ve;let X=1;for(;X<64;){const le=g(F.huffmanTableAC),be=le&15,fe=le>>4;if(be===0){if(fe<15)break;X+=16;continue}X+=fe;const We=Ft[X];F.blockData[U+We]=w(be),X++}}function R(F,U){const W=g(F.huffmanTableDC),ve=W===0?0:w(W)<<l;F.blockData[U]=F.pred+=ve}function E(F,U){F.blockData[U]|=u()<<l}let x=0;function T(F,U){if(x>0){x--;return}let W=r,ve=o;for(;W<=ve;){const X=g(F.huffmanTableAC),le=X&15,be=X>>4;if(le===0){if(be<15){x=v(be)+(1<<be)-1;break}W+=16;continue}W+=be;const fe=Ft[W];F.blockData[U+fe]=w(le)*(1<<l),W++}}let L=0,H;function M(F,U){let W=r;const ve=o;let X=0,le,be;for(;W<=ve;){const fe=Ft[W];switch(L){case 0:if(be=g(F.huffmanTableAC),le=be&15,X=be>>4,le===0)X<15?(x=v(X)+(1<<X),L=4):(X=16,L=1);else{if(le!==1)throw new He("invalid ACn encoding");H=w(le),L=X?2:3}continue;case 1:case 2:F.blockData[U+fe]?F.blockData[U+fe]+=u()<<l:(X--,X===0&&(L=L===2?3:0));break;case 3:F.blockData[U+fe]?F.blockData[U+fe]+=u()<<l:(F.blockData[U+fe]=H<<l,L=0);break;case 4:F.blockData[U+fe]&&(F.blockData[U+fe]+=u()<<l);break}W++}L===4&&(x--,x===0&&(L=0))}function $(F,U,W,ve,X){const le=W/c|0,be=W%c,fe=le*F.v+ve,We=be*F.h+X,jt=di(F,fe,We);U(F,jt)}function ne(F,U,W){const ve=W/F.blocksPerLine|0,X=W%F.blocksPerLine,le=di(F,ve,X);U(F,le)}const D=i.length;let ee,Y,B,z,P,V;d?r===0?V=a===0?R:E:V=a===0?T:M:V=y;let j=0,G,se;D===1?se=i[0].blocksPerLine*i[0].blocksPerColumn:se=c*t.mcusPerColumn;let Ee,Re;for(;j<se;){const F=n?Math.min(se-j,n):se;for(Y=0;Y<D;Y++)i[Y].pred=0;if(x=0,D===1)for(ee=i[0],P=0;P<F;P++)ne(ee,V,j),j++;else for(P=0;P<F;P++){for(Y=0;Y<D;Y++)for(ee=i[Y],Ee=ee.h,Re=ee.v,B=0;B<Re;B++)for(z=0;z<Ee;z++)$(ee,V,j,B,z);j++}p=0,G=qi(s,e),G&&G.invalid&&(e=G.offset);const U=G&&G.marker;if(!U||U<=65280)throw new He("marker was not found");if(U>=65488&&U<=65495)e+=2;else break}return G=qi(s,e),G&&G.invalid&&(e=G.offset),e-h}function ua(s,e,t){const i=s.quantizationTable,n=s.blockData;let r,o,a,l,c,d,h,f,p,u,g,v,w,y,R,E,x;if(!i)throw new He("missing required Quantization Table.");for(let T=0;T<64;T+=8){if(p=n[e+T],u=n[e+T+1],g=n[e+T+2],v=n[e+T+3],w=n[e+T+4],y=n[e+T+5],R=n[e+T+6],E=n[e+T+7],p*=i[T],(u|g|v|w|y|R|E)===0){x=bt*p+512>>10,t[T]=x,t[T+1]=x,t[T+2]=x,t[T+3]=x,t[T+4]=x,t[T+5]=x,t[T+6]=x,t[T+7]=x;continue}u*=i[T+1],g*=i[T+2],v*=i[T+3],w*=i[T+4],y*=i[T+5],R*=i[T+6],E*=i[T+7],r=bt*p+128>>8,o=bt*w+128>>8,a=g,l=R,c=hi*(u-E)+128>>8,f=hi*(u+E)+128>>8,d=v<<4,h=y<<4,r=r+o+1>>1,o=r-o,x=a*ci+l*li+128>>8,a=a*li-l*ci+128>>8,l=x,c=c+h+1>>1,h=c-h,f=f+d+1>>1,d=f-d,r=r+l+1>>1,l=r-l,o=o+a+1>>1,a=o-a,x=c*ai+f*oi+2048>>12,c=c*oi-f*ai+2048>>12,f=x,x=d*ri+h*si+2048>>12,d=d*si-h*ri+2048>>12,h=x,t[T]=r+f,t[T+7]=r-f,t[T+1]=o+h,t[T+6]=o-h,t[T+2]=a+d,t[T+5]=a-d,t[T+3]=l+c,t[T+4]=l-c}for(let T=0;T<8;++T){if(p=t[T],u=t[T+8],g=t[T+16],v=t[T+24],w=t[T+32],y=t[T+40],R=t[T+48],E=t[T+56],(u|g|v|w|y|R|E)===0){x=bt*p+8192>>14,x=x<-2040?0:x>=2024?255:x+2056>>4,n[e+T]=x,n[e+T+8]=x,n[e+T+16]=x,n[e+T+24]=x,n[e+T+32]=x,n[e+T+40]=x,n[e+T+48]=x,n[e+T+56]=x;continue}r=bt*p+2048>>12,o=bt*w+2048>>12,a=g,l=R,c=hi*(u-E)+2048>>12,f=hi*(u+E)+2048>>12,d=v,h=y,r=(r+o+1>>1)+4112,o=r-o,x=a*ci+l*li+2048>>12,a=a*li-l*ci+2048>>12,l=x,c=c+h+1>>1,h=c-h,f=f+d+1>>1,d=f-d,r=r+l+1>>1,l=r-l,o=o+a+1>>1,a=o-a,x=c*ai+f*oi+2048>>12,c=c*oi-f*ai+2048>>12,f=x,x=d*ri+h*si+2048>>12,d=d*si-h*ri+2048>>12,h=x,p=r+f,E=r-f,u=o+h,R=o-h,g=a+d,y=a-d,v=l+c,w=l-c,p=p<16?0:p>=4080?255:p>>4,u=u<16?0:u>=4080?255:u>>4,g=g<16?0:g>=4080?255:g>>4,v=v<16?0:v>=4080?255:v>>4,w=w<16?0:w>=4080?255:w>>4,y=y<16?0:y>=4080?255:y>>4,R=R<16?0:R>=4080?255:R>>4,E=E<16?0:E>=4080?255:E>>4,n[e+T]=p,n[e+T+8]=u,n[e+T+16]=g,n[e+T+24]=v,n[e+T+32]=w,n[e+T+40]=y,n[e+T+48]=R,n[e+T+56]=E}}function fa(s,e){const t=e.blocksPerLine,i=e.blocksPerColumn,n=new Int16Array(64);for(let r=0;r<i;r++)for(let o=0;o<t;o++){const a=di(e,r,o);ua(e,a,n)}return e.blockData}function qi(s,e,t){function i(l){return s[l]<<8|s[l+1]}const n=s.length-1;let r=t<e?t:e;if(e>=n)return null;const o=i(e);if(o>=65472&&o<=65534)return{invalid:null,marker:o,offset:e};let a=i(r);for(;!(a>=65472&&a<=65534);){if(++r>=n)return null;a=i(r)}return{invalid:o.toString(16),marker:a,offset:r}}class pa{constructor(){this.decodeTransform=null,this.colorTransform=-1,this.width=0,this.height=0}parse(e){function t(){const P=e[r]<<8|e[r+1];return r+=2,P}function i(){const P=t();let V=r+P-2;const j=qi(e,V,r);j&&j.invalid&&(V=j.offset);const G=e.subarray(r,V);return r+=G.length,G}function n(P){const V=Math.ceil(P.samplesPerLine/8/P.maxH),j=Math.ceil(P.scanLines/8/P.maxV);for(let G=0;G<P.components.length;G++){D=P.components[G];const se=Math.ceil(Math.ceil(P.samplesPerLine/8)*D.h/P.maxH),Ee=Math.ceil(Math.ceil(P.scanLines/8)*D.v/P.maxV),Re=V*D.h,U=64*(j*D.v)*(Re+1);D.blockData=new Int16Array(U),D.blocksPerLine=se,D.blocksPerColumn=Ee}P.mcusPerLine=V,P.mcusPerColumn=j}var r=0;let o=null,a=null,l,c;const d=[],h=[],f=[];let p=t();if(p!==65496)throw new He("SOI not found");for(p=t();p!==65497;){var u,g,v;switch(p){case 65504:case 65505:case 65506:case 65507:case 65508:case 65509:case 65510:case 65511:case 65512:case 65513:case 65514:case 65515:case 65516:case 65517:case 65518:case 65519:case 65534:var w=i();p===65504&&w[0]===74&&w[1]===70&&w[2]===73&&w[3]===70&&w[4]===0&&(o={version:{major:w[5],minor:w[6]},densityUnits:w[7],xDensity:w[8]<<8|w[9],yDensity:w[10]<<8|w[11],thumbWidth:w[12],thumbHeight:w[13],thumbData:w.subarray(14,14+3*w[12]*w[13])}),p===65518&&w[0]===65&&w[1]===100&&w[2]===111&&w[3]===98&&w[4]===101&&(a={version:w[5]<<8|w[6],flags0:w[7]<<8|w[8],flags1:w[9]<<8|w[10],transformCode:w[11]});break;case 65499:for(var y=t(),R=y+r-2,E;r<R;){const P=e[r++],V=new Uint16Array(64);if(P>>4===0)for(g=0;g<64;g++)E=Ft[g],V[E]=e[r++];else if(P>>4===1)for(g=0;g<64;g++)E=Ft[g],V[E]=t();else throw new He("DQT - invalid table spec");d[P&15]=V}break;case 65472:case 65473:case 65474:if(l)throw new He("Only single frame JPEGs supported");t(),l={},l.extended=p===65473,l.progressive=p===65474,l.precision=e[r++],l.scanLines=t(),l.samplesPerLine=t(),l.components=[],l.componentIds={};var x=e[r++],T,L=0,H=0;for(u=0;u<x;u++){T=e[r];const P=e[r+1]>>4,V=e[r+1]&15;L<P&&(L=P),H<V&&(H=V);const j=e[r+2];v=l.components.push({h:P,v:V,quantizationId:j,quantizationTable:null}),l.componentIds[T]=v-1,r+=3}l.maxH=L,l.maxV=H,n(l);break;case 65476:var M=t();for(u=2;u<M;){const P=e[r++],V=new Uint8Array(16);let j=0;for(g=0;g<16;g++,r++)j+=V[g]=e[r];const G=new Uint8Array(j);for(g=0;g<j;g++,r++)G[g]=e[r];u+=17+j,(P>>4===0?f:h)[P&15]=ha(V,G)}break;case 65501:t(),c=t();break;case 65498:t();var $=e[r++],ne=[],D;for(u=0;u<$;u++){const P=l.componentIds[e[r++]];D=l.components[P];const V=e[r++];D.huffmanTableDC=f[V>>4],D.huffmanTableAC=h[V&15],ne.push(D)}var ee=e[r++],Y=e[r++],B=e[r++],z=da(e,r,l,ne,c,ee,Y,B>>4,B&15);r+=z;break;case 65535:e[r]!==255&&r--;break;default:if(e[r-3]===255&&e[r-2]>=192&&e[r-2]<=254){r-=3;break}throw new He("unknown marker "+p.toString(16))}p=t()}for(this.width=l.samplesPerLine,this.height=l.scanLines,this.jfif=o,this.adobe=a,this.components=[],u=0;u<l.components.length;u++){D=l.components[u];const P=d[D.quantizationId];P&&(D.quantizationTable=P),this.components.push({output:fa(l,D),scaleX:D.h/l.maxH,scaleY:D.v/l.maxV,blocksPerLine:D.blocksPerLine,blocksPerColumn:D.blocksPerColumn})}this.numComponents=this.components.length}getData(e){const t=e.data,i=this.components,n=new Uint8Array((i[0].blocksPerLine<<3)*i[0].blocksPerColumn*8);[i[0],i[2]]=[i[2],i[0]];for(let l=0,c=i.length;l<c;l++){const d=i[l],h=d.blocksPerLine,f=d.blocksPerColumn,p=h<<3;var r,o,a=0;for(let g=0;g<f;g++){const v=g<<3;for(let w=0;w<h;w++){const y=di(d,g,w);let R=0,E=w<<3;for(r=0;r<8;r++){var a=(v+r)*p;for(o=0;o<8;o++)n[a+E+o]=d.output[y+R++]}}}let u=l;for(let g=0;g<this.height;g++)for(let v=0;v<this.width;v++)t[u]=n[g*p+v],u+=c}return t}}const ma=827345986,Vs=0;class ji{content=0;alphaBits=0;width=0;height=0;type=0;hasMipmaps=!1;mipmapOffsets=new Uint32Array(16);mipmapSizes=new Uint32Array(16);uint8array=null;jpgHeader=null;pallete=null;load(e){const t=Et(e),i=new Int32Array(t.buffer,0,40);if(i[0]!==ma)throw new Error("WrongMagicNumber");this.content=i[1],this.alphaBits=i[2],this.width=i[3],this.height=i[4],this.type=i[5],this.hasMipmaps=i[6]!==0;for(let n=0;n<16;n++)this.mipmapOffsets[n]=i[7+n],this.mipmapSizes[n]=i[23+n];this.uint8array=t,this.content===Vs?this.jpgHeader=t.subarray(160,160+i[39]):this.pallete=t.subarray(156,1180)}getMipmap(e){const t=this.uint8array,i=this.mipmapOffsets[e],n=this.mipmapSizes[e];let r;if(this.content===Vs){const o=this.jpgHeader,a=new Uint8Array(o.length+n),l=new pa;a.set(o),a.set(t.subarray(i,i+n),o.length),l.parse(a),r=new ImageData(l.width,l.height),l.getData(r)}else{const o=this.pallete,a=Math.max(this.width/(1<<e),1),l=Math.max(this.height/(1<<e),1),c=a*l;let d=this.alphaBits,h,f=0;r=new ImageData(a,l),d>0&&(d>8&&(d=8),h=new la(t.buffer,i+c,Math.ceil(c*d/8)),f=ni(d,8));const p=r.data;for(let u=0;u<c;u++){const g=u*4,v=t[i+u]*4;p[g]=o[v+2],p[g+1]=o[v+1],p[g+2]=o[v],d>0?p[g+3]=h.readBits(d)*f:p[g+3]=255}}return r}mipmaps(){let e=0;for(const t of this.mipmapSizes)t>0&&(e+=1);return e}fakeMipmaps(){const e=this.mipmapOffsets;let t=0;for(let i=0;i<16;i++){const n=e[i];if(n>0){for(let r=i+1;r<16;r++)if(n===e[r]){t+=1;break}}}return t}}function ga(s){return s instanceof ArrayBuffer&&(s=new Uint8Array(s)),s instanceof Uint8Array&&s[0]===66&&s[1]===76&&s[2]===80&&s[3]===49}class va extends Ht{constructor(e,t){super(t);let i;e instanceof ji?i=e:(i=new ji,i.load(e));const r=this.viewer.gl,o=r.createTexture();r.bindTexture(r.TEXTURE_2D,o),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR);const a=ct(i.width)&&ct(i.height);a||(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE));const l=i.mipmaps();if(l===1||i.fakeMipmaps()||!a){const c=i.getMipmap(0);r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,c)}else{r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR_MIPMAP_LINEAR);let c=i.width,d=i.height;for(let h=0;h<l;h++){const f=i.getMipmap(h);r.texImage2D(r.TEXTURE_2D,h,r.RGBA,c,d,0,r.RGBA,r.UNSIGNED_BYTE,f.data),c=Math.ceil(c/2),d=Math.ceil(d/2)}}this.width=i.width,this.height=i.height,this.webglResource=o}}const ba={isValidSource(s){return s instanceof ji?!0:ga(s)},resource:va},wa=ni(4,8),Ye=ni(5,8),ui=ni(6,8),kt=new Uint8Array(16),ze=new Uint8Array(12),Gs=new Uint8Array(8),qs=new Uint8Array(8),js=new Uint8Array(8);function ya(s,e,t){const i=(e>>11&31)*Ye,n=(e>>5&63)*ui,r=(e&31)*Ye,o=(t>>11&31)*Ye,a=(t>>5&63)*ui,l=(t&31)*Ye;s[0]=i,s[1]=n,s[2]=r,s[3]=255,s[4]=o,s[5]=a,s[6]=l,s[7]=255,e>t?(s[8]=5*i+3*o>>3,s[9]=5*n+3*a>>3,s[10]=5*r+3*l>>3,s[11]=255,s[12]=5*o+3*i>>3,s[13]=5*a+3*n>>3,s[14]=5*l+3*r>>3,s[15]=255):(s[8]=i+o>>1,s[9]=n+a>>1,s[10]=r+l>>1,s[11]=255,s[12]=0,s[13]=0,s[14]=0,s[15]=0)}function Ks(s,e,t){const i=(e>>11&31)*Ye,n=(e>>5&63)*ui,r=(e&31)*Ye,o=(t>>11&31)*Ye,a=(t>>5&63)*ui,l=(t&31)*Ye;s[0]=i,s[1]=n,s[2]=r,s[3]=o,s[4]=a,s[5]=l,s[6]=5*i+3*o>>3,s[7]=5*n+3*a>>3,s[8]=5*r+3*l>>3,s[9]=5*o+3*i>>3,s[10]=5*a+3*n>>3,s[11]=5*l+3*r>>3}function Aa(s,e,t){s[0]=e,s[1]=t,e>t?(s[2]=54*e+9*t>>6,s[3]=45*e+18*t>>6,s[4]=36*e+27*t>>6,s[5]=27*e+36*t>>6,s[6]=18*e+45*t>>6,s[7]=9*e+54*t>>6):(s[2]=12*e+3*t>>4,s[3]=9*e+6*t>>4,s[4]=6*e+9*t>>4,s[5]=3*e+12*t>>4,s[6]=0,s[7]=255)}function Hs(s,e,t){s[0]=e,s[1]=t,e>t?(s[2]=(6*e+1*t)/7,s[3]=(5*e+2*t)/7,s[4]=(4*e+3*t)/7,s[5]=(3*e+4*t)/7,s[6]=(2*e+5*t)/7,s[7]=(1*e+6*t)/7):(s[2]=(4*e+1*t)/5,s[3]=(3*e+2*t)/5,s[4]=(2*e+3*t)/5,s[5]=(1*e+4*t)/5,s[6]=0,s[7]=1)}function Ta(s,e,t){const i=new Uint8Array(e*t*4);for(let n=0,r=t/4;n<r;n++)for(let o=0,a=e/4;o<a;o++){const l=8*(n*a+o);ya(kt,s[l]+256*s[l+1],s[l+2]+256*s[l+3]);const c=n*16*e+o*16,d=s[l+4]|s[l+5]<<8|s[l+6]<<16|s[l+7]<<24;for(let h=0;h<4;h++){const f=h*8,p=c+h*e*4;for(let u=0;u<4;u++){const g=p+u*4,v=(d>>f+u*2&3)*4;i[g+0]=kt[v+0],i[g+1]=kt[v+1],i[g+2]=kt[v+2],i[g+3]=kt[v+3]}}}return i}function Sa(s,e,t){const i=new Uint8Array(e*t*4),n=e*4;for(let r=0,o=t/4;r<o;r++)for(let a=0,l=e/4;a<l;a++){const c=16*(r*l+a);Ks(ze,s[c+8]+256*s[c+9],s[c+10]+256*s[c+11]);let d=r*16*e+a*16;for(let h=0;h<4;h++){const f=s[c+h*2]+256*s[c+1+h*2],p=s[c+12+h];for(let u=0;u<4;u++){const g=d+u*4,v=(p>>u*2&3)*3;i[g+0]=ze[v+0],i[g+1]=ze[v+1],i[g+2]=ze[v+2],i[g+3]=(f>>u*4&15)*wa}d+=n}}return i}function Ea(s,e,t){const i=new Uint8Array(e*t*4),n=e*4;for(let r=0,o=t/4;r<o;r++)for(let a=0,l=e/4;a<l;a++){const c=16*(r*l+a);Aa(Gs,s[c],s[c+1]),Ks(ze,s[c+8]+256*s[c+9],s[c+10]+256*s[c+11]);let d=r*16*e+a*16;for(let h=0;h<2;h++){const f=c+2+h*3,p=c+12+h*2,u=s[f]+256*(s[f+1]+256*s[f+2]);for(let g=0;g<2;g++){const v=s[p+g];for(let w=0;w<4;w++){const y=d+w*4,R=(v>>w*2&3)*3,E=u>>g*12+w*3&7;i[y+0]=ze[R+0],i[y+1]=ze[R+1],i[y+2]=ze[R+2],i[y+3]=Gs[E]}d+=n}}}return i}function xa(s,e,t){const i=new Uint8Array(e*t*2),n=e*2;for(let r=0,o=t/4;r<o;r++)for(let a=0,l=e/4;a<l;a++){const c=16*(r*l+a);Hs(qs,s[c],s[c+1]),Hs(js,s[c+8],s[c+9]);let d=r*8*e+a*8;for(let h=0;h<2;h++){const f=c+h*3,p=s[f+2]+256*(s[f+3]+256*s[f+4]),u=s[f+10]+256*(s[f+11]+256*s[f+12]);for(let g=0;g<2;g++){const v=g*4;for(let w=0;w<4;w++){const y=d+w*2,R=3*(v+w);i[y+1]=qs[p>>R&7],i[y+2]=js[u>>R&7]}d+=n}}}return i}const _a=542327876,Ia=131072,Ca=4,nt=827611204,Pt=861165636,Mt=894720068,Ki=843666497,La=808540228,Ra=71,Ba=74,Fa=77,ka=83;class Hi{width=0;height=0;format=0;mipmapWidths=[];mipmapHeights=[];mipmapDatas=[];load(e){const t=Et(e),i=new Int32Array(t.buffer,0,31);let n=128;if(i[0]!==_a)throw new Error("Wrong magic number");if(!(i[20]&Ca))throw new Error("Not FourCC");let r=i[21];if(r!==nt&&r!==Pt&&r!==Mt&&r!==Ki)if(r===La){n+=20;const d=new Int32Array(t.buffer,128,5),h=d[0];if(h===Ra)r=nt;else if(h===Ba)r=Pt;else if(h===Fa)r=Mt;else if(h===ka)r=Ki;else throw new Error(`Unsupported DXGI format: ${h}`);console.log(d)}else throw new Error(`Unsupported FourCC: ${Vr(r)}`);this.format=r;let o=1;i[2]&Ia&&(o=Math.max(1,i[7]));let a=i[4],l=i[3],c=16;r===nt&&(c=8),this.width=a,this.height=l;for(let d=0;d<o;d++){const h=Math.max(4,a)/4*Math.max(4,l)/4*c;this.mipmapWidths[d]=a,this.mipmapHeights[d]=l,this.mipmapDatas[d]=t.subarray(n,n+h),n+=h,a=Math.max(a/2,1),l=Math.max(l/2,1)}}mipmaps(){return this.mipmapDatas.length}getMipmap(e,t=!1){const i=this.mipmapWidths[e],n=this.mipmapHeights[e],r=this.mipmapDatas[e];let o;return t?o=r:this.format===nt?o=Ta(r,i,n):this.format===Pt?o=Sa(r,i,n):this.format===Mt?o=Ea(r,i,n):o=xa(r,i,n),{width:i,height:n,data:o}}}function Pa(s){return s instanceof ArrayBuffer&&(s=new Uint8Array(s)),s instanceof Uint8Array&&s[0]===68&&s[1]===68&&s[2]===83&&s[3]===32}class Ma extends Ht{constructor(e,t){super(t);let i;e instanceof Hi?i=e:(i=new Hi,i.load(e));const n=this.viewer,r=n.gl,a=n.webgl.extensions.WEBGL_compressed_texture_s3tc,l=i.format;let c=0;a&&(l===nt?c=a.COMPRESSED_RGB_S3TC_DXT1_EXT:l===Pt?c=a.COMPRESSED_RGBA_S3TC_DXT3_EXT:l===Mt&&(c=a.COMPRESSED_RGBA_S3TC_DXT5_EXT));const d=r.createTexture();this.width=i.width,this.height=i.height,this.webglResource=d,r.bindTexture(r.TEXTURE_2D,d);const h=i.mipmaps();(l===nt||l===Ki)&&r.pixelStorei(r.UNPACK_ALIGNMENT,2);for(let f=0;f<h;f++){const{width:p,height:u,data:g}=i.getMipmap(f,c!==0);c?r.compressedTexImage2D(r.TEXTURE_2D,f,c,p,u,0,g):l===nt||l===Pt||l===Mt?r.texImage2D(r.TEXTURE_2D,f,r.RGBA,p,u,0,r.RGBA,r.UNSIGNED_BYTE,g):r.texImage2D(r.TEXTURE_2D,f,r.LUMINANCE_ALPHA,p,u,0,r.LUMINANCE_ALPHA,r.UNSIGNED_BYTE,g)}r.pixelStorei(r.UNPACK_ALIGNMENT,4),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),h>1?r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR_MIPMAP_LINEAR):r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR)}}const Ua={load(s){s.webgl.ensureExtension("WEBGL_compressed_texture_s3tc")||console.warn("DDS: No compressed textures support! This might reduce performance.")},isValidSource(s){return s instanceof Hi?!0:Pa(s)},resource:Ma};class $i{width=0;height=0;data=null;load(e){const t=Et(e),i=new ir;i.load(t);const n=i.header;this.width=n.width,this.height=n.height,this.data=new ImageData(n.width,n.height),i.getImageData(this.data)}}function Oa(s){return s instanceof ArrayBuffer&&(s=new Uint8Array(s)),!!(s instanceof Uint8Array&&cn(s,"TRUEVISION-XFILE.\0",s.length-18))}class Da extends Ht{constructor(e,t){super(t);let i;e instanceof $i?i=e:(i=new $i,i.load(e));const n=i.width,r=i.height,o=this.viewer.gl,a=o.createTexture();o.bindTexture(o.TEXTURE_2D,a),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,i.data),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,o.LINEAR),ct(n)&&ct(r)?(o.generateMipmap(o.TEXTURE_2D),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.LINEAR_MIPMAP_LINEAR)):o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.LINEAR),this.webglResource=a,this.width=n,this.height=r}}const Na={isValidSource(s){return s instanceof $i?!0:Oa(s)},resource:Da};function $s(s){return[...s].reverse().join("")}class I{index=null;entries=0;id=0;flags=0;load(e,t){this.index=t,this.entries=e.readUint32(),this.id=e.readUint32(),this.flags=e.readUint32()}get(){if(this.index&&this.id!==0&&this.entries!==0)return this.index[this.id].entries}first(){const e=this.get();if(e)return e[0]}}class Xs{version=-1;tag="";offset=0;entries=0;model=new I;load(e,t,i){this.version=t,this.tag=$s(e.readBinary(4)),this.offset=e.readUint32(),this.entries=e.readUint32(),this.model.load(e,i)}}class Xi{min=new Float32Array(3);max=new Float32Array(3);radius=0;load(e){e.readFloat32Array(this.min),e.readFloat32Array(this.max),this.radius=e.readFloat32()}}class Va{shape=-1;bone=-1;unknown0=0;matrix=new Float32Array(16);unknown1=0;unknown2=0;unknown3=0;unknown4=0;unknown5=0;unknown6=0;size=new Float32Array(3);load(e){this.shape=e.readUint32(),this.bone=e.readInt16(),this.unknown0=e.readUint16(),e.readFloat32Array(this.matrix),this.unknown1=e.readUint32(),this.unknown2=e.readUint32(),this.unknown3=e.readUint32(),this.unknown4=e.readUint32(),this.unknown5=e.readUint32(),this.unknown6=e.readUint32(),e.readFloat32Array(this.size)}}class Ga{version=-1;modelName=new I;flags=0;sequences=new I;stc=new I;stg=new I;unknown0=0;unknown1=0;unknown2=0;unknown3=0;sts=new I;bones=new I;numberOfBonesToCheckForSkin=0;vertexFlags=0;vertices=new I;divisions=new I;boneLookup=new I;boundings=new Xi;unknown4To20=new Uint32Array(16);attachmentPoints=new I;attachmentPointAddons=new I;ligts=new I;shbxData=new I;cameras=new I;unknown21=new I;materialReferences=new I;materials=[];particleEmitters=new I;particleEmitterCopies=new I;ribbonEmitters=new I;projections=new I;forces=new I;warps=new I;unknown22=new I;rigidBodies=new I;unknown23=new I;physicsJoints=new I;clothBehavior=new I;unknown24=new I;ikjtData=new I;unknown25=new I;unknown26=new I;partsOfTurrentBehaviors=new I;turrentBehaviors=new I;absoluteInverseBoneRestPositions=new I;tightHitTest=new Va;fuzzyHitTestObjects=new I;attachmentVolumes=new I;attachmentVolumesAddon0=new I;attachmentVolumesAddon1=new I;billboardBehaviors=new I;tmdData=new I;unknown27=0;unknown28=new I;constructor(){for(let e=0;e<11;e++)this.materials[e]=new I}load(e,t,i){this.version=t,this.modelName.load(e,i),this.flags=e.readUint32(),this.sequences.load(e,i),this.stc.load(e,i),this.stg.load(e,i),this.unknown0=e.readFloat32(),this.unknown1=e.readFloat32(),this.unknown2=e.readFloat32(),this.unknown3=e.readFloat32(),this.sts.load(e,i),this.bones.load(e,i),this.numberOfBonesToCheckForSkin=e.readUint32(),this.vertexFlags=e.readUint32(),this.vertices.load(e,i),this.divisions.load(e,i),this.boneLookup.load(e,i),this.boundings.load(e),e.readUint32Array(this.unknown4To20),this.attachmentPoints.load(e,i),this.attachmentPointAddons.load(e,i),this.ligts.load(e,i),this.shbxData.load(e,i),this.cameras.load(e,i),this.unknown21.load(e,i),this.materialReferences.load(e,i);for(let n=0;n<7;n++)this.materials[n].load(e,i);t>24&&this.materials[7].load(e,i),t>25&&this.materials[8].load(e,i),t>27&&this.materials[9].load(e,i),t>28&&this.materials[10].load(e,i),this.particleEmitters.load(e,i),this.particleEmitterCopies.load(e,i),this.ribbonEmitters.load(e,i),this.projections.load(e,i),this.forces.load(e,i),this.warps.load(e,i),this.unknown22.load(e,i),this.rigidBodies.load(e,i),this.unknown23.load(e,i),this.physicsJoints.load(e,i),t>27&&this.clothBehavior.load(e,i),this.unknown24.load(e,i),this.ikjtData.load(e,i),this.unknown25.load(e,i),t>24&&this.unknown26.load(e,i),this.partsOfTurrentBehaviors.load(e,i),this.turrentBehaviors.load(e,i),this.absoluteInverseBoneRestPositions.load(e,i),this.tightHitTest.load(e),this.fuzzyHitTestObjects.load(e,i),this.attachmentVolumes.load(e,i),this.attachmentVolumesAddon0.load(e,i),this.attachmentVolumesAddon1.load(e,i),this.billboardBehaviors.load(e,i),this.tmdData.load(e,i),this.unknown27=e.readUint32(),this.unknown28.load(e,i)}}class qa{version=-1;name=new I;interval=new Uint32Array(2);movementSpeed=0;flags=0;frequency=0;boundingSphere=new Xi;load(e,t,i){this.version=t,e.skip(8),this.name.load(e,i),e.readUint32Array(this.interval),this.movementSpeed=e.readFloat32(),this.flags=e.readUint32(),this.frequency=e.readUint32(),e.skip(12),t<2&&e.skip(4),this.boundingSphere.load(e),e.skip(12)}}class ja{version=-1;name=new I;runsConcurrent=0;priority=0;stsIndex=-1;stsIndexCopy=-1;animIds=new I;animRefs=new I;sd=[];constructor(){for(let e=0;e<13;e++)this.sd[e]=new I}load(e,t,i){this.version=t,this.name.load(e,i),this.runsConcurrent=e.readUint16(),this.priority=e.readUint16(),this.stsIndex=e.readUint16(),this.stsIndexCopy=e.readUint16(),this.animIds.load(e,i),this.animRefs.load(e,i),e.skip(4);for(let n=0;n<13;n++)this.sd[n].load(e,i)}}class Ka{version=-1;name=new I;stcIndices=new I;load(e,t,i){this.version=t,this.name.load(e,i),this.stcIndices.load(e,i)}}class Ha{version=-1;animIds=new I;load(e,t,i){this.version=t,this.animIds.load(e,i),e.skip(16)}}class st{interpolationType=0;animFlags=0;animId=-1;initValue=null;nullValue=null;load(e){this.interpolationType=e.readUint16(),this.animFlags=e.readUint16(),this.animId=e.readUint32(),this.readInitNullValues(e),e.skip(4)}}class $a extends st{readInitNullValues(e){this.initValue=e.readUint8Array(4),this.nullValue=e.readUint8Array(4)}}class Xa extends st{readInitNullValues(e){this.initValue=e.readUint16(),this.nullValue=e.readUint16()}}class Ut extends st{readInitNullValues(e){this.initValue=e.readUint32(),this.nullValue=e.readUint32()}}class Le extends st{readInitNullValues(e){this.initValue=e.readFloat32(),this.nullValue=e.readFloat32()}}class Ys extends st{readInitNullValues(e){this.initValue=e.readFloat32Array(2),this.nullValue=e.readFloat32Array(2)}}class Ot extends st{readInitNullValues(e){this.initValue=e.readFloat32Array(3),this.nullValue=e.readFloat32Array(3)}}class Ya extends st{readInitNullValues(e){this.initValue=e.readFloat32Array(4),this.nullValue=e.readFloat32Array(4)}}class za{version=-1;unknown0=0;name=new I;flags=0;parent=-1;unknown1=0;location=new Ot;rotation=new Ya;scale=new Ot;visibility=new Ut;load(e,t,i){this.version=t,this.unknown0=e.readInt32(),this.name.load(e,i),this.flags=e.readUint32(),this.parent=e.readInt16(),this.unknown1=e.readUint16(),this.location.load(e),this.rotation.load(e),this.scale.load(e),this.visibility.load(e)}}class Wa{version=-1;triangles=new I;regions=new I;batches=new I;MSEC=new I;unknown0=0;load(e,t,i){this.version=t,this.triangles.load(e,i),this.regions.load(e,i),this.batches.load(e,i),this.MSEC.load(e,i),this.unknown0=e.readUint32()}}class Za{version=-1;unknown0=0;unknown1=0;firstVertexIndex=-1;verticesCount=0;firstTriangleIndex=-1;triangleIndicesCount=0;bonesCount=0;firstBoneLookupIndex=-1;boneLookupIndicesCount=0;unknown2=0;boneWeightPairsCount=0;unknown3=0;rootBoneIndex=-1;unknown4=0;unknown5=new Uint8Array(8);load(e,t,i){this.version=t,this.unknown0=e.readUint32(),this.unknown1=e.readUint32(),this.firstVertexIndex=e.readUint32(),this.verticesCount=e.readUint32(),this.firstTriangleIndex=e.readUint32(),this.triangleIndicesCount=e.readUint32(),this.bonesCount=e.readUint16(),this.firstBoneLookupIndex=e.readUint16(),this.boneLookupIndicesCount=e.readUint16(),this.unknown2=e.readUint16(),this.boneWeightPairsCount=e.readUint8(),this.unknown3=e.readUint8(),this.rootBoneIndex=e.readUint16(),t>3&&(this.unknown4=e.readUint32()),t>4&&e.readUint8Array(this.unknown5)}}class Qa{version=-1;unknown0=0;regionIndex=-1;unknown1=0;materialReferenceIndex=-1;unknown2=0;load(e,t,i){this.version=t,this.unknown0=e.readUint32(),this.regionIndex=e.readUint16(),this.unknown1=e.readUint32(),this.materialReferenceIndex=e.readUint16(),this.unknown2=e.readUint16()}}class Ja{version=-1;materialType=0;materialIndex=-1;load(e,t,i){this.version=t,this.materialType=e.readUint32(),this.materialIndex=e.readUint32()}}class el{version=-1;name=new I;additionalFlags=0;flags=0;blendMode=0;priority=0;usedRTTChannels=0;specularity=0;depthBlendFalloff=0;cutoutThreshold=0;unknown1=0;unknown2=0;unknown3=0;specMult=0;emisMult=0;diffuseLayer=new I;decalLayer=new I;specularLayer=new I;glossLayer=new I;emissiveLayer=new I;emissive2Layer=new I;evioLayer=new I;evioMaskLayer=new I;alphaMaskLayer=new I;alphaMask2Layer=new I;normalLayer=new I;heightLayer=new I;lightMapLayer=new I;ambientOcclusionLayer=new I;unknown4=new I;unknown5=new I;unknown6=new I;unknown7=new I;unknown8=0;layerBlendType=0;emisBlendType=0;emisMode=0;specType=0;unknown9=new Le;unknown10=new Ut;unknown11=new Uint8Array(12);load(e,t,i){this.version=t,this.name.load(e,i),this.additionalFlags=e.readUint32(),this.flags=e.readUint32(),this.blendMode=e.readUint32(),this.priority=e.readInt32(),this.usedRTTChannels=e.readUint32(),this.specularity=e.readFloat32(),this.depthBlendFalloff=e.readFloat32(),this.cutoutThreshold=e.readUint8(),this.unknown1=e.readUint8(),this.unknown2=e.readUint8(),this.unknown3=e.readUint8(),this.specMult=e.readFloat32(),this.emisMult=e.readFloat32(),this.diffuseLayer.load(e,i),this.decalLayer.load(e,i),this.specularLayer.load(e,i),t>15&&this.glossLayer.load(e,i),this.emissiveLayer.load(e,i),this.emissive2Layer.load(e,i),this.evioLayer.load(e,i),this.evioMaskLayer.load(e,i),this.alphaMaskLayer.load(e,i),this.alphaMask2Layer.load(e,i),this.normalLayer.load(e,i),this.heightLayer.load(e,i),this.lightMapLayer.load(e,i),this.ambientOcclusionLayer.load(e,i),t>18&&(this.unknown4.load(e,i),this.unknown5.load(e,i),this.unknown6.load(e,i),this.unknown7.load(e,i)),this.unknown8=e.readUint32(),this.layerBlendType=e.readUint32(),this.emisBlendType=e.readUint32(),this.emisMode=e.readUint32(),this.specType=e.readUint32(),this.unknown9.load(e),this.unknown10.load(e),t>18&&(this.unknown11=e.readUint8Array(this.unknown11))}}class tl{version=-1;unknown0=0;imagePath=new I;color=new $a;flags=0;uvSource=-1;colorChannelSetting=0;brightMult=new Le;midtoneOffset=new Le;unknown1=0;noiseAmp=0;noiseFreq=0;rttChannel=0;videoFrameRate=0;videoStartFrame=0;videoEndFrame=0;videoMode=0;videoSyncTiming=0;videoPlay=new Ut;videoRestart=new Ut;flipBookRows=0;flipBookColumns=0;flipBookFrame=new Xa;uvOffset=new Ys;uvAngle=new Ot;uvTiling=new Ys;unknown2=new Ut;unknown3=new Le;brightness=new Le;triPlanarOffset=new Ot;triPlanarScale=new Ot;unknown4=0;fresnelType=0;fresnelExponent=0;fresnelMin=0;fresnelMaxOffset=0;unknown5=0;unknown6=new Uint8Array(8);fresnelInvertedMaskX=0;fresnelInvertedMaskY=0;fresnelInvertedMaskZ=0;fresnelRotationYaw=0;fresnelRotationPitch=0;unknown7=0;load(e,t,i){this.version=t,this.unknown0=e.readUint32(),this.imagePath.load(e,i),this.color.load(e),this.flags=e.readUint32(),this.uvSource=e.readUint32(),this.colorChannelSetting=e.readUint32(),this.brightMult.load(e),this.midtoneOffset.load(e),this.unknown1=e.readUint32(),t>23&&(this.noiseAmp=e.readFloat32(),this.noiseFreq=e.readFloat32()),this.rttChannel=e.readInt32(),this.videoFrameRate=e.readUint32(),this.videoStartFrame=e.readUint32(),this.videoEndFrame=e.readInt32(),this.videoMode=e.readUint32(),this.videoSyncTiming=e.readUint32(),this.videoPlay.load(e),this.videoRestart.load(e),this.flipBookRows=e.readUint32(),this.flipBookColumns=e.readUint32(),this.flipBookFrame.load(e),this.uvOffset.load(e),this.uvAngle.load(e),this.uvTiling.load(e),this.unknown2.load(e),this.unknown3.load(e),this.brightness.load(e),t>23&&(this.triPlanarOffset.load(e),this.triPlanarScale.load(e)),this.unknown4=e.readInt32(),this.fresnelType=e.readUint32(),this.fresnelExponent=e.readFloat32(),this.fresnelMin=e.readFloat32(),this.fresnelMaxOffset=e.readFloat32(),this.unknown5=e.readFloat32(),t>24&&(this.unknown6=e.readUint8Array(8),this.fresnelInvertedMaskX=e.readFloat32(),this.fresnelInvertedMaskY=e.readFloat32(),this.fresnelInvertedMaskZ=e.readFloat32(),this.fresnelRotationYaw=e.readFloat32(),this.fresnelRotationPitch=e.readFloat32(),this.unknown7=e.readUint32())}}class il{version=-1;name=new I;unknown0=0;unknown1=0;unknown2=0;matrix=new Float32Array(16);unknown3=0;unknown4=0;unknown5=0;unknown6=0;unknown7=0;unknown8=0;load(e,t,i){this.version=t,this.name.load(e,i),this.unknown0=e.readInt32(),this.unknown1=e.readInt16(),this.unknown2=e.readUint16(),e.readFloat32Array(this.matrix),this.unknown3=e.readInt32(),this.unknown4=e.readInt32(),this.unknown5=e.readInt32(),t>0&&(this.unknown6=e.readInt32(),this.unknown7=e.readInt32()),t>1&&(this.unknown8=e.readInt32())}}class nl{version=-1;unknown=0;name=new I;bone=-1;load(e,t,i){this.version=t,this.unknown=e.readInt32(),this.name.load(e,i),this.bone=e.readUint32()}}class sl{version=-1;bone=-1;name=new I;fieldOfView=new Le;unknown0=0;farClip=new Le;nearClip=new Le;clip2=new Le;focalDepth=new Le;falloffStart=new Le;falloffEnd=new Le;depthOfField=new Le;load(e,t,i){this.version=t,this.bone=e.readUint32(),this.name.load(e,i),this.fieldOfView.load(e),this.unknown0=e.readUint32(),this.farClip.load(e),this.nearClip.load(e),this.clip2.load(e),this.focalDepth.load(e),this.falloffStart.load(e),this.falloffEnd.load(e),this.depthOfField.load(e)}}class Pe{version=-1;keys=new I;flags=0;biggestKey=-1;values=new I;load(e,t,i){this.version=t,this.keys.load(e,i),this.flags=e.readUint32(),this.biggestKey=e.readUint32(),this.values.load(e,i)}}class K{stream;version;index;constructor(e,t,i){this.stream=e,this.version=t,this.index=i}}const rl={MD34:[Xs,{11:24}],MODL:[Ga,{23:784,25:808,26:820,28:844,29:856}],SEQS:[qa,{1:96,2:92}],STC_:[ja,{4:204}],STG_:[Ka,{0:24}],STS_:[Ha,{0:28}],BONE:[za,{1:160}],DIV_:[Wa,{2:52}],REGN:[Za,{3:36,4:40,5:48}],BAT_:[Qa,{1:14}],MATM:[Ja,{0:8}],MAT_:[el,{15:268,16:280,17:280,18:280,19:340}],LAYR:[tl,{22:356,24:436,25:468,26:464}],EVNT:[il,{0:96,1:104,2:108}],BNDS:[Xi,{0:28}],ATT_:[nl,{1:20}],CAM_:[sl,{3:180,5:264}],SDEV:[Pe,{0:32}],SDU6:[Pe,{0:32}],SDFG:[Pe,{0:32}],SDS6:[Pe,{0:32}],SDR3:[Pe,{0:32}],SD2V:[Pe,{0:32}],SD3V:[Pe,{0:32}],SD4Q:[Pe,{0:32}],SDCC:[Pe,{0:32}],SDMB:[Pe,{0:32}],FLAG:[Pe,{0:32}],MSEC:[K,{1:72}],LITE:[K,{7:212}],ATVL:[K,{0:116}],PATU:[K,{4:152}],TRGD:[K,{0:24}],DIS_:[K,{4:68}],CMS_:[K,{0:24}],CMP_:[K,{2:28}],TER_:[K,{0:24,1:28}],VOL_:[K,{0:84}],VON_:[K,{0:268}],CREP:[K,{0:24,1:28}],STBM:[K,{0:48}],LFSB:[K,{2:56}],LFLR:[K,{2:80,3:152}],PAR_:[K,{12:1316,17:1460,18:1464,19:1464,21:1464,22:1484,23:1492,24:1496}],PARC:[K,{0:40}],PROJ:[K,{4:388,5:382}],PHYJ:[K,{0:180}],PHCC:[K,{0:76}],PHAC:[K,{0:32}],PHCL:[K,{2:128}],FOR_:[K,{1:104,2:104}],DMSE:[K,{0:4}],PHSH:[K,{1:132,3:300}],PHRB:[K,{2:104,4:80}],SSGS:[K,{1:108}],BBSC:[K,{0:48}],SRIB:[K,{0:272}],RIB_:[K,{6:748,8:756,9:760}],IKJT:[K,{0:32}],SHBX:[K,{0:64}],WRP_:[K,{1:132}]};class ol{index;tag;offset;version;entries;constructor(e,t){const i=$s(e.readBinary(4)),n=e.readUint32(),r=e.readUint32(),o=e.readUint32();this.index=t,this.tag=i,this.offset=n,this.version=o;const a=rl[i],l=e.index;if(e.seek(n),a){const c=a[0],d=a[1][o];if(!d)throw new Error(": Unsupported object version - tag "+i+" and version "+o);this.entries=[];for(let h=0,f=r;h<f;h++)if(c===K)this.entries[h]=new K(e.substream(d),o,t);else{const p=new c;p.load(e.substream(d),o,t),this.entries[h]=p}}else if(i==="CHAR"||i==="SCHR")this.entries=e.read(r);else if(i==="U8__")this.entries=e.readUint8Array(r);else if(i==="U16_")this.entries=e.readUint16Array(r);else if(i==="U32_")this.entries=e.readUint32Array(r);else if(i==="I16_")this.entries=e.readInt16Array(r);else if(i==="I32_")this.entries=e.readInt32Array(r);else if(i==="REAL")this.entries=e.readFloat32Array(r);else if(i==="VEC2"){this.entries=[];for(let c=0;c<r;c++)this.entries[c]=e.readFloat32Array(2)}else if(i==="VEC3"||i==="SVC3"){this.entries=[];for(let c=0;c<r;c++)this.entries[c]=e.readFloat32Array(3)}else if(i==="VEC4"||i==="QUAT"){this.entries=[];for(let c=0;c<r;c++)this.entries[c]=e.readFloat32Array(4)}else if(i==="IREF"){this.entries=[];for(let c=0;c<r;c++)this.entries[c]=e.readFloat32Array(16)}else throw this.entries=[],new Error(": Unsupported object tag - tag "+i+" and version "+o);e.seek(l)}}class Yi{index=[];model=null;load(e){const t=new xt(e),i=new Xs;if(i.load(t,11,this.index),i.tag!=="MD34")throw new Error("WrongMagicNumber");t.seek(i.offset);for(let r=0,o=i.entries;r<o;r++)this.index[r]=new ol(t,this.index);const n=this.index[i.model.id].entries;n&&(this.model=n[0])}}function al(s){return s instanceof ArrayBuffer&&(s=new Uint8Array(s)),s instanceof Uint8Array&&s[0]===52&&s[1]===51&&s[2]===68&&s[3]===77}class ll{texture=null;wrapS=33071;wrapT=33071;constructor(e,t){e&&(this.wrapS=10497),t&&(this.wrapT=10497)}}const cl={diffuse:1,decal:2,specular:3,gloss:4,emissive:5,emissive2:6,evio:7,evioMask:8,alphaMask:9,alphaMask2:10,normal:11,heightMap:12,lightMap:13,ao:14};class Se{model;material;index;active=0;layer=null;gl;uniformMap;source="";texture=null;flags=0;colorChannels=0;type="";op=0;uvCoordinate=0;textureUnit=0;invert=0;clampResult=0;teamColorMode=0;constructor(e,t,i,n,r){const o=e.model;this.model=o,this.material=e,this.gl=e.gl,this.index=t;const a="u_"+n,l=a+"LayerSettings.";if(this.uniformMap={map:a+"Map",enabled:l+"enabled",op:l+"op",channels:l+"channels",teamColorMode:l+"teamColorMode",invert:l+"invert",clampResult:l+"clampResult",uvCoordinate:l+"uvCoordinate"},i.entries){const c=i.first();this.layer=c;const d=o.pathSolver,h=c.imagePath.get();if(h){const f=h.toLowerCase();if(f.length){this.source=f,this.active=1;const p=c.uvSource,u=c.flags;this.flags=u,this.colorChannels=c.colorChannelSetting,this.model=o,this.type=n,this.op=r;let g=0;p===1?g=1:p===9?g=2:p===10&&(g=3),this.uvCoordinate=g,this.textureUnit=cl[n],this.invert=u&16,this.clampResult=u&32,n==="diffuse"&&(this.teamColorMode=1);const v=new ll(!!(u&4),!!(u&8));o.viewer.load(f,d).then(w=>{w&&(v.texture=w)}),this.texture=v}}}}bind(e,t){const i=this.gl,n=this.uniformMap,r=e.uniforms,o=this.active;if(i.uniform1f(r[n.enabled],o),o){const a=this.texture,l=t.get(this.material.index*zs+this.index)||a.texture,c=this.textureUnit;i.uniform1i(r[n.map],c),this.model.viewer.webgl.bindTextureAndWrap(l,c,a.wrapS,a.wrapT),i.uniform1f(r[n.op],this.op),i.uniform1f(r[n.channels],this.colorChannels),i.uniform1f(r[n.teamColorMode],this.teamColorMode),i.uniform1f(r[n.invert],this.invert),i.uniform1f(r[n.clampResult],this.clampResult),i.uniform1f(r[n.uvCoordinate],this.uvCoordinate)}}unbind(e){this.active&&this.gl.uniform1f(e.uniforms[this.uniformMap.enabled],0)}}const zs=100;class hl{model;gl;index;name;flags;blendMode;priority;specularity;specMult;emisMult;layerBlendType;emisBlendType;emisMode;doubleSided;layers;constructor(e,t,i){this.model=e,this.gl=e.viewer.gl,this.index=t,this.name=i.name.get(),this.flags=i.flags,this.blendMode=i.blendMode,this.priority=i.priority,this.specularity=i.specularity,this.specMult=i.specMult,this.emisMult=i.emisMult,this.layerBlendType=i.layerBlendType,this.emisBlendType=i.emisBlendType,this.emisMode=i.emisMode,this.doubleSided=i.flags&8,this.layers=[new Se(this,0,i.diffuseLayer,"diffuse",2),new Se(this,1,i.decalLayer,"decal",2),new Se(this,2,i.specularLayer,"specular",2),new Se(this,3,i.glossLayer,"gloss",2),new Se(this,4,i.emissiveLayer,"emissive",i.emisBlendType),new Se(this,5,i.emissive2Layer,"emissive2",i.emisMode),new Se(this,6,i.evioLayer,"evio",2),new Se(this,7,i.evioMaskLayer,"evioMask",2),new Se(this,8,i.alphaMaskLayer,"alphaMask",2),new Se(this,9,i.alphaMask2Layer,"alphaMask2",2),new Se(this,10,i.normalLayer,"normal",2),new Se(this,11,i.heightLayer,"heightMap",2),new Se(this,12,i.lightMapLayer,"lightMap",2),new Se(this,13,i.ambientOcclusionLayer,"ao",2)]}bindCommon(){const e=this.gl;this.blendMode===1||this.blendMode===2?(e.enable(e.BLEND),e.blendFunc(e.ONE,e.ONE)):e.disable(e.BLEND),this.doubleSided?e.disable(e.CULL_FACE):e.enable(e.CULL_FACE),e.enable(e.DEPTH_TEST),e.depthMask(!0)}bind(e,t){const i=this.gl;this.bindCommon(),i.uniform1f(e.uniforms.u_specularity,this.specularity),i.uniform1f(e.uniforms.u_specMult,this.specMult),i.uniform1f(e.uniforms.u_emisMult,this.emisMult),i.uniform4f(e.uniforms.u_lightAmbient,.02,.02,.02,0);const n=this.layers;n[0].bind(e,t),n[1].bind(e,t),n[2].bind(e,t),n[4].bind(e,t),n[5].bind(e,t),n[10].bind(e,t),n[12].bind(e,t)}unbind(e){const t=this.gl;t.disable(t.BLEND),t.enable(t.CULL_FACE);const i=this.layers;i[0].unbind(e),i[1].unbind(e),i[2].unbind(e),i[4].unbind(e),i[5].unbind(e),i[10].unbind(e),i[12].unbind(e)}}class dl{name;parent;location;rotation;scale;visibility;inhertTranslation;inheritScale;inheritRotation;billboard1;billboard2;twoDProjection;animated;inverseKinematics;skinned;real;constructor(e){const t=e.flags;this.name=e.name.get(),this.parent=e.parent,this.location=e.location,this.rotation=e.rotation,this.scale=e.scale,this.visibility=e.visibility,this.inhertTranslation=t&1,this.inheritScale=t&2,this.inheritRotation=t&4,this.billboard1=t&16,this.billboard2=t&64,this.twoDProjection=t&256,this.animated=t&512,this.inverseKinematics=t&1024,this.skinned=t&2048,this.real=t&8192}}class ul{name;interval;movementSpeed;frequency;boundingSphere;flags;constructor(e){this.name=e.name.get(),this.interval=e.interval,this.movementSpeed=e.movementSpeed,this.frequency=e.frequency,this.boundingSphere=e.boundingSphere,this.flags=e.flags}}class fl{animIds=new Map;constructor(e){const t=e.animIds.get();for(let i=0,n=t.length;i<n;i++)this.animIds.set(t[i],i)}hasData(e){return this.animIds.has(e.animId)}}const Ws=m.vec3.create(),Zs=m.quat.create();class pl{keys;values;biggestKey;constructor(e){this.keys=e.keys.get(),this.values=e.values.get(),this.biggestKey=e.biggestKey}}class ml{sd=[];addSds(e){for(const t of e)this.sd.push(new pl(t))}getValueUnsafe(e,t,i,n){const r=this.sd[e];n&&(i=i%r.biggestKey);const o=r.keys,a=r.values;let l=o.length,c=0;for(;c!==o.length&&i>o[c];)l=c,c++;const d=o.length;if(l===d)return c===d?t.initValue:a[c];if(c===d||l>=c)return a[l];const h=Er((i-o[l])/(o[c]-o[l]),0,1),f=a[l],p=a[c],u=t.interpolationType,g=f;return g.length===4?u===0?m.quat.copy(Zs,f):m.quat.slerp(Zs,f,p,h):g.length===3?u===0?m.vec3.copy(Ws,f):m.vec3.lerp(Ws,f,p,h):u===0?f:on(f,p,h)}}class gl{name;runsConcurrent;priority;stsIndex;animRefs=[];sd=[];constructor(e){const t=e.animIds.get();this.name=e.name.get(),this.runsConcurrent=e.runsConcurrent,this.priority=e.priority,this.stsIndex=e.stsIndex;const i=e.animRefs.get(),n=new Uint16Array(i.buffer);for(let r=0,o=t.length;r<o;r++)this.animRefs[t[r]]=[n[r*2+1],n[r*2]];for(const r of e.sd){const o=new ml,a=r.get();a&&o.addSds(a),this.sd.push(o)}}getValueUnsafe(e,t){const i=this.animRefs[e.animId];return i?this.sd[i[0]].getValueUnsafe(i[1],e,t.frame,this.runsConcurrent):e.initValue}}class vl{name;stcIndices;sts;stc;constructor(e,t,i){this.name=e.name.get(),this.stcIndices=e.stcIndices.get(),this.sts=t,this.stc=i}getValueUnsafe(e,t){const i=this.stcIndices,n=this.stc,r=this.sts;for(let o=0,a=i.length;o<a;o++){const l=n[i[o]];if(r[l.stsIndex].hasData(e))return l.getValueUnsafe(e,t)}return e.initValue}}class bl{name;bone;constructor(e){this.name=e.name.get(),this.bone=e.bone}}class wl{bone;name;constructor(e){this.bone=e.bone,this.name=e.name.get()}}class yl{gl;firstBoneLookupIndex;boneWeightPairsCount;offset;verticesCount;elements;constructor(e,t,i,n,r){const o=t.firstVertexIndex,a=t.triangleIndicesCount,l=t.firstTriangleIndex;for(let c=0;c<a;c++)n[r+c]=i[l+c]+o;this.gl=e.viewer.gl,this.firstBoneLookupIndex=t.firstBoneLookupIndex,this.boneWeightPairsCount=t.boneWeightPairsCount,this.offset=r*2,this.verticesCount=t.verticesCount,this.elements=a}render(e){const t=this.gl;t.uniform1f(e.uniforms.u_firstBoneLookupIndex,this.firstBoneLookupIndex),t.uniform1f(e.uniforms.u_boneWeightPairsCount,this.boneWeightPairsCount),t.drawElements(t.TRIANGLES,this.elements,t.UNSIGNED_SHORT,this.offset)}}class Al extends Ui{convertBasis(e){const t=Math.PI/2;m.quat.rotateZ(e,e,t),m.quat.rotateY(e,e,-t)}}class Tl{nodes;worldMatrices;instance;modelNodes;initialReference;sts;stc;stg;boneLookup;constructor(e){const t=e.model,i=t.bones,n=t.boneLookup,r=ys(i.length,Al),o=r.nodes;this.nodes=o,this.worldMatrices=r.worldMatrices,this.instance=e,this.modelNodes=i,this.initialReference=t.initialReference,this.sts=t.sts,this.stc=t.stc,this.stg=t.stg,this.boneLookup=n;for(let a=0,l=i.length;a<l;a++){const c=i[a];c.parent===-1?o[a].parent=e:o[a].parent=o[c.parent],c.billboard1&&(o[a].billboarded=!0)}}update(e){const t=this.instance,i=this.nodes,n=this.modelNodes;for(let r=0,o=i.length;r<o;r++){const a=i[r],l=n[r];this.getValue4(a.localRotation,l.rotation,t),this.getValue3(a.localLocation,l.location,t),this.getValue3(a.localScale,l.scale,t),a.recalculateTransformation(t);for(const c of a.children)c.recalculateTransformation(),c.update(e)}}getValueUnsafe(e,t){const i=t.sequence;return i!==-1?this.stg[i].getValueUnsafe(e,t):e.initValue}getValue(e,t){return this.getValueUnsafe(e,t)}getValue2(e,t,i){const n=this.getValueUnsafe(t,i);return e[0]=n[0],e[1]=n[1],e}getValue3(e,t,i){const n=this.getValueUnsafe(t,i);return e[0]=n[0],e[1]=n[1],e[2]=n[2],e}getValue4(e,t,i){const n=this.getValueUnsafe(t,i);return e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e}}const Qs=m.mat4.create();class Sl extends ws{skeleton=null;teamColor=0;vertexColor=new Float32Array([1,1,1,1]);sequence=-1;frame=0;sequenceLoopMode=0;sequenceEnded=!1;forced=!0;boneTexture=null;constructor(e){super(e),this.skeleton=new Tl(this),this.sequence!==-1&&this.setSequence(this.sequence),this.boneTexture=new pi(e.viewer.gl,3,e.boneLookup.length*4,1)}setTexture(e,t,i){this.overrideTexture(e*zs+t,i)}updateSkeletonAndBoneTexture(e){const t=this.model,n=t.viewer.buffer,r=t.boneLookup,o=this.skeleton,a=o.nodes,l=t.initialReference,c=r.length,d=this.sequence!==-1,h=this.boneTexture;o.update(e),n.reserve(c*48);const f=n.floatView;let p;d?p=Qs:p=this.worldMatrix;for(let u=0;u<c;u++){const g=u*12;if(d){const v=r[u];p=m.mat4.mul(Qs,a[v].worldMatrix,l[v])}f[g+0]=p[0],f[g+1]=p[1],f[g+2]=p[2],f[g+3]=p[4],f[g+4]=p[5],f[g+5]=p[6],f[g+6]=p[8],f[g+7]=p[9],f[g+8]=p[10],f[g+9]=p[12],f[g+10]=p[13],f[g+11]=p[14]}h.bindAndUpdate(f,h.width,1)}renderOpaque(){const e=this.model,t=e.batches;if(t.length){const i=e.viewer,n=i.sharedCache.get("m3"),r=i.gl,o=e.vertexSize,a=e.uvSetCount,l=n.standardShaders[a-1],c=l.attribs,d=l.uniforms,h=this.scene,f=h.camera,p=this.textureOverrides,u=this.boneTexture;l.use(),r.uniform1f(d.u_teamColor,this.teamColor),r.uniform4fv(d.u_vertexColor,this.vertexColor),r.uniformMatrix4fv(d.u_VP,!1,f.viewProjectionMatrix),r.uniformMatrix4fv(d.u_MV,!1,f.viewMatrix),r.uniform3fv(d.u_eyePos,f.location),r.uniform3fv(d.u_lightPos,h.lightPosition),u.bind(15),r.uniform1i(d.u_boneMap,15),r.uniform1f(d.u_vectorSize,1/u.width),r.uniform1f(d.u_rowSize,1),r.bindBuffer(r.ARRAY_BUFFER,e.arrayBuffer),r.vertexAttribPointer(c.a_position,3,r.FLOAT,!1,o,0),r.vertexAttribPointer(c.a_weights,4,r.UNSIGNED_BYTE,!1,o,12),r.vertexAttribPointer(c.a_bones,4,r.UNSIGNED_BYTE,!1,o,16),r.vertexAttribPointer(c.a_normal,4,r.UNSIGNED_BYTE,!1,o,20);for(let g=0;g<a;g++)r.vertexAttribPointer(c[`a_uv${g}`],2,r.SHORT,!1,o,24+g*4);r.vertexAttribPointer(c.a_tangent,4,r.UNSIGNED_BYTE,!1,o,24+a*4),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,e.elementBuffer);for(const g of t){const v=g.material,w=g.region;v.bind(l,p),w.render(l),v.unbind(l)}}}updateAnimations(e){const t=this.sequence;if(t!==-1){const n=this.model.sequences[t],r=n.interval;this.frame+=e*1e3,this.frame>r[1]?(this.sequenceLoopMode===0&&!(n.flags&1)||this.sequenceLoopMode===2?this.frame=r[0]:this.frame=r[1],this.sequenceEnded=!0):this.sequenceEnded=!1}(this.forced||t!==-1)&&(this.forced=!1,this.updateSkeletonAndBoneTexture(e))}setTeamColor(e){return this.teamColor=e,this}setVertexColor(e){return this.vertexColor.set(e),this}setSequence(e){const t=this.model;return this.sequence=e,this.frame=0,(e<-1||e>t.sequences.length-1)&&(e=-1,this.sequence=e),this.forced=!0,this}setSequenceLoopMode(e){return this.sequenceLoopMode=e,this}getAttachment(e){const i=this.model.attachments[e];if(i)return this.skeleton.nodes[i.bone]}}class El{region;material;constructor(e,t){this.region=e,this.material=t}}class xl extends Wn{name="";batches=[];materials=[[],[]];materialMaps=[];bones=[];boneLookup;sequences=[];sts=[];stc=[];stg=[];attachments=[];cameras=[];regions=[];initialReference=[];elementBuffer=null;arrayBuffer=null;vertexSize=0;uvSetCount=0;constructor(e,t){super(t);let i;e instanceof Yi?i=e:(i=new Yi,i.load(e));const n=i.model,r=n.divisions.first();this.name=n.modelName.get(),this.setupGeometry(n,r);const o=n.materialReferences.get();this.materialMaps=o;const a=n.materials[0].get();for(let u=0,g=a.length;u<g;u++)this.materials[1].push(new hl(this,u,a[u]));for(const u of r.batches.get()){const g=u.regionIndex,v=o[u.materialReferenceIndex];v.materialType===1&&this.batches.push(new El(this.regions[g],this.materials[1][v.materialIndex]))}this.initialReference=n.absoluteInverseBoneRestPositions.get();for(const u of n.bones.get())this.bones.push(new dl(u));this.boneLookup=n.boneLookup.get();const l=n.sequences.get();if(l)for(const u of l)this.sequences.push(new ul(u));const c=n.sts.get();if(c)for(const u of c)this.sts.push(new fl(u));const d=n.stc.get();if(d)for(const u of d)this.stc.push(new gl(u));const h=n.stg.get();if(h)for(const u of h)this.stg.push(new vl(u,this.sts,this.stc));this.addGlobalAnims();const f=n.attachmentPoints.get();if(f)for(const u of f)this.attachments.push(new bl(u));const p=n.cameras.get();if(p)for(const u of p)this.cameras.push(new wl(u))}addInstance(){return new Sl(this)}setupGeometry(e,t){const i=this.viewer.gl;let n=1;const r=e.vertexFlags;r&262144?n=2:r&524288?n=3:r&1048576&&(n=4);const o=t.regions.get();let a=0;const l=[];for(let p=0,u=o.length;p<u;p++)l[p]=a,a+=o[p].triangleIndicesCount;const c=new Uint16Array(a),d=t.triangles.get();for(let p=0,u=o.length;p<u;p++)this.regions.push(new yl(this,o[p],d,c,l[p]));const h=e.vertices.get();this.elementBuffer=i.createBuffer(),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this.elementBuffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,c,i.STATIC_DRAW);const f=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,f),i.bufferData(i.ARRAY_BUFFER,h,i.STATIC_DRAW),this.arrayBuffer=f,this.vertexSize=(7+n)*4,this.uvSetCount=n}mapMaterial(e){const t=this.materialMaps[e];return this.materials[1][t.materialIndex]}addGlobalAnims(){}}const _l=`
uniform mat4 u_VP;
uniform mat4 u_MV;
uniform vec3 u_eyePos;
uniform vec3 u_lightPos;
uniform float u_firstBoneLookupIndex;
uniform float u_boneWeightPairsCount;
uniform vec3 u_teamColors[14];
uniform float u_teamColor;
uniform vec4 u_vertexColor;

attribute vec3 a_position;
attribute vec4 a_normal;
attribute vec2 a_uv0;

#ifdef EXPLICITUV1
attribute vec2 a_uv1;
#endif
#ifdef EXPLICITUV2
attribute vec2 a_uv1, a_uv2;
#endif
#ifdef EXPLICITUV3
attribute vec2 a_uv1, a_uv2, a_uv3;
#endif

attribute vec4 a_tangent;
attribute vec4 a_bones;
attribute vec4 a_weights;

varying vec3 v_normal;
varying vec4 v_uv[2]; // Pack 4 vec2 in 2 vec4, to reduce the varyings count
varying vec3 v_lightDir;
// varying vec3 v_eyeVec;
varying vec3 v_halfVec;
varying vec3 v_teamColor;
varying vec4 v_vertexColor;

${Gi}

vec3 TBN(vec3 vector, vec3 tangent, vec3 binormal, vec3 normal) {
  return vec3(dot(vector, tangent), dot(vector, binormal), dot(vector, normal));
}

vec4 decodeVector(vec4 v) {
  return ((v / 255.0) * 2.0) - 1.0;
}

void transform(inout vec3 position, inout vec3 normal, inout vec3 tangent, inout vec3 binormal, vec4 bones, vec4 weights) {
  if (u_boneWeightPairsCount > 0.0) {
    mat4 bone;

    if (u_boneWeightPairsCount == 1.0) {
      bone = fetchMatrix(bones[0], 0.0);
    } else {
      bone += fetchMatrix(bones[0], 0.0) * weights[0];
      bone += fetchMatrix(bones[1], 0.0) * weights[1];
      bone += fetchMatrix(bones[2], 0.0) * weights[2];
      bone += fetchMatrix(bones[3], 0.0) * weights[3];
    }

    position = vec3(bone * vec4(position, 1.0));
    normal = mat3(bone) * normal;
    tangent = vec3(bone * vec4(tangent, 0.0));
    binormal = vec3(bone * vec4(binormal, 0.0));
  }
}

void main() {
  vec4 decodedNormal = decodeVector(a_normal);

  vec3 position = a_position;
  vec3 normal = decodedNormal.xyz;
  vec3 tangent = vec3(decodeVector(a_tangent));
  vec3 binormal = cross(normal, tangent) * decodedNormal.w;

  transform(position, normal, tangent, binormal, a_bones + u_firstBoneLookupIndex, a_weights / 255.0);

  vec3 position_mv = vec3(u_MV * vec4(position, 1));

  mat3 mv = mat3(u_MV);
  vec3 t = normalize(mv * tangent);
  vec3 b = normalize(mv * binormal);
  vec3 n = normalize(mv * normal);

  vec3 lightDir = normalize(u_lightPos - position_mv);

  v_lightDir = normalize(TBN(lightDir, t, b, n));

  vec3 eyeVec = normalize(u_eyePos - position_mv);
  vec3 halfVec = normalize(eyeVec - u_lightPos);

  // v_eyeVec = TBN(eyeVec, t, b, n);
  v_halfVec = TBN(halfVec, t, b, n);

  v_normal = n;

  vec4 uv0, uv1;

  uv0.xy = a_uv0 / 2048.0;

  #ifdef EXPLICITUV1
  uv0.zw = a_uv1 / 2048.0;
  #endif

  #ifdef EXPLICITUV2
  uv0.zw = a_uv1 / 2048.0;
  uv1.xy = a_uv2 / 2048.0;
  #endif

  #ifdef EXPLICITUV3
  uv0.zw = a_uv1 / 2048.0;
  uv1.xy = a_uv2 / 2048.0;
  uv1.zw = a_uv3 / 2048.0;
  #endif

  v_uv[0] = uv0;
  v_uv[1] = uv1;

  v_teamColor = u_teamColors[int(u_teamColor)];
  v_vertexColor = u_vertexColor;

  gl_Position = u_VP * vec4(position, 1.0);
}
`,Il=`
${ti}


varying vec3 v_normal;
varying vec4 v_uv[2];
varying vec3 v_lightDir;
// varying vec3 v_eyeVec;
varying vec3 v_halfVec;
varying vec3 v_teamColor;
varying vec4 v_vertexColor;

struct LayerSettings {
  bool enabled;
  float op;
  float channels;
  float teamColorMode;
  // vec3 multAddAlpha;
  // bool useAlphaFactor;
  bool invert;
  // bool multColor;
  // bool addColor;
  bool clampResult;
  // bool useConstantColor;
  // vec4 constantColor;
  // float uvSource;
  float uvCoordinate;
  // float fresnelMode;
  // float fresnelTransformMode;
  // mat4 fresnelTransform;
  // bool fresnelClamp;
  // vec3 fresnelExponentBiasScale;
};

uniform float u_specularity;
uniform float u_specMult;
uniform float u_emisMult;
uniform vec4 u_lightAmbient;

uniform LayerSettings u_diffuseLayerSettings;
uniform sampler2D u_diffuseMap;
uniform LayerSettings u_decalLayerSettings;
uniform sampler2D u_decalMap;
uniform LayerSettings u_specularLayerSettings;
uniform sampler2D u_specularMap;
uniform LayerSettings u_glossLayerSettings;
uniform sampler2D u_glossMap;
uniform LayerSettings u_emissiveLayerSettings;
uniform sampler2D u_emissiveMap;
uniform LayerSettings u_emissive2LayerSettings;
uniform sampler2D u_emissive2Map;
uniform LayerSettings u_evioLayerSettings;
uniform sampler2D u_evioMap;
uniform LayerSettings u_evioMaskLayerSettings;
uniform sampler2D u_evioMaskMap;
uniform LayerSettings u_alphaLayerSettings;
uniform sampler2D u_alphaMap;
uniform LayerSettings u_alphaMaskLayerSettings;
uniform sampler2D u_alphaMaskMap;
uniform LayerSettings u_normalLayerSettings;
uniform sampler2D u_normalMap;
uniform LayerSettings u_heightLayerSettings;
uniform sampler2D u_heightMap;
uniform LayerSettings u_lightMapLayerSettings;
uniform sampler2D u_lightMapMap;
uniform LayerSettings u_aoLayerSettings;
uniform sampler2D u_aoMap;

#define SPECULAR_RGB 0.0
#define SPECULAR_A_ONLY 1.0

#define FRESNELMODE_NONE 0.0
#define FRESNELMODE_STANDARD 1.0
#define FRESNELMODE_INVERTED 2.0

#define FRESNELTRANSFORM_NONE 0.0
#define FRESNELTRANSFORM_SIMPLE 1.0
#define FRESNELTRANSFORM_NORMALIZED 2.0

#define UVMAP_EXPLICITUV0 0.0
#define UVMAP_EXPLICITUV1 1.0
#define UVMAP_REFLECT_CUBICENVIO 2.0
#define UVMAP_REFLECT_SPHERICALENVIO 3.0
#define UVMAP_PLANARLOCALZ 4.0
#define UVMAP_PLANARWORLDZ 5.0
#define UVMAP_PARTICLE_FLIPBOOK 6.0
#define UVMAP_CUBICENVIO 7.0
#define UVMAP_SPHERICALENVIO 8.0
#define UVMAP_EXPLICITUV2 9.0
#define UVMAP_EXPLICITUV3 10.0
#define UVMAP_PLANARLOCALX 11.0
#define UVMAP_PLANARLOCALY 12.0
#define UVMAP_PLANARWORLDX 13.0
#define UVMAP_PLANARWORLDY 14.0
#define UVMAP_SCREENSPACE 15.0
#define UVMAP_TRIPLANAR_LOCAL 16.0
#define UVMAP_TRIPLANAR_WORLD 17.0
#define UVMAP_TRIPLANAR_WORLD_LOCAL_Z 18.0

#define CHANNELSELECT_RGB 0.0
#define CHANNELSELECT_RGBA 1.0
#define CHANNELSELECT_A 2.0
#define CHANNELSELECT_R 3.0
#define CHANNELSELECT_G 4.0
#define CHANNELSELECT_B 5.0

#define TEAMCOLOR_NONE 0.0
#define TEAMCOLOR_DIFFUSE 1.0
#define TEAMCOLOR_EMISSIVE 2.0

#define LAYEROP_MOD 0.0
#define LAYEROP_MOD2X 1.0
#define LAYEROP_ADD 2.0
#define LAYEROP_LERP 3.0
#define LAYEROP_TEAMCOLOR_EMISSIVE_ADD 4.0
#define LAYEROP_TEAMCOLOR_DIFFUSE_ADD 5.0
#define LAYEROP_ADD_NO_ALPHA 6.0

// float calculateFresnelTerm(vec3 normal, vec3 eyeToVertex, float exponent, mat4 fresnelTransform, float fresnelTransformMode, bool fresnelClamp) {
//   vec3 fresnelDir = eyeToVertex;
//   float result;

//   if (fresnelTransformMode != FRESNELTRANSFORM_NONE) {
//     fresnelDir = (fresnelTransform * vec4(fresnelDir, 1.0)).xyz;

//     if (fresnelTransformMode == FRESNELTRANSFORM_NORMALIZED) {
//       fresnelDir = normalize(fresnelDir);
//     }
//   }

//   if (fresnelClamp) {
//     result = 1.0 - clamp(-dot(normal, fresnelDir), 0.0, 1.0);
//   } else {
//     result = 1.0 - abs(dot(normal, fresnelDir));
//   }

//   result = max(result, 0.0000001);

//   return pow(result, exponent);
// }

vec3 combineLayerColor(vec4 color, vec3 result, LayerSettings layerSettings) {
  if (layerSettings.op == LAYEROP_MOD) {
    result *= color.rgb;
  } else if (layerSettings.op == LAYEROP_MOD2X) {
    result *= color.rgb * 2.0;
  } else if (layerSettings.op == LAYEROP_ADD) {
    result += color.rgb * color.a;
  } else if (layerSettings.op == LAYEROP_ADD_NO_ALPHA) {
    result += color.rgb;
  } else if (layerSettings.op == LAYEROP_LERP) {
    result = mix(result, color.rgb, color.a);
  } else if (layerSettings.op == LAYEROP_TEAMCOLOR_EMISSIVE_ADD) {
    result += color.a * v_teamColor;
  } else if (layerSettings.op == LAYEROP_TEAMCOLOR_DIFFUSE_ADD) {
    result += color.a * v_teamColor;
  }

  return result;
}

vec4 chooseChannel(float channel, vec4 texel) {
  if (channel == CHANNELSELECT_R) {
    texel = texel.rrrr;
  } else if (channel == CHANNELSELECT_G) {
    texel = texel.gggg;
  } else if (channel == CHANNELSELECT_B) {
    texel = texel.bbbb;
  } else if (channel == CHANNELSELECT_A) {
    texel = texel.aaaa;
  } else if (channel == CHANNELSELECT_RGB) {
    texel.a = 1.0;
  }

  return texel;
}

vec2 getUV(LayerSettings layerSettings) {
  if (layerSettings.uvCoordinate == 1.0) {
    return v_uv[0].zw;
  } else if (layerSettings.uvCoordinate == 2.0) {
    return v_uv[1].xy;
  } else if (layerSettings.uvCoordinate == 3.0) {
    return v_uv[1].zw;
  }

  return v_uv[0].xy;
}

vec4 sampleLayer(sampler2D layer, LayerSettings layerSettings) {
  // if (layerSettings.useConstantColor) {
  //   return layerSettings.constantColor;
  // }

  return texture2D(layer, getUV(layerSettings));
}

vec4 computeLayerColor(sampler2D layer, LayerSettings layerSettings) {
  vec4 color = sampleLayer(layer, layerSettings);

  // if (layerSettings.useMask) {
  //   result *= mask;
  // }

  vec4 result = chooseChannel(layerSettings.channels, color);

  // if (layerSettings.useAlphaFactor) {
  //   result.a *= layerSettings.multiplyAddAlpha.z;
  // }

  if (layerSettings.teamColorMode == TEAMCOLOR_DIFFUSE) {
    result = vec4(mix(v_teamColor, result.rgb, color.a), 1.0);
  } else if (layerSettings.teamColorMode == TEAMCOLOR_EMISSIVE) {
    result = vec4(mix(v_teamColor, result.rgb, color.a), 1.0);
  }

  if (layerSettings.invert) {
    result = vec4(1.0) - result;
  }

  // if (layerSettings.multiplyEnable) {
  //   result *= layerSettings.multiplyAddAlpha.x;
  // }

  // if (layerSettings.addEnable) {
  //   result += layerSettings.multiplyAddAlpha.y;
  // }

  if (layerSettings.clampResult) {
    result = clamp(result, 0.0, 1.0);
  }

  // if (layerSettings.fresnelMode != FRESNELMODE_NONE) {
  //   float fresnelTerm = calculateFresnelTerm(v_normal, v_eyeVec, layerSettings.fresnelExponentBiasScale.x, layerSettings.fresnelTransform, layerSettings.fresnelTransformMode, layerSettings.fresnelClamp);
    
  //   if (layerSettings.fresnelMode == FRESNELMODE_INVERTED) {
  //     fresnelTerm = 1.0 - fresnelTerm;
  //   }
    
  //   fresnelTerm = clamp(fresnelTerm * layerSettings.fresnelExponentBiasScale.z + layerSettings.fresnelExponentBiasScale.y, 0.0, 1.0);
    
  //   result *= fresnelTerm;
  // }

  return result;
}

vec3 decodeNormal(sampler2D map) {
  vec4 texel = texture2D(map, v_uv[0].xy);
  vec3 normal;

  normal.xy = 2.0 * texel.wy - 1.0;
  normal.z = sqrt(max(0.0, 1.0 - dot(normal.xy, normal.xy)));

  return normal;
}

vec4 computeSpecular(sampler2D specularMap, LayerSettings layerSettings, float specularity, float specMult, vec3 normal) {
  vec4 color;

  if (layerSettings.enabled) {
    color = computeLayerColor(specularMap, layerSettings);
  } else {
    color = vec4(0);
  }

  float factor = pow(max(-dot(v_halfVec, normal), 0.0), specularity) * specMult;

  return color * factor;
}


void main() {
  vec3 color;
  vec4 final = u_lightAmbient;
  vec3 normal;
  vec3 lightMapDiffuse;

  if (u_normalLayerSettings.enabled) {
    normal = decodeNormal(u_normalMap);
  } else {
    normal = v_normal;
  }

  float lambertFactor = max(dot(normal, v_lightDir), 0.0);

  if (lambertFactor > 0.0) {
    if (u_diffuseLayerSettings.enabled) {
      vec4 diffuseColor = computeLayerColor(u_diffuseMap, u_diffuseLayerSettings);

      color = combineLayerColor(diffuseColor, color, u_diffuseLayerSettings);
    }

    if (u_decalLayerSettings.enabled) {
      vec4 decalColor = computeLayerColor(u_decalMap, u_decalLayerSettings);

      color = combineLayerColor(decalColor, color, u_decalLayerSettings);
    }

    vec4 specularColor = computeSpecular(u_specularMap, u_specularLayerSettings, u_specularity, u_specMult, normal);

    if (u_lightMapLayerSettings.enabled) {
      vec4 lightMapColor = computeLayerColor(u_lightMapMap, u_lightMapLayerSettings) * 2.0;

      lightMapDiffuse = lightMapColor.rgb;
    }

    // final.rgb = color * lightMapDiffuse + specularColor.rgb;
    final.rgb = (color + specularColor.rgb) * lambertFactor;

    bool addEmissive = false;
    vec3 emissiveColor;
    vec4 tempColor;

    if (u_emissiveLayerSettings.enabled) {
      tempColor = computeLayerColor(u_emissiveMap, u_emissiveLayerSettings);

      if (u_emissiveLayerSettings.op == LAYEROP_MOD || u_emissiveLayerSettings.op == LAYEROP_MOD2X || u_emissiveLayerSettings.op == LAYEROP_LERP) {
        final.rgb = combineLayerColor(tempColor, final.rgb, u_emissiveLayerSettings);
      } else {
        emissiveColor = combineLayerColor(tempColor, emissiveColor, u_emissiveLayerSettings);
        addEmissive = true;
      }
    }

    if (u_emissive2LayerSettings.enabled) {
      tempColor = computeLayerColor(u_emissive2Map, u_emissive2LayerSettings);

      if (!addEmissive && (u_emissive2LayerSettings.op == LAYEROP_MOD || u_emissive2LayerSettings.op == LAYEROP_MOD2X || u_emissive2LayerSettings.op == LAYEROP_LERP)) {
        final.rgb = combineLayerColor(tempColor, final.rgb, u_emissive2LayerSettings);
      } else {
        emissiveColor = combineLayerColor(tempColor, emissiveColor, u_emissive2LayerSettings);
        addEmissive = true;
      }
    }

    if (addEmissive) {
      final.rgb += emissiveColor * u_emisMult;
    }
  }

  gl_FragColor = final * v_vertexColor;
}
`,Cl={load(s){const e=s.gl,t=s.webgl,i=[[255,3,3],[0,66,255],[28,230,185],[84,0,129],[255,252,1],[254,138,14],[32,192,0],[229,91,176],[149,150,151],[126,191,241],[16,98,70],[78,42,4],[40,40,40],[0,0,0]];if(!t.ensureExtension("OES_texture_float"))throw new Error("M3: No float texture support!");const n=[];for(let o=0;o<4;o++){const a=t.createShader(`#define EXPLICITUV${o}
${_l}`,Il);a.use();for(let l=0;l<14;l++){const c=i[l];e.uniform3f(a.uniforms["u_teamColors["+l+"]"],c[0]/255,c[1]/255,c[2]/255)}n[o]=a}const r={standardShaders:n};s.sharedCache.set("m3",r)},isValidSource(s){return s instanceof Yi?!0:al(s)},resource:xl};class Ll{constructor(e){let t=document.createElement("canvas");t.width=t.height=256;let i=new kr(t,{alpha:!1,antialias:!1});i.gl.clearColor(.05,.05,.05,1),i.on("error",n=>console.log(n)),i.addHandler(ii,e),i.addHandler(ba),i.addHandler(Ua),i.addHandler(Na),i.addHandler(Cl),this.viewer=i,this.mathRandom=Math.random,this.tests=[]}add(e){e.tests?this.addBaseName(e.tests,e.name):this.tests.push({name:e.name,test:e})}async test(e){for(let t of this.tests){let i=await this.getTestBlob(t),n=await this.getComparisonBlob(t);if(i&&n){let r=await new Promise(l=>nr(i).compareTo(n).ignoreColors().onComplete(c=>l(c))),o=await At(i),a=await At(n);e({done:!1,value:{name:t.name,testImage:o,comparisonImage:a,mismatchPercentage:r.rawMisMatchPercentage}})}else e(i?{done:!1,value:{name:t.name,testImage:await At(i),mismatchPercentage:100}}:n?{done:!1,value:{name:t.name,comparisonImage:await At(n),mismatchPercentage:100}}:{done:!1,value:{name:t.name,mismatchPercentage:100}})}e({done:!0})}async download(e){for(let t of this.tests){let i=t.name,n=await this.getTestBlob(t);e(n?{done:!1,value:{name:i,blob:n}}:{done:!1,value:{name:i}})}e({done:!0})}isDataAGo(e){if(e){if(Array.isArray(e)){for(let t of e)if(!t)return!1}return!0}return!1}async getTestBlob(e){let t=e.test.load,i=e.test.test,n=this.viewer;n.clear();let r=n.addScene();r.color.fill(.05);let o=t(n);if(await n.whenAllLoaded(),Array.isArray(o)?o=await Promise.all(o):o=await o,this.isDataAGo(o))return Math.random=sr(6),i(n,r,r.camera,o),n.updateAndRender(),Math.random=this.mathRandom,await n.toBlob()}async getComparisonBlob(e){let t=await fetch(`compare/${e.name}.png`);if(t.ok)return await t.blob()}addBaseName(e,t){for(let i of e)i.tests?this.addBaseName(i.tests,t+"-"+i.name):this.tests.push({name:t+"-"+i.name,test:i})}}function ge(s){let e="div";s&&s.tagName&&(e=s.tagName);let t=document.createElement(e);return s&&(s.style&&(t.style=s.style),s.className&&(t.className=s.className),s.textContent&&(t.textContent=s.textContent),s.placeholder&&(t.placeholder=s.placeholder),s.readonly&&(t.readonly=!0),s.href&&(t.href=s.href),s.target&&(t.target=s.target),s.title&&(t.title=s.title),s.onclick&&t.addEventListener("click",i=>s.onclick(i,s.component)),s.onchange&&t.addEventListener("change",i=>s.onchange(i,s.component)),s.oninput&&t.addEventListener("input",i=>s.oninput(i,s.component)),s.container&&s.container.appendChild(t)),t}function fi(s){s.classList.add("hidden")}function wt(s){s.classList.remove("hidden")}function zi(s,e){let t=s.insertCell();return t.appendChild(document.createTextNode(e)),t}function rt(s,e){let t=s.insertCell();return t.appendChild(e),t}class Rl{constructor(e){this.container=ge({...e,component:this})}hide(){fi(this.container)}show(){wt(this.container)}highlight(){this.container.classList.add("highlighted")}normal(){this.container.classList.remove("highlighted")}}function Bl(s,e){if(e){const t=Object.entries(e);if(t.length){const i=t.map(([r,o])=>`${r}=${o}`).join("&");let n="&";return s.indexOf("?")===-1&&(n="?"),`${s}${n}${i}`}}return s}function Js(s,e){return s=s.toLowerCase(),window.location.hostname==="127.0.0.1"?Bl(`${window.location.origin}/assets?path=${s}`,e):`https://www.hiveworkshop.com/casc-contents?path=${s}`}const Q=(s,e)=>(s=Js(s,e),s.endsWith("orcbloodriderlesswyvernrider.mdx")&&s.includes("hiveworkshop")&&(s=s.replace("orcbloodriderlesswyvernrider.mdx","ordbloodriderlesswyvernrider.mdx")),s),ot=Js,Fl={name:"mdx",tests:[{name:"base",load(s){return s.load("Units/Human/Footman/Footman.mdx",Q)},test(s,e,t,i){t.moveToAndFace([150,0,45],[0,0,45],[0,0,1]);let n=i.addInstance();e.addInstance(n)}},{name:"sequence",load(s){return s.load("Units/Human/Footman/Footman.mdx",Q)},test(s,e,t,i){t.moveToAndFace([150,0,45],[0,0,45],[0,0,1]);let n=i.addInstance().setSequence(0);n.frame=800,e.addInstance(n)}},{name:"team-color",load(s){return s.load("Units/Human/Footman/Footman.mdx",Q)},test(s,e,t,i){t.moveToAndFace([150,0,45],[0,0,45],[0,0,1]);let n=i.addInstance().setTeamColor(1);e.addInstance(n)}},{name:"vertex-color",load(s){return s.load("Units/Human/Footman/Footman.mdx",Q)},test(s,e,t,i){t.moveToAndFace([150,0,45],[0,0,45],[0,0,1]);let n=i.addInstance().setVertexColor([1,0,0,1]);e.addInstance(n)}},{name:"vertex-and-team-colors",load(s){return s.load("Units/Human/Footman/Footman.mdx",Q)},test(s,e,t,i){t.moveToAndFace([150,0,45],[0,0,45],[0,0,1]);let n=i.addInstance().setVertexColor([1,0,0,1]).setTeamColor(1);e.addInstance(n)}},{name:"texture-animation",tests:[{name:"translation-and-slot",load(s){return s.load("Units/Human/WaterElemental/WaterElemental.mdx",Q)},test(s,e,t,i){t.moveToAndFace([200,0,85],[0,0,85],[0,0,1]);let n=i.addInstance().setSequence(0);n.frame=800,e.addInstance(n)}},{name:"rotation",load(s){return s.load("UI/Feedback/Cooldown/UI-Cooldown-Indicator.mdx",Q)},test(s,e,t,i){t.moveToAndFace([40,40,100],[40,40,0],[0,1,0]);let n=i.addInstance().setSequence(0).uniformScale(2100).setSequenceLoopMode(2);n.frame=600,e.addInstance(n)}},{name:"scale",load(s){return s.load("Abilities/Spells/Other/Volcano/Volcano.mdx",Q)},test(s,e,t,i){t.moveToAndFace([400,0,50],[0,0,50],[0,0,1]);let n=i.addInstance().setSequence(1);e.addInstance(n)}}]},{name:"billboarding",tests:[{name:"standard",load(s){return s.load("Units/Creeps/Gnoll/Gnoll.mdx",Q)},test(s,e,t,i){t.moveToAndFace([120,-50,75],[0,0,40],[0,0,1]);let n=i.addInstance().setSequence(1).setSequenceLoopMode(2);n.rotate(m.quat.setAxisAngle([],[0,1,0],-.785398)),n.frame=800,e.addInstance(n),s.update()}},{name:"x-axis",load(s){return s.load("SharedModels/NEBirth.MDX",Q)},test(s,e,t,i){t.moveToAndFace([200,-200,400],[0,0,300],[0,0,1]);let n=i.addInstance().setSequence(0).rotate(m.quat.setAxisAngle([],[0,0,1],-.785398));n.frame+=3e4,e.addInstance(n)}}]},{name:"attachment-model",load(s){return s.load("Buildings/Undead/HauntedMine/HauntedMine.mdx",Q)},test(s,e,t,i){t.moveToAndFace([0,0,620],[0,0,0],[0,1,0]);let n=i.addInstance().setSequence(0);e.addInstance(n),n.frame=2e4,s.update();let r=n.attachments[0].internalInstance;r.frame=n.frame}},{name:"particle-emitter",load(s){return s.load("Units/Creeps/AzureDragon/AzureDragon.mdx",Q)},test(s,e,t,i){t.moveToAndFace([50,-35,250],[50,-35,0],[0,1,0]);let n=i.addInstance().setSequence(5);e.addInstance(n);for(let r=0;r<30;r++)s.update()}},{name:"particle-2-emitter",tests:[{name:"base",load(s){return s.load("Units/Creeps/AzureDragon/AzureDragon.mdx",Q)},test(s,e,t,i){t.moveToAndFace([300,0,-20],[0,0,-20],[0,0,1]);let n=i.addInstance().setSequence(1);e.addInstance(n);for(let r=0;r<90;r++)s.update()}},{name:"squirt",load(s){return s.load("Abilities/Spells/Human/Thunderclap/ThunderclapCaster.mdx",Q)},test(s,e,t,i){t.moveToAndFace([0,0,250],[0,0,0],[0,1,0]);let n=i.addInstance().setSequence(1);e.addInstance(n);for(let r=0;r<4;r++)s.update()}},{name:"line-emitter",load(s){return s.load("Abilities/Spells/Human/Thunderclap/ThunderclapCaster.mdx",Q)},test(s,e,t,i){t.moveToAndFace([200,0,50],[0,0,50],[0,0,1]);let n=i.addInstance().setSequence(1);e.addInstance(n);for(let r=0;r<4;r++)s.update()}},{name:"tail",load(s){return s.load("Doodads/Dungeon/Props/ForceWall/ForceWall.mdx",Q)},test(s,e,t,i){t.moveToAndFace([700,0,100],[0,0,100],[0,0,1]);let n=i.addInstance().setSequence(0).setSequenceLoopMode(2);e.addInstance(n);for(let r=0;r<100;r++)s.update()}},{name:"repeat",load(s){return s.load("Doodads/Cinematic/EnergyField/EnergyField.mdx",Q)},test(s,e,t,i){t.moveToAndFace([0,600,100],[0,0,50],[0,0,1]);let n=i.addInstance().setSequence(0).setSequenceLoopMode(2);e.addInstance(n);for(let r=0;r<50;r++)s.update()}},{name:"xy-quad",load(s){return s.load("Units/Orc/SpiritWyvern/SpiritWyvern.mdx",Q)},test(s,e,t,i){t.moveToAndFace([0,300,100],[0,0,50],[0,0,1]);let n=i.addInstance().setSequence(9).setSequenceLoopMode(2);e.addInstance(n);for(let r=0;r<50;r++)s.update()}}]},{name:"ribbon-emitter",load(s){return s.load("Units/Human/HeroPaladin/HeroPaladin.mdx",Q)},test(s,e,t,i){t.moveToAndFace([225,-45,70],[0,0,70],[0,0,1]);let n=i.addInstance().setSequence(4).setSequenceLoopMode(2);e.addInstance(n);for(let r=0;r<24;r++)s.update()}},{name:"event-object",tests:[{name:"spn",load(s){return s.load("Units/Human/Footman/Footman.mdx",Q)},test(s,e,t,i){t.moveToAndFace([-40,0,100],[-40,0,0],[0,1,0]);let n=i.addInstance().setSequence(9);e.addInstance(n);for(let r=0;r<50;r++)s.update()}},{name:"spl",load(s){return s.load("Units/Human/Footman/Footman.mdx",Q)},test(s,e,t,i){t.moveToAndFace([0,0,80],[0,0,0],[0,1,0]);let n=i.addInstance().setSequence(9);e.addInstance(n);for(let r=0;r<170;r++)s.update()}},{name:"ubr",load(s){return s.load("Abilities/Spells/Human/Thunderclap/ThunderclapCaster.mdx",Q)},test(s,e,t,i){t.moveToAndFace([0,0,500],[0,0,0],[0,1,0]);let n=i.addInstance().setSequence(1);e.addInstance(n);for(let r=0;r<20;r++)s.update()}}]},{name:"texture-overriding",load(s){return s.load("Units/Human/Footman/Footman.mdx",Q)},test(s,e,t,i){t.moveToAndFace([220,0,45],[0,0,45],[0,0,1]);let n=i.addInstance().move([0,40,0]),r=i.addInstance().move([0,-40,0]);n.setTexture(0,i.textures[2].texture),e.addInstance(n),e.addInstance(r)}}]};function J(s,e,t){let i,n,r,o=je.Unshaded;t&&(i=t.lines,n=t.color,r=t.texture,t.twoSided&&(o|=je.TwoSided));const a=new Yt,l=a.extent,c=e.boundingRadius;l.min.fill(-c),l.max.fill(c),l.boundsRadius=c;const d=new xi;d.path="PLACEHOLDER",a.textures[0]=d;const h=y=>y===a?a:r,f=new Ei,p=new Si;p.textureId=0,p.flags=o,f.layers[0]=p,a.materials[0]=f;const u=new _i;u.vertices=e.vertices,u.uvSets[0]=e.uvs,u.matrixGroups=new Uint32Array([1]),u.matrixIndices=new Uint32Array([0]),u.vertexGroups=new Uint8Array(e.vertices.length/3);let g=4,v=e.faces;if(i&&(g=1,v=e.edges),u.faceTypeGroups=new Uint32Array([g]),u.faceGroups=new Uint32Array([v.length]),u.faces=v,a.geosets[0]=u,n){const y=new Ii;y.geosetId=0,y.color=n,a.geosetAnimations[0]=y}const w=new Ci;return w.objectId=0,a.bones[0]=w,s.load(a,h)}function kl(s,e){return{vertices:new Float32Array([-s,e,0,-s,-e,0,s,-e,0,s,e,0]),uvs:new Float32Array([0,0,0,1,1,1,1,0]),faces:new Uint16Array([0,1,2,0,2,3]),edges:new Uint16Array([0,1,1,2,2,3,3,0]),boundingRadius:Math.hypot(s,e)}}function Dt(){return kl(1,1)}function Pl(s,e,t){return{vertices:new Float32Array([-s,-e,-t,-s,-e,t,-s,e,-t,-s,e,t,s,e,-t,s,e,t,s,-e,-t,s,-e,t]),uvs:new Float32Array([0,0,0,1,.25,0,.25,1,.5,0,.5,1,.75,0,.75,1]),faces:new Uint16Array([0,1,2,1,3,2,2,3,4,3,5,4,4,5,6,5,7,6,6,7,0,7,1,0,0,2,4,0,4,6,1,5,3,1,7,5]),edges:new Uint16Array([0,1,2,3,4,5,6,7,0,2,2,4,4,6,6,0,1,3,3,5,5,7,7,1]),boundingRadius:Math.hypot(s,e,t)}}function Nt(){return Pl(1,1,1)}function Ml(s,e,t){const i=(e+1)*(t+1),n=new Float32Array(i*3),r=new Float32Array(i*2),o=new Uint16Array(e*t*6),a=new Uint16Array(e*t*6);for(let l=0,c=0,d=0;l<=e;l++){const h=l*Math.PI/e,f=Math.sin(h),p=Math.cos(h);for(let u=0;u<=t;u+=1,c+=3,d+=2){const g=u*2*Math.PI/t,v=Math.sin(g),w=Math.cos(g);n[c+0]=w*f*s,n[c+1]=v*f*s,n[c+2]=p*s,r[d+0]=u/t,r[d+1]=1-l/e}}for(let l=0,c=0;l<e;l++)for(let d=0;d<t;d+=1,c+=6){const h=l*(t+1)+d,f=h+t+1;o[c+0]=h,o[c+1]=f,o[c+2]=h+1,o[c+3]=f,o[c+4]=f+1,o[c+5]=h+1,a[c+0]=h,a[c+1]=f,a[c+2]=h,a[c+3]=h+1,a[c+4]=f,a[c+5]=f+1}return{vertices:n,uvs:r,faces:o,edges:a,boundingRadius:s}}function Vt(s,e){return Ml(1,s,e)}function Ul(s,e,t){t=Math.max(t,3);const i=(t+1)*2+2,n=new Float32Array(i*3),r=new Float32Array(i*2),o=new Uint16Array(t*12),a=new Uint16Array(t*10),l=Math.PI*2/t;let c=0,d=0;for(let h=0;h<t+1;h+=1,c+=6,d+=4){const f=Math.cos(l*h)*s,p=Math.sin(l*h)*s,u=h/t;n[c+0]=f,n[c+1]=p,n[c+2]=e,n[c+3]=f,n[c+4]=p,n[c+5]=-e,r[d+0]=u,r[d+1]=1,r[d+2]=u,r[d+3]=0}n[c+0]=0,n[c+1]=0,n[c+2]=e,n[c+3]=0,n[c+4]=0,n[c+5]=-e,r[d+0]=0,r[d+1]=1,r[d+2]=0,r[d+3]=0;for(let h=0,f=0,p=0;h<t;h+=1,f+=12,p+=10){const u=h*2;o[f+0]=u+0,o[f+1]=u+1,o[f+2]=(u+3)%(i-2),o[f+3]=u+0,o[f+4]=(u+3)%(i-2),o[f+5]=(u+2)%(i-2),o[f+6]=u+0,o[f+7]=(u+2)%(i-2),o[f+8]=i-2,o[f+9]=u+1,o[f+10]=(u+3)%(i-2),o[f+11]=i-1,a[p+0]=u+0,a[p+1]=u+1,a[p+2]=u+0,a[p+3]=(u+2)%(i-2),a[p+4]=u+1,a[p+5]=(u+3)%(i-2),a[p+6]=u+0,a[p+7]=i-2,a[p+8]=u+1,a[p+9]=i-1}return{vertices:n,uvs:r,faces:o,edges:a,boundingRadius:Math.hypot(s,e)}}function Gt(s){return Ul(1,1,s)}function qt(s,e,t,i){const n=2*Math.tan(s/2),r=n*t/2,o=t*e/2,a=n*i/2,l=i*e/2;return{vertices:new Float32Array([-o,-r,t,-o,r,t,-l,-a,i,-l,a,i,l,-a,i,l,a,i,o,-r,t,o,r,t]),uvs:new Float32Array([0,0,0,1,.25,0,.25,1,.5,0,.5,1,.75,0,.75,1]),faces:new Uint16Array([0,1,2,1,3,2,2,3,4,3,5,4,4,5,6,5,7,6,6,7,0,7,1,0,0,2,4,0,4,6,1,5,3,1,7,5]),edges:new Uint16Array([0,1,2,3,4,5,6,7,0,2,2,4,4,6,6,0,1,3,3,5,5,7,7,1]),boundingRadius:Math.hypot(l,a)}}const Ol={name:"mdx-primitives",tests:[{name:"rectangle",tests:[{name:"faces",load(s){return J(s,Dt())},test(s,e,t,i){t.move([0,0,120]);let n=i.addInstance().uniformScale(40).rotate(m.quat.setAxisAngle([],[1,0,0],Math.PI/8));e.addInstance(n)}},{name:"edges",load(s){return J(s,Dt(),{lines:!0})},test(s,e,t,i){t.move([0,0,120]);let n=i.addInstance().uniformScale(40).rotate(m.quat.setAxisAngle([],[1,0,0],Math.PI/8));e.addInstance(n)}},{name:"vertex-color",load(s){return J(s,Dt(),{color:new Float32Array([1,0,0])})},test(s,e,t,i){t.move([0,0,120]);let n=i.addInstance().uniformScale(40).rotate(m.quat.setAxisAngle([],[1,0,0],Math.PI/8));e.addInstance(n)}},{name:"edge-color",load(s){return J(s,Dt(),{lines:!0,color:new Float32Array([0,1,0])})},test(s,e,t,i){t.move([0,0,120]);let n=i.addInstance().uniformScale(40).rotate(m.quat.setAxisAngle([],[1,0,0],Math.PI/8));e.addInstance(n)}},{name:"texture",load(s){let e=s.load("resources/checkers.jpg");return J(s,Dt(),{texture:e})},test(s,e,t,i){t.move([0,0,120]);let n=i.addInstance().uniformScale(40).rotate(m.quat.setAxisAngle([],[1,0,0],Math.PI/8));e.addInstance(n)}}]},{name:"cube",tests:[{name:"faces",load(s){return J(s,Nt())},test(s,e,t,i){t.move([0,0,160]);let n=i.addInstance().uniformScale(40).rotate(m.quat.setAxisAngle([],[1,0,0],Math.PI/8));e.addInstance(n)}},{name:"edges",load(s){return J(s,Nt(),{lines:!0})},test(s,e,t,i){t.move([0,0,160]);let n=i.addInstance().uniformScale(40).rotate(m.quat.setAxisAngle([],[1,0,0],Math.PI/8));e.addInstance(n)}},{name:"vertex-color",load(s){return J(s,Nt(),{color:new Float32Array([1,0,0])})},test(s,e,t,i){t.move([0,0,160]);let n=i.addInstance().uniformScale(40).rotate(m.quat.setAxisAngle([],[1,0,0],Math.PI/8));e.addInstance(n)}},{name:"edge-color",load(s){return J(s,Nt(),{lines:!0,color:new Float32Array([0,1,0])})},test(s,e,t,i){t.move([0,0,160]);let n=i.addInstance().uniformScale(40).rotate(m.quat.setAxisAngle([],[1,0,0],Math.PI/8));e.addInstance(n)}},{name:"texture",load(s){let e=s.load("resources/checkers.jpg");return J(s,Nt(),{texture:e})},test(s,e,t,i){t.move([0,0,160]);let n=i.addInstance().uniformScale(40).rotate(m.quat.setAxisAngle([],[1,0,0],Math.PI/8));e.addInstance(n)}}]},{name:"sphere",tests:[{name:"faces",load(s){return J(s,Vt(20,20))},test(s,e,t,i){t.move([0,0,120]);let n=i.addInstance().uniformScale(40).rotate(m.quat.setAxisAngle([],[1,0,0],Math.PI/8));e.addInstance(n)}},{name:"edges",load(s){return J(s,Vt(20,20),{lines:!0})},test(s,e,t,i){t.move([0,0,120]);let n=i.addInstance().uniformScale(40).rotate(m.quat.setAxisAngle([],[1,0,0],Math.PI/8));e.addInstance(n)}},{name:"vertex-color",load(s){return J(s,Vt(20,20),{color:new Float32Array([1,0,0])})},test(s,e,t,i){t.move([0,0,120]);let n=i.addInstance().uniformScale(40).rotate(m.quat.setAxisAngle([],[1,0,0],Math.PI/8));e.addInstance(n)}},{name:"edge-color",load(s){return J(s,Vt(20,20),{lines:!0,color:new Float32Array([0,1,0])})},test(s,e,t,i){t.move([0,0,120]);let n=i.addInstance().uniformScale(40).rotate(m.quat.setAxisAngle([],[1,0,0],Math.PI/8));e.addInstance(n)}},{name:"texture",load(s){let e=s.load("resources/checkers.jpg");return J(s,Vt(20,20),{texture:e})},test(s,e,t,i){t.move([0,0,120]);let n=i.addInstance().uniformScale(40).rotate(m.quat.setAxisAngle([],[1,0,0],Math.PI/8));e.addInstance(n)}}]},{name:"cylinder",tests:[{name:"faces",load(s){return J(s,Gt(20))},test(s,e,t,i){t.move([0,0,150]);let n=i.addInstance().uniformScale(40).rotate(m.quat.setAxisAngle([],[1,0,0],Math.PI/8));e.addInstance(n)}},{name:"edges",load(s){return J(s,Gt(20),{lines:!0})},test(s,e,t,i){t.move([0,0,150]);let n=i.addInstance().uniformScale(40).rotate(m.quat.setAxisAngle([],[1,0,0],Math.PI/8));e.addInstance(n)}},{name:"vertex-color",load(s){return J(s,Gt(20),{color:new Float32Array([1,0,0])})},test(s,e,t,i){t.move([0,0,150]);let n=i.addInstance().uniformScale(40).rotate(m.quat.setAxisAngle([],[1,0,0],Math.PI/8));e.addInstance(n)}},{name:"edge-color",load(s){return J(s,Gt(20),{lines:!0,color:new Float32Array([0,1,0])})},test(s,e,t,i){t.move([0,0,150]);let n=i.addInstance().uniformScale(40).rotate(m.quat.setAxisAngle([],[1,0,0],Math.PI/8));e.addInstance(n)}},{name:"texture",load(s){let e=s.load("resources/checkers.jpg");return J(s,Gt(),{texture:e})},test(s,e,t,i){t.move([0,0,150]);let n=i.addInstance().uniformScale(40).rotate(m.quat.setAxisAngle([],[1,0,0],Math.PI/8));e.addInstance(n)}}]},{name:"frustum",tests:[{name:"faces",load(s){return J(s,qt(Math.PI/4,.75,8,120))},test(s,e,t,i){t.moveToAndFace([150,0,200],[0,0,60],[0,0,1]);let n=i.addInstance();e.addInstance(n)}},{name:"edges",load(s){return J(s,qt(Math.PI/4,.75,8,120),{lines:!0})},test(s,e,t,i){t.moveToAndFace([150,0,200],[0,0,60],[0,0,1]);let n=i.addInstance();e.addInstance(n)}},{name:"vertex-color",load(s){return J(s,qt(Math.PI/4,.75,8,120),{color:new Float32Array([1,0,0])})},test(s,e,t,i){t.moveToAndFace([150,0,200],[0,0,60],[0,0,1]);let n=i.addInstance();e.addInstance(n)}},{name:"edge-color",load(s){return J(s,qt(Math.PI/4,.75,8,120),{lines:!0,color:new Float32Array([0,1,0])})},test(s,e,t,i){t.moveToAndFace([150,0,200],[0,0,60],[0,0,1]);let n=i.addInstance();e.addInstance(n)}},{name:"texture",load(s){let e=s.load("resources/checkers.jpg");return J(s,qt(Math.PI/4,.75,8,120),{texture:e})},test(s,e,t,i){t.moveToAndFace([150,0,200],[0,0,60],[0,0,1]);let n=i.addInstance();e.addInstance(n)}}]}]},Dl={name:"m3",tests:[{name:"base",load(s){return s.load("Assets/Units/Zerg/Baneling/Baneling.m3",ot)},test(s,e,t,i){t.moveToAndFace([0,5,100],[0,5,0],[0,1,0]);let n=i.addInstance().uniformScale(50);e.addInstance(n)}},{name:"sequence",load(s){return s.load("Assets/Units/Zerg/Baneling/Baneling.m3",ot)},test(s,e,t,i){t.moveToAndFace([0,5,100],[0,5,0],[0,1,0]);let n=i.addInstance().uniformScale(50).setSequence(0);n.frame=800,e.addInstance(n)}},{name:"team-color",load(s){return s.load("Assets/Units/Zerg/Baneling/Baneling.m3",ot)},test(s,e,t,i){t.moveToAndFace([0,5,100],[0,5,0],[0,1,0]);let n=i.addInstance().uniformScale(50).setTeamColor(1);e.addInstance(n)}},{name:"vertex-color",load(s){return s.load("Assets/Units/Zerg/Baneling/Baneling.m3",ot)},test(s,e,t,i){t.moveToAndFace([0,5,100],[0,5,0],[0,1,0]);let n=i.addInstance().uniformScale(50).setVertexColor([1,0,0,1]);e.addInstance(n)}},{name:"vertex-and-team-colors",load(s){return s.load("Assets/Units/Zerg/Baneling/Baneling.m3",ot)},test(s,e,t,i){t.moveToAndFace([0,5,100],[0,5,0],[0,1,0]);let n=i.addInstance().uniformScale(50).setVertexColor([1,0,0,1]).setTeamColor(1);e.addInstance(n)}},{name:"texture-overriding",load(s){return s.load("Assets/Units/Zerg/Baneling/Baneling.m3",ot)},test(s,e,t,i){t.moveToAndFace([0,5,140],[0,5,0],[0,1,0]);let n=i.addInstance().uniformScale(50).move([25,0,0]),r=i.addInstance().uniformScale(50).move([-25,0,0]),o=i.materials[1][0];n.setTexture(0,0,o.layers[10].texture.texture),e.addInstance(n),e.addInstance(r)}}]},Nl={name:"base",tests:[{name:"attachments",load(s){return[s.load("Units/Human/Footman/Footman.mdx",Q),s.load("Assets/Units/Zerg/Baneling/Baneling.m3",ot)]},test(s,e,t,i){let n=i[0],r=i[1];t.moveToAndFace([450,0,160],[0,0,160],[0,0,1]);let o=n.addInstance().setSequence(1),a=n.addInstance().setSequence(1),l=n.addInstance().setSequence(1),c=r.addInstance().setSequence(0).uniformScale(100),d=r.addInstance().setSequence(0).uniformScale(100),h=r.addInstance().setSequence(0).uniformScale(100);c.setParent(o.getAttachment(3)),a.setParent(c.getAttachment(4)),d.setParent(a.getAttachment(3)),l.setParent(d.getAttachment(4)),h.setParent(l.getAttachment(3)),e.addInstance(o),e.addInstance(c),e.addInstance(a),e.addInstance(d),e.addInstance(l),e.addInstance(h)}}]};class Vl extends Rl{constructor(e){super(),this.mismatchPercentageForFailure=1,this.passed=0;let t=new Ll(Q);t.add(Fl),t.add(Ol),t.add(Dl),t.add(Nl),this.unitTester=t,ge({tagName:"b",textContent:`Viewer version ${Zi}`,container:this.container}),ge({tagName:"hr",container:this.container});let i=ge({container:this.container});this.runButton=ge({tagName:"button",textContent:"Run",onclick:()=>this.run(),container:i}),this.downloadButton=ge({tagName:"button",textContent:"Download",onclick:()=>this.download(),container:i}),ge({tagName:"hr",container:this.container}),this.resultsContainer=ge({className:"hidden",container:this.container}),this.resultsMeta=ge({container:this.resultsContainer});let n=ge({tagName:"table",container:this.resultsContainer});this.tbody=n.createTBody();let o=n.createTHead().insertRow();rt(o,ge({className:"bold",textContent:"Name"})),this.headerResult=rt(o,ge({className:"bold",textContent:"Result"})),this.headerNew=rt(o,ge({className:"bold",textContent:"New"})),this.headerOld=rt(o,ge({className:"bold",textContent:"Old"})),e.appendChild(this.container)}clear(){let e=this.tbody;for(let t=e.rows.length-1,i=t;i>=0;i--)e.deleteRow(i)}result(e){let t=this.tbody.insertRow();if(zi(t,e.name),e.mismatchPercentage!==void 0){let i=e.mismatchPercentage<this.mismatchPercentageForFailure;i&&(this.passed+=1);let n=this.unitTester.tests.length,r=this.tbody.rows.length,o="passed";this.passed<r&&(o="failed"),this.resultsMeta.className=o,this.resultsMeta.textContent=`${this.passed} / ${r} (${n} total)`;let a=i?"passed":"failed";if(rt(t,ge({className:a,textContent:a})),e.testImage){let l=ge({tagName:"a",className:"center",href:e.testImage.src,target:"_blank"});l.appendChild(e.testImage),rt(t,l)}else zi(t,"");if(e.comparisonImage){let l=ge({tagName:"a",className:"center",href:e.comparisonImage.src,target:"_blank"});l.appendChild(e.comparisonImage),rt(t,l)}else zi(t,"")}}run(){this.passed=0,this.runButton.disabled=!0,this.downloadButton.disabled=!0,this.clear(),wt(this.headerResult),wt(this.headerNew),wt(this.headerOld),wt(this.resultsContainer),this.unitTester.test(e=>{if(e.done)this.runButton.disabled=!1,this.downloadButton.disabled=!1;else{let t=e.value;t.result<1&&this.passed++,this.result(t)}})}download(){this.passed=0,this.runButton.disabled=!0,this.downloadButton.disabled=!0,this.clear(),fi(this.headerResult),fi(this.headerNew),fi(this.headerOld),wt(this.resultsContainer);let e=new JSZip;this.unitTester.download(t=>{if(t.done)this.runButton.disabled=!1,this.downloadButton.disabled=!1,e.generateAsync({type:"blob"}).then(i=>{saveAs(i,`compare_${Zi}.zip`)});else{let i=t.value;this.result(i),i.blob?(this.passed++,e.file(`${i.name}.png`,i.blob)):console.log(`Skipping ${i.name} because it has no blob`)}})}}const Gl=new Vl(document.body);window.tester=Gl}));
