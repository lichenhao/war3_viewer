(function(R,F){typeof exports=="object"&&typeof module<"u"?F(require("pako")):typeof define=="function"&&define.amd?define(["pako"],F):(R=typeof globalThis<"u"?globalThis:R||self,F(R.pako))})(this,(function(R){"use strict";function F(i){if(i&&i.length){const e=i.lastIndexOf(".");return e!==-1&&(i=i.slice(e).toLowerCase()),i}return""}const yt=new TextDecoder,St=new TextEncoder;function q(i){return yt.decode(i)}function ue(i){return St.encode(i)}function T(i){let e=i.length;for(let t=i.length-1;t>=0;t--){const r=i.charCodeAt(t);r>127&&r<=2047?e++:r>2047&&r<=65535&&(e+=2),r>=56320&&r<=57343&&t--}return e}function bt(i,e){const t=[];let r=0,n=0;for(let s=0,a=i.length;s<a;s++){const o=i.charCodeAt(s);o<128?n+=1:o<2048?n+=2:o<55296||o>=57344?n+=3:(s++,n+=4),n>=e-3&&(t.push(i.substr(r,s)),r+=s,n=0)}return n>0&&t.push(i.substr(r)),t}function Z(i){return i instanceof Uint8Array?i:typeof i=="string"?ue(i):new Uint8Array(i)}function wt(i){return i--,i|=i>>1,i|=i>>2,i|=i>>4,i|=i>>8,i|=i>>16,i++,i}const _=new ArrayBuffer(8),fe=new Int8Array(_),ge=new Int16Array(_),pe=new Int32Array(_),S=new Uint8Array(_),me=new Uint16Array(_),k=new Uint32Array(_),ye=new Float32Array(_),Se=new Float64Array(_);function be(i){return S[0]=i,fe[0]}function we(i,e){return S[0]=i,S[1]=e,ge[0]}function Te(i,e,t,r){return S[0]=i,S[1]=e,S[2]=t,S[3]=r,pe[0]}function Be(i,e){return S[0]=i,S[1]=e,me[0]}function Ie(i,e,t,r){return S[0]=i,S[1]=e,S[2]=t,S[3]=r,k[0]}function ve(i,e,t,r){return S[0]=i,S[1]=e,S[2]=t,S[3]=r,ye[0]}function Ae(i,e,t,r,n,s,a,o){return S[0]=i,S[1]=e,S[2]=t,S[3]=r,S[4]=n,S[5]=s,S[6]=a,S[7]=o,Se[0]}function Ee(i){return S[0]=i,fe[0]}function Le(i,e){return ge[0]=e,i[0]=S[0],i[1]=S[1],i}function Ce(i,e){return pe[0]=e,i[0]=S[0],i[1]=S[1],i[2]=S[2],i[3]=S[3],i}function Ue(i,e){return me[0]=e,i[0]=S[0],i[1]=S[1],i}function xe(i,e){return k[0]=e,i[0]=S[0],i[1]=S[1],i[2]=S[2],i[3]=S[3],i}function Pe(i,e){return ye[0]=e,i[0]=S[0],i[1]=S[1],i[2]=S[2],i[3]=S[3],i}function Je(i,e){return Se[0]=e,i[0]=S[0],i[1]=S[1],i[2]=S[2],i[3]=S[3],i[4]=S[4],i[5]=S[5],i[6]=S[6],i[7]=S[7],i}function _e(i){return k[0]=i,k[0]}function Tt(i){let e=0;for(const t of i)e=e*256+t.charCodeAt(0);return e}class He{offset=0;compressedSize=0;normalSize=0;flags=0;load(e){this.offset=e[0],this.compressedSize=e[1],this.normalSize=e[2],this.flags=e[3]}save(e){e[0]=this.offset,e[1]=this.compressedSize,e[2]=this.normalSize,e[3]=this.flags}}const Bt=441536589,De=3283040112,Me=0,Re=1,Fe=2,It=3,z=4294967294,Ge=4294967295,$e=3968054179,vt=256,ee=512,te=65536,Ne=131072,Oe=16777216,V=2147483648,At=1,Et=2,Lt=8,Ct=16,Ut=64,xt=128;class Pt{c;entries;constructor(e){this.c=e,this.entries=[]}add(e){const t=new He;return t.normalSize=e.byteLength,this.entries.push(t),t}clear(){this.entries.length=0}addEmpties(e){for(let t=0;t<e;t++)this.entries.push(new He)}load(e){const t=e.byteLength/16,r=new Uint32Array(this.c.decryptBlock(e,$e).buffer);let n=0;this.clear(),this.addEmpties(t);for(const s of this.entries)s.load(r.subarray(n,n+4)),n+=4}save(e){const t=new Uint32Array(this.entries.length*4);let r=0;for(const s of this.entries)s.save(t.subarray(r,r+4)),r+=4;const n=new Uint8Array(t.buffer);this.c.encryptBlock(n,$e),e.set(n)}}const A=new Uint8Array(4),j=new Uint32Array(A.buffer);class Jt{cryptTable=new Uint32Array(1280);constructor(){let e=1048577,t=0,r=0;for(let n=0;n<256;n++)for(let s=n,a=0;a<5;a+=1,s+=256)e=(e*125+3)%2796203,t=(e&65535)<<16,e=(e*125+3)%2796203,r=e&65535,this.cryptTable[s]=t|r}hash(e,t){const r=this.cryptTable;let n=2146271213,s=4008636142;e=e.toUpperCase();for(let a=0;a<e.length;a++){const o=e.charCodeAt(a);n=r[(t<<8)+o]^n+s,s=o+n+s+(s<<5)+3}return n>>>0}decryptBlock(e,t){const r=this.cryptTable;let n=4008636142;const s=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);for(let a=0,o=e.byteLength>>>2;a<o;a++)n+=r[1024+(t&255)],A[0]=s[a*4],A[1]=s[a*4+1],A[2]=s[a*4+2],A[3]=s[a*4+3],j[0]^=t+n,t=(~t<<21)+286331153|t>>>11,n=j[0]+n+(n<<5)+3,s[a*4]=A[0],s[a*4+1]=A[1],s[a*4+2]=A[2],s[a*4+3]=A[3];return e}encryptBlock(e,t){const r=this.cryptTable;let n=4008636142;const s=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);for(let a=0,o=e.byteLength>>>2;a<o;a++){n+=r[1024+(t&255)],A[0]=s[a*4],A[1]=s[a*4+1],A[2]=s[a*4+2],A[3]=s[a*4+3];const h=j[0];j[0]^=t+n,t=(~t<<21)+286331153|t>>>11,n=h+n+(n<<5)+3,s[a*4]=A[0],s[a*4+1]=A[1],s[a*4+2]=A[2],s[a*4+3]=A[3]}return e}computeFileKey(e,t){const r=e.lastIndexOf("\\"),n=e.substring(r+1);let s=this.hash(n,It);return t.flags&Ne&&(s=s+t.offset^t.normalSize),s}}const ke=0,_t=1;class Ht{ctype=0;outputPos=0;dsize_bits=0;dsize_mask=0;bit_buff=0;extra_bits=0;in_pos=0;in_buff;out_buff=[];constructor(e){this.in_buff=e}}const ze=0,Dt=1,Ve=new Uint8Array([2,4,4,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8]),Mt=new Uint8Array([3,13,5,25,9,17,1,62,30,46,14,54,22,38,6,58,26,42,10,50,18,34,66,2,124,60,92,28,108,44,76,12,116,52,84,20,100,36,68,4,120,56,88,24,104,40,72,8,240,112,176,48,208,80,144,16,224,96,160,32,192,64,128,0]),Rt=new Uint8Array([0,0,0,0,0,0,0,0,1,2,3,4,5,6,7,8]),Ft=new Uint16Array([0,1,2,3,4,5,6,7,8,10,14,22,38,70,134,262]),je=new Uint8Array([3,2,3,3,4,4,4,5,5,5,5,6,6,6,7,7]),Gt=new Uint8Array([5,3,1,6,10,2,12,20,4,24,8,48,16,32,64,0]),N=new Uint8Array([11,12,12,12,12,12,12,12,12,8,7,12,12,7,12,12,12,12,12,12,12,12,12,12,12,12,13,12,12,12,12,12,4,10,8,12,10,12,10,8,7,7,8,9,7,6,7,8,7,6,7,7,7,7,8,7,7,8,8,12,11,7,9,11,12,6,7,6,6,5,7,8,8,6,11,9,6,7,6,6,7,11,6,6,6,7,9,8,9,9,11,8,11,9,12,8,12,5,6,6,6,5,6,6,6,5,11,7,5,6,5,5,6,10,5,5,5,5,8,7,8,8,10,11,11,12,12,12,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,13,12,13,13,13,12,13,13,13,12,13,13,13,13,12,13,13,13,12,12,12,13,13,13,13,13,13,13,13,13,13,13]),G=new Uint16Array([1168,4064,2016,3040,992,3552,1504,2528,480,184,98,3808,1760,34,2784,736,3296,1248,2272,224,3936,1888,2912,864,3424,1376,4672,2400,352,3680,1632,2656,15,592,56,608,80,3168,912,216,66,2,88,432,124,41,60,152,92,9,28,108,44,76,24,12,116,232,104,1120,144,52,176,1808,2144,49,84,17,33,23,20,168,40,1,784,304,62,100,30,46,36,1296,14,54,22,68,48,200,464,208,272,72,1552,336,96,136,4e3,7,38,6,58,27,26,42,10,11,528,4,19,50,3,29,18,400,13,21,5,25,8,120,240,112,656,1040,16,1952,2976,928,576,7232,3136,5184,1088,6208,2112,4160,64,8064,3968,6016,1920,7040,2944,4992,896,7552,3456,5504,1408,6528,2432,4480,384,7808,3712,5760,1664,6784,2688,4736,640,7296,3200,5248,1152,6272,2176,4224,128,7936,3840,5888,1792,6912,2816,4864,3488,1440,2464,416,3744,1696,2720,672,3232,1184,2208,160,3872,1824,2848,800,3360,1312,2336,288,3616,1568,2592,544,3104,1056,2080,32,4032,1984,3008,960,3520,1472,2496,448,3776,1728,2752,704,3264,1216,2240,192,3904,1856,2880,832,768,3392,7424,3328,5376,1344,1280,6400,2304,2368,4352,256,7680,3584,320,5632,1536,6656,3648,1600,2624,2560,4608,512,7168,3072,5120,1024,6144,2048,4096,0]);let We=!1;const Ke=new Uint8Array(256),Ye=new Uint8Array(256);let Qe=!1;const re=new Uint8Array(256),Xe=new Uint8Array(256),qe=new Uint8Array(128),Ze=new Uint8Array(256);function et(i,e,t){for(let r=0,n=e.length;r<n;r++){const s=1<<t[r];for(let a=e[r];a<256;a+=s)i[a]=r}}function $t(){let i=255,e,t;for(let r=255;i>=0;i--,r--){const n=r;let s=N[n];if(s<=8){t=1<<s,e=G[i];do re[e]=r,e+=t;while(e<256)}else if((e=G[i]&255)!=0)if(re[e]=255,G[i]&63){s-=4,N[n]=s,t=1<<s,e=G[i]>>4;do Xe[e]=r,e+=t;while(e<256)}else{s-=6,N[n]=s,t=1<<s,e=G[i]>>6;do qe[e]=r,e+=t;while(e<128)}else{s-=8,N[n]=s,t=1<<s,e=G[i]>>8;do Ze[e]=r,e+=t;while(e<256)}}}function C(i,e){return e<=i.extra_bits?(i.extra_bits-=e,i.bit_buff>>=e,ze):(i.bit_buff>>=i.extra_bits,i.in_pos===i.in_buff.byteLength?Dt:(i.bit_buff|=i.in_buff[i.in_pos++]<<8,i.bit_buff>>=e-i.extra_bits,i.extra_bits=i.extra_bits-e+8,ze))}function Nt(i){if(i.bit_buff&1){if(C(i,1))return 774;let t=Ye[i.bit_buff&255];if(C(i,je[t]))return 774;let r;if((r=Rt[t])!=0){const n=i.bit_buff&(1<<r)-1;if(C(i,r)&&t+n!=270)return 774;t=Ft[t]+n}return t+256}if(C(i,1))return 774;if(i.ctype==ke){const t=i.bit_buff&255;return C(i,8)?774:t}let e;if(i.bit_buff&255){if(e=re[i.bit_buff&255],e==255)if(i.bit_buff&63){if(C(i,4))return 774;e=Xe[i.bit_buff&255]}else{if(C(i,6))return 774;e=qe[i.bit_buff&127]}}else{if(C(i,8))return 774;e=Ze[i.bit_buff&255]}return C(i,N[e])?774:e}function Ot(i,e){const t=Ke[i.bit_buff&255],r=Ve[t];if(C(i,r))return 0;let n;if(e==2){if(n=t<<2|i.bit_buff&3,C(i,2))return 0}else if(n=t<<i.dsize_bits|i.bit_buff&i.dsize_mask,C(i,i.dsize_bits))return 0;return n+1}function kt(i){let e;for(;(e=Nt(i))<773;)if(e>=256){let t=e-254,r;if((r=Ot(i,t))==0)return 774;let n=i.outputPos,s=n-r;for(i.outputPos+=t;t-- >0;)i.out_buff[n++]=i.out_buff[s++]}else i.out_buff[i.outputPos++]=e;return e}function tt(i){const e=new Ht(i);if(e.in_buff.byteLength<=4)throw new Error("Bad data");if(e.ctype=e.in_buff[0],e.dsize_bits=e.in_buff[1],e.bit_buff=e.in_buff[2],e.extra_bits=0,e.in_pos=3,4>e.dsize_bits||e.dsize_bits>6)throw new Error("Invalid dictionary size");if(e.dsize_mask=65535>>16-e.dsize_bits,e.ctype!==ke){if(e.ctype!==_t)throw new Error("Invalid mode");Qe||($t(),Qe=!0)}if(We||(et(Ye,Gt,je),et(Ke,Mt,Ve),We=!0),kt(e)===774)throw new Error("Error while expanding");return new Uint8Array(e.out_buff)}function rt(i){let e=-1;for(let t=0,r=Math.ceil(i.byteLength/512);t<r;t++){const n=t*512;i[n]===77&&i[n+1]===80&&i[n+2]===81&&i[n+3]===26&&(e=n)}return e}function zt(i){return i[0]===72&&i[1]===77&&i[2]===51&&i[3]===87?!0:rt(i)!==-1}class it{archive;c;name;nameResolved;hash;block;rawBuffer=null;buffer=null;constructor(e,t,r,n,s){const a=e.headerOffset;this.archive=e,this.c=e.c,this.name=`File${`${t.blockIndex}`.padStart(8,"0")}`,this.nameResolved=!1,this.hash=t,this.block=r,n&&(this.rawBuffer=n.slice(a+r.offset,a+r.offset+r.compressedSize)),s&&(this.buffer=s)}bytes(){return this.buffer===null&&this.decode(),this.buffer}arrayBuffer(){return this.bytes().buffer}text(){return q(this.bytes())}set(e){if(this.archive.readonly)return!1;const t=this.hash,r=this.block;return t.locale=0,t.platform=0,r.compressedSize=0,r.normalSize=e.byteLength,r.flags=0,this.buffer=e,this.rawBuffer=null,!0}delete(){if(this.archive.readonly)return!1;const e=this.archive,t=this.hash,r=t.blockIndex;t.delete();for(const n of e.hashTable.entries)n.blockIndex<z&&n.blockIndex>r&&(n.blockIndex-=1);return e.blockTable.entries.splice(r,1),e.files.splice(r,1),!0}rename(e){if(this.archive.readonly)return!1;const t=this.hash,r=t.locale,n=t.platform,s=t.blockIndex;t.delete();const a=this.archive.hashTable.add(e,s);return a.locale=r,a.platform=n,this.name=e,this.nameResolved=!0,this.hash=a,!0}decode(){if(!this.rawBuffer)throw new Error(`File ${this.name}: Nothing to decode`);const e=this.archive,t=this.block,r=e.c,n=r.computeFileKey(this.name,t),s=this.rawBuffer,a=t.flags;if(a===V)this.buffer=s.slice(0,t.normalSize);else if(a&Oe){let o;a&te?o=r.decryptBlock(s.slice(0,t.compressedSize),n):o=s.subarray(0,t.compressedSize),a&ee?o=this.decompressSector(o,t.normalSize):o=o.slice(),this.buffer=o}else{const o=Math.ceil(t.normalSize/e.sectorSize),h=new Uint8Array(t.normalSize);let l=new Uint32Array(s.buffer,0,o+1);a&te&&(l=r.decryptBlock(l.slice(),n-1));let u=l[0],p=l[1],m=0;for(let f=0;f<o;f++){let y;if(a&te?y=r.decryptBlock(s.slice(u,p),n+f):y=s.subarray(u,p),a&ee){let b=e.sectorSize;t.normalSize-m<b&&(b=t.normalSize-m),y=this.decompressSector(y,b)}a&vt&&(y=tt(y)),h.set(y,m),m+=y.byteLength,f<o&&(u=p,p=l[f+2])}this.buffer=h}e.readonly&&(this.rawBuffer=null)}decompressSector(e,t){if(e.byteLength===t)return e;{const r=e[0];if(r&Ct)throw new Error(`File ${this.name}: compression type 'bzip2' not supported`);if(r&Lt)try{e=tt(e.subarray(1))}catch(n){throw new Error(`File ${this.name}: failed to decompress with 'explode': ${n}`)}if(r&Et)try{e=R.inflate(e.subarray(1))}catch(n){throw new Error(`File ${this.name}: failed to decompress with 'zlib': ${n}`)}if(r&At)throw new Error(`File ${this.name}: compression type 'huffman' not supported`);if(r&xt)throw new Error(`File ${this.name}: compression type 'adpcm stereo' not supported`);if(r&Ut)throw new Error(`File ${this.name}: compression type 'adpcm mono' not supported`);return e}}encode(){if(this.buffer!==null&&this.rawBuffer===null){const e=this.buffer;if(zt(e))this.rawBuffer=this.buffer,this.block.compressedSize=this.buffer.byteLength,this.block.flags=V;else{const t=this.archive.sectorSize,r=Math.ceil(e.byteLength/t),n=new Uint32Array(r+1);let s=n.byteLength;const a=[],o=[];n[0]=s;for(let h=0;h<r;h++){const l=h*t;let u=e.subarray(l,l+t),p=u.byteLength;const m=R.deflate(u);let f=!1;m.byteLength+1<p&&(u=m,p=m.byteLength+1,f=!0),s+=p,n[h+1]=s,a[h]=u,o[h]=f}if(s<e.byteLength){const h=new Uint8Array(s);h.set(new Uint8Array(n.buffer)),s=n.byteLength;for(let l=0;l<r;l++){o[l]&&(h[s]=2,s+=1);const u=a[l];h.set(u,s),s+=u.byteLength}this.rawBuffer=h,this.block.compressedSize=h.byteLength,this.block.flags=(V|ee)>>>0}else this.rawBuffer=this.buffer,this.block.compressedSize=this.buffer.byteLength,this.block.flags=V}}}reEncrypt(e){if(!this.rawBuffer)return!1;const t=this.archive,r=this.block,n=t.c,s=this.rawBuffer,a=r.flags,o=n.computeFileKey(this.name,r);r.offset=e;const h=n.computeFileKey(this.name,r);if(a&Oe)n.decryptBlock(s,o),n.encryptBlock(s,h);else{const l=Math.ceil(r.normalSize/t.sectorSize),u=new Uint32Array(s.buffer,0,l+1);n.decryptBlock(u,o-1);let p=u[0],m=u[1];for(let f=0;f<l;f++){const y=s.subarray(p,m);n.decryptBlock(y,o+f),n.encryptBlock(y,h+f),f<l&&(p=m,m=u[f+2])}n.encryptBlock(u,h-1)}return!0}offsetChanged(e){const t=this.block;return t.offset!==e&&t.flags&Ne?this.nameResolved?this.reEncrypt(e):!1:(t.offset=e,!0)}}class Vt{nameA=4294967295;nameB=4294967295;locale=65535;platform=65535;blockIndex=Ge;load(e){const t=e[2];this.nameA=e[0],this.nameB=e[1],this.locale=t&65535,this.platform=t>>>16,this.blockIndex=e[3]}copy(e){this.nameA=e.nameA,this.nameB=e.nameB,this.locale=e.locale,this.platform=e.platform,this.blockIndex=e.blockIndex}save(e){e[0]=this.nameA,e[1]=this.nameB,e[2]=this.locale<<16|this.platform,e[3]=this.blockIndex}delete(){this.nameA=4294967295,this.nameB=4294967295,this.locale=65535,this.platform=65535,this.blockIndex=z}}class jt{c;entries;constructor(e){this.c=e,this.entries=[],this.addEmpties(4)}clear(){this.entries.length=0}addEmpties(e){for(let t=0;t<e;t++)this.entries.push(new Vt)}getInsertionIndex(e){const t=this.entries,r=this.c.hash(e,Me)&t.length-1;for(let n=0,s=t.length;n<s;n++){const a=(n+r)%s;if(t[a].platform===65535)return a}return-1}add(e,t){const r=this.getInsertionIndex(e);if(r!==-1){const n=this.entries[r];return n.nameA=this.c.hash(e,Re),n.nameB=this.c.hash(e,Fe),n.locale=0,n.platform=0,n.blockIndex=t,n}}load(e){const t=e.byteLength/16,r=new Uint32Array(this.c.decryptBlock(e,De).buffer);let n=0;this.clear(),this.addEmpties(t);for(const s of this.entries)s.load(r.subarray(n,n+4)),n+=4}save(e){const t=new Uint32Array(this.entries.length*4);let r=0;for(const s of this.entries)s.save(t.subarray(r,r+4)),r+=4;const n=new Uint8Array(t.buffer);this.c.encryptBlock(n,De),e.set(n)}get(e){const t=this.c,r=this.entries,n=t.hash(e,Me)&r.length-1,s=t.hash(e,Re),a=t.hash(e,Fe);for(let o=0,h=r.length;o<h;o++){const l=r[(o+n)%h];if(s===l.nameA&&a===l.nameB)return l;if(l.blockIndex===4294967295)return null}return null}}class nt{headerOffset;sectorSize;c;hashTable;blockTable;files;readonly=!1;constructor(){this.headerOffset=0,this.sectorSize=4096,this.c=new Jt,this.hashTable=new jt(this.c),this.blockTable=new Pt(this.c),this.files=[]}load(e,t=!1){const r=Z(e);this.readonly=t;const n=rt(r);if(n===-1)throw new Error("No MPQ header");const s=new Uint32Array(r.buffer,n,8),a=s[3],o=_e(s[4]+n),h=_e(s[5]+n),l=s[6];let u=s[7];u>l&&(u=l),this.headerOffset=n,this.sectorSize=512*(1<<(a>>>16)),this.hashTable.load(r.slice(o,o+l*16)),this.blockTable.load(r.slice(h,h+u*16)),this.files.length=0;for(const m of this.hashTable.entries){const f=m.blockIndex;f<this.blockTable.entries.length&&(this.files[f]=new it(this,m,this.blockTable.entries[f],r,null))}const p=this.get("(listfile)");if(p){const m=p.text();if(m)for(const f of m.split(`\r
`))this.get(f)}}save(){if(this.readonly)return null;const e=32;this.delete("(attributes)"),this.saveMemory(),this.set("(listfile)",this.getFileNames().join(`\r
`));let t=e;for(const f of this.files)if(f){if(!f.offsetChanged(t))return null;f.encode(),t+=f.block.compressedSize}const r=this.hashTable,n=this.blockTable,s=r.entries.length,a=n.entries.length,o=t-e,h=e+o+s*16+a*16,l=e+o,u=l+s*16,p=new Uint8Array(h),m=new Uint32Array(p.buffer,0,8);m[0]=Bt,m[1]=e,m[2]=h,m[3]=Math.log2(this.sectorSize/512)<<16,m[4]=l,m[5]=u,m[6]=s,m[7]=a,t=e;for(const f of this.files)f&&(f.rawBuffer&&p.set(f.rawBuffer,t),t+=f.block.compressedSize);return r.save(p.subarray(t,t+r.entries.length*16)),t+=r.entries.length*16,n.save(p.subarray(t,t+n.entries.length*16)),p}saveMemory(){if(this.readonly)return 0;const e=this.blockTable.entries,t=this.hashTable.entries;let r=e.length,n=0;for(;r--;){const s=e[r];if(s.normalSize===0)this.removeBlock(r),n+=s.compressedSize;else{let a=!1;for(const o of t)if(o.blockIndex===r){a=!0;break}a||(this.removeBlock(r),n+=s.compressedSize)}}return n}removeBlock(e){for(const t of this.hashTable.entries)t.blockIndex<z&&t.blockIndex>e&&(t.blockIndex-=1);this.blockTable.entries.splice(e,1)}getFileNames(){const e=[];for(const t of this.files)t&&t.name!==""&&e.push(t.name);return e}countUnresolved(){let e=0;for(const t of this.files)t.nameResolved||e++;return e}applyListfile(e){for(const t of e)this.get(t)}set(e,t){if(this.readonly)return!1;const r=Z(t);let n=this.get(e);if(n)n.set(r);else{const s=this.blockTable.entries.length,a=this.hashTable.add(e,s);if(!a)return!1;const o=this.blockTable.add(r);n=new it(this,a,o,null,r),n.name=e,n.nameResolved=!0,this.files[s]=n}return!0}get(e){const t=this.hashTable.get(e);if(t){const r=t.blockIndex;if(r<z){const n=this.files[r];if(n)return n.name=e,n.nameResolved=!0,n}}return null}has(e){return!!this.get(e)}delete(e){if(this.readonly)return!1;const t=this.get(e);return t?(t.delete(),!0):!1}rename(e,t){if(this.readonly)return!1;const r=this.get(e);return r?(r.rename(t),!0):!1}resizeHashtable(e){if(this.readonly)return!1;e=Math.max(4,wt(e));const t=this.files;if(t.length>e)return!1;for(const a of t)if(!a.nameResolved)return!1;const r=this.hashTable,n=r.entries,s=n.slice();r.clear(),r.addEmpties(e);for(const a of s)if(a.blockIndex!==Ge){const o=t[a.blockIndex],h=r.getInsertionIndex(o.name);n[h].copy(a)}return!0}}let Wt=class{buffer;index;constructor(e){this.buffer=e,this.index=0}read(){const e=this.buffer,t=e.length;let r=!1,n=!1,s=!1,a="";for(;this.index<t;){const o=e[this.index++];if(r)o===`
`&&(r=!1,this.index--);else if(n){if(o==="\\"?a+=o+e[this.index++]:o===`
`?a+="\\n":o==="\r"?a+="\\r":a+=o,o==='"')return a}else if(s){if(a+=o,o==="'")return a}else if(o===" "||o==="	"){if(a.length)return a}else if(o==="("||o===")"||o==="["||o==="]"||o==="="||o==="\r"||o===`
`||o===","||o==="!"||o==="-"||o==="<"||o===">"||o==="+"||o==="*"||o==="/"){if(a.length)return this.index--,a;{const h=e[this.index];if(o==="="&&h==="=")return this.index++,"==";if(o==="\r")return h===`
`&&this.index++,`
`;if(o==="!"&&h==="=")return this.index++,"!=";if(o==="/"&&h==="/"){if(a.length)return this.index--,a;r=!0}else return o}}else if(o==='"'){if(a.length)return this.index--,a;a+=o,n=!0}else if(o==="'"){if(a.length)return this.index--,a;a+=o,s=!0}else a+=o;if(this.index===t)return a}}peek(){const e=this.index,t=this.read();return this.index=e,t}readSafe(){const e=this.read();if(e===void 0)throw new Error("Premature end of stream reached");return e==="null"?"nil":e==="!="?"~=":e[0]==="'"?`${Tt(e.slice(1,e.indexOf("'",1)))}`:e==="break"||e==="do"||e==="end"||e==="for"||e==="goto"||e==="in"||e==="nil"||e==="repeat"||e==="until"||e==="while"?e+"_":e==="and"||e==="or"?" "+e+" ":e[0]==="$"?"0x"+e.slice(1):e}readUntil(e){let t="",r;for(;(r=this.readSafe())!==e;)t+=r;return t}};class Kt{properties=new Map;sections=new Map;load(e){let t=this.properties;const r=this.sections;for(const n of e.split(`\r
`))if(n.length&&!n.startsWith("//")&&!n.startsWith(";")){let s=n.match(/^\[(.+?)\]/);if(s){const a=s[1].trim();t=r.get(a),t||(t=new Map,r.set(a,t))}else if(s=n.match(/^(.+?)=(.*?)$/),s){let a=s[2];a[0]==='"'&&(a=a.slice(1,-1)),t.set(s[1],a)}}}save(){const e=[];for(const[t,r]of this.properties)e.push(`${t}=${r}`);for(const[t,r]of this.sections){e.push(`[${t}]`);for(const[n,s]of r)e.push(`${n}=${s}`)}return e.join(`\r
`)}getSection(e){return this.sections.get(e)}}class st{types={};functions=[{},{},{},{}];presets={};externalTypes={};externalFunctions=[{},{},{},{}];externalPresets={};addTriggerData(e,t){let r=this.types,n=this.functions,s=this.presets;t&&(r=this.externalTypes,n=this.externalFunctions,s=this.externalPresets);const a=new Kt;a.load(e);let o=a.getSection("TriggerTypes");o&&this.addTriggerTypes(r,o),o=a.getSection("TriggerEvents"),o&&this.addTriggerDataFunctions(n[0],o,1),o=a.getSection("TriggerConditions"),o&&this.addTriggerDataFunctions(n[1],o,1),o=a.getSection("TriggerActions"),o&&this.addTriggerDataFunctions(n[2],o,1),o=a.getSection("TriggerCalls"),o&&this.addTriggerDataFunctions(n[3],o,3),o=a.getSection("TriggerParams"),o&&this.addTriggerDataPresets(s,o)}addTriggerTypes(e,t){for(const[r,n]of t){const s=n.split(",");e[r.toLowerCase()]=s[4]||""}}addTriggerDataFunctions(e,t,r){for(const[n,s]of t)if(n[0]!=="_"){const a=s.split(","),o=[],h=t.get(`_${n}_scriptname`)||null;let l=null;r===3&&(l=a[2]);for(let u=r,p=a.length;u<p;u++){const m=a[u];Number.isNaN(parseFloat(m))&&m!=="nothing"&&m!==""&&o.push(m)}e[n.toLowerCase()]={args:o,scriptName:h,returnType:l}}}addTriggerDataPresets(e,t){for(const[r,n]of t){const s=n.split(",");e[r.toLowerCase()]=s[2].replace(/"/g,"").replace(/`/g,'"')}}addJassFunctions(e){const t=new Wt(e);let r;for(;(r=t.read())!==void 0;)if(r==="native"||r==="function"){const n=t.read();if(n&&(r=t.read(),r==="takes")){const s=[],a=t.readSafe();if(a!=="nothing")for(s.push(a),t.readSafe();t.read()===",";)s.push(t.readSafe()),t.readSafe();else t.read();let o=t.readSafe();o==="nothing"&&(o=null);const h=n.toLowerCase(),l={args:s,scriptName:n,returnType:o};this.externalFunctions[2][h]=l,o!=="nothing"&&(this.externalFunctions[3][h]=l)}}}getBaseType(e){e=e.toLowerCase();let t=this.types[e];return t===void 0&&(t=this.externalTypes[e]),t===""||t===void 0?e:t}isBaseFunction(e,t){return t=t.toLowerCase(),!!this.functions[e][t]}getFunction(e,t){t=t.toLowerCase();let r=this.functions[e][t];return r||(r=this.externalFunctions[e][t]),r}getFunctionType(e){e=e.toLowerCase();const t=this.functions;for(let r=0;r<4;r++)if(t[r][e])return r;return-1}getPreset(e){e=e.toLowerCase();let t=this.presets[e];return t===void 0&&(t=this.externalPresets[e]),t}isCustomPreset(e){if(e=e.toLowerCase(),this.presets[e]!==void 0)return!1;if(this.externalPresets[e]!==void 0)return!0;throw new Error(`Failed to find a preset: ${e}`)}}function Yt(i,e,t=0,r=1/0){const n=Math.max(t,0),s=Math.min(n+r,i.length);for(let a=n;a<s;a++)if(i[a]===e)return a;return-1}const g=new Uint8Array(8);class v{buffer;uint8array;index=0;byteLength;remaining;constructor(e,t,r){const n=Z(e);t=t||0,r=r||n.length,this.buffer=e,this.uint8array=n.subarray(t,t+r),this.byteLength=r,this.remaining=r}substream(e){if(this.remaining<e)throw new Error(`ByteStream: substream: want ${e} bytes but have ${this.remaining}`);const t=this.index;return this.index+=e,new v(this.uint8array.subarray(t,t+e))}skip(e){if(this.remaining<e)throw new Error(`ByteStream: skip: premature end - want ${e} bytes but have ${this.remaining}`);this.index+=e,this.remaining-=e}seek(e){this.index=e,this.remaining=this.byteLength-e}read(e){if(this.remaining<e)throw new Error(`ByteStream: read: premature end - want ${e} bytes but have ${this.remaining}`);const t=this.uint8array,r=this.index;let n=Yt(t,0,r,e);return n===-1&&(n=r+e),this.index+=e,this.remaining-=e,q(t.subarray(r,n))}readNull(){if(this.remaining<1)throw new Error("ByteStream: readNull: premature end - want at least 1 byte but have 0");const e=this.uint8array,t=this.index;let r=e.indexOf(0,t);r===-1&&(r=e.length-1);const n=r-t+1;return this.index+=n,this.remaining-=n,q(e.subarray(t,r))}readBinary(e){if(this.remaining<e)throw new Error(`ByteStream: readBinary: premature end - want ${e} bytes but have ${this.remaining}`);const t=this.uint8array,r=this.index;let n="";for(let s=0;s<e;s++)n+=String.fromCharCode(t[r+s]);return this.index+=e,this.remaining-=e,n}readInt8(){if(this.remaining<1)throw new Error(`ByteStream: readInt8: premature end - want 1 byte but have ${this.remaining}`);const e=this.index,t=this.uint8array,r=be(t[e]);return this.index+=1,this.remaining-=1,r}readInt16(){if(this.remaining<2)throw new Error(`ByteStream: readInt16: premature end - want 2 bytes but have ${this.remaining}`);const e=this.index,t=this.uint8array,r=we(t[e],t[e+1]);return this.index+=2,this.remaining-=2,r}readInt32(){if(this.remaining<4)throw new Error(`ByteStream: readInt32: premature end - want 4 bytes but have ${this.remaining}`);const e=this.index,t=this.uint8array,r=Te(t[e],t[e+1],t[e+2],t[e+3]);return this.index+=4,this.remaining-=4,r}readUint8(){if(this.remaining<1)throw new Error(`ByteStream: readUint8: premature end - want 1 byte but have ${this.remaining}`);const e=this.uint8array[this.index];return this.index+=1,this.remaining-=1,e}readUint16(){if(this.remaining<2)throw new Error(`ByteStream: readUint16: premature end - want 2 bytes but have ${this.remaining}`);const e=this.index,t=this.uint8array,r=Be(t[e],t[e+1]);return this.index+=2,this.remaining-=2,r}readUint32(){if(this.remaining<4)throw new Error(`ByteStream: readUint32: premature end - want 4 bytes but have ${this.remaining}`);const e=this.index,t=this.uint8array,r=Ie(t[e],t[e+1],t[e+2],t[e+3]);return this.index+=4,this.remaining-=4,r}readFloat32(){if(this.remaining<4)throw new Error(`ByteStream: readFloat32: premature end - want 4 bytes but have ${this.remaining}`);const e=this.index,t=this.uint8array,r=ve(t[e],t[e+1],t[e+2],t[e+3]);return this.index+=4,this.remaining-=4,r}readFloat64(){if(this.remaining<8)throw new Error(`ByteStream: readFloat64: premature end - want 8 bytes but have ${this.remaining}`);const e=this.index,t=this.uint8array,r=Ae(t[e],t[e+1],t[e+2],t[e+3],t[e+4],t[e+5],t[e+6],t[e+7]);return this.index+=8,this.remaining-=8,r}readInt8Array(e){if(ArrayBuffer.isView(e)||(e=new Int8Array(e)),this.remaining<e.byteLength)throw new Error(`ByteStream: readInt8Array: premature end - want ${e.byteLength} bytes but have ${this.remaining}`);const t=this.index,r=this.uint8array;for(let n=0,s=e.length;n<s;n++)e[n]=be(r[t+n]);return this.index+=e.byteLength,this.remaining-=e.byteLength,e}readInt16Array(e){if(ArrayBuffer.isView(e)||(e=new Int16Array(e)),this.remaining<e.byteLength)throw new Error(`ByteStream: readInt16Array: premature end - want ${e.byteLength} bytes but have ${this.remaining}`);const t=this.index,r=this.uint8array;for(let n=0,s=e.length;n<s;n++){const a=t+n*2;e[n]=we(r[a],r[a+1])}return this.index+=e.byteLength,this.remaining-=e.byteLength,e}readInt32Array(e){if(ArrayBuffer.isView(e)||(e=new Int32Array(e)),this.remaining<e.byteLength)throw new Error(`ByteStream: readInt32Array: premature end - want ${e.byteLength} bytes but have ${this.remaining}`);const t=this.index,r=this.uint8array;for(let n=0,s=e.length;n<s;n++){const a=t+n*4;e[n]=Te(r[a],r[a+1],r[a+2],r[a+3])}return this.index+=e.byteLength,this.remaining-=e.byteLength,e}readUint8Array(e){if(ArrayBuffer.isView(e)||(e=new Uint8Array(e)),this.remaining<e.byteLength)throw new Error(`ByteStream: readUint8Array: premature end - want ${e.byteLength} bytes but have ${this.remaining}`);const t=this.index,r=this.uint8array;for(let n=0,s=e.length;n<s;n++)e[n]=r[t+n];return this.index+=e.byteLength,this.remaining-=e.byteLength,e}readUint16Array(e){if(ArrayBuffer.isView(e)||(e=new Uint16Array(e)),this.remaining<e.byteLength)throw new Error(`ByteStream: readUint16Array: premature end - want ${e.byteLength} bytes but have ${this.remaining}`);const t=this.index,r=this.uint8array;for(let n=0,s=e.length;n<s;n++){const a=t+n*2;e[n]=Be(r[a],r[a+1])}return this.index+=e.byteLength,this.remaining-=e.byteLength,e}readUint32Array(e){if(ArrayBuffer.isView(e)||(e=new Uint32Array(e)),this.remaining<e.byteLength)throw new Error(`ByteStream: readUint32Array: premature end - want ${e.byteLength} bytes but have ${this.remaining}`);const t=this.index,r=this.uint8array;for(let n=0,s=e.length;n<s;n++){const a=t+n*4;e[n]=Ie(r[a],r[a+1],r[a+2],r[a+3])}return this.index+=e.byteLength,this.remaining-=e.byteLength,e}readFloat32Array(e){if(ArrayBuffer.isView(e)||(e=new Float32Array(e)),this.remaining<e.byteLength)throw new Error(`ByteStream: readFloat32Array: premature end - want ${e.byteLength} bytes but have ${this.remaining}`);const t=this.index,r=this.uint8array;for(let n=0,s=e.length;n<s;n++){const a=t+n*4;e[n]=ve(r[a],r[a+1],r[a+2],r[a+3])}return this.index+=e.byteLength,this.remaining-=e.byteLength,e}readFloat64Array(e){if(ArrayBuffer.isView(e)||(e=new Float64Array(e)),this.remaining<e.byteLength)throw new Error(`ByteStream: readFloat64Array: premature end - want ${e.byteLength} bytes but have ${this.remaining}`);const t=this.index,r=this.uint8array;for(let n=0,s=e.length;n<s;n++){const a=t+n*8;e[n]=Ae(r[a],r[a+1],r[a+2],r[a+3],r[a+4],r[a+5],r[a+6],r[a+7])}return this.index+=e.byteLength,this.remaining-=e.byteLength,e}write(e){const t=ue(e);return this.writeUint8Array(t),t.length}writeNull(e){const t=this.write(e);return this.index++,this.remaining--,t+1}writeBinary(e){const t=this.index,r=this.uint8array,n=e.length;for(let s=0;s<n;s++)r[t+s]=e.charCodeAt(s);this.index+=n}writeInt8(e){this.uint8array[this.index]=Ee(e),this.index+=1}writeInt16(e){const t=this.index,r=this.uint8array;Le(g,e),r[t]=g[0],r[t+1]=g[1],this.index+=2}writeInt32(e){const t=this.index,r=this.uint8array;Ce(g,e),r[t]=g[0],r[t+1]=g[1],r[t+2]=g[2],r[t+3]=g[3],this.index+=4}writeUint8(e){this.uint8array[this.index]=e,this.index+=1}writeUint16(e){const t=this.index,r=this.uint8array;Ue(g,e),r[t]=g[0],r[t+1]=g[1],this.index+=2}writeUint32(e){const t=this.index,r=this.uint8array;xe(g,e),r[t]=g[0],r[t+1]=g[1],r[t+2]=g[2],r[t+3]=g[3],this.index+=4}writeFloat32(e){const t=this.index,r=this.uint8array;Pe(g,e),r[t]=g[0],r[t+1]=g[1],r[t+2]=g[2],r[t+3]=g[3],this.index+=4}writeFloat64(e){const t=this.index,r=this.uint8array;Je(g,e),r[t]=g[0],r[t+1]=g[1],r[t+2]=g[2],r[t+3]=g[3],r[t+4]=g[4],r[t+5]=g[5],r[t+6]=g[6],r[t+7]=g[7],this.index+=8}writeInt8Array(e){const t=this.index,r=this.uint8array;for(let n=0,s=e.length;n<s;n++)r[t+n]=Ee(e[n]);this.index+=e.byteLength}writeInt16Array(e){const t=this.index,r=this.uint8array;for(let n=0,s=e.length;n<s;n++){const a=t+n*2;Le(g,e[n]),r[a]=g[0],r[a+1]=g[1]}this.index+=e.byteLength}writeInt32Array(e){const t=this.index,r=this.uint8array;for(let n=0,s=e.length;n<s;n++){const a=t+n*4;Ce(g,e[n]),r[a]=g[0],r[a+1]=g[1],r[a+2]=g[2],r[a+3]=g[3]}this.index+=e.byteLength}writeUint8Array(e){const t=this.index,r=this.uint8array;for(let n=0,s=e.length;n<s;n++)r[t+n]=e[n];this.index+=e.byteLength}writeUint16Array(e){const t=this.index,r=this.uint8array;for(let n=0,s=e.length;n<s;n++){const a=t+n*2;Ue(g,e[n]),r[a]=g[0],r[a+1]=g[1]}this.index+=e.byteLength}writeUint32Array(e){const t=this.index,r=this.uint8array;for(let n=0,s=e.length;n<s;n++){const a=t+n*4;xe(g,e[n]),r[a]=g[0],r[a+1]=g[1],r[a+2]=g[2],r[a+3]=g[3]}this.index+=e.byteLength}writeFloat32Array(e){const t=this.index,r=this.uint8array;for(let n=0,s=e.length;n<s;n++){const a=t+n*4;Pe(g,e[n]),r[a]=g[0],r[a+1]=g[1],r[a+2]=g[2],r[a+3]=g[3]}this.index+=e.byteLength}writeFloat64Array(e){const t=this.index,r=this.uint8array;for(let n=0,s=e.length;n<s;n++){const a=t+n*8;Je(g,e[n]),r[a]=g[0],r[a+1]=g[1],r[a+2]=g[2],r[a+3]=g[3],r[a+4]=g[4],r[a+5]=g[5],r[a+6]=g[6],r[a+7]=g[7]}this.index+=e.byteLength}}class at{isCustom=0;path="";load(e){this.isCustom=e.readUint8(),this.path=e.readNull()}save(e){e.writeUint8(this.isCustom),e.writeNull(this.path)}getByteLength(){return 2+T(this.path)}}class Qt{version=1;entries=new Map;load(e){const t=new v(e);this.version=t.readUint32();for(let r=0,n=t.readUint32();r<n;r++){const s=new at;s.load(t),s.isCustom?this.entries.set(s.path,s):this.entries.set(`war3mapimported\\${s.path}`,s)}}save(){const e=new v(new ArrayBuffer(this.getByteLength()));e.writeUint32(this.version),e.writeUint32(this.entries.size);for(const t of this.entries.values())t.save(e);return e.uint8array}getByteLength(){let e=8;for(const t of this.entries.values())e+=t.getByteLength();return e}set(e){if(!this.entries.has(e)){const t=new at;return t.isCustom=10,t.path=e,this.entries.set(e,t),!0}return!1}has(e){return this.entries.has(e)}delete(e){return this.entries.delete(e)}rename(e,t){const r=this.entries.get(e);return r?(r.isCustom=10,r.path=t,!0):!1}}class Xt{id="\0\0\0\0";variableType=0;levelOrVariation=0;dataPointer=0;value=0;u1=0;load(e,t){if(this.id=e.readBinary(4),this.variableType=e.readInt32(),t&&(this.levelOrVariation=e.readInt32(),this.dataPointer=e.readInt32()),this.variableType===0)this.value=e.readInt32();else if(this.variableType===1||this.variableType===2)this.value=e.readFloat32();else if(this.variableType===3)this.value=e.readNull();else throw new Error(`Modification: unknown variable type ${this.variableType}`);this.u1=e.readInt32()}save(e,t){if(e.writeBinary(this.id),e.writeInt32(this.variableType),t&&(e.writeInt32(this.levelOrVariation),e.writeInt32(this.dataPointer)),this.variableType===0)e.writeInt32(this.value);else if(this.variableType===1||this.variableType===2)e.writeFloat32(this.value);else if(this.variableType===3)e.writeNull(this.value);else throw new Error(`Modification: unknown variable type ${this.variableType}`);e.writeInt32(this.u1)}getByteLength(e){let t=12;return e&&(t+=8),this.variableType===3?t+=T(this.value)+1:t+=4,t}}class qt{oldId="\0\0\0\0";newId="\0\0\0\0";sets=1;setsFlag=[];modifications=[];load(e,t,r){this.oldId=e.readBinary(4),this.newId=e.readBinary(4),r>=3&&(this.sets=e.readUint32());for(let n=0;n<this.sets;n++){r>=3&&(this.setsFlag[n]=e.readUint32());for(let s=0,a=e.readUint32();s<a;s++){const o=new Xt;o.load(e,t),this.modifications[s]=o}}}save(e,t,r){this.oldId!=="\0\0\0\0"?e.writeBinary(this.oldId):e.writeUint32(0),this.newId!=="\0\0\0\0"?e.writeBinary(this.newId):e.writeUint32(0),r>=3&&e.writeUint32(this.sets),e.writeUint32(this.modifications.length);for(let n=0;n<this.sets;n++){r>=3&&e.writeUint32(this.setsFlag[n]);for(const s of this.modifications)s.save(e,t)}}getByteLength(e,t){let r=t>=3?16:12;for(let n=0;n<this.sets;n++){t>=3&&(r+=4);for(const s of this.modifications)r+=s.getByteLength(e)}return r}}class W{objects=[];load(e,t,r){for(let n=0,s=e.readUint32();n<s;n++){const a=new qt;a.load(e,t,r),this.objects[n]=a}}save(e,t,r){e.writeUint32(this.objects.length);for(const n of this.objects)n.save(e,t,r)}getByteLength(e,t){let r=4;for(const n of this.objects)r+=n.getByteLength(e,t);return r}}class Zt{version=0;originalTable=new W;customTable=new W;load(e){let t;e instanceof v?t=e:t=new v(e),this.version=t.readInt32(),this.originalTable.load(t,!0,this.version),this.customTable.load(t,!0,this.version)}save(){const e=new v(new ArrayBuffer(this.getByteLength()));return e.writeInt32(this.version),this.originalTable.save(e,!0,this.version),this.customTable.save(e,!0,this.version),e.uint8array}getByteLength(){return 4+this.originalTable.getByteLength(!0,this.version)+this.customTable.getByteLength(!0,this.version)}}class er{version=0;originalTable=new W;customTable=new W;load(e){let t;e instanceof v?t=e:t=new v(e),this.version=t.readInt32(),this.originalTable.load(t,!1,this.version),this.customTable.load(t,!1,this.version)}save(){const e=new v(new ArrayBuffer(this.getByteLength()));return e.writeInt32(this.version),this.originalTable.save(e,!1,this.version),this.customTable.save(e,!1,this.version),e.uint8array}getByteLength(){return 4+this.originalTable.getByteLength(!1,this.version)+this.customTable.getByteLength(!1,this.version)}}class K{text="";load(e){const t=e.readInt32();t&&(this.text=e.read(t-1),e.skip(1))}save(e){this.text.length?(e.writeInt32(T(this.text)+1),e.write(this.text),e.skip(1)):e.writeInt32(0)}getByteLength(){let e=4;return this.text.length&&(e+=T(this.text)+1),e}}class tr{version=0;comment="";trigger=new K;triggers=[];load(e){const t=new v(e);this.version=t.readInt32(),this.version===1&&(this.comment=t.readNull(),this.trigger.load(t));for(let r=0,n=t.readUint32();r<n;r++){const s=new K;s.load(t),this.triggers[r]=s}}save(){const e=new v(new ArrayBuffer(this.getByteLength()));e.writeInt32(this.version),this.version===1&&(e.writeNull(this.comment),this.trigger.save(e)),e.writeUint32(this.triggers.length);for(const t of this.triggers)t.save(e);return e.uint8array}getByteLength(){let e=8;this.version===1&&(e+=T(this.comment)+1+this.trigger.getByteLength());for(const t of this.triggers)e+=t.getByteLength();return e}}class rr{id=0;name="";isComment=0;load(e,t){this.id=e.readInt32(),this.name=e.readNull(),t===7&&(this.isComment=e.readInt32())}save(e,t){e.writeInt32(this.id),e.writeNull(this.name),t===7&&e.writeInt32(this.isComment)}getByteLength(e){let t=5+T(this.name);return e===7&&(t+=4),t}}class ir{name="";type="";u1=0;isArray=0;arraySize=0;isInitialized=0;initialValue="";load(e,t){this.name=e.readNull(),this.type=e.readNull(),this.u1=e.readInt32(),this.isArray=e.readInt32(),t===7&&(this.arraySize=e.readInt32()),this.isInitialized=e.readInt32(),this.initialValue=e.readNull()}save(e,t){e.writeNull(this.name),e.writeNull(this.type),e.writeInt32(this.u1),e.writeInt32(this.isArray),t===7&&e.writeInt32(this.arraySize),e.writeInt32(this.isInitialized),e.writeNull(this.initialValue)}getByteLength(e){let t=15+T(this.name)+T(this.type)+T(this.initialValue);return e===7&&(t+=4),t}}class ${type=0;name="";beginParameters=0;parameters=[];load(e,t,r){if(this.type=e.readInt32(),this.type<0||this.type>3)throw new Error(`SubParameters: Bad type: ${this.type}`);if(this.name=e.readNull(),this.name.length===0)throw new Error("SubParameters: Empty name");if(this.beginParameters=e.readInt32(),this.beginParameters){const n=r.getFunction(this.type,this.name);if(!n)throw new Error(`SubParameters "${this.name}:${this.type}": Unknown signature`);const s=n.args;for(let a=0,o=s.length;a<o;a++){const h=new U;try{h.load(e,t,r)}catch(l){throw new Error(`SubParameters "${this.name}": Parameter ${a}: ${l}`)}this.parameters[a]=h}}}save(e,t){e.writeInt32(this.type),e.writeNull(this.name),e.writeInt32(this.beginParameters);for(const r of this.parameters)r.save(e,t)}getByteLength(e){let t=9+T(this.name);if(this.parameters.length)for(const r of this.parameters)t+=r.getByteLength(e);return t}}class U{type=0;value="";subParameters=null;u1=0;isArray=0;arrayIndex=null;load(e,t,r){if(this.type=e.readInt32(),this.type<-1||this.type>3)throw new Error(`Parameter: Bad type: ${this.type}`);if(this.value=e.readNull(),e.readInt32()){const n=new $;try{n.load(e,t,r)}catch(s){throw new Error(`Parameter "${this.value}": SubParameters ${s}`)}this.subParameters=n}if((t===4&&this.type===2||t===7&&this.subParameters)&&(this.u1=e.readInt32()),(t===4&&this.type!==2||t===7)&&(this.isArray=e.readInt32()),this.isArray){const n=new U;try{n.load(e,t,r)}catch(s){throw new Error(`Parameter "${this.value}": ArrayIndex: ${s}`)}this.arrayIndex=n}}save(e,t){e.writeInt32(this.type),e.writeNull(this.value),this.subParameters?(e.writeInt32(1),this.subParameters.save(e,t)):e.writeInt32(0),(t===4&&this.type===2||t===7&&this.subParameters)&&e.writeInt32(this.u1),(t===4&&this.type!==2||t===7)&&e.writeInt32(this.isArray),this.isArray&&this.arrayIndex&&this.arrayIndex.save(e,t)}getByteLength(e){let t=9+T(this.value);return this.subParameters&&(t+=this.subParameters.getByteLength(e)),(e===4&&this.type===2||e===7&&this.subParameters)&&(t+=4),(e===4&&this.type!==2||e===7)&&(t+=4),this.isArray&&this.arrayIndex&&(t+=this.arrayIndex.getByteLength(e)),t}}class J{type=-1;group=-1;name="";isEnabled=0;parameters=[];ecas=[];load(e,t,r,n){if(this.type=e.readInt32(),this.type<0||this.type>3)throw new Error(`ECA: Bad type: ${this.type}`);if(r&&(this.group=e.readUint32()),this.name=e.readNull(),this.name.length===0)throw new Error("ECA: Empty name");this.isEnabled=e.readInt32();const s=n.getFunction(this.type,this.name);if(!s)throw new Error(`ECA "${this.name}:${this.type}": Unknown signature`);const a=s.args;for(let o=0,h=a.length;o<h;o++){const l=new U;try{l.load(e,t,n)}catch(u){throw new Error(`ECA "${this.name}": Parameter ${o}: ${u}`)}this.parameters[o]=l}if(t===7)for(let o=0,h=e.readUint32();o<h;o++){const l=new J;try{l.load(e,t,!0,n)}catch(u){throw new Error(`ECA "${this.name}": Child ECA ${o} ${u}`)}this.ecas[o]=l}}save(e,t){e.writeInt32(this.type),this.group!==-1&&e.writeInt32(this.group),e.writeNull(this.name),e.writeInt32(this.isEnabled);for(const r of this.parameters)r.save(e,t);if(t===7){e.writeUint32(this.ecas.length);for(const r of this.ecas)r.save(e,t)}}getByteLength(e){let t=9+T(this.name);this.group!==-1&&(t+=4);for(const r of this.parameters)t+=r.getByteLength(e);if(e===7){t+=4;for(const r of this.ecas)t+=r.getByteLength(e)}return t}}class ie{name="";description="";isComment=0;isEnabled=0;isCustom=0;isInitiallyOff=0;runOnInitialization=0;category=0;ecas=[];load(e,t,r){this.name=e.readNull(),this.description=e.readNull(),t===7&&(this.isComment=e.readInt32()),this.isEnabled=e.readInt32(),this.isCustom=e.readInt32(),this.isInitiallyOff=e.readInt32(),this.runOnInitialization=e.readInt32(),this.category=e.readInt32();for(let n=0,s=e.readUint32();n<s;n++){const a=new J;try{a.load(e,t,!1,r)}catch(o){throw new Error(`Trigger "${this.name}": ECA ${n}: ${o}`)}this.ecas[n]=a}}save(e,t){e.writeNull(this.name),e.writeNull(this.description),t===7&&e.writeInt32(this.isComment),e.writeInt32(this.isEnabled),e.writeInt32(this.isCustom),e.writeInt32(this.isInitiallyOff),e.writeInt32(this.runOnInitialization),e.writeInt32(this.category),e.writeUint32(this.ecas.length);for(const r of this.ecas)r.save(e,t)}getByteLength(e){let t=26+T(this.name)+T(this.description);e===7&&(t+=4);for(const r of this.ecas)t+=r.getByteLength(e);return t}}class nr{version=0;categories=[];u1=0;variables=[];triggers=[];load(e,t){const r=new v(e);if(r.readBinary(4)!=="WTG!")throw new Error("Not a WTG file");this.version=r.readInt32();for(let n=0,s=r.readUint32();n<s;n++){const a=new rr;a.load(r,this.version),this.categories[n]=a}this.u1=r.readInt32();for(let n=0,s=r.readUint32();n<s;n++){const a=new ir;a.load(r,this.version),this.variables[n]=a}for(let n=0,s=r.readUint32();n<s;n++){const a=new ie;try{a.load(r,this.version,t)}catch(o){throw new Error(`Trigger ${n}: ${o}`)}this.triggers[n]=a}}save(){const e=new v(new ArrayBuffer(this.getByteLength()));e.writeBinary("WTG!"),e.writeInt32(this.version),e.writeUint32(this.categories.length);for(const t of this.categories)t.save(e,this.version);e.writeInt32(this.u1),e.writeUint32(this.variables.length);for(const t of this.variables)t.save(e,this.version);e.writeUint32(this.triggers.length);for(const t of this.triggers)t.save(e,this.version);return e.uint8array}getByteLength(){let e=24;const t=this.version;for(const r of this.categories)e+=r.getByteLength(t);for(const r of this.variables)e+=r.getByteLength(t);for(const r of this.triggers)e+=r.getByteLength(t);return e}}class sr{buffer;index=0;ident=0;indentSpaces=4;precision=1e6;constructor(e){this.buffer=e||""}clear(){this.buffer="",this.index=0,this.ident=0}readToken(){const e=this.buffer,t=e.length;let r=!1,n=!1,s="";for(;this.index<t;){const a=e[this.index++];if(r)a===`
`&&(r=!1);else if(n)if(a==="\\")s+=a+e[this.index++];else if(a===`
`)s+="\\n";else if(a==="\r")s+="\\r";else{if(a==='"')return s;s+=a}else if(a===" "||a===","||a==="	"||a===`
`||a===":"||a==="\r"){if(s.length)return s}else{if(a==="{"||a==="}")return s.length?(this.index--,s):a;if(a==="/"&&e[this.index]==="/"){if(s.length)return this.index--,s;r=!0}else if(a==='"'){if(s.length)return this.index--,s;n=!0}else s+=a}}}read(){const e=this.readToken();if(e===void 0)throw new Error("End of stream reached prematurely");return e}peek(){const e=this.index,t=this.read();return this.index=e,t}readInt(){return parseInt(this.read())}readFloat(){return parseFloat(this.read())}readVector(e){this.read();for(let t=0,r=e.length;t<r;t++)e[t]=this.readFloat();return this.read(),e}readVectorsBlock(e,t){this.read();for(let r=0,n=e.length;r<n;r+=t)this.readVector(e.subarray(r,r+t));return this.read(),e}readColor(e){return this.read(),e[2]=this.readFloat(),e[1]=this.readFloat(),e[0]=this.readFloat(),this.read(),e}*readBlock(){this.read();let e=this.read();for(;e!=="}";)yield e,e=this.read()}writeLine(e){this.buffer+=`${" ".repeat(this.ident*this.indentSpaces)}${e}
`}writeFlag(e){this.writeLine(`${e},`)}writeFlagAttrib(e,t){this.writeLine(`${e} ${t},`)}writeNumberAttrib(e,t){this.writeLine(`${e} ${this.floatDecimals(t)},`)}writeStringAttrib(e,t){this.writeLine(`${e} "${t}",`)}writeVectorAttrib(e,t){this.writeLine(`${e} { ${this.floatArrayDecimals(t)} },`)}writeColor(e,t){const r=this.floatDecimals(t[0]),n=this.floatDecimals(t[1]),s=this.floatDecimals(t[2]);this.writeLine(`${e} { ${s}, ${n}, ${r} },`)}writeVector(e){this.writeLine(`{ ${this.floatArrayDecimals(e)} },`)}writeVectorArrayBlock(e,t,r){this.startBlock(e,t.length/r);for(let n=0,s=t.length;n<s;n+=r)this.writeVector(t.subarray(n,n+r));this.endBlock()}startBlock(e,...t){t.length&&(e=`${e} ${t.join(" ")}`),this.writeLine(`${e} {`),this.ident+=1}startObjectBlock(e,t){this.writeLine(`${e} "${t.replace(/"/g,'\\"')}" {`),this.ident+=1}endBlock(){this.ident-=1,this.writeLine("}")}endBlockComma(){this.ident-=1,this.writeLine("},")}indent(){this.ident+=1}unindent(){this.ident-=1}floatDecimals(e){return`${Math.trunc(e*this.precision)/this.precision}`}floatArrayDecimals(e){if(e instanceof Float32Array){const t=[];for(let r=0,n=e.length;r<n;r++)t[r]=this.floatDecimals(e[r]);return t.join(", ")}else return e.join(", ")}}class ar{stringMap=new Map;load(e){const t=new sr(e);let r;const n=e.indexOf("STRING");if(n===-1)throw new Error("Not a valid war3map.wts buffer");for(t.index=n;r=t.readToken();)if(r==="STRING"){const s=t.readInt();t.read();const a=e.indexOf("}",t.index);if(a===-1)throw this.stringMap.set(s,e.slice(t.index,e.length).trim()),new Error(`WTS: missing data in string ${this.stringMap.size} (and maybe more)`);this.stringMap.set(s,e.slice(t.index,a).trim()),t.index=a}}save(){let e="";for(const[t,r]of this.stringMap)e+=`STRING ${t}\r
{\r
${r}\r
}\r
\r
`;return e}getString(e){if(typeof e=="string"){if(e.startsWith("TRIGSTR_"))return this.stringMap.get(parseInt(e.slice(8)))}else return this.stringMap.get(e)}setString(e,t){typeof e=="string"?e.startsWith("TRIGSTR_")&&this.stringMap.set(parseInt(e.slice(8)),t):this.stringMap.set(e,t)}}class or{flags=0;playerMasks=0;name="";load(e){this.flags=e.readUint32(),this.playerMasks=e.readUint32(),this.name=e.readNull()}save(e){e.writeUint32(this.flags),e.writeUint32(this.playerMasks),e.writeNull(this.name)}getByteLength(){return 9+T(this.name)}}class lr{id=0;type=0;race=0;isFixedStartPosition=0;name="";startLocation=new Float32Array(2);allyLowPriorities=0;allyHighPriorities=0;unknown1=new Uint8Array(8);load(e,t){this.id=e.readInt32(),this.type=e.readInt32(),this.race=e.readInt32(),this.isFixedStartPosition=e.readInt32(),this.name=e.readNull(),e.readFloat32Array(this.startLocation),this.allyLowPriorities=e.readUint32(),this.allyHighPriorities=e.readUint32(),t>30&&e.readUint8Array(this.unknown1)}save(e,t){e.writeInt32(this.id),e.writeInt32(this.type),e.writeInt32(this.race),e.writeInt32(this.isFixedStartPosition),e.writeNull(this.name),e.writeFloat32Array(this.startLocation),e.writeUint32(this.allyLowPriorities),e.writeUint32(this.allyHighPriorities),t>30&&e.writeUint8Array(this.unknown1)}getByteLength(e){let t=33+T(this.name);return e>30&&(t+=8),t}}class hr{chance=0;id="\0\0\0\0";load(e){this.chance=e.readInt32(),this.id=e.readBinary(4)}save(e){e.writeInt32(this.chance),e.writeBinary(this.id)}}class cr{items=[];load(e){for(let t=0,r=e.readUint32();t<r;t++){const n=new hr;n.load(e),this.items[t]=n}}save(e){e.writeUint32(this.items.length);for(const t of this.items)t.save(e)}getByteLength(){return 4+this.items.length*8}}class dr{id=0;name="";sets=[];load(e){this.id=e.readInt32(),this.name=e.readNull();for(let t=0,r=e.readUint32();t<r;t++){const n=new cr;n.load(e),this.sets[t]=n}}save(e){e.writeInt32(this.id),e.writeNull(this.name),e.writeUint32(this.sets.length);for(const t of this.sets)t.save(e)}getByteLength(){let e=9+T(this.name);for(const t of this.sets)e+=t.getByteLength();return e}}class ur{chance=0;ids=[];load(e,t){this.chance=e.readInt32();for(let r=0;r<t;r++)this.ids[r]=e.readBinary(4)}save(e){e.writeInt32(this.chance);for(const t of this.ids)e.writeBinary(t)}}class fr{id=0;name="";positions=0;columnTypes=new Int32Array(0);units=[];load(e){this.id=e.readInt32(),this.name=e.readNull(),this.positions=e.readInt32(),this.columnTypes=e.readInt32Array(this.positions);for(let t=0,r=e.readUint32();t<r;t++){const n=new ur;n.load(e,this.positions),this.units[t]=n}}save(e){e.writeInt32(this.id),e.writeNull(this.name),e.writeInt32(this.positions),e.writeInt32Array(this.columnTypes),e.writeUint32(this.units.length);for(const t of this.units)t.save(e)}getByteLength(){return 13+T(this.name)+this.columnTypes.byteLength+this.units.length*(4+4*this.positions)}}class gr{playerFlags=0;id="\0\0\0\0";load(e){this.playerFlags=e.readUint32(),this.id=e.readBinary(4)}save(e){e.writeUint32(this.playerFlags),e.writeBinary(this.id)}}class pr{playerFlags=0;id="\0\0\0\0";levelAffected=0;availability=0;load(e){this.playerFlags=e.readUint32(),this.id=e.readBinary(4),this.levelAffected=e.readInt32(),this.availability=e.readInt32()}save(e){e.writeUint32(this.playerFlags),e.writeBinary(this.id),e.writeInt32(this.levelAffected),e.writeInt32(this.availability)}}class mr{version=0;saves=0;editorVersion=0;buildVersion=new Uint32Array(4);name="";author="";description="";recommendedPlayers="";cameraBounds=new Float32Array(8);cameraBoundsComplements=new Int32Array(4);playableSize=new Int32Array(2);flags=0;tileset="A";campaignBackground=0;loadingScreenModel="";loadingScreenText="";loadingScreenTitle="";loadingScreenSubtitle="";loadingScreen=0;prologueScreenModel="";prologueScreenText="";prologueScreenTitle="";prologueScreenSubtitle="";useTerrainFog=0;fogHeight=new Float32Array(2);fogDensity=0;fogColor=new Uint8Array(4);globalWeather=0;soundEnvironment="";lightEnvironmentTileset="\0";waterVertexColor=new Uint8Array(4);scriptMode=0;graphicsMode=0;defaultCameraZoom=0;maxCameraZoom=0;minCameraZoom=0;players=[];forces=[];upgradeAvailabilityChanges=[];techAvailabilityChanges=[];randomUnitTables=[];randomItemTables=[];unknown1=0;load(e){const t=new v(e);this.version=t.readInt32(),this.saves=t.readInt32(),this.editorVersion=t.readInt32(),this.version>27&&t.readUint32Array(this.buildVersion),this.name=t.readNull(),this.author=t.readNull(),this.description=t.readNull(),this.recommendedPlayers=t.readNull(),t.readFloat32Array(this.cameraBounds),t.readInt32Array(this.cameraBoundsComplements),t.readInt32Array(this.playableSize),this.flags=t.readUint32(),this.tileset=t.readBinary(1),this.campaignBackground=t.readInt32(),this.version>24&&(this.loadingScreenModel=t.readNull()),this.loadingScreenText=t.readNull(),this.loadingScreenTitle=t.readNull(),this.loadingScreenSubtitle=t.readNull(),this.loadingScreen=t.readInt32(),this.version>24&&(this.prologueScreenModel=t.readNull()),this.prologueScreenText=t.readNull(),this.prologueScreenTitle=t.readNull(),this.prologueScreenSubtitle=t.readNull(),this.version>24&&(this.useTerrainFog=t.readInt32(),t.readFloat32Array(this.fogHeight),this.fogDensity=t.readFloat32(),t.readUint8Array(this.fogColor),this.globalWeather=t.readInt32(),this.soundEnvironment=t.readNull(),this.lightEnvironmentTileset=t.readBinary(1),t.readUint8Array(this.waterVertexColor)),this.version>27&&(this.scriptMode=t.readUint32()),this.version>30&&(this.graphicsMode=t.readUint32(),this.unknown1=t.readUint32()),this.version>32&&(this.defaultCameraZoom=t.readUint32(),this.maxCameraZoom=t.readUint32(),this.minCameraZoom=t.readUint32());for(let r=0,n=t.readInt32();r<n;r++){const s=new lr;s.load(t,this.version),this.players[r]=s}for(let r=0,n=t.readInt32();r<n;r++){const s=new or;s.load(t),this.forces[r]=s}for(let r=0,n=t.readInt32();r<n;r++){const s=new pr;s.load(t),this.upgradeAvailabilityChanges[r]=s}for(let r=0,n=t.readInt32();r<n;r++){const s=new gr;s.load(t),this.techAvailabilityChanges[r]=s}for(let r=0,n=t.readInt32();r<n;r++){const s=new fr;s.load(t),this.randomUnitTables[r]=s}if(this.version>24)for(let r=0,n=t.readInt32();r<n;r++){const s=new dr;s.load(t),this.randomItemTables[r]=s}}save(){const e=new v(new ArrayBuffer(this.getByteLength()));e.writeInt32(this.version),e.writeInt32(this.saves),e.writeInt32(this.editorVersion),this.version>27&&e.writeUint32Array(this.buildVersion),e.writeNull(this.name),e.writeNull(this.author),e.writeNull(this.description),e.writeNull(this.recommendedPlayers),e.writeFloat32Array(this.cameraBounds),e.writeInt32Array(this.cameraBoundsComplements),e.writeInt32Array(this.playableSize),e.writeUint32(this.flags),e.writeBinary(this.tileset),e.writeInt32(this.campaignBackground),this.version>24&&e.writeNull(this.loadingScreenModel),e.writeNull(this.loadingScreenText),e.writeNull(this.loadingScreenTitle),e.writeNull(this.loadingScreenSubtitle),e.writeInt32(this.loadingScreen),this.version>24&&e.writeNull(this.prologueScreenModel),e.writeNull(this.prologueScreenText),e.writeNull(this.prologueScreenTitle),e.writeNull(this.prologueScreenSubtitle),this.version>24&&(e.writeInt32(this.useTerrainFog),e.writeFloat32Array(this.fogHeight),e.writeFloat32(this.fogDensity),e.writeUint8Array(this.fogColor),e.writeInt32(this.globalWeather),e.writeNull(this.soundEnvironment),e.writeBinary(this.lightEnvironmentTileset),e.writeUint8Array(this.waterVertexColor)),this.version>27&&e.writeUint32(this.scriptMode),this.version>30&&(e.writeUint32(this.graphicsMode),e.writeUint32(this.unknown1)),this.version>32&&(e.writeUint32(this.defaultCameraZoom),e.writeUint32(this.maxCameraZoom),e.writeUint32(this.minCameraZoom)),e.writeUint32(this.players.length);for(const t of this.players)t.save(e,this.version);e.writeUint32(this.forces.length);for(const t of this.forces)t.save(e);e.writeUint32(this.upgradeAvailabilityChanges.length);for(const t of this.upgradeAvailabilityChanges)t.save(e);e.writeUint32(this.techAvailabilityChanges.length);for(const t of this.techAvailabilityChanges)t.save(e);e.writeUint32(this.randomUnitTables.length);for(const t of this.randomUnitTables)t.save(e);if(this.version>24){e.writeUint32(this.randomItemTables.length);for(const t of this.randomItemTables)t.save(e)}return e.uint8array}getByteLength(){let e=111+T(this.name)+T(this.author)+T(this.description)+T(this.recommendedPlayers)+T(this.loadingScreenText)+T(this.loadingScreenTitle)+T(this.loadingScreenSubtitle)+T(this.prologueScreenText)+T(this.prologueScreenTitle)+T(this.prologueScreenSubtitle);for(const t of this.players)e+=t.getByteLength(this.version);for(const t of this.forces)e+=t.getByteLength();e+=this.upgradeAvailabilityChanges.length*16,e+=this.techAvailabilityChanges.length*8;for(const t of this.randomUnitTables)e+=t.getByteLength();if(this.version>24){e+=36+T(this.loadingScreenModel)+T(this.prologueScreenModel)+T(this.soundEnvironment);for(const t of this.randomItemTables)e+=t.getByteLength()}return this.version>27&&(e+=20),this.version>30&&(e+=8),e}getBuildVersion(){return this.buildVersion[0]*100+this.buildVersion[1]}}class yr{u1=0;name="";flags=0;maxPlayers=0;archive=new nt;imports=new Qt;readonly=!1;load(e,t=!1){const r=new v(e);r.readBinary(4)==="HM3W"&&(this.u1=r.readUint32(),this.name=r.readNull(),this.flags=r.readUint32(),this.maxPlayers=r.readUint32()),this.readonly=t,this.archive.load(e,t),this.readImports()}save(){this.setImportsFile();const e=this.archive.save();if(!e)throw Error("Failed to save the map MPQ archive");const t=this.getMapInformation();if(!t||t.getBuildVersion()<131){const r=new Uint8Array(512+e.byteLength),n=new v(r);return n.writeBinary("HM3W"),n.writeUint32(this.u1),n.writeNull(this.name),n.writeUint32(this.flags),n.writeUint32(this.maxPlayers),r.set(e,512),r}else return e}getFileNames(){return this.archive.getFileNames()}getImportNames(){const e=[];for(const t of this.imports.entries.values()){const r=t.isCustom;r===10||r===13?e.push(t.path):e.push(`war3mapImported\\${t.path}`)}return e}setImportsFile(){return this.readonly?!1:this.imports.entries.size>0?this.set("war3map.imp",this.imports.save()):!1}import(e,t){return this.readonly?!1:this.archive.set(e,t)?(this.imports.set(e),!0):!1}set(e,t){return this.readonly?!1:this.archive.set(e,t)}get(e){return this.archive.get(e)}getScriptFile(){return this.get("war3map.j")||this.get("scripts\\war3map.j")||this.get("war3map.lua")||this.get("scripts\\war3map.lua")}has(e){return this.archive.has(e)}delete(e){return this.readonly?!1:(this.imports.delete(e),this.archive.delete(e))}rename(e,t){return this.readonly?!1:this.archive.rename(e,t)?(this.imports.rename(e,t),!0):!1}getMapInformation(){const e=this.archive.get("war3map.w3i");if(!e)throw new Error("File does not exist");const t=new mr;return t.load(e.bytes()),t}readImports(){const e=this.archive.get("war3map.imp");if(e){const t=e.arrayBuffer();t&&this.imports.load(t)}}readTriggers(e){const t=this.archive.get("war3map.wtg");if(t){const r=t.arrayBuffer();if(r){const n=new nr;return n.load(r,e),n}}}readCustomTextTriggers(){const e=this.archive.get("war3map.wct");if(e){const t=e.arrayBuffer();if(t){const r=new tr;return r.load(t),r}}}readStringTable(){const e=this.archive.get("war3map.wts");if(e){const t=e.text();if(t){const r=new ar;return r.load(t),r}}}readModifications(){const e={},t=["w3u","w3t","w3b","w3d","w3a","w3h","w3q"],r=[!1,!1,!1,!0,!0,!1,!0];for(let n=0,s=t.length;n<s;n++){const a=this.archive.get(`war3map.${t[n]}`);if(a){const o=a.arrayBuffer();if(o){let h;r[n]?h=new Zt:h=new er,h.load(o),e[t[n]]=h}}}return e}}function ne(i,e,t,r){if(t.has(e.name)){const s=t.get(e.name).args;for(const[a,o]of e.parameters.entries()){const{type:h,value:l}=o;if(h===1){for(const u of i.variables)if(u.name===l){s[a]=u.type;break}}else if(h===2){if(o.subParameters){const u=o.subParameters,p=r.getFunction(u.type,u.name);if(p){const m=p.returnType;m&&m!=="AnyType"&&(s[a]=m)}}}else if(h===3){if(l.startsWith("TRIGSTER_")||l.includes("\\"))s[a]="string";else if(l==="true"||l==="false")s[a]="boolean";else if(!isNaN(parseFloat(l))){const u=parseFloat(l);isNaN(u)||(Number.isInteger(u)&&!l.includes(".")?s[a]="integer":s[a]="real")}}}}for(const n of e.parameters)n.type===2&&n.subParameters&&ne(i,n.subParameters,t,r);if(e instanceof J)for(const n of e.ecas)ne(i,n,t,r)}const Sr=20;function br(i,e,t){let r;const n=new Map;let s,a,o=!0;for(;o;)try{r=i.readTriggers(e),o=!1}catch(h){if(h instanceof Error){const l=h.message;if(l.endsWith("Unknown signature")){const u=l.lastIndexOf('"'),p=l.lastIndexOf('"',u-1)+1,m=l.slice(p,u),[f,y]=m.split(":"),b=parseInt(y),I={args:[],scriptName:null,returnType:b===3?"AnyType":null};s=f.toLowerCase(),a=I,n.set(f,I),e.externalFunctions[b][s]=a}else s&&a&&(a.args.push("AnyType"),a.args.length>Sr&&(o=!1))}}if(n.size){if(r)for(const h of r.triggers)for(const l of h.ecas)ne(r,l,n,e);for(const[h,l]of n)t.change("unknownsignature","Unknown signature",`${h}(${l.args.join(", ")}) => ${l.returnType?l.returnType:"void"}`)}return r}class wr{triggerData;stringTable;preplacedObjects=new Map;changes=[];stack=[];constructor(e,t){this.triggerData=e,this.stringTable=t}push(e){this.stack.unshift(e)}pop(){this.stack.shift()}change(e,t,r){this.changes.push({type:e,reason:t,data:r,stack:this.stackToString()})}stackToString(){return this.stack.map(e=>e instanceof U?e.value:e.name).reverse().join(" > ")}getTriggerName(){for(const e of this.stack)if(e instanceof ie)return e.name;return""}updateGUIReference(e,t){if(e.startsWith("gg_unit")||e.startsWith("gg_dest")){const r=this.preplacedObjects;r.get(e)||r.set(e,t)}}saveGUIReferences(e,t){const r=[];for(const[n,s]of this.preplacedObjects)s||r.push(n);if(r.length){const n=new ie;n.name="PreplacedObjectReferences",n.isEnabled=1,n.isInitiallyOff=1;for(const s of r){const a=new J;a.type=2,a.isEnabled=1,s.startsWith("gg_unit")?a.name="RemoveUnit":s.startsWith("gg_dest")&&(a.name="RemoveDestructable");const o=new U;o.type=1,o.value=s,a.parameters[0]=o,n.ecas.push(a)}e.push(n),t.push(new K),this.change("references","Saved references to preplaced objects lost due to conversions",r.join(`
`))}}}function Tr(i,e){const t=new J;t.type=2,t.name="CustomScriptCode",t.isEnabled=1;const r=new U;return r.type=3,r.value=i,t.parameters[0]=r,t}function O(i){return Tr(i)}function Y(i,e){const t=new J;return t.name=i.name,t.type=i.type,t.group=e,t.isEnabled=1,t.parameters.push(...i.parameters),t}function Br(i){if(i.name==="IfThenElse"){const e=i.parameters,t=Y(e[0].subParameters,0),r=Y(e[1].subParameters,1),n=Y(e[2].subParameters,2);return i.name="IfThenElseMultiple",i.parameters.length=0,i.ecas.push(t,r,n),!0}else if(i.name==="ForGroup"||i.name==="ForForce"){const e=Y(i.parameters[1].subParameters,0);return i.name=`${i.name}Multiple`,i.parameters.length=1,i.ecas.push(e),!0}return!1}function Ir(i,e){return e!==0?!1:i==="AndMultiple"||i==="OrMultiple"||i==="IfThenElseMultiple"}const ot=239;function lt(i){const e=[];for(const t of i)if(t.name==="CustomScriptCode"){const r=t.parameters[0].value;if(T(r)>ot){const s=bt(r,ot),a=s.length,o=a-1;for(let h=0;h<a;h++){let l="";h>0&&(l+="*/"),l+=s[h],h<o&&(l+="/*");const u=O(l);u.group=t.group,e.push(u)}}else e.push(t)}else e.push(t);return e}function ht(i){return i.split("").map(e=>e.charCodeAt(0)>127?"_":e).join("").replace(/\s/g,"_")}const vr=new Set(["OperatorCompareBoolean","OperatorCompareAbilityId","OperatorCompareBuffId","OperatorCompareDestructible","OperatorCompareDestructableCode","OperatorCompareButton","OperatorCompareGameDifficulty","OperatorCompareGameSpeed","OperatorCompareHeroSkill","OperatorCompareInteger","OperatorCompareItem","OperatorCompareItemType","OperatorCompareItemCode","OperatorCompareMouseButton","OperatorCompareMeleeDifficulty","OperatorCompareOrderCode","OperatorComparePlayer","OperatorComparePlayerColor","OperatorComparePlayerControl","OperatorComparePlayerSlotStatus","OperatorCompareRace","OperatorCompareReal","OperatorCompareString","OperatorCompareTechCode","OperatorCompareTerrainType","OperatorCompareTrigger","OperatorCompareUnit","OperatorCompareUnitCode","OperatorInt","OperatorReal"]),Ar=new Set(["EnumDestructablesInRectAllMultiple","EnumDestructablesInCircleBJMultiple","EnumItemsInRectBJMultiple","ForForceMultiple","ForGroupMultiple"]);function Er(i,e,t){const r=ht(e.name),n=[],s=[],a=[];for(const h of e.ecas)h.type===0?n.push(h):h.type===1?s.push(h):a.push(h);const o=[];if(n.length||s.length||a.length){const h=[],l=[],u=[],p=`gg_trg_${r}`,m=new U;m.type=3,m.value=p,h.push(`set ${p} = CreateTrigger()`);for(const f of n){f.parameters.unshift(m);for(const y of L(i,f,t))h.push(y.parameters[0].value)}if(s.length){h.push(`call TriggerAddCondition(${p}, Condition(function Trig_${r}_Conditions)`);for(const f of s)for(const y of L(i,f,t))l.push(`if ${y.parameters[0].value} then\r
 return true\r
endif`)}if(a.length){h.push(`call TriggerAddAction(${p}, function Trig_${r}_Actions)`);for(const f of a)for(const y of L(i,f,t))u.push(y.parameters[0].value)}u.length&&o.push(`function Trig_${r}_Actions takes nothing returns nothing\r
${u.join(`\r
`)}\r
endfunction`),l.length&&o.push(`function Trig_${r}_Conditions takes nothing returns boolean\r
${l.join(`\r
`)}\r
return false\r
endfunction`),o.push(`function InitTrig_${r} takes nothing returns nothing\r
${h.join(`\r
`)}\r
endfunction`)}return o.join(`\r
`)}function L(i,e,t){const r=e.name,n=[],s=e.parameters,a=i.triggerData.getFunction(e.type,e.name);if(!a)throw new Error(`Could not find a function signature: ${r}. Stack: ${i.stackToString()}`);let{args:o,scriptName:h}=a;const l=o.length;let u=!1,p=!1,m=!1;const f=e;if(h=h||e.name,l){const y=o[l-1];y==="code"||Ar.has(r)?u=!0:y==="boolexpr"?p=!0:y==="scriptcode"&&(m=!0)}if(r==="IfThenElse")n.push(`if ${B(i,s[0],o[0],t)} then`),n.push(`call ${B(i,s[1],o[1],t)}`),n.push("else"),n.push(`call ${B(i,s[2],o[2],t)}`),n.push("endif");else if(r==="OrMultiple")n.push(f.ecas.slice().map(y=>L(i,y,t).map(b=>b.parameters[0].value)).join(" or "));else if(r==="AndMultiple")n.push(f.ecas.slice().map(y=>L(i,y,t).map(b=>b.parameters[0].value)).join(" and "));else if(r==="ForLoopAMultiple"||r==="ForLoopBMultiple"||r==="ForLoopVarMultiple"){let y="A";r==="ForLoopBMultiple"?y="B":r==="ForLoopVarMultiple"&&(y="Var");let b;if(y==="A"||y==="B"){b=`bj_forLoop${y}Index`;const I=`${b}End`;n.push(`set ${b} = ${B(i,s[0],o[0],t)}`),n.push(`set ${I} = ${B(i,s[1],o[1],t)}`),n.push("loop"),n.push(`exitwhen ${b} > ${I}`)}else b=B(i,s[0],o[0],t),n.push(`set ${b} = ${B(i,s[1],o[1],t)}`),n.push("loop"),n.push(`exitwhen ${b} > ${B(i,s[2],o[2],t)}`);for(const I of f.ecas){const E=L(i,I,t);for(const D of E)n.push(`${D.parameters[0].value}`)}n.push(`set ${b} = ${b} + 1`),n.push("endloop")}else if(r==="IfThenElseMultiple"){let y;const b=[],I=[];for(const E of f.ecas)E.group===0?y=E:E.group===1?b.push(E):E.group===2&&I.push(E);y&&n.push(`if ${L(i,y,t)[0].parameters[0].value} then`);for(const E of b){const D=L(i,E,t);for(const M of D)n.push(`${M.parameters[0].value}`)}if(I.length){n.push("else");for(const E of I){const D=L(i,E,t);for(const M of D)n.push(`${M.parameters[0].value}`)}}n.push("endif")}else if(u||p){const y=i.getTriggerName(),b=`Trig_${ht(y)}_Func${t.length}`;let I=`function ${b}`,E="nothing",D="call",M=s.length-1;const gt=e.name.endsWith("Multiple");p&&(I=`Filter(${I})`,E="boolean",D="return"),gt&&(M=s.length);const pt=t.length;t[pt]="NOTHING";const mt=[...s.slice(0,M).map((ce,de)=>B(i,ce,o[de],t)),I];e instanceof J?n.push(`call ${h}(${mt.join(", ")})`):n.push(`${h}(${mt.join(", ")})`);let he;gt?he=f.ecas.map(ce=>L(i,ce,t).map(de=>de.parameters[0].value).join(`\r
`)).join(`\r
`):he=`${D} ${B(i,s[M],o[M],t)}`,t[pt]=`function ${b} takes nothing returns ${E}\r
${he}\r
endfunction`}else m?n.push(B(i,f.parameters[0],"scriptcode",t)):r==="SetVariable"?n.push(`set ${B(i,s[0],o[0],t)} = ${B(i,s[1],o[1],t)}`):r==="OperatorString"?n.push(`${B(i,s[0],o[0],t)} + ${B(i,s[1],o[1],t)}`):vr.has(r)?n.push(`${B(i,s[0],o[0],t)} ${B(i,s[1],o[1],t)} ${B(i,s[2],o[2],t)}`):r==="CommentString"?n.push(`// ${s[0].value}`):r==="GetBooleanAnd"?n.push(`(${B(i,s[0],o[0],t)} and ${B(i,s[1],o[1],t)})`):r==="GetBooleanOr"?n.push(`(${B(i,s[0],o[0],t)} or ${B(i,s[1],o[1],t)})`):e instanceof J?(e.type===0&&(o=["trigger",...o]),n.push(`call ${h}(${s.map((y,b)=>B(i,y,o[b],t)).join(", ")})`)):e instanceof $&&n.push(`${h}(${s.map((y,b)=>B(i,y,o[b],t)).join(", ")})`);return n.map(y=>O(y))}function B(i,e,t,r){const{type:n,value:s}=e;if(n===0){const a=i.triggerData.getPreset(s);if(a===void 0)throw new Error(`Failed to find a preset: "${s}"`);return a}else if(n===1){if(s.startsWith("gg_"))return i.updateGUIReference(s,!1),s;{let a=`udg_${s}`;return e.isArray&&e.arrayIndex&&(a+=`[${B(i,e.arrayIndex,"integer",r)}]`),a}}else{if(e.type===2)return L(i,e.subParameters,r)[0].parameters[0].value;if(e.type===3){const a=i.triggerData.getBaseType(t);if(a==="string"&&t!=="scriptcode"){if(s.startsWith("TRIGSTR")&&i.stringTable){const o=i.stringTable.getString(s);if(o!==void 0)return`"${o.replace(/\r\n/g,`\\r
`)}"`;i.change("missingstring","Entry not found in the string table",s)}return`"${s.replace(/\\/g,"\\\\")}"`}return a==="integer"&&isNaN(parseInt(s))?`'${s}'`:s}else return""}}function Q(i,e,t){return B(i,e,t,[])}function Lr(i,e,t,r,n){const s=e.parameters,a=[];r.test&&a.push(r.test),r.tests&&a.push(...r.tests);for(const[o,h]of a)if(n[o]===void 0&&(n[o]=Q(i,s[o],t[o])),h!==n[o])return!1;return!0}function Cr(i,e,t){if(e.name=t,e.type=i.triggerData.getFunctionType(t),e instanceof $){const r=i.stack[1];r.value=t}}function Ur(i,e,t,r){if(r.parameters){const n=e.parameters;e.parameters=r.parameters.map(s=>{if(typeof s=="number")return n[s];if(typeof s=="string"){const a=new U;return i.triggerData.getPreset(s)?a.type=0:a.type=3,a.value=s,a}else{const a=s[0],o=s[1],h=s[2],l=t[a];let u,p;if(l==="integer")u="OperatorInt";else if(l==="real")u="OperatorReal";else throw new Error(`Attempted to use an operator on a non-number parameter of type "${l}`);o==="+"?p="OperatorAdd":o==="-"?p="OperatorSubtract":o==="*"?p="OperatorMultiply":p="OperatorDivide";const m=new U;m.value=u,m.type=2;const f=new $;f.name=u,f.type=3;const y=n[a],b=new U;b.type=0,b.value=p;const I=new U;return I.type=3,I.value=`${h}`,f.beginParameters=1,f.parameters=[y,b,I],m.subParameters=f,m}})}}function d(i){return function(e,t){const r=e.triggerData.getFunction(t.type,t.name);if(!r)return console.warn(`transformer failed to get the signature for the input function: ${t.name}`),!1;const n=r.args,s=[];for(const[a,o]of Object.entries(i)){let h;Array.isArray(o)?h=o:h=[o];for(const l of h)if(Lr(e,t,n,l,s))return Cr(e,t,a),Ur(e,t,n,l),!0}return!1}}function xr(i,e){const t=i.stack[1],r=i.stack[2],n=r.parameters;if(r.name!=="OperatorCompareBoolean")return!1;let s;r.parameters[0]===t?s=n[2]:s=n[0];const a=Q(i,s,"boolean");if(a!=="true"&&a!=="false")return!1;r.name="OperatorComparePlayer";const h=e.parameters[1];return t.value="GetOwningPlayer",e.name="GetOwningPlayer",e.parameters.length=1,n[0]=t,a==="true"?n[1].value="OperatorEqualENE":n[1].value="OperatorNotEqualENE",n[2]=h,!0}function Pr(i,e){const t=i.stack[1],r=i.stack[2],n=r.parameters;if(r.name!=="OperatorCompareBoolean")return!1;let s;r.parameters[0]===t?s=n[2]:s=n[0];const a=Q(i,s,"boolean");if(a!=="true"&&a!=="false")return!1;r.name="OperatorCompareRace";const h=e.parameters[1];return t.value="GetUnitRace",e.name="GetUnitRace",e.parameters.length=1,n[0]=t,n[1].value==="OperatorEqualENE"===(a==="true")?n[1].value="OperatorEqualENE":n[1].value="OperatorNotEqualENE",n[1]=h,!0}function Jr(i,e){if(i.stack[2].name!=="OperatorCompareBoolean"||Q(i,e.parameters[1],"unittype")!=="UNIT_TYPE_DEAD")return!1;const n=i.stack[1];return n.value="IsUnitDeadBJ",e.name="IsUnitDeadBJ",e.parameters.length=1,!0}function _r(i){return i==="GetTriggerPlayerMouseX"||i==="GetTriggerPlayerMouseY"||i==="GetTriggerPlayerMousePosition"||i==="GetTriggerPlayerMouseButton"||i==="SetAbilityTooltip"||i==="SetAbilityExtendedTooltip"||i==="SetAbilityResearchTooltip"||i==="SetAbilityResearchExtendedTooltip"||i==="GetAbilityTooltip"||i==="GetAbilityExtendedTooltip"||i==="GetAbilityResearchTooltip"||i==="GetAbilityResearchExtendedTooltip"||i==="SetAbilityIcon"||i==="GetAbilityIcon"||i==="GetAbilityPosX"||i==="GetAbilityPosY"||i==="SetAbilityPosX"||i==="SetAbilityPosY"||i==="GetUnitMaxHP"||i==="SetUnitMaxHP"||i==="GetUnitMaxMana"||i==="SetUnitMaxMana"||i==="SetItemName"||i==="SetItemDescription"||i==="GetItemDescription"||i==="SetItemTooltip"||i==="GetItemTooltip"||i==="SetItemExtendedTooltip"||i==="GetItemExtendedTooltip"||i==="SetItemIconPath"||i==="GetItemIconPath"||i==="SetUnitName"||i==="SetHeroProperName"||i==="GetUnitBaseDamage"||i==="SetUnitBaseDamage"||i==="GetUnitDiceNumber"||i==="SetUnitDiceNumber"||i==="GetUnitDiceSides"||i==="SetUnitDiceSides"||i==="GetUnitAttackCooldown"||i==="SetUnitAttackCooldown"||i==="SetSpcialEffectColorByPlayer"||i==="SetSpecialEffectColor"||i==="SetSpecialEffectAlpha"||i==="SetSpecialEffectScale"||i==="SetSpecialEffectPosition"||i==="SetSpecialEffectHeight"||i==="SetSpecialEffectTimeScale"||i==="SetSpecialEffectTime"||i==="SetSpecialEffectOrientation"||i==="SetSpecialEffectYaw"||i==="SetSpecialEffectPitch"||i==="SetSpecialEffectRoll"||i==="SetSpecialEffectX"||i==="SetSpecialEffectY"||i==="SetSpecialEffectZ"||i==="SetSpecialEffectPositionLoc"||i==="GetLocalSpecialEffectX"||i==="GetLocalSpecialEffectY"||i==="GetLocalSpecialEffectZ"||i==="GetUnitArmor"||i==="SetUnitArmor"||i==="UnitHideAbility"||i==="UnitDisableAbility"||i==="UnitCancelTimedLife"||i==="IsUnitSelectable"||i==="IsUnitInvulnerable"||i==="UnitInterruptAttack"||i==="GetUnitCollisionSize"||i==="GetAbilityManaCost"||i==="GetAbilityCooldown"||i==="SetUnitAbilityCooldown"||i==="GetUnitAbilityCooldown"||i==="GetUnitAbilityCooldownRemaining"||i==="EndUnitAbilityCooldown"||i==="GetUnitAbilityManaCost"||i==="SetEventDamage"||i==="PlaySpecialEffect"||i==="PlaySpecialEffectWithTimeScale"}function Hr(i,e){const t=e.name;if(!_r(t))return!1;e.name=`Blz${t}`,e instanceof $&&(i.stack[1].value=`Blz${t}`);const r=e.parameters;return(t==="GetAbilityIcon"||t==="SetAbilityIcon")&&r.length===3&&r.pop(),!0}let se=!1,ct;function c(i){return d({[i]:{}})}function x(i){return function(e){return d({[e]:{parameters:i}})}}function Dr(){if(!se){se=!0;const i=x([1,0]),e=x([1,0,2]),t=x([1,2,0]),r=x([2,0,1]),n=x([2,1,0]),s=x([0,2,3,1]),a=x([1,0,2,3]),o=x([3,0,1,2]),h=x([3,2,0,1]),l=x([3,2,1,0]);ct={UnitId:c("String2UnitIdBJ"),UnitId2String:c("UnitId2StringBJ"),GetObjectName:c("GetAbilityName"),Sin:d({SinBJ:{parameters:[[0,"/",Math.PI/180]]}}),Cos:d({CosBJ:{parameters:[[0,"/",Math.PI/180]]}}),Tan:d({TanBJ:{parameters:[[0,"/",Math.PI/180]]}}),GetHandleId:c("GetHandleIdBJ"),SubString:d({SubStringBJ:{parameters:[0,[1,"+",1],2]}}),StringHash:c("StringHashBJ"),GetLocalizedString:c("StringIdentity"),SetMapFlag:d({LockGameSpeedBJ:{tests:[[0,"MAP_LOCK_SPEED"],[1,"true"]],parameters:[]},UnlockGameSpeedBJ:{tests:[[0,"MAP_LOCK_SPEED"],[1,"false"]],parameters:[]}}),SetPlayerColor:d({SetPlayerColorBJ:{parameters:[0,1,"PlayerChangeColorRetain"]}}),SetPlayerAlliance:s("SetPlayerAllianceBJ"),SetPlayerTaxRate:h("SetPlayerTaxRateBJ"),SetPlayerOnScoreScreen:i("SetPlayerOnScoreScreenBJ"),GetPlayerTaxRate:r("GetPlayerTaxRateBJ"),TimerStart:d({StartTimerBJ:{test:[3,"null"],parameters:[0,2,1]}}),PauseTimer:d({PauseTimerBJ:{parameters:["PauseResumePause",0]}}),ResumeTimer:d({PauseTimerBJ:{parameters:["PauseResumeResume",0]}}),GroupAddUnit:i("GroupAddUnitSimple"),GroupRemoveUnit:i("GroupRemoveUnitSimple"),GroupImmediateOrderById:c("GroupTrainOrderByIdBJ"),ForceAddPlayer:i("ForceAddPlayerSimple"),ForceRemovePlayer:i("ForceRemovePlayerSimple"),GetWorldBounds:c("GetEntireMapRect"),TriggerRegisterTimerEvent:d({TriggerRegisterTimerEventPeriodic:{test:[2,"true"],parameters:[0,1]},TriggerRegisterTimerEventSingle:{test:[2,"false"],parameters:[0,1]}}),TriggerRegisterTimerExpireEvent:c("TriggerRegisterTimerExpireEventBJ"),TriggerRegisterGameStateEvent:d({TriggerRegisterGameStateEventTimeOfDay:{test:[1,"GAME_STATE_TIME_OF_DAY"],parameters:[0,2,3]}}),TriggerRegisterDialogEvent:c("TriggerRegisterDialogEventBJ"),TriggerRegisterGameEvent:d({TriggerRegisterShowSkillEventBJ:{test:[1,"EVENT_GAME_SHOW_SKILL"],parameters:[0]},TriggerRegisterBuildSubmenuEventBJ:{test:[1,"EVENT_GAME_BUILD_SUBMENU"],parameters:[0]},TriggerRegisterGameLoadedEventBJ:{test:[1,"EVENT_GAME_LOADED"],parameters:[0]},TriggerRegisterGameSavedEventBJ:{test:[1,"EVENT_GAME_SAVE"],parameters:[0]}}),GetClickedButton:c("GetClickedButtonBJ"),GetClickedDialog:c("GetClickedDialogBJ"),TriggerRegisterPlayerEvent:d({TriggerRegisterPlayerKeyEventBJ:[{test:[2,"EVENT_PLAYER_ARROW_LEFT_DOWN"],parameters:[0,1,"KeyEventTypeDepress","KeyEventKeyLeft"]},{test:[2,"EVENT_PLAYER_ARROW_RIGHT_DOWN"],parameters:[0,1,"KeyEventTypeDepress","KeyEventKeyRight"]},{test:[2,"EVENT_PLAYER_ARROW_DOWN_DOWN"],parameters:[0,1,"KeyEventTypeDepress","KeyEventKeyDown"]},{test:[2,"EVENT_PLAYER_ARROW_UP_DOWN"],parameters:[0,1,"KeyEventTypeDepress","KeyEventKeyUp"]},{test:[2,"EVENT_PLAYER_ARROW_LEFT_UP"],parameters:[0,1,"KeyEventTypeRelease","KeyEventKeyLeft"]},{test:[2,"EVENT_PLAYER_ARROW_RIGHT_UP"],parameters:[0,1,"KeyEventTypeRelease","KeyEventKeyRight"]},{test:[2,"EVENT_PLAYER_ARROW_DOWN_UP"],parameters:[0,1,"KeyEventTypeRelease","KeyEventKeyDown"]},{test:[2,"EVENT_PLAYER_ARROW_UP_UP"],parameters:[0,1,"KeyEventTypeRelease","KeyEventKeyUp"]}],TriggerRegisterPlayerMouseEventBJ:[{test:[2,"EVENT_PLAYER_MOUSE_DOWN"],parameters:[0,1,"MouseEventTypeDown"]},{test:[2,"EVENT_PLAYER_MOUSE_UP"],parameters:[0,1,"MouseEventTypeUp"]},{test:[2,"EVENT_PLAYER_MOUSE_MOVE"],parameters:[0,1,"MouseEventTypeMove"]}],TriggerRegisterPlayerEventVictory:{test:[2,"EVENT_PLAYER_VICTORY"],parameters:[0,1]},TriggerRegisterPlayerEventDefeat:{test:[2,"EVENT_PLAYER_DEFEAT"],parameters:[0,1]},TriggerRegisterPlayerEventLeave:{test:[2,"EVENT_PLAYER_LEAVE"],parameters:[0,1]},TriggerRegisterPlayerEventAllianceChanged:{test:[2,"EVENT_PLAYER_ALLIANCE_CHANGED"],parameters:[0,1]},TriggerRegisterPlayerEventEndCinematic:{test:[2,"EVENT_PLAYER_END_CINEMATIC"],parameters:[0,1]}}),TriggerRegisterPlayerUnitEvent:d({TriggerRegisterPlayerUnitEventSimple:{test:[3,"null"],parameters:[0,1,2]}}),GetLearnedSkill:c("GetLearnedSkillBJ"),GetKillingUnit:c("GetKillingUnitBJ"),GetTransportUnit:c("GetTransportUnitBJ"),GetLoadedUnit:c("GetLoadedUnitBJ"),GetIssuedOrderId:c("GetIssuedOrderIdBJ"),TriggerRegisterUnitStateEvent:d({TriggerRegisterUnitLifeEvent:{test:[1,"UNIT_STATE_LIFE"],parameters:[0,2,3]},TriggerRegisterUnitManaEvent:{test:[1,"UNIT_STATE_MANA"],parameters:[0,2,3]}}),TriggerWaitForSound:c("WaitForSoundBJ"),GetWidgetLife:c("GetItemLifeBJ"),SetWidgetLife:c("SetItemLifeBJ"),SetDestructableInvulnerable:c("SetDestructableInvulnerableBJ"),IsDestructableInvulnerable:c("IsDestructableInvulnerableBJ"),EnumDestructablesInRect:d({EnumDestructablesInRectAll:{test:[1,"null"],parameters:[0,2]}}),SetDestructableMaxLife:c("SetDestructableMaxLifeBJ"),QueueDestructableAnimation:c("QueueDestructableAnimationBJ"),SetDestructableAnimation:c("SetDestructableAnimationBJ"),SetDestructableAnimationSpeed:d({SetDestAnimationSpeedPercent:{parameters:[0,[1,"*",100]]}}),ShowDestructable:i("ShowDestructableBJ"),GetTriggerDestructable:c("GetDyingDestructable"),SetItemDropOnDeath:c("SetItemDropOnDeathBJ"),SetItemDroppable:c("SetItemDroppableBJ"),SetItemPlayer:c("SetItemPlayerBJ"),SetItemInvulnerable:c("SetItemInvulnerableBJ"),SetItemVisible:i("SetItemVisibleBJ"),IsItemOwned:d({CheckItemStatus:{parameters:[0,"ItemStatusOwned"]}}),IsItemPowerup:d({CheckItemStatus:{parameters:[0,"ItemStatusPowerup"]}}),IsItemSellable:d({CheckItemStatus:{parameters:[0,"ItemStatusSellable"]}}),IsItemPawnable:d({CheckItemStatus:{parameters:[0,"ItemStatusPawnable"]}}),IsItemIdPowerup:d({CheckItemcodeStatus:{parameters:[0,"ItemcodeStatusPowerup"]}}),IsItemIdSellable:d({CheckItemcodeStatus:{parameters:[0,"ItemcodeStatusSellable"]}}),IsItemIdPawnable:d({CheckItemcodeStatus:{parameters:[0,"ItemcodeStatusPawnable"]}}),EnumItemsInRect:d({EnumItemsInRectBJ:{test:[1,"null"],parameters:[0,2]}}),ShowUnit:d({ShowUnitShow:{test:[1,"true"],parameters:[0]},ShowUnitHide:{test:[1,"false"],parameters:[0]}}),SetUnitState:d({SetUnitLifeBJ:{test:[1,"UNIT_STATE_LIFE"],parameters:[0,2]},SetUnitManaBJ:{test:[1,"UNIT_STATE_MANA"],parameters:[0,2]}}),SetUnitFlyHeight:c("SetUnitFlyHeightBJ"),SetUnitTurnSpeed:c("SetUnitTurnSpeedBJ"),SetUnitAcquireRange:c("SetUnitAcquireRangeBJ"),SetUnitCreepGuard:d({LockGuardPosition:{test:[1,"true"],parameters:[0]}}),GetUnitDefaultPropWindow:c("GetUnitDefaultPropWindowBJ"),SetUnitScale:d({SetUnitScalePercent:{parameters:[0,[1,"*",100],[2,"*",100],[3,"*",100]]}}),SetUnitTimeScale:d({SetUnitTimeScalePercent:{parameters:[0,[1,"*",100]]}}),SetUnitBlendTime:c("SetUnitBlendTimeBJ"),QueueUnitAnimation:c("QueueUnitAnimationBJ"),SetUnitAnimation:d({ResetUnitAnimation:{test:[1,'"stand"'],parameters:[0]}}),AddUnitAnimationProperties:n("AddUnitAnimationPropertiesBJ"),SetHeroStr:d({ModifyHeroStat:{test:[2,"true"],parameters:["HeroStatStr",0,"ModifyMethodSet",1]}}),SetHeroAgi:d({ModifyHeroStat:{test:[2,"true"],parameters:["HeroStatAgi",0,"ModifyMethodSet",1]}}),SetHeroInt:d({ModifyHeroStat:{test:[2,"true"],parameters:["HeroStatInt",0,"ModifyMethodSet",1]}}),GetHeroStr:d({GetHeroStatBJ:{parameters:["HeroStatStr",0,1]}}),GetHeroAgi:d({GetHeroStatBJ:{parameters:["HeroStatAgi",0,1]}}),GetHeroInt:d({GetHeroStatBJ:{parameters:["HeroStatInt",0,1]}}),UnitModifySkillPoints:d({ModifyHeroSkillPoints:{parameters:[0,"0",1]}}),AddHeroXP:e("AddHeroXPSwapped"),GetUnitAbilityLevel:i("GetUnitAbilityLevelSwapped"),DecUnitAbilityLevel:i("DecUnitAbilityLevelSwapped"),IncUnitAbilityLevel:i("IncUnitAbilityLevelSwapped"),SetUnitAbilityLevel:e("SetUnitAbilityLevelSwapped"),SetUnitExploded:c("SetUnitExplodedBJ"),PauseUnit:i("PauseUnitBJ"),IsUnitPaused:c("IsUnitPausedBJ"),SelectUnit:d({SelectUnitAdd:{test:[1,"true"],parameters:[0]},SelectUnitRemove:{test:[1,"false"],parameters:[0]}}),UnitAddItem:i("UnitAddItemSwapped"),UnitRemoveItem:i("UnitRemoveItemSwapped"),UnitRemoveItemFromSlot:d({UnitRemoveItemFromSlotSwapped:{parameters:[0,[1,"+",1]]}}),UnitItemInSlot:d({UnitItemInSlotBJ:{parameters:[0,[1,"+",1]]}}),UnitInventorySize:c("UnitInventorySizeBJ"),UnitDropItemSlot:d({UnitDropItemSlotBJ:{parameters:[0,1,[2,"+",1]]}}),UnitDropItemTarget:c("UnitDropItemTargetBJ"),GetUnitState:i("GetUnitStateSwap"),SetUnitUseFood:i("SetUnitUseFoodBJ"),IsUnitOwnedByPlayer:xr,IsUnitRace:Pr,IsUnitType:Jr,IsUnitHidden:c("IsUnitHiddenBJ"),IsUnitIllusion:c("IsUnitIllusionBJ"),IsUnitInTransport:c("IsUnitInTransportBJ"),IsUnitLoaded:c("IsUnitLoadedBJ"),UnitShareVision:r("UnitShareVisionBJ"),UnitSuspendDecay:i("UnitSuspendDecayBJ"),UnitAddType:i("UnitAddTypeBJ"),UnitRemoveType:i("UnitRemoveTypeBJ"),UnitAddAbility:i("UnitAddAbilityBJ"),UnitRemoveAbility:i("UnitRemoveAbilityBJ"),UnitRemoveBuffs:d({UnitRemoveBuffsBJ:[{tests:[[1,"true"],[2,"false"]],parameters:["BuffTypePositive",0]},{tests:[[1,"false"],[2,"true"]],parameters:["BuffTypeNegative",0]},{tests:[[1,"true"],[2,"true"]],parameters:["BuffTypeAll",0]}]}),UnitRemoveBuffsEx:d({UnitRemoveBuffsBJ:{tests:[[1,"true"],[2,"true"],[3,"false"],[4,"false"],[5,"false"],[6,"true"],[7,"false"]],parameters:["BuffTypeNonTLife",0]}}),UnitAddSleep:c("UnitSetCanSleepBJ"),UnitCanSleep:c("UnitCanSleepBJ"),UnitIsSleeping:c("UnitIsSleepingBJ"),UnitWakeUp:c("UnitWakeUpBJ"),UnitApplyTimedLife:n("UnitApplyTimedLifeBJ"),UnitPauseTimedLife:i("UnitPauseTimedLifeBJ"),UnitSetUsesAltIcon:i("UnitSetUsesAltIconBJ"),UnitDamageTarget:d({UnitDamageTargetBJ:{tests:[[3,"true"],[4,"false"],[7,"WEAPON_TYPE_WHOKNOWS"]],parameters:[0,1,2,5,6]}}),IssueImmediateOrderById:c("IssueTrainOrderByIdBJ"),AddResourceAmount:i("AddResourceAmountBJ"),WaygateActivate:i("WaygateActivateBJ"),WaygateIsActive:c("WaygateIsActiveBJ"),AddItemToStock:a("AddItemToStockBJ"),AddUnitToStock:a("AddUnitToStockBJ"),RemoveItemFromStock:i("RemoveItemFromStockBJ"),RemoveUnitFromStock:i("RemoveUnitFromStockBJ"),Player:d({ConvertedPlayer:{parameters:[[0,"+",1]]}}),SetPlayerHandicap:d({SetPlayerHandicapBJ:{parameters:[0,[1,"*",100]]}}),SetPlayerHandicapXP:d({SetPlayerHandicapXPBJ:{parameters:[0,[1,"*",100]]}}),SetPlayerTechMaxAllowed:t("SetPlayerTechMaxAllowedSwap"),GetPlayerTechMaxAllowed:i("GetPlayerTechMaxAllowedSwap"),SetPlayerTechResearched:t("SetPlayerTechResearchedSwap"),GetPlayerTechCount:d({GetPlayerTechCountSimple:{test:[2,"true"],parameters:[1,0]}}),SetPlayerAbilityAvailable:n("SetPlayerAbilityAvailableBJ"),FogMaskEnable:d({FogMaskEnableOn:{test:[0,"true"],parameters:[]},FogMaskEnableOff:{test:[0,"false"],parameters:[]}}),FogEnable:d({FogEnableOn:{test:[0,"true"],parameters:[]},FogEnableOff:{test:[0,"false"],parameters:[]}}),SetCampaignMenuRace:d({SetCampaignMenuRaceBJ:[{test:[0,"RACE_OTHER"],parameters:["CampaignIndexT"]},{test:[0,"RACE_HUMAN"],parameters:["CampaignIndexH"]},{test:[0,"RACE_UNDEAD"],parameters:["CampaignIndexU"]},{test:[0,"RACE_ORC"],parameters:["CampaignIndexO"]},{test:[0,"RACE_NIGHTELF"],parameters:["CampaignIndexN"]}]}),SetCampaignMenuRaceEx:d({SetCampaignMenuRaceBJ:[{test:[0,"bj_CAMPAIGN_OFFSET_XN"],parameters:["CampaignIndexXN"]},{test:[0,"bj_CAMPAIGN_OFFSET_XH"],parameters:["CampaignIndexXH"]},{test:[0,"bj_CAMPAIGN_OFFSET_XU"],parameters:["CampaignIndexXU"]},{test:[0,"bj_CAMPAIGN_OFFSET_XO"],parameters:["CampaignIndexXO"]}]}),LoadGame:c("LoadGameBJ"),RenameSaveDirectory:c("RenameSaveDirectoryBJ"),RemoveSaveDirectory:c("RemoveSaveDirectoryBJ"),CopySaveGame:c("CopySaveGameBJ"),GetFloatGameState:d({GetTimeOfDay:{test:[0,"GAME_STATE_TIME_OF_DAY"],parameters:[]}}),SetFloatGameState:d({SetTimeOfDay:{test:[0,"GAME_STATE_TIME_OF_DAY"],parameters:[1]}}),SetCustomCampaignButtonVisible:d({ShowCustomCampaignButton:{parameters:[[0,"+",1],1]}}),GetCustomCampaignButtonVisible:d({IsCustomCampaignButtonVisibile:{parameters:[[0,"+",1]]}}),DialogClear:c("DialogClearBJ"),DialogSetMessage:c("DialogSetMessageBJ"),DialogDisplay:n("DialogDisplayBJ"),InitGameCache:c("InitGameCacheBJ"),SaveGameCache:c("SaveGameCacheBJ"),StoreInteger:l("StoreIntegerBJ"),StoreReal:l("StoreRealBJ"),StoreBoolean:l("StoreBooleanBJ"),StoreUnit:l("StoreUnitBJ"),StoreString:l("StoreStringBJ"),HaveStoredBoolean:d({HaveStoredValue:{parameters:[2,"CacheValueTypeBoolean",1,0]}}),HaveStoredInteger:d({HaveStoredValue:{parameters:[2,"CacheValueTypeInteger",1,0]}}),HaveStoredReal:d({HaveStoredValue:{parameters:[2,"CacheValueTypeReal",1,0]}}),HaveStoredUnit:d({HaveStoredValue:{parameters:[2,"CacheValueTypeUnit",1,0]}}),HaveStoredString:d({HaveStoredValue:{parameters:[2,"CacheValueTypeString",1,0]}}),FlushGameCache:c("FlushGameCacheBJ"),FlushStoredMission:i("FlushStoredMissionBJ"),GetStoredInteger:n("GetStoredIntegerBJ"),GetStoredReal:n("GetStoredRealBJ"),GetStoredBoolean:n("GetStoredBooleanBJ"),GetStoredString:n("GetStoredStringBJ"),InitHashtable:c("InitHashtableBJ"),SaveInteger:l("SaveIntegerBJ"),SaveReal:l("SaveRealBJ"),SaveBoolean:l("SaveBooleanBJ"),SaveStr:l("SaveStringBJ"),SavePlayerHandle:l("SavePlayerHandleBJ"),SaveWidgetHandle:l("SaveWidgetHandleBJ"),SaveDestructableHandle:l("SaveDestructableHandleBJ"),SaveItemHandle:l("SaveItemHandleBJ"),SaveUnitHandle:l("SaveUnitHandleBJ"),SaveAbilityHandle:l("SaveAbilityHandleBJ"),SaveTimerHandle:l("SaveTimerHandleBJ"),SaveTriggerHandle:l("SaveTriggerHandleBJ"),SaveTriggerConditionHandle:l("SaveTriggerConditionHandleBJ"),SaveTriggerActionHandle:l("SaveTriggerActionHandleBJ"),SaveTriggerEventHandle:l("SaveTriggerEventHandleBJ"),SaveForceHandle:l("SaveForceHandleBJ"),SaveGroupHandle:l("SaveGroupHandleBJ"),SaveLocationHandle:l("SaveLocationHandleBJ"),SaveRectHandle:l("SaveRectHandleBJ"),SaveBooleanExprHandle:l("SaveBooleanExprHandleBJ"),SaveSoundHandle:l("SaveSoundHandleBJ"),SaveEffectHandle:l("SaveEffectHandleBJ"),SaveUnitPoolHandle:l("SaveUnitPoolHandleBJ"),SaveItemPoolHandle:l("SaveItemPoolHandleBJ"),SaveQuestHandle:l("SaveQuestHandleBJ"),SaveQuestItemHandle:l("SaveQuestItemHandleBJ"),SaveDefeatConditionHandle:l("SaveDefeatConditionHandleBJ"),SaveTimerDialogHandle:l("SaveTimerDialogHandleBJ"),SaveLeaderboardHandle:l("SaveLeaderboardHandleBJ"),SaveMultiboardHandle:l("SaveMultiboardHandleBJ"),SaveMultiboardItemHandle:l("SaveMultiboardItemHandleBJ"),SaveTrackableHandle:l("SaveTrackableHandleBJ"),SaveDialogHandle:l("SaveDialogHandleBJ"),SaveButtonHandle:l("SaveButtonHandleBJ"),SaveTextTagHandle:l("SaveTextTagHandleBJ"),SaveLightningHandle:l("SaveLightningHandleBJ"),SaveImageHandle:l("SaveImageHandleBJ"),SaveUbersplatHandle:l("SaveUbersplatHandleBJ"),SaveRegionHandle:l("SaveRegionHandleBJ"),SaveFogStateHandle:l("SaveFogStateHandleBJ"),SaveFogModifierHandle:l("SaveFogModifierHandleBJ"),LoadInteger:n("LoadIntegerBJ"),LoadReal:n("LoadRealBJ"),LoadBoolean:n("LoadBooleanBJ"),LoadStr:n("LoadStringBJ"),LoadPlayerHandle:n("LoadPlayerHandleBJ"),LoadWidgetHandle:n("LoadWidgetHandleBJ"),LoadDestructableHandle:n("LoadDestructableHandleBJ"),LoadItemHandle:n("LoadItemHandleBJ"),LoadUnitHandle:n("LoadUnitHandleBJ"),LoadAbilityHandle:n("LoadAbilityHandleBJ"),LoadTimerHandle:n("LoadTimerHandleBJ"),LoadTriggerHandle:n("LoadTriggerHandleBJ"),LoadTriggerConditionHandle:n("LoadTriggerConditionHandleBJ"),LoadTriggerActionHandle:n("LoadTriggerActionHandleBJ"),LoadTriggerEventHandle:n("LoadTriggerEventHandleBJ"),LoadForceHandle:n("LoadForceHandleBJ"),LoadGroupHandle:n("LoadGroupHandleBJ"),LoadLocationHandle:n("LoadLocationHandleBJ"),LoadRectHandle:n("LoadRectHandleBJ"),LoadBooleanExprHandle:n("LoadBooleanExprHandleBJ"),LoadSoundHandle:n("LoadSoundHandleBJ"),LoadEffectHandle:n("LoadEffectHandleBJ"),LoadUnitPoolHandle:n("LoadUnitPoolHandleBJ"),LoadItemPoolHandle:n("LoadItemPoolHandleBJ"),LoadQuestHandle:n("LoadQuestHandleBJ"),LoadQuestItemHandle:n("LoadQuestItemHandleBJ"),LoadDefeatConditionHandle:n("LoadDefeatConditionHandleBJ"),LoadTimerDialogHandle:n("LoadTimerDialogHandleBJ"),LoadLeaderboardHandle:n("LoadLeaderboardHandleBJ"),LoadMultiboardHandle:n("LoadMultiboardHandleBJ"),LoadMultiboardItemHandle:n("LoadMultiboardItemHandleBJ"),LoadTrackableHandle:n("LoadTrackableHandleBJ"),LoadDialogHandle:n("LoadDialogHandleBJ"),LoadButtonHandle:n("LoadButtonHandleBJ"),LoadTextTagHandle:n("LoadTextTagHandleBJ"),LoadLightningHandle:n("LoadLightningHandleBJ"),LoadImageHandle:n("LoadImageHandleBJ"),LoadUbersplatHandle:n("LoadUbersplatHandleBJ"),LoadRegionHandle:n("LoadRegionHandleBJ"),LoadFogStateHandle:n("LoadFogStateHandleBJ"),LoadFogModifierHandle:n("LoadFogModifierHandleBJ"),HaveSavedBoolean:d({HaveSavedValue:{parameters:[2,"HashtableValueTypeBoolean",1,0]}}),HaveSavedInteger:d({HaveSavedValue:{parameters:[2,"HashtableValueTypeInteger",1,0]}}),HaveSavedReal:d({HaveSavedValue:{parameters:[2,"HashtableValueTypeReal",1,0]}}),HaveSavedString:d({HaveSavedValue:{parameters:[2,"HashtableValueTypeString",1,0]}}),HaveSavedHandle:d({HaveSavedValue:{parameters:[2,"HashtableValueTypeHandle",1,0]}}),FlushParentHashtable:c("FlushParentHashtableBJ"),FlushChildHashtable:i("FlushChildHashtableBJ"),ChooseRandomCreep:c("ChooseRandomCreepBJ"),ChooseRandomNPBuilding:c("ChooseRandomNPBuildingBJ"),ChooseRandomItem:c("ChooseRandomItemBJ"),ChooseRandomItemEx:i("ChooseRandomItemExBJ"),ResetTerrainFog:c("ResetTerrainFogBJ"),SetTerrainFogEx:d({SetTerrainFogExBJ:{parameters:[0,1,2,3,[4,"*",100],[5,"*",100],[6,"*",100]]}}),SetTimeOfDayScale:d({SetTimeOfDayScalePercentBJ:{parameters:[[0,"*",100]]}}),PauseGame:d({PauseGameOn:{test:[0,"true"],parameters:[]},PauseGameOff:{test:[0,"false"],parameters:[]}}),DestroyTextTag:c("DestroyTextTagBJ"),SetTextTagPosUnit:c("SetTextTagPosUnitBJ"),SetTextTagSuspended:c("SetTextTagSuspendedBJ"),SetTextTagPermanent:c("SetTextTagPermanentBJ"),SetTextTagAge:c("SetTextTagAgeBJ"),SetTextTagLifespan:c("SetTextTagLifespanBJ"),SetTextTagFadepoint:c("SetTextTagFadepointBJ"),DestroyQuest:c("DestroyQuestBJ"),QuestSetTitle:c("QuestSetTitleBJ"),QuestSetDescription:c("QuestSetDescriptionBJ"),QuestSetCompleted:c("QuestSetCompletedBJ"),QuestSetDiscovered:c("QuestSetDiscoveredBJ"),QuestSetFailed:c("QuestSetFailedBJ"),QuestSetEnabled:i("QuestSetEnabledBJ"),QuestItemSetDescription:c("QuestItemSetDescriptionBJ"),QuestItemSetCompleted:c("QuestItemSetCompletedBJ"),DestroyDefeatCondition:c("DestroyDefeatConditionBJ"),DefeatConditionSetDescription:c("DefeatConditionSetDescriptionBJ"),FlashQuestDialogButton:c("FlashQuestDialogButtonBJ"),DestroyTimerDialog:c("DestroyTimerDialogBJ"),TimerDialogSetTitle:c("TimerDialogSetTitleBJ"),TimerDialogDisplay:i("TimerDialogDisplayBJ"),DestroyLeaderboard:c("DestroyLeaderboardBJ"),LeaderboardDisplay:i("LeaderboardDisplayBJ"),LeaderboardRemovePlayerItem:i("LeaderboardRemovePlayerItemBJ"),LeaderboardSortItemsByValue:d({LeaderboardSortItemsBJ:{parameters:[0,"LeaderboardSortByValue",1]}}),LeaderboardSortItemsByPlayer:d({LeaderboardSortItemsBJ:{parameters:[0,"LeaderboardSortByPlayer",1]}}),LeaderboardSortItemsByLabel:d({LeaderboardSortItemsBJ:{parameters:[0,"LeaderboardSortByLabel",1]}}),LeaderboardHasPlayerItem:c("LeaderboardHasPlayerItemBJ"),LeaderboardSetLabel:c("LeaderboardSetLabelBJ"),PlayerGetLeaderboard:c("PlayerGetLeaderboardBJ"),LeaderboardSetStyle:c("LeaderboardSetStyleBJ"),DestroyMultiboard:c("DestroyMultiboardBJ"),MultiboardDisplay:i("MultiboardDisplayBJ"),MultiboardMinimize:i("MultiboardMinimizeBJ"),CameraSetupGetField:i("CameraSetupGetFieldSwap"),CameraSetSmoothingFactor:c("CameraSetSmoothingFactorBJ"),DisplayCineFilter:c("DisplayCineFilterBJ"),ForceCinematicSubtitles:c("ForceCinematicSubtitlesBJ"),SetSoundDistanceCutoff:c("SetSoundDistanceCutoffBJ"),SetSoundPitch:c("SetSoundPitchBJ"),AttachSoundToUnit:c("AttachSoundToUnitBJ"),StopSound:d({StopSoundBJ:{test:[1,"false"],parameters:[0,2]}}),KillSoundWhenDone:c("KillSoundWhenDoneBJ"),SetMapMusic:d({SetMapMusicIndexedBJ:{test:[1,"false"],parameters:[0,2]},SetMapMusicRandomBJ:{tests:[[1,"true"],[2,"0"]],parameters:[0]}}),ClearMapMusic:c("ClearMapMusicBJ"),PlayMusic:c("PlayMusicBJ"),StopMusic:c("StopMusicBJ"),ResumeMusic:c("ResumeMusicBJ"),PlayThematicMusic:c("PlayThematicMusicBJ"),EndThematicMusic:c("EndThematicMusicBJ"),VolumeGroupSetVolume:d({VolumeGroupSetVolumeBJ:{parameters:[0,[1,"*",100]]}}),AddWeatherEffect:c("AddWeatherEffectSaveLast"),RemoveWeatherEffect:c("RemoveWeatherEffectBJ"),AddSpecialEffectLoc:i("AddSpecialEffectLocBJ"),AddSpecialEffectTarget:n("AddSpecialEffectTargetUnitBJ"),DestroyEffect:c("DestroyEffectBJ"),DestroyLightning:c("DestroyLightningBJ"),GetLightningColorA:c("GetLightningColorABJ"),GetLightningColorR:c("GetLightningColorRBJ"),GetLightningColorG:c("GetLightningColorGBJ"),GetLightningColorB:c("GetLightningColorBBJ"),SetLightningColor:c("SetLightningColorBJ"),GetAbilityEffectById:c("GetAbilityEffectBJ"),GetAbilitySoundById:c("GetAbilitySoundBJ"),ShowImage:i("ShowImageBJ"),ShowUbersplat:i("ShowUbersplatBJ"),SetBlightRect:r("SetBlightRectBJ"),SetBlightLoc:o("SetBlightRadiusLocBJ"),SetDoodadAnimationRect:d({SetDoodadAnimationRectBJ:{test:[3,"false"],parameters:[2,1,0]}})}}}function Mr(i,e){se||Dr();const t=ct[e.name];return t?t(i,e):Hr(i,e)}let ae=!1,dt;function w(i){return function(e,t){const r=new $;return r.name=i,r.type=e.triggerData.getFunctionType(i),t.value=i,t.type=2,t.subParameters=r,!0}}function Rr(){ae||(ae=!0,dt={bj_forLoopAIndex:w("GetForLoopIndexA"),bj_forLoopBIndex:w("GetForLoopIndexB"),bj_queuedExecTotal:w("QueuedTriggerCountBJ"),bj_mapInitialCameraBounds:w("GetCameraBoundsMapRect"),bj_mapInitialPlayableArea:w("GetPlayableMapRect"),bj_lastCreatedWeatherEffect:w("GetLastCreatedWeatherEffect"),bj_lastCreatedTerrainDeformation:w("GetLastCreatedTerrainDeformation"),bj_lastCreatedLightning:w("GetLastCreatedLightningBJ"),bj_lastCreatedFogModifier:w("GetLastCreatedFogModifier"),bj_lastCreatedImage:w("GetLastCreatedImage"),bj_lastCreatedUbersplat:w("GetLastCreatedUbersplat"),bj_lastPlayedSound:w("GetLastPlayedSound"),bj_lastPlayedMusic:w("GetLastPlayedMusic"),bj_useDawnDuskSounds:w("IsDawnDuskEnabled"),bj_lastCreatedEffect:w("GetLastCreatedEffectBJ"),bj_lastCreatedItem:w("GetLastCreatedItem"),bj_lastRemovedItem:w("GetLastRemovedItem"),bj_lastCreatedUnit:w("GetLastCreatedUnit"),bj_lastReplacedUnit:w("GetLastReplacedUnitBJ"),bj_lastCreatedDestructable:w("GetLastCreatedDestructable"),bj_FORCE_ALL_PLAYERS:w("GetPlayersAll"),bj_lastCreatedButton:w("GetLastCreatedButtonBJ"),bj_lastCreatedQuest:w("GetLastCreatedQuestBJ"),bj_lastCreatedQuestItem:w("GetLastCreatedQuestItemBJ"),bj_lastCreatedDefeatCondition:w("GetLastCreatedDefeatConditionBJ"),bj_lastStartedTimer:w("GetLastCreatedTimerBJ"),bj_lastCreatedTimerDialog:w("GetLastCreatedTimerDialogBJ"),bj_lastCreatedLeaderboard:w("GetLastCreatedLeaderboard"),bj_lastCreatedMultiboard:w("GetLastCreatedMultiboard"),bj_lastCreatedTextTag:w("GetLastCreatedTextTag"),bj_lastTransmissionDuration:w("GetLastTransmissionDurationBJ"),bj_lastCreatedGameCache:w("GetLastCreatedGameCacheBJ"),bj_lastCreatedHashtable:w("GetLastCreatedHashtableBJ"),bj_lastLoadedUnit:w("GetLastRestoredUnitBJ"),bj_lastHauntedGoldMine:w("GetLastHauntedGoldMine")})}function Fr(i,e){ae||Rr();const t=dt[e.value];return t?t(i,e):!1}function Gr(i,e,t){i.push(e);const r=[],n=[];for(const a of e.ecas){const o=a.type;o===0||o===1?r.push(a):o===2&&n.push(a)}const s=[];for(const a of r){const o=oe(i,a,t);if(o.convert)return i.pop(),o;s.push(a)}for(const a of n){const o=oe(i,a,t);if(o.convert){const h=L(i,a,t);i.change("inlinecustomscript",o.reason,h.map(l=>l.parameters[0].value).join(`
`)),s.push(...h)}else s.push(a)}return e.ecas=lt(s),i.pop(),{convert:!1,reason:""}}function oe(i,e,t){i.push(e);const r=le(i,e);if(r.convert){const s=r.reason;if(Br(e)){const a=le(i,e);if(a.convert)return i.pop(),a;i.change("singletomultiple",s,e.name)}else return i.pop(),r}const n=[];for(const s of e.ecas){const a=oe(i,s,t);if(a.convert){let o;if(Ir(e.name,s.group)){let h=L(i,s,t)[0].parameters[0].value;h.startsWith("call ")&&(h=h.slice(5));let l,u;e.name==="OrMultiple"?(l=h,u="true"):(l=`not (${h})`,u="false"),o=[O(`if ${l} then`),O(`return ${u}`),O("endif")]}else o=L(i,s,t);for(const h of o)h.group=s.group;i.change("inlinecustomscript",a.reason,o.map(h=>h.parameters[0].value).join(`
`)),n.push(...o)}else n.push(s)}return e.ecas=lt(n),i.pop(),{convert:!1,reason:""}}function le(i,e,t){const r=e.name;if(Mr(i,e)&&i.change("inlinegui",r,e.name),!i.triggerData.isBaseFunction(e.type,e.name))return{convert:!0,reason:e.name};for(const n of e.parameters){if(n.type===0&&i.triggerData.isCustomPreset(n.value)){const a=n.value;if(Fr(i,n))i.change("inlinepreset",a,n.value);else return{convert:!0,reason:a}}const s=ut(i,n);if(s.convert)return s}return{convert:!1,reason:""}}function ut(i,e,t){i.push(e);const r=e.type,n=e.value;if(r===1)n.startsWith("gg_")&&i.updateGUIReference(n,!0);else if(r===2){const a=$r(i,e.subParameters);if(a.convert)return i.pop(),a}const s=e.arrayIndex;if(s){const a=ut(i,s);if(a.convert)return i.pop(),a}return i.pop(),{convert:!1,reason:""}}function $r(i,e,t){i.push(e);const r=le(i,e);return r.convert?(i.pop(),r):(i.pop(),{convert:!1,reason:""})}function Nr(i,e,t){let r,n,s;try{r=i.readStringTable()}catch(p){return{ok:!1,error:`Failed to read the string table file: ${p}`}}if(!r)return{ok:!1,error:"The string table file doesn't exist"};const a=i.getScriptFile();if(a&&a.name.endsWith(".j"))try{e.addJassFunctions(a.text())}catch{}const o=new wr(e,r);try{n=br(i,e,o)}catch(p){return{ok:!1,error:`Failed to read the triggers file: ${p}`}}if(!n)return{ok:!1,error:"The triggers file doesn't exist"};try{s=i.readCustomTextTriggers()}catch(p){return{ok:!1,error:`Failed to read the custom text triggers file: ${p}`}}if(!s)return{ok:!1,error:"The custom text triggers file doesn't exist"};const h=n.triggers,l=s.triggers,u=s.trigger;if(l.length<h.length)for(let p=0,m=h.length-l.length;p<m;p++)l.push(new K);for(let p=0,m=h.length;p<m;p++){const f=h[p],y=[];try{const b=Gr(o,f,y);if(b.convert){o.push(f);let I=Er(o,f,y);y.length&&(I=`${y.join(`\r
`)}\r
${I}`),l[p].text=I,f.ecas.length=0,f.isCustom=1,o.change("convertedtrigger",b.reason,l[p].text),o.pop()}else if(y.length){const I=y.join(`\r
`);u.text+=`// Callbacks generated for trigger "${f.name}" due to conversions\r
${I}\r
`,o.change("generatedcallbacks",f.name,I)}}catch(b){return{ok:!1,error:`Error at ${o.stackToString()}: ${b}`}}}o.saveGUIReferences(h,l),i.set("war3map.wtg",n.save()),i.set("war3map.wct",s.save());try{n=i.readTriggers(t)}catch(p){return{ok:!1,error:`Failed to validate the triggers file: ${p}`}}return n?{ok:!0,changes:o.changes}:{ok:!1,error:"Failed to re-read the triggers file"}}function P(i){let e="div";i&&i.tagName&&(e=i.tagName);let t=document.createElement(e);return i&&(i.style&&(t.style=i.style),i.className&&(t.className=i.className),i.textContent&&(t.textContent=i.textContent),i.placeholder&&(t.placeholder=i.placeholder),i.readonly&&(t.readonly=!0),i.href&&(t.href=i.href),i.target&&(t.target=i.target),i.title&&(t.title=i.title),i.onclick&&t.addEventListener("click",r=>i.onclick(r,i.component)),i.onchange&&t.addEventListener("change",r=>i.onchange(r,i.component)),i.oninput&&t.addEventListener("input",r=>i.oninput(r,i.component)),i.container&&i.container.appendChild(t)),t}function Or(i){i.classList.add("hidden")}function kr(i){i.classList.remove("hidden")}function H(i,e){let t=i.insertCell();return t.appendChild(document.createTextNode(e)),t}class X{constructor(e){this.container=P({...e,component:this})}hide(){Or(this.container)}show(){kr(this.container)}highlight(){this.container.classList.add("highlighted")}normal(){this.container.classList.remove("highlighted")}}function zr(){return new Promise(i=>{setTimeout(()=>i(),0)})}function Vr(i,e){return i}function ft(i,e){return i=i.toLowerCase(),window.location.hostname==="127.0.0.1"?Vr(`${window.location.origin}/assets?path=${i}`):`https://www.hiveworkshop.com/casc-contents?path=${i}`}class jr extends X{constructor(e,t,r,n){super({...n,tagName:"button",textContent:e,onclick:()=>this.toggle()}),this.offName=e,this.onName=t,this.callback=r,this.clicked=!1}toggle(){this.clicked=!this.clicked,this.clicked?this.container.textContent=this.onName:this.container.textContent=this.offName,this.callback&&this.callback(this)}}class Wr extends X{constructor(e,t){super({tagName:"table",className:"hidden"});let r=this.container.createTBody(),s=this.container.createTHead().insertRow();s.className="header",H(s,"#"),H(s,"Reason"),H(s,"Change"),H(s,"Stack");for(let a=0,o=t.length;a<o;a++){let h=t[a],l=r.insertRow();l.className=h.type,H(l,`${a+1}`),H(l,h.reason),H(l,h.data),H(l,h.stack)}e.changesElement.appendChild(this.container)}}class Kr extends X{constructor(e,t){if(super(),this.changes=null,this.changesToggle=null,t.ok){let r=t.changes;r.length?(P({textContent:`Converted with ${r.length} changes`,container:this.container}),this.changes=new Wr(e,r),this.changesToggle=new jr("Show the changes","Hide the changes",n=>{n.clicked?e.showChanges(this):e.hideChanges()},{container:this.container})):P({textContent:"Found nothing to convert!",container:this.container})}else P({className:"error",textContent:t.error,container:this.container}),P({className:"error",textContent:"Did nothing due to errors",container:this.container})}}class Yr extends X{constructor(e){super({className:"client"}),this.triggerData=new st,this.weTriggerData=new st,this.ready=!1,this.metaElement=P({className:"meta",container:this.container}),this.metaStack=[this.metaElement],this.visibleMeta=null,this.changesElement=P({className:"changes",container:this.container}),this.visibleChanges=null,this.load(),e.appendChild(this.container)}async load(){this.text('Fetching files: "UI\\TriggerData.txt", "TriggerDataWEU.txt", "TriggerDataYDWE.txt", "TriggerDataCustom.txt", "Scripts\\common.j"'),this.text("Please wait...");let[e,t,r,n,s]=await Promise.all([fetch(ft("UI\\TriggerData.txt")),fetch(ft("Scripts\\common.j")),fetch("TriggerDataWEU.txt"),fetch("TriggerDataYDWE.txt"),fetch("TriggerDataCustom.txt")]),[a,o,h,l,u]=await Promise.all([e.text(),t.text(),r.text(),n.text(),s.text()]);this.triggerData.addTriggerData(a),this.triggerData.addJassFunctions(o),this.triggerData.addTriggerData(h,!0),this.triggerData.addTriggerData(l,!0),this.triggerData.addTriggerData(u,!0),this.weTriggerData.addTriggerData(a),this.ready=!0,this.text("Ready, drag and drop a TFT map (*.w3x) or campaign (*.w3n) anywhere on the page")}clear(){this.metaElement.innerHTML="",this.changesElement.innerHTML=""}indent(){this.metaStack.unshift(P({className:"indent",container:this.metaStack[0]}))}deindent(){this.metaStack.shift()}text(e){P({textContent:e,container:this.metaStack[0]}),this.metaElement.scrollTo(0,1e7)}error(e){P({className:"error",textContent:e,container:this.metaStack[0]}),this.metaElement.scrollTo(0,1e7)}results(e){this.metaStack[0].appendChild(new Kr(this,e).container),this.metaElement.scrollTo(0,1e7)}showChanges(e){this.visibleMeta&&this.visibleMeta.changesToggle.toggle(),this.visibleMeta=e,e.changes.show()}hideChanges(){this.visibleMeta&&(this.visibleMeta.changes.hide(),this.visibleMeta=null)}convertMap(e,t){this.text(`Parsing ${e}`);let r=new yr;try{r.load(t)}catch(a){this.error(`Failed to parse: ${a}`),this.error("This map is most likely protected/optimized");return}let n=0,s=Nr(r,this.triggerData,this.weTriggerData);if(this.indent(),s.ok){let a=s.changes;a.length?(n=a.length,this.results(s)):this.text("Found nothing to convert")}else this.error(s.error);return this.deindent(),{parser:r,changes:n}}async convertCampaign(e,t){this.text(`Parsing ${e}`);let r=new nt;try{r.load(t)}catch(a){this.error(`Failed to parse: ${a}`),this.error("This campaign is most likely protected/optimized");return}this.text("Looking for maps");let n=0,s=0;for(let a of r.getFileNames())if(F(a)===".w3x"){this.indent();let o=this.convertMap(a,r.get(a).arrayBuffer());this.deindent(),o&&(n+=o.changes,s+=1,r.set(a,o.parser.save())),await zr()}return n?this.text(`Converted with ${n} changes in ${s} maps`):this.text("Found nothing to convert"),{parser:r,changes:n}}convertFile(e){if(this.ready&&e){let t=e.name,r=F(t),n=r===".w3x",s=r===".w3n";if(this.clear(),n||s){this.text(`Reading ${t}`);let a=new FileReader;a.addEventListener("loadend",async o=>{let h=o.target.result,l;this.indent(),n?l=this.convertMap(t,h):l=await this.convertCampaign(t,h),this.deindent(),l&&l.changes&&(t=`${t.slice(0,-4)}_no_weu${r}`,this.text(`Saving as ${t}`),this.metaElement.scrollTo(0,1e7),saveAs(new Blob([l.parser.save().buffer],{type:"application/octet-stream"}),t))}),a.readAsArrayBuffer(e)}else this.error(`${t} is not a TFT map/campaign`)}}}const Qr=new Yr(document.body);document.addEventListener("dragover",i=>{i.preventDefault()}),document.addEventListener("dragend",i=>{i.preventDefault()}),document.addEventListener("drop",i=>{i.preventDefault(),Qr.convertFile(i.dataTransfer.files[0])})}));
