(function(Ce,gt){typeof exports=="object"&&typeof module<"u"?gt(require("pako"),require("tga-js"),require("events"),require("gl-matrix")):typeof define=="function"&&define.amd?define(["pako","tga-js","events","gl-matrix"],gt):(Ce=typeof globalThis<"u"?globalThis:Ce||self,gt(Ce.pako,Ce.TGA,Ce.EventEmitter,Ce.glMatrix))})(this,(function(Ce,gt,_r,f){"use strict";function mt(n){if(n&&n.length){let e=n.lastIndexOf("/");return e!==-1&&(n=n.slice(e+1)),e=n.lastIndexOf("\\"),e!==-1&&(n=n.slice(e+1)),n}return""}function ze(n){if(n&&n.length){const e=n.lastIndexOf(".");return e!==-1&&(n=n.slice(e).toLowerCase()),n}return""}function ke(n){n=mt(n);const e=n.lastIndexOf(".");return e!==-1&&(n=n.slice(0,e)),n}const Cr=new TextDecoder,Lr=new TextEncoder;function Ut(n){return Cr.decode(n)}function mi(n){return Lr.encode(n)}function O(n){let e=n.length;for(let t=n.length-1;t>=0;t--){const i=n.charCodeAt(t);i>127&&i<=2047?e++:i>2047&&i<=65535&&(e+=2),i>=56320&&i<=57343&&t--}return e}function $e(n){return n instanceof Uint8Array?n:typeof n=="string"?mi(n):new Uint8Array(n)}function on(n,e,t=0,i=1/0){const s=Math.max(t,0),r=Math.min(s+i,n.length);let o=0,a=e.charCodeAt(0);for(let l=s;l<r;l++)if(n[l]===a){if(o+=1,o===e.length)return!0;a=e.charCodeAt(o)}else o>0&&(o=0,a=e.charCodeAt(0));return!1}function Br(n,e,t=0,i=1/0){const s=Math.max(t,0),r=Math.min(s+i,n.length);let o=0,a=e[0];for(let l=s;l<r;l++)if(n[l]===a){if(o+=1,o===e.length)return!0;a=e[o]}else o>0&&(o=0,a=e[0]);return!1}function Rr(n,e,t=0,i=1/0){const s=Math.max(t,0),r=Math.min(s+i,n.length);for(let o=s;o<r;o++)if(n[o]===e)return o;return-1}const Ue=new ArrayBuffer(8),an=new Int8Array(Ue),ln=new Int16Array(Ue),cn=new Int32Array(Ue),L=new Uint8Array(Ue),hn=new Uint16Array(Ue),Ft=new Uint32Array(Ue),dn=new Float32Array(Ue),fn=new Float64Array(Ue);function un(n){return L[0]=n,an[0]}function pn(n,e){return L[0]=n,L[1]=e,ln[0]}function gn(n,e,t,i){return L[0]=n,L[1]=e,L[2]=t,L[3]=i,cn[0]}function mn(n,e){return L[0]=n,L[1]=e,hn[0]}function bn(n,e,t,i){return L[0]=n,L[1]=e,L[2]=t,L[3]=i,Ft[0]}function wn(n,e,t,i){return L[0]=n,L[1]=e,L[2]=t,L[3]=i,dn[0]}function vn(n,e,t,i,s,r,o,a){return L[0]=n,L[1]=e,L[2]=t,L[3]=i,L[4]=s,L[5]=r,L[6]=o,L[7]=a,fn[0]}function yn(n){return L[0]=n,an[0]}function An(n,e){return ln[0]=e,n[0]=L[0],n[1]=L[1],n}function Tn(n,e){return cn[0]=e,n[0]=L[0],n[1]=L[1],n[2]=L[2],n[3]=L[3],n}function xn(n,e){return hn[0]=e,n[0]=L[0],n[1]=L[1],n}function En(n,e){return Ft[0]=e,n[0]=L[0],n[1]=L[1],n[2]=L[2],n[3]=L[3],n}function Sn(n,e){return dn[0]=e,n[0]=L[0],n[1]=L[1],n[2]=L[2],n[3]=L[3],n}function In(n,e){return fn[0]=e,n[0]=L[0],n[1]=L[1],n[2]=L[2],n[3]=L[3],n[4]=L[4],n[5]=L[5],n[6]=L[6],n[7]=L[7],n}function _n(n){return Ft[0]=n,Ft[0]}function Pr(n){const e=[];for(;n>0;)e.push(String.fromCharCode(n%256)),n=Math.floor(n/256);return e.reverse().join("")}const E=new Uint8Array(8);class X{buffer;uint8array;index=0;byteLength;remaining;constructor(e,t,i){const s=$e(e);t=t||0,i=i||s.length,this.buffer=e,this.uint8array=s.subarray(t,t+i),this.byteLength=i,this.remaining=i}substream(e){if(this.remaining<e)throw new Error(`ByteStream: substream: want ${e} bytes but have ${this.remaining}`);const t=this.index;return this.index+=e,new X(this.uint8array.subarray(t,t+e))}skip(e){if(this.remaining<e)throw new Error(`ByteStream: skip: premature end - want ${e} bytes but have ${this.remaining}`);this.index+=e,this.remaining-=e}seek(e){this.index=e,this.remaining=this.byteLength-e}read(e){if(this.remaining<e)throw new Error(`ByteStream: read: premature end - want ${e} bytes but have ${this.remaining}`);const t=this.uint8array,i=this.index;let s=Rr(t,0,i,e);return s===-1&&(s=i+e),this.index+=e,this.remaining-=e,Ut(t.subarray(i,s))}readNull(){if(this.remaining<1)throw new Error("ByteStream: readNull: premature end - want at least 1 byte but have 0");const e=this.uint8array,t=this.index;let i=e.indexOf(0,t);i===-1&&(i=e.length-1);const s=i-t+1;return this.index+=s,this.remaining-=s,Ut(e.subarray(t,i))}readBinary(e){if(this.remaining<e)throw new Error(`ByteStream: readBinary: premature end - want ${e} bytes but have ${this.remaining}`);const t=this.uint8array,i=this.index;let s="";for(let r=0;r<e;r++)s+=String.fromCharCode(t[i+r]);return this.index+=e,this.remaining-=e,s}readInt8(){if(this.remaining<1)throw new Error(`ByteStream: readInt8: premature end - want 1 byte but have ${this.remaining}`);const e=this.index,t=this.uint8array,i=un(t[e]);return this.index+=1,this.remaining-=1,i}readInt16(){if(this.remaining<2)throw new Error(`ByteStream: readInt16: premature end - want 2 bytes but have ${this.remaining}`);const e=this.index,t=this.uint8array,i=pn(t[e],t[e+1]);return this.index+=2,this.remaining-=2,i}readInt32(){if(this.remaining<4)throw new Error(`ByteStream: readInt32: premature end - want 4 bytes but have ${this.remaining}`);const e=this.index,t=this.uint8array,i=gn(t[e],t[e+1],t[e+2],t[e+3]);return this.index+=4,this.remaining-=4,i}readUint8(){if(this.remaining<1)throw new Error(`ByteStream: readUint8: premature end - want 1 byte but have ${this.remaining}`);const e=this.uint8array[this.index];return this.index+=1,this.remaining-=1,e}readUint16(){if(this.remaining<2)throw new Error(`ByteStream: readUint16: premature end - want 2 bytes but have ${this.remaining}`);const e=this.index,t=this.uint8array,i=mn(t[e],t[e+1]);return this.index+=2,this.remaining-=2,i}readUint32(){if(this.remaining<4)throw new Error(`ByteStream: readUint32: premature end - want 4 bytes but have ${this.remaining}`);const e=this.index,t=this.uint8array,i=bn(t[e],t[e+1],t[e+2],t[e+3]);return this.index+=4,this.remaining-=4,i}readFloat32(){if(this.remaining<4)throw new Error(`ByteStream: readFloat32: premature end - want 4 bytes but have ${this.remaining}`);const e=this.index,t=this.uint8array,i=wn(t[e],t[e+1],t[e+2],t[e+3]);return this.index+=4,this.remaining-=4,i}readFloat64(){if(this.remaining<8)throw new Error(`ByteStream: readFloat64: premature end - want 8 bytes but have ${this.remaining}`);const e=this.index,t=this.uint8array,i=vn(t[e],t[e+1],t[e+2],t[e+3],t[e+4],t[e+5],t[e+6],t[e+7]);return this.index+=8,this.remaining-=8,i}readInt8Array(e){if(ArrayBuffer.isView(e)||(e=new Int8Array(e)),this.remaining<e.byteLength)throw new Error(`ByteStream: readInt8Array: premature end - want ${e.byteLength} bytes but have ${this.remaining}`);const t=this.index,i=this.uint8array;for(let s=0,r=e.length;s<r;s++)e[s]=un(i[t+s]);return this.index+=e.byteLength,this.remaining-=e.byteLength,e}readInt16Array(e){if(ArrayBuffer.isView(e)||(e=new Int16Array(e)),this.remaining<e.byteLength)throw new Error(`ByteStream: readInt16Array: premature end - want ${e.byteLength} bytes but have ${this.remaining}`);const t=this.index,i=this.uint8array;for(let s=0,r=e.length;s<r;s++){const o=t+s*2;e[s]=pn(i[o],i[o+1])}return this.index+=e.byteLength,this.remaining-=e.byteLength,e}readInt32Array(e){if(ArrayBuffer.isView(e)||(e=new Int32Array(e)),this.remaining<e.byteLength)throw new Error(`ByteStream: readInt32Array: premature end - want ${e.byteLength} bytes but have ${this.remaining}`);const t=this.index,i=this.uint8array;for(let s=0,r=e.length;s<r;s++){const o=t+s*4;e[s]=gn(i[o],i[o+1],i[o+2],i[o+3])}return this.index+=e.byteLength,this.remaining-=e.byteLength,e}readUint8Array(e){if(ArrayBuffer.isView(e)||(e=new Uint8Array(e)),this.remaining<e.byteLength)throw new Error(`ByteStream: readUint8Array: premature end - want ${e.byteLength} bytes but have ${this.remaining}`);const t=this.index,i=this.uint8array;for(let s=0,r=e.length;s<r;s++)e[s]=i[t+s];return this.index+=e.byteLength,this.remaining-=e.byteLength,e}readUint16Array(e){if(ArrayBuffer.isView(e)||(e=new Uint16Array(e)),this.remaining<e.byteLength)throw new Error(`ByteStream: readUint16Array: premature end - want ${e.byteLength} bytes but have ${this.remaining}`);const t=this.index,i=this.uint8array;for(let s=0,r=e.length;s<r;s++){const o=t+s*2;e[s]=mn(i[o],i[o+1])}return this.index+=e.byteLength,this.remaining-=e.byteLength,e}readUint32Array(e){if(ArrayBuffer.isView(e)||(e=new Uint32Array(e)),this.remaining<e.byteLength)throw new Error(`ByteStream: readUint32Array: premature end - want ${e.byteLength} bytes but have ${this.remaining}`);const t=this.index,i=this.uint8array;for(let s=0,r=e.length;s<r;s++){const o=t+s*4;e[s]=bn(i[o],i[o+1],i[o+2],i[o+3])}return this.index+=e.byteLength,this.remaining-=e.byteLength,e}readFloat32Array(e){if(ArrayBuffer.isView(e)||(e=new Float32Array(e)),this.remaining<e.byteLength)throw new Error(`ByteStream: readFloat32Array: premature end - want ${e.byteLength} bytes but have ${this.remaining}`);const t=this.index,i=this.uint8array;for(let s=0,r=e.length;s<r;s++){const o=t+s*4;e[s]=wn(i[o],i[o+1],i[o+2],i[o+3])}return this.index+=e.byteLength,this.remaining-=e.byteLength,e}readFloat64Array(e){if(ArrayBuffer.isView(e)||(e=new Float64Array(e)),this.remaining<e.byteLength)throw new Error(`ByteStream: readFloat64Array: premature end - want ${e.byteLength} bytes but have ${this.remaining}`);const t=this.index,i=this.uint8array;for(let s=0,r=e.length;s<r;s++){const o=t+s*8;e[s]=vn(i[o],i[o+1],i[o+2],i[o+3],i[o+4],i[o+5],i[o+6],i[o+7])}return this.index+=e.byteLength,this.remaining-=e.byteLength,e}write(e){const t=mi(e);return this.writeUint8Array(t),t.length}writeNull(e){const t=this.write(e);return this.index++,this.remaining--,t+1}writeBinary(e){const t=this.index,i=this.uint8array,s=e.length;for(let r=0;r<s;r++)i[t+r]=e.charCodeAt(r);this.index+=s}writeInt8(e){this.uint8array[this.index]=yn(e),this.index+=1}writeInt16(e){const t=this.index,i=this.uint8array;An(E,e),i[t]=E[0],i[t+1]=E[1],this.index+=2}writeInt32(e){const t=this.index,i=this.uint8array;Tn(E,e),i[t]=E[0],i[t+1]=E[1],i[t+2]=E[2],i[t+3]=E[3],this.index+=4}writeUint8(e){this.uint8array[this.index]=e,this.index+=1}writeUint16(e){const t=this.index,i=this.uint8array;xn(E,e),i[t]=E[0],i[t+1]=E[1],this.index+=2}writeUint32(e){const t=this.index,i=this.uint8array;En(E,e),i[t]=E[0],i[t+1]=E[1],i[t+2]=E[2],i[t+3]=E[3],this.index+=4}writeFloat32(e){const t=this.index,i=this.uint8array;Sn(E,e),i[t]=E[0],i[t+1]=E[1],i[t+2]=E[2],i[t+3]=E[3],this.index+=4}writeFloat64(e){const t=this.index,i=this.uint8array;In(E,e),i[t]=E[0],i[t+1]=E[1],i[t+2]=E[2],i[t+3]=E[3],i[t+4]=E[4],i[t+5]=E[5],i[t+6]=E[6],i[t+7]=E[7],this.index+=8}writeInt8Array(e){const t=this.index,i=this.uint8array;for(let s=0,r=e.length;s<r;s++)i[t+s]=yn(e[s]);this.index+=e.byteLength}writeInt16Array(e){const t=this.index,i=this.uint8array;for(let s=0,r=e.length;s<r;s++){const o=t+s*2;An(E,e[s]),i[o]=E[0],i[o+1]=E[1]}this.index+=e.byteLength}writeInt32Array(e){const t=this.index,i=this.uint8array;for(let s=0,r=e.length;s<r;s++){const o=t+s*4;Tn(E,e[s]),i[o]=E[0],i[o+1]=E[1],i[o+2]=E[2],i[o+3]=E[3]}this.index+=e.byteLength}writeUint8Array(e){const t=this.index,i=this.uint8array;for(let s=0,r=e.length;s<r;s++)i[t+s]=e[s];this.index+=e.byteLength}writeUint16Array(e){const t=this.index,i=this.uint8array;for(let s=0,r=e.length;s<r;s++){const o=t+s*2;xn(E,e[s]),i[o]=E[0],i[o+1]=E[1]}this.index+=e.byteLength}writeUint32Array(e){const t=this.index,i=this.uint8array;for(let s=0,r=e.length;s<r;s++){const o=t+s*4;En(E,e[s]),i[o]=E[0],i[o+1]=E[1],i[o+2]=E[2],i[o+3]=E[3]}this.index+=e.byteLength}writeFloat32Array(e){const t=this.index,i=this.uint8array;for(let s=0,r=e.length;s<r;s++){const o=t+s*4;Sn(E,e[s]),i[o]=E[0],i[o+1]=E[1],i[o+2]=E[2],i[o+3]=E[3]}this.index+=e.byteLength}writeFloat64Array(e){const t=this.index,i=this.uint8array;for(let s=0,r=e.length;s<r;s++){const o=t+s*8;In(E,e[s]),i[o]=E[0],i[o+1]=E[1],i[o+2]=E[2],i[o+3]=E[3],i[o+4]=E[4],i[o+5]=E[5],i[o+6]=E[6],i[o+7]=E[7]}this.index+=e.byteLength}}function kr(n){return n*(Math.PI/180)}function Fe(n,e){return n+Math.random()*(e-n)}function Ur(n,e,t){return n+t*(e-n)}function Fr(n,e,t,i,s){const r=s*s,o=r*(2*s-3)+1,a=r*(s-2)+s,l=r*(s-1),c=r*(3-2*s);return n*o+e*a+t*l+i*c}function Nr(n,e,t,i,s){const r=1-s,o=s*s,a=r*r,l=a*r,c=3*s*a,d=3*o*r,h=o*s;return n*l+e*c+t*d+i*h}function Mr(n){return n--,n|=n>>1,n|=n>>2,n|=n>>4,n|=n>>8,n|=n>>16,n++,n}function xe(n){return n===0?!1:(n&n-1)===0}class Cn{offset=0;compressedSize=0;normalSize=0;flags=0;load(e){this.offset=e[0],this.compressedSize=e[1],this.normalSize=e[2],this.flags=e[3]}save(e){e[0]=this.offset,e[1]=this.compressedSize,e[2]=this.normalSize,e[3]=this.flags}}const Or=441536589,Ln=3283040112,Bn=0,Rn=1,Pn=2,Dr=3,Nt=4294967294,kn=4294967295,Un=3968054179,Vr=256,bi=512,wi=65536,Fn=131072,Nn=16777216,Mt=2147483648,Gr=1,$r=2,qr=8,Kr=16,jr=64,Hr=128;class zr{c;entries;constructor(e){this.c=e,this.entries=[]}add(e){const t=new Cn;return t.normalSize=e.byteLength,this.entries.push(t),t}clear(){this.entries.length=0}addEmpties(e){for(let t=0;t<e;t++)this.entries.push(new Cn)}load(e){const t=e.byteLength/16,i=new Uint32Array(this.c.decryptBlock(e,Un).buffer);let s=0;this.clear(),this.addEmpties(t);for(const r of this.entries)r.load(i.subarray(s,s+4)),s+=4}save(e){const t=new Uint32Array(this.entries.length*4);let i=0;for(const r of this.entries)r.save(t.subarray(i,i+4)),i+=4;const s=new Uint8Array(t.buffer);this.c.encryptBlock(s,Un),e.set(s)}}const te=new Uint8Array(4),Ot=new Uint32Array(te.buffer);class Xr{cryptTable=new Uint32Array(1280);constructor(){let e=1048577,t=0,i=0;for(let s=0;s<256;s++)for(let r=s,o=0;o<5;o+=1,r+=256)e=(e*125+3)%2796203,t=(e&65535)<<16,e=(e*125+3)%2796203,i=e&65535,this.cryptTable[r]=t|i}hash(e,t){const i=this.cryptTable;let s=2146271213,r=4008636142;e=e.toUpperCase();for(let o=0;o<e.length;o++){const a=e.charCodeAt(o);s=i[(t<<8)+a]^s+r,r=a+s+r+(r<<5)+3}return s>>>0}decryptBlock(e,t){const i=this.cryptTable;let s=4008636142;const r=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);for(let o=0,a=e.byteLength>>>2;o<a;o++)s+=i[1024+(t&255)],te[0]=r[o*4],te[1]=r[o*4+1],te[2]=r[o*4+2],te[3]=r[o*4+3],Ot[0]^=t+s,t=(~t<<21)+286331153|t>>>11,s=Ot[0]+s+(s<<5)+3,r[o*4]=te[0],r[o*4+1]=te[1],r[o*4+2]=te[2],r[o*4+3]=te[3];return e}encryptBlock(e,t){const i=this.cryptTable;let s=4008636142;const r=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);for(let o=0,a=e.byteLength>>>2;o<a;o++){s+=i[1024+(t&255)],te[0]=r[o*4],te[1]=r[o*4+1],te[2]=r[o*4+2],te[3]=r[o*4+3];const l=Ot[0];Ot[0]^=t+s,t=(~t<<21)+286331153|t>>>11,s=l+s+(s<<5)+3,r[o*4]=te[0],r[o*4+1]=te[1],r[o*4+2]=te[2],r[o*4+3]=te[3]}return e}computeFileKey(e,t){const i=e.lastIndexOf("\\"),s=e.substring(i+1);let r=this.hash(s,Dr);return t.flags&Fn&&(r=r+t.offset^t.normalSize),r}}const Mn=0,Wr=1;class Yr{ctype=0;outputPos=0;dsize_bits=0;dsize_mask=0;bit_buff=0;extra_bits=0;in_pos=0;in_buff;out_buff=[];constructor(e){this.in_buff=e}}const On=0,Zr=1,Dn=new Uint8Array([2,4,4,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8]),Qr=new Uint8Array([3,13,5,25,9,17,1,62,30,46,14,54,22,38,6,58,26,42,10,50,18,34,66,2,124,60,92,28,108,44,76,12,116,52,84,20,100,36,68,4,120,56,88,24,104,40,72,8,240,112,176,48,208,80,144,16,224,96,160,32,192,64,128,0]),Jr=new Uint8Array([0,0,0,0,0,0,0,0,1,2,3,4,5,6,7,8]),eo=new Uint16Array([0,1,2,3,4,5,6,7,8,10,14,22,38,70,134,262]),Vn=new Uint8Array([3,2,3,3,4,4,4,5,5,5,5,6,6,6,7,7]),to=new Uint8Array([5,3,1,6,10,2,12,20,4,24,8,48,16,32,64,0]),bt=new Uint8Array([11,12,12,12,12,12,12,12,12,8,7,12,12,7,12,12,12,12,12,12,12,12,12,12,12,12,13,12,12,12,12,12,4,10,8,12,10,12,10,8,7,7,8,9,7,6,7,8,7,6,7,7,7,7,8,7,7,8,8,12,11,7,9,11,12,6,7,6,6,5,7,8,8,6,11,9,6,7,6,6,7,11,6,6,6,7,9,8,9,9,11,8,11,9,12,8,12,5,6,6,6,5,6,6,6,5,11,7,5,6,5,5,6,10,5,5,5,5,8,7,8,8,10,11,11,12,12,12,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,13,12,13,13,13,12,13,13,13,12,13,13,13,13,12,13,13,13,12,12,12,13,13,13,13,13,13,13,13,13,13,13]),Xe=new Uint16Array([1168,4064,2016,3040,992,3552,1504,2528,480,184,98,3808,1760,34,2784,736,3296,1248,2272,224,3936,1888,2912,864,3424,1376,4672,2400,352,3680,1632,2656,15,592,56,608,80,3168,912,216,66,2,88,432,124,41,60,152,92,9,28,108,44,76,24,12,116,232,104,1120,144,52,176,1808,2144,49,84,17,33,23,20,168,40,1,784,304,62,100,30,46,36,1296,14,54,22,68,48,200,464,208,272,72,1552,336,96,136,4e3,7,38,6,58,27,26,42,10,11,528,4,19,50,3,29,18,400,13,21,5,25,8,120,240,112,656,1040,16,1952,2976,928,576,7232,3136,5184,1088,6208,2112,4160,64,8064,3968,6016,1920,7040,2944,4992,896,7552,3456,5504,1408,6528,2432,4480,384,7808,3712,5760,1664,6784,2688,4736,640,7296,3200,5248,1152,6272,2176,4224,128,7936,3840,5888,1792,6912,2816,4864,3488,1440,2464,416,3744,1696,2720,672,3232,1184,2208,160,3872,1824,2848,800,3360,1312,2336,288,3616,1568,2592,544,3104,1056,2080,32,4032,1984,3008,960,3520,1472,2496,448,3776,1728,2752,704,3264,1216,2240,192,3904,1856,2880,832,768,3392,7424,3328,5376,1344,1280,6400,2304,2368,4352,256,7680,3584,320,5632,1536,6656,3648,1600,2624,2560,4608,512,7168,3072,5120,1024,6144,2048,4096,0]);let Gn=!1;const $n=new Uint8Array(256),qn=new Uint8Array(256);let Kn=!1;const vi=new Uint8Array(256),jn=new Uint8Array(256),Hn=new Uint8Array(128),zn=new Uint8Array(256);function Xn(n,e,t){for(let i=0,s=e.length;i<s;i++){const r=1<<t[i];for(let o=e[i];o<256;o+=r)n[o]=i}}function io(){let n=255,e,t;for(let i=255;n>=0;n--,i--){const s=i;let r=bt[s];if(r<=8){t=1<<r,e=Xe[n];do vi[e]=i,e+=t;while(e<256)}else if((e=Xe[n]&255)!=0)if(vi[e]=255,Xe[n]&63){r-=4,bt[s]=r,t=1<<r,e=Xe[n]>>4;do jn[e]=i,e+=t;while(e<256)}else{r-=6,bt[s]=r,t=1<<r,e=Xe[n]>>6;do Hn[e]=i,e+=t;while(e<128)}else{r-=8,bt[s]=r,t=1<<r,e=Xe[n]>>8;do zn[e]=i,e+=t;while(e<256)}}}function me(n,e){return e<=n.extra_bits?(n.extra_bits-=e,n.bit_buff>>=e,On):(n.bit_buff>>=n.extra_bits,n.in_pos===n.in_buff.byteLength?Zr:(n.bit_buff|=n.in_buff[n.in_pos++]<<8,n.bit_buff>>=e-n.extra_bits,n.extra_bits=n.extra_bits-e+8,On))}function no(n){if(n.bit_buff&1){if(me(n,1))return 774;let t=qn[n.bit_buff&255];if(me(n,Vn[t]))return 774;let i;if((i=Jr[t])!=0){const s=n.bit_buff&(1<<i)-1;if(me(n,i)&&t+s!=270)return 774;t=eo[t]+s}return t+256}if(me(n,1))return 774;if(n.ctype==Mn){const t=n.bit_buff&255;return me(n,8)?774:t}let e;if(n.bit_buff&255){if(e=vi[n.bit_buff&255],e==255)if(n.bit_buff&63){if(me(n,4))return 774;e=jn[n.bit_buff&255]}else{if(me(n,6))return 774;e=Hn[n.bit_buff&127]}}else{if(me(n,8))return 774;e=zn[n.bit_buff&255]}return me(n,bt[e])?774:e}function so(n,e){const t=$n[n.bit_buff&255],i=Dn[t];if(me(n,i))return 0;let s;if(e==2){if(s=t<<2|n.bit_buff&3,me(n,2))return 0}else if(s=t<<n.dsize_bits|n.bit_buff&n.dsize_mask,me(n,n.dsize_bits))return 0;return s+1}function ro(n){let e;for(;(e=no(n))<773;)if(e>=256){let t=e-254,i;if((i=so(n,t))==0)return 774;let s=n.outputPos,r=s-i;for(n.outputPos+=t;t-- >0;)n.out_buff[s++]=n.out_buff[r++]}else n.out_buff[n.outputPos++]=e;return e}function Wn(n){const e=new Yr(n);if(e.in_buff.byteLength<=4)throw new Error("Bad data");if(e.ctype=e.in_buff[0],e.dsize_bits=e.in_buff[1],e.bit_buff=e.in_buff[2],e.extra_bits=0,e.in_pos=3,4>e.dsize_bits||e.dsize_bits>6)throw new Error("Invalid dictionary size");if(e.dsize_mask=65535>>16-e.dsize_bits,e.ctype!==Mn){if(e.ctype!==Wr)throw new Error("Invalid mode");Kn||(io(),Kn=!0)}if(Gn||(Xn(qn,to,Vn),Xn($n,Qr,Dn),Gn=!0),ro(e)===774)throw new Error("Error while expanding");return new Uint8Array(e.out_buff)}function Yn(n){let e=-1;for(let t=0,i=Math.ceil(n.byteLength/512);t<i;t++){const s=t*512;n[s]===77&&n[s+1]===80&&n[s+2]===81&&n[s+3]===26&&(e=s)}return e}function oo(n){return n[0]===72&&n[1]===77&&n[2]===51&&n[3]===87?!0:Yn(n)!==-1}class Zn{archive;c;name;nameResolved;hash;block;rawBuffer=null;buffer=null;constructor(e,t,i,s,r){const o=e.headerOffset;this.archive=e,this.c=e.c,this.name=`File${`${t.blockIndex}`.padStart(8,"0")}`,this.nameResolved=!1,this.hash=t,this.block=i,s&&(this.rawBuffer=s.slice(o+i.offset,o+i.offset+i.compressedSize)),r&&(this.buffer=r)}bytes(){return this.buffer===null&&this.decode(),this.buffer}arrayBuffer(){return this.bytes().buffer}text(){return Ut(this.bytes())}set(e){if(this.archive.readonly)return!1;const t=this.hash,i=this.block;return t.locale=0,t.platform=0,i.compressedSize=0,i.normalSize=e.byteLength,i.flags=0,this.buffer=e,this.rawBuffer=null,!0}delete(){if(this.archive.readonly)return!1;const e=this.archive,t=this.hash,i=t.blockIndex;t.delete();for(const s of e.hashTable.entries)s.blockIndex<Nt&&s.blockIndex>i&&(s.blockIndex-=1);return e.blockTable.entries.splice(i,1),e.files.splice(i,1),!0}rename(e){if(this.archive.readonly)return!1;const t=this.hash,i=t.locale,s=t.platform,r=t.blockIndex;t.delete();const o=this.archive.hashTable.add(e,r);return o.locale=i,o.platform=s,this.name=e,this.nameResolved=!0,this.hash=o,!0}decode(){if(!this.rawBuffer)throw new Error(`File ${this.name}: Nothing to decode`);const e=this.archive,t=this.block,i=e.c,s=i.computeFileKey(this.name,t),r=this.rawBuffer,o=t.flags;if(o===Mt)this.buffer=r.slice(0,t.normalSize);else if(o&Nn){let a;o&wi?a=i.decryptBlock(r.slice(0,t.compressedSize),s):a=r.subarray(0,t.compressedSize),o&bi?a=this.decompressSector(a,t.normalSize):a=a.slice(),this.buffer=a}else{const a=Math.ceil(t.normalSize/e.sectorSize),l=new Uint8Array(t.normalSize);let c=new Uint32Array(r.buffer,0,a+1);o&wi&&(c=i.decryptBlock(c.slice(),s-1));let d=c[0],h=c[1],u=0;for(let p=0;p<a;p++){let g;if(o&wi?g=i.decryptBlock(r.slice(d,h),s+p):g=r.subarray(d,h),o&bi){let m=e.sectorSize;t.normalSize-u<m&&(m=t.normalSize-u),g=this.decompressSector(g,m)}o&Vr&&(g=Wn(g)),l.set(g,u),u+=g.byteLength,p<a&&(d=h,h=c[p+2])}this.buffer=l}e.readonly&&(this.rawBuffer=null)}decompressSector(e,t){if(e.byteLength===t)return e;{const i=e[0];if(i&Kr)throw new Error(`File ${this.name}: compression type 'bzip2' not supported`);if(i&qr)try{e=Wn(e.subarray(1))}catch(s){throw new Error(`File ${this.name}: failed to decompress with 'explode': ${s}`)}if(i&$r)try{e=Ce.inflate(e.subarray(1))}catch(s){throw new Error(`File ${this.name}: failed to decompress with 'zlib': ${s}`)}if(i&Gr)throw new Error(`File ${this.name}: compression type 'huffman' not supported`);if(i&Hr)throw new Error(`File ${this.name}: compression type 'adpcm stereo' not supported`);if(i&jr)throw new Error(`File ${this.name}: compression type 'adpcm mono' not supported`);return e}}encode(){if(this.buffer!==null&&this.rawBuffer===null){const e=this.buffer;if(oo(e))this.rawBuffer=this.buffer,this.block.compressedSize=this.buffer.byteLength,this.block.flags=Mt;else{const t=this.archive.sectorSize,i=Math.ceil(e.byteLength/t),s=new Uint32Array(i+1);let r=s.byteLength;const o=[],a=[];s[0]=r;for(let l=0;l<i;l++){const c=l*t;let d=e.subarray(c,c+t),h=d.byteLength;const u=Ce.deflate(d);let p=!1;u.byteLength+1<h&&(d=u,h=u.byteLength+1,p=!0),r+=h,s[l+1]=r,o[l]=d,a[l]=p}if(r<e.byteLength){const l=new Uint8Array(r);l.set(new Uint8Array(s.buffer)),r=s.byteLength;for(let c=0;c<i;c++){a[c]&&(l[r]=2,r+=1);const d=o[c];l.set(d,r),r+=d.byteLength}this.rawBuffer=l,this.block.compressedSize=l.byteLength,this.block.flags=(Mt|bi)>>>0}else this.rawBuffer=this.buffer,this.block.compressedSize=this.buffer.byteLength,this.block.flags=Mt}}}reEncrypt(e){if(!this.rawBuffer)return!1;const t=this.archive,i=this.block,s=t.c,r=this.rawBuffer,o=i.flags,a=s.computeFileKey(this.name,i);i.offset=e;const l=s.computeFileKey(this.name,i);if(o&Nn)s.decryptBlock(r,a),s.encryptBlock(r,l);else{const c=Math.ceil(i.normalSize/t.sectorSize),d=new Uint32Array(r.buffer,0,c+1);s.decryptBlock(d,a-1);let h=d[0],u=d[1];for(let p=0;p<c;p++){const g=r.subarray(h,u);s.decryptBlock(g,a+p),s.encryptBlock(g,l+p),p<c&&(h=u,u=d[p+2])}s.encryptBlock(d,l-1)}return!0}offsetChanged(e){const t=this.block;return t.offset!==e&&t.flags&Fn?this.nameResolved?this.reEncrypt(e):!1:(t.offset=e,!0)}}class ao{nameA=4294967295;nameB=4294967295;locale=65535;platform=65535;blockIndex=kn;load(e){const t=e[2];this.nameA=e[0],this.nameB=e[1],this.locale=t&65535,this.platform=t>>>16,this.blockIndex=e[3]}copy(e){this.nameA=e.nameA,this.nameB=e.nameB,this.locale=e.locale,this.platform=e.platform,this.blockIndex=e.blockIndex}save(e){e[0]=this.nameA,e[1]=this.nameB,e[2]=this.locale<<16|this.platform,e[3]=this.blockIndex}delete(){this.nameA=4294967295,this.nameB=4294967295,this.locale=65535,this.platform=65535,this.blockIndex=Nt}}class lo{c;entries;constructor(e){this.c=e,this.entries=[],this.addEmpties(4)}clear(){this.entries.length=0}addEmpties(e){for(let t=0;t<e;t++)this.entries.push(new ao)}getInsertionIndex(e){const t=this.entries,i=this.c.hash(e,Bn)&t.length-1;for(let s=0,r=t.length;s<r;s++){const o=(s+i)%r;if(t[o].platform===65535)return o}return-1}add(e,t){const i=this.getInsertionIndex(e);if(i!==-1){const s=this.entries[i];return s.nameA=this.c.hash(e,Rn),s.nameB=this.c.hash(e,Pn),s.locale=0,s.platform=0,s.blockIndex=t,s}}load(e){const t=e.byteLength/16,i=new Uint32Array(this.c.decryptBlock(e,Ln).buffer);let s=0;this.clear(),this.addEmpties(t);for(const r of this.entries)r.load(i.subarray(s,s+4)),s+=4}save(e){const t=new Uint32Array(this.entries.length*4);let i=0;for(const r of this.entries)r.save(t.subarray(i,i+4)),i+=4;const s=new Uint8Array(t.buffer);this.c.encryptBlock(s,Ln),e.set(s)}get(e){const t=this.c,i=this.entries,s=t.hash(e,Bn)&i.length-1,r=t.hash(e,Rn),o=t.hash(e,Pn);for(let a=0,l=i.length;a<l;a++){const c=i[(a+s)%l];if(r===c.nameA&&o===c.nameB)return c;if(c.blockIndex===4294967295)return null}return null}}class co{headerOffset;sectorSize;c;hashTable;blockTable;files;readonly=!1;constructor(){this.headerOffset=0,this.sectorSize=4096,this.c=new Xr,this.hashTable=new lo(this.c),this.blockTable=new zr(this.c),this.files=[]}load(e,t=!1){const i=$e(e);this.readonly=t;const s=Yn(i);if(s===-1)throw new Error("No MPQ header");const r=new Uint32Array(i.buffer,s,8),o=r[3],a=_n(r[4]+s),l=_n(r[5]+s),c=r[6];let d=r[7];d>c&&(d=c),this.headerOffset=s,this.sectorSize=512*(1<<(o>>>16)),this.hashTable.load(i.slice(a,a+c*16)),this.blockTable.load(i.slice(l,l+d*16)),this.files.length=0;for(const u of this.hashTable.entries){const p=u.blockIndex;p<this.blockTable.entries.length&&(this.files[p]=new Zn(this,u,this.blockTable.entries[p],i,null))}const h=this.get("(listfile)");if(h){const u=h.text();if(u)for(const p of u.split(`\r
`))this.get(p)}}save(){if(this.readonly)return null;const e=32;this.delete("(attributes)"),this.saveMemory(),this.set("(listfile)",this.getFileNames().join(`\r
`));let t=e;for(const p of this.files)if(p){if(!p.offsetChanged(t))return null;p.encode(),t+=p.block.compressedSize}const i=this.hashTable,s=this.blockTable,r=i.entries.length,o=s.entries.length,a=t-e,l=e+a+r*16+o*16,c=e+a,d=c+r*16,h=new Uint8Array(l),u=new Uint32Array(h.buffer,0,8);u[0]=Or,u[1]=e,u[2]=l,u[3]=Math.log2(this.sectorSize/512)<<16,u[4]=c,u[5]=d,u[6]=r,u[7]=o,t=e;for(const p of this.files)p&&(p.rawBuffer&&h.set(p.rawBuffer,t),t+=p.block.compressedSize);return i.save(h.subarray(t,t+i.entries.length*16)),t+=i.entries.length*16,s.save(h.subarray(t,t+s.entries.length*16)),h}saveMemory(){if(this.readonly)return 0;const e=this.blockTable.entries,t=this.hashTable.entries;let i=e.length,s=0;for(;i--;){const r=e[i];if(r.normalSize===0)this.removeBlock(i),s+=r.compressedSize;else{let o=!1;for(const a of t)if(a.blockIndex===i){o=!0;break}o||(this.removeBlock(i),s+=r.compressedSize)}}return s}removeBlock(e){for(const t of this.hashTable.entries)t.blockIndex<Nt&&t.blockIndex>e&&(t.blockIndex-=1);this.blockTable.entries.splice(e,1)}getFileNames(){const e=[];for(const t of this.files)t&&t.name!==""&&e.push(t.name);return e}countUnresolved(){let e=0;for(const t of this.files)t.nameResolved||e++;return e}applyListfile(e){for(const t of e)this.get(t)}set(e,t){if(this.readonly)return!1;const i=$e(t);let s=this.get(e);if(s)s.set(i);else{const r=this.blockTable.entries.length,o=this.hashTable.add(e,r);if(!o)return!1;const a=this.blockTable.add(i);s=new Zn(this,o,a,null,i),s.name=e,s.nameResolved=!0,this.files[r]=s}return!0}get(e){const t=this.hashTable.get(e);if(t){const i=t.blockIndex;if(i<Nt){const s=this.files[i];if(s)return s.name=e,s.nameResolved=!0,s}}return null}has(e){return!!this.get(e)}delete(e){if(this.readonly)return!1;const t=this.get(e);return t?(t.delete(),!0):!1}rename(e,t){if(this.readonly)return!1;const i=this.get(e);return i?(i.rename(t),!0):!1}resizeHashtable(e){if(this.readonly)return!1;e=Math.max(4,Mr(e));const t=this.files;if(t.length>e)return!1;for(const o of t)if(!o.nameResolved)return!1;const i=this.hashTable,s=i.entries,r=s.slice();i.clear(),i.addEmpties(e);for(const o of r)if(o.blockIndex!==kn){const a=t[o.blockIndex],l=i.getInsertionIndex(a.name);s[l].copy(o)}return!0}}class Qn{isCustom=0;path="";load(e){this.isCustom=e.readUint8(),this.path=e.readNull()}save(e){e.writeUint8(this.isCustom),e.writeNull(this.path)}getByteLength(){return 2+O(this.path)}}class ho{version=1;entries=new Map;load(e){const t=new X(e);this.version=t.readUint32();for(let i=0,s=t.readUint32();i<s;i++){const r=new Qn;r.load(t),r.isCustom?this.entries.set(r.path,r):this.entries.set(`war3mapimported\\${r.path}`,r)}}save(){const e=new X(new ArrayBuffer(this.getByteLength()));e.writeUint32(this.version),e.writeUint32(this.entries.size);for(const t of this.entries.values())t.save(e);return e.uint8array}getByteLength(){let e=8;for(const t of this.entries.values())e+=t.getByteLength();return e}set(e){if(!this.entries.has(e)){const t=new Qn;return t.isCustom=10,t.path=e,this.entries.set(e,t),!0}return!1}has(e){return this.entries.has(e)}delete(e){return this.entries.delete(e)}rename(e,t){const i=this.entries.get(e);return i?(i.isCustom=10,i.path=t,!0):!1}}class fo{id="\0\0\0\0";variableType=0;levelOrVariation=0;dataPointer=0;value=0;u1=0;load(e,t){if(this.id=e.readBinary(4),this.variableType=e.readInt32(),t&&(this.levelOrVariation=e.readInt32(),this.dataPointer=e.readInt32()),this.variableType===0)this.value=e.readInt32();else if(this.variableType===1||this.variableType===2)this.value=e.readFloat32();else if(this.variableType===3)this.value=e.readNull();else throw new Error(`Modification: unknown variable type ${this.variableType}`);this.u1=e.readInt32()}save(e,t){if(e.writeBinary(this.id),e.writeInt32(this.variableType),t&&(e.writeInt32(this.levelOrVariation),e.writeInt32(this.dataPointer)),this.variableType===0)e.writeInt32(this.value);else if(this.variableType===1||this.variableType===2)e.writeFloat32(this.value);else if(this.variableType===3)e.writeNull(this.value);else throw new Error(`Modification: unknown variable type ${this.variableType}`);e.writeInt32(this.u1)}getByteLength(e){let t=12;return e&&(t+=8),this.variableType===3?t+=O(this.value)+1:t+=4,t}}class uo{oldId="\0\0\0\0";newId="\0\0\0\0";sets=1;setsFlag=[];modifications=[];load(e,t,i){this.oldId=e.readBinary(4),this.newId=e.readBinary(4),i>=3&&(this.sets=e.readUint32());for(let s=0;s<this.sets;s++){i>=3&&(this.setsFlag[s]=e.readUint32());for(let r=0,o=e.readUint32();r<o;r++){const a=new fo;a.load(e,t),this.modifications[r]=a}}}save(e,t,i){this.oldId!=="\0\0\0\0"?e.writeBinary(this.oldId):e.writeUint32(0),this.newId!=="\0\0\0\0"?e.writeBinary(this.newId):e.writeUint32(0),i>=3&&e.writeUint32(this.sets),e.writeUint32(this.modifications.length);for(let s=0;s<this.sets;s++){i>=3&&e.writeUint32(this.setsFlag[s]);for(const r of this.modifications)r.save(e,t)}}getByteLength(e,t){let i=t>=3?16:12;for(let s=0;s<this.sets;s++){t>=3&&(i+=4);for(const r of this.modifications)i+=r.getByteLength(e)}return i}}class Dt{objects=[];load(e,t,i){for(let s=0,r=e.readUint32();s<r;s++){const o=new uo;o.load(e,t,i),this.objects[s]=o}}save(e,t,i){e.writeUint32(this.objects.length);for(const s of this.objects)s.save(e,t,i)}getByteLength(e,t){let i=4;for(const s of this.objects)i+=s.getByteLength(e,t);return i}}class po{version=0;originalTable=new Dt;customTable=new Dt;load(e){let t;e instanceof X?t=e:t=new X(e),this.version=t.readInt32(),this.originalTable.load(t,!0,this.version),this.customTable.load(t,!0,this.version)}save(){const e=new X(new ArrayBuffer(this.getByteLength()));return e.writeInt32(this.version),this.originalTable.save(e,!0,this.version),this.customTable.save(e,!0,this.version),e.uint8array}getByteLength(){return 4+this.originalTable.getByteLength(!0,this.version)+this.customTable.getByteLength(!0,this.version)}}class go{version=0;originalTable=new Dt;customTable=new Dt;load(e){let t;e instanceof X?t=e:t=new X(e),this.version=t.readInt32(),this.originalTable.load(t,!1,this.version),this.customTable.load(t,!1,this.version)}save(){const e=new X(new ArrayBuffer(this.getByteLength()));return e.writeInt32(this.version),this.originalTable.save(e,!1,this.version),this.customTable.save(e,!1,this.version),e.uint8array}getByteLength(){return 4+this.originalTable.getByteLength(!1,this.version)+this.customTable.getByteLength(!1,this.version)}}class Jn{text="";load(e){const t=e.readInt32();t&&(this.text=e.read(t-1),e.skip(1))}save(e){this.text.length?(e.writeInt32(O(this.text)+1),e.write(this.text),e.skip(1)):e.writeInt32(0)}getByteLength(){let e=4;return this.text.length&&(e+=O(this.text)+1),e}}class mo{version=0;comment="";trigger=new Jn;triggers=[];load(e){const t=new X(e);this.version=t.readInt32(),this.version===1&&(this.comment=t.readNull(),this.trigger.load(t));for(let i=0,s=t.readUint32();i<s;i++){const r=new Jn;r.load(t),this.triggers[i]=r}}save(){const e=new X(new ArrayBuffer(this.getByteLength()));e.writeInt32(this.version),this.version===1&&(e.writeNull(this.comment),this.trigger.save(e)),e.writeUint32(this.triggers.length);for(const t of this.triggers)t.save(e);return e.uint8array}getByteLength(){let e=8;this.version===1&&(e+=O(this.comment)+1+this.trigger.getByteLength());for(const t of this.triggers)e+=t.getByteLength();return e}}class bo{id=0;name="";isComment=0;load(e,t){this.id=e.readInt32(),this.name=e.readNull(),t===7&&(this.isComment=e.readInt32())}save(e,t){e.writeInt32(this.id),e.writeNull(this.name),t===7&&e.writeInt32(this.isComment)}getByteLength(e){let t=5+O(this.name);return e===7&&(t+=4),t}}class wo{name="";type="";u1=0;isArray=0;arraySize=0;isInitialized=0;initialValue="";load(e,t){this.name=e.readNull(),this.type=e.readNull(),this.u1=e.readInt32(),this.isArray=e.readInt32(),t===7&&(this.arraySize=e.readInt32()),this.isInitialized=e.readInt32(),this.initialValue=e.readNull()}save(e,t){e.writeNull(this.name),e.writeNull(this.type),e.writeInt32(this.u1),e.writeInt32(this.isArray),t===7&&e.writeInt32(this.arraySize),e.writeInt32(this.isInitialized),e.writeNull(this.initialValue)}getByteLength(e){let t=15+O(this.name)+O(this.type)+O(this.initialValue);return e===7&&(t+=4),t}}class vo{type=0;name="";beginParameters=0;parameters=[];load(e,t,i){if(this.type=e.readInt32(),this.type<0||this.type>3)throw new Error(`SubParameters: Bad type: ${this.type}`);if(this.name=e.readNull(),this.name.length===0)throw new Error("SubParameters: Empty name");if(this.beginParameters=e.readInt32(),this.beginParameters){const s=i.getFunction(this.type,this.name);if(!s)throw new Error(`SubParameters "${this.name}:${this.type}": Unknown signature`);const r=s.args;for(let o=0,a=r.length;o<a;o++){const l=new Vt;try{l.load(e,t,i)}catch(c){throw new Error(`SubParameters "${this.name}": Parameter ${o}: ${c}`)}this.parameters[o]=l}}}save(e,t){e.writeInt32(this.type),e.writeNull(this.name),e.writeInt32(this.beginParameters);for(const i of this.parameters)i.save(e,t)}getByteLength(e){let t=9+O(this.name);if(this.parameters.length)for(const i of this.parameters)t+=i.getByteLength(e);return t}}class Vt{type=0;value="";subParameters=null;u1=0;isArray=0;arrayIndex=null;load(e,t,i){if(this.type=e.readInt32(),this.type<-1||this.type>3)throw new Error(`Parameter: Bad type: ${this.type}`);if(this.value=e.readNull(),e.readInt32()){const s=new vo;try{s.load(e,t,i)}catch(r){throw new Error(`Parameter "${this.value}": SubParameters ${r}`)}this.subParameters=s}if((t===4&&this.type===2||t===7&&this.subParameters)&&(this.u1=e.readInt32()),(t===4&&this.type!==2||t===7)&&(this.isArray=e.readInt32()),this.isArray){const s=new Vt;try{s.load(e,t,i)}catch(r){throw new Error(`Parameter "${this.value}": ArrayIndex: ${r}`)}this.arrayIndex=s}}save(e,t){e.writeInt32(this.type),e.writeNull(this.value),this.subParameters?(e.writeInt32(1),this.subParameters.save(e,t)):e.writeInt32(0),(t===4&&this.type===2||t===7&&this.subParameters)&&e.writeInt32(this.u1),(t===4&&this.type!==2||t===7)&&e.writeInt32(this.isArray),this.isArray&&this.arrayIndex&&this.arrayIndex.save(e,t)}getByteLength(e){let t=9+O(this.value);return this.subParameters&&(t+=this.subParameters.getByteLength(e)),(e===4&&this.type===2||e===7&&this.subParameters)&&(t+=4),(e===4&&this.type!==2||e===7)&&(t+=4),this.isArray&&this.arrayIndex&&(t+=this.arrayIndex.getByteLength(e)),t}}class yi{type=-1;group=-1;name="";isEnabled=0;parameters=[];ecas=[];load(e,t,i,s){if(this.type=e.readInt32(),this.type<0||this.type>3)throw new Error(`ECA: Bad type: ${this.type}`);if(i&&(this.group=e.readUint32()),this.name=e.readNull(),this.name.length===0)throw new Error("ECA: Empty name");this.isEnabled=e.readInt32();const r=s.getFunction(this.type,this.name);if(!r)throw new Error(`ECA "${this.name}:${this.type}": Unknown signature`);const o=r.args;for(let a=0,l=o.length;a<l;a++){const c=new Vt;try{c.load(e,t,s)}catch(d){throw new Error(`ECA "${this.name}": Parameter ${a}: ${d}`)}this.parameters[a]=c}if(t===7)for(let a=0,l=e.readUint32();a<l;a++){const c=new yi;try{c.load(e,t,!0,s)}catch(d){throw new Error(`ECA "${this.name}": Child ECA ${a} ${d}`)}this.ecas[a]=c}}save(e,t){e.writeInt32(this.type),this.group!==-1&&e.writeInt32(this.group),e.writeNull(this.name),e.writeInt32(this.isEnabled);for(const i of this.parameters)i.save(e,t);if(t===7){e.writeUint32(this.ecas.length);for(const i of this.ecas)i.save(e,t)}}getByteLength(e){let t=9+O(this.name);this.group!==-1&&(t+=4);for(const i of this.parameters)t+=i.getByteLength(e);if(e===7){t+=4;for(const i of this.ecas)t+=i.getByteLength(e)}return t}}class yo{name="";description="";isComment=0;isEnabled=0;isCustom=0;isInitiallyOff=0;runOnInitialization=0;category=0;ecas=[];load(e,t,i){this.name=e.readNull(),this.description=e.readNull(),t===7&&(this.isComment=e.readInt32()),this.isEnabled=e.readInt32(),this.isCustom=e.readInt32(),this.isInitiallyOff=e.readInt32(),this.runOnInitialization=e.readInt32(),this.category=e.readInt32();for(let s=0,r=e.readUint32();s<r;s++){const o=new yi;try{o.load(e,t,!1,i)}catch(a){throw new Error(`Trigger "${this.name}": ECA ${s}: ${a}`)}this.ecas[s]=o}}save(e,t){e.writeNull(this.name),e.writeNull(this.description),t===7&&e.writeInt32(this.isComment),e.writeInt32(this.isEnabled),e.writeInt32(this.isCustom),e.writeInt32(this.isInitiallyOff),e.writeInt32(this.runOnInitialization),e.writeInt32(this.category),e.writeUint32(this.ecas.length);for(const i of this.ecas)i.save(e,t)}getByteLength(e){let t=26+O(this.name)+O(this.description);e===7&&(t+=4);for(const i of this.ecas)t+=i.getByteLength(e);return t}}class Ao{version=0;categories=[];u1=0;variables=[];triggers=[];load(e,t){const i=new X(e);if(i.readBinary(4)!=="WTG!")throw new Error("Not a WTG file");this.version=i.readInt32();for(let s=0,r=i.readUint32();s<r;s++){const o=new bo;o.load(i,this.version),this.categories[s]=o}this.u1=i.readInt32();for(let s=0,r=i.readUint32();s<r;s++){const o=new wo;o.load(i,this.version),this.variables[s]=o}for(let s=0,r=i.readUint32();s<r;s++){const o=new yo;try{o.load(i,this.version,t)}catch(a){throw new Error(`Trigger ${s}: ${a}`)}this.triggers[s]=o}}save(){const e=new X(new ArrayBuffer(this.getByteLength()));e.writeBinary("WTG!"),e.writeInt32(this.version),e.writeUint32(this.categories.length);for(const t of this.categories)t.save(e,this.version);e.writeInt32(this.u1),e.writeUint32(this.variables.length);for(const t of this.variables)t.save(e,this.version);e.writeUint32(this.triggers.length);for(const t of this.triggers)t.save(e,this.version);return e.uint8array}getByteLength(){let e=24;const t=this.version;for(const i of this.categories)e+=i.getByteLength(t);for(const i of this.variables)e+=i.getByteLength(t);for(const i of this.triggers)e+=i.getByteLength(t);return e}}class Gt{buffer;index=0;ident=0;indentSpaces=4;precision=1e6;constructor(e){this.buffer=e||""}clear(){this.buffer="",this.index=0,this.ident=0}readToken(){const e=this.buffer,t=e.length;let i=!1,s=!1,r="";for(;this.index<t;){const o=e[this.index++];if(i)o===`
`&&(i=!1);else if(s)if(o==="\\")r+=o+e[this.index++];else if(o===`
`)r+="\\n";else if(o==="\r")r+="\\r";else{if(o==='"')return r;r+=o}else if(o===" "||o===","||o==="	"||o===`
`||o===":"||o==="\r"){if(r.length)return r}else{if(o==="{"||o==="}")return r.length?(this.index--,r):o;if(o==="/"&&e[this.index]==="/"){if(r.length)return this.index--,r;i=!0}else if(o==='"'){if(r.length)return this.index--,r;s=!0}else r+=o}}}read(){const e=this.readToken();if(e===void 0)throw new Error("End of stream reached prematurely");return e}peek(){const e=this.index,t=this.read();return this.index=e,t}readInt(){return parseInt(this.read())}readFloat(){return parseFloat(this.read())}readVector(e){this.read();for(let t=0,i=e.length;t<i;t++)e[t]=this.readFloat();return this.read(),e}readVectorsBlock(e,t){this.read();for(let i=0,s=e.length;i<s;i+=t)this.readVector(e.subarray(i,i+t));return this.read(),e}readColor(e){return this.read(),e[2]=this.readFloat(),e[1]=this.readFloat(),e[0]=this.readFloat(),this.read(),e}*readBlock(){this.read();let e=this.read();for(;e!=="}";)yield e,e=this.read()}writeLine(e){this.buffer+=`${" ".repeat(this.ident*this.indentSpaces)}${e}
`}writeFlag(e){this.writeLine(`${e},`)}writeFlagAttrib(e,t){this.writeLine(`${e} ${t},`)}writeNumberAttrib(e,t){this.writeLine(`${e} ${this.floatDecimals(t)},`)}writeStringAttrib(e,t){this.writeLine(`${e} "${t}",`)}writeVectorAttrib(e,t){this.writeLine(`${e} { ${this.floatArrayDecimals(t)} },`)}writeColor(e,t){const i=this.floatDecimals(t[0]),s=this.floatDecimals(t[1]),r=this.floatDecimals(t[2]);this.writeLine(`${e} { ${r}, ${s}, ${i} },`)}writeVector(e){this.writeLine(`{ ${this.floatArrayDecimals(e)} },`)}writeVectorArrayBlock(e,t,i){this.startBlock(e,t.length/i);for(let s=0,r=t.length;s<r;s+=i)this.writeVector(t.subarray(s,s+i));this.endBlock()}startBlock(e,...t){t.length&&(e=`${e} ${t.join(" ")}`),this.writeLine(`${e} {`),this.ident+=1}startObjectBlock(e,t){this.writeLine(`${e} "${t.replace(/"/g,'\\"')}" {`),this.ident+=1}endBlock(){this.ident-=1,this.writeLine("}")}endBlockComma(){this.ident-=1,this.writeLine("},")}indent(){this.ident+=1}unindent(){this.ident-=1}floatDecimals(e){return`${Math.trunc(e*this.precision)/this.precision}`}floatArrayDecimals(e){if(e instanceof Float32Array){const t=[];for(let i=0,s=e.length;i<s;i++)t[i]=this.floatDecimals(e[i]);return t.join(", ")}else return e.join(", ")}}class To{stringMap=new Map;load(e){const t=new Gt(e);let i;const s=e.indexOf("STRING");if(s===-1)throw new Error("Not a valid war3map.wts buffer");for(t.index=s;i=t.readToken();)if(i==="STRING"){const r=t.readInt();t.read();const o=e.indexOf("}",t.index);if(o===-1)throw this.stringMap.set(r,e.slice(t.index,e.length).trim()),new Error(`WTS: missing data in string ${this.stringMap.size} (and maybe more)`);this.stringMap.set(r,e.slice(t.index,o).trim()),t.index=o}}save(){let e="";for(const[t,i]of this.stringMap)e+=`STRING ${t}\r
{\r
${i}\r
}\r
\r
`;return e}getString(e){if(typeof e=="string"){if(e.startsWith("TRIGSTR_"))return this.stringMap.get(parseInt(e.slice(8)))}else return this.stringMap.get(e)}setString(e,t){typeof e=="string"?e.startsWith("TRIGSTR_")&&this.stringMap.set(parseInt(e.slice(8)),t):this.stringMap.set(e,t)}}class xo{flags=0;playerMasks=0;name="";load(e){this.flags=e.readUint32(),this.playerMasks=e.readUint32(),this.name=e.readNull()}save(e){e.writeUint32(this.flags),e.writeUint32(this.playerMasks),e.writeNull(this.name)}getByteLength(){return 9+O(this.name)}}class Eo{id=0;type=0;race=0;isFixedStartPosition=0;name="";startLocation=new Float32Array(2);allyLowPriorities=0;allyHighPriorities=0;unknown1=new Uint8Array(8);load(e,t){this.id=e.readInt32(),this.type=e.readInt32(),this.race=e.readInt32(),this.isFixedStartPosition=e.readInt32(),this.name=e.readNull(),e.readFloat32Array(this.startLocation),this.allyLowPriorities=e.readUint32(),this.allyHighPriorities=e.readUint32(),t>30&&e.readUint8Array(this.unknown1)}save(e,t){e.writeInt32(this.id),e.writeInt32(this.type),e.writeInt32(this.race),e.writeInt32(this.isFixedStartPosition),e.writeNull(this.name),e.writeFloat32Array(this.startLocation),e.writeUint32(this.allyLowPriorities),e.writeUint32(this.allyHighPriorities),t>30&&e.writeUint8Array(this.unknown1)}getByteLength(e){let t=33+O(this.name);return e>30&&(t+=8),t}}class So{chance=0;id="\0\0\0\0";load(e){this.chance=e.readInt32(),this.id=e.readBinary(4)}save(e){e.writeInt32(this.chance),e.writeBinary(this.id)}}class Io{items=[];load(e){for(let t=0,i=e.readUint32();t<i;t++){const s=new So;s.load(e),this.items[t]=s}}save(e){e.writeUint32(this.items.length);for(const t of this.items)t.save(e)}getByteLength(){return 4+this.items.length*8}}class _o{id=0;name="";sets=[];load(e){this.id=e.readInt32(),this.name=e.readNull();for(let t=0,i=e.readUint32();t<i;t++){const s=new Io;s.load(e),this.sets[t]=s}}save(e){e.writeInt32(this.id),e.writeNull(this.name),e.writeUint32(this.sets.length);for(const t of this.sets)t.save(e)}getByteLength(){let e=9+O(this.name);for(const t of this.sets)e+=t.getByteLength();return e}}class Co{chance=0;ids=[];load(e,t){this.chance=e.readInt32();for(let i=0;i<t;i++)this.ids[i]=e.readBinary(4)}save(e){e.writeInt32(this.chance);for(const t of this.ids)e.writeBinary(t)}}class Lo{id=0;name="";positions=0;columnTypes=new Int32Array(0);units=[];load(e){this.id=e.readInt32(),this.name=e.readNull(),this.positions=e.readInt32(),this.columnTypes=e.readInt32Array(this.positions);for(let t=0,i=e.readUint32();t<i;t++){const s=new Co;s.load(e,this.positions),this.units[t]=s}}save(e){e.writeInt32(this.id),e.writeNull(this.name),e.writeInt32(this.positions),e.writeInt32Array(this.columnTypes),e.writeUint32(this.units.length);for(const t of this.units)t.save(e)}getByteLength(){return 13+O(this.name)+this.columnTypes.byteLength+this.units.length*(4+4*this.positions)}}class Bo{playerFlags=0;id="\0\0\0\0";load(e){this.playerFlags=e.readUint32(),this.id=e.readBinary(4)}save(e){e.writeUint32(this.playerFlags),e.writeBinary(this.id)}}class Ro{playerFlags=0;id="\0\0\0\0";levelAffected=0;availability=0;load(e){this.playerFlags=e.readUint32(),this.id=e.readBinary(4),this.levelAffected=e.readInt32(),this.availability=e.readInt32()}save(e){e.writeUint32(this.playerFlags),e.writeBinary(this.id),e.writeInt32(this.levelAffected),e.writeInt32(this.availability)}}class Po{version=0;saves=0;editorVersion=0;buildVersion=new Uint32Array(4);name="";author="";description="";recommendedPlayers="";cameraBounds=new Float32Array(8);cameraBoundsComplements=new Int32Array(4);playableSize=new Int32Array(2);flags=0;tileset="A";campaignBackground=0;loadingScreenModel="";loadingScreenText="";loadingScreenTitle="";loadingScreenSubtitle="";loadingScreen=0;prologueScreenModel="";prologueScreenText="";prologueScreenTitle="";prologueScreenSubtitle="";useTerrainFog=0;fogHeight=new Float32Array(2);fogDensity=0;fogColor=new Uint8Array(4);globalWeather=0;soundEnvironment="";lightEnvironmentTileset="\0";waterVertexColor=new Uint8Array(4);scriptMode=0;graphicsMode=0;defaultCameraZoom=0;maxCameraZoom=0;minCameraZoom=0;players=[];forces=[];upgradeAvailabilityChanges=[];techAvailabilityChanges=[];randomUnitTables=[];randomItemTables=[];unknown1=0;load(e){const t=new X(e);this.version=t.readInt32(),this.saves=t.readInt32(),this.editorVersion=t.readInt32(),this.version>27&&t.readUint32Array(this.buildVersion),this.name=t.readNull(),this.author=t.readNull(),this.description=t.readNull(),this.recommendedPlayers=t.readNull(),t.readFloat32Array(this.cameraBounds),t.readInt32Array(this.cameraBoundsComplements),t.readInt32Array(this.playableSize),this.flags=t.readUint32(),this.tileset=t.readBinary(1),this.campaignBackground=t.readInt32(),this.version>24&&(this.loadingScreenModel=t.readNull()),this.loadingScreenText=t.readNull(),this.loadingScreenTitle=t.readNull(),this.loadingScreenSubtitle=t.readNull(),this.loadingScreen=t.readInt32(),this.version>24&&(this.prologueScreenModel=t.readNull()),this.prologueScreenText=t.readNull(),this.prologueScreenTitle=t.readNull(),this.prologueScreenSubtitle=t.readNull(),this.version>24&&(this.useTerrainFog=t.readInt32(),t.readFloat32Array(this.fogHeight),this.fogDensity=t.readFloat32(),t.readUint8Array(this.fogColor),this.globalWeather=t.readInt32(),this.soundEnvironment=t.readNull(),this.lightEnvironmentTileset=t.readBinary(1),t.readUint8Array(this.waterVertexColor)),this.version>27&&(this.scriptMode=t.readUint32()),this.version>30&&(this.graphicsMode=t.readUint32(),this.unknown1=t.readUint32()),this.version>32&&(this.defaultCameraZoom=t.readUint32(),this.maxCameraZoom=t.readUint32(),this.minCameraZoom=t.readUint32());for(let i=0,s=t.readInt32();i<s;i++){const r=new Eo;r.load(t,this.version),this.players[i]=r}for(let i=0,s=t.readInt32();i<s;i++){const r=new xo;r.load(t),this.forces[i]=r}for(let i=0,s=t.readInt32();i<s;i++){const r=new Ro;r.load(t),this.upgradeAvailabilityChanges[i]=r}for(let i=0,s=t.readInt32();i<s;i++){const r=new Bo;r.load(t),this.techAvailabilityChanges[i]=r}for(let i=0,s=t.readInt32();i<s;i++){const r=new Lo;r.load(t),this.randomUnitTables[i]=r}if(this.version>24)for(let i=0,s=t.readInt32();i<s;i++){const r=new _o;r.load(t),this.randomItemTables[i]=r}}save(){const e=new X(new ArrayBuffer(this.getByteLength()));e.writeInt32(this.version),e.writeInt32(this.saves),e.writeInt32(this.editorVersion),this.version>27&&e.writeUint32Array(this.buildVersion),e.writeNull(this.name),e.writeNull(this.author),e.writeNull(this.description),e.writeNull(this.recommendedPlayers),e.writeFloat32Array(this.cameraBounds),e.writeInt32Array(this.cameraBoundsComplements),e.writeInt32Array(this.playableSize),e.writeUint32(this.flags),e.writeBinary(this.tileset),e.writeInt32(this.campaignBackground),this.version>24&&e.writeNull(this.loadingScreenModel),e.writeNull(this.loadingScreenText),e.writeNull(this.loadingScreenTitle),e.writeNull(this.loadingScreenSubtitle),e.writeInt32(this.loadingScreen),this.version>24&&e.writeNull(this.prologueScreenModel),e.writeNull(this.prologueScreenText),e.writeNull(this.prologueScreenTitle),e.writeNull(this.prologueScreenSubtitle),this.version>24&&(e.writeInt32(this.useTerrainFog),e.writeFloat32Array(this.fogHeight),e.writeFloat32(this.fogDensity),e.writeUint8Array(this.fogColor),e.writeInt32(this.globalWeather),e.writeNull(this.soundEnvironment),e.writeBinary(this.lightEnvironmentTileset),e.writeUint8Array(this.waterVertexColor)),this.version>27&&e.writeUint32(this.scriptMode),this.version>30&&(e.writeUint32(this.graphicsMode),e.writeUint32(this.unknown1)),this.version>32&&(e.writeUint32(this.defaultCameraZoom),e.writeUint32(this.maxCameraZoom),e.writeUint32(this.minCameraZoom)),e.writeUint32(this.players.length);for(const t of this.players)t.save(e,this.version);e.writeUint32(this.forces.length);for(const t of this.forces)t.save(e);e.writeUint32(this.upgradeAvailabilityChanges.length);for(const t of this.upgradeAvailabilityChanges)t.save(e);e.writeUint32(this.techAvailabilityChanges.length);for(const t of this.techAvailabilityChanges)t.save(e);e.writeUint32(this.randomUnitTables.length);for(const t of this.randomUnitTables)t.save(e);if(this.version>24){e.writeUint32(this.randomItemTables.length);for(const t of this.randomItemTables)t.save(e)}return e.uint8array}getByteLength(){let e=111+O(this.name)+O(this.author)+O(this.description)+O(this.recommendedPlayers)+O(this.loadingScreenText)+O(this.loadingScreenTitle)+O(this.loadingScreenSubtitle)+O(this.prologueScreenText)+O(this.prologueScreenTitle)+O(this.prologueScreenSubtitle);for(const t of this.players)e+=t.getByteLength(this.version);for(const t of this.forces)e+=t.getByteLength();e+=this.upgradeAvailabilityChanges.length*16,e+=this.techAvailabilityChanges.length*8;for(const t of this.randomUnitTables)e+=t.getByteLength();if(this.version>24){e+=36+O(this.loadingScreenModel)+O(this.prologueScreenModel)+O(this.soundEnvironment);for(const t of this.randomItemTables)e+=t.getByteLength()}return this.version>27&&(e+=20),this.version>30&&(e+=8),e}getBuildVersion(){return this.buildVersion[0]*100+this.buildVersion[1]}}class ko{u1=0;name="";flags=0;maxPlayers=0;archive=new co;imports=new ho;readonly=!1;load(e,t=!1){const i=new X(e);i.readBinary(4)==="HM3W"&&(this.u1=i.readUint32(),this.name=i.readNull(),this.flags=i.readUint32(),this.maxPlayers=i.readUint32()),this.readonly=t,this.archive.load(e,t),this.readImports()}save(){this.setImportsFile();const e=this.archive.save();if(!e)throw Error("Failed to save the map MPQ archive");const t=this.getMapInformation();if(!t||t.getBuildVersion()<131){const i=new Uint8Array(512+e.byteLength),s=new X(i);return s.writeBinary("HM3W"),s.writeUint32(this.u1),s.writeNull(this.name),s.writeUint32(this.flags),s.writeUint32(this.maxPlayers),i.set(e,512),i}else return e}getFileNames(){return this.archive.getFileNames()}getImportNames(){const e=[];for(const t of this.imports.entries.values()){const i=t.isCustom;i===10||i===13?e.push(t.path):e.push(`war3mapImported\\${t.path}`)}return e}setImportsFile(){return this.readonly?!1:this.imports.entries.size>0?this.set("war3map.imp",this.imports.save()):!1}import(e,t){return this.readonly?!1:this.archive.set(e,t)?(this.imports.set(e),!0):!1}set(e,t){return this.readonly?!1:this.archive.set(e,t)}get(e){return this.archive.get(e)}getScriptFile(){return this.get("war3map.j")||this.get("scripts\\war3map.j")||this.get("war3map.lua")||this.get("scripts\\war3map.lua")}has(e){return this.archive.has(e)}delete(e){return this.readonly?!1:(this.imports.delete(e),this.archive.delete(e))}rename(e,t){return this.readonly?!1:this.archive.rename(e,t)?(this.imports.rename(e,t),!0):!1}getMapInformation(){const e=this.archive.get("war3map.w3i");if(!e)throw new Error("File does not exist");const t=new Po;return t.load(e.bytes()),t}readImports(){const e=this.archive.get("war3map.imp");if(e){const t=e.arrayBuffer();t&&this.imports.load(t)}}readTriggers(e){const t=this.archive.get("war3map.wtg");if(t){const i=t.arrayBuffer();if(i){const s=new Ao;return s.load(i,e),s}}}readCustomTextTriggers(){const e=this.archive.get("war3map.wct");if(e){const t=e.arrayBuffer();if(t){const i=new mo;return i.load(t),i}}}readStringTable(){const e=this.archive.get("war3map.wts");if(e){const t=e.text();if(t){const i=new To;return i.load(t),i}}}readModifications(){const e={},t=["w3u","w3t","w3b","w3d","w3a","w3h","w3q"],i=[!1,!1,!1,!0,!0,!1,!0];for(let s=0,r=t.length;s<r;s++){const o=this.archive.get(`war3map.${t[s]}`);if(o){const a=o.arrayBuffer();if(a){let l;i[s]?l=new po:l=new go,l.load(a),e[t[s]]=l}}}return e}}function A(n){let e="div";n&&n.tagName&&(e=n.tagName);let t=document.createElement(e);return n&&(n.style&&(t.style=n.style),n.className&&(t.className=n.className),n.textContent&&(t.textContent=n.textContent),n.placeholder&&(t.placeholder=n.placeholder),n.readonly&&(t.readonly=!0),n.href&&(t.href=n.href),n.target&&(t.target=n.target),n.title&&(t.title=n.title),n.onclick&&t.addEventListener("click",i=>n.onclick(i,n.component)),n.onchange&&t.addEventListener("change",i=>n.onchange(i,n.component)),n.oninput&&t.addEventListener("input",i=>n.oninput(i,n.component)),n.container&&n.container.appendChild(t)),t}function Ai(n){n.classList.add("hidden")}function Ti(n){n.classList.remove("hidden")}function es(n){n.scrollTop=n.scrollHeight}function ts(n){return n.scrollHeight-n.clientHeight===n.scrollTop}function is(n){for(let e=n.options.length-1,t=e;t>=0;t--)n.remove(t)}class ye{constructor(e){this.container=A({...e,component:this})}hide(){Ai(this.container)}show(){Ti(this.container)}highlight(){this.container.classList.add("highlighted")}normal(){this.container.classList.remove("highlighted")}}class Ae extends ye{constructor(e,t,i,s){super({...s,tagName:"button",textContent:e,onclick:()=>this.toggle()}),this.offName=e,this.onName=t,this.callback=i,this.clicked=!1}toggle(){this.clicked=!this.clicked,this.clicked?this.container.textContent=this.onName:this.container.textContent=this.offName,this.callback&&this.callback(this)}}function Uo(n,e){if(e){const t=Object.entries(e);if(t.length){const i=t.map(([r,o])=>`${r}=${o}`).join("&");let s="&";return n.indexOf("?")===-1&&(s="?"),`${n}${s}${i}`}}return n}function wt(n,e){return n=n.toLowerCase(),window.location.hostname==="127.0.0.1"?Uo(`${window.location.origin}/assets?path=${n}`,e):`https://www.hiveworkshop.com/casc-contents?path=${n}`}async function Fo(n){const e=n.items;let t=[],i=[];for(let s=0;s<e.length;s++)i.push(e[s].webkitGetAsEntry());for(;i.length>0;){let s=i.shift();s.isFile?t.push(s):s.isDirectory&&i.push(...await No(s.createReader()))}return t}async function No(n){let e=[],t=await ns(n);for(;t.length>0;)e.push(...t),t=await ns(n);return e}async function ns(n){try{return await new Promise((e,t)=>{n.readEntries(e,t)})}catch(e){console.log(e)}}async function ss(n,e){return new Promise(t=>{let i=new FileReader;i.addEventListener("loadend",s=>{t(s.target.result)}),e?i.readAsText(n):i.readAsArrayBuffer(n)})}async function Mo(n,e){return new Promise(t=>n.file(async i=>t(await ss(i,e))))}class qe{boundsRadius=0;min=new Float32Array(3);max=new Float32Array(3);readMdx(e){this.boundsRadius=e.readFloat32(),e.readFloat32Array(this.min),e.readFloat32Array(this.max)}writeMdx(e){e.writeFloat32(this.boundsRadius),e.writeFloat32Array(this.min),e.writeFloat32Array(this.max)}writeMdl(e){(this.min[0]!==0||this.min[1]!==0||this.min[2]!==0)&&e.writeVectorAttrib("MinimumExtent",this.min),(this.max[0]!==0||this.max[1]!==0||this.max[2]!==0)&&e.writeVectorAttrib("MaximumExtent",this.max),this.boundsRadius!==0&&e.writeNumberAttrib("BoundsRadius",this.boundsRadius)}}let $t=class{name="";interval=new Uint32Array(2);moveSpeed=0;nonLooping=0;rarity=0;syncPoint=0;extent=new qe;readMdx(e){this.name=e.read(80),e.readUint32Array(this.interval),this.moveSpeed=e.readFloat32(),this.nonLooping=e.readUint32(),this.rarity=e.readFloat32(),this.syncPoint=e.readUint32(),this.extent.readMdx(e)}writeMdx(e){e.skip(80-e.write(this.name)),e.writeUint32Array(this.interval),e.writeFloat32(this.moveSpeed),e.writeUint32(this.nonLooping),e.writeFloat32(this.rarity),e.writeUint32(this.syncPoint),this.extent.writeMdx(e)}readMdl(e){this.name=e.read();for(const t of e.readBlock())if(t==="Interval")e.readVector(this.interval);else if(t==="NonLooping")this.nonLooping=1;else if(t==="MoveSpeed")this.moveSpeed=e.readFloat();else if(t==="Rarity")this.rarity=e.readFloat();else if(t==="MinimumExtent")e.readVector(this.extent.min);else if(t==="MaximumExtent")e.readVector(this.extent.max);else if(t==="BoundsRadius")this.extent.boundsRadius=e.readFloat();else throw new Error(`Unknown token in Sequence: "${t}"`)}writeMdl(e){e.startObjectBlock("Anim",this.name),e.writeVectorAttrib("Interval",this.interval),this.nonLooping===1&&e.writeFlag("NonLooping"),this.moveSpeed!==0&&e.writeNumberAttrib("MoveSpeed",this.moveSpeed),this.rarity!==0&&e.writeNumberAttrib("Rarity",this.rarity),this.extent.writeMdl(e),e.endBlock()}};var W=(n=>(n[n.DontInterp=0]="DontInterp",n[n.Linear=1]="Linear",n[n.Hermite=2]="Hermite",n[n.Bezier=3]="Bezier",n))(W||{});class Ne{name="";interpolationType=0;globalSequenceId=-1;frames=[];values=[];inTans=[];outTans=[];readMdx(e,t){const i=this.frames,s=this.values,r=this.inTans,o=this.outTans,a=e.readUint32(),l=e.readUint32();this.name=t,this.interpolationType=l,this.globalSequenceId=e.readInt32();for(let c=0;c<a;c++)i.push(e.readInt32()),s.push(this.readMdxValue(e)),l>1&&(r.push(this.readMdxValue(e)),o.push(this.readMdxValue(e)))}writeMdx(e){const t=this.interpolationType,i=this.frames,s=this.values,r=this.inTans,o=this.outTans,a=i.length;e.writeBinary(this.name),e.writeUint32(a),e.writeUint32(t),e.writeInt32(this.globalSequenceId);for(let l=0;l<a;l++)e.writeInt32(i[l]),this.writeMdxValue(e,s[l]),t>1&&(this.writeMdxValue(e,r[l]),this.writeMdxValue(e,o[l]))}readMdl(e,t){const i=this.frames,s=this.values,r=this.inTans,o=this.outTans;this.name=t;const a=e.readInt();e.read();let l=0;const c=e.read();c==="DontInterp"?l=0:c==="Linear"?l=1:c==="Hermite"?l=2:c==="Bezier"&&(l=3),this.interpolationType=l,e.peek()==="GlobalSeqId"&&(e.read(),this.globalSequenceId=e.readInt());for(let d=0;d<a;d++)i[d]=e.readInt(),s[d]=this.readMdlValue(e),l>1&&(e.read(),r[d]=this.readMdlValue(e),e.read(),o[d]=this.readMdlValue(e));e.read()}writeMdl(e,t){const i=this.interpolationType,s=this.frames,r=this.values,o=this.inTans,a=this.outTans,l=s.length;e.startBlock(t,this.frames.length);let c="";this.interpolationType===0?c="DontInterp":this.interpolationType===1?c="Linear":this.interpolationType===2?c="Hermite":this.interpolationType===3&&(c="Bezier"),e.writeFlag(c),this.globalSequenceId!==-1&&e.writeNumberAttrib("GlobalSeqId",this.globalSequenceId);for(let d=0;d<l;d++)this.writeMdlValue(e,`${s[d]}:`,r[d]),i>1&&(e.indent(),this.writeMdlValue(e,"InTan",o[d]),this.writeMdlValue(e,"OutTan",a[d]),e.unindent());e.endBlock()}getByteLength(){const e=this.frames.length;let t=16;if(e){const i=this.values[0].byteLength;let s=1;this.interpolationType>1&&(s=3),t+=(4+s*i)*e}return t}}class qt extends Ne{readMdxValue(e){return e.readUint32Array(1)}writeMdxValue(e,t){e.writeUint32(t[0])}readMdlValue(e){return new Uint32Array([e.readInt()])}writeMdlValue(e,t,i){e.writeNumberAttrib(t,i[0])}}class k extends Ne{readMdxValue(e){return e.readFloat32Array(1)}writeMdxValue(e,t){e.writeFloat32(t[0])}readMdlValue(e){return new Float32Array([e.readFloat()])}writeMdlValue(e,t,i){e.writeNumberAttrib(t,i[0])}}class he extends Ne{readMdxValue(e){return e.readFloat32Array(3)}writeMdxValue(e,t){e.writeFloat32Array(t)}readMdlValue(e){return e.readVector(new Float32Array(3))}writeMdlValue(e,t,i){e.writeVectorAttrib(t,i)}}class rs extends Ne{readMdxValue(e){return e.readFloat32Array(4)}writeMdxValue(e,t){e.writeFloat32Array(t)}readMdlValue(e){return e.readVector(new Float32Array(4))}writeMdlValue(e,t,i){e.writeVectorAttrib(t,i)}}const xi={KMTF:["TextureID",qt],KMTA:["Alpha",k],KMTE:["EmissiveGain",k],KFC3:["FresnelColor",he],KFCA:["FresnelOpacity",k],KFTC:["FresnelTeamColor",qt],KTAT:["Translation",he],KTAR:["Rotation",rs],KTAS:["Scaling",he],KGAO:["Alpha",k],KGAC:["Color",he],KGTR:["Translation",he],KGRT:["Rotation",rs],KGSC:["Scaling",he],KLAS:["AttenuationStart",k],KLAE:["AttenuationEnd",k],KLAC:["Color",he],KLAI:["Intensity",k],KLBI:["AmbIntensity",k],KLBC:["AmbColor",he],KLAV:["Visibility",k],KATV:["Visibility",k],KPEE:["EmissionRate",k],KPEG:["Gravity",k],KPLN:["Longitude",k],KPLT:["Latitude",k],KPEL:["LifeSpan",k],KPES:["InitVelocity",k],KPEV:["Visibility",k],KP2S:["Speed",k],KP2R:["Variation",k],KP2L:["Latitude",k],KP2G:["Gravity",k],KP2E:["EmissionRate",k],KP2N:["Width",k],KP2W:["Length",k],KP2V:["Visibility",k],KPPA:["Alpha",k],KPPC:["Color",he],KPPE:["EmissionRate",k],KPPL:["LifeSpan",k],KPPS:["Speed",k],KPPV:["Visibility",k],KRHA:["HeightAbove",k],KRHB:["HeightBelow",k],KRAL:["Alpha",k],KRCO:["Color",he],KRTX:["TextureSlot",qt],KRVS:["Visibility",k],KCTR:["Translation",he],KTTR:["Translation",he],KCRL:["Rotation",k]};let We=class{animations=[];readAnimations(e,t){const i=e.index+t;for(;e.index<i;){const s=e.readBinary(4),r=new xi[s][1];r.readMdx(e,s),this.animations.push(r)}}writeAnimations(e){for(const t of this.animations)t.writeMdx(e)}*readAnimatedBlock(e){for(const t of e.readBlock())t==="static"?yield`static ${e.read()}`:yield t}readAnimation(e,t){const i=new xi[t][1];i.readMdl(e,t),this.animations.push(i)}writeAnimation(e,t){for(const i of this.animations)if(i.name===t)return i.writeMdl(e,xi[t][0]),!0;return!1}getByteLength(e=0){let t=0;for(const i of this.animations)t+=i.getByteLength();return t}};var de=(n=>(n[n.None=0]="None",n[n.Transparent=1]="Transparent",n[n.Blend=2]="Blend",n[n.Additive=3]="Additive",n[n.AddAlpha=4]="AddAlpha",n[n.Modulate=5]="Modulate",n[n.Modulate2x=6]="Modulate2x",n))(de||{}),Le=(n=>(n[n.None=0]="None",n[n.Unshaded=1]="Unshaded",n[n.SphereEnvMap=2]="SphereEnvMap",n[n.TwoSided=16]="TwoSided",n[n.Unfogged=32]="Unfogged",n[n.NoDepthTest=64]="NoDepthTest",n[n.NoDepthSet=128]="NoDepthSet",n[n.Unlit=256]="Unlit",n))(Le||{});function Oo(n){return n==="None"?0:n==="Transparent"?1:n==="Blend"?2:n==="Additive"?3:n==="AddAlpha"?4:n==="Modulate"?5:n==="Modulate2x"?6:0}function Do(n){return n===0?"None":n===1?"Transparent":n===2?"Blend":n===3?"Additive":n===4?"AddAlpha":n===5?"Modulate":n===6?"Modulate2x":"None"}let Kt=class extends We{filterMode=0;flags=0;textureId=-1;textureAnimationId=-1;coordId=0;alpha=1;emissiveGain=1;fresnelColor=new Float32Array([1,1,1]);fresnelOpacity=0;fresnelTeamColor=0;readMdx(e,t){const i=e.index,s=e.readUint32();this.filterMode=e.readUint32(),this.flags=e.readUint32(),this.textureId=e.readInt32(),this.textureAnimationId=e.readInt32(),this.coordId=e.readUint32(),this.alpha=e.readFloat32(),t>800&&(this.emissiveGain=e.readFloat32(),e.readFloat32Array(this.fresnelColor),this.fresnelOpacity=e.readFloat32(),this.fresnelTeamColor=e.readFloat32()),this.readAnimations(e,s-(e.index-i))}writeMdx(e,t){e.writeUint32(this.getByteLength(t)),e.writeUint32(this.filterMode),e.writeUint32(this.flags),e.writeInt32(this.textureId),e.writeInt32(this.textureAnimationId),e.writeUint32(this.coordId),e.writeFloat32(this.alpha),t>800&&(e.writeFloat32(this.emissiveGain),e.writeFloat32Array(this.fresnelColor),e.writeFloat32(this.fresnelOpacity),e.writeFloat32(this.fresnelTeamColor)),this.writeAnimations(e)}readMdl(e){for(const t of super.readAnimatedBlock(e))if(t==="FilterMode")this.filterMode=Oo(e.read());else if(t==="Unshaded")this.flags|=1;else if(t==="SphereEnvMap")this.flags|=2;else if(t==="TwoSided")this.flags|=16;else if(t==="Unfogged")this.flags|=32;else if(t==="NoDepthTest")this.flags|=64;else if(t==="NoDepthSet")this.flags|=128;else if(t==="Unlit")this.flags|=256;else if(t==="static TextureID")this.textureId=e.readInt();else if(t==="TextureID")this.readAnimation(e,"KMTF");else if(t==="TVertexAnimId")this.textureAnimationId=e.readInt();else if(t==="CoordId")this.coordId=e.readInt();else if(t==="static Alpha")this.alpha=e.readFloat();else if(t==="Alpha")this.readAnimation(e,"KMTA");else if(t==="static EmissiveGain")this.emissiveGain=e.readFloat();else if(t==="EmissiveGain")this.readAnimation(e,"KMTE");else if(t==="static FresnelColor")e.readVector(this.fresnelColor);else if(t==="FresnelColor")this.readAnimation(e,"KFC3");else if(t==="static FresnelOpacity")this.fresnelOpacity=e.readFloat();else if(t==="FresnelOpacity")this.readAnimation(e,"KFCA");else if(t==="static FresnelTeamColor")this.fresnelTeamColor=e.readFloat();else if(t==="FresnelTeamColor")this.readAnimation(e,"KFTC");else throw new Error(`Unknown token in Layer: "${t}"`)}writeMdl(e,t){e.startBlock("Layer"),e.writeFlagAttrib("FilterMode",Do(this.filterMode)),this.flags&1&&e.writeFlag("Unshaded"),this.flags&2&&e.writeFlag("SphereEnvMap"),this.flags&16&&e.writeFlag("TwoSided"),this.flags&32&&e.writeFlag("Unfogged"),this.flags&64&&e.writeFlag("NoDepthTest"),this.flags&128&&e.writeFlag("NoDepthSet"),t>800&&this.flags&256&&e.writeFlag("Unlit"),this.writeAnimation(e,"KMTF")||e.writeNumberAttrib("static TextureID",this.textureId),this.textureAnimationId!==-1&&e.writeNumberAttrib("TVertexAnimId",this.textureAnimationId),this.coordId!==0&&e.writeNumberAttrib("CoordId",this.coordId),!this.writeAnimation(e,"KMTA")&&this.alpha!==1&&e.writeNumberAttrib("static Alpha",this.alpha),t>800&&(!this.writeAnimation(e,"KMTE")&&this.emissiveGain!==1&&e.writeNumberAttrib("static EmissiveGain",this.emissiveGain),!this.writeAnimation(e,"KFC3")&&(this.fresnelColor[0]!==1||this.fresnelColor[1]!==1||this.fresnelColor[2]!==1)&&e.writeVectorAttrib("static FresnelColor",this.fresnelColor),!this.writeAnimation(e,"KFCA")&&this.fresnelOpacity!==0&&e.writeNumberAttrib("static FresnelOpacity",this.fresnelOpacity),!this.writeAnimation(e,"KFTC")&&this.fresnelTeamColor!==0&&e.writeNumberAttrib("static FresnelTeamColor",this.fresnelTeamColor)),e.endBlock()}getByteLength(e){let t=28+super.getByteLength();return e>800&&(t+=24),t}},jt=class{priorityPlane=0;flags=0;shader="";layers=[];readMdx(e,t){e.readUint32(),this.priorityPlane=e.readInt32(),this.flags=e.readUint32(),t>800&&(this.shader=e.read(80)),e.skip(4);for(let i=0,s=e.readUint32();i<s;i++){const r=new Kt;r.readMdx(e,t),this.layers.push(r)}}writeMdx(e,t){e.writeUint32(this.getByteLength(t)),e.writeInt32(this.priorityPlane),e.writeUint32(this.flags),t>800&&e.skip(80-e.write(this.shader)),e.writeBinary("LAYS"),e.writeUint32(this.layers.length);for(const i of this.layers)i.writeMdx(e,t)}readMdl(e){for(const t of e.readBlock())if(t==="ConstantColor")this.flags|=1;else if(t==="TwoSided")this.flags|=2;else if(t==="SortPrimsNearZ")this.flags|=8;else if(t==="SortPrimsFarZ")this.flags|=16;else if(t==="FullResolution")this.flags|=32;else if(t==="PriorityPlane")this.priorityPlane=e.readInt();else if(t==="Shader")this.shader=e.read();else if(t==="Layer"){const i=new Kt;i.readMdl(e),this.layers.push(i)}else throw new Error(`Unknown token in Material: "${t}"`)}writeMdl(e,t){e.startBlock("Material"),this.flags&1&&e.writeFlag("ConstantColor"),t>800&&this.flags&2&&e.writeFlag("TwoSided"),this.flags&8&&e.writeFlag("SortPrimsNearZ"),this.flags&16&&e.writeFlag("SortPrimsFarZ"),this.flags&32&&e.writeFlag("FullResolution"),this.priorityPlane!==0&&e.writeNumberAttrib("PriorityPlane",this.priorityPlane),t>800&&e.writeStringAttrib("Shader",this.shader);for(const i of this.layers)i.writeMdl(e,t);e.endBlock()}getByteLength(e){let t=20;e>800&&(t+=80);for(const i of this.layers)t+=i.getByteLength(e);return t}};var Ke=(n=>(n[n.RepeatBoth=0]="RepeatBoth",n[n.WrapWidth=1]="WrapWidth",n[n.WrapHeight=2]="WrapHeight",n[n.WrapBoth=3]="WrapBoth",n))(Ke||{});let Ye=class{replaceableId=0;path="";wrapMode=0;readMdx(e){this.replaceableId=e.readUint32(),this.path=e.read(260),this.wrapMode=e.readUint32()}writeMdx(e){e.writeUint32(this.replaceableId),e.skip(260-e.write(this.path)),e.writeUint32(this.wrapMode)}readMdl(e){for(const t of e.readBlock())if(t==="Image")this.path=e.read();else if(t==="ReplaceableId")this.replaceableId=e.readInt();else if(t==="WrapWidth")this.wrapMode|=1;else if(t==="WrapHeight")this.wrapMode|=2;else throw new Error(`Unknown token in Texture: "${t}"`)}writeMdl(e){e.startBlock("Bitmap"),this.path.length&&e.writeStringAttrib("Image",this.path),this.replaceableId!==0&&e.writeNumberAttrib("ReplaceableId",this.replaceableId),this.wrapMode&1&&e.writeFlag("WrapWidth"),this.wrapMode&2&&e.writeFlag("WrapHeight"),e.endBlock()}},Ei=class extends We{readMdx(e){const t=e.readUint32();this.readAnimations(e,t-4)}writeMdx(e){e.writeUint32(this.getByteLength()),this.writeAnimations(e)}readMdl(e){for(const t of e.readBlock())if(t==="Translation")this.readAnimation(e,"KTAT");else if(t==="Rotation")this.readAnimation(e,"KTAR");else if(t==="Scaling")this.readAnimation(e,"KTAS");else throw new Error(`Unknown token in TextureAnimation: "${t}"`)}writeMdl(e){e.startBlock("TVertexAnim "),this.writeAnimation(e,"KTAT"),this.writeAnimation(e,"KTAR"),this.writeAnimation(e,"KTAS"),e.endBlock()}getByteLength(){return 4+super.getByteLength()}},Ht=class{vertices=new Float32Array(0);normals=new Float32Array(0);faceTypeGroups=new Uint32Array(0);faceGroups=new Uint32Array(0);faces=new Uint16Array(0);vertexGroups=new Uint8Array(0);matrixGroups=new Uint32Array(0);matrixIndices=new Uint32Array(0);materialId=0;selectionGroup=0;selectionFlags=0;lod=-1;lodName="";extent=new qe;sequenceExtents=[];tangents=new Float32Array(0);skin=new Uint8Array(0);uvSets=[];readMdx(e,t){e.readUint32(),e.skip(4),this.vertices=e.readFloat32Array(e.readUint32()*3),e.skip(4),this.normals=e.readFloat32Array(e.readUint32()*3),e.skip(4),this.faceTypeGroups=e.readUint32Array(e.readUint32()),e.skip(4),this.faceGroups=e.readUint32Array(e.readUint32()),e.skip(4),this.faces=e.readUint16Array(e.readUint32()),e.skip(4),this.vertexGroups=e.readUint8Array(e.readUint32()),e.skip(4),this.matrixGroups=e.readUint32Array(e.readUint32()),e.skip(4),this.matrixIndices=e.readUint32Array(e.readUint32()),this.materialId=e.readUint32(),this.selectionGroup=e.readUint32(),this.selectionFlags=e.readUint32(),t>800&&(this.lod=e.readInt32(),this.lodName=e.read(80)),this.extent.readMdx(e);for(let i=0,s=e.readUint32();i<s;i++){const r=new qe;r.readMdx(e),this.sequenceExtents.push(r)}t>800&&(e.readBinary(4)==="TANG"?this.tangents=e.readFloat32Array(e.readUint32()*4):e.skip(-4),e.readBinary(4)==="SKIN"?this.skin=e.readUint8Array(e.readUint32()):e.skip(-4)),e.skip(4);for(let i=0,s=e.readUint32();i<s;i++)e.skip(4),this.uvSets.push(e.readFloat32Array(e.readUint32()*2))}writeMdx(e,t){e.writeUint32(this.getByteLength(t)),e.writeBinary("VRTX"),e.writeUint32(this.vertices.length/3),e.writeFloat32Array(this.vertices),e.writeBinary("NRMS"),e.writeUint32(this.normals.length/3),e.writeFloat32Array(this.normals),e.writeBinary("PTYP"),e.writeUint32(this.faceTypeGroups.length),e.writeUint32Array(this.faceTypeGroups),e.writeBinary("PCNT"),e.writeUint32(this.faceGroups.length),e.writeUint32Array(this.faceGroups),e.writeBinary("PVTX"),e.writeUint32(this.faces.length),e.writeUint16Array(this.faces),e.writeBinary("GNDX"),e.writeUint32(this.vertexGroups.length),e.writeUint8Array(this.vertexGroups),e.writeBinary("MTGC"),e.writeUint32(this.matrixGroups.length),e.writeUint32Array(this.matrixGroups),e.writeBinary("MATS"),e.writeUint32(this.matrixIndices.length),e.writeUint32Array(this.matrixIndices),e.writeUint32(this.materialId),e.writeUint32(this.selectionGroup),e.writeUint32(this.selectionFlags),t>800&&(e.writeInt32(this.lod),e.skip(80-e.write(this.lodName))),this.extent.writeMdx(e),e.writeUint32(this.sequenceExtents.length);for(const i of this.sequenceExtents)i.writeMdx(e);t>800&&(this.tangents.length&&(e.writeBinary("TANG"),e.writeUint32(this.tangents.length/4),e.writeFloat32Array(this.tangents)),this.skin.length&&(e.writeBinary("SKIN"),e.writeUint32(this.skin.length),e.writeUint8Array(this.skin))),e.writeBinary("UVAS"),e.writeUint32(this.uvSets.length);for(const i of this.uvSets)e.writeBinary("UVBS"),e.writeUint32(i.length/2),e.writeFloat32Array(i)}readMdl(e){for(let t of e.readBlock())if(t==="Vertices")this.vertices=e.readVectorsBlock(new Float32Array(e.readInt()*3),3);else if(t==="Normals")this.normals=e.readVectorsBlock(new Float32Array(e.readInt()*3),3);else if(t==="TVertices")this.uvSets.push(e.readVectorsBlock(new Float32Array(e.readInt()*2),2));else if(t==="VertexGroup"){const i=[];for(const s of e.readBlock())i.push(parseInt(s));this.vertexGroups=new Uint8Array(i)}else if(t==="Tangents")this.tangents=e.readVectorsBlock(new Float32Array(e.readInt()*4),4);else if(t==="SkinWeights")this.skin=e.readVector(new Uint8Array(e.readInt()*8));else if(t==="Faces"){this.faceTypeGroups=new Uint32Array([4]);const i=e.readInt(),s=e.readInt();e.read(),e.read(),this.faces=e.readVectorsBlock(new Uint16Array(s),s/i),this.faceGroups=new Uint32Array([s]),e.read()}else if(t==="Groups"){const i=[],s=[];e.readInt(),e.readInt();for(const r of e.readBlock()){let o=0;for(const a of e.readBlock())i.push(parseInt(a)),o+=1;s.push(o)}this.matrixIndices=new Uint32Array(i),this.matrixGroups=new Uint32Array(s)}else if(t==="MinimumExtent")e.readVector(this.extent.min);else if(t==="MaximumExtent")e.readVector(this.extent.max);else if(t==="BoundsRadius")this.extent.boundsRadius=e.readFloat();else if(t==="Anim"){const i=new qe;for(t of e.readBlock())t==="MinimumExtent"?e.readVector(i.min):t==="MaximumExtent"?e.readVector(i.max):t==="BoundsRadius"&&(i.boundsRadius=e.readFloat());this.sequenceExtents.push(i)}else if(t==="MaterialID")this.materialId=e.readInt();else if(t==="SelectionGroup")this.selectionGroup=e.readInt();else if(t==="Unselectable")this.selectionFlags=4;else if(t==="LevelOfDetail")this.lod=e.readInt();else if(t==="Name")this.lodName=e.read();else throw new Error(`Unknown token in Geoset: "${t}"`)}writeMdl(e,t){e.startBlock("Geoset"),e.writeVectorArrayBlock("Vertices",this.vertices,3),e.writeVectorArrayBlock("Normals",this.normals,3);for(const s of this.uvSets)e.writeVectorArrayBlock("TVertices",s,2);if(t>800&&this.tangents.length&&e.writeVectorArrayBlock("Tangents",this.tangents,4),this.vertexGroups.length){e.startBlock("VertexGroup");for(let s=0,r=this.vertexGroups.length;s<r;s++)e.writeLine(`${this.vertexGroups[s]},`);e.endBlock()}if(t>800&&this.skin.length){e.startBlock("SkinWeights",this.skin.length/8);for(let s=0,r=this.skin.length;s<r;s+=8)e.writeLine(`${this.skin.subarray(s,s+8).join(", ")},`);e.endBlock()}e.startBlock("Faces",1,this.faces.length),e.startBlock("Triangles"),e.writeVector(this.faces),e.endBlock(),e.endBlock(),e.startBlock("Groups",this.matrixGroups.length,this.matrixIndices.length);let i=0;for(const s of this.matrixGroups)e.writeVectorAttrib("Matrices",this.matrixIndices.subarray(i,i+s)),i+=s;e.endBlock(),this.extent.writeMdl(e);for(const s of this.sequenceExtents)e.startBlock("Anim"),s.writeMdl(e),e.endBlock();e.writeNumberAttrib("MaterialID",this.materialId),e.writeNumberAttrib("SelectionGroup",this.selectionGroup),this.selectionFlags===4&&e.writeFlag("Unselectable"),t>800&&(e.writeNumberAttrib("LevelOfDetail",this.lod),this.lodName.length&&e.writeStringAttrib("Name",this.lodName)),e.endBlock()}getByteLength(e){let t=120+this.vertices.byteLength+this.normals.byteLength+this.faceTypeGroups.byteLength+this.faceGroups.byteLength+this.faces.byteLength+this.vertexGroups.byteLength+this.matrixGroups.byteLength+this.matrixIndices.byteLength+this.sequenceExtents.length*28;e>800&&(t+=84,this.tangents.length&&(t+=8+this.tangents.byteLength),this.skin.length&&(t+=8+this.skin.byteLength));for(const i of this.uvSets)t+=8+i.byteLength;return t}},zt=class extends We{alpha=1;flags=0;color=new Float32Array([1,1,1]);geosetId=-1;readMdx(e){const t=e.readUint32();this.alpha=e.readFloat32(),this.flags=e.readUint32(),e.readFloat32Array(this.color),this.geosetId=e.readInt32(),this.readAnimations(e,t-28)}writeMdx(e){e.writeUint32(this.getByteLength()),e.writeFloat32(this.alpha),e.writeUint32(this.flags),e.writeFloat32Array(this.color),e.writeInt32(this.geosetId),this.writeAnimations(e)}readMdl(e){for(const t of super.readAnimatedBlock(e))if(t==="DropShadow")this.flags|=1;else if(t==="static Alpha")this.alpha=e.readFloat();else if(t==="Alpha")this.readAnimation(e,"KGAO");else if(t==="static Color")this.flags|=2,e.readColor(this.color);else if(t==="Color")this.flags|=2,this.readAnimation(e,"KGAC");else if(t==="GeosetId")this.geosetId=e.readInt();else throw new Error(`Unknown token in GeosetAnimation: "${t}"`)}writeMdl(e){e.startBlock("GeosetAnim"),this.flags&1&&e.writeFlag("DropShadow"),this.writeAnimation(e,"KGAO")||e.writeNumberAttrib("static Alpha",this.alpha),this.flags&2&&!this.writeAnimation(e,"KGAC")&&(this.color[0]!==1||this.color[1]!==1||this.color[2]!==1)&&e.writeColor("static Color ",this.color),e.writeNumberAttrib("GeosetId",this.geosetId),e.endBlock()}getByteLength(){return 28+super.getByteLength()}};var Be=(n=>(n[n.None=0]="None",n[n.DontInheritTranslation=1]="DontInheritTranslation",n[n.DontInheritScaling=2]="DontInheritScaling",n[n.DontInheritRotation=4]="DontInheritRotation",n[n.Billboarded=8]="Billboarded",n[n.BillboardedLockX=16]="BillboardedLockX",n[n.BillboardedLockY=32]="BillboardedLockY",n[n.BillboardedLockZ=64]="BillboardedLockZ",n[n.CameraAnchored=128]="CameraAnchored",n))(Be||{});let fe=class extends We{name="";objectId=-1;parentId=-1;flags;constructor(e=0){super(),this.flags=e}readMdx(e){const t=e.readUint32();this.name=e.read(80),this.objectId=e.readInt32(),this.parentId=e.readInt32(),this.flags=e.readUint32(),this.readAnimations(e,t-96)}writeMdx(e){e.writeUint32(this.getGenericByteLength()),e.skip(80-e.write(this.name)),e.writeInt32(this.objectId),e.writeInt32(this.parentId),e.writeUint32(this.flags);for(const t of this.eachAnimation(!0))t.writeMdx(e)}writeNonGenericAnimationChunks(e){for(const t of this.eachAnimation(!1))t.writeMdx(e)}*readGenericBlock(e){this.name=e.read();for(let t of this.readAnimatedBlock(e))if(t==="ObjectId")this.objectId=e.readInt();else if(t==="Parent")this.parentId=e.readInt();else if(t==="BillboardedLockZ")this.flags|=64;else if(t==="BillboardedLockY")this.flags|=32;else if(t==="BillboardedLockX")this.flags|=16;else if(t==="Billboarded")this.flags|=8;else if(t==="CameraAnchored")this.flags|=128;else if(t==="DontInherit")for(t of e.readBlock())t==="Rotation"?this.flags|=4:t==="Translation"?this.flags|=1:t==="Scaling"&&(this.flags|=2);else t==="Translation"?this.readAnimation(e,"KGTR"):t==="Rotation"?this.readAnimation(e,"KGRT"):t==="Scaling"?this.readAnimation(e,"KGSC"):yield t}writeGenericHeader(e){e.writeNumberAttrib("ObjectId",this.objectId),this.parentId!==-1&&e.writeNumberAttrib("Parent",this.parentId),this.flags&64&&e.writeFlag("BillboardedLockZ"),this.flags&32&&e.writeFlag("BillboardedLockY"),this.flags&16&&e.writeFlag("BillboardedLockX"),this.flags&8&&e.writeFlag("Billboarded"),this.flags&128&&e.writeFlag("CameraAnchored"),this.flags&4&&e.writeFlag("DontInherit { Rotation }"),this.flags&1&&e.writeFlag("DontInherit { Translation }"),this.flags&2&&e.writeFlag("DontInherit { Scaling }")}writeGenericAnimations(e){this.writeAnimation(e,"KGTR"),this.writeAnimation(e,"KGRT"),this.writeAnimation(e,"KGSC")}*eachAnimation(e){for(const t of this.animations){const i=t.name,s=i==="KGTR"||i==="KGRT"||i==="KGSC";(e&&s||!e&&!s)&&(yield t)}}getGenericByteLength(){let e=96;for(const t of this.eachAnimation(!0))e+=t.getByteLength();return e}getByteLength(){return 96+super.getByteLength()}},vt=class extends fe{geosetId=-1;geosetAnimationId=-1;constructor(){super(256)}readMdx(e){super.readMdx(e),this.geosetId=e.readInt32(),this.geosetAnimationId=e.readInt32()}writeMdx(e){super.writeMdx(e),e.writeInt32(this.geosetId),e.writeInt32(this.geosetAnimationId)}readMdl(e){for(let t of super.readGenericBlock(e))if(t==="GeosetId")t=e.read(),t==="Multiple"?this.geosetId=-1:this.geosetId=parseInt(t);else if(t==="GeosetAnimId")t=e.read(),t==="None"?this.geosetAnimationId=-1:this.geosetAnimationId=parseInt(t);else throw new Error(`Unknown token in Bone ${this.name}: "${t}"`)}writeMdl(e){e.startObjectBlock("Bone",this.name),this.writeGenericHeader(e),this.geosetId===-1?e.writeFlagAttrib("GeosetId","Multiple"):e.writeNumberAttrib("GeosetId",this.geosetId),this.geosetAnimationId===-1?e.writeFlagAttrib("GeosetAnimId","None"):e.writeNumberAttrib("GeosetAnimId",this.geosetAnimationId),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 8+super.getByteLength()}},Si=class extends fe{type=-1;attenuation=new Float32Array(2);color=new Float32Array(3);intensity=0;ambientColor=new Float32Array(3);ambientIntensity=0;constructor(){super(512)}readMdx(e){const t=e.index,i=e.readUint32();super.readMdx(e),this.type=e.readUint32(),e.readFloat32Array(this.attenuation),e.readFloat32Array(this.color),this.intensity=e.readFloat32(),e.readFloat32Array(this.ambientColor),this.ambientIntensity=e.readFloat32(),this.readAnimations(e,i-(e.index-t))}writeMdx(e){e.writeUint32(this.getByteLength()),super.writeMdx(e),e.writeUint32(this.type),e.writeFloat32Array(this.attenuation),e.writeFloat32Array(this.color),e.writeFloat32(this.intensity),e.writeFloat32Array(this.ambientColor),e.writeFloat32(this.ambientIntensity),this.writeNonGenericAnimationChunks(e)}readMdl(e){for(const t of super.readGenericBlock(e))if(t==="Omnidirectional")this.type=0;else if(t==="Directional")this.type=1;else if(t==="Ambient")this.type=2;else if(t==="static AttenuationStart")this.attenuation[0]=e.readFloat();else if(t==="AttenuationStart")this.readAnimation(e,"KLAS");else if(t==="static AttenuationEnd")this.attenuation[1]=e.readFloat();else if(t==="AttenuationEnd")this.readAnimation(e,"KLAE");else if(t==="static Intensity")this.intensity=e.readFloat();else if(t==="Intensity")this.readAnimation(e,"KLAI");else if(t==="static Color")e.readColor(this.color);else if(t==="Color")this.readAnimation(e,"KLAC");else if(t==="static AmbIntensity")this.ambientIntensity=e.readFloat();else if(t==="AmbIntensity")this.readAnimation(e,"KLBI");else if(t==="static AmbColor")e.readColor(this.ambientColor);else if(t==="AmbColor")this.readAnimation(e,"KLBC");else if(t==="Visibility")this.readAnimation(e,"KLAV");else throw new Error(`Unknown token in Light: "${t}"`)}writeMdl(e){e.startObjectBlock("Light",this.name),this.writeGenericHeader(e),this.type===0?e.writeFlag("Omnidirectional"):this.type===1?e.writeFlag("Directional"):this.type===2&&e.writeFlag("Ambient"),this.writeAnimation(e,"KLAS")||e.writeNumberAttrib("static AttenuationStart",this.attenuation[0]),this.writeAnimation(e,"KLAE")||e.writeNumberAttrib("static AttenuationEnd",this.attenuation[1]),this.writeAnimation(e,"KLAI")||e.writeNumberAttrib("static Intensity",this.intensity),this.writeAnimation(e,"KLAC")||e.writeColor("static Color",this.color),this.writeAnimation(e,"KLBI")||e.writeNumberAttrib("static AmbIntensity",this.ambientIntensity),this.writeAnimation(e,"KLBC")||e.writeColor("static AmbColor",this.ambientColor),this.writeAnimation(e,"KLAV"),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 48+super.getByteLength()}},Ii=class extends fe{readMdl(e){for(const t of super.readGenericBlock(e))throw new Error(`Unknown token in Helper: "${t}"`)}writeMdl(e){e.startObjectBlock("Helper",this.name),this.writeGenericHeader(e),this.writeGenericAnimations(e),e.endBlock()}},_i=class extends fe{path="";attachmentId=0;constructor(){super(2048)}readMdx(e){const t=e.index,i=e.readUint32();super.readMdx(e),this.path=e.read(260),this.attachmentId=e.readInt32(),this.readAnimations(e,i-(e.index-t))}writeMdx(e){e.writeUint32(this.getByteLength()),super.writeMdx(e),e.skip(260-e.write(this.path)),e.writeInt32(this.attachmentId),this.writeNonGenericAnimationChunks(e)}readMdl(e){for(const t of super.readGenericBlock(e))if(t==="AttachmentID")this.attachmentId=e.readInt();else if(t==="Path")this.path=e.read();else if(t==="Visibility")this.readAnimation(e,"KATV");else throw new Error(`Unknown token in Attachment ${this.name}: "${t}"`)}writeMdl(e){e.startObjectBlock("Attachment",this.name),this.writeGenericHeader(e),e.writeNumberAttrib("AttachmentID",this.attachmentId),this.path.length&&e.writeStringAttrib("Path",this.path),this.writeAnimation(e,"KATV"),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 268+super.getByteLength()}},Ci=class extends fe{emissionRate=0;gravity=0;longitude=0;latitude=0;path="";lifeSpan=0;speed=0;constructor(){super(4096)}readMdx(e){const t=e.index,i=e.readUint32();super.readMdx(e),this.emissionRate=e.readFloat32(),this.gravity=e.readFloat32(),this.longitude=e.readFloat32(),this.latitude=e.readFloat32(),this.path=e.read(260),this.lifeSpan=e.readFloat32(),this.speed=e.readFloat32(),this.readAnimations(e,i-(e.index-t))}writeMdx(e){e.writeUint32(this.getByteLength()),super.writeMdx(e),e.writeFloat32(this.emissionRate),e.writeFloat32(this.gravity),e.writeFloat32(this.longitude),e.writeFloat32(this.latitude),e.skip(260-e.write(this.path)),e.writeFloat32(this.lifeSpan),e.writeFloat32(this.speed),this.writeNonGenericAnimationChunks(e)}readMdl(e){for(let t of super.readGenericBlock(e))if(t==="EmitterUsesMDL")this.flags|=32768;else if(t==="EmitterUsesTGA")this.flags|=65536;else if(t==="static EmissionRate")this.emissionRate=e.readFloat();else if(t==="EmissionRate")this.readAnimation(e,"KPEE");else if(t==="static Gravity")this.gravity=e.readFloat();else if(t==="Gravity")this.readAnimation(e,"KPEG");else if(t==="static Longitude")this.longitude=e.readFloat();else if(t==="Longitude")this.readAnimation(e,"KPLN");else if(t==="static Latitude")this.latitude=e.readFloat();else if(t==="Latitude")this.readAnimation(e,"KPLT");else if(t==="Visibility")this.readAnimation(e,"KPEV");else if(t==="Particle")for(t of this.readAnimatedBlock(e))t==="static LifeSpan"?this.lifeSpan=e.readFloat():t==="LifeSpan"?this.readAnimation(e,"KPEL"):t==="static InitVelocity"?this.speed=e.readFloat():t==="InitVelocity"?this.readAnimation(e,"KPES"):t==="Path"&&(this.path=e.read());else throw new Error(`Unknown token in ParticleEmitter: "${t}"`)}writeMdl(e){e.startObjectBlock("ParticleEmitter",this.name),this.writeGenericHeader(e),this.flags&32768&&e.writeFlag("EmitterUsesMDL"),this.flags&65536&&e.writeFlag("EmitterUsesTGA"),this.writeAnimation(e,"KPEE")||e.writeNumberAttrib("static EmissionRate",this.emissionRate),this.writeAnimation(e,"KPEG")||e.writeNumberAttrib("static Gravity",this.gravity),this.writeAnimation(e,"KPLN")||e.writeNumberAttrib("static Longitude",this.longitude),this.writeAnimation(e,"KPLT")||e.writeNumberAttrib("static Latitude",this.latitude),this.writeAnimation(e,"KPEV"),e.startBlock("Particle"),this.writeAnimation(e,"KPEL")||e.writeNumberAttrib("static LifeSpan",this.lifeSpan),this.writeAnimation(e,"KPES")||e.writeNumberAttrib("static InitVelocity",this.speed),(this.flags&32768||this.flags&65536)&&e.writeStringAttrib("Path",this.path),e.endBlock(),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 288+super.getByteLength()}};var Ze=(n=>(n[n.Unshaded=32768]="Unshaded",n[n.SortPrimsFarZ=65536]="SortPrimsFarZ",n[n.LineEmitter=131072]="LineEmitter",n[n.Unfogged=262144]="Unfogged",n[n.ModelSpace=524288]="ModelSpace",n[n.XYQuad=1048576]="XYQuad",n))(Ze||{}),Me=(n=>(n[n.Blend=0]="Blend",n[n.Additive=1]="Additive",n[n.Modulate=2]="Modulate",n[n.Modulate2x=3]="Modulate2x",n[n.AlphaKey=4]="AlphaKey",n))(Me||{}),Qe=(n=>(n[n.Head=0]="Head",n[n.Tail=1]="Tail",n[n.Both=2]="Both",n))(Qe||{});let Li=class extends fe{speed=0;variation=0;latitude=0;gravity=0;lifeSpan=0;emissionRate=0;width=0;length=0;filterMode=0;rows=0;columns=0;headOrTail=0;tailLength=0;timeMiddle=0;segmentColors=[new Float32Array(3),new Float32Array(3),new Float32Array(3)];segmentAlphas=new Uint8Array(3);segmentScaling=new Float32Array(3);headIntervals=[new Uint32Array(3),new Uint32Array(3)];tailIntervals=[new Uint32Array(3),new Uint32Array(3)];textureId=-1;squirt=0;priorityPlane=0;replaceableId=0;readMdx(e){const t=e.index,i=e.readUint32();super.readMdx(e),this.speed=e.readFloat32(),this.variation=e.readFloat32(),this.latitude=e.readFloat32(),this.gravity=e.readFloat32(),this.lifeSpan=e.readFloat32(),this.emissionRate=e.readFloat32(),this.width=e.readFloat32(),this.length=e.readFloat32(),this.filterMode=e.readUint32(),this.rows=e.readUint32(),this.columns=e.readUint32(),this.headOrTail=e.readUint32(),this.tailLength=e.readFloat32(),this.timeMiddle=e.readFloat32(),e.readFloat32Array(this.segmentColors[0]),e.readFloat32Array(this.segmentColors[1]),e.readFloat32Array(this.segmentColors[2]),e.readUint8Array(this.segmentAlphas),e.readFloat32Array(this.segmentScaling),e.readUint32Array(this.headIntervals[0]),e.readUint32Array(this.headIntervals[1]),e.readUint32Array(this.tailIntervals[0]),e.readUint32Array(this.tailIntervals[1]),this.textureId=e.readInt32(),this.squirt=e.readUint32(),this.priorityPlane=e.readInt32(),this.replaceableId=e.readUint32(),this.readAnimations(e,i-(e.index-t))}writeMdx(e){e.writeUint32(this.getByteLength()),super.writeMdx(e),e.writeFloat32(this.speed),e.writeFloat32(this.variation),e.writeFloat32(this.latitude),e.writeFloat32(this.gravity),e.writeFloat32(this.lifeSpan),e.writeFloat32(this.emissionRate),e.writeFloat32(this.width),e.writeFloat32(this.length),e.writeUint32(this.filterMode),e.writeUint32(this.rows),e.writeUint32(this.columns),e.writeUint32(this.headOrTail),e.writeFloat32(this.tailLength),e.writeFloat32(this.timeMiddle),e.writeFloat32Array(this.segmentColors[0]),e.writeFloat32Array(this.segmentColors[1]),e.writeFloat32Array(this.segmentColors[2]),e.writeUint8Array(this.segmentAlphas),e.writeFloat32Array(this.segmentScaling),e.writeUint32Array(this.headIntervals[0]),e.writeUint32Array(this.headIntervals[1]),e.writeUint32Array(this.tailIntervals[0]),e.writeUint32Array(this.tailIntervals[1]),e.writeInt32(this.textureId),e.writeUint32(this.squirt),e.writeInt32(this.priorityPlane),e.writeUint32(this.replaceableId),this.writeNonGenericAnimationChunks(e)}readMdl(e){for(const t of super.readGenericBlock(e))if(t==="SortPrimsFarZ")this.flags|=65536;else if(t==="Unshaded")this.flags|=32768;else if(t==="LineEmitter")this.flags|=131072;else if(t==="Unfogged")this.flags|=262144;else if(t==="ModelSpace")this.flags|=524288;else if(t==="XYQuad")this.flags|=1048576;else if(t==="static Speed")this.speed=e.readFloat();else if(t==="Speed")this.readAnimation(e,"KP2S");else if(t==="static Variation")this.variation=e.readFloat();else if(t==="Variation")this.readAnimation(e,"KP2R");else if(t==="static Latitude")this.latitude=e.readFloat();else if(t==="Latitude")this.readAnimation(e,"KP2L");else if(t==="static Gravity")this.gravity=e.readFloat();else if(t==="Gravity")this.readAnimation(e,"KP2G");else if(t==="Visibility")this.readAnimation(e,"KP2V");else if(t==="Squirt")this.squirt=1;else if(t==="LifeSpan")this.lifeSpan=e.readFloat();else if(t==="static EmissionRate")this.emissionRate=e.readFloat();else if(t==="EmissionRate")this.readAnimation(e,"KP2E");else if(t==="static Width")this.width=e.readFloat();else if(t==="Width")this.readAnimation(e,"KP2N");else if(t==="static Length")this.length=e.readFloat();else if(t==="Length")this.readAnimation(e,"KP2W");else if(t==="Blend")this.filterMode=0;else if(t==="Additive")this.filterMode=1;else if(t==="Modulate")this.filterMode=2;else if(t==="Modulate2x")this.filterMode=3;else if(t==="AlphaKey")this.filterMode=4;else if(t==="Rows")this.rows=e.readInt();else if(t==="Columns")this.columns=e.readInt();else if(t==="Head")this.headOrTail=0;else if(t==="Tail")this.headOrTail=1;else if(t==="Both")this.headOrTail=2;else if(t==="TailLength")this.tailLength=e.readFloat();else if(t==="Time")this.timeMiddle=e.readFloat();else if(t==="SegmentColor"){e.read();for(let i=0;i<3;i++)e.read(),e.readColor(this.segmentColors[i]);e.read()}else if(t==="Alpha")e.readVector(this.segmentAlphas);else if(t==="ParticleScaling")e.readVector(this.segmentScaling);else if(t==="LifeSpanUVAnim")e.readVector(this.headIntervals[0]);else if(t==="DecayUVAnim")e.readVector(this.headIntervals[1]);else if(t==="TailUVAnim")e.readVector(this.tailIntervals[0]);else if(t==="TailDecayUVAnim")e.readVector(this.tailIntervals[1]);else if(t==="TextureID")this.textureId=e.readInt();else if(t==="ReplaceableId")this.replaceableId=e.readInt();else if(t==="PriorityPlane")this.priorityPlane=e.readInt();else throw new Error(`Unknown token in ParticleEmitter2: "${t}"`)}writeMdl(e){e.startObjectBlock("ParticleEmitter2",this.name),this.writeGenericHeader(e),this.flags&65536&&e.writeFlag("SortPrimsFarZ"),this.flags&32768&&e.writeFlag("Unshaded"),this.flags&131072&&e.writeFlag("LineEmitter"),this.flags&262144&&e.writeFlag("Unfogged"),this.flags&524288&&e.writeFlag("ModelSpace"),this.flags&1048576&&e.writeFlag("XYQuad"),this.writeAnimation(e,"KP2S")||e.writeNumberAttrib("static Speed",this.speed),this.writeAnimation(e,"KP2R")||e.writeNumberAttrib("static Variation",this.variation),this.writeAnimation(e,"KP2L")||e.writeNumberAttrib("static Latitude",this.latitude),this.writeAnimation(e,"KP2G")||e.writeNumberAttrib("static Gravity",this.gravity),this.writeAnimation(e,"KP2V"),this.squirt&&e.writeFlag("Squirt"),e.writeNumberAttrib("LifeSpan",this.lifeSpan),this.writeAnimation(e,"KP2E")||e.writeNumberAttrib("static EmissionRate",this.emissionRate),this.writeAnimation(e,"KP2N")||e.writeNumberAttrib("static Width",this.width),this.writeAnimation(e,"KP2W")||e.writeNumberAttrib("static Length",this.length),this.filterMode===0?e.writeFlag("Blend"):this.filterMode===1?e.writeFlag("Additive"):this.filterMode===2?e.writeFlag("Modulate"):this.filterMode===3?e.writeFlag("Modulate2x"):this.filterMode===4&&e.writeFlag("AlphaKey"),e.writeNumberAttrib("Rows",this.rows),e.writeNumberAttrib("Columns",this.columns),this.headOrTail===0?e.writeFlag("Head"):this.headOrTail===1?e.writeFlag("Tail"):this.headOrTail===2&&e.writeFlag("Both"),e.writeNumberAttrib("TailLength",this.tailLength),e.writeNumberAttrib("Time",this.timeMiddle),e.startBlock("SegmentColor"),e.writeColor("Color",this.segmentColors[0]),e.writeColor("Color",this.segmentColors[1]),e.writeColor("Color",this.segmentColors[2]),e.endBlockComma(),e.writeVectorAttrib("Alpha",this.segmentAlphas),e.writeVectorAttrib("ParticleScaling",this.segmentScaling),e.writeVectorAttrib("LifeSpanUVAnim",this.headIntervals[0]),e.writeVectorAttrib("DecayUVAnim",this.headIntervals[1]),e.writeVectorAttrib("TailUVAnim",this.tailIntervals[0]),e.writeVectorAttrib("TailDecayUVAnim",this.tailIntervals[1]),e.writeNumberAttrib("TextureID",this.textureId),this.replaceableId!==0&&e.writeNumberAttrib("ReplaceableId",this.replaceableId),this.priorityPlane!==0&&e.writeNumberAttrib("PriorityPlane",this.priorityPlane),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 175+super.getByteLength()}};class Bi extends fe{lifeSpan=0;emissionRate=0;speed=0;color=new Float32Array(3);alpha=1;replaceableId=0;path="";animationVisiblityGuide="";readMdx(e){const t=e.index,i=e.readUint32();super.readMdx(e),this.lifeSpan=e.readFloat32(),this.emissionRate=e.readFloat32(),this.speed=e.readFloat32(),e.readFloat32Array(this.color),this.alpha=e.readFloat32(),this.replaceableId=e.readUint32(),this.path=e.read(260),this.animationVisiblityGuide=e.read(260),this.readAnimations(e,i-(e.index-t))}writeMdx(e){e.writeUint32(this.getByteLength()),super.writeMdx(e),e.writeFloat32(this.lifeSpan),e.writeFloat32(this.emissionRate),e.writeFloat32(this.speed),e.writeFloat32Array(this.color),e.writeFloat32(this.alpha),e.writeUint32(this.replaceableId),e.skip(260-e.write(this.path)),e.skip(260-e.write(this.animationVisiblityGuide)),this.writeNonGenericAnimationChunks(e)}readMdl(e){for(const t of super.readGenericBlock(e))if(t==="SortPrimsFarZ")this.flags|=65536;else if(t==="Unshaded")this.flags|=32768;else if(t==="Unfogged")this.flags|=262144;else if(t==="static LifeSpan")this.lifeSpan=e.readFloat();else if(t==="LifeSpan")this.readAnimation(e,"KPPL");else if(t==="static EmissionRate")this.emissionRate=e.readFloat();else if(t==="EmissionRate")this.readAnimation(e,"KPPE");else if(t==="static Speed")this.speed=e.readFloat();else if(t==="Speed")this.readAnimation(e,"KPPS");else if(t==="static Color")e.readVector(this.color);else if(t==="Color")this.readAnimation(e,"KPPC");else if(t==="static Alpha")this.alpha=e.readFloat();else if(t==="Alpha")this.readAnimation(e,"KPPA");else if(t==="Visibility")this.readAnimation(e,"KPPV");else if(t==="ReplaceableId")this.replaceableId=e.readInt();else if(t==="Path")this.path=e.read();else if(t==="AnimVisibilityGuide")this.animationVisiblityGuide=e.read();else throw new Error(`Unknown token in ParticleEmitterPopcorn: "${t}"`)}writeMdl(e){e.startObjectBlock("ParticleEmitterPopcorn",this.name),this.writeGenericHeader(e),this.flags&65536&&e.writeFlag("SortPrimsFarZ"),this.flags&32768&&e.writeFlag("Unshaded"),this.flags&262144&&e.writeFlag("Unfogged"),this.writeAnimation(e,"KPPL")||e.writeNumberAttrib("static LifeSpan",this.lifeSpan),this.writeAnimation(e,"KPPE")||e.writeNumberAttrib("static EmissionRate",this.emissionRate),this.writeAnimation(e,"KPPS")||e.writeNumberAttrib("static Speed",this.speed),this.writeAnimation(e,"KPPC")||e.writeVectorAttrib("static Color",this.color),this.writeAnimation(e,"KPPA")||e.writeNumberAttrib("static Alpha",this.alpha),this.writeAnimation(e,"KPPV"),this.replaceableId!==0&&e.writeNumberAttrib("ReplaceableId",this.replaceableId),this.path.length&&e.writeStringAttrib("Path",this.path),this.animationVisiblityGuide.length&&e.writeStringAttrib("AnimVisibilityGuide",this.animationVisiblityGuide),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 556+super.getByteLength()}}let Ri=class extends fe{heightAbove=0;heightBelow=0;alpha=0;color=new Float32Array(3);lifeSpan=0;textureSlot=0;emissionRate=0;rows=0;columns=0;materialId=0;gravity=0;constructor(){super(16384)}readMdx(e){const t=e.index,i=e.readUint32();super.readMdx(e),this.heightAbove=e.readFloat32(),this.heightBelow=e.readFloat32(),this.alpha=e.readFloat32(),e.readFloat32Array(this.color),this.lifeSpan=e.readFloat32(),this.textureSlot=e.readUint32(),this.emissionRate=e.readUint32(),this.rows=e.readUint32(),this.columns=e.readUint32(),this.materialId=e.readInt32(),this.gravity=e.readFloat32(),this.readAnimations(e,i-(e.index-t))}writeMdx(e){e.writeUint32(this.getByteLength()),super.writeMdx(e),e.writeFloat32(this.heightAbove),e.writeFloat32(this.heightBelow),e.writeFloat32(this.alpha),e.writeFloat32Array(this.color),e.writeFloat32(this.lifeSpan),e.writeUint32(this.textureSlot),e.writeUint32(this.emissionRate),e.writeUint32(this.rows),e.writeUint32(this.columns),e.writeInt32(this.materialId),e.writeFloat32(this.gravity),this.writeNonGenericAnimationChunks(e)}readMdl(e){for(const t of super.readGenericBlock(e))if(t==="static HeightAbove")this.heightAbove=e.readFloat();else if(t==="HeightAbove")this.readAnimation(e,"KRHA");else if(t==="static HeightBelow")this.heightBelow=e.readFloat();else if(t==="HeightBelow")this.readAnimation(e,"KRHB");else if(t==="static Alpha")this.alpha=e.readFloat();else if(t==="Alpha")this.readAnimation(e,"KRAL");else if(t==="static Color")e.readColor(this.color);else if(t==="Color")this.readAnimation(e,"KRCO");else if(t==="static TextureSlot")this.textureSlot=e.readInt();else if(t==="TextureSlot")this.readAnimation(e,"KRTX");else if(t==="Visibility")this.readAnimation(e,"KRVS");else if(t==="EmissionRate")this.emissionRate=e.readInt();else if(t==="LifeSpan")this.lifeSpan=e.readFloat();else if(t==="Gravity")this.gravity=e.readFloat();else if(t==="Rows")this.rows=e.readInt();else if(t==="Columns")this.columns=e.readInt();else if(t==="MaterialID")this.materialId=e.readInt();else throw new Error(`Unknown token in RibbonEmitter: "${t}"`)}writeMdl(e){e.startObjectBlock("RibbonEmitter",this.name),this.writeGenericHeader(e),this.writeAnimation(e,"KRHA")||e.writeNumberAttrib("static HeightAbove",this.heightAbove),this.writeAnimation(e,"KRHB")||e.writeNumberAttrib("static HeightBelow",this.heightBelow),this.writeAnimation(e,"KRAL")||e.writeNumberAttrib("static Alpha",this.alpha),this.writeAnimation(e,"KRCO")||e.writeColor("static Color",this.color),this.writeAnimation(e,"KRTX")||e.writeNumberAttrib("static TextureSlot",this.textureSlot),this.writeAnimation(e,"KRVS"),e.writeNumberAttrib("EmissionRate",this.emissionRate),e.writeNumberAttrib("LifeSpan",this.lifeSpan),this.gravity!==0&&e.writeNumberAttrib("Gravity",this.gravity),e.writeNumberAttrib("Rows",this.rows),e.writeNumberAttrib("Columns",this.columns),e.writeNumberAttrib("MaterialID",this.materialId),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 56+super.getByteLength()}},Xt=class extends We{name="";position=new Float32Array(3);fieldOfView=0;farClippingPlane=0;nearClippingPlane=0;targetPosition=new Float32Array(3);readMdx(e){const t=e.readUint32();this.name=e.read(80),e.readFloat32Array(this.position),this.fieldOfView=e.readFloat32(),this.farClippingPlane=e.readFloat32(),this.nearClippingPlane=e.readFloat32(),e.readFloat32Array(this.targetPosition),this.readAnimations(e,t-120)}writeMdx(e){e.writeUint32(this.getByteLength()),e.skip(80-e.write(this.name)),e.writeFloat32Array(this.position),e.writeFloat32(this.fieldOfView),e.writeFloat32(this.farClippingPlane),e.writeFloat32(this.nearClippingPlane),e.writeFloat32Array(this.targetPosition),this.writeAnimations(e)}readMdl(e){this.name=e.read();for(let t of e.readBlock())if(t==="Position")e.readVector(this.position);else if(t==="Translation")this.readAnimation(e,"KCTR");else if(t==="Rotation")this.readAnimation(e,"KCRL");else if(t==="FieldOfView")this.fieldOfView=e.readFloat();else if(t==="FarClip")this.farClippingPlane=e.readFloat();else if(t==="NearClip")this.nearClippingPlane=e.readFloat();else if(t==="Target")for(t of e.readBlock())if(t==="Position")e.readVector(this.targetPosition);else if(t==="Translation")this.readAnimation(e,"KTTR");else throw new Error(`Unknown token in Camera ${this.name}'s Target: "${t}"`);else throw new Error(`Unknown token in Camera ${this.name}: "${t}"`)}writeMdl(e){e.startObjectBlock("Camera",this.name),e.writeVectorAttrib("Position",this.position),this.writeAnimation(e,"KCTR"),this.writeAnimation(e,"KCRL"),e.writeNumberAttrib("FieldOfView",this.fieldOfView),e.writeNumberAttrib("FarClip",this.farClippingPlane),e.writeNumberAttrib("NearClip",this.nearClippingPlane),e.startBlock("Target"),e.writeVectorAttrib("Position",this.targetPosition),this.writeAnimation(e,"KTTR"),e.endBlock(),e.endBlock()}getByteLength(){return 120+super.getByteLength()}};class Pi extends fe{globalSequenceId=-1;tracks=new Uint32Array(0);constructor(){super(1024)}readMdx(e){super.readMdx(e),e.skip(4);const t=e.readUint32();this.globalSequenceId=e.readInt32(),this.tracks=e.readUint32Array(t)}writeMdx(e){super.writeMdx(e),e.writeBinary("KEVT"),e.writeUint32(this.tracks.length),e.writeInt32(this.globalSequenceId),e.writeUint32Array(this.tracks)}readMdl(e){for(const t of super.readGenericBlock(e))if(t==="EventTrack"){const i=e.readInt();this.tracks=new Uint32Array(i),e.read(),e.peek()==="GlobalSeqId"&&(e.read(),this.globalSequenceId=e.readInt());for(let s=0;s<i;s++)this.tracks[s]=e.readInt();e.read()}else throw new Error(`Unknown token in EventObject: "${t}"`)}writeMdl(e){e.startObjectBlock("EventObject",this.name),this.writeGenericHeader(e),e.startBlock("EventTrack",this.tracks.length),this.globalSequenceId!==-1&&e.writeNumberAttrib("GlobalSeqId",this.globalSequenceId);for(const t of this.tracks)e.writeFlag(`${t}`);e.endBlock(),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 12+this.tracks.byteLength+super.getByteLength()}}let ki=class extends fe{type=0;vertices=[new Float32Array(3),new Float32Array(3)];boundsRadius=0;constructor(){super(8192)}readMdx(e){super.readMdx(e),this.type=e.readUint32(),e.readFloat32Array(this.vertices[0]),this.type!==2&&e.readFloat32Array(this.vertices[1]),(this.type===2||this.type===3)&&(this.boundsRadius=e.readFloat32())}writeMdx(e){super.writeMdx(e),e.writeUint32(this.type),e.writeFloat32Array(this.vertices[0]),this.type!==2&&e.writeFloat32Array(this.vertices[1]),(this.type===2||this.type===3)&&e.writeFloat32(this.boundsRadius)}readMdl(e){for(const t of super.readGenericBlock(e))if(t==="Box")this.type=0;else if(t==="Plane")this.type=1;else if(t==="Sphere")this.type=2;else if(t==="Cylinder")this.type=3;else if(t==="Vertices"){const i=e.readInt();e.read(),e.readVector(this.vertices[0]),i===2&&e.readVector(this.vertices[1]),e.read()}else if(t==="BoundsRadius")this.boundsRadius=e.readFloat();else throw new Error(`Unknown token in CollisionShape: "${t}"`)}writeMdl(e){e.startObjectBlock("CollisionShape",this.name),this.writeGenericHeader(e);let t="",i=2,s=!1;this.type===0?t="Box":this.type===1?t="Plane":this.type===2?(t="Sphere",i=1,s=!0):this.type===3&&(t="Cylinder",s=!0),e.writeFlag(t),e.startBlock("Vertices",i),e.writeVector(this.vertices[0]),i===2&&e.writeVector(this.vertices[1]),e.endBlock(),s&&e.writeNumberAttrib("BoundsRadius",this.boundsRadius),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){let e=16+super.getByteLength();return this.type!==2&&(e+=12),(this.type===2||this.type===3)&&(e+=4),e}};class Wt{type="";path="";readMdx(e){this.type=e.read(80),this.path=e.read(260)}writeMdx(e){e.skip(80-e.write(this.type)),e.skip(260-e.write(this.path))}readMdl(e){this.type=e.read();for(const t of e.readBlock())if(t==="Path")this.path=e.read();else throw new Error(`Unknown token in FaceEffect: "${t}"`)}writeMdl(e){e.startObjectBlock("FaceFX",this.type),e.writeStringAttrib("Path",this.path),e.endBlock()}}class Vo{tag;chunk;constructor(e,t,i){this.tag=i,this.chunk=e.readUint8Array(new Uint8Array(t))}writeMdx(e){e.writeBinary(this.tag),e.writeUint32(this.chunk.byteLength),e.writeUint8Array(this.chunk)}getByteLength(){return 8+this.chunk.byteLength}}function os(n){return n instanceof ArrayBuffer&&(n=new Uint8Array(n)),!!(n instanceof Uint8Array&&n[0]===77&&n[1]===68&&n[2]===76&&n[3]===88||typeof n=="string"&&n.startsWith("MDLX"))}function as(n){return n instanceof ArrayBuffer&&(n=new Uint8Array(n)),!!(n instanceof Uint8Array&&on(n,"FormatVersion",0,4096)||typeof n=="string"&&Br(n,"FormatVersion",0,4096))}let Je=class{version=800;name="";animationFile="";extent=new qe;blendTime=0;sequences=[];globalSequences=[];materials=[];textures=[];textureAnimations=[];geosets=[];geosetAnimations=[];bones=[];lights=[];helpers=[];attachments=[];pivotPoints=[];particleEmitters=[];particleEmitters2=[];particleEmittersPopcorn=[];ribbonEmitters=[];cameras=[];eventObjects=[];collisionShapes=[];faceEffects=[];bindPose=[];unknownChunks=[];load(e){if(os(e))typeof e=="string"&&(e=mi(e)),this.loadMdx(e);else if(as(e))typeof e!="string"&&(e=Ut(e)),this.loadMdl(e);else throw new Error("Not a valid MDX/MDL buffer")}loadMdx(e){const t=new X(e);let i,s;for(t.skip(4);t.remaining>0;)i=t.readBinary(4),s=t.readUint32(),i==="VERS"?this.loadVersionChunk(t):i==="MODL"?this.loadModelChunk(t):i==="SEQS"?this.loadStaticObjects(this.sequences,$t,t,s/132):i==="GLBS"?this.loadGlobalSequenceChunk(t,s):i==="MTLS"?this.loadDynamicObjects(this.materials,jt,t,s):i==="TEXS"?this.loadStaticObjects(this.textures,Ye,t,s/268):i==="TXAN"?this.loadDynamicObjects(this.textureAnimations,Ei,t,s):i==="GEOS"?this.loadDynamicObjects(this.geosets,Ht,t,s):i==="GEOA"?this.loadDynamicObjects(this.geosetAnimations,zt,t,s):i==="BONE"?this.loadDynamicObjects(this.bones,vt,t,s):i==="LITE"?this.loadDynamicObjects(this.lights,Si,t,s):i==="HELP"?this.loadDynamicObjects(this.helpers,Ii,t,s):i==="ATCH"?this.loadDynamicObjects(this.attachments,_i,t,s):i==="PIVT"?this.loadPivotPointChunk(t,s):i==="PREM"?this.loadDynamicObjects(this.particleEmitters,Ci,t,s):i==="PRE2"?this.loadDynamicObjects(this.particleEmitters2,Li,t,s):i==="CORN"?this.loadDynamicObjects(this.particleEmittersPopcorn,Bi,t,s):i==="RIBB"?this.loadDynamicObjects(this.ribbonEmitters,Ri,t,s):i==="CAMS"?this.loadDynamicObjects(this.cameras,Xt,t,s):i==="EVTS"?this.loadDynamicObjects(this.eventObjects,Pi,t,s):i==="CLID"?this.loadDynamicObjects(this.collisionShapes,ki,t,s):i==="FAFX"?this.loadStaticObjects(this.faceEffects,Wt,t,s/340):i==="BPOS"?this.loadBindPoseChunk(t,s):this.unknownChunks.push(new Vo(t,s,i))}loadVersionChunk(e){this.version=e.readUint32()}loadModelChunk(e){this.name=e.read(80),this.animationFile=e.read(260),this.extent.readMdx(e),this.blendTime=e.readUint32()}loadStaticObjects(e,t,i,s){for(let r=0;r<s;r++){const o=new t;o.readMdx(i),e.push(o)}}loadGlobalSequenceChunk(e,t){for(let i=0,s=t/4;i<s;i++)this.globalSequences.push(e.readUint32())}loadDynamicObjects(e,t,i,s){const r=i.index+s;for(;i.index<r;){const o=new t;o.readMdx(i,this.version),e.push(o)}}loadPivotPointChunk(e,t){for(let i=0,s=t/12;i<s;i++)this.pivotPoints.push(e.readFloat32Array(3))}loadBindPoseChunk(e,t){for(let i=0,s=e.readUint32();i<s;i++)this.bindPose[i]=e.readFloat32Array(12)}saveMdx(){const e=new X(new ArrayBuffer(this.getByteLength()));e.writeBinary("MDLX"),this.saveVersionChunk(e),this.saveModelChunk(e),this.saveStaticObjectChunk(e,"SEQS",this.sequences,132),this.saveGlobalSequenceChunk(e),this.saveDynamicObjectChunk(e,"MTLS",this.materials),this.saveStaticObjectChunk(e,"TEXS",this.textures,268),this.saveDynamicObjectChunk(e,"TXAN",this.textureAnimations),this.saveDynamicObjectChunk(e,"GEOS",this.geosets),this.saveDynamicObjectChunk(e,"GEOA",this.geosetAnimations),this.saveDynamicObjectChunk(e,"BONE",this.bones),this.saveDynamicObjectChunk(e,"LITE",this.lights),this.saveDynamicObjectChunk(e,"HELP",this.helpers),this.saveDynamicObjectChunk(e,"ATCH",this.attachments),this.savePivotPointChunk(e),this.saveDynamicObjectChunk(e,"PREM",this.particleEmitters),this.saveDynamicObjectChunk(e,"PRE2",this.particleEmitters2),this.version>800&&this.saveDynamicObjectChunk(e,"CORN",this.particleEmittersPopcorn),this.saveDynamicObjectChunk(e,"RIBB",this.ribbonEmitters),this.saveDynamicObjectChunk(e,"CAMS",this.cameras),this.saveDynamicObjectChunk(e,"EVTS",this.eventObjects),this.saveDynamicObjectChunk(e,"CLID",this.collisionShapes),this.version>800&&(this.saveStaticObjectChunk(e,"FAFX",this.faceEffects,340),this.saveBindPoseChunk(e));for(const t of this.unknownChunks)t.writeMdx(e);return e.uint8array}saveVersionChunk(e){e.writeBinary("VERS"),e.writeUint32(4),e.writeUint32(this.version)}saveModelChunk(e){e.writeBinary("MODL"),e.writeUint32(372),e.skip(80-e.write(this.name)),e.skip(260-e.write(this.animationFile)),this.extent.writeMdx(e),e.writeUint32(this.blendTime)}saveStaticObjectChunk(e,t,i,s){if(i.length){e.writeBinary(t),e.writeUint32(i.length*s);for(const r of i)r.writeMdx(e)}}saveGlobalSequenceChunk(e){if(this.globalSequences.length){e.writeBinary("GLBS"),e.writeUint32(this.globalSequences.length*4);for(const t of this.globalSequences)e.writeUint32(t)}}saveDynamicObjectChunk(e,t,i){if(i.length){e.writeBinary(t),e.writeUint32(this.getObjectsByteLength(i));for(const s of i)s.writeMdx(e,this.version)}}savePivotPointChunk(e){if(this.pivotPoints.length){e.writeBinary("PIVT"),e.writeUint32(this.pivotPoints.length*12);for(const t of this.pivotPoints)e.writeFloat32Array(t)}}saveBindPoseChunk(e){if(this.bindPose.length){e.writeBinary("BPOS"),e.writeUint32(4+this.bindPose.length*48),e.writeUint32(this.bindPose.length);for(const t of this.bindPose)e.writeFloat32Array(t)}}loadMdl(e){let t;const i=new Gt(e);for(;t=i.readToken();)if(t==="Version")this.loadVersionBlock(i);else if(t==="Model")this.loadModelBlock(i);else if(t==="Sequences")this.loadNumberedObjectBlock(this.sequences,$t,"Anim",i);else if(t==="GlobalSequences")this.loadGlobalSequenceBlock(i);else if(t==="Textures")this.loadNumberedObjectBlock(this.textures,Ye,"Bitmap",i);else if(t==="Materials")this.loadNumberedObjectBlock(this.materials,jt,"Material",i);else if(t==="TextureAnims")this.loadNumberedObjectBlock(this.textureAnimations,Ei,"TVertexAnim",i);else if(t==="Geoset")this.loadObject(this.geosets,Ht,i);else if(t==="GeosetAnim")this.loadObject(this.geosetAnimations,zt,i);else if(t==="Bone")this.loadObject(this.bones,vt,i);else if(t==="Light")this.loadObject(this.lights,Si,i);else if(t==="Helper")this.loadObject(this.helpers,Ii,i);else if(t==="Attachment")this.loadObject(this.attachments,_i,i);else if(t==="PivotPoints")this.loadPivotPointBlock(i);else if(t==="ParticleEmitter")this.loadObject(this.particleEmitters,Ci,i);else if(t==="ParticleEmitter2")this.loadObject(this.particleEmitters2,Li,i);else if(t==="ParticleEmitterPopcorn")this.loadObject(this.particleEmittersPopcorn,Bi,i);else if(t==="RibbonEmitter")this.loadObject(this.ribbonEmitters,Ri,i);else if(t==="Camera")this.loadObject(this.cameras,Xt,i);else if(t==="EventObject")this.loadObject(this.eventObjects,Pi,i);else if(t==="CollisionShape")this.loadObject(this.collisionShapes,ki,i);else if(t==="FaceFX")this.loadObject(this.faceEffects,Wt,i);else if(t==="BindPose")this.loadBindPoseBlock(i);else throw new Error(`Unsupported block: ${t}`)}loadVersionBlock(e){for(const t of e.readBlock())if(t==="FormatVersion")this.version=e.readInt();else throw new Error(`Unknown token in Version: "${t}"`)}loadModelBlock(e){this.name=e.read();for(const t of e.readBlock())if(t.startsWith("Num"))e.read();else if(t==="BlendTime")this.blendTime=e.readInt();else if(t==="MinimumExtent")e.readVector(this.extent.min);else if(t==="MaximumExtent")e.readVector(this.extent.max);else if(t==="BoundsRadius")this.extent.boundsRadius=e.readFloat();else if(t==="AnimationFile")this.animationFile=e.read();else throw new Error(`Unknown token in Model: "${t}"`)}loadNumberedObjectBlock(e,t,i,s){s.read();for(const r of s.readBlock())if(r===i){const o=new t;o.readMdl(s),e.push(o)}else throw new Error(`Unknown token in ${i}: "${r}"`)}loadGlobalSequenceBlock(e){e.read();for(const t of e.readBlock())if(t==="Duration")this.globalSequences.push(e.readInt());else throw new Error(`Unknown token in GlobalSequences: "${t}"`)}loadObject(e,t,i){const s=new t;s.readMdl(i),e.push(s)}loadPivotPointBlock(e){const t=e.readInt();e.read();for(let i=0;i<t;i++)this.pivotPoints.push(e.readVector(new Float32Array(3)));e.read()}loadBindPoseBlock(e){for(const t of e.readBlock())if(t==="Matrices"){const i=e.readInt();e.read();for(let s=0;s<i;s++)this.bindPose[s]=e.readVector(new Float32Array(12));e.read()}else throw new Error(`Unknown token in BindPose: "${t}"`)}saveMdl(){const e=new Gt;return this.saveVersionBlock(e),this.saveModelBlock(e),this.saveStaticObjectsBlock(e,"Sequences",this.sequences),this.saveGlobalSequenceBlock(e),this.saveStaticObjectsBlock(e,"Textures",this.textures),this.saveStaticObjectsBlock(e,"Materials",this.materials),this.saveStaticObjectsBlock(e,"TextureAnims",this.textureAnimations),this.saveObjects(e,this.geosets),this.saveObjects(e,this.geosetAnimations),this.saveObjects(e,this.bones),this.saveObjects(e,this.lights),this.saveObjects(e,this.helpers),this.saveObjects(e,this.attachments),this.savePivotPointBlock(e),this.saveObjects(e,this.particleEmitters),this.saveObjects(e,this.particleEmitters2),this.version>800&&this.saveObjects(e,this.particleEmittersPopcorn),this.saveObjects(e,this.ribbonEmitters),this.saveObjects(e,this.cameras),this.saveObjects(e,this.eventObjects),this.saveObjects(e,this.collisionShapes),this.version>800&&(this.saveObjects(e,this.faceEffects),this.saveBindPoseBlock(e)),e.buffer}saveVersionBlock(e){e.startBlock("Version"),e.writeNumberAttrib("FormatVersion",this.version),e.endBlock()}saveModelBlock(e){e.startObjectBlock("Model",this.name),e.writeNumberAttrib("BlendTime",this.blendTime),this.extent.writeMdl(e),this.animationFile.length&&e.writeStringAttrib("AnimationFile",this.animationFile),e.endBlock()}saveStaticObjectsBlock(e,t,i){if(i.length){e.startBlock(t,i.length);for(const s of i)s.writeMdl(e,this.version);e.endBlock()}}saveGlobalSequenceBlock(e){if(this.globalSequences.length){e.startBlock("GlobalSequences",this.globalSequences.length);for(const t of this.globalSequences)e.writeNumberAttrib("Duration",t);e.endBlock()}}saveObjects(e,t){for(const i of t)i.writeMdl(e,this.version)}savePivotPointBlock(e){if(this.pivotPoints.length){e.startBlock("PivotPoints",this.pivotPoints.length);for(const t of this.pivotPoints)e.writeVector(t);e.endBlock()}}saveBindPoseBlock(e){if(this.bindPose.length){e.startBlock("BindPose"),e.startBlock("Matrices",this.bindPose.length);for(const t of this.bindPose)e.writeVector(t);e.endBlock(),e.endBlock()}}getByteLength(){let e=396;return e+=this.getStaticObjectsChunkByteLength(this.sequences,132),e+=this.getStaticObjectsChunkByteLength(this.globalSequences,4),e+=this.getDynamicObjectsChunkByteLength(this.materials),e+=this.getStaticObjectsChunkByteLength(this.textures,268),e+=this.getDynamicObjectsChunkByteLength(this.textureAnimations),e+=this.getDynamicObjectsChunkByteLength(this.geosets),e+=this.getDynamicObjectsChunkByteLength(this.geosetAnimations),e+=this.getDynamicObjectsChunkByteLength(this.bones),e+=this.getDynamicObjectsChunkByteLength(this.lights),e+=this.getDynamicObjectsChunkByteLength(this.helpers),e+=this.getDynamicObjectsChunkByteLength(this.attachments),e+=this.getStaticObjectsChunkByteLength(this.pivotPoints,12),e+=this.getDynamicObjectsChunkByteLength(this.particleEmitters),e+=this.getDynamicObjectsChunkByteLength(this.particleEmitters2),this.version>800&&(e+=this.getDynamicObjectsChunkByteLength(this.particleEmittersPopcorn)),e+=this.getDynamicObjectsChunkByteLength(this.ribbonEmitters),e+=this.getDynamicObjectsChunkByteLength(this.cameras),e+=this.getDynamicObjectsChunkByteLength(this.eventObjects),e+=this.getDynamicObjectsChunkByteLength(this.collisionShapes),this.version>800&&(e+=this.getStaticObjectsChunkByteLength(this.faceEffects,340),e+=this.getBindPoseChunkByteLength()),e+=this.getObjectsByteLength(this.unknownChunks),e}getObjectsByteLength(e){let t=0;for(const i of e)t+=i.getByteLength(this.version);return t}getDynamicObjectsChunkByteLength(e){return e.length?8+this.getObjectsByteLength(e):0}getStaticObjectsChunkByteLength(e,t){return e.length?8+e.length*t:0}getBindPoseChunkByteLength(){return this.bindPose.length?12+this.bindPose.length*48:0}};class Go{buffer;uint8array;index=0;byteLength;bitBuffer=0;bits=0;constructor(e,t,i){const s=$e(e);t=t||0,i=i||s.length,this.buffer=e,this.uint8array=s.subarray(t,t+i),this.byteLength=e.byteLength}peekBits(e){return this.loadBits(e),this.bitBuffer&(1<<e)-1}readBits(e){const t=this.peekBits(e);return this.bitBuffer>>>=e,this.bits-=e,t}skipBits(e){this.loadBits(e),this.bitBuffer>>>=e,this.bits-=e}loadBits(e){for(;this.bits<e;)this.bitBuffer+=this.uint8array[this.index]<<this.bits,this.bits+=8,this.index+=1}}function Yt(n,e){return((1<<e)-1)/((1<<n)-1)}const $o=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(n){return typeof n}:function(n){return n&&typeof Symbol=="function"&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n},Re=(function(){function e(t){this.message="JPEG error: "+t}return e.prototype=new Error,e.prototype.name="JpegError",e.constructor=e,e})(),yt=new Uint8Array([0,1,8,16,9,2,3,10,17,24,32,25,18,11,4,5,12,19,26,33,40,48,41,34,27,20,13,6,7,14,21,28,35,42,49,56,57,50,43,36,29,22,15,23,30,37,44,51,58,59,52,45,38,31,39,46,53,60,61,54,47,55,62,63]),Zt=4017,Qt=799,Jt=3406,ei=2276,ti=1567,ii=3784,et=5793,ni=2896;function qo(n,e){let t=0,i=[],s,r,o=16;for(;o>0&&!n[o-1];)o--;i.push({children:[],index:0});let a=i[0],l;for(s=0;s<o;s++){for(r=0;r<n[s];r++){for(a=i.pop(),a.children[a.index]=e[t];a.index>0;)a=i.pop();for(a.index++,i.push(a);i.length<=s;)i.push(l={children:[],index:0}),a.children[a.index]=l.children,a=l;t++}s+1<o&&(i.push(l={children:[],index:0}),a.children[a.index]=l.children,a=l)}return i[0].children}function si(n,e,t){return 64*((n.blocksPerLine+1)*e+t)}function Ko(n,e,t,i,s,r,o,a,l){const c=t.mcusPerLine,d=t.progressive;let h=e,u=0,p=0;function g(){if(p>0)return p--,u>>p&1;if(u=n[e++],u===255){const I=n[e++];if(I)throw new Re("unexpected marker "+(u<<8|I).toString(16))}return p=7,u>>>7}function m(I){let B=I;for(;;){if(B=B[g()],typeof B=="number")return B;if((typeof B>"u"?"undefined":$o(B))!=="object")throw new Re("invalid huffman sequence")}}function w(I){let B=0;for(;I>0;)B=B<<1|g(),I--;return B}function b(I){if(I===1)return g()===1?1:-1;const B=w(I);return B>=1<<I-1?B:B+(-1<<I)+1}function v(I,B){const G=m(I.huffmanTableDC),ge=G===0?0:b(G);I.blockData[B]=I.pred+=ge;let K=1;for(;K<64;){const re=m(I.huffmanTableAC),le=re&15,oe=re>>4;if(le===0){if(oe<15)break;K+=16;continue}K+=oe;const kt=yt[K];I.blockData[B+kt]=b(le),K++}}function _(I,B){const G=m(I.huffmanTableDC),ge=G===0?0:b(G)<<l;I.blockData[B]=I.pred+=ge}function x(I,B){I.blockData[B]|=g()<<l}let T=0;function y(I,B){if(T>0){T--;return}let G=r,ge=o;for(;G<=ge;){const K=m(I.huffmanTableAC),re=K&15,le=K>>4;if(re===0){if(le<15){T=w(le)+(1<<le)-1;break}G+=16;continue}G+=le;const oe=yt[G];I.blockData[B+oe]=b(re)*(1<<l),G++}}let N=0,D;function j(I,B){let G=r;const ge=o;let K=0,re,le;for(;G<=ge;){const oe=yt[G];switch(N){case 0:if(le=m(I.huffmanTableAC),re=le&15,K=le>>4,re===0)K<15?(T=w(K)+(1<<K),N=4):(K=16,N=1);else{if(re!==1)throw new Re("invalid ACn encoding");D=b(re),N=K?2:3}continue;case 1:case 2:I.blockData[B+oe]?I.blockData[B+oe]+=g()<<l:(K--,K===0&&(N=N===2?3:0));break;case 3:I.blockData[B+oe]?I.blockData[B+oe]+=g()<<l:(I.blockData[B+oe]=D<<l,N=0);break;case 4:I.blockData[B+oe]&&(I.blockData[B+oe]+=g()<<l);break}G++}N===4&&(T--,T===0&&(N=0))}function q(I,B,G,ge,K){const re=G/c|0,le=G%c,oe=re*I.v+ge,kt=le*I.h+K,Ah=si(I,oe,kt);B(I,Ah)}function ce(I,B,G){const ge=G/I.blocksPerLine|0,K=G%I.blocksPerLine,re=si(I,ge,K);B(I,re)}const P=i.length;let z,V,S,$,C,U;d?r===0?U=a===0?_:x:U=a===0?y:j:U=v;let M=0,F,Q;P===1?Q=i[0].blocksPerLine*i[0].blocksPerColumn:Q=c*t.mcusPerColumn;let ve,Te;for(;M<Q;){const I=s?Math.min(Q-M,s):Q;for(V=0;V<P;V++)i[V].pred=0;if(T=0,P===1)for(z=i[0],C=0;C<I;C++)ce(z,U,M),M++;else for(C=0;C<I;C++){for(V=0;V<P;V++)for(z=i[V],ve=z.h,Te=z.v,S=0;S<Te;S++)for($=0;$<ve;$++)q(z,U,M,S,$);M++}p=0,F=Ui(n,e),F&&F.invalid&&(e=F.offset);const B=F&&F.marker;if(!B||B<=65280)throw new Re("marker was not found");if(B>=65488&&B<=65495)e+=2;else break}return F=Ui(n,e),F&&F.invalid&&(e=F.offset),e-h}function jo(n,e,t){const i=n.quantizationTable,s=n.blockData;let r,o,a,l,c,d,h,u,p,g,m,w,b,v,_,x,T;if(!i)throw new Re("missing required Quantization Table.");for(let y=0;y<64;y+=8){if(p=s[e+y],g=s[e+y+1],m=s[e+y+2],w=s[e+y+3],b=s[e+y+4],v=s[e+y+5],_=s[e+y+6],x=s[e+y+7],p*=i[y],(g|m|w|b|v|_|x)===0){T=et*p+512>>10,t[y]=T,t[y+1]=T,t[y+2]=T,t[y+3]=T,t[y+4]=T,t[y+5]=T,t[y+6]=T,t[y+7]=T;continue}g*=i[y+1],m*=i[y+2],w*=i[y+3],b*=i[y+4],v*=i[y+5],_*=i[y+6],x*=i[y+7],r=et*p+128>>8,o=et*b+128>>8,a=m,l=_,c=ni*(g-x)+128>>8,u=ni*(g+x)+128>>8,d=w<<4,h=v<<4,r=r+o+1>>1,o=r-o,T=a*ii+l*ti+128>>8,a=a*ti-l*ii+128>>8,l=T,c=c+h+1>>1,h=c-h,u=u+d+1>>1,d=u-d,r=r+l+1>>1,l=r-l,o=o+a+1>>1,a=o-a,T=c*ei+u*Jt+2048>>12,c=c*Jt-u*ei+2048>>12,u=T,T=d*Qt+h*Zt+2048>>12,d=d*Zt-h*Qt+2048>>12,h=T,t[y]=r+u,t[y+7]=r-u,t[y+1]=o+h,t[y+6]=o-h,t[y+2]=a+d,t[y+5]=a-d,t[y+3]=l+c,t[y+4]=l-c}for(let y=0;y<8;++y){if(p=t[y],g=t[y+8],m=t[y+16],w=t[y+24],b=t[y+32],v=t[y+40],_=t[y+48],x=t[y+56],(g|m|w|b|v|_|x)===0){T=et*p+8192>>14,T=T<-2040?0:T>=2024?255:T+2056>>4,s[e+y]=T,s[e+y+8]=T,s[e+y+16]=T,s[e+y+24]=T,s[e+y+32]=T,s[e+y+40]=T,s[e+y+48]=T,s[e+y+56]=T;continue}r=et*p+2048>>12,o=et*b+2048>>12,a=m,l=_,c=ni*(g-x)+2048>>12,u=ni*(g+x)+2048>>12,d=w,h=v,r=(r+o+1>>1)+4112,o=r-o,T=a*ii+l*ti+2048>>12,a=a*ti-l*ii+2048>>12,l=T,c=c+h+1>>1,h=c-h,u=u+d+1>>1,d=u-d,r=r+l+1>>1,l=r-l,o=o+a+1>>1,a=o-a,T=c*ei+u*Jt+2048>>12,c=c*Jt-u*ei+2048>>12,u=T,T=d*Qt+h*Zt+2048>>12,d=d*Zt-h*Qt+2048>>12,h=T,p=r+u,x=r-u,g=o+h,_=o-h,m=a+d,v=a-d,w=l+c,b=l-c,p=p<16?0:p>=4080?255:p>>4,g=g<16?0:g>=4080?255:g>>4,m=m<16?0:m>=4080?255:m>>4,w=w<16?0:w>=4080?255:w>>4,b=b<16?0:b>=4080?255:b>>4,v=v<16?0:v>=4080?255:v>>4,_=_<16?0:_>=4080?255:_>>4,x=x<16?0:x>=4080?255:x>>4,s[e+y]=p,s[e+y+8]=g,s[e+y+16]=m,s[e+y+24]=w,s[e+y+32]=b,s[e+y+40]=v,s[e+y+48]=_,s[e+y+56]=x}}function Ho(n,e){const t=e.blocksPerLine,i=e.blocksPerColumn,s=new Int16Array(64);for(let r=0;r<i;r++)for(let o=0;o<t;o++){const a=si(e,r,o);jo(e,a,s)}return e.blockData}function Ui(n,e,t){function i(l){return n[l]<<8|n[l+1]}const s=n.length-1;let r=t<e?t:e;if(e>=s)return null;const o=i(e);if(o>=65472&&o<=65534)return{invalid:null,marker:o,offset:e};let a=i(r);for(;!(a>=65472&&a<=65534);){if(++r>=s)return null;a=i(r)}return{invalid:o.toString(16),marker:a,offset:r}}class zo{constructor(){this.decodeTransform=null,this.colorTransform=-1,this.width=0,this.height=0}parse(e){function t(){const C=e[r]<<8|e[r+1];return r+=2,C}function i(){const C=t();let U=r+C-2;const M=Ui(e,U,r);M&&M.invalid&&(U=M.offset);const F=e.subarray(r,U);return r+=F.length,F}function s(C){const U=Math.ceil(C.samplesPerLine/8/C.maxH),M=Math.ceil(C.scanLines/8/C.maxV);for(let F=0;F<C.components.length;F++){P=C.components[F];const Q=Math.ceil(Math.ceil(C.samplesPerLine/8)*P.h/C.maxH),ve=Math.ceil(Math.ceil(C.scanLines/8)*P.v/C.maxV),Te=U*P.h,B=64*(M*P.v)*(Te+1);P.blockData=new Int16Array(B),P.blocksPerLine=Q,P.blocksPerColumn=ve}C.mcusPerLine=U,C.mcusPerColumn=M}var r=0;let o=null,a=null,l,c;const d=[],h=[],u=[];let p=t();if(p!==65496)throw new Re("SOI not found");for(p=t();p!==65497;){var g,m,w;switch(p){case 65504:case 65505:case 65506:case 65507:case 65508:case 65509:case 65510:case 65511:case 65512:case 65513:case 65514:case 65515:case 65516:case 65517:case 65518:case 65519:case 65534:var b=i();p===65504&&b[0]===74&&b[1]===70&&b[2]===73&&b[3]===70&&b[4]===0&&(o={version:{major:b[5],minor:b[6]},densityUnits:b[7],xDensity:b[8]<<8|b[9],yDensity:b[10]<<8|b[11],thumbWidth:b[12],thumbHeight:b[13],thumbData:b.subarray(14,14+3*b[12]*b[13])}),p===65518&&b[0]===65&&b[1]===100&&b[2]===111&&b[3]===98&&b[4]===101&&(a={version:b[5]<<8|b[6],flags0:b[7]<<8|b[8],flags1:b[9]<<8|b[10],transformCode:b[11]});break;case 65499:for(var v=t(),_=v+r-2,x;r<_;){const C=e[r++],U=new Uint16Array(64);if(C>>4===0)for(m=0;m<64;m++)x=yt[m],U[x]=e[r++];else if(C>>4===1)for(m=0;m<64;m++)x=yt[m],U[x]=t();else throw new Re("DQT - invalid table spec");d[C&15]=U}break;case 65472:case 65473:case 65474:if(l)throw new Re("Only single frame JPEGs supported");t(),l={},l.extended=p===65473,l.progressive=p===65474,l.precision=e[r++],l.scanLines=t(),l.samplesPerLine=t(),l.components=[],l.componentIds={};var T=e[r++],y,N=0,D=0;for(g=0;g<T;g++){y=e[r];const C=e[r+1]>>4,U=e[r+1]&15;N<C&&(N=C),D<U&&(D=U);const M=e[r+2];w=l.components.push({h:C,v:U,quantizationId:M,quantizationTable:null}),l.componentIds[y]=w-1,r+=3}l.maxH=N,l.maxV=D,s(l);break;case 65476:var j=t();for(g=2;g<j;){const C=e[r++],U=new Uint8Array(16);let M=0;for(m=0;m<16;m++,r++)M+=U[m]=e[r];const F=new Uint8Array(M);for(m=0;m<M;m++,r++)F[m]=e[r];g+=17+M,(C>>4===0?u:h)[C&15]=qo(U,F)}break;case 65501:t(),c=t();break;case 65498:t();var q=e[r++],ce=[],P;for(g=0;g<q;g++){const C=l.componentIds[e[r++]];P=l.components[C];const U=e[r++];P.huffmanTableDC=u[U>>4],P.huffmanTableAC=h[U&15],ce.push(P)}var z=e[r++],V=e[r++],S=e[r++],$=Ko(e,r,l,ce,c,z,V,S>>4,S&15);r+=$;break;case 65535:e[r]!==255&&r--;break;default:if(e[r-3]===255&&e[r-2]>=192&&e[r-2]<=254){r-=3;break}throw new Re("unknown marker "+p.toString(16))}p=t()}for(this.width=l.samplesPerLine,this.height=l.scanLines,this.jfif=o,this.adobe=a,this.components=[],g=0;g<l.components.length;g++){P=l.components[g];const C=d[P.quantizationId];C&&(P.quantizationTable=C),this.components.push({output:Ho(l,P),scaleX:P.h/l.maxH,scaleY:P.v/l.maxV,blocksPerLine:P.blocksPerLine,blocksPerColumn:P.blocksPerColumn})}this.numComponents=this.components.length}getData(e){const t=e.data,i=this.components,s=new Uint8Array((i[0].blocksPerLine<<3)*i[0].blocksPerColumn*8);[i[0],i[2]]=[i[2],i[0]];for(let l=0,c=i.length;l<c;l++){const d=i[l],h=d.blocksPerLine,u=d.blocksPerColumn,p=h<<3;var r,o,a=0;for(let m=0;m<u;m++){const w=m<<3;for(let b=0;b<h;b++){const v=si(d,m,b);let _=0,x=b<<3;for(r=0;r<8;r++){var a=(w+r)*p;for(o=0;o<8;o++)s[a+x+o]=d.output[v+_++]}}}let g=l;for(let m=0;m<this.height;m++)for(let w=0;w<this.width;w++)t[g]=s[m*p+w],g+=c}return t}}const Xo=827345986,Fi=0;class At{content=0;alphaBits=0;width=0;height=0;type=0;hasMipmaps=!1;mipmapOffsets=new Uint32Array(16);mipmapSizes=new Uint32Array(16);uint8array=null;jpgHeader=null;pallete=null;load(e){const t=$e(e),i=new Int32Array(t.buffer,0,40);if(i[0]!==Xo)throw new Error("WrongMagicNumber");this.content=i[1],this.alphaBits=i[2],this.width=i[3],this.height=i[4],this.type=i[5],this.hasMipmaps=i[6]!==0;for(let s=0;s<16;s++)this.mipmapOffsets[s]=i[7+s],this.mipmapSizes[s]=i[23+s];this.uint8array=t,this.content===Fi?this.jpgHeader=t.subarray(160,160+i[39]):this.pallete=t.subarray(156,1180)}getMipmap(e){const t=this.uint8array,i=this.mipmapOffsets[e],s=this.mipmapSizes[e];let r;if(this.content===Fi){const o=this.jpgHeader,a=new Uint8Array(o.length+s),l=new zo;a.set(o),a.set(t.subarray(i,i+s),o.length),l.parse(a),r=new ImageData(l.width,l.height),l.getData(r)}else{const o=this.pallete,a=Math.max(this.width/(1<<e),1),l=Math.max(this.height/(1<<e),1),c=a*l;let d=this.alphaBits,h,u=0;r=new ImageData(a,l),d>0&&(d>8&&(d=8),h=new Go(t.buffer,i+c,Math.ceil(c*d/8)),u=Yt(d,8));const p=r.data;for(let g=0;g<c;g++){const m=g*4,w=t[i+g]*4;p[m]=o[w+2],p[m+1]=o[w+1],p[m+2]=o[w],d>0?p[m+3]=h.readBits(d)*u:p[m+3]=255}}return r}mipmaps(){let e=0;for(const t of this.mipmapSizes)t>0&&(e+=1);return e}fakeMipmaps(){const e=this.mipmapOffsets;let t=0;for(let i=0;i<16;i++){const s=e[i];if(s>0){for(let r=i+1;r<16;r++)if(s===e[r]){t+=1;break}}}return t}}const Wo=Yt(4,8),Oe=Yt(5,8),ri=Yt(6,8),Tt=new Uint8Array(16),De=new Uint8Array(12),ls=new Uint8Array(8),cs=new Uint8Array(8),hs=new Uint8Array(8);function Yo(n,e,t){const i=(e>>11&31)*Oe,s=(e>>5&63)*ri,r=(e&31)*Oe,o=(t>>11&31)*Oe,a=(t>>5&63)*ri,l=(t&31)*Oe;n[0]=i,n[1]=s,n[2]=r,n[3]=255,n[4]=o,n[5]=a,n[6]=l,n[7]=255,e>t?(n[8]=5*i+3*o>>3,n[9]=5*s+3*a>>3,n[10]=5*r+3*l>>3,n[11]=255,n[12]=5*o+3*i>>3,n[13]=5*a+3*s>>3,n[14]=5*l+3*r>>3,n[15]=255):(n[8]=i+o>>1,n[9]=s+a>>1,n[10]=r+l>>1,n[11]=255,n[12]=0,n[13]=0,n[14]=0,n[15]=0)}function ds(n,e,t){const i=(e>>11&31)*Oe,s=(e>>5&63)*ri,r=(e&31)*Oe,o=(t>>11&31)*Oe,a=(t>>5&63)*ri,l=(t&31)*Oe;n[0]=i,n[1]=s,n[2]=r,n[3]=o,n[4]=a,n[5]=l,n[6]=5*i+3*o>>3,n[7]=5*s+3*a>>3,n[8]=5*r+3*l>>3,n[9]=5*o+3*i>>3,n[10]=5*a+3*s>>3,n[11]=5*l+3*r>>3}function Zo(n,e,t){n[0]=e,n[1]=t,e>t?(n[2]=54*e+9*t>>6,n[3]=45*e+18*t>>6,n[4]=36*e+27*t>>6,n[5]=27*e+36*t>>6,n[6]=18*e+45*t>>6,n[7]=9*e+54*t>>6):(n[2]=12*e+3*t>>4,n[3]=9*e+6*t>>4,n[4]=6*e+9*t>>4,n[5]=3*e+12*t>>4,n[6]=0,n[7]=255)}function fs(n,e,t){n[0]=e,n[1]=t,e>t?(n[2]=(6*e+1*t)/7,n[3]=(5*e+2*t)/7,n[4]=(4*e+3*t)/7,n[5]=(3*e+4*t)/7,n[6]=(2*e+5*t)/7,n[7]=(1*e+6*t)/7):(n[2]=(4*e+1*t)/5,n[3]=(3*e+2*t)/5,n[4]=(2*e+3*t)/5,n[5]=(1*e+4*t)/5,n[6]=0,n[7]=1)}function Qo(n,e,t){const i=new Uint8Array(e*t*4);for(let s=0,r=t/4;s<r;s++)for(let o=0,a=e/4;o<a;o++){const l=8*(s*a+o);Yo(Tt,n[l]+256*n[l+1],n[l+2]+256*n[l+3]);const c=s*16*e+o*16,d=n[l+4]|n[l+5]<<8|n[l+6]<<16|n[l+7]<<24;for(let h=0;h<4;h++){const u=h*8,p=c+h*e*4;for(let g=0;g<4;g++){const m=p+g*4,w=(d>>u+g*2&3)*4;i[m+0]=Tt[w+0],i[m+1]=Tt[w+1],i[m+2]=Tt[w+2],i[m+3]=Tt[w+3]}}}return i}function Jo(n,e,t){const i=new Uint8Array(e*t*4),s=e*4;for(let r=0,o=t/4;r<o;r++)for(let a=0,l=e/4;a<l;a++){const c=16*(r*l+a);ds(De,n[c+8]+256*n[c+9],n[c+10]+256*n[c+11]);let d=r*16*e+a*16;for(let h=0;h<4;h++){const u=n[c+h*2]+256*n[c+1+h*2],p=n[c+12+h];for(let g=0;g<4;g++){const m=d+g*4,w=(p>>g*2&3)*3;i[m+0]=De[w+0],i[m+1]=De[w+1],i[m+2]=De[w+2],i[m+3]=(u>>g*4&15)*Wo}d+=s}}return i}function ea(n,e,t){const i=new Uint8Array(e*t*4),s=e*4;for(let r=0,o=t/4;r<o;r++)for(let a=0,l=e/4;a<l;a++){const c=16*(r*l+a);Zo(ls,n[c],n[c+1]),ds(De,n[c+8]+256*n[c+9],n[c+10]+256*n[c+11]);let d=r*16*e+a*16;for(let h=0;h<2;h++){const u=c+2+h*3,p=c+12+h*2,g=n[u]+256*(n[u+1]+256*n[u+2]);for(let m=0;m<2;m++){const w=n[p+m];for(let b=0;b<4;b++){const v=d+b*4,_=(w>>b*2&3)*3,x=g>>m*12+b*3&7;i[v+0]=De[_+0],i[v+1]=De[_+1],i[v+2]=De[_+2],i[v+3]=ls[x]}d+=s}}}return i}function ta(n,e,t){const i=new Uint8Array(e*t*2),s=e*2;for(let r=0,o=t/4;r<o;r++)for(let a=0,l=e/4;a<l;a++){const c=16*(r*l+a);fs(cs,n[c],n[c+1]),fs(hs,n[c+8],n[c+9]);let d=r*8*e+a*8;for(let h=0;h<2;h++){const u=c+h*3,p=n[u+2]+256*(n[u+3]+256*n[u+4]),g=n[u+10]+256*(n[u+11]+256*n[u+12]);for(let m=0;m<2;m++){const w=m*4;for(let b=0;b<4;b++){const v=d+b*2,_=3*(w+b);i[v+1]=cs[p>>_&7],i[v+2]=hs[g>>_&7]}d+=s}}}return i}const ia=542327876,na=131072,sa=4,Ve=827611204,tt=861165636,it=894720068,xt=843666497,ra=808540228,oa=71,aa=74,la=77,ca=83;class Et{width=0;height=0;format=0;mipmapWidths=[];mipmapHeights=[];mipmapDatas=[];load(e){const t=$e(e),i=new Int32Array(t.buffer,0,31);let s=128;if(i[0]!==ia)throw new Error("Wrong magic number");if(!(i[20]&sa))throw new Error("Not FourCC");let r=i[21];if(r!==Ve&&r!==tt&&r!==it&&r!==xt)if(r===ra){s+=20;const d=new Int32Array(t.buffer,128,5),h=d[0];if(h===oa)r=Ve;else if(h===aa)r=tt;else if(h===la)r=it;else if(h===ca)r=xt;else throw new Error(`Unsupported DXGI format: ${h}`);console.log(d)}else throw new Error(`Unsupported FourCC: ${Pr(r)}`);this.format=r;let o=1;i[2]&na&&(o=Math.max(1,i[7]));let a=i[4],l=i[3],c=16;r===Ve&&(c=8),this.width=a,this.height=l;for(let d=0;d<o;d++){const h=Math.max(4,a)/4*Math.max(4,l)/4*c;this.mipmapWidths[d]=a,this.mipmapHeights[d]=l,this.mipmapDatas[d]=t.subarray(s,s+h),s+=h,a=Math.max(a/2,1),l=Math.max(l/2,1)}}mipmaps(){return this.mipmapDatas.length}getMipmap(e,t=!1){const i=this.mipmapWidths[e],s=this.mipmapHeights[e],r=this.mipmapDatas[e];let o;return t?o=r:this.format===Ve?o=Qo(r,i,s):this.format===tt?o=Jo(r,i,s):this.format===it?o=ea(r,i,s):o=ta(r,i,s),{width:i,height:s,data:o}}}class St{width=0;height=0;data=null;load(e){const t=$e(e),i=new gt;i.load(t);const s=i.header;this.width=s.width,this.height=s.height,this.data=new ImageData(s.width,s.height),i.getImageData(this.data)}}let It,us,ps;typeof window=="object"&&(It=document.createElement("canvas"),us=It.getContext("2d"),ps=document.createElement("canvas"),ps.getContext("2d"));function ha(n){return new Promise((e,t)=>{const i=URL.createObjectURL(n),s=new Image;s.onload=()=>{e(s)},s.onerror=r=>{t(r)},s.src=i})}function da(n){return It.width=n.width,It.height=n.height,us.putImageData(n,0,0),It.toDataURL()}function fa(n){const e=new Image;return e.src=da(n),e}function ua(n){return n.includes("does not match the number of sequences")?`Having the wrong amount of geoset extents can in some cases crash War 3 Model Editor (Magos).

This does not affect the game.`:n.includes("has exactly the same value as tracks")?"A keyframe with the same value as the two keyframes sorrounding it is useless.":n.includes("has roughly the same value as tracks")?"A keyframe with roughly the same value as the two keyframes sorrounding it is many times useless.":n.includes("Missing opening track for sequence")?`When missing the opening keyframe for an animation, the game will wrap the animation and interpolate between the last and first keyframes.

However there is a bug in the game which causes the animation values to reverse.

To fix it, add a keyframe at the beginning of the animation.
`:n.includes("has the same frame")?"Remove one of the keyframes.":n==="Missing the Origin attachment point"?`Missing the Origin attachment stops many in-game effects from attaching to models.

Not relevant to portraits and special effects.`:n.includes("is not in global sequence")?"This keyframe uses a global sequence, but its frame is outside of the global sequence's range.":n==='Missing "Stand" sequence'?`Missing the stand animation can cause issues for models that are used as units.

Not relevant to portraits.`:n==='Missing "Death" sequence'?`Missing the death animation makes particles and other effects linger for a short time after an object using this model dies.
    
Not relevant to portraits.`:n.endsWith("is not in any sequence")?"A keyframe that is not in any animation is useless.":n.includes("is lower than the track before it at")?"A keyframe is not supposed to have a frame before the previous keyframe.":n==="There are no vertices attached to this bone"?"Bones with no attached vertices should preferably be converted to helpers.":""}function pa(n){return n.reverse().filter((e,t,i)=>i.indexOf(e,t+1)===-1).reverse()}function ga(n,e,t){if(t===-1){const i=n.model.sequences;for(let s=0,r=i.length;s<r;s++){const o=i[s].interval;if(e>=o[0]&&e<=o[1])return s}}else{const i=n.model.globalSequences[t];if(e>=0&&e<=i)return t}return-1}function ma(n,e,t,i){let s=-1/0;for(let r=0,o=e.length;r<o;r++){const a=e[r];n.assertWarning(a>=0,`Track ${r} has a negative frame ${a}`),a===s?n.addWarning(`Track ${r} has the same frame ${a} as track ${r-1}`):a<s&&n.addSevere(`Track ${r} at frame ${a} is lower than the track before it at ${s}`);const l=ga(n,a,t);l!==-1?i[l].push(r):a!==0&&e.length>1&&(t===-1?n.addUnused(`Track ${r} at frame ${a} is not in any sequence`):n.addUnused(`Track ${r} at frame ${a} is not in global sequence ${t}`)),s=a}}function ba(n,e,t){return t===-1?`sequence "${n.model.sequences[e].name}"`:`global sequence ${t}`}const wa=.001;function va(n,e,t){let i=0;for(let s=0,r=n.length;s<r;s++){const o=n[s],a=Math.abs(o-e[s]),l=Math.abs(o-t[s]);a>i&&(i=a),l>i&&(i=l)}return i}function ya(n,e){for(let t=0,i=n.length;t<i;t++)if(n[t]!==e[t])return!1;return!0}function Aa(n,e,t,i,s){const{globalSequenceId:r,interpolationType:o,values:a}=i;let l;r===-1?l=n.model.sequences[t].interval[0]:l=0;const c=e[0],d=e[e.length-1],h=s[c];if(o!==W.DontInterp&&h!==l){const u=a[c],p=a[d];ya(u,p)||n.addSevere(`Missing opening track for ${ba(n,t,r)} at frame ${l} where it is needed`)}if(e.length>2){let u=a[e[0]],p=a[e[1]];for(let g=2,m=e.length;g<m;g++){const w=a[e[g]],b=e[g-1],v=va(u,p,w);v===0?n.addUnused(`Track ${b} at frame ${s[b]} has exactly the same value as tracks ${b-1} and ${b+1}`):v<wa&&n.addUnused(`Track ${b} at frame ${s[b]} has roughly the same value as tracks ${b-1} and ${b+1}`),u=p,p=w}}}function gs(n,e){let t;e instanceof Ne?(n.assertWarning(e.frames.length>0,"Zero tracks"),t=e.frames):(n.assertError(e.tracks.length>0,"Zero tracks"),t=e.tracks);const i=e.globalSequenceId,s=[];if(i===-1){n.assertWarning(n.model.sequences.length>0,"This animation exists, but the model has no sequences");for(let r=0,o=n.model.sequences.length;r<o;r++)s.push([])}else if(Ge(n,n.model.globalSequences,i,"global sequence"))s[i]=[];else return;if(ma(n,t,i,s),e instanceof Ne)for(let r=0,o=s.length;r<o;r++){const a=s[r];a&&a.length>1&&Aa(n,a,r,e,t)}}function Ta(n,e,t){return n>=e&&n<=t}const xa=new Set(["attack","birth","cinematic","death","decay","dissipate","morph","portrait","sleep","spell","stand","walk","ready"]),ms=new Set([1,2,11,21,31,32,33,34,35,36,37]),bs=new Map([["KMTF","Texture ID"],["KMTA","Alpha"],["KMTE","Emissive Gain"],["KFC3","Fresnel Color"],["KFCA","Fresnel Opacity"],["KFTC","Fresnel Team Color"],["KTAT","Translation"],["KTAR","Rotation"],["KTAS","Scaling"],["KGAO","Alpha"],["KGAC","Color"],["KGTR","Translation"],["KGRT","Rotation"],["KGSC","Scaling"],["KLAS","Attenuation Start"],["KLAE","Attenuation End"],["KLAC","Color"],["KLAI","Intensity"],["KLBI","Ambient Intensity"],["KLBC","Ambient Color"],["KLAV","Visibility"],["KATV","Visibility"],["KPEE","Emission Rate"],["KPEG","Gravity"],["KPLN","Longitude"],["KPLT","Latitude"],["KPEL","Lifespan"],["KPES","Speed"],["KPEV","Visibility"],["KP2E","Emission Rate"],["KP2G","Gravity"],["KP2L","Latitude"],["KP2R","Variation"],["KP2N","Length"],["KP2W","Width"],["KP2S","Speed"],["KP2V","Visibility"],["KPPA","Alpha"],["KPPC","Color"],["KPPE","EmissionRate"],["KPPL","LifeSpan"],["KPPS","Speed"],["KPPV","Visibility"],["KRHA","Height Above"],["KRHB","Height Below"],["KRAL","Alpha"],["KRCO","Color"],["KRTX","Texture Slot"],["KRVS","Visibility"],["KCTR","Translation"],["KTTR","Rotation"],["KCRL","Target Translation"]]);function Ea(n,e){for(const t of n.animations)if(t.name===e)return!0;return!1}function ws(n){return n instanceof qe?"Extent":n instanceof $t?"Sequence":typeof n=="number"?"GlobalSequence":n instanceof Ye?"Texture":n instanceof jt?"Material":n instanceof Kt?"Layer":n instanceof Ei?"TextureAnimation":n instanceof Ht?"Geoset":n instanceof zt?"GeosetAnimation":n instanceof vt?"Bone":n instanceof Si?"Light":n instanceof Ii?"Helper":n instanceof _i?"Attachment":n instanceof Ci?"ParticleEmitter":n instanceof Li?"ParticleEmitter2":n instanceof Bi?"ParticleEmitterPopcorn":n instanceof Ri?"RibbonEmitter":n instanceof Pi?"EventObject":n instanceof Xt?"Camera":n instanceof ki?"CollisionShape":n instanceof Wt?"FaceEffect":n instanceof Ne?bs.get(n.name):(console.warn("Unknown object type",n),"Unknown")}function Ni(n,e){let t=ws(n);return!(n instanceof Ne)&&!(n instanceof qe)&&(t+=` ${e}`),(n instanceof $t||n instanceof fe||n instanceof Xt)&&(t+=` - "${n.name}"`),(n instanceof Ye||n instanceof Wt)&&(n.path.length&&(t+=` - "${mt(n.path)}"`),n instanceof Ye&&(n.replaceableId===1?t+=" - Team color":n.replaceableId===2?t+=" - Team glow":n.replaceableId>0&&(t+=` - Replaceable ID ${n.replaceableId}`))),t}function Y(n,e,t){const i=e.length;if(i){const s=e[0]instanceof We,r=e[0]instanceof fe;for(let o=0;o<i;o++){const a=e[o];if(n.push(a,o),t&&t(n,a,o),s&&Y(n,a.animations,Ca),r){const l=a,c=l.objectId,d=l.parentId;n.assertError(d===-1||_a(n,d),`Invalid parent ${d}`),n.assertError(c!==d,"Same object and parent")}n.pop()}}}function vs(n,e,t,i){if(t>=0&&t<e.length)return n.addReference(e[t]),e[t];n.addError(`Invalid ${i} ${t}`)}function Ge(n,e,t,i){return vs(n,e,t,i)!==void 0}function Sa(n){for(const e of n.animations)if(e.name==="KMTF")return pa(e.values.map(t=>t[0]));return[n.textureId]}function _t(n,e,t,i){const s=n.objects[t];if(i&&n.assertError(Ta(t,0,255),`Vertex ${e}: References bone ${t} but there can only be 256 bones in an HD model`),s)if(!(s instanceof vt))n.addSevere(`Vertex ${e}: Attached to "${s.name}" which is not a bone`);else{const r=n.boneUsageMap.get(t)||0;n.boneUsageMap.set(t,r+1)}else n.addError(`Vertex ${e}: Attached to object ${t} which does not exist`)}function Ia(n,e){if(n.model.version>800&&e.skin.length){n.assertWarning(e.vertexGroups.length===0,"This geoset has both skin/weights and vertex groups");const t=e.skin;for(let i=0,s=t.length/8;i<s;i++){const r=i*8,o=t[r],a=t[r+1],l=t[r+2],c=t[r+3],d=t[r+4],h=t[r+5],u=t[r+6],p=t[r+7];d>0&&_t(n,i,o,!0),h>0&&_t(n,i,a,!0),u>0&&_t(n,i,l,!0),p>0&&_t(n,i,c,!0);const g=d+h+u+p;g===0?n.addSevere(`Vertex ${i}: Not attached to anything`):g!==255&&n.addSevere(`Vertex ${i}: The weights are not normalized to 1`)}}else if(n.model.bones.length){const t=e.vertexGroups,i=e.matrixGroups,s=e.matrixIndices,r=[];for(let o=0,a=i.length,l=0;o<a;o++)r.push(s.subarray(l,l+i[o])),l+=i[o];for(let o=0,a=t.length;o<a;o++){const l=r[t[o]];if(l)for(const c of l)_t(n,o,c,!1);else{const c=t[o];c===255?n.addSevere(`Vertex ${o}: Not attached to anything`):n.addSevere(`Vertex ${o}: Attached to vertex group ${c} which does not exist`)}}}}function _a(n,e){for(const t of n.objects)if(t.objectId===e)return!0;return!1}function Ca(n,e){const t=e.name,i=e.interpolationType;n.assertWarning(t!=="KP2R","Using a variation animation."),n.assertWarning(t!=="KP2G","Using a gravity animation."),n.assertWarning(bs.get(t)!=="Visibility"||i===W.DontInterp,"Interpolation type not set to None"),gs(n,e)}function ys(n){const e=n.nodes;for(let t=e.length-1;t>=0;t--){const i=e[t];i.type==="node"&&(i.errors||i.severe||i.warnings||i.unused||i.uses!==void 0&&!i.uses?ys(i):e.splice(t,1))}}function La(n,e){for(const t of n.animations)if(t.name===e)return t}function oi(n,e){n.push(e,0);const{max:t,min:i}=e;(t[0]-i[0]<0||t[1]-i[1]<0||t[2]-i[2]<0)&&n.addWarning("Negative extents"),n.pop()}class Ba{model;objects=[];current;stack;map=new Map;foundStand=!1;foundDeath=!1;boneUsageMap=new Map;constructor(e){this.model=e,this.current={type:"node",name:"",errors:0,severe:0,warnings:0,unused:0,nodes:[]},this.stack=[this.current],this.addObjects(e.sequences),this.addObjects(e.globalSequences),this.addObjects(e.textures),this.addObjects(e.materials),this.addObjects(e.textureAnimations),this.addObjects(e.geosets),this.addObjects(e.geosetAnimations),this.addObjects(e.bones),this.addObjects(e.lights),this.addObjects(e.helpers),this.addObjects(e.attachments),this.addObjects(e.particleEmitters),this.addObjects(e.particleEmitters2),this.addObjects(e.particleEmittersPopcorn),this.addObjects(e.ribbonEmitters),this.addObjects(e.cameras),this.addObjects(e.eventObjects),this.addObjects(e.collisionShapes),this.addObjects(e.faceEffects)}addObjects(e){if(e.length){const t=e[0]instanceof fe;for(let i=0,s=e.length;i<s;i++){const r=e[i],a={type:"node",name:Ni(r,i),errors:0,severe:0,warnings:0,unused:0,nodes:[]};t||(a.uses=0),this.map.set(r,a)}t&&this.objects.push(...e)}}push(e,t){let i=this.map.get(e);i||(i={type:"node",name:Ni(e,t),errors:0,severe:0,warnings:0,unused:0,nodes:[]}),this.current.nodes.push(i),this.current=i,this.stack.unshift(i)}pop(){this.stack.shift(),this.current=this.stack[0]}addReference(e){const t=this.map.get(e);t.uses!==void 0&&(t.uses+=1)}addImplicitReference(){const e=this.current;e.uses!==void 0&&(e.uses+=1)}addError(e){this.current.nodes.push({type:"error",message:e});for(const t of this.stack)t.errors+=1}addSevere(e){this.current.nodes.push({type:"severe",message:e});for(const t of this.stack)t.severe+=1}addWarning(e){this.current.nodes.push({type:"warning",message:e});for(const t of this.stack)t.warnings+=1}addUnused(e){this.current.nodes.push({type:"unused",message:e});for(const t of this.stack)t.unused+=1}assertError(e,t){e||this.addError(t)}assertSevere(e,t){e||this.addSevere(t)}assertWarning(e,t){e||this.addWarning(t)}assertUnused(e,t){e||this.addUnused(t)}}function Ra(n){const e=n.model.version;e!==800&&e!==900&&e!==1e3&&n.addWarning(`Unknown version: ${e}`),e===900&&n.addError("Version 900 is not supported by Warcrft 3"),n.model.animationFile!==""&&n.addWarning(`The animation file should probably be empty, currently set to: "${n.model.animationFile}"`),oi(n,n.model.extent)}function Pa(n){const e=n.model.sequences;e.length?(Y(n,e,ka),n.assertSevere(n.foundStand,'Missing "Stand" sequence'),n.assertSevere(n.foundDeath,'Missing "Death" sequence')):n.addWarning("No sequences")}function ka(n,e,t){const s=e.name.toLowerCase().trim().split("-")[0].split(/\s+/);let r=s[0];const o=e.interval,a=o[1]-o[0],l=n.model.sequences;for(let c=0;c<t;c++){const d=l[c],h=d.interval;n.model.version===800&&(o[0]===h[0]?n.addSevere(`This sequence starts at the same frame as sequence ${c} "${d.name}"`):o[0]<h[1]&&n.addSevere(`This sequence starts before sequence ${c} "${d.name}" ends`))}r==="alternate"&&(r=s[1]),r==="stand"&&(n.foundStand=!0),r==="death"&&(n.foundDeath=!0),n.addImplicitReference(),n.assertWarning(xa.has(r),`"${r}" is not a standard name`),n.assertWarning(a!==0,"Zero length"),n.assertWarning(a>-1,`Negative length: ${a}`),oi(n,e.extent)}function Ua(n,e){n.assertWarning(e!==0,"Zero length"),n.assertWarning(e>=0,`Negative length: ${e}`)}function Fa(n){const e=n.model.textures;e.length?Y(n,e,Na):n.addWarning("No textures")}function Na(n,e){const t=e.replaceableId,i=e.path.toLowerCase(),s=ze(i);n.assertError(i===""||s===".blp"||s===".tga"||s===".tif"||s===".dds",`Corrupted path: "${i}"`),n.assertError(t===0||ms.has(t),`Unknown replaceable ID: ${t}`),n.assertWarning(i===""||t===0,`Path "${i}" and replaceable ID ${t} used together`)}function Ma(n,e){const t=e.layers,i=e.shader;n.model.version>800&&n.assertWarning(i===""||i==="Shader_SD_FixedFunction"||i==="Shader_HD_DefaultUnit",`Unknown shader: "${i}"`),t.length?Y(n,t,Oa):n.addWarning("No layers")}function Oa(n,e){const t=n.model.textures,i=n.model.textureAnimations;for(const o of Sa(e))Ge(n,t,o,"texture");const s=e.textureAnimationId;s!==-1&&Ge(n,i,s,"texture animation");const r=e.filterMode;n.assertWarning(r>=de.None&&r<=de.Modulate2x,`Invalid filter mode: ${e.filterMode}`)}function Da(n,e,t){const i=n.model.geosetAnimations,s=vs(n,n.model.materials,e.materialId,"material");let r=!1;if(s&&s.shader==="Shader_HD_DefaultUnit"&&(r=!0),r||n.assertSevere(e.vertices.length<22299,`Too many vertices in one geoset: ${e.vertices.length/3}`),Ia(n,e),i.length){const o=[];for(let a=0,l=i.length;a<l;a++)i[a].geosetId===t&&o.push(a);n.assertWarning(o.length<=1,`Referenced by ${o.length} geoset animations: ${o.join(", ")}`)}e.faces.length?n.addImplicitReference():n.addWarning("Zero faces"),e.sequenceExtents.length!==n.model.sequences.length&&n.model.version===800&&n.addWarning(`Number of sequence extents (${e.sequenceExtents.length}) does not match the number of sequences (${n.model.sequences.length})`),oi(n,e.extent);for(const o of e.sequenceExtents)oi(n,o)}function Va(n,e){const t=n.model.geosets,i=e.geosetId;n.addImplicitReference(),Ge(n,t,i,"geoset")}const Ga=.1;function $a(n,e,t){const i=n.model.geosets,s=n.model.geosetAnimations,r=e.geosetId,o=e.geosetAnimationId;if(r!==-1&&Ge(n,i,r,"geoset"),o!==-1&&Ge(n,s,o,"geoset animation")){const a=s[o];r!==-1&&a.alpha<Ga&&!Ea(a,"KGAO")&&n.addSevere(`Referencing geoset ${r} and geoset animation ${o} with a 0 alpha, the geoset may be invisible`)}n.assertWarning(n.boneUsageMap.get(t)>0,"There are no vertices attached to this bone")}function qa(n,e){const t=e.attenuation;n.assertWarning(t[0]>=80,`Minimum attenuation should probably be bigger than or equal to 80, but is ${t[0]}`),n.assertWarning(t[1]<=200,`Maximum attenuation should probably be smaller than or equal to 200, but is ${t[1]}`),n.assertWarning(t[1]-t[0]>0,"The maximum attenuation should be bigger than the minimum, but isn't")}function Ka(n){const e=n.model.attachments;let t=!1;for(const i of e){const s=i.path;if(s.length){const r=s.toLowerCase();n.assertError(r.endsWith(".mdl")||r.endsWith(".mdx"),`Invalid path "${s}"`)}i.name.startsWith("Origin Ref")&&(t=!0)}t||n.addWarning("Missing the Origin attachment point")}function ja(n){const e=n.model.pivotPoints,t=n.objects;n.assertWarning(e.length===t.length,`Expected ${t.length} pivot points, got ${e.length}`)}function Ha(n,e){const t=e.path.toLowerCase();n.assertError(t.endsWith(".mdl")||t.endsWith(".mdx"),"Invalid path")}function za(n,e){const t=e.replaceableId;Ge(n,n.model.textures,e.textureId,"texture");const i=e.filterMode;n.assertWarning(i>=Me.Blend&&i<=Me.AlphaKey,`Invalid filter mode: ${e.filterMode}`),n.assertError(t===0||ms.has(t),`Invalid replaceable ID: ${t}`),e.flags&Ze.XYQuad&&n.assertSevere(e.speed!==0&&e.latitude!==0,"XY Quad emitters must have a non-zero speed and latitude"),n.assertSevere(e.timeMiddle>=0&&e.timeMiddle<=1,`Expected time middle to be between 0 and 1, got ${e.timeMiddle}`),e.squirt&&!La(e,"KP2E")&&n.addSevere("Using squirt without animating the emission rate")}function Xa(n,e){n.assertSevere(e.animationVisiblityGuide.length>0,"No animation visibility guide")}function Wa(n,e){Ge(n,n.model.materials,e.materialId,"material")}function Ya(n,e){gs(n,e)}function Za(n,e){n.addImplicitReference()}function Qa(n,e){const t=e.path;t.length&&n.assertError(t.endsWith(".facefx")||t.endsWith(".facefx_ingame"),`Corrupted face effect path: "${t}"`),n.addImplicitReference()}function Ja(n){const e=n.model.bindPose,t=n.objects;e.length&&t.length&&n.assertWarning(e.length===t.length+1,`Expected ${t.length+1} matrices, got ${e.length}`)}function el(n){const e=new Ba(n);Ra(e),Pa(e),Y(e,n.globalSequences,Ua),Fa(e),Y(e,n.materials,Ma),Y(e,n.textureAnimations),Y(e,n.geosets,Da),Y(e,n.geosetAnimations,Va),Y(e,n.bones,$a),Y(e,n.lights,qa),Y(e,n.helpers),Ka(e),ja(e),Y(e,n.particleEmitters,Ha),Y(e,n.particleEmitters2,za),n.version>800&&Y(e,n.particleEmittersPopcorn,Xa),Y(e,n.ribbonEmitters,Wa),Y(e,n.eventObjects,Ya),Y(e,n.cameras,Za),Y(e,n.collisionShapes),n.version>800&&(Y(e,n.faceEffects,Qa),Ja(e));const t=e.stack[0];ys(t);const{nodes:i,errors:s,severe:r,warnings:o}=t;let{unused:a}=t;for(const l of i)l.type==="node"&&l.uses===0&&(a+=1);return{type:"node",nodes:i,errors:s,severe:r,warnings:o,unused:a}}function tl(n,e){const t=e[n];for(let i=0;i<n;i++)if(e[i]===t)return!0;return!1}function il(n){const e=[],t=n.content,i=n.alphaBits,s=n.mipmapOffsets,r=n.mipmapSizes;let o=n.width,a=n.height;if(t!==0&&t!==1&&e.push({type:"warning",message:"Unknown content type"}),i!==0&&i!==1&&i!==4&&i!==8&&e.push({type:"warning",message:`Expected alpha bits to be 0, 1, 4, or 8, but got ${i}`}),(o>512||a>512)&&e.push({type:"warning",message:`Expected width and height up to 512, but got ${o}x${a}`}),t===0){const l=n.jpgHeader;l.length>624&&e.push({type:"warning",message:`Expected the JPG header to be at most 624 bytes, but got ${l.length}`})}(!xe(o)||!xe(a))&&e.push({type:"warning",message:`Expected the width and height to be powers of two, but got ${o}x${a}`});for(let l=0;l<16;l++){if(r[l]>0)if(o<1&&a<1)e.push({type:"warning",message:`Mipmap ${l}: this mipmap should not exist`});else if(tl(l,s))e.push({type:"warning",message:`Mipmap ${l}: this mipmap is fake`});else{o=Math.max(o,1),a=Math.max(a,1);let c;try{c=n.getMipmap(l)}catch{e.push({type:"warning",message:`Mipmap ${l}: Decoding failed`})}if(c){if(t===0)(c.width!==o||c.height!==a)&&e.push({type:"warning",message:`Mipmap ${l}: the JPG width (${c.width}) and height (${c.height}) do not match the mipmap width (${o}) and height (${a})`});else if(t===1){const d=o*a,h=d+Math.ceil(d*i/8);h!==r[l]&&e.push({type:"warning",message:`Mipmap ${l}: the declared size is ${r[l]}, but the real size is ${h}`})}}}o>>=1,a>>=1}return{nodes:e,warnings:e.length}}function nl(n){const e=[],t=n.width,i=n.height,s=n.mipmaps(),r=Math.log2(Math.max(t,i));s<r&&e.push({type:"warning",message:`Expected ${r} mipmaps, but got ${s}`}),(t%4!==0||i%4!==0)&&e.push({type:"warning",message:`Expected the width and height to be multiples of four, but got ${t}x${i}`}),(!xe(t)||!xe(i))&&e.push({type:"warning",message:`Expected the width and height to be powers of two, but got ${t}x${i}`});for(let o=0;o<s;o++)try{n.getMipmap(o)}catch{e.push({type:"warning",message:`Mipmap ${o}: Decoding failed`})}return{nodes:e,warnings:e.length}}class sl extends ye{constructor(e){super(),this.nodes=[];const t=this.container,i=e instanceof Je,s=e instanceof At,r=e instanceof Et,o=e instanceof St,a=s||r||o;(s||r||o)&&(A({textContent:`Width: ${e.width}`,container:t}),A({textContent:`Height: ${e.height}`,container:t}),s?(e.content===Fi?A({textContent:"Content: JPG",container:t}):A({textContent:"Content: Palette",container:t}),e.alphaBits>8?A({textContent:`Alpha bits: ${e.alphaBits} (fake)`,container:t}):A({textContent:`Alpha bits: ${e.alphaBits}`,container:t}),A({textContent:`Mipmaps: ${e.mipmaps()} (fake: ${e.fakeMipmaps()})`,container:t})):r&&(e.format===Ve?A({textContent:"Content: BC1 (DXT1)",container:t}):e.format===tt?A({textContent:"Content: BC2 (DXT3)",container:t}):e.format===it?A({textContent:"Content: BC3 (DXT5)",container:t}):e.format===xt?A({textContent:"Content: BC5 (ATI2)",container:t}):A({textContent:"Content: Not supported",container:t}),A({textContent:`Mipmaps: ${e.mipmaps()}`,container:t})),A({tagName:"hr",container:t}));let l;if(i?l=el(e):s?l=il(e):r?l=nl(e):l={},l.nodes&&l.nodes.length)for(let c of l.nodes)this.nodes.push(new nt(c,t));else this.nodes.push(new nt({type:"bold",message:"Passed"},t));if(this.results=l,a)if(A({tagName:"hr",container:t}),s||r)for(let c=0,d=e.mipmaps();c<d;c++)try{let h;s?h=e.getMipmap(c):h=this.getDdsMipmap(e,c),this.addMipmap(h)}catch(h){this.results.errors===void 0?this.results.errors=1:this.results.errors+=1,this.nodes.push(new nt({type:"error",message:`Mipmap ${c}: ${h}`},this.container))}else this.addMipmap(e.data)}getDdsMipmap(e,t){const i=e.getMipmap(t);if(e.format===xt){const s=new ImageData(i.width,i.height),r=i.data,o=s.data;for(let a=0,l=i.width*i.height;a<l;a++){const c=a*2,d=a*4;o[d+0]=r[c+0],o[d+1]=r[c+1],o[d+2]=0,o[d+3]=255}return s}else return new ImageData(new Uint8ClampedArray(i.data.buffer),i.width,i.height)}addMipmap(e){const t=fa(e);t.className="padded",this.container.appendChild(t)}filter(e,t,i,s){for(let r of this.nodes)r.filter(e,t,i,s)}}class nt extends ye{constructor(e,t){super();let i="",s="",r="";e.type==="node"?(i="bold",s=e.name):(i=e.type,s=e.message,r=ua(s),r.length&&(i+=" pointer"));const o=A({className:i,textContent:s,title:r,container:this.container});if(r.length&&A({tagName:"span",className:"info_marker",textContent:"tooltip",container:o}),this.node=e,this.nodes=[],e.type==="node"&&(e.nodes.length||e.uses===0)){let a=A({className:"indent",container:this.container});e.uses===0&&this.nodes.push(new nt({type:"unused",message:"Not used"},a));for(let l of e.nodes)this.nodes.push(new nt(l,a))}t.appendChild(this.container)}filter(e,t,i,s){if(this.matchFilters(e,t,i,s)){if(this.node.type==="node")for(let r of this.nodes)r.filter(e,t,i,s);this.show()}else this.hide()}matchFilters(e,t,i,s){let r=this.node;if(r.type==="node")return(r.unused||r.uses===0)&&!e||r.warnings&&!t||r.severe&&!i||r.errors&&!s;{let o=r.type;return o==="unused"&&!e||o==="warning"&&!t||o==="severe"&&!i||o==="error"&&!s||o==="bold"}}}function Mi(n,e){return e===1?n:`${n}s`}class rl extends ye{constructor(e,t,i,s){super({...s,className:"clickable highlightable padded"}),this.name=A({className:"bold",textContent:e,container:this.container});let r=A({className:"indent",container:this.container});t&&A({className:"error",textContent:"Parsing failed",container:r}),i.errors||i.severe||i.warnings||i.unused?(i.errors&&A({className:"error",textContent:`${i.errors} ${Mi("error",i.errors)}`,container:r}),i.severe&&A({className:"severe",textContent:`${i.severe} ${Mi("severe warning",i.severe)}`,container:r}),i.warnings&&A({className:"warning",textContent:`${i.warnings} ${Mi("warning",i.warnings)}`,container:r}),i.unused&&A({className:"unused",textContent:`${i.unused} unused`,container:r})):A({className:"bold",textContent:"Passed",container:r})}}function ne(n,e,t,i){if(t.length)for(const[s,r]of t.entries())r.writeMdl(n,e.version),i.push({name:Ni(r,s),source:n.buffer}),n.clear()}function Oi(n,e,t,i){if(t.length){const s=ws(t[0])+"s",r=[];ne(n,e,t,r),e.saveStaticObjectsBlock(n,s,t),i.push({name:s,source:n.buffer,nodes:r}),n.clear()}}function ol(n){const e=new Gt,t=[];if(n.saveVersionBlock(e),t.push({name:"Version",source:e.buffer}),e.clear(),n.saveModelBlock(e),t.push({name:"Model",source:e.buffer}),e.clear(),Oi(e,n,n.sequences,t),n.globalSequences.length&&(n.saveGlobalSequenceBlock(e),t.push({name:"GlobalSequences",source:e.buffer}),e.clear()),Oi(e,n,n.textures,t),n.materials.length){const i=[];for(const[s,r]of n.materials.entries()){const o=[];ne(e,n,r.layers,o),r.writeMdl(e,n.version),i.push({name:`Material ${s}`,source:e.buffer,nodes:o}),e.clear()}n.saveStaticObjectsBlock(e,"Materials",n.materials),t.push({name:"Materials",source:e.buffer,nodes:i}),e.clear()}return Oi(e,n,n.textureAnimations,t),ne(e,n,n.geosets,t),ne(e,n,n.geosetAnimations,t),ne(e,n,n.bones,t),ne(e,n,n.lights,t),ne(e,n,n.helpers,t),ne(e,n,n.attachments,t),n.pivotPoints.length&&(n.savePivotPointBlock(e),t.push({name:"PivotPoints",source:e.buffer}),e.clear()),ne(e,n,n.particleEmitters,t),ne(e,n,n.particleEmitters2,t),ne(e,n,n.particleEmittersPopcorn,t),ne(e,n,n.ribbonEmitters,t),ne(e,n,n.cameras,t),ne(e,n,n.eventObjects,t),ne(e,n,n.collisionShapes,t),ne(e,n,n.faceEffects,t),n.bindPose.length&&(n.saveBindPoseBlock(e),t.push({name:"BindPose",source:e.buffer}),e.clear()),t}class al extends ye{constructor(e){super({className:"mdl-view"});const t=ol(e);this.structureElement=A({className:"mdl-structure",container:this.container}),this.sourceElement=A({tagName:"pre",className:"mdl-source",container:this.container}),this.nodes=[],this.visibleNode=null;for(let i of t)this.nodes.push(new Di(this,i,this.structureElement))}showNode(e){this.visibleNode&&this.visibleNode.normal(),this.visibleNode=e,e.highlight(),this.sourceElement.textContent=e.node.source}}class Di extends ye{constructor(e,t,i){if(super({className:"clickable highlightable",textContent:t.name,container:i}),this.container.addEventListener("click",()=>e.showNode(this)),this.node=t,this.nodes=[],t.nodes&&t.nodes.length){let s=A({className:"indent"});for(let r of t.nodes)this.nodes.push(new Di(e,r,s));i.appendChild(s)}}}class ll{constructor(e,t,i,s){let r=ze(t),o=r===".mdx"||r===".mdl",a=r===".blp",l=r===".dds";this.name=t,this.shortName=mt(t),this.parsingError=!1,this.results=null,this.mdl=null,this.pathSolver=s,this.resource=null,this.instance=null,this.boundingBox=null,this.boundingSphere=null,this.collisions=[],o?this.parser=new Je:a?this.parser=new At:l?this.parser=new Et:this.parser=new St;try{this.parser.load(i)}catch(c){this.parsingError=!0,e.logger.error(`Failed to parse ${t}: ${c}. The test will attempt to run on whatever data loaded`)}this.results=new sl(this.parser),o&&(this.mdl=new al(this.parser)),this.meta=new rl(this.shortName,this.parsingError,this.results.results,{onclick:()=>e.render(this)})}show(){this.meta.highlight(),this.results&&this.results.show(),this.mdl&&this.mdl.show()}hide(){this.meta.normal(),this.results&&this.results.hide(),this.mdl&&this.mdl.hide()}}class cl extends ye{constructor(e){super({...e,className:"console"}),this.messages=[],this.tabs=A({className:"tabs",container:this.container}),this.logsToggler=new Ae("Hide Logs","Show Logs",t=>this.filter(),{container:this.tabs}),this.infoToggler=new Ae("Hide Info","Show Info",t=>this.filter(),{container:this.tabs}),this.errorsToggler=new Ae("Hide Errors","Show Errors",t=>this.filter(),{container:this.tabs}),this.contents=A({className:"tab-contents",container:this.container}),this.logsToggler.toggle()}message(e,t){let i=new hl(e,t);i.filter(this.logsToggler.clicked,this.infoToggler.clicked,this.errorsToggler.clicked),this.messages.push(i);let s=ts(this.contents);this.contents.appendChild(i.container),s&&es(this.contents)}log(e){this.message("log",e)}info(e){this.message("info",e)}error(e){this.message("error",e)}filter(){let e=ts(this.contents);for(let t of this.messages)t.filter(this.logsToggler.clicked,this.infoToggler.clicked,this.errorsToggler.clicked);e&&es(this.contents)}}class hl extends ye{constructor(e,t){super({className:e,textContent:t}),this.type=e}matchFilters(e,t,i){let s=this.type;return s==="log"&&!e||s==="info"&&!t||s==="error"&&!i}filter(e,t,i){this.matchFilters(e,t,i)?this.show():this.hide()}}async function As(n,e){if(e==="image")return new Promise(t=>{const i=new Image;i.onload=()=>{t({ok:!0,data:i})},i.onerror=s=>{t({ok:!1,error:"Image Error",data:s})},i.src=n});{let t;try{t=await fetch(n)}catch(i){return{ok:!1,error:"Network Error",data:i}}if(!t.ok)return{ok:!1,error:"Http Error",data:t};try{let i=null;return e==="text"?i=await t.text():e==="arrayBuffer"||e==="bytes"?i=await t.arrayBuffer():e==="blob"&&(i=await t.blob()),e==="bytes"&&(i=new Uint8Array(i)),{ok:!0,data:i}}catch(i){return{ok:!1,error:"Data Error",data:i}}}}class dl{gl;buffer;size=0;arrayBuffer=null;byteView=null;floatView=null;constructor(e,t=4){this.gl=e,this.buffer=e.createBuffer(),this.reserve(t)}reserve(e){if(this.size<e){const t=this.gl;this.size=Math.ceil(e/4)*4,t.bindBuffer(t.ARRAY_BUFFER,this.buffer),t.bufferData(t.ARRAY_BUFFER,this.size,t.DYNAMIC_DRAW),this.arrayBuffer=new ArrayBuffer(this.size),this.byteView=new Uint8Array(this.arrayBuffer),this.floatView=new Float32Array(this.arrayBuffer)}}bindAndUpdate(e=this.size){const t=this.gl,i=this.byteView;t.bindBuffer(t.ARRAY_BUFFER,this.buffer),t.bufferSubData(t.ARRAY_BUFFER,0,i.subarray(0,e))}}class fl{gl;texture;width=0;height=0;arrayBuffer=new ArrayBuffer(0);byteView=null;floatView=null;constructor(e,t=1,i=1){this.gl=e,this.texture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),this.reserve(t,i)}reserve(e,t){if(this.width<e||this.height<t){const i=this.gl;this.width=Math.max(this.width,e),this.height=Math.max(this.height,t),i.bindTexture(i.TEXTURE_2D,this.texture),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,this.width,this.height,0,i.RGBA,i.FLOAT,null),this.arrayBuffer=new ArrayBuffer(this.width*this.height*16),this.byteView=new Uint8Array(this.arrayBuffer),this.floatView=new Float32Array(this.arrayBuffer)}}bindAndUpdate(e=this.width,t=this.height){const i=this.gl;i.bindTexture(i.TEXTURE_2D,this.texture),i.texSubImage2D(i.TEXTURE_2D,0,0,0,e,t,i.RGBA,i.FLOAT,this.byteView)}}class Ts{gl;texture;format;width=0;height=0;constructor(e,t=4,i=1,s=1){this.gl=e,this.texture=e.createTexture(),this.format=t===3?e.RGB:e.RGBA,e.bindTexture(e.TEXTURE_2D,this.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),this.reserve(i,s)}reserve(e,t){if(this.width<e||this.height<t){const i=this.gl;this.width=Math.max(this.width,e),this.height=Math.max(this.height,t),i.bindTexture(i.TEXTURE_2D,this.texture),i.texImage2D(i.TEXTURE_2D,0,this.format,this.width,this.height,0,this.format,i.FLOAT,null)}}bindAndUpdate(e,t=this.width,i=this.height){const s=this.gl;s.bindTexture(s.TEXTURE_2D,this.texture),s.texSubImage2D(s.TEXTURE_2D,0,0,0,t,i,this.format,s.FLOAT,e)}bind(e){const t=this.gl;t.activeTexture(t.TEXTURE0+e),t.bindTexture(t.TEXTURE_2D,this.texture)}}class ul{webgl;program;uniforms={};attribs={};attribsCount=0;constructor(e,t){this.webgl=e,this.program=t;const i=e.gl;for(let s=0,r=i.getProgramParameter(t,i.ACTIVE_UNIFORMS);s<r;s++){const o=i.getActiveUniform(t,s);if(o)if(o.size===1)this.uniforms[o.name]=i.getUniformLocation(t,o.name);else{const a=o.name.substr(0,o.name.length-3);for(let l=0;l<o.size;l++){const c=a+"["+l+"]";this.uniforms[c]=i.getUniformLocation(t,c)}}}for(let s=0,r=i.getProgramParameter(t,i.ACTIVE_ATTRIBUTES);s<r;s++){const o=i.getActiveAttrib(t,s);if(o)if(this.attribsCount+=o.size,o.size===1)this.attribs[o.name]=i.getAttribLocation(t,o.name);else{const a=o.name.substr(0,o.name.length-3);for(let l=0;l<o.size;l++){const c=a+"["+l+"]";this.attribs[c]=i.getAttribLocation(t,c)}}}}use(){this.webgl.useShader(this)}}class pl{gl;currentShader=null;emptyTexture;extensions={};constructor(e,t={alpha:!1}){let i=e.getContext("webgl",t);if(i||(i=e.getContext("experimental-webgl",t)),!i)throw new Error("WebGL: Failed to create a WebGL context!");const s=new Uint8ClampedArray(16).fill(255),r=i.createTexture();i.bindTexture(i.TEXTURE_2D,r),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,2,2,0,i.RGBA,i.UNSIGNED_BYTE,s),this.gl=i,this.emptyTexture=r}ensureExtension(e){const t=this.gl.getExtension(e);return t?(this.extensions[e]=t,!0):!1}createShader(e,t){const i=this.gl,s=i.createShader(i.VERTEX_SHADER);i.shaderSource(s,e),i.compileShader(s);const r=i.createShader(i.FRAGMENT_SHADER);i.shaderSource(r,t),i.compileShader(r);const o=i.createProgram();if(i.attachShader(o,s),i.attachShader(o,r),i.linkProgram(o),!i.getProgramParameter(o,i.LINK_STATUS)){let a="Shader failed to link:";const l=i.getShaderInfoLog(s);l&&l.length&&(a+=` Vertex shader: ${l}`);const c=i.getShaderInfoLog(r);throw c&&c.length&&(a+=` Fragment shader: ${c}`),new Error(a)}return new ul(this,o)}enableVertexAttribs(e,t){const i=this.gl;for(let s=e;s<t;s++)i.enableVertexAttribArray(s)}disableVertexAttribs(e,t){const i=this.gl;for(let s=e;s<t;s++)i.disableVertexAttribArray(s)}useShader(e){if(e&&e!==this.currentShader){let t=0;const i=e.attribsCount;this.currentShader&&(t=this.currentShader.attribsCount),this.gl.useProgram(e.program),i>t?this.enableVertexAttribs(t,i):i<t&&this.disableVertexAttribs(i,t),this.currentShader=e}}bindTexture(e,t){const i=this.gl;i.activeTexture(i.TEXTURE0+t),e?i.bindTexture(i.TEXTURE_2D,e.webglResource):i.bindTexture(i.TEXTURE_2D,this.emptyTexture)}bindTextureAndWrap(e,t,i,s){const r=this.gl;r.activeTexture(r.TEXTURE0+t),e?r.bindTexture(r.TEXTURE_2D,e.webglResource):r.bindTexture(r.TEXTURE_2D,this.emptyTexture),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,i),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,s)}setTextureMode(e,t,i,s){const r=this.gl;r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,e),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,t),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,i),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,s)}createClientBuffer(e=4){return new dl(this.gl,e)}createDataTexture(e=4,t=1,i=1){return new Ts(this.gl,e,t,i)}createClientDataTexture(e=1,t=1){return new fl(this.gl,e,t)}}const Vi=f.vec3.fromValues(1,0,0),xs=f.vec3.fromValues(0,1,0),Ct=f.vec3.fromValues(0,0,1),st=f.vec3.create(),Gi=f.vec3.fromValues(1,1,1);f.quat.fromValues(0,0,0,0);const $i=f.quat.create(),Pe=f.vec4.create();function Es(n,e,t,i){const s=2*(e[0]-i[0])/i[2]-1,r=1-2*(e[1]-i[1])/i[3],o=2*e[2]-1;return f.vec4.set(Pe,s,r,o,1),f.vec4.transformMat4(Pe,Pe,t),f.vec3.set(n,Pe[0]/Pe[3],Pe[1]/Pe[3],Pe[2]/Pe[3]),n}function ai(n,e,t){return n[0]*e+n[1]*t+n[3]}function Ss(n,e,t,i){return n[0]*e+n[1]*t+n[2]*i+n[3]}function gl(n,e,t,i,s,r){r===-1&&(r=0);for(let o=0;o<6;o++){const a=(r+o)%6;if(Ss(n[a],e,t,i)<=-s)return a}return-1}function ml(n,e,t,i,s,r){r===-1&&(r=0);for(let o=0;o<6;o++){const a=(r+o)%6,l=n[a];if(ai(l,e,i)<0&&ai(l,e,s)<0&&ai(l,t,s)<0&&ai(l,t,i)<0)return a}return-1}function bl(n){return Math.hypot(n[0],n[1],n[2])}function rt(n,e){const t=bl(e);n[0]=e[0]/t,n[1]=e[1]/t,n[2]=e[2]/t,n[3]=e[3]/t}function wl(n,e){const t=e[0],i=e[4],s=e[8],r=e[12],o=e[1],a=e[5],l=e[9],c=e[13],d=e[2],h=e[6],u=e[10],p=e[14],g=e[3],m=e[7],w=e[11],b=e[15];let v;v=n[0],v[0]=g+t,v[1]=m+i,v[2]=w+s,v[3]=b+r,v=n[1],v[0]=g-t,v[1]=m-i,v[2]=w-s,v[3]=b-r,v=n[2],v[0]=g-o,v[1]=m-a,v[2]=w-l,v[3]=b-c,v=n[3],v[0]=g+o,v[1]=m+a,v[2]=w+l,v[3]=b+c,v=n[4],v[0]=g+d,v[1]=m+h,v[2]=w+u,v[3]=b+p,v=n[5],v[0]=g-d,v[1]=m-h,v[2]=w-u,v[3]=b-p,rt(n[0],n[0]),rt(n[1],n[1]),rt(n[2],n[2]),rt(n[3],n[3]),rt(n[4],n[4]),rt(n[5],n[5])}const J=f.vec3.create(),ie=f.vec3.create(),ae=f.vec3.create();function Is(n,e,t,i){f.vec3.normalize(J,f.vec3.sub(J,t,e)),f.vec3.normalize(ie,f.vec3.cross(ie,i,J)),f.vec3.cross(ae,ie,J);const s=ie[0]+ae[2]+J[1];if(s>0){const r=.5/Math.sqrt(s+1);n[3]=.25/r,n[0]=(ae[1]-J[2])*r,n[2]=(J[0]-ie[1])*r,n[1]=(ie[2]-ae[0])*r}else if(ie[0]>ae[2]&&ie[0]>J[1]){const r=2*Math.sqrt(1+ie[0]-ae[2]-J[1]);n[3]=(ae[1]-J[2])/r,n[0]=.25*r,n[2]=(ae[0]+ie[2])/r,n[1]=(J[0]+ie[1])/r}else if(ae[2]>J[1]){const r=2*Math.sqrt(1+ae[2]-ie[0]-J[1]);n[3]=(J[0]-ie[1])/r,n[0]=(ae[0]+ie[2])/r,n[2]=.25*r,n[1]=(J[2]+ae[1])/r}else{const r=2*Math.sqrt(1+J[1]-ie[0]-ae[2]);n[3]=(ie[2]-ae[0])/r,n[0]=(J[0]+ie[1])/r,n[2]=(J[2]+ae[1])/r,n[1]=.25*r}return n}const Lt=f.vec3.create(),vl=f.vec3.create(),yl=f.vec3.create(),Al=f.quat.create(),Tl=f.quat.setAxisAngle(f.quat.create(),Vi,Math.PI/2);let xl=class{isPerspective=!0;fov=0;aspect=0;isOrtho=!1;leftClipPlane=0;rightClipPlane=0;bottomClipPlane=0;topClipPlane=0;nearClipPlane=0;farClipPlane=0;location=f.vec3.create();rotation=f.quat.create();inverseRotation=f.quat.create();viewMatrix=f.mat4.create();projectionMatrix=f.mat4.create();viewProjectionMatrix=f.mat4.create();inverseViewMatrix=f.mat4.create();inverseViewProjectionMatrix=f.mat4.create();directionX=f.vec3.create();directionY=f.vec3.create();directionZ=f.vec3.create();vectors=[f.vec3.fromValues(-1,-1,0),f.vec3.fromValues(-1,1,0),f.vec3.fromValues(1,1,0),f.vec3.fromValues(1,-1,0),f.vec3.fromValues(1,0,0),f.vec3.fromValues(0,1,0),f.vec3.fromValues(0,0,1)];billboardedVectors=[f.vec3.create(),f.vec3.create(),f.vec3.create(),f.vec3.create(),f.vec3.create(),f.vec3.create(),f.vec3.create()];planes=[f.vec4.create(),f.vec4.create(),f.vec4.create(),f.vec4.create(),f.vec4.create(),f.vec4.create()];perspective(e,t,i,s){this.isPerspective=!0,this.isOrtho=!1,this.fov=e,this.aspect=t,this.nearClipPlane=i,this.farClipPlane=s,this.update()}ortho(e,t,i,s,r,o){this.isPerspective=!1,this.isOrtho=!0,this.leftClipPlane=e,this.rightClipPlane=t,this.bottomClipPlane=i,this.topClipPlane=s,this.nearClipPlane=r,this.farClipPlane=o,this.update()}setLocation(e){f.vec3.copy(this.location,e),this.update()}move(e){f.vec3.add(this.location,this.location,e),this.update()}setRotation(e){f.quat.copy(this.rotation,e),this.update()}rotate(e){f.quat.mul(this.rotation,this.rotation,e),this.update()}face(e,t){f.quat.mul(this.rotation,Tl,Is(Al,e,this.location,t)),this.update()}moveToAndFace(e,t,i){f.vec3.copy(this.location,e),this.face(t,i)}reset(){f.vec3.set(this.location,0,0,0),f.quat.identity(this.rotation),this.update()}update(){const e=this.location,t=this.rotation,i=this.inverseRotation,s=this.viewMatrix,r=this.projectionMatrix,o=this.viewProjectionMatrix,a=this.vectors,l=this.billboardedVectors;this.isPerspective?f.mat4.perspective(r,this.fov,this.aspect,this.nearClipPlane,this.farClipPlane):f.mat4.ortho(r,this.leftClipPlane,this.rightClipPlane,this.bottomClipPlane,this.topClipPlane,this.nearClipPlane,this.farClipPlane),f.mat4.fromQuat(s,t),f.mat4.translate(s,s,f.vec3.negate(Lt,e)),f.mat4.mul(o,r,s),f.mat4.invert(this.inverseViewMatrix,s),f.mat4.invert(this.inverseViewProjectionMatrix,o),wl(this.planes,o),f.quat.conjugate(i,t),f.vec3.transformQuat(this.directionX,Vi,i),f.vec3.transformQuat(this.directionY,xs,i),f.vec3.transformQuat(this.directionZ,Ct,i);for(let c=0;c<7;c++)f.vec3.transformQuat(l[c],a[c],i)}cameraToWorld(e,t){return f.vec3.transformMat4(e,t,this.inverseViewMatrix)}worldToCamera(e,t){return f.vec3.transformMat4(e,t,this.viewMatrix)}worldToScreen(e,t,i){return f.vec3.transformMat4(Lt,t,this.viewProjectionMatrix),e[0]=Math.round((Lt[0]+1)/2*i[2]),e[1]=Math.round((Lt[1]+1)/2*i[3]),e}screenToWorldRay(e,t,i){const s=Lt,r=vl,o=yl,a=t[0],l=t[1],c=this.inverseViewProjectionMatrix;return Es(s,f.vec3.set(o,a,l,0),c,i),Es(r,f.vec3.set(o,a,l,1),c,i),e.set(s,0),e.set(r,3),e}};class El{left;right;bottom;top;plane=-1;instances=[];visible=!1;constructor(e,t,i,s){this.left=e,this.right=t,this.bottom=i,this.top=s}add(e){this.instances.push(e)}remove(e){const t=this.instances.indexOf(e);this.instances.splice(t,1)}clear(){this.instances.length=0}isVisible(e){return this.plane=ml(e.planes,this.left,this.right,this.bottom,this.top,this.plane),this.plane===-1}}class Sl{x;y;width;depth;cellWidth;cellDepth;columns;rows;cells=[];constructor(e,t,i,s,r,o){const a=i/r,l=s/o;this.x=e,this.y=t,this.width=i,this.depth=s,this.cellWidth=r,this.cellDepth=o,this.columns=a,this.rows=l;for(let c=0;c<l;c++)for(let d=0;d<a;d++){const h=e+d*r,u=h+r,p=t+c*o,g=p+o;this.cells[c*a+d]=new El(h,u,p,g)}}add(e){const t=this.cells,i=this.columns,s=e.left,r=e.right+1,o=e.bottom,a=e.top+1;if(s!==-1)for(let l=o;l<a;l++)for(let c=s;c<r;c++)t[l*i+c].add(e)}remove(e){const t=this.cells,i=this.columns,s=e.left,r=e.right+1,o=e.bottom,a=e.top+1;if(s!==-1){e.left=-1;for(let l=o;l<a;l++)for(let c=s;c<r;c++)t[l*i+c].remove(e)}}moved(e){const t=this.cellWidth,i=this.cellDepth,s=e.model.bounds,r=e.worldLocation[0]+s.x-this.x,o=e.worldLocation[1]+s.y-this.y,a=s.r,l=e.worldScale;let c=Math.floor((r-a*l[0])/t),d=Math.floor((r+a*l[0])/t),h=Math.floor((o-a*l[1])/i),u=Math.floor((o+a*l[1])/i);d<0||c>this.columns-1||u<0||h>this.rows-1?this.remove(e):(c=Math.max(c,0),d=Math.min(d,this.columns-1),h=Math.max(h,0),u=Math.min(u,this.rows-1),(c!==e.left||d!==e.right||h!==e.bottom||u!==e.top)&&(this.remove(e),e.left=c,e.right=d,e.bottom=h,e.top=u,this.add(e)))}clear(){for(const e of this.cells)e.clear()}}class Il{objects=[];alive=0;add(e){this.objects[this.alive++]=e}update(e){const t=this.objects;for(let i=0;i<this.alive;i++){const s=t[i];s.update(e*s.emitter.instance.timeScale),s.health<=0&&(this.alive-=1,s.emitter.kill(s),i!==this.alive&&(t[i]=t[this.alive],i-=1))}}}class _l{viewer;camera=new xl;grid=new Sl(-1e5,-1e5,2e5,2e5,2e5,2e5);visibleCells=0;visibleInstances=0;updatedParticles=0;audioEnabled=!1;audioContext=null;instances=[];emittedObjectUpdater=new Il;alpha=!1;color=f.vec3.create();viewport=f.vec4.create();lightPosition=f.vec3.fromValues(0,0,1e4);constructor(e){this.viewer=e;const t=e.canvas,i=t.width,s=t.height;this.viewport[2]=i,this.viewport[3]=s,this.camera.perspective(Math.PI/4,i/s,8,1e4)}async enableAudio(){return typeof AudioContext=="function"?(this.audioContext||(this.audioContext=new AudioContext),this.audioContext.state!=="suspended"&&await this.audioContext.resume(),this.audioEnabled=this.audioContext.state==="running",this.audioEnabled):!1}disableAudio(){this.audioContext&&this.audioContext.suspend(),this.audioEnabled=!1}addInstance(e){return e.scene!==this?(e.scene&&e.scene.removeInstance(e),e.scene=this,this.grid.moved(e),!0):!1}removeInstance(e){return e.scene===this?(this.grid.remove(e),e.scene=null,!0):!1}clear(){for(const e of this.grid.cells)for(const t of e.instances)t.scene=null;this.grid.clear()}detach(){return this.viewer?this.viewer.removeScene(this):!1}update(e){const t=this.camera;if(this.audioContext){const r=this.audioContext.listener,o=t.location,a=t.directionY,l=t.directionZ;r.positionX.value=-o[0],r.positionY.value=-o[1],r.positionZ.value=-o[2],r.forwardX.value=a[0],r.forwardY.value=a[1],r.forwardZ.value=a[2],r.upX.value=l[0],r.upY.value=l[1],r.upZ.value=l[2]}const i=this.viewer.frame,s=this.instances;this.visibleCells=0,this.visibleInstances=0;for(const r of this.grid.cells)if(r.isVisible(t)){this.visibleCells+=1;for(const o of r.instances)o.rendered&&o.updateFrame<i&&!o.parent&&(o.updateFrame=i,o.update(e))}s.length=this.visibleInstances,s.sort((r,o)=>r.depth-o.depth),this.emittedObjectUpdater.update(e),this.updatedParticles=this.emittedObjectUpdater.alive}renderInstance(e){this.instances[this.visibleInstances++]=e}startFrame(){const e=this.viewer.gl,t=this.viewport;if(e.viewport(t[0],t[1],t[2],t[3]),e.scissor(t[0],t[1],t[2],t[3]),!this.alpha){const i=this.color;e.depthMask(!0),e.clearColor(i[0],i[1],i[2],1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)}}renderOpaque(){const e=this.instances;for(let t=0,i=e.length;t<i;t++)e[t].renderOpaque()}renderTranslucent(){const e=this.instances;for(let t=e.length-1;t>=0;t--)e[t].renderTranslucent()}render(){this.startFrame(),this.renderOpaque(),this.renderTranslucent()}clearEmittedObjects(){for(const e of this.emittedObjectUpdater.objects)e.health=0}}class qi{viewer;fetchUrl;blockers=[];constructor(e){this.viewer=e.viewer,this.fetchUrl=e.fetchUrl}detach(){return this.viewer.unload(this)}}class Cl extends qi{data=null;constructor(e,t){super(t),this.data=e}}function Ll(n){return n instanceof ArrayBuffer&&(n=new Uint8Array(n)),n instanceof Uint8Array&&n[0]===137&&n[1]===80&&n[2]===78&&n[3]===71&&n[4]===13&&n[5]===10&&n[6]===26&&n[7]===10}function Bl(n){return n instanceof ArrayBuffer&&(n=new Uint8Array(n)),n instanceof Uint8Array&&n[0]===255&&n[1]===216&&n[n.length-2]===255&&n[n.length-1]===217}function Rl(n){return n instanceof ArrayBuffer&&(n=new Uint8Array(n)),n instanceof Uint8Array&&n[0]===71&&n[1]===73&&n[2]===70&&n[3]===56&&(n[4]===55||n[4]===57)&&n[5]===97}function Pl(n){return n instanceof ArrayBuffer&&(n=new Uint8Array(n)),n instanceof Uint8Array&&n[0]===82&&n[1]===73&&n[2]===70&&n[3]===70&&n[8]===87&&n[9]===69&&n[10]===66&&n[11]===80}class _s extends qi{pathSolver;constructor(e){super(e),this.pathSolver=e.pathSolver}}class ot extends _s{webglResource=null;width=0;height=0}function kl(n){return n instanceof ImageData||n instanceof HTMLImageElement||n instanceof HTMLCanvasElement||n instanceof HTMLVideoElement}function Ul(n){return Ll(n)?"image/png":Bl(n)?"image/jpeg":Rl(n)?"image/gif":Pl(n)?"image/webp":""}class Cs extends ot{constructor(e,t){super(t);const i=this.viewer.gl;this.webglResource=i.createTexture(),i.bindTexture(i.TEXTURE_2D,this.webglResource),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),xe(e.width)&&xe(e.height)?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR_MIPMAP_LINEAR),i.generateMipmap(i.TEXTURE_2D)):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE)),this.width=e.width,this.height=e.height}}var R=(n=>(n[n.None=0]="None",n[n.Diffuse=1]="Diffuse",n[n.NormalMap=2]="NormalMap",n[n.Occlusion=3]="Occlusion",n[n.Roughness=4]="Roughness",n[n.Metallic=5]="Metallic",n[n.TCFactor=6]="TCFactor",n[n.Emissive=7]="Emissive",n[n.TexCoords=8]="TexCoords",n[n.Normals=9]="Normals",n[n.Tangents=10]="Tangents",n))(R||{});class Fl extends _r.EventEmitter{canvas;gl;webgl;resources=[];resourceMap=new Map;promiseMap=new Map;handlers=new Set;scenes=[];frame=0;visibleCells=0;visibleInstances=0;updatedParticles=0;audioEnabled=!1;buffer;sharedCache=new Map;debugRenderMode=0;directLoadId=0;constructor(e,t){super();const i=new pl(e,t),s=i.gl;this.canvas=e,this.gl=s,this.webgl=i,this.buffer=i.createClientBuffer(),s.depthFunc(s.LEQUAL),s.enable(s.DEPTH_TEST),s.enable(s.SCISSOR_TEST)}enableAudio(){return typeof AudioContext=="function"?(this.audioEnabled=!0,!0):!1}addHandler(e,...t){if(e){const i=this.handlers;if(!i.has(e)){if(!e.isValidSource)return this.emit("error",{viewer:this,error:"Handler missing the isValidSource function",handler:e}),!1;if(e.load)try{e.load(this,...t)}catch(s){return this.emit("error",{viewer:this,error:"Handler failed to load",handler:e,reason:s}),!1}return i.add(e),!0}}return!1}addScene(){const e=new _l(this);return this.scenes.push(e),e}removeScene(e){const t=this.scenes,i=t.indexOf(e);return i!==-1?(t.splice(i,1),!0):!1}clear(){this.scenes.length=0}async load(e,t,i){let s,r="",o;if(t)try{s=t(e,i)}catch(a){this.emit("error",{viewer:this,error:"Path solver failed",src:e,reason:a,pathSolver:t,solverParams:i});return}else s=e;if(s){if(s instanceof Promise&&(s=await s),s instanceof qi)return s;if(typeof s=="string"&&!this.detectFormat(s)){if(r=s,o=this.promiseMap.get(r),o)return o;const a=this.resourceMap.get(r);if(a)return a;o=As(r,"arrayBuffer").then(l=>{if(l.ok)return l.data;this.emit("error",{viewer:this,error:`Failed to fetch a resource: ${l.error}`,fetchUrl:r,reason:l.data})})}else r=`__DIRECT_LOAD_${this.directLoadId++}`,o=Promise.resolve(s);return o=o.then(async a=>{if(a){if(a instanceof ArrayBuffer&&(a=new Uint8Array(a)),kl(a))return new Cs(a,{viewer:this,fetchUrl:r,pathSolver:t});if(a instanceof Uint8Array){const c=Ul(a);if(c.length)return new Cs(await ha(new Blob([a.buffer],{type:c})),{viewer:this,fetchUrl:r,pathSolver:t})}const l=this.detectFormat(a);if(l)try{const c=new l.resource(a,{viewer:this,fetchUrl:r,pathSolver:t});return await Promise.all(c.blockers),c.blockers.length=0,c}catch(c){this.emit("error",{viewer:this,error:"Failed to create a resource",fetchUrl:r,src:e,reason:c})}else this.emit("error",{viewer:this,error:"Source has no matching handler",fetchUrl:r,src:e})}}).then(a=>(this.promiseMap.delete(r),a&&(this.resourceMap.set(r,a),this.resources.push(a),this.emit("load",{viewer:this,fetchUrl:r,resource:a})),this.emit("loadend",{viewer:this,fetchUrl:r,resource:a}),this.checkLoadingStatus(),a)),this.promiseMap.set(r,o),this.emit("loadstart",{viewer:this,fetchUrl:r,promise:o}),o}}detectFormat(e){for(const t of this.handlers)if(t.isValidSource(e))return t}has(e){return this.resourceMap.has(e)}get(e){return this.resourceMap.get(e)}async loadGeneric(e,t,i){const s=this.promiseMap.get(e);if(s)return s;const r=this.resourceMap.get(e);if(r)return r;const o=As(e,t).then(async a=>{this.promiseMap.delete(e);let l;if(a.ok){let c=a.data;i&&(c=await i(c)),l=new Cl(c,{viewer:this,fetchUrl:e}),this.resourceMap.set(e,l),this.resources.push(l),this.emit("load",{viewer:this,fetchUrl:e,resource:l})}else this.emit("error",{viewer:this,error:"Failed to fetch a generic resource",fetchUrl:e});return this.emit("loadend",{viewer:this,fetchUrl:e,resource:l}),this.checkLoadingStatus(),l});return this.promiseMap.set(e,o),this.emit("loadstart",{viewer:this,fetchUrl:e}),o}unload(e){const t=e.fetchUrl;t!==""&&this.resourceMap.delete(t);const i=this.resources,s=i.indexOf(e);return s!==-1?(i.splice(s,1),!0):!1}promise(){const e=Promise.resolve(void 0),t=`${performance.now()}`;return this.promiseMap.set(t,e),()=>{this.promiseMap.delete(t),this.checkLoadingStatus()}}checkLoadingStatus(){this.promiseMap.size===0&&setTimeout(()=>this.emit("idle"),0)}whenAllLoaded(e){const t=new Promise(i=>{this.promiseMap.size===0?i(this):this.once("idle",()=>i(this))});if(e)t.then(()=>e(this));else return t}toBlob(e){const t=new Promise(i=>this.canvas.toBlob(s=>i(s)));if(e)t.then(i=>e(i));else return t}updateAndRender(e=1e3/60){this.update(e),this.startFrame(),this.render()}update(e=1e3/60){e*=.001,this.frame+=1,this.visibleCells=0,this.visibleInstances=0,this.updatedParticles=0;for(const t of this.scenes)t.update(e),this.visibleCells+=t.visibleCells,this.visibleInstances+=t.visibleInstances,this.updatedParticles+=t.updatedParticles}startFrame(){const e=this.gl;e.depthMask(!0),e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)}render(){for(const e of this.scenes)e.render()}clearEmittedObjects(){for(const e of this.scenes)e.clearEmittedObjects()}}let Ki;typeof OfflineAudioContext=="function"&&(Ki=new OfflineAudioContext(1,1,48e3));async function Nl(n){if(Ki)return Ki.decodeAudioData(n)}class Ml{rows=[];load(e){if(!e.startsWith("ID"))throw new Error("WrongMagicNumber");const t=this.rows;let i=0,s=0;for(const r of e.split(`
`))if(r[0]!=="B")for(const o of r.split(";")){const a=o[0],l=o.substring(1).trim();let c;a==="X"?i=parseInt(l,10)-1:a==="Y"?s=parseInt(l,10)-1:a==="K"&&(t[s]||(t[s]=[]),l[0]==='"'?c=l.slice(1,-1):c=l,t[s][i]=c)}}save(){const e=this.rows,t=e.length,i=[];let s=0;for(let r=0;r<t;r++){const o=e[r],a=o.length;a>s&&(s=a);let l=!0;for(let c=0;c<a;c++){const d=o[c];if(d!==void 0){let h;typeof d=="string"?h=`"${d}"`:typeof d=="boolean"?d?h="TRUE":h="FALSE":h=`${d}`,l?(l=!1,i.push(`C;X${c+1};Y${r+1};K${h}`)):i.push(`C;X${c+1};K${h}`)}}}return`ID;P\r
B;X${s};Y${t}\r
${i.join(`\r
`)}\r
E`}}class Ol{properties=new Map;sections=new Map;load(e){let t=this.properties;const i=this.sections;for(const s of e.split(`\r
`))if(s.length&&!s.startsWith("//")&&!s.startsWith(";")){let r=s.match(/^\[(.+?)\]/);if(r){const o=r[1].trim();t=i.get(o),t||(t=new Map,i.set(o,t))}else if(r=s.match(/^(.+?)=(.*?)$/),r){let o=r[2];o[0]==='"'&&(o=o.slice(1,-1)),t.set(r[1],o)}}}save(){const e=[];for(const[t,i]of this.properties)e.push(`${t}=${i}`);for(const[t,i]of this.sections){e.push(`[${t}]`);for(const[s,r]of i)e.push(`${s}=${r}`)}return e.join(`\r
`)}getSection(e){return this.sections.get(e)}}class Ls{map={};set(e,t){typeof t!="string"&&(t=t.toString()),this.map[e.toLowerCase()]=t}string(e){return this.map[e.toLowerCase()]}number(e){const t=this.string(e);return t?parseFloat(t):0}}class Dl{map={};constructor(e){e&&this.load(e)}load(e){if(e.startsWith("ID;")){const t=new Ml;t.load(e);const i=t.rows,s=i[0],r=this.map;for(let o=1,a=i.length;o<a;o++){const l=i[o];if(l){const c=l[0];if(c&&c!=="_"){r[c]||(r[c]=new Ls);const d=r[c];for(let h=0,u=s.length;h<u;h++){let p=s[h];p===void 0&&(p=`column${h}`),d.map[p.toLowerCase()]=l[h]}}}}}else{const t=new Ol;t.load(e);const i=t.sections,s=this.map;for(const[r,o]of i.entries()){s[r]||(s[r]=new Ls);const a=s[r];for(const[l,c]of o)a.map[l.toLowerCase()]=c}}}getRow(e){return this.map[e]}getProperty(e,t){return this.map[e].map[t]}setRow(e,t){this.map[e]=t}findRow(e,t){for(const i of Object.values(this.map))if(i.string(e)===t)return i}}class Bs{x=0;y=0;z=0;r=0;fromExtents(e,t){const i=e[0],s=e[1],r=e[2],o=t[0]-i,a=t[1]-s,l=t[2]-r;this.x=i+o/2,this.y=s+a/2,this.z=r+l/2,this.r=Math.max(0,Math.max(o,a,l)/2)}}class Vl{name;interval;nonLooping;rarity;bounds;constructor(e){this.name=e.name,this.interval=e.interval,this.nonLooping=e.nonLooping,this.rarity=e.rarity,this.bounds=new Bs;const t=e.extent;this.bounds.fromExtents(t.min,t.max)}}class Rs extends _s{bounds=new Bs}class Ps{sd;start;end;frames=[];values=[];inTans=[];outTans=[];constant=!1;constructor(e,t,i,s,r){this.sd=e,this.start=t,this.end=i;const o=e.interpolationType,a=s.frames,l=s.values,c=s.inTans,d=s.outTans,h=e.defval;r&&a[0]>i&&(this.frames[0]=a[0],this.values[0]=l[0]);for(let p=0,g=a.length;p<g;p++){const m=a[p];m>=t&&m<=i&&(this.frames.push(m),this.values.push(l[p]),o>1&&(this.inTans.push(c[p]),this.outTans.push(d[p])))}const u=this.frames.length;if(u===0)this.constant=!0,this.frames[0]=t,this.values[0]=h;else if(u===1)this.constant=!0;else{const p=this.values[0];this.constant=this.values.every(g=>p.every((m,w)=>m===g[w]))}}getValue(e,t){const s=this.frames.length;if(this.constant||t<this.start)return this.sd.copy(e,this.values[0]),-1;{let r=-1,o=-1;const a=s-1;if(t<this.frames[0]||t>=this.frames[a])r=a,o=0;else for(let u=1;u<s;u++)if(this.frames[u]>t){r=u-1,o=u;break}let l=this.frames[r];const c=this.frames[o];let d=c-l;d<0&&(d+=this.end-this.start,t<l&&(l=c));const h=d==0?0:(t-l)/d;return this.sd.interpolate(e,this.values,this.inTans,this.outTans,r,o,h),r}}}const Gl={KLAV:W.DontInterp,KATV:W.DontInterp,KPEV:W.DontInterp,KP2V:W.DontInterp,KRVS:W.DontInterp},H=new Float32Array(1),$l=new Uint32Array(1),at=new Float32Array([1]),Bt=f.vec3.create(),ks=f.quat.create(),Us=f.vec3.fromValues(1,1,1),Fs=at,li=Bt,ql={KMTF:H,KMTA:Fs,KTAT:Bt,KTAR:ks,KTAS:Us,KGAO:Fs,KGAC:li,KLAS:H,KLAE:H,KLAC:li,KLAI:H,KLBI:H,KLBC:li,KLAV:at,KATV:at,KPEE:H,KPEG:H,KPLN:H,KPLT:H,KPEL:H,KPES:H,KPEV:at,KP2S:H,KP2R:H,KP2L:H,KP2G:H,KP2E:H,KP2N:H,KP2W:H,KP2V:at,KRHA:H,KRHB:H,KRAL:new Float32Array([0]),KRCO:li,KRTX:H,KRVS:at,KCTR:Bt,KTTR:Bt,KCRL:$l,KGTR:Bt,KGRT:ks,KGSC:Us};class ji{defval;model;name;globalSequence=null;sequences=[];interpolationType;constructor(e,t){const i=e.globalSequences,s=t.globalSequenceId,r=Gl[t.name];if(this.model=e,this.name=t.name,this.defval=ql[t.name],this.interpolationType=r!==void 0?r:t.interpolationType,s!==-1&&i)this.globalSequence=new Ps(this,0,i[s],t,!0);else for(const o of e.sequences){const a=o.interval;this.sequences.push(new Ps(this,a[0],a[1],t,!1))}}getValue(e,t,i,s){return this.globalSequence?this.globalSequence.getValue(e,s%this.globalSequence.end):this.sequences[t].getValue(e,i)}isVariant(e){return this.globalSequence?!this.globalSequence.constant:!this.sequences[e].constant}}class Kl extends ji{copy(e,t){e[0]=t[0]}interpolate(e,t,i,s,r,o,a){const l=this.interpolationType,c=t[r][0];l===W.DontInterp?e[0]=c:l===W.Linear?e[0]=Ur(c,t[o][0],a):l===W.Hermite?e[0]=Fr(c,s[r][0],i[o][0],t[o][0],a):l===W.Bezier&&(e[0]=Nr(c,s[r][0],i[o][0],t[o][0],a))}}class jl extends ji{copy(e,t){f.vec3.copy(e,t)}interpolate(e,t,i,s,r,o,a){const l=this.interpolationType;l===W.DontInterp?f.vec3.copy(e,t[r]):l===W.Linear?f.vec3.lerp(e,t[r],t[o],a):l===W.Hermite?f.vec3.hermite(e,t[r],s[r],i[o],t[o],a):l===W.Bezier&&f.vec3.bezier(e,t[r],s[r],i[o],t[o],a)}}class Hl extends ji{copy(e,t){f.quat.copy(e,t)}interpolate(e,t,i,s,r,o,a){const l=this.interpolationType;l===W.DontInterp?f.quat.copy(e,t[r]):l===W.Linear?f.quat.slerp(e,t[r],t[o],a):(l===W.Hermite||l===W.Bezier)&&f.quat.sqlerp(e,t[r],s[r],i[o],t[o],a)}}function zl(n,e){return e instanceof qt||e instanceof k?new Kl(n,e):e instanceof he?new jl(n,e):new Hl(n,e)}class Rt{model;animations=new Map;variants={};constructor(e,t){this.model=e;for(const i of t.animations)this.animations.set(i.name,zl(e,i))}getScalarValue(e,t,i,s,r,o){if(i!==-1){const a=this.animations.get(t);if(a)return a.getValue(e,i,s,r)}return e[0]=o,-1}getVectorValue(e,t,i,s,r,o){if(i!==-1){const a=this.animations.get(t);if(a)return a.getValue(e,i,s,r)}return e[0]=o[0],e[1]=o[1],e[2]=o[2],-1}getQuatValue(e,t,i,s,r,o){if(i!==-1){const a=this.animations.get(t);if(a)return a.getValue(e,i,s,r)}return e[0]=o[0],e[1]=o[1],e[2]=o[2],e[3]=o[3],-1}addVariants(e,t){const i=this.animations.get(e),s=this.model.sequences.length,r=new Uint8Array(s);if(i)for(let o=0;o<s;o++)i.isVariant(o)&&(r[o]=1);this.variants[t]=r}addVariantIntersection(e,t){const i=this.model.sequences.length,s=new Uint8Array(i);for(let r=0;r<i;r++)for(const o of e)this.variants[o][r]&&(s[r]=1);this.variants[t]=s}}class Xl extends Rt{constructor(e,t){super(e,t),this.addVariants("KTAT","translation"),this.addVariants("KTAR","rotation"),this.addVariants("KTAS","scale")}getTranslation(e,t,i,s){return this.getVectorValue(e,"KTAT",t,i,s,st)}getRotation(e,t,i,s){return this.getQuatValue(e,"KTAR",t,i,s,$i)}getScale(e,t,i,s){return this.getVectorValue(e,"KTAS",t,i,s,Gi)}}function Wl(n,e){return n===de.Blend?[e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA]:n===de.Additive?[e.SRC_ALPHA,e.ONE]:n===de.AddAlpha?[e.SRC_ALPHA,e.ONE]:n===de.Modulate?[e.ZERO,e.SRC_COLOR]:n===de.Modulate2x?[e.DST_COLOR,e.SRC_COLOR]:[0,0]}function Ns(n,e){return n===Me.Blend?[e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA]:n===Me.Additive?[e.SRC_ALPHA,e.ONE]:n===Me.Modulate?[e.ZERO,e.SRC_COLOR]:n===Me.Modulate2x?[e.DST_COLOR,e.SRC_COLOR]:n===Me.AlphaKey?[e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA]:[0,0]}class Yl extends Rt{index;priorityPlane;filterMode;textureId=0;coordId;alpha;unshaded;sphereEnvironmentMap;twoSided;unfogged;noDepthTest;noDepthSet;depthMaskValue;blendSrc=0;blendDst=0;blended=!1;textureAnimation=null;constructor(e,t,i,s){super(e,t);let r=t.filterMode;const o=t.textureAnimationId,a=e.viewer.gl;this.index=i,this.priorityPlane=s,r>de.Modulate2x&&(r=de.Blend),this.filterMode=r,t.textureId!==-1&&(this.textureId=t.textureId),this.coordId=t.coordId,this.alpha=t.alpha;const l=t.flags;if(this.unshaded=l&Le.Unshaded,this.sphereEnvironmentMap=l&Le.SphereEnvMap,this.twoSided=l&Le.TwoSided,this.unfogged=l&Le.Unfogged,this.noDepthTest=l&Le.NoDepthTest,this.noDepthSet=l&Le.NoDepthSet,this.depthMaskValue=r===de.None||r===de.Transparent,r>de.Transparent&&(this.blended=!0,[this.blendSrc,this.blendDst]=Wl(r,a)),o!==-1){const c=e.textureAnimations[o];c&&(this.textureAnimation=c)}this.addVariants("KMTA","alpha"),this.addVariants("KMTF","textureId")}bind(e){const t=this.model.viewer.gl;t.uniform1f(e.uniforms.u_filterMode,this.filterMode),this.blended?(t.enable(t.BLEND),t.blendFunc(this.blendSrc,this.blendDst)):t.disable(t.BLEND),this.twoSided?t.disable(t.CULL_FACE):t.enable(t.CULL_FACE),this.noDepthTest?t.disable(t.DEPTH_TEST):t.enable(t.DEPTH_TEST),this.noDepthSet?t.depthMask(!1):t.depthMask(this.depthMaskValue)}getAlpha(e,t,i,s){return this.getScalarValue(e,"KMTA",t,i,s,this.alpha)}getTextureId(e,t,i,s){return this.getScalarValue(e,"KMTF",t,i,s,this.textureId)}}class Zl{model;shader;layers;constructor(e,t,i){this.model=e,this.shader=t,this.layers=i}}class Ql extends Rt{alpha;color;geosetId;constructor(e,t){super(e,t);const i=t.color;this.alpha=t.alpha,this.color=f.vec3.fromValues(i[2],i[1],i[0]),this.geosetId=t.geosetId,this.addVariants("KGAO","alpha"),this.addVariants("KGAC","color")}getAlpha(e,t,i,s){return this.getScalarValue(e,"KGAO",t,i,s,this.alpha)}getColor(e,t,i,s){return this.getVectorValue(e,"KGAC",t,i,s,this.color)}}const Ms={1:"TeamColor/TeamColor00",2:"TeamGlow/TeamGlow00",11:"Cliff/Cliff0",21:"",31:"LordaeronTree/LordaeronSummerTree",32:"AshenvaleTree/AshenTree",33:"BarrensTree/BarrensTree",34:"NorthrendTree/NorthTree",35:"Mushroom/MushroomTree",36:"RuinsTree/RuinsTree",37:"OutlandMushroomTree/MushroomTree"};class Ee extends Rt{index;name;objectId;parentId;pivot;dontInheritTranslation;dontInheritRotation;dontInheritScaling;billboarded;billboardedX;billboardedY;billboardedZ;cameraAnchored;anyBillboarding;constructor(e,t,i){super(e,t),this.index=i,this.name=t.name,this.objectId=t.objectId,this.parentId=t.parentId,this.pivot=e.pivotPoints[t.objectId]||f.vec3.create();const s=t.flags;this.dontInheritTranslation=(s&Be.DontInheritTranslation)>0,this.dontInheritRotation=(s&Be.DontInheritRotation)>0,this.dontInheritScaling=(s&Be.DontInheritScaling)>0,this.billboarded=(s&Be.Billboarded)>0,this.billboardedX=(s&Be.BillboardedLockX)>0,this.billboardedY=(s&Be.BillboardedLockY)>0,this.billboardedZ=(s&Be.BillboardedLockZ)>0,this.cameraAnchored=(s&Be.CameraAnchored)>0,this.anyBillboarding=this.billboarded||this.billboardedX||this.billboardedY||this.billboardedZ,t.objectId===t.parentId&&(this.parentId=-1),this.addVariants("KGTR","translation"),this.addVariants("KGRT","rotation"),this.addVariants("KGSC","scale"),this.addVariantIntersection(["translation","rotation","scale"],"generic")}getVisibility(e,t,i,s){return e[0]=1,-1}getTranslation(e,t,i,s){return this.getVectorValue(e,"KGTR",t,i,s,st)}getRotation(e,t,i,s){return this.getQuatValue(e,"KGRT",t,i,s,$i)}getScale(e,t,i,s){return this.getVectorValue(e,"KGSC",t,i,s,Gi)}}class Jl extends Ee{geosetAnimation;constructor(e,t,i){super(e,t,i),this.geosetAnimation=e.geosetAnimations[t.geosetAnimationId]}getVisibility(e,t,i,s){return this.geosetAnimation?this.geosetAnimation.getAlpha(e,t,i,s):(e[0]=1,-1)}}class ec extends Ee{type;attenuation;color;intensity;ambientColor;ambientIntensity;constructor(e,t,i){super(e,t,i),this.type=t.type,this.attenuation=t.attenuation,this.color=t.color,this.intensity=t.intensity,this.ambientColor=t.ambientColor,this.ambientIntensity=t.ambientIntensity}getAttenuationStart(e,t,i,s){return this.getScalarValue(e,"KLAS",t,i,s,this.attenuation[0])}getAttenuationEnd(e,t,i,s){return this.getScalarValue(e,"KLAE",t,i,s,this.attenuation[1])}getIntensity(e,t,i,s){return this.getScalarValue(e,"KLAI",t,i,s,this.intensity)}getColor(e,t,i,s){return this.getVectorValue(e,"KLAC",t,i,s,this.color)}getAmbientIntensity(e,t,i,s){return this.getScalarValue(e,"KLBI",t,i,s,this.ambientIntensity)}getAmbientColor(e,t,i,s){return this.getVectorValue(e,"KLBC",t,i,s,this.ambientColor)}}class tc extends Ee{}class ic extends Ee{path;attachmentId;internalModel=null;constructor(e,t,i){super(e,t,i);const s=t.path.replace(/\\/g,"/").toLowerCase().replace(".mdl",".mdx");if(this.path=s,this.attachmentId=t.attachmentId,s!==""&&s.indexOf(".mdx")!=-1){const r=e.viewer.load(s,e.pathSolver,e.solverParams);r.then(o=>{o&&(this.internalModel=o)}),e.blockers.push(r)}}getVisibility(e,t,i,s){return this.getScalarValue(e,"KATV",t,i,s,1)}}class nc extends Ee{internalModel=null;speed;latitude;longitude;lifeSpan;gravity;emissionRate;ok=!1;constructor(e,t,i){super(e,t,i),this.speed=t.speed,this.latitude=t.latitude,this.longitude=t.longitude,this.lifeSpan=t.lifeSpan,this.gravity=t.gravity,this.emissionRate=t.emissionRate,e.viewer.load(t.path.replace(/\\/g,"/").toLowerCase().replace(".mdl",".mdx"),e.pathSolver,e.solverParams).then(s=>{s&&(this.internalModel=s,this.ok=!0)})}getSpeed(e,t,i,s){return this.getScalarValue(e,"KPES",t,i,s,this.speed)}getLatitude(e,t,i,s){return this.getScalarValue(e,"KPLTV",t,i,s,this.latitude)}getLongitude(e,t,i,s){return this.getScalarValue(e,"KPLN",t,i,s,this.longitude)}getLifeSpan(e,t,i,s){return this.getScalarValue(e,"KPEL",t,i,s,this.lifeSpan)}getGravity(e,t,i,s){return this.getScalarValue(e,"KPEG",t,i,s,this.gravity)}getEmissionRate(e,t,i,s){return this.getScalarValue(e,"KPEE",t,i,s,this.emissionRate)}getVisibility(e,t,i,s){return this.getScalarValue(e,"KPEV",t,i,s,1)}}const sc=f.vec3.create(),rc=f.vec3.create(),oc=f.vec3.create(),be=60,Hi=be>>2,Os=0,ac=12,lc=24,cc=36,Ds=48,Vs=52,Gs=56,zi=57,Xi=Os>>2,$s=Ds>>2,hc=zi,qs=0,Wi=1,Ks=2,dc=3,js=1e3,Yi=1e4,Hs=2;function fc(n,e){const t=n.instance,i=n.objects,s=e.byteView,r=e.floatView,o=n.emitterObject,a=o.modelSpace,l=o.tailLength,c=n.node,d=t.teamColor;let h=0;for(const u of i){const p=h*be,g=h*Hi,m=g+Xi;let w=u.location;const b=u.scale,v=u.tail;if(v===Qe.Head)a&&(w=f.vec3.transformMat4(sc,w,c.worldMatrix)),r[m+0]=w[0],r[m+1]=w[1],r[m+2]=w[2],r[m+3]=u.facing;else{const _=u.velocity;let x=rc,T=w;x[0]=T[0]-l*_[0],x[1]=T[1]-l*_[1],x[2]=T[2]-l*_[2],a&&(x=f.vec3.transformMat4(x,x,c.worldMatrix),T=f.vec3.transformMat4(oc,T,c.worldMatrix)),r[m+0]=x[0],r[m+1]=x[1],r[m+2]=x[2],r[m+3]=T[0],r[m+4]=T[1],r[m+5]=T[2]}r[m+6]=b[0],r[m+7]=b[0],r[m+8]=b[0],r[g+$s]=u.health,s[p+Gs]=v,s[p+hc]=d,h+=1}}function uc(n,e){const t=n.instance,i=t.textureOverrides,r=t.scene.camera,o=n.emitterObject,a=o.model,l=a.viewer,c=l.gl,d=l.sharedCache.get("mdx"),h=e.uniforms,u=o.colors,p=o.intervals,g=o.replaceableId;let m,w=o.internalTexture;c.blendFunc(o.blendSrc,o.blendDst),c.uniform1f(h.u_filterMode,o.filterMode),o.internalTexture?w=o.internalTexture:g===1?w=d.teamColors[t.teamColor]:g===2?w=d.teamGlows[t.teamColor]:w=a.textures[o.textureId];let b=i.get(js+o.index);b||(g===0&&(b=i.get(o.textureId)),b||(b=w.texture)),l.webgl.bindTextureAndWrap(b,0,w.wrapS,w.wrapT),o.xYQuad?m=r.vectors:m=r.billboardedVectors,c.uniform1f(h.u_lifeSpan,o.lifeSpan),c.uniform1f(h.u_timeMiddle,o.timeMiddle),c.uniform1f(h.u_columns,o.columns),c.uniform1f(h.u_rows,o.rows),c.uniform1f(h.u_teamColored,o.teamColored),c.uniform3fv(h["u_intervals[0]"],p[0]),c.uniform3fv(h["u_intervals[1]"],p[1]),c.uniform3fv(h["u_intervals[2]"],p[2]),c.uniform3fv(h["u_intervals[3]"],p[3]),c.uniform4fv(h["u_colors[0]"],u[0]),c.uniform4fv(h["u_colors[1]"],u[1]),c.uniform4fv(h["u_colors[2]"],u[2]),c.uniform3fv(h.u_scaling,o.scaling),o.head&&(c.uniform3fv(h["u_vertices[0]"],m[0]),c.uniform3fv(h["u_vertices[1]"],m[1]),c.uniform3fv(h["u_vertices[2]"],m[2]),c.uniform3fv(h["u_vertices[3]"],m[3])),o.tail&&c.uniform3fv(h.u_cameraZ,r.directionZ)}function pc(n,e){let t=n.first;const i=e.byteView,s=e.floatView,o=n.emitterObject.columns,l=1/(n.alive-1);let c=0;for(;t.next;){const d=t.next.vertices,h=c*be,p=c*Hi+Xi,g=h+Vs,m=h+zi,w=(t.slot%o+(1-c*l-l))/o,b=t.slot/o,v=w+l,_=t.vertices,x=t.color;s[p+0]=_[0],s[p+1]=_[1],s[p+2]=_[2],s[p+3]=_[3],s[p+4]=_[4],s[p+5]=_[5],s[p+6]=d[3],s[p+7]=d[4],s[p+8]=d[5],s[p+9]=d[0],s[p+10]=d[1],s[p+11]=d[2],i[g+0]=x[0],i[g+1]=x[1],i[g+2]=x[2],i[g+3]=x[3],i[m+0]=w*255,i[m+1]=v*255,i[m+2]=b*255,t=t.next,c+=1}}function gc(n,e){const t=n.instance.textureOverrides,i=n.emitterObject,s=i.layer,r=i.model,o=r.viewer.gl,a=e.uniforms,l=r.textures[s.textureId],c=t.get(s.textureId)||l.texture;s.bind(e),o.uniform1f(a.u_filterMode,s.filterMode),r.viewer.webgl.bindTextureAndWrap(c,0,l.wrapS,l.wrapT),o.uniform1f(a.u_columns,i.columns),o.uniform1f(a.u_rows,i.rows)}function zs(n,e){const t=n.objects,i=e.floatView;let s=0;for(const r of t){const o=s*Hi,a=o+Xi,l=r.vertices;i[a+0]=l[0],i[a+1]=l[1],i[a+2]=l[2],i[a+3]=l[3],i[a+4]=l[4],i[a+5]=l[5],i[a+6]=l[6],i[a+7]=l[7],i[a+8]=l[8],i[a+9]=l[9],i[a+10]=l[10],i[a+11]=l[11],i[o+$s]=r.health,s+=1}}function mc(n,e){const t=n.instance.textureOverrides,i=n.emitterObject,s=i.intervalTimes,r=i.intervals,o=i.colors,a=i.model,l=a.viewer.gl,c=e.uniforms,d=i.internalTexture,h=t.get(Yi+i.index)||d.texture;l.blendFunc(i.blendSrc,i.blendDst),a.viewer.webgl.bindTextureAndWrap(h,0,d.wrapS,d.wrapT),l.uniform1f(c.u_lifeSpan,i.lifeSpan),l.uniform1f(c.u_columns,i.columns),l.uniform1f(c.u_rows,i.rows),l.uniform3f(c.u_intervalTimes,s[0],s[1],0),l.uniform3fv(c["u_intervals[0]"],r[0]),l.uniform3fv(c["u_intervals[1]"],r[1]),l.uniform4fv(c["u_colors[0]"],o[0]),l.uniform4fv(c["u_colors[1]"],o[1]),l.uniform4fv(c["u_colors[2]"],o[2])}function bc(n,e){const t=n.instance.textureOverrides,i=n.emitterObject,s=i.intervalTimes,r=i.colors,o=i.model,l=o.viewer.gl,c=e.uniforms,d=i.internalTexture,h=t.get(Yi+i.index)||d.texture;l.blendFunc(i.blendSrc,i.blendDst),o.viewer.webgl.bindTextureAndWrap(h,0,d.wrapS,d.wrapT),l.uniform1f(c.u_lifeSpan,i.lifeSpan),l.uniform1f(c.u_columns,i.columns),l.uniform1f(c.u_rows,i.rows),l.uniform3fv(c.u_intervalTimes,s),l.uniform4fv(c["u_colors[0]"],r[0]),l.uniform4fv(c["u_colors[1]"],r[1]),l.uniform4fv(c["u_colors[2]"],r[2])}function wc(n,e){let t=n.alive;const s=n.emitterObject.geometryEmitterType;if(s===Wi&&(t-=1),t>0){const r=n.instance.model.viewer,o=r.buffer,a=r.gl,l=r.webgl.extensions.ANGLE_instanced_arrays,c=t*be,d=e.attribs;o.reserve(c),s===qs?(fc(n,o),uc(n,e)):s===Wi?(pc(n,o),gc(n,e)):s===Ks?(zs(n,o),mc(n,e)):(zs(n,o),bc(n,e)),o.bindAndUpdate(c),a.uniform1i(e.uniforms.u_emitter,s),a.vertexAttribPointer(d.a_p0,3,a.FLOAT,!1,be,Os),a.vertexAttribPointer(d.a_p1,3,a.FLOAT,!1,be,ac),a.vertexAttribPointer(d.a_p2,3,a.FLOAT,!1,be,lc),a.vertexAttribPointer(d.a_p3,3,a.FLOAT,!1,be,cc),a.vertexAttribPointer(d.a_health,1,a.FLOAT,!1,be,Ds),a.vertexAttribPointer(d.a_color,4,a.UNSIGNED_BYTE,!0,be,Vs),a.vertexAttribPointer(d.a_tail,1,a.UNSIGNED_BYTE,!1,be,Gs),a.vertexAttribPointer(d.a_leftRightTop,3,a.UNSIGNED_BYTE,!1,be,zi),l.drawArraysInstancedANGLE(a.TRIANGLES,0,6,t)}}class Pt{texture=null;replaceableId;wrapS=33071;wrapT=33071;constructor(e,t){this.replaceableId=e,t&Ke.WrapWidth&&(this.wrapS=10497),t&Ke.WrapHeight&&(this.wrapT=10497)}}class Xs extends Ee{geometryEmitterType=qs;width;length;speed;latitude;gravity;emissionRate;squirt;lifeSpan;variation;tailLength;timeMiddle;columns;rows;teamColored=0;internalTexture=null;replaceableId;textureId;head;tail;cellWidth;cellHeight;colors=[];scaling;intervals;filterMode;blendSrc;blendDst;priorityPlane;lineEmitter;unfogged;modelSpace;xYQuad;ok=!0;constructor(e,t,i){super(e,t,i),this.width=t.width,this.length=t.length,this.speed=t.speed,this.latitude=t.latitude,this.gravity=t.gravity,this.emissionRate=t.emissionRate*Hs,this.squirt=t.squirt,this.lifeSpan=t.lifeSpan,this.variation=t.variation,this.tailLength=t.tailLength,this.timeMiddle=t.timeMiddle;const s=t.flags;this.lineEmitter=s&Ze.LineEmitter,this.unfogged=s&Ze.Unfogged,this.modelSpace=s&Ze.ModelSpace,this.xYQuad=s&Ze.XYQuad;const r=t.replaceableId;if(this.columns=t.columns,this.rows=t.rows,r===1||r===2)this.teamColored=1;else if(r>2){const u=e.reforged?".dds":".blp";this.internalTexture=new Pt(r,Ke.RepeatBoth),e.viewer.load(`ReplaceableTextures\\${Ms[r]}${u}`,e.pathSolver,e.solverParams).then(p=>{p&&(this.internalTexture.texture=p)})}this.replaceableId=t.replaceableId,this.textureId=t.textureId;const o=t.headOrTail;this.head=o===Qe.Head||o===Qe.Both,this.tail=o===Qe.Tail||o===Qe.Both,this.cellWidth=1/t.columns,this.cellHeight=1/t.rows;const a=t.segmentColors,l=t.segmentAlphas;for(let u=0;u<3;u++){const p=a[u];this.colors[u]=new Float32Array([p[0],p[1],p[2],l[u]/255])}this.scaling=t.segmentScaling;const c=t.headIntervals,d=t.tailIntervals;this.intervals=[new Float32Array(c[0]),new Float32Array(c[1]),new Float32Array(d[0]),new Float32Array(d[1])];const h=Ns(t.filterMode,this.model.viewer.gl);this.filterMode=t.filterMode,this.blendSrc=h[0],this.blendDst=h[1],this.priorityPlane=t.priorityPlane}getWidth(e,t,i,s){return this.getScalarValue(e,"KP2N",t,i,s,this.width)}getLength(e,t,i,s){return this.getScalarValue(e,"KP2W",t,i,s,this.length)}getSpeed(e,t,i,s){return this.getScalarValue(e,"KP2S",t,i,s,this.speed)}getLatitude(e,t,i,s){return this.getScalarValue(e,"KP2L",t,i,s,this.latitude)}getGravity(e,t,i,s){return this.getScalarValue(e,"KP2G",t,i,s,this.gravity)}getEmissionRate(e,t,i,s){return this.getScalarValue(e,"KP2E",t,i,s,this.emissionRate)}getVariation(e,t,i,s){return this.getScalarValue(e,"KP2R",t,i,s,this.variation)}getVisibility(e,t,i,s){return this.getScalarValue(e,"KP2V",t,i,s,1)}}class Ws extends Ee{geometryEmitterType=Wi;layer;heightAbove;heightBelow;alpha;color;lifeSpan;textureSlot;emissionRate;gravity;columns;rows;ok=!0;constructor(e,t,i){super(e,t,i),this.layer=e.materials[t.materialId].layers[0],this.heightAbove=t.heightAbove,this.heightBelow=t.heightBelow,this.alpha=t.alpha,this.color=t.color,this.lifeSpan=t.lifeSpan,this.textureSlot=t.textureSlot,this.emissionRate=t.emissionRate*Hs,this.gravity=t.gravity,this.columns=t.columns,this.rows=t.rows}getHeightBelow(e,t,i,s){return this.getScalarValue(e,"KRHB",t,i,s,this.heightBelow)}getHeightAbove(e,t,i,s){return this.getScalarValue(e,"KRHA",t,i,s,this.heightAbove)}getTextureSlot(e,t,i,s){return this.getScalarValue(e,"KRTX",t,i,s,0)}getColor(e,t,i,s){return this.getVectorValue(e,"KRCO",t,i,s,this.color)}getAlpha(e,t,i,s){return this.getScalarValue(e,"KRAL",t,i,s,this.alpha)}getVisibility(e,t,i,s){const r=this.getAlpha(e,t,i,s);return e[0]===0?r:this.getScalarValue(e,"KRVS",t,i,s,1)}}class vc extends Rt{name;position;fieldOfView;farClippingPlane;nearClippingPlane;targetPosition;constructor(e,t){super(e,t),this.name=t.name,this.position=t.position,this.fieldOfView=t.fieldOfView,this.farClippingPlane=t.farClippingPlane,this.nearClippingPlane=t.nearClippingPlane,this.targetPosition=t.targetPosition}getTranslation(e,t,i,s){return this.getVectorValue(e,"KCTR",t,i,s,st)}getTargetTranslation(e,t,i,s){return this.getVectorValue(e,"KTTR",t,i,s,st)}getRotation(e,t,i,s){return this.getScalarValue(e,"KCRL",t,i,s,0)}}class yc extends Ee{geometryEmitterType=-1;type;id;tracks;globalSequence=-1;defval=new Uint32Array(1);internalModel=null;internalTexture=null;colors=[];intervalTimes=new Float32Array(3);scale=0;columns=0;rows=0;lifeSpan=0;blendSrc=0;blendDst=0;intervals=[];distanceCutoff=0;maxDistance=0;minDistance=0;pitch=0;pitchVariance=0;volume=0;decodedBuffers=[];ok=!1;constructor(e,t,i){super(e,t,i);const s=e.viewer,r=t.name;let o=r.substring(0,3);const a=r.substring(4);o==="FPT"&&(o="SPL"),o==="SPL"?this.geometryEmitterType=Ks:o==="UBR"&&(this.geometryEmitterType=dc),this.type=o,this.id=a,this.tracks=t.tracks;const l=t.globalSequenceId;if(l!==-1&&(this.globalSequence=e.globalSequences[l]),o==="SND"&&!s.audioEnabled)return;const c=s.promise();pi.getEventObjectData(s,o,a,e.hd).then(d=>{if(c(),d){const{row:h,resources:u}=d;if(this.ok=!0,o==="SPN")this.internalModel=u[0];else if(o==="SPL"||o==="UBR"){this.internalTexture=new Pt(0,Ke.WrapBoth),this.internalTexture.texture=u[0],this.scale=h.number("Scale"),this.colors[0]=new Float32Array([h.number("StartR"),h.number("StartG"),h.number("StartB"),h.number("StartA")]),this.colors[1]=new Float32Array([h.number("MiddleR"),h.number("MiddleG"),h.number("MiddleB"),h.number("MiddleA")]),this.colors[2]=new Float32Array([h.number("EndR"),h.number("EndG"),h.number("EndB"),h.number("EndA")]),o==="SPL"?(this.columns=h.number("Columns"),this.rows=h.number("Rows"),this.lifeSpan=h.number("Lifespan")+h.number("Decay"),this.intervalTimes[0]=h.number("Lifespan"),this.intervalTimes[1]=h.number("Decay"),this.intervals[0]=new Float32Array([h.number("UVLifespanStart"),h.number("UVLifespanEnd"),h.number("LifespanRepeat")]),this.intervals[1]=new Float32Array([h.number("UVDecayStart"),h.number("UVDecayEnd"),h.number("DecayRepeat")])):(this.columns=1,this.rows=1,this.lifeSpan=h.number("BirthTime")+h.number("PauseTime")+h.number("Decay"),this.intervalTimes[0]=h.number("BirthTime"),this.intervalTimes[1]=h.number("PauseTime"),this.intervalTimes[2]=h.number("Decay"));const p=Ns(h.number("BlendMode"),s.gl);this.blendSrc=p[0],this.blendDst=p[1]}else{this.distanceCutoff=h.number("DistanceCutoff"),this.maxDistance=h.number("MaxDistance"),this.minDistance=h.number("MinDistance"),this.pitch=h.number("Pitch"),this.pitchVariance=h.number("PitchVariance"),this.volume=h.number("Volume");for(const p of u)this.decodedBuffers.push(p.data)}}})}getValue(e,t){if(this.globalSequence!==-1){const i=this.globalSequence;return this.getValueAtTime(e,t.counter%i,0,i)}else if(t.sequence!==-1){const i=this.model.sequences[t.sequence].interval;return this.getValueAtTime(e,t.frame,i[0],i[1])}else return e[0]=this.defval[0],-1}getValueAtTime(e,t,i,s){const r=this.tracks;if(t>=i&&t<=s)for(let o=r.length-1;o>-1;o--){if(r[o]<i)return e[0]=0,o;if(r[o]<=t)return e[0]=1,o}return e[0]=0,-1}}class Ac extends Ee{type;vertices;boundsRadius;constructor(e,t,i){super(e,t,i),this.type=t.type,this.vertices=t.vertices,this.boundsRadius=t.boundsRadius}}var ee=(n=>(n[n.VertexGroups=0]="VertexGroups",n[n.ExtendedVertexGroups=1]="ExtendedVertexGroups",n[n.Skin=2]="Skin",n))(ee||{});class lt{index;geoset;layer;material;skinningType;isHd;constructor(e,t,i,s,r){let o,a;r?(o=i,a=o.layers[0]):(o=null,a=i),this.index=e,this.geoset=t,this.skinningType=s,this.isHd=r,this.layer=a,this.material=o}}class Tc{model;index;positionOffset;normalOffset;uvOffset;tangentOffset;skinOffset;faceOffset;vertices;elements;faceType;geosetAnimation=null;constructor(e,t,i,s,r,o,a,l,c,d,h){this.model=e,this.index=t,this.positionOffset=i,this.normalOffset=s,this.uvOffset=r,this.tangentOffset=o,this.skinOffset=a,this.faceOffset=l,this.vertices=c,this.elements=d,this.faceType=h;for(const u of e.geosetAnimations)u.geosetId===t&&(this.geosetAnimation=u)}bindShared(e,t,i){e.vertexAttribPointer(t.a_position,3,e.FLOAT,!1,0,this.positionOffset),e.vertexAttribPointer(t.a_normal,3,e.FLOAT,!1,0,this.normalOffset),e.vertexAttribPointer(t.a_uv,2,e.FLOAT,!1,0,this.uvOffset+i*this.vertices*8)}bindVertexGroups(e,t){const i=this.model,s=i.skinDataType,r=i.bytesPerSkinElement;e.vertexAttribPointer(t.a_bones,4,s,!1,5*r,this.skinOffset),e.vertexAttribPointer(t.a_boneNumber,1,s,!1,5*r,this.skinOffset+4*r)}bindVertexGroupsExtended(e,t){const i=this.model,s=i.skinDataType,r=i.bytesPerSkinElement;e.vertexAttribPointer(t.a_bones,4,s,!1,9*r,this.skinOffset),e.vertexAttribPointer(t.a_extendedBones,4,s,!1,9*r,this.skinOffset+4*r),e.vertexAttribPointer(t.a_boneNumber,1,s,!1,9*r,this.skinOffset+8*r)}bindSkin(e,t){e.vertexAttribPointer(t.a_bones,4,e.UNSIGNED_BYTE,!1,8,this.skinOffset),e.vertexAttribPointer(t.a_weights,4,e.UNSIGNED_BYTE,!0,8,this.skinOffset+4)}bind(e,t){const i=this.model.viewer.gl,s=e.attribs;this.bindShared(i,s,t),s.a_weights!==void 0?this.bindSkin(i,s):this.bindVertexGroups(i,s)}bindExtended(e,t){const i=this.model.viewer.gl,s=e.attribs;this.bindShared(i,s,t),this.bindVertexGroupsExtended(i,s)}bindHd(e,t,i){const s=this.model.viewer.gl,r=e.attribs;this.bindShared(s,r,i),s.vertexAttribPointer(r.a_tangent,4,s.FLOAT,!1,0,this.tangentOffset),t===ee.Skin?this.bindSkin(s,r):t===ee.ExtendedVertexGroups?this.bindVertexGroupsExtended(s,r):this.bindVertexGroups(s,r)}render(){const e=this.model.viewer.gl;e.drawElements(this.faceType,this.elements,e.UNSIGNED_SHORT,this.faceOffset)}}function xc(n,e){if(e.length>0){const t=n.viewer.gl;let i=0,s=0,r=0,o=0,a=0,l=0;const c=[];for(let v=0,_=e.length;v<_;v++){const x=e[v];if(x.lod===0||x.lod===-1){const T=x.vertices.length/3;if(i+=T*12,s+=T*12,r+=x.uvSets.length*T*8,x.tangents.length&&(o+=T*16),x.skin.length)a+=T*8,c[v]=ee.Skin;else{let y=0;for(const N of x.matrixGroups)N>y&&(y=N);y>4?(a+=T*9,c[v]=ee.ExtendedVertexGroups):(a+=T*5,c[v]=ee.VertexGroups)}l+=x.faces.byteLength}}let d=0,h=d+i,u=h+s,p=u+r,g=p+o,m=0,w=Uint8Array,b=t.UNSIGNED_BYTE;n.bones.length>255&&(a*=2,w=Uint16Array,b=t.UNSIGNED_SHORT),n.skinDataType=b,n.bytesPerSkinElement=w.BYTES_PER_ELEMENT,n.arrayBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,n.arrayBuffer),t.bufferData(t.ARRAY_BUFFER,g+a,t.STATIC_DRAW),n.elementBuffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,n.elementBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,l,t.STATIC_DRAW);for(let v=0,_=e.length;v<_;v++){const x=e[v];if(x.lod===0||x.lod===-1){const T=x.vertices,y=x.normals,N=x.uvSets,D=x.tangents,j=x.faces;let q;const ce=x.vertices.length/3,P=c[v];if(P===ee.Skin)q=x.skin;else{const $=x.matrixIndices,C=x.vertexGroups,U=[];let M=0,F=4;P===ee.ExtendedVertexGroups&&(F=8),q=new w(ce*(F+1));for(const Q of x.matrixGroups)U.push($.subarray(M,M+Q)),M+=Q;for(let Q=0;Q<ce;Q++){const ve=U[C[Q]];if(M=Q*(F+1),ve){const Te=Math.min(ve.length,F);for(let I=0;I<Te;I++)q[M+I]=ve[I]+1;q[M+F]=Te}}}const z=new Tc(n,n.geosets.length,d,h,u,p,g,m,ce,j.length,x.faceTypeGroups[0]);n.geosets.push(z);const V=n.materials[x.materialId];if(V.shader==="Shader_HD_DefaultUnit")n.batches.push(new lt(n.batches.length,z,V,P,!0));else for(const $ of V.layers)n.batches.push(new lt(n.batches.length,z,$,P,!1));t.bufferSubData(t.ARRAY_BUFFER,d,T),d+=T.byteLength,t.bufferSubData(t.ARRAY_BUFFER,h,y),h+=y.byteLength;for(const $ of N)t.bufferSubData(t.ARRAY_BUFFER,u,$),u+=$.byteLength;D.length&&(t.bufferSubData(t.ARRAY_BUFFER,p,D),p+=D.byteLength),t.bufferSubData(t.ARRAY_BUFFER,g,q),g+=q.byteLength,t.bufferSubData(t.ELEMENT_ARRAY_BUFFER,m,j),m+=j.byteLength}}}}class Ys{model;skinningType;isHd;objects=[];constructor(e,t,i){this.model=e,this.skinningType=t,this.isHd=i}render(e){const t=e.scene,i=t.camera,s=e.textureOverrides,r=e.layerAlphas,o=this.model,a=o.textures,l=o.batches,c=o.viewer,d=c.sharedCache.get("mdx"),h=c.gl,u=c.webgl,p=this.skinningType,g=this.isHd,m=d.teamColors,w=d.teamGlows,b=pi.getBatchShader(c,p,g);b.use();const v=b.uniforms;h.uniformMatrix4fv(v.u_VP,!1,i.viewProjectionMatrix);const _=e.boneTexture;if(_?(_.bind(15),h.uniform1f(v.u_hasBones,1),h.uniform1i(v.u_boneMap,15),h.uniform1f(v.u_vectorSize,1/_.width),h.uniform1f(v.u_rowSize,1)):h.uniform1f(v.u_hasBones,0),h.uniform3fv(v.u_lightPos,t.lightPosition),h.bindBuffer(h.ARRAY_BUFFER,o.arrayBuffer),h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,o.elementBuffer),g){h.uniform1i(v.u_diffuseMap,0),h.uniform1i(v.u_normalsMap,1),h.uniform1i(v.u_ormMap,2),h.uniform1i(v.u_emissiveMap,3),h.uniform1i(v.u_teamColorMap,4),h.uniform1i(v.u_environmentMap,5),h.disable(h.BLEND),h.enable(h.DEPTH_TEST),h.depthMask(!0),h.uniformMatrix4fv(v.u_MV,!1,i.viewMatrix),h.uniform3fv(v.u_eyePos,i.location);for(const x of this.objects){const T=l[x],y=T.geoset,N=T.material,[D,j,q,ce,P,z]=N.layers,V=r[D.index];if(V>0){h.uniform1f(v.u_layerAlpha,V),h.uniform1f(v.u_filterMode,D.filterMode);const S=D.textureId,$=j.textureId,C=q.textureId,U=ce.textureId,M=P.textureId,F=z.textureId,Q=a[S],ve=a[$],Te=a[C],I=a[U];let B=a[M];const G=a[F];(B.replaceableId===0||B.replaceableId===1)&&(B=m[e.teamColor]);const ge=s.get(S)||Q.texture,K=s.get($)||ve.texture,re=s.get(C)||Te.texture,le=s.get(U)||I.texture,oe=s.get(M)||B.texture,kt=s.get(F)||G.texture;u.bindTextureAndWrap(ge,0,Q.wrapS,Q.wrapT),u.bindTextureAndWrap(K,1,ve.wrapS,ve.wrapT),u.bindTextureAndWrap(re,2,Te.wrapS,Te.wrapT),u.bindTextureAndWrap(le,3,I.wrapS,I.wrapT),u.bindTextureAndWrap(oe,4,B.wrapS,B.wrapT),u.bindTextureAndWrap(kt,5,G.wrapS,G.wrapT),y.bindHd(b,T.skinningType,D.coordId),y.render()}}}else{const x=e.geosetColors,T=e.layerTextures,y=e.uvAnims;h.uniform4fv(v.u_vertexColor,e.vertexColor),h.uniform1i(v.u_texture,0);for(const N of this.objects){const D=l[N],j=D.geoset,q=D.layer,ce=j.index,P=q.index,z=x[ce],V=r[P];if(z[3]>.01&&V>.01){const S=T[P],$=a[S],C=y[P];h.uniform4fv(v.u_geosetColor,z),h.uniform1f(v.u_layerAlpha,V),h.uniform1f(v.u_unshaded,q.unshaded),h.uniform2f(v.u_uvTrans,C[0],C[1]),h.uniform2f(v.u_uvRot,C[2],C[3]),h.uniform1f(v.u_uvScale,C[4]),q.bind(b);let U=s.get(S);if(!U){const M=$.replaceableId;let F;M===1?F=m[e.teamColor]:M===2?F=w[e.teamColor]:F=$,F&&(U=F.texture)}u.bindTextureAndWrap(U,0,$.wrapS,$.wrapT),p===ee.ExtendedVertexGroups?j.bindExtended(b,q.coordId):j.bind(b,q.coordId),j.render()}}}}}class Ec{model;objects=[];constructor(e){this.model=e}render(e){const t=e.scene,i=e.nodes,r=e.model.viewer,o=r.gl,a=r.webgl.extensions.ANGLE_instanced_arrays,l=r.sharedCache.get("mdx"),c=l.particlesShader,d=c.uniforms,h=c.attribs,u=l.rectBuffer;o.depthMask(!1),o.enable(o.BLEND),o.disable(o.CULL_FACE),o.enable(o.DEPTH_TEST),c.use(),o.uniformMatrix4fv(d.u_VP,!1,t.camera.viewProjectionMatrix),o.uniform1i(d.u_texture,0),a.vertexAttribDivisorANGLE(h.a_position,0),o.bindBuffer(o.ARRAY_BUFFER,u),o.vertexAttribPointer(h.a_position,1,o.UNSIGNED_BYTE,!1,0,0),a.vertexAttribDivisorANGLE(h.a_p0,1),a.vertexAttribDivisorANGLE(h.a_p1,1),a.vertexAttribDivisorANGLE(h.a_p2,1),a.vertexAttribDivisorANGLE(h.a_p3,1),a.vertexAttribDivisorANGLE(h.a_health,1),a.vertexAttribDivisorANGLE(h.a_color,1),a.vertexAttribDivisorANGLE(h.a_tail,1),a.vertexAttribDivisorANGLE(h.a_leftRightTop,1);for(const p of this.objects)wc(i[p].object,c);a.vertexAttribDivisorANGLE(h.a_leftRightTop,0),a.vertexAttribDivisorANGLE(h.a_tail,0),a.vertexAttribDivisorANGLE(h.a_color,0),a.vertexAttribDivisorANGLE(h.a_health,0),a.vertexAttribDivisorANGLE(h.a_p3,0),a.vertexAttribDivisorANGLE(h.a_p2,0),a.vertexAttribDivisorANGLE(h.a_p1,0),a.vertexAttribDivisorANGLE(h.a_p0,0)}}function Zs(n){return n instanceof lt||n instanceof Ws?n.layer.priorityPlane:n instanceof Xs?n.priorityPlane:0}function Qs(n,e){return n instanceof Ys?e instanceof lt&&e.skinningType===n.skinningType&&e.isHd===n.isHd:e instanceof Ee}function Js(n,e){return e instanceof lt?new Ys(n,e.skinningType,e.isHd):new Ec(n)}function Sc(n){const e=[];let t=[];for(const a of n.batches)a.layer.filterMode<2?e.push(a):t.push(a);const i=n.opaqueGroups,s=n.translucentGroups;let r=null;for(const a of e)(!r||!Qs(r,a))&&(r=Js(n,a),i.push(r)),r.objects.push(a.index);t=t.sort((a,l)=>a.layer.filterMode-l.layer.filterMode);const o=[...t,...n.eventObjects,...n.particleEmitters2,...n.ribbonEmitters].sort((a,l)=>Zs(a)-Zs(l));r=null;for(const a of o)(a instanceof lt||a.geometryEmitterType!==-1)&&((!r||!Qs(r,a))&&(r=Js(n,a),s.push(r)),r.objects.push(a.index))}const Ic=f.vec3.create(),_c=f.quat.create(),Cc=f.vec3.create();class Lc{pivot=f.vec3.create();localLocation=f.vec3.create();localRotation=f.quat.create();localScale=f.vec3.fromValues(1,1,1);worldLocation=f.vec3.create();worldRotation=f.quat.create();worldScale=f.vec3.fromValues(1,1,1);inverseWorldLocation=f.vec3.create();inverseWorldRotation=f.quat.create();inverseWorldScale=f.vec3.fromValues(1,1,1);localMatrix=f.mat4.create();worldMatrix=f.mat4.create();dontInheritTranslation=!1;dontInheritRotation=!1;dontInheritScaling=!0;parent=null;children=[];setPivot(e){return f.vec3.copy(this.pivot,e),this.recalculateTransformation(),this}setLocation(e){return f.vec3.copy(this.localLocation,e),this.recalculateTransformation(),this}setRotation(e){return f.quat.copy(this.localRotation,e),this.recalculateTransformation(),this}setScale(e){return f.vec3.copy(this.localScale,e),this.recalculateTransformation(),this}setUniformScale(e){return f.vec3.set(this.localScale,e,e,e),this.recalculateTransformation(),this}setTransformation(e,t,i){const s=this.localLocation,r=this.localRotation,o=this.localScale;return s[0]=e[0],s[1]=e[1],s[2]=e[2],r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],o[0]=i[0],o[1]=i[1],o[2]=i[2],this.recalculateTransformation(),this}resetTransformation(){return f.vec3.copy(this.pivot,st),f.vec3.copy(this.localLocation,st),f.quat.copy(this.localRotation,$i),f.vec3.copy(this.localScale,Gi),this.recalculateTransformation(),this}movePivot(e){return f.vec3.add(this.pivot,this.pivot,e),this.recalculateTransformation(),this}move(e){return f.vec3.add(this.localLocation,this.localLocation,e),this.recalculateTransformation(),this}rotate(e){return f.quat.mul(this.localRotation,this.localRotation,e),this.recalculateTransformation(),this}rotateLocal(e){return f.quat.mul(this.localRotation,e,this.localRotation),this.recalculateTransformation(),this}scale(e){return f.vec3.mul(this.localScale,this.localScale,e),this.recalculateTransformation(),this}uniformScale(e){return f.vec3.scale(this.localScale,this.localScale,e),this.recalculateTransformation(),this}face(e,t){return f.quat.conjugate(this.localRotation,Is(this.localRotation,this.localLocation,e,t)),this.recalculateTransformation(),this}setParent(e){if(this.parent){const t=this.parent.children,i=t.indexOf(this);i!==-1&&t.splice(i,1)}return this.parent=e||null,e&&e.children.push(this),this.recalculateTransformation(),this}recalculateTransformation(){const e=this.parent,t=this.localMatrix,i=this.localLocation,s=this.localRotation,r=this.localScale,o=this.worldMatrix,a=this.worldLocation,l=this.worldRotation,c=this.worldScale,d=this.inverseWorldLocation,h=this.inverseWorldRotation,u=this.inverseWorldScale;if(e){const p=Ic,g=e.pivot;let m,w;if(p[0]=i[0]+g[0],p[1]=i[1]+g[1],p[2]=i[2]+g[2],this.dontInheritRotation?(m=_c,f.quat.mul(m,s,e.inverseWorldRotation)):m=s,this.dontInheritScaling){w=Cc;const b=e.inverseWorldScale;w[0]=b[0]*r[0],w[1]=b[1]*r[1],w[2]=b[2]*r[2],c[0]=r[0],c[1]=r[1],c[2]=r[2]}else{w=r;const b=e.worldScale;c[0]=b[0]*r[0],c[1]=b[1]*r[1],c[2]=b[2]*r[2]}f.mat4.fromRotationTranslationScale(t,m,p,w),f.mat4.mul(o,e.worldMatrix,t),f.quat.mul(l,e.worldRotation,m)}else f.mat4.fromRotationTranslationScale(t,s,i,r),o[0]=t[0],o[1]=t[1],o[2]=t[2],o[3]=t[3],o[4]=t[4],o[5]=t[5],o[6]=t[6],o[7]=t[7],o[8]=t[8],o[9]=t[9],o[10]=t[10],o[11]=t[11],o[12]=t[12],o[13]=t[13],o[14]=t[14],o[15]=t[15],l[0]=s[0],l[1]=s[1],l[2]=s[2],l[3]=s[3],c[0]=r[0],c[1]=r[1],c[2]=r[2];h[0]=-l[0],h[1]=-l[1],h[2]=-l[2],h[3]=l[3],u[0]=1/c[0],u[1]=1/c[1],u[2]=1/c[2],a[0]=o[12],a[1]=o[13],a[2]=o[14],d[0]=-a[0],d[1]=-a[1],d[2]=-a[2];for(const p of this.children)p.recalculateTransformation()}update(e){for(const t of this.children)t.update(e)}}class Bc extends Lc{scene=null;left=-1;right=-1;bottom=-1;top=-1;plane=-1;depth=0;updateFrame=0;model;timeScale=1;rendered=!0;textureOverrides=new Map;constructor(e){super(),this.model=e}show(){this.rendered=!0}hide(){this.rendered=!1}shown(){return this.rendered}hidden(){return!this.rendered}detach(){return this.scene?this.scene.removeInstance(this):!1}overrideTexture(e,t){t?this.textureOverrides.set(e,t):this.textureOverrides.delete(e)}getBounds(){return this.model.bounds}clearEmittedObjects(){}setScene(e){return e.addInstance(this)}recalculateTransformation(){super.recalculateTransformation(),this.scene&&this.scene.grid.moved(this)}update(e){const t=this.scene;t&&this.rendered&&this.isVisible(t.camera)&&(t.renderInstance(this),this.updateAnimations(e*this.timeScale),super.update(e))}updateAnimations(e){}renderOpaque(){}renderTranslucent(){}isVisible(e){const[t,i,s]=this.worldLocation,[r,o,a]=this.worldScale,l=this.getBounds(),c=e.planes;let d=r;return o>d&&(d=o),a>d&&(d=a),this.plane=gl(c,t+l.x,i+l.y,s+l.z,l.r*d,this.plane),this.plane===-1?(this.depth=Ss(c[4],t,i,s),!0):!1}}const ct=f.vec3.create(),Zi=f.quat.create(),Rc=f.vec3.create(),je=f.vec3.create(),we=f.quat.create();class er{pivot;localLocation;localRotation;localScale;worldLocation;worldRotation;worldScale;inverseWorldLocation;inverseWorldRotation;inverseWorldScale;localMatrix;worldMatrix;dontInheritTranslation=!1;dontInheritRotation=!1;dontInheritScaling=!1;billboarded=!1;billboardedX=!1;billboardedY=!1;billboardedZ=!1;dirty=!0;wasDirty=!1;parent=null;children=[];object=null;constructor(e,t,i,s,r,o,a,l,c,d,h,u){this.pivot=e,this.localLocation=t,this.localRotation=i,this.localScale=s,this.worldLocation=r,this.worldRotation=o,this.worldScale=a,this.inverseWorldLocation=l,this.inverseWorldRotation=c,this.inverseWorldScale=d,this.localMatrix=h,this.worldMatrix=u,this.localRotation[3]=1,this.localScale.fill(1),this.localMatrix[0]=1,this.localMatrix[5]=1,this.localMatrix[10]=1,this.localMatrix[15]=1}recalculateTransformation(e){const t=e.scene,i=this.localMatrix,s=this.localLocation,r=this.localRotation,o=this.localScale,a=this.worldMatrix,l=this.worldLocation,c=this.worldRotation,d=this.worldScale,h=this.pivot,u=this.inverseWorldLocation,p=this.inverseWorldRotation,g=this.inverseWorldScale,m=this.parent;let w,b,v;if(this.dontInheritTranslation?(f.vec3.add(ct,m.inverseWorldLocation,l),w=f.vec3.add(ct,ct,s)):w=s,this.dontInheritScaling?(f.vec3.mul(ct,m.inverseWorldScale,e.worldScale),v=f.vec3.mul(ct,ct,o)):v=o,this.billboarded)b=Zi,f.quat.copy(b,m.inverseWorldRotation),f.quat.mul(b,b,t.camera.inverseRotation),this.convertBasis(b),f.quat.mul(b,b,r);else{const{billboardedX:N,billboardedY:D,billboardedZ:j}=this;N||D||j?(N&&(v===o&&(v=Rc,f.vec3.copy(v,o)),v[2]*=-1),we[0]=-r[0],we[1]=-r[1],we[2]=-r[2],f.quat.mul(we,we,m.inverseWorldRotation),f.vec3.transformQuat(je,t.camera.billboardedVectors[6],we),N?f.quat.setAxisAngle(we,Vi,Math.atan2(je[2],je[1])):D?f.quat.setAxisAngle(we,xs,Math.atan2(-je[2],je[0])):f.quat.setAxisAngle(we,Ct,Math.atan2(je[1],je[0])),b=Zi,f.quat.mul(b,r,we)):b=r}this.dontInheritRotation&&(f.quat.mul(we,m.inverseWorldRotation,e.worldRotation),b=f.quat.mul(Zi,we,b)),f.mat4.fromRotationTranslationScaleOrigin(i,b,w,v,h),f.mat4.mul(a,m.worldMatrix,i);const _=h[0],x=h[1],T=h[2];l[0]=a[0]*_+a[4]*x+a[8]*T+a[12],l[1]=a[1]*_+a[5]*x+a[9]*T+a[13],l[2]=a[2]*_+a[6]*x+a[10]*T+a[14],u[0]=-l[0],u[1]=-l[1],u[2]=-l[2],f.quat.mul(c,m.worldRotation,b),p[0]=-c[0],p[1]=-c[1],p[2]=-c[2],p[3]=c[3];const y=m.worldScale;d[0]=y[0]*v[0],d[1]=y[1]*v[1],d[2]=y[2]*v[2],g[0]=1/d[0],g[1]=1/d[1],g[2]=1/d[2]}convertBasis(e){}}const Pc=65;function kc(n,e=er){const t=new Float32Array(n*Pc),i=[];let s=0;const r=n*3,o=n*4,a=n*16,l=t.subarray(s,s+r);s+=r;const c=t.subarray(s,s+r);s+=r;const d=t.subarray(s,s+o);s+=o;const h=t.subarray(s,s+r);s+=r;const u=t.subarray(s,s+r);s+=r;const p=t.subarray(s,s+o);s+=o;const g=t.subarray(s,s+r);s+=r;const m=t.subarray(s,s+r);s+=r;const w=t.subarray(s,s+o);s+=o;const b=t.subarray(s,s+r);s+=r;const v=t.subarray(s,s+a);s+=a;const _=t.subarray(s,s+a);for(let x=0;x<n;x++){const T=x*3,y=T+3,N=x*4,D=N+4,j=x*16,q=j+16;i[x]=new e(l.subarray(T,y),c.subarray(T,y),d.subarray(N,D),h.subarray(T,y),u.subarray(T,y),p.subarray(N,D),g.subarray(T,y),m.subarray(T,y),w.subarray(N,D),b.subarray(T,y),v.subarray(j,q),_.subarray(j,q))}return{data:t,nodes:i,pivots:l,localLocations:c,localRotations:d,localScales:h,worldLocations:u,worldRotations:p,worldScales:g,inverseWorldLocations:m,invereseWorldRotations:w,inverseWorldScales:b,localMatrices:v,worldMatrices:_}}class Uc extends er{convertBasis(e){f.quat.rotateY(e,e,-Math.PI/2),f.quat.rotateX(e,e,-Math.PI/2)}}const tr=new Float32Array(1);class Fc{instance;attachment;internalInstance;constructor(e,t){const s=t.internalModel.addInstance();s.setSequenceLoopMode(2),s.dontInheritScaling=!1,s.hide(),s.setParent(e.nodes[t.objectId]),this.instance=e,this.attachment=t,this.internalInstance=s}update(){const e=this.instance,t=this.internalInstance;e.scene&&e.sequence!==-1&&(this.attachment.getVisibility(tr,e.sequence,e.frame,e.counter),tr[0]>.1?(e.scene.addInstance(t),t.hidden()&&(t.show(),t.setSequence(0))):t.hide())}}class Nc{instance;objects=[];alive=0;currentEmission=0;constructor(e){this.instance=e}update(e){this.updateEmission(e);const t=this.currentEmission;if(t>=1)for(let i=0;i<t;i+=1)this.emit()}clear(){const e=this.objects;for(let t=0,i=this.alive;t<i;t++){const s=e[t];s.health=0}this.currentEmission=0}emitObject(e){const t=this.objects;this.alive===t.length&&t.push(this.createObject());const i=t[this.alive];return i.index=this.alive,i.bind(e),this.alive+=1,this.currentEmission-=1,this.instance.scene.emittedObjectUpdater.add(i),i}kill(e){const t=this.objects;this.alive-=1;const i=t[this.alive];t[e.index]=i,t[this.alive]=e,i.index=e.index,e.index=-1}}class ci extends Nc{emitterObject;constructor(e,t){super(e),this.emitterObject=t}update(e){this.emitterObject.ok&&super.update(e)}}class ht{emitter;index=-1;health=0;constructor(e){this.emitter=e}}const He=f.quat.create(),Mc=f.vec3.create(),Qi=new Float32Array(1),ir=new Float32Array(1),nr=new Float32Array(1),sr=new Float32Array(1);class Oc extends ht{internalInstance;velocity=f.vec3.create();gravity=0;constructor(e){super(e);const i=e.emitterObject.internalModel;this.internalInstance=i.addInstance()}bind(){const e=this.emitter,t=e.instance,i=t.sequence,s=t.frame,r=t.counter,o=t.scene,a=e.emitterObject,l=t.nodes[a.index],c=this.internalInstance,d=l.worldScale,h=this.velocity;a.getLatitude(Qi,i,s,r),a.getLifeSpan(ir,i,s,r),a.getGravity(nr,i,s,r),a.getSpeed(sr,i,s,r),this.health=ir[0],this.gravity=nr[0]*d[2],f.quat.identity(He),f.quat.rotateZ(He,He,Fe(-Math.PI,Math.PI)),f.quat.rotateY(He,He,Fe(-Qi[0],Qi[0])),f.vec3.transformQuat(h,Ct,He),f.vec3.transformQuat(h,h,l.worldRotation),f.vec3.scale(h,h,sr[0]),f.vec3.mul(h,h,d),c.setScene(o),c.setSequence(0),c.setTransformation(l.worldLocation,f.quat.setAxisAngle(He,Ct,Fe(0,Math.PI*2)),l.worldScale),c.show()}update(e){const t=this.internalInstance;if(this.health-=e,this.health>0){const i=this.velocity;i[2]-=this.gravity*e,t.move(f.vec3.scale(Mc,i,e))}else t.hide()}}const rr=new Float32Array(1);class Dc extends ci{updateEmission(e){const t=this.instance;t.allowParticleSpawn&&(this.emitterObject.getEmissionRate(rr,t.sequence,t.frame,t.counter),this.currentEmission+=rr[0]*e)}emit(){this.emitObject()}createObject(){return new Oc(this)}}const Se=f.quat.create(),or=new Float32Array(1),ar=new Float32Array(1),lr=new Float32Array(1),cr=new Float32Array(1),hr=new Float32Array(1),dr=new Float32Array(1);class Vc extends ht{tail=0;gravity=0;location=f.vec3.create();velocity=f.vec3.create();scale=f.vec3.create();facing=0;bind(e){const t=this.emitter,i=t.instance,s=i.sequence,r=i.frame,o=i.counter,a=t.emitterObject;a.getWidth(or,s,r,o),a.getLength(ar,s,r,o),a.getLatitude(lr,s,r,o),a.getVariation(cr,s,r,o),a.getSpeed(hr,s,r,o),a.getGravity(dr,s,r,o);const l=t.node,c=l.pivot,d=l.worldScale,h=or[0]*.5,u=ar[0]*.5,p=kr(lr[0]),g=cr[0],m=hr[0],w=this.location,b=this.velocity;this.health=a.lifeSpan,this.tail=e,this.gravity=dr[0]*d[2],f.vec3.copy(this.scale,d),w[0]=c[0]+Fe(-h,h),w[1]=c[1]+Fe(-u,u),w[2]=c[2],a.modelSpace||f.vec3.transformMat4(w,w,l.worldMatrix),f.quat.identity(Se),f.quat.rotateZ(Se,Se,Math.PI/2),f.quat.rotateY(Se,Se,Fe(-p,p)),a.lineEmitter||f.quat.rotateX(Se,Se,Fe(-p,p)),a.modelSpace||f.quat.mul(Se,l.worldRotation,Se),f.vec3.transformQuat(b,Ct,Se),f.vec3.scale(b,b,m*(1+Fe(-g,g))),a.modelSpace||f.vec3.mul(b,b,d),a.xYQuad&&(this.facing=Math.atan2(b[1],b[0])-Math.PI+Math.PI/8)}update(e){if(this.health-=e,this.health>0){const t=this.location,i=this.velocity;i[2]-=this.gravity*e,t[0]+=i[0]*e,t[1]+=i[1]*e,t[2]+=i[2]*e}}}const Ji=new Float32Array(1);class Gc extends ci{node;lastEmissionKey=-1;constructor(e,t){super(e,t),this.node=e.nodes[t.index]}updateEmission(e){const t=this.instance;if(t.allowParticleSpawn){const i=this.emitterObject,s=i.getEmissionRate(Ji,t.sequence,t.frame,t.counter);i.squirt?(s!==this.lastEmissionKey&&(this.currentEmission+=Ji[0]),this.lastEmissionKey=s):this.currentEmission+=Ji[0]*e}}emit(){const e=this.emitterObject;e.head&&this.emitObject(0),e.tail&&this.emitObject(1)}createObject(){return new Vc(this)}}const Ie=f.vec3.create(),_e=f.vec3.create(),hi=new Float32Array(3),fr=new Float32Array(1),ur=new Uint32Array(1);class $c extends ht{vertices=new Float32Array(6);color=new Uint8Array(4);slot=0;prev=null;next=null;bind(){const e=this.emitter,t=e.instance,i=t.sequence,s=t.frame,r=t.counter,o=e.emitterObject,a=t.nodes[o.index],[l,c,d]=a.pivot,h=a.worldMatrix,u=this.vertices;this.health=e.emitterObject.lifeSpan,o.getHeightBelow(Ie,i,s,r),o.getHeightAbove(_e,i,s,r),Ie[1]=c-Ie[0],Ie[0]=l,Ie[2]=d,_e[1]=c+_e[0],_e[0]=l,_e[2]=d,f.vec3.transformMat4(Ie,Ie,h),f.vec3.transformMat4(_e,_e,h),u[0]=_e[0],u[1]=_e[1],u[2]=_e[2],u[3]=Ie[0],u[4]=Ie[1],u[5]=Ie[2]}update(e){if(this.health-=e,this.health>0){const t=this.emitter,i=t.instance,s=i.sequence,r=i.frame,o=i.counter,a=t.emitterObject,l=this.color,c=this.vertices,d=a.gravity*e*e;a.getColor(hi,s,r,o),a.getAlpha(fr,s,r,o),a.getTextureSlot(ur,s,r,o),c[1]-=d,c[4]-=d,l[0]=hi[0]*255,l[1]=hi[1]*255,l[2]=hi[2]*255,l[3]=fr[0]*255,this.slot=ur[0]}}}class qc extends ci{first=null;last=null;updateEmission(e){if(this.instance.allowParticleSpawn){const i=this.emitterObject;this.currentEmission+=i.emissionRate*e}}emit(){const e=this.emitObject(),t=this.last;t?(t.next=e,e.prev=t):this.first=e,this.last=e}kill(e){super.kill(e);const t=e.prev,i=e.next;e===this.first&&(this.first=i),e===this.last&&(this.first=null,this.last=null),t&&(t.next=i),i&&(i.prev=t),e.prev=null,e.next=null}createObject(){return new $c(this)}}const pr=new Uint32Array(1);class di extends ci{lastValue=0;updateEmission(e){const t=this.instance;if(t.allowParticleSpawn){this.emitterObject.getValue(pr,t);const s=pr[0];s===1&&s!==this.lastValue&&(this.currentEmission+=1),this.lastValue=s}}emit(){this.emitObject()}}class Kc extends ht{internalInstance;constructor(e){super(e);const i=e.emitterObject.internalModel;this.internalInstance=i.addInstance()}bind(){const e=this.emitter,t=e.instance,i=t.scene,s=t.nodes[e.emitterObject.index],r=this.internalInstance;r.setScene(i),r.setSequence(0),r.setTransformation(s.worldLocation,s.worldRotation,s.worldScale),r.show(),this.health=1}update(e){const t=this.internalInstance,i=t.model;t.frame>=i.sequences[0].interval[1]&&(this.health=0,t.hide())}}class jc extends di{createObject(){return new Kc(this)}}const se=f.vec3.create();class gr extends ht{vertices=new Float32Array(12);bind(){const e=this.emitter,t=e.instance,i=e.emitterObject,s=this.vertices,r=i.scale,{worldLocation:o,worldRotation:a}=t.nodes[i.index];this.health=i.lifeSpan,f.vec3.set(se,r,r,0),f.vec3.transformQuat(se,se,a),f.vec3.add(s.subarray(0,2),se,o),f.vec3.set(se,-r,r,0),f.vec3.transformQuat(se,se,a),f.vec3.add(s.subarray(3,5),se,o),f.vec3.set(se,-r,-r,0),f.vec3.transformQuat(se,se,a),f.vec3.add(s.subarray(6,8),se,o),f.vec3.set(se,r,-r,0),f.vec3.transformQuat(se,se,a),f.vec3.add(s.subarray(9,11),se,o)}update(e){this.health-=e}}class Hc extends di{createObject(){return new gr(this)}}class zc extends di{createObject(){return new gr(this)}}class Xc extends ht{bind(){const e=this.emitter,t=e.instance,i=t.model.viewer,s=t.scene;if(i.audioEnabled&&s.audioEnabled){const r=e.emitterObject,o=t.nodes[r.index],a=s.audioContext,l=r.decodedBuffers,c=a.createPanner(),d=a.createBufferSource(),h=o.worldLocation;c.positionX.value=h[0],c.positionY.value=h[1],c.positionZ.value=h[2],c.maxDistance=r.distanceCutoff,c.refDistance=r.minDistance,c.connect(a.destination),d.buffer=l[Math.random()*l.length|0],d.connect(c),d.start(0)}}update(e){}}class Wc extends di{createObject(){return new Xc(this)}}const mr=new Float32Array(1),en=f.vec3.create(),tn=f.quat.create(),br=f.vec3.create(),fi=new Float32Array(3),ui=new Float32Array(1),wr=new Uint32Array(1);class Yc extends Bc{attachments=[];particleEmitters=[];particleEmitters2=[];ribbonEmitters=[];eventObjectEmitters=[];nodes=[];sortedNodes=[];frame=0;counter=0;sequence=-1;sequenceLoopMode=0;sequenceEnded=!1;teamColor=0;vertexColor=new Float32Array([1,1,1,1]);allowParticleSpawn=!1;forced=!0;geosetColors=[];layerAlphas=[];layerTextures=[];uvAnims=[];worldMatrices=null;boneTexture=null;constructor(e){super(e);for(let o=0,a=e.geosets.length;o<a;o++)this.geosetColors[o]=new Float32Array(4);for(let o=0,a=e.layers.length;o<a;o++)this.layerAlphas[o]=0,this.layerTextures[o]=0,this.uvAnims[o]=new Float32Array(5);const t=kc(e.genericObjects.length,Uc),i=t.nodes;let s=0;this.nodes.push(...i),this.worldMatrices=t.worldMatrices;for(const o of e.bones)this.initNode(i,i[s++],o);for(const o of e.lights)this.initNode(i,i[s++],o);for(const o of e.helpers)this.initNode(i,i[s++],o);for(const o of e.attachments){let a;o.internalModel&&(a=new Fc(this,o),this.attachments.push(a)),this.initNode(i,i[s++],o,a)}for(const o of e.particleEmitters){const a=new Dc(this,o);this.particleEmitters.push(a),this.initNode(i,i[s++],o,a)}for(const o of e.particleEmitters2){const a=new Gc(this,o);this.particleEmitters2.push(a),this.initNode(i,i[s++],o,a)}for(const o of e.ribbonEmitters){const a=new qc(this,o);this.ribbonEmitters.push(a),this.initNode(i,i[s++],o,a)}for(const o of e.eventObjects){const a=o.type;let l;a==="SPN"?l=new jc(this,o):a==="SPL"?l=new Hc(this,o):a==="UBR"?l=new zc(this,o):l=new Wc(this,o),this.eventObjectEmitters.push(l),this.initNode(i,i[s++],o,l)}for(const o of e.collisionShapes)this.initNode(i,i[s++],o);const r=e.hierarchy;for(let o=0,a=i.length;o<a;o++)this.sortedNodes[o]=i[r[o]];e.bones.length&&(this.boneTexture=new Ts(e.viewer.gl,4,e.bones.length*4,1))}setTexture(e,t){this.overrideTexture(e,t)}setParticle2Texture(e,t){this.overrideTexture(js+e,t)}setEventTexture(e,t){this.overrideTexture(Yi+e,t)}clearEmittedObjects(){for(const e of this.particleEmitters)e.clear();for(const e of this.particleEmitters2)e.clear();for(const e of this.ribbonEmitters)e.clear();for(const e of this.eventObjectEmitters)e.clear()}initNode(e,t,i,s){f.vec3.copy(t.pivot,i.pivot),i.parentId===-1?t.parent=this:t.parent=e[i.parentId],t.dontInheritTranslation=i.dontInheritTranslation,t.dontInheritRotation=i.dontInheritRotation,t.dontInheritScaling=i.dontInheritScaling,i.billboarded?t.billboarded=!0:i.billboardedX?t.billboardedX=!0:i.billboardedY?t.billboardedY=!0:i.billboardedZ&&(t.billboardedZ=!0),s&&(t.object=s)}hide(){super.hide(),this.resetAttachments()}updateNodes(e,t){const i=this.sequence,s=this.frame,r=this.counter,o=this.sortedNodes,l=this.model.sortedGenericObjects;for(let c=0,d=o.length;c<d;c++){const h=l[c],u=o[c],p=u.parent;let g=t||p.wasDirty||h.anyBillboarding;const m=h.variants;(t||m.generic[i])&&(g=!0,(t||m.translation[i])&&h.getTranslation(u.localLocation,i,s,r),(t||m.rotation[i])&&h.getRotation(u.localRotation,i,s,r),(t||m.scale[i])&&h.getScale(u.localScale,i,s,r)),u.wasDirty=g,g&&u.recalculateTransformation(this),u.object&&(h.getVisibility(mr,i,s,r),mr[0]>0&&u.object.update(e));for(const w of u.children)g&&w.recalculateTransformation(),w.update(e)}}recalculateTransformation(){super.recalculateTransformation(),this.forced=!0}updateBatches(e){const t=this.sequence,i=this.frame,s=this.counter,r=this.model,o=r.geosets,a=r.layers,l=this.geosetColors,c=this.layerAlphas,d=this.layerTextures,h=this.uvAnims;for(let u=0,p=o.length;u<p;u++){const m=o[u].geosetAnimation,w=l[u];m?((e||m.variants.color[t])&&(m.getColor(fi,t,i,s),w[0]=fi[0],w[1]=fi[1],w[2]=fi[2]),(e||m.variants.alpha[t])&&(m.getAlpha(ui,t,i,s),w[3]=ui[0])):e&&(w[0]=1,w[1]=1,w[2]=1,w[3]=1)}for(let u=0,p=a.length;u<p;u++){const g=a[u],m=g.textureAnimation,w=h[u];(e||g.variants.alpha[t])&&(g.getAlpha(ui,t,i,s),c[u]=ui[0]),(e||g.variants.textureId[t])&&(g.getTextureId(wr,t,i,s),d[u]=wr[0]),m?((e||m.variants.translation[t])&&(m.getTranslation(en,t,i,s),w[0]=en[0],w[1]=en[1]),(e||m.variants.rotation[t])&&(m.getRotation(tn,t,i,s),w[2]=tn[2],w[3]=tn[3]),(e||m.variants.scale[t])&&(m.getScale(br,t,i,s),w[4]=br[0])):e&&(w[0]=0,w[1]=0,w[2]=0,w[3]=1,w[4]=1)}}updateBoneTexture(){this.boneTexture&&this.boneTexture.bindAndUpdate(this.worldMatrices)}renderOpaque(){const e=this.model;for(const t of e.opaqueGroups)t.render(this)}renderTranslucent(){const e=this.model;for(const t of e.translucentGroups)t.render(this)}updateAnimations(e){const t=this.model,i=this.sequence;if(i!==-1){const r=t.sequences[i],o=r.interval,a=e*1e3;this.frame+=a,this.counter+=a,this.allowParticleSpawn=!0,this.frame>=o[1]?(this.sequenceLoopMode===2||this.sequenceLoopMode===0&&r.nonLooping===0?(this.frame=o[0],this.resetEventEmitters()):(this.frame=o[1],this.counter-=a,this.allowParticleSpawn=!1),this.sequenceEnded=!0):this.sequenceEnded=!1}const s=this.forced;(i!==-1||s)&&(this.updateNodes(e,s),this.updateBoneTexture(),this.updateBatches(s)),this.forced=!1}setTeamColor(e){return this.teamColor=e,this}setVertexColor(e){return this.vertexColor.set(e),this}setSequence(e){const i=this.model.sequences;return this.sequence=e,e<0||e>i.length-1?(this.sequence=-1,this.frame=0,this.allowParticleSpawn=!1):this.frame=i[e].interval[0],this.resetEventEmitters(),this.resetAttachments(),this.forced=!0,this}getBounds(){const e=this.model;if(this.sequence===-1)return e.bounds;const t=e.sequences[this.sequence].bounds;return t.r===0?e.bounds:t}setSequenceLoopMode(e){return this.sequenceLoopMode=e,this}getAttachment(e){const i=this.model.attachments[e];if(i)return this.nodes[i.index]}resetEventEmitters(){for(const e of this.eventObjectEmitters)e.lastValue=0}resetAttachments(){for(const e of this.attachments)e.internalInstance.hide()}}class vr extends Rs{reforged=!1;hd=!1;solverParams={};name="";sequences=[];globalSequences=[];materials=[];layers=[];textures=[];textureAnimations=[];geosets=[];geosetAnimations=[];bones=[];lights=[];helpers=[];attachments=[];pivotPoints=[];particleEmitters=[];particleEmitters2=[];ribbonEmitters=[];cameras=[];eventObjects=[];collisionShapes=[];hasLayerAnims=!1;hasGeosetAnims=!1;batches=[];genericObjects=[];sortedGenericObjects=[];hierarchy=[];opaqueGroups=[];translucentGroups=[];arrayBuffer=null;elementBuffer=null;skinDataType=0;bytesPerSkinElement=1;constructor(e,t){super(t);let i;if(e instanceof Je)i=e;else{i=new Je;try{i.load(e)}catch{}}const s=this.viewer,r=this.pathSolver,o=this.solverParams,a=i.version>800,l=a?".dds":".blp";let c=!1;this.reforged=a,this.name=i.name;const d=i.extent;this.bounds.fromExtents(d.min,d.max);for(const g of i.sequences)this.sequences.push(new Vl(g));for(const g of i.globalSequences)this.globalSequences.push(g);for(const g of i.textureAnimations)this.textureAnimations.push(new Xl(this,g));let h=0;for(const g of i.materials){const m=[];for(const w of g.layers){const b=new Yl(this,w,h++,g.priorityPlane);m.push(b),this.layers.push(b)}this.materials.push(new Zl(this,g.shader,m)),g.shader!==""&&(this.hd=!0)}a&&(o.reforged=!0),this.hd&&(o.hd=!0);const u=i.textures;for(let g=0,m=u.length;g<m;g++){const w=u[g];let b=w.path;const v=w.replaceableId,_=w.wrapMode;b===""&&v!==0&&(b=`ReplaceableTextures\\${Ms[v]}${l}`,(v===1||v===2)&&(c=!0));const x=new Pt(v,_);s.load(b,r,o).then(T=>{T&&(x.texture=T)}),this.textures[g]=x}for(const g of i.geosetAnimations)this.geosetAnimations.push(new Ql(this,g));this.pivotPoints=i.pivotPoints;let p=0;for(const g of i.bones)this.bones.push(new Jl(this,g,p++));for(const g of i.lights)this.lights.push(new ec(this,g,p++));for(const g of i.helpers)this.helpers.push(new tc(this,g,p++));for(const g of i.attachments)this.attachments.push(new ic(this,g,p++));for(const g of i.particleEmitters)this.particleEmitters.push(new nc(this,g,p++));for(const g of i.particleEmitters2){const m=new Xs(this,g,p++);this.particleEmitters2.push(m),m.teamColored&&(c=!0)}for(const g of i.ribbonEmitters)this.ribbonEmitters.push(new Ws(this,g,p++));for(const g of i.cameras)this.cameras.push(new vc(this,g));for(const g of i.eventObjects)this.eventObjects.push(new yc(this,g,p++));for(const g of i.collisionShapes)this.collisionShapes.push(new Ac(this,g,p++));this.genericObjects.push(...this.bones,...this.lights,...this.helpers,...this.attachments,...this.particleEmitters,...this.particleEmitters2,...this.ribbonEmitters,...this.eventObjects,...this.collisionShapes),xc(this,i.geosets),Sc(this),this.setupHierarchy(-1);for(let g=0,m=this.genericObjects.length;g<m;g++)this.sortedGenericObjects[g]=this.genericObjects[this.hierarchy[g]];c&&pi.loadTeamTextures(s)}addInstance(){return new Yc(this)}setupHierarchy(e){for(let t=0,i=this.genericObjects.length;t<i;t++){const s=this.genericObjects[t];s.parentId===e&&(this.hierarchy.push(t),this.setupHierarchy(s.objectId))}}}const yr=`
uniform sampler2D u_boneMap;
uniform float u_vectorSize;
uniform float u_rowSize;

mat4 fetchMatrix(float column, float row) {
  column *= u_vectorSize * 4.0;
  row *= u_rowSize;
  // Add in half a texel, to sample in the middle of the texel.
  // Otherwise, since the sample is directly on the boundary, floating point errors can cause the sample to get the wrong pixel.
  // This is most noticeable with NPOT textures, which the bone maps are.
  column += 0.5 * u_vectorSize;
  row += 0.5 * u_rowSize;

  return mat4(texture2D(u_boneMap, vec2(column, row)),
              texture2D(u_boneMap, vec2(column + u_vectorSize, row)),
              texture2D(u_boneMap, vec2(column + u_vectorSize * 2.0, row)),
              texture2D(u_boneMap, vec2(column + u_vectorSize * 3.0, row)));
}
`,Ar=`
#ifdef SKIN
attribute vec4 a_bones;
attribute vec4 a_weights;

void transformSkin(inout vec3 position, inout vec3 normal, inout vec3 tangent, inout vec3 binormal) {
  mat4 bone;

  bone += fetchMatrix(a_bones[0], 0.0) * a_weights[0];
  bone += fetchMatrix(a_bones[1], 0.0) * a_weights[1];
  bone += fetchMatrix(a_bones[2], 0.0) * a_weights[2];
  bone += fetchMatrix(a_bones[3], 0.0) * a_weights[3];

  mat3 rotation = mat3(bone);

  position = vec3(bone * vec4(position, 1.0));
  normal = rotation * normal;
  tangent = rotation * tangent;
  binormal = rotation * binormal;
}
#else
attribute vec4 a_bones;
#ifdef EXTENDED_BONES
attribute vec4 a_extendedBones;
#endif
attribute float a_boneNumber;

mat4 getVertexGroupMatrix() {
  mat4 bone;

  // For the broken models out there, since the game supports this.
  if (a_boneNumber > 0.0) {
    for (int i = 0; i < 4; i++) {
      if (a_bones[i] > 0.0) {
        bone += fetchMatrix(a_bones[i] - 1.0, 0.0);
      }
    }

    #ifdef EXTENDED_BONES
      for (int i = 0; i < 4; i++) {
        if (a_extendedBones[i] > 0.0) {
          bone += fetchMatrix(a_extendedBones[i] - 1.0, 0.0);
        }
      }
    #endif
  }

  return bone / a_boneNumber;
}

void transformVertexGroups(inout vec3 position, inout vec3 normal) {
  mat4 bone = getVertexGroupMatrix();
  mat3 rotation = mat3(bone);

  position = vec3(bone * vec4(position, 1.0));
  normal = normalize(rotation * normal);
}

void transformVertexGroupsHD(inout vec3 position, inout vec3 normal, inout vec3 tangent, inout vec3 binormal) {
  mat4 bone = getVertexGroupMatrix();
  mat3 rotation = mat3(bone);

  position = vec3(bone * vec4(position, 1.0));
  normal = normalize(rotation * normal);
  tangent = normalize(rotation * tangent);
  binormal = normalize(rotation * binormal);
}
#endif
`,dt=`
uniform mat4 u_VP;
uniform vec3 u_lightPos;
uniform vec4 u_vertexColor;
uniform vec4 u_geosetColor;
uniform float u_layerAlpha;
uniform vec2 u_uvTrans;
uniform vec2 u_uvRot;
uniform float u_uvScale;
uniform bool u_hasBones;

attribute vec3 a_position;
attribute vec3 a_normal;
attribute vec2 a_uv;

varying vec2 v_uv;
varying vec3 v_normal;
varying vec4 v_color;
varying vec4 v_uvTransRot;
varying float v_uvScale;
varying vec3 v_lightDir;

${yr}
${Ar}

void main() {
  vec3 position = a_position;
  vec3 normal = a_normal;

  if (u_hasBones) {
    #ifdef SKIN
      vec3 tangent = vec3(0.0);
      vec3 binormal = vec3(0.0);
      transformSkin(position, normal, tangent, binormal);
    #else
      transformVertexGroups(position, normal);
    #endif
  }

  v_uv = a_uv;
  v_normal = normal;
  v_color = u_vertexColor * u_geosetColor.bgra * vec4(1.0, 1.0, 1.0, u_layerAlpha);
  v_uvTransRot = vec4(u_uvTrans, u_uvRot);
  v_uvScale = u_uvScale;
  v_lightDir = normalize(u_lightPos - position);

  gl_Position = u_VP * vec4(position, 1.0);
}
`,nn=`
#ifdef GL_FRAGMENT_PRECISION_HIGH
precision highp float;
#else
precision mediump float;
#endif
`,ft=`
${nn}


// A 2D quaternion*vector.
// q is the zw components of the original quaternion.
vec2 quat_transform(vec2 q, vec2 v) {
  vec2 uv = vec2(-q.x * v.y, q.x * v.x);
  vec2 uuv = vec2(-q.x * uv.y, q.x * uv.x);

  return v + 2.0 * (uv * q.y + uuv);
}


uniform sampler2D u_texture;
uniform float u_filterMode;
uniform bool u_unshaded;

varying vec2 v_uv;
varying vec3 v_normal;
varying vec4 v_color;
varying vec4 v_uvTransRot;
varying float v_uvScale;
varying vec3 v_lightDir;

vec4 getDiffuseColor() {
  vec2 uv = v_uv;

  // Translation animation
  uv += v_uvTransRot.xy;

  // Rotation animation
  uv = quat_transform(v_uvTransRot.zw, uv - 0.5) + 0.5;

  // Scale animation
  uv = v_uvScale * (uv - 0.5) + 0.5;

  vec4 texel = texture2D(u_texture, uv);
  vec4 color = texel * v_color;

  // 1bit Alpha
  if (u_filterMode == 1.0 && color.a < 0.75) {
    discard;
  }

  // "Close to 0 alpha"
  if (u_filterMode >= 5.0 && color.a < 0.02) {
    discard;
  }

  return color;
}

void onlyTexCoords() {
  gl_FragColor = vec4(v_uv, 0.0, 1.0);
}

void onlyNormals() {
  gl_FragColor = vec4(v_normal, 1.0);
}

void onlyDiffuse() {
  gl_FragColor = getDiffuseColor();
}

void lambert() {
  vec4 color = getDiffuseColor();

  if (!u_unshaded) {
    float lambertFactor = clamp(dot(v_normal, v_lightDir), 0.0, 1.0);
    lambertFactor = clamp(lambertFactor + 0.7, 0.0, 1.0);

    color.rgb *= lambertFactor;
  }

  gl_FragColor = color;
}

void main() {
  #if defined(ONLY_DIFFUSE)
  onlyDiffuse();
  #elif defined(ONLY_TEXCOORDS)
  onlyTexCoords();
  #elif defined(ONLY_NORMALS)
  onlyNormals();
  #else
  lambert();
  #endif
}
`,ue=`
uniform mat4 u_VP;
uniform mat4 u_MV;
uniform vec3 u_eyePos;
uniform vec3 u_lightPos;
uniform float u_layerAlpha;
uniform bool u_hasBones;

attribute vec3 a_position;
attribute vec3 a_normal;
attribute vec2 a_uv;
attribute vec4 a_tangent;

varying vec2 v_uv;
varying float v_layerAlpha;
varying vec3 v_lightDir;
varying vec3 v_eyeVec;
varying vec3 v_normal;
// varying vec3 v_lightDirWorld;

#if defined(ONLY_TANGENTS)
varying vec3 v_tangent;
#endif

${yr}
${Ar}

vec3 TBN(vec3 vector, vec3 tangent, vec3 binormal, vec3 normal) {
  return vec3(dot(vector, tangent), dot(vector, binormal), dot(vector, normal));
}

void main() {
  vec3 position = a_position;
  vec3 normal = a_normal;
  vec3 tangent = a_tangent.xyz;

  // Re-orthogonalize the tangent in case it wasnt normalized.
  // See "One last thing" at https://learnopengl.com/Advanced-Lighting/Normal-Mapping
  tangent = normalize(tangent - dot(tangent, normal) * normal);

  vec3 binormal = cross(normal, tangent) * a_tangent.w;

  if (u_hasBones) {
    #ifdef SKIN
      transformSkin(position, normal, tangent, binormal);
    #else
      transformVertexGroupsHD(position, normal, tangent, binormal);
    #endif
  }

  vec3 position_mv = vec3(u_MV * vec4(position, 1));

  mat3 mv = mat3(u_MV);
  vec3 t = normalize(mv * tangent);
  vec3 b = normalize(mv * binormal);
  vec3 n = normalize(mv * normal);

  v_eyeVec = normalize(u_eyePos - position_mv);

  vec3 lightDir = normalize(u_lightPos - position_mv);
  v_lightDir = normalize(TBN(lightDir, t, b, n));
  
  v_uv = a_uv;
  v_layerAlpha = u_layerAlpha;

  v_normal = normal;
  // v_lightDirWorld = normalize(lightDir);

  #if defined(ONLY_TANGENTS)
  v_tangent = tangent;
  #endif

  gl_Position = u_VP * vec4(position, 1.0);
}
`,pe=`
${nn}

uniform sampler2D u_diffuseMap;
uniform sampler2D u_normalsMap;
uniform sampler2D u_ormMap;
uniform sampler2D u_emissiveMap;
uniform sampler2D u_teamColorMap;
uniform sampler2D u_environmentMap;
uniform float u_filterMode;

// uniform sampler2D u_lutMap;
// uniform sampler2D u_envDiffuseMap;
// uniform sampler2D u_envSpecularMap;

varying vec2 v_uv;
varying float v_layerAlpha;
varying vec3 v_lightDir;
varying vec3 v_eyeVec;
varying vec3 v_normal;
// varying vec3 v_lightDirWorld;

#if defined(ONLY_TANGENTS)
varying vec3 v_tangent;
#endif

vec3 decodeNormal() {
  vec2 xy = texture2D(u_normalsMap, v_uv).xy * 2.0 - 1.0;
  
  return vec3(xy, sqrt(1.0 - dot(xy, xy)));
}

const vec2 invAtan = vec2(0.1591, 0.3183);
vec2 sampleEnvironmentMap(vec3 normal) {
  vec2 uv = vec2(atan(normal.x, normal.y), -asin(normal.z));
  uv *= invAtan;
  uv += 0.5;
  return uv;
}

vec4 getDiffuseColor() {
  vec4 color = texture2D(u_diffuseMap, v_uv);

  // 1bit Alpha
  if (u_filterMode == 1.0 && color.a < 0.75) {
    discard;
  }

  return color;
}

vec4 getOrmColor() {
  return texture2D(u_ormMap, v_uv);
}

vec3 getEmissiveColor() {
  return texture2D(u_emissiveMap, v_uv).rgb;
}

vec3 getTeamColor() {
  return texture2D(u_teamColorMap, v_uv).rgb;
}

// const float PI = 3.14159265359;
// const float RECIPROCAL_PI = 0.31830988618;
// const float RECIPROCAL_PI2 = 0.15915494;
// const float LN2 = 0.6931472;
// const float ENV_LODS = 6.0;
// vec4 SRGBtoLinear(vec4 srgb) {
//     vec3 linOut = pow(srgb.xyz, vec3(2.2));
//     return vec4(linOut, srgb.w);;
// }
// vec4 RGBMToLinear(in vec4 value) {
//     float maxRange = 6.0;
//     return vec4(value.xyz * value.w * maxRange, 1.0);
// }
// vec3 linearToSRGB(vec3 color) {
//     return pow(color, vec3(1.0 / 2.2));
// }
// // vec3 getNormal() {
// //     vec3 pos_dx = dFdx(vMPos.xyz);
// //     vec3 pos_dy = dFdy(vMPos.xyz);
// //     vec2 tex_dx = dFdx(vUv);
// //     vec2 tex_dy = dFdy(vUv);
// //     vec3 t = normalize(pos_dx * tex_dy.t - pos_dy * tex_dx.t);
// //     vec3 b = normalize(-pos_dx * tex_dy.s + pos_dy * tex_dx.s);
// //     mat3 tbn = mat3(t, b, normalize(vNormal));
// //     vec3 n = texture2D(tNormal, vUv * uNormalUVScale).rgb * 2.0 - 1.0;
// //     n.xy *= uNormalScale;
// //     vec3 normal = normalize(tbn * n);
// //     // Get world normal from view normal (normalMatrix * normal)
// //     return normalize((vec4(normal, 0.0) * viewMatrix).xyz);
// // }
// vec3 specularReflection(vec3 specularEnvR0, vec3 specularEnvR90, float VdH) {
//     return specularEnvR0 + (specularEnvR90 - specularEnvR0) * pow(clamp(1.0 - VdH, 0.0, 1.0), 5.0);
// }
// float geometricOcclusion(float NdL, float NdV, float roughness) {
//     float r = roughness;
//     float attenuationL = 2.0 * NdL / (NdL + sqrt(r * r + (1.0 - r * r) * (NdL * NdL)));
//     float attenuationV = 2.0 * NdV / (NdV + sqrt(r * r + (1.0 - r * r) * (NdV * NdV)));
//     return attenuationL * attenuationV;
// }
// float microfacetDistribution(float roughness, float NdH) {
//     float roughnessSq = roughness * roughness;
//     float f = (NdH * roughnessSq - NdH) * NdH + 1.0;
//     return roughnessSq / (PI * f * f);
// }
// vec2 cartesianToPolar(vec3 n) {
//     vec2 uv;
//     uv.x = atan(n.z, n.x) * RECIPROCAL_PI2 + 0.5;
//     uv.y = asin(n.y) * RECIPROCAL_PI + 0.5;
//     return uv;
// }
// void getIBLContribution(inout vec3 diffuse, inout vec3 specular, float NdV, float roughness, vec3 n, vec3 reflection, vec3 diffuseColor, vec3 specularColor) {
//   vec3 brdf = SRGBtoLinear(texture2D(u_lutMap, vec2(NdV, roughness))).rgb;
//   vec3 diffuseLight = RGBMToLinear(texture2D(u_envDiffuseMap, sampleEnvironmentMap(n))).rgb;
//   // Sample 2 levels and mix between to get smoother degradation
//   float blend = roughness * ENV_LODS;
//   float level0 = floor(blend);
//   float level1 = min(ENV_LODS, level0 + 1.0);
//   blend -= level0;
  
//   // Sample the specular env map atlas depending on the roughness value
//   vec2 uvSpec = sampleEnvironmentMap(reflection);
//   uvSpec.y /= 2.0;
//   vec2 uv0 = uvSpec;
//   vec2 uv1 = uvSpec;
//   uv0 /= pow(2.0, level0);
//   uv0.y += 1.0 - exp(-LN2 * level0);
//   uv1 /= pow(2.0, level1);
//   uv1.y += 1.0 - exp(-LN2 * level1);
//   vec3 specular0 = RGBMToLinear(texture2D(u_envSpecularMap, uv0)).rgb;
//   vec3 specular1 = RGBMToLinear(texture2D(u_envSpecularMap, uv1)).rgb;
//   vec3 specularLight = mix(specular0, specular1, blend);
//   diffuse = diffuseLight * diffuseColor;
  
//   // Bit of extra reflection for smooth materials
//   float reflectivity = pow((1.0 - roughness), 2.0) * 0.05;
//   specular = specularLight * (specularColor * brdf.x + brdf.y + reflectivity);
//   // specular *= uEnvSpecular;
// }

// void PBR() {
//   vec4 baseDiffuseColor = getDiffuseColor();
//   vec3 baseColor = baseDiffuseColor.rgb;
//   vec4 orm = getOrmColor();
//   vec3 tc = getTeamColor();
//   float tcFactor = getOrmColor().a;

//   if (tcFactor > 0.1) {
//     baseColor *= tc * tcFactor;
//   }

//   float roughness = clamp(orm.g, 0.04, 1.0);
//   float metallic = clamp(orm.b, 0.04, 1.0);

//   vec3 f0 = vec3(0.04);
//   vec3 diffuseColor = baseColor * (vec3(1.0) - f0) * (1.0 - metallic);
//   vec3 specularColor = mix(f0, baseColor, metallic);
//   vec3 specularEnvR0 = specularColor;
//   vec3 specularEnvR90 = vec3(clamp(max(max(specularColor.r, specularColor.g), specularColor.b) * 25.0, 0.0, 1.0));

//   vec3 N = v_normal;
//   vec3 V = normalize(v_eyeVec);
//   vec3 L = normalize(v_lightDirWorld);
//   vec3 H = normalize(L + V);
//   vec3 reflection = normalize(reflect(-V, N));

//   float NdL = clamp(dot(N, L), 0.001, 1.0);
//   float NdV = clamp(abs(dot(N, V)), 0.001, 1.0);
//   float NdH = clamp(dot(N, H), 0.0, 1.0);
//   float LdH = clamp(dot(L, H), 0.0, 1.0);
//   float VdH = clamp(dot(V, H), 0.0, 1.0);

//   vec3 F = specularReflection(specularEnvR0, specularEnvR90, VdH);
//   float G = geometricOcclusion(NdL, NdV, roughness);
//   float D = microfacetDistribution(roughness, NdH);

//   vec3 diffuseContrib = (1.0 - F) * (diffuseColor / PI);
//   vec3 specContrib = F * G * D / (4.0 * NdL * NdV);
  
//   // Shading based off lights
//   // vec3 color = NdL * uLightColor * (diffuseContrib + specContrib);
//   vec3 color = NdL * (diffuseContrib + specContrib);

//   // Calculate IBL lighting
//   vec3 diffuseIBL;
//   vec3 specularIBL;
//   getIBLContribution(diffuseIBL, specularIBL, NdV, roughness, N, reflection, diffuseColor, specularColor);

//   // Add IBL on top of color
//   color +=  specularIBL;

//   color *= orm.r;

//   color += getEmissiveColor();

//   // Convert to sRGB to display
//   gl_FragColor.rgb = color;
//   gl_FragColor.a = baseDiffuseColor.a;
// }

void onlyDiffuse() {
  vec4 baseColor = getDiffuseColor();
  vec3 tc = getTeamColor();
  float tcFactor = getOrmColor().a;

  if (tcFactor > 0.1) {
    baseColor.rgb *= tc * tcFactor;
  }

  gl_FragColor = baseColor;
}

void onlyNormalMap() {
  gl_FragColor = vec4(decodeNormal(), 1.0);
}

void onlyOcclusion() {
  gl_FragColor = vec4(getOrmColor().rrr, 1.0);
}

void onlyRoughness() {
  gl_FragColor = vec4(getOrmColor().ggg, 1.0);
}

void onlyMetallic() {
  gl_FragColor = vec4(getOrmColor().bbb, 1.0);
}

void onlyTeamColorFactor() {
  gl_FragColor = vec4(getOrmColor().aaa, 1.0);
}

void onlyEmissiveMap() {
  gl_FragColor = vec4(getEmissiveColor(), 1.0);
}

void onlyTexCoords() {
  gl_FragColor = vec4(v_uv, 0.0, 1.0);
}

void onlyNormals() {
  gl_FragColor = vec4(v_normal, 1.0);
}

#if defined(ONLY_TANGENTS)
void onlyTangents() {
  gl_FragColor = vec4(v_tangent, 1.0);
}
#endif

void lambert() {
  vec4 baseColor = getDiffuseColor();
  vec3 normal = decodeNormal();
  vec4 orm = getOrmColor();
  vec3 emissive = getEmissiveColor();
  vec3 tc = getTeamColor();
  float aoFactor = orm.r;
  float tcFactor = orm.a;
  float lambertFactor = clamp(dot(normal, v_lightDir), 0.0, 1.0);
  vec3 color = baseColor.rgb;

  if (tcFactor > 0.1) {
    color *= tc * tcFactor;
  }
  
  color *= clamp(lambertFactor * aoFactor + 0.1, 0.0, 1.0);
  color += emissive;

  gl_FragColor = vec4(color, baseColor.a);
}

void main() {
  #if defined(ONLY_DIFFUSE)
  onlyDiffuse();
  #elif defined(ONLY_NORMAL_MAP)
  onlyNormalMap();
  #elif defined(ONLY_OCCLUSION)
  onlyOcclusion();
  #elif defined(ONLY_ROUGHNESS)
  onlyRoughness();
  #elif defined(ONLY_METALLIC)
  onlyMetallic();
  #elif defined(ONLY_TC_FACTOR)
  onlyTeamColorFactor();
  #elif defined(ONLY_EMISSIVE)
  onlyEmissiveMap();
  #elif defined(ONLY_TEXCOORDS)
  onlyTexCoords();
  #elif defined(ONLY_NORMALS)
  onlyNormals();
  #elif defined(ONLY_TANGENTS)
  onlyTangents();
  #else
  lambert();
  #endif
}
`,Zc=`
#define EMITTER_PARTICLE2 0
#define EMITTER_RIBBON 1
#define EMITTER_SPLAT 2
#define EMITTER_UBERSPLAT 3
#define HEAD 0.0

uniform mat4 u_VP;
uniform int u_emitter;

// Shared
uniform vec4 u_colors[3];
uniform vec3 u_vertices[4];
uniform vec3 u_intervals[4];
uniform float u_lifeSpan;
uniform float u_columns;
uniform float u_rows;

// Particle2
uniform vec3 u_scaling;
uniform vec3 u_cameraZ;
uniform float u_timeMiddle;
uniform bool u_teamColored;

// Splat and Uber.
uniform vec3 u_intervalTimes;

// Vertices
attribute float a_position;

// Instances
attribute vec3 a_p0;
attribute vec3 a_p1;
attribute vec3 a_p2;
attribute vec3 a_p3;
attribute float a_health;
attribute vec4 a_color;
attribute float a_tail;
attribute vec3 a_leftRightTop;

varying vec2 v_texcoord;
varying vec4 v_color;

float getCell(vec3 interval, float factor) {
  float start = interval[0];
  float end = interval[1];
  float repeat = interval[2];
  float spriteCount = end - start;

  if (spriteCount > 0.0) {
    // Repeating speeds up the sprite animation, which makes it effectively run N times in its interval.
    // E.g. if repeat is 4, the sprite animation will be seen 4 times, and thus also run 4 times as fast.
    // The sprite index is limited to the number of actual sprites.
    return min(start + mod(floor(spriteCount * repeat * factor), spriteCount), u_columns * u_rows - 1.0);
  }

  return start;
}

void particle2() {
  float factor = (u_lifeSpan - a_health) / u_lifeSpan;
  int index = 0;

  if (factor < u_timeMiddle) {
    factor = factor / u_timeMiddle;
    index = 0;
  } else {
    factor = (factor - u_timeMiddle) / (1.0 - u_timeMiddle);
    index = 1;
  }

  factor = min(factor, 1.0);

  float scale = mix(u_scaling[index], u_scaling[index + 1], factor);
  vec4 color = mix(u_colors[index], u_colors[index + 1], factor);

  float cell = 0.0;

  if (u_teamColored) {
    cell = a_leftRightTop[0];
  } else {
    vec3 interval;

    if (a_tail == HEAD) {
      interval = u_intervals[index];
    } else {
      interval = u_intervals[index + 2];
    }

    cell = getCell(interval, factor);
  }

  float left = floor(mod(cell, u_columns));
  float top = floor(cell / u_columns);
  float right = left + 1.0;
  float bottom = top + 1.0;

  left /= u_columns;
  right /= u_columns;
  top /= u_rows;
  bottom /= u_rows;

  if (a_position == 0.0) {
    v_texcoord = vec2(right, top);
  } else if (a_position == 1.0) {
    v_texcoord = vec2(left, top);
  } else if (a_position == 2.0) {
    v_texcoord = vec2(left, bottom);
  } else if (a_position == 3.0) {
    v_texcoord = vec2(right, bottom);
  }

  v_color = color;
  
  if (a_tail == HEAD) {
    vec3 v = u_vertices[int(a_position)];
    float cs = cos(a_p1.x);
    float sn = sin(a_p1.x);

    float x = v.x * cs - v.y * sn;
    float y = v.x * sn + v.y * cs;

    vec3 fv = vec3(
      v.x * cs - v.y * sn,
      v.x * sn + v.y * cs,
      v.z);

    gl_Position = u_VP * vec4(a_p0 + fv * scale, 1.0);
  } else {
    // Get the normal to the tail in camera space.
    // This allows to build a 2D rectangle around the 3D tail.
    vec3 normal = cross(u_cameraZ, normalize(a_p1 - a_p0));
    vec3 boundary = normal * scale * a_p2[0];
    vec3 position;

    if (a_position == 0.0) {
      position = a_p0 - boundary;
    } else if (a_position == 1.0) {
      position = a_p1 - boundary;
    } else if (a_position == 2.0) {
      position = a_p1 + boundary;
    } else if (a_position == 3.0) {
      position = a_p0 + boundary;
    }

    gl_Position = u_VP * vec4(position, 1.0);
  }
}

void ribbon() {
  vec3 position;
  float left = a_leftRightTop[0] / 255.0;
  float right = a_leftRightTop[1] / 255.0;
  float top = a_leftRightTop[2] / 255.0;
  float bottom = top + 1.0;

  if (a_position == 0.0) {
    v_texcoord = vec2(right, top);
    position = a_p0;
  } else if (a_position == 1.0) {
    v_texcoord = vec2(right, bottom);
    position = a_p1;
  } else if (a_position == 2.0) {
    v_texcoord = vec2(left, bottom);
    position = a_p2;
  } else if (a_position == 3.0) {
    v_texcoord = vec2(left, top);
    position = a_p3;
  }

  v_texcoord[0] /= u_columns;
  v_texcoord[1] /= u_rows;

  v_color = a_color;

  gl_Position = u_VP * vec4(position, 1.0);
}

void splat() {
  float factor = u_lifeSpan - a_health;
  int index;

  if (factor < u_intervalTimes[0]) {
    factor = factor / u_intervalTimes[0];
    index = 0;
  } else {
    factor = (factor - u_intervalTimes[0]) / u_intervalTimes[1];
    index = 1;
  }

  float cell = getCell(u_intervals[index], factor);
  float left = floor(mod(cell, u_columns));
  float top = floor(cell / u_columns);
  float right = left + 1.0;
  float bottom = top + 1.0;
  vec3 position;

  if (a_position == 0.0) {
    v_texcoord = vec2(left, top);
    position = a_p0;
  } else if (a_position == 1.0) {
    v_texcoord = vec2(left, bottom);
    position = a_p1;
  } else if (a_position == 2.0) {
    v_texcoord = vec2(right, bottom);
    position = a_p2;
  } else if (a_position == 3.0) {
    v_texcoord = vec2(right, top);
    position = a_p3;
  }

  v_texcoord[0] /= u_columns;
  v_texcoord[1] /= u_rows;

  v_color = mix(u_colors[index], u_colors[index + 1], factor) / 255.0;

  gl_Position = u_VP * vec4(position, 1.0);
}

void ubersplat() {
  float factor = u_lifeSpan - a_health;
  vec4 color;

  if (factor < u_intervalTimes[0]) {
    color = mix(u_colors[0], u_colors[1], factor / u_intervalTimes[0]);
  } else if (factor < u_intervalTimes[0] + u_intervalTimes[1]) {
    color = u_colors[1];
  } else {
    color = mix(u_colors[1], u_colors[2], (factor - u_intervalTimes[0] - u_intervalTimes[1]) / u_intervalTimes[2]);
  }

  vec3 position;

  if (a_position == 0.0) {
    v_texcoord = vec2(0.0, 0.0);
    position = a_p0;
  } else if (a_position == 1.0) {
    v_texcoord = vec2(0.0, 1.0);
    position = a_p1;
  } else if (a_position == 2.0) {
    v_texcoord = vec2(1.0, 1.0);
    position = a_p2;
  } else if (a_position == 3.0) {
    v_texcoord = vec2(1.0, 0.0);
    position = a_p3;
  }

  v_color = color / 255.0;

  gl_Position = u_VP * vec4(position, 1.0);
}

void main() {
  if (u_emitter == EMITTER_PARTICLE2) {
    particle2();
  } else if (u_emitter == EMITTER_RIBBON) {
    ribbon();
  } else if (u_emitter == EMITTER_SPLAT) {
    splat();
  } else if (u_emitter == EMITTER_UBERSPLAT) {
    ubersplat();
  }
}
`,Qc=`
${nn}

#define EMITTER_PARTICLE2 0
#define EMITTER_RIBBON 1

uniform sampler2D u_texture;
uniform highp int u_emitter;
uniform float u_filterMode;

varying vec2 v_texcoord;
varying vec4 v_color;

void main() {
  vec4 texel = texture2D(u_texture, v_texcoord);
  vec4 color = texel * v_color;

  // 1bit Alpha, used by ribbon emitters.
  if (u_emitter == EMITTER_RIBBON && u_filterMode == 1.0 && color.a < 0.75) {
    discard;
  }

  // "Close to 0 alpha"
  if (u_emitter == EMITTER_PARTICLE2 && (u_filterMode == 2.0 || u_filterMode == 3.0) && color.a < 0.02) {
    discard;
  }

  // Alpha key.
  if (u_emitter == EMITTER_PARTICLE2 && (u_filterMode == 4.0) && color.a < 0.75) {
    discard;
  }

  gl_FragColor = color;
}
`,Jc=n=>new Dl(n),eh=n=>Nl(n),pi={load(n,e,t=!1){const i=n.gl,s=n.webgl;if(!s.ensureExtension("OES_texture_float"))throw new Error("MDX: No float texture support!");if(!s.ensureExtension("ANGLE_instanced_arrays"))throw new Error("MDX: No instanced rendering support!");const r=`#define EXTENDED_BONES
`+dt,o=`#define ONLY_DIFFUSE
`+ft,a=`#define ONLY_TEXCOORDS
`+ft,l=`#define ONLY_NORMALS
`+ft,c=`#define EXTENDED_BONES
`+ue,d=`#define SKIN
`+ue,h=`#define ONLY_DIFFUSE
`+pe,u=`#define ONLY_NORMAL_MAP
`+pe,p=`#define ONLY_OCCLUSION
`+pe,g=`#define ONLY_ROUGHNESS
`+pe,m=`#define ONLY_METALLIC
`+pe,w=`#define ONLY_TC_FACTOR
`+pe,b=`#define ONLY_EMISSIVE
`+pe,v=`#define ONLY_TEXCOORDS
`+pe,_=`#define ONLY_NORMALS
`+pe,x=`#define ONLY_TANGENTS
`+pe,T=s.createShader(dt,ft),y=s.createShader(r,ft),N=`#define SKIN
`+dt,D=s.createShader(N,ft),j=s.createShader(ue,pe),q=s.createShader(c,pe),ce=s.createShader(d,pe),P=s.createShader(Zc,Qc),z=[],V=[];let S=[];S[R.Diffuse]=s.createShader(dt,o),S[R.TexCoords]=s.createShader(dt,a),S[R.Normals]=s.createShader(dt,l),z[ee.VertexGroups]=S,S=[],S[R.Diffuse]=s.createShader(r,o),S[R.TexCoords]=s.createShader(r,a),S[R.Normals]=s.createShader(r,l),z[ee.ExtendedVertexGroups]=S,S=[],S[R.Diffuse]=s.createShader(ue,h),S[R.NormalMap]=s.createShader(ue,u),S[R.Occlusion]=s.createShader(ue,p),S[R.Roughness]=s.createShader(ue,g),S[R.Metallic]=s.createShader(ue,m),S[R.TCFactor]=s.createShader(ue,w),S[R.Emissive]=s.createShader(ue,b),S[R.TexCoords]=s.createShader(ue,v),S[R.Normals]=s.createShader(ue,_),S[R.Tangents]=s.createShader(`#define ONLY_TANGENTS
`+ue,x),V[ee.VertexGroups]=S,S=[],S[R.Diffuse]=s.createShader(c,h),S[R.NormalMap]=s.createShader(c,u),S[R.Occlusion]=s.createShader(c,p),S[R.Roughness]=s.createShader(c,g),S[R.Metallic]=s.createShader(c,m),S[R.TCFactor]=s.createShader(c,w),S[R.Emissive]=s.createShader(c,b),S[R.TexCoords]=s.createShader(c,v),S[R.Normals]=s.createShader(c,_),S[R.Tangents]=s.createShader(`#define ONLY_TANGENTS
`+c,x),V[ee.ExtendedVertexGroups]=S,S=[],S[R.Diffuse]=s.createShader(d,h),S[R.NormalMap]=s.createShader(d,u),S[R.Occlusion]=s.createShader(d,p),S[R.Roughness]=s.createShader(d,g),S[R.Metallic]=s.createShader(d,m),S[R.TCFactor]=s.createShader(d,w),S[R.Emissive]=s.createShader(d,b),S[R.TexCoords]=s.createShader(d,v),S[R.Normals]=s.createShader(d,_),S[R.Tangents]=s.createShader(`#define ONLY_TANGENTS
`+d,x),V[ee.Skin]=S;const $=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,$),i.bufferData(i.ARRAY_BUFFER,new Uint8Array([0,1,2,0,2,3]),i.STATIC_DRAW);const C={pathSolver:e,reforged:t,sdShader:T,sdSkinShader:D,sdExtendedShader:y,hdShader:j,hdExtendedShader:q,hdSkinShader:ce,particlesShader:P,sdDebugShaders:z,hdDebugShaders:V,rectBuffer:$,teamColors:[],teamGlows:[],eventObjectTables:{}};n.sharedCache.set("mdx",C)},isValidSource(n){return n instanceof Je?!0:os(n)||as(n)},resource:vr,loadTeamTextures(n){const{pathSolver:e,reforged:t,teamColors:i,teamGlows:s}=n.sharedCache.get("mdx");if(i.length===0){const r=t?28:16,o=t?"dds":"blp",a=t?{reforged:!0}:void 0;for(let l=0;l<r;l++){const d=`${`${l}`.padStart(2,"0")}.${o}`,h=new Pt(1,Ke.WrapBoth),u=new Pt(2,Ke.WrapBoth);n.load(`ReplaceableTextures\\TeamColor\\TeamColor${d}`,e,a).then(p=>h.texture=p),n.load(`ReplaceableTextures\\TeamGlow\\TeamGlow${d}`,e,a).then(p=>u.texture=p),i[l]=h,s[l]=u}}},getEventObjectSoundFile(n,e,t,i){if(!e||ze(n)===".flac")return n;for(let s=1,r=i.length;s<r;s++){const o=i[s].data.getRow(n);if(o){const a=o.string("Flags"),l=o.string("Filepath");if(a==="SD_ONLY"){if(!t)return l}else if(a==="HD_ONLY"){if(t)return l}else return l}}},async getEventObjectData(n,e,t,i){if(e!=="SPN"&&e!=="SPL"&&e!=="UBR"&&e!=="SND")return;const{pathSolver:s,reforged:r,eventObjectTables:o}=n.sharedCache.get("mdx"),a=r?{reforged:!0}:{},l=(p,g)=>s?s(p,g):p;if(!o[e]){const p=[];e==="SPN"?p.push("Splats\\SpawnData.slk"):e==="SPL"?p.push("Splats\\SplatData.slk"):e==="UBR"?p.push("Splats\\UberSplatData.slk"):e==="SND"&&(p.push("UI\\SoundInfo\\AnimSounds.slk"),r?p.push("UI\\SoundInfo\\DialogueHumanBase.slk","UI\\SoundInfo\\DialogueOrcBase.slk","UI\\SoundInfo\\DialogueUndeadBase.slk","UI\\SoundInfo\\DialogueNightElfBase.slk","UI\\SoundInfo\\DialogueNagaBase.slk","UI\\SoundInfo\\DialogueDemonBase.slk","UI\\SoundInfo\\DialogueCreepsBase.slk"):p.push("UI\\SoundInfo\\AnimLookups.slk"));const g=p.map(w=>n.loadGeneric(l(w,a),"text",Jc)),m=await Promise.all(g);for(const w of m)if(!w)return;o[e]=m}const c=o[e],d=c[0].data;let h;const u=[];if(e==="SND"){if(r)h=d.findRow("AnimationEventCode",t);else{const p=c[1].data.getRow(t);p&&(h=d.getRow(p.string("SoundLabel")))}if(h)for(const p of h.string("FileNames").split(",")){const g=this.getEventObjectSoundFile(p,r,i,c);g&&u.push(n.loadGeneric(l(g,a),"arrayBuffer",eh))}}else h=d.getRow(t),h&&(e==="SPN"?u.push(n.load(h.string("Model").replace(".mdl",".mdx"),l,a)):(e==="SPL"||e==="UBR")&&u.push(n.load(`ReplaceableTextures\\Splats\\${h.string("file")}${r?".dds":".blp"}`,l,a)));if(h&&u.length){const g=(await Promise.all(u)).filter(m=>m);if(g.length)return{row:h,resources:g}}},getBatchShader(n,e,t){const i=n.sharedCache.get("mdx"),s=n.debugRenderMode;if(t){if(s!==R.None){const r=i.hdDebugShaders[e];if(r){const o=r[s];if(o)return o}}return e===ee.Skin?i.hdSkinShader:e===ee.VertexGroups?i.hdShader:i.hdExtendedShader}else{if(s!==R.None){const r=i.sdDebugShaders[e];if(r){const o=r[s];if(o)return o}}return e===ee.Skin?i.sdSkinShader:e===ee.VertexGroups?i.sdShader:i.sdExtendedShader}}};function th(n){return n instanceof ArrayBuffer&&(n=new Uint8Array(n)),n instanceof Uint8Array&&n[0]===66&&n[1]===76&&n[2]===80&&n[3]===49}class ih extends ot{constructor(e,t){super(t);let i;e instanceof At?i=e:(i=new At,i.load(e));const r=this.viewer.gl,o=r.createTexture();r.bindTexture(r.TEXTURE_2D,o),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR);const a=xe(i.width)&&xe(i.height);a||(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE));const l=i.mipmaps();if(l===1||i.fakeMipmaps()||!a){const c=i.getMipmap(0);r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,c)}else{r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR_MIPMAP_LINEAR);let c=i.width,d=i.height;for(let h=0;h<l;h++){const u=i.getMipmap(h);r.texImage2D(r.TEXTURE_2D,h,r.RGBA,c,d,0,r.RGBA,r.UNSIGNED_BYTE,u.data),c=Math.ceil(c/2),d=Math.ceil(d/2)}}this.width=i.width,this.height=i.height,this.webglResource=o}}const nh={isValidSource(n){return n instanceof At?!0:th(n)},resource:ih};function sh(n){return n instanceof ArrayBuffer&&(n=new Uint8Array(n)),n instanceof Uint8Array&&n[0]===68&&n[1]===68&&n[2]===83&&n[3]===32}class rh extends ot{constructor(e,t){super(t);let i;e instanceof Et?i=e:(i=new Et,i.load(e));const s=this.viewer,r=s.gl,a=s.webgl.extensions.WEBGL_compressed_texture_s3tc,l=i.format;let c=0;a&&(l===Ve?c=a.COMPRESSED_RGB_S3TC_DXT1_EXT:l===tt?c=a.COMPRESSED_RGBA_S3TC_DXT3_EXT:l===it&&(c=a.COMPRESSED_RGBA_S3TC_DXT5_EXT));const d=r.createTexture();this.width=i.width,this.height=i.height,this.webglResource=d,r.bindTexture(r.TEXTURE_2D,d);const h=i.mipmaps();(l===Ve||l===xt)&&r.pixelStorei(r.UNPACK_ALIGNMENT,2);for(let u=0;u<h;u++){const{width:p,height:g,data:m}=i.getMipmap(u,c!==0);c?r.compressedTexImage2D(r.TEXTURE_2D,u,c,p,g,0,m):l===Ve||l===tt||l===it?r.texImage2D(r.TEXTURE_2D,u,r.RGBA,p,g,0,r.RGBA,r.UNSIGNED_BYTE,m):r.texImage2D(r.TEXTURE_2D,u,r.LUMINANCE_ALPHA,p,g,0,r.LUMINANCE_ALPHA,r.UNSIGNED_BYTE,m)}r.pixelStorei(r.UNPACK_ALIGNMENT,4),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),h>1?r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR_MIPMAP_LINEAR):r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR)}}const oh={load(n){n.webgl.ensureExtension("WEBGL_compressed_texture_s3tc")||console.warn("DDS: No compressed textures support! This might reduce performance.")},isValidSource(n){return n instanceof Et?!0:sh(n)},resource:rh};function ah(n){return n instanceof ArrayBuffer&&(n=new Uint8Array(n)),!!(n instanceof Uint8Array&&on(n,"TRUEVISION-XFILE.\0",n.length-18))}class lh extends ot{constructor(e,t){super(t);let i;e instanceof St?i=e:(i=new St,i.load(e));const s=i.width,r=i.height,o=this.viewer.gl,a=o.createTexture();o.bindTexture(o.TEXTURE_2D,a),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,i.data),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,o.LINEAR),xe(s)&&xe(r)?(o.generateMipmap(o.TEXTURE_2D),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.LINEAR_MIPMAP_LINEAR)):o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.LINEAR),this.webglResource=a,this.width=s,this.height=r}}const ch={isValidSource(n){return n instanceof St?!0:ah(n)},resource:lh};function hh(n,e={}){return new dh(n,e)}const Z=f.vec3.create(),ut=f.vec3.create(),pt=f.quat.create(),Tr=new Float32Array(1);function xr(n,e){let t=e.clientX-n.clientX,i=e.clientY-n.clientY;return Math.sqrt(t*t+i*i)}const gi=-1,Er=0,Sr=1;class dh{constructor(e,t={}){this.scene=e,this.canvas=e.viewer.canvas,this.camera=e.camera,this.moveSpeed=t.moveSpeed||2,this.rotationSpeed=t.rotationSpeed||Math.PI/180,this.zoomFactor=t.zoomFactor||.1,this.horizontalAngle=t.horizontalAngle||Math.PI/2,this.verticalAngle=t.verticalAngle||Math.PI/4,this.distance=t.distance||500,this.position=t.position||f.vec3.create(),this.target=t.target||f.vec3.create(),this.twist=t.twist||0,this.mouse={buttons:[!1,!1,!1],x:0,y:0,x2:0,y2:0},this.touchMode=gi,this.touches=[],this.instance=null,this.onManualChange=t.onManualChange||null,this.fov=t.fov||Math.PI/4,this.nearClipPlane=t.nearClipPlane||1,this.farClipPlane=t.farClipPlane||2e5,this.update(),window.addEventListener("resize",i=>this.onResize()),setTimeout(()=>this.onResize(),0),this.canvas.addEventListener("contextmenu",i=>i.preventDefault()),this.canvas.addEventListener("selectstart",i=>i.preventDefault()),this.canvas.addEventListener("mousedown",i=>{i.preventDefault(),this.mouse.buttons[i.button]=!0}),document.addEventListener("mouseup",i=>{i.preventDefault(),this.mouse.buttons[i.button]=!1}),window.addEventListener("mousemove",i=>{this.mouse.x2=this.mouse.x,this.mouse.y2=this.mouse.y,this.mouse.x=i.clientX,this.mouse.y=i.clientY;let s=this.mouse.x-this.mouse.x2,r=this.mouse.y-this.mouse.y2;this.mouse.buttons[0]&&this.rotate(s,r),this.mouse.buttons[2]&&this.move(-s,r)}),this.canvas.addEventListener("wheel",i=>{i.preventDefault();let s=i.deltaY;i.deltaMode===1&&(s=s/3*100),this.zoom(s/100)}),this.canvas.addEventListener("touchstart",i=>{i.preventDefault();let s=i.targetTouches;s.length===1?this.touchMode=Er:s.length==2?this.touchMode=Sr:this.touchMode=gi,this.touches.length=0,this.touches.push(...s)}),this.canvas.addEventListener("touchend",i=>{i.preventDefault(),this.touchMode=gi}),this.canvas.addEventListener("touchcancel",i=>{i.preventDefault(),this.touchMode=gi}),this.canvas.addEventListener("touchmove",i=>{i.preventDefault();let s=i.targetTouches;if(this.touchMode===Er){let r=this.touches[0],o=s[0],a=o.clientX-r.clientX,l=o.clientY-r.clientY;this.rotate(a,l)}else if(this.touchMode===Sr){let r=xr(this.touches[0],this.touches[1]),o=xr(s[0],s[1]);this.zoom((r-o)/50)}this.touches.length=0,this.touches.push(...s)})}update(){if(this.instance){let e=this.instance,t=e.model.cameras[0];t.getTranslation(Z,e.sequence,e.frame,e.counter),f.vec3.add(Z,Z,t.position),t.getTargetTranslation(ut,e.sequence,e.frame,e.counter),f.vec3.add(ut,ut,t.targetPosition),t.getRotation(Tr,e.sequence,e.frame,e.counter),this.twist=Tr[0],f.vec3.transformMat4(Z,Z,e.worldMatrix),f.vec3.transformMat4(ut,ut,e.worldMatrix),this.moveToAndFace(Z,ut)}else this.updateInternalCamera()}move(e,t){let i=this.camera.directionX,s=this.camera.directionY,r=this.canvas.width,o=this.canvas.height,a=r/o,l=e/r*this.distance*a,c=t/o*this.distance;f.vec3.add(this.target,this.target,f.vec3.scale(Z,f.vec3.normalize(Z,f.vec3.set(Z,i[0],i[1],0)),l)),f.vec3.add(this.target,this.target,f.vec3.scale(Z,f.vec3.normalize(Z,f.vec3.set(Z,s[0],s[1],0)),c)),this.manualChange()}rotate(e,t){this.horizontalAngle-=e*this.rotationSpeed,this.verticalAngle-=t*this.rotationSpeed,this.manualChange()}zoom(e){this.distance=Math.max(1,this.distance*(1+e*this.zoomFactor)),this.manualChange()}manualChange(){this.updateInternalCamera(),this.instance&&(this.instance=null,this.onManualChange&&this.onManualChange())}onResize(){let e=Math.max(this.canvas.clientWidth,1),t=Math.max(this.canvas.clientHeight,1);this.canvas.width=e,this.canvas.height=t,this.scene.viewport[2]=e,this.scene.viewport[3]=t,this.camera.perspective(this.fov,e/t,this.nearClipPlane,this.farClipPlane)}moveToAndFace(e,t){f.vec3.sub(Z,e,t);let i=f.vec3.length(Z),s=Math.atan2(Z[1],Z[0]),r=Math.acos(Z[2]/i);f.vec3.copy(this.target,t),this.verticalAngle=r,this.horizontalAngle=s+Math.PI/2,this.distance=i,this.updateInternalCamera()}updateInternalCamera(){this.verticalAngle=Math.min(Math.max(.01,this.verticalAngle),Math.PI-.01),f.quat.identity(pt),f.quat.rotateZ(pt,pt,this.horizontalAngle),f.quat.rotateX(pt,pt,this.verticalAngle),f.vec3.set(this.position,0,0,1),f.vec3.transformQuat(this.position,this.position,pt),f.vec3.scale(this.position,this.position,this.distance),f.vec3.add(this.position,this.position,this.target);let e=this.twist-Math.PI/2;f.vec3.set(Z,0,-Math.cos(e),-Math.sin(e)),this.camera.moveToAndFace(this.position,this.target,Z)}applyInstanceCamera(e){this.instance=e,this.fov=e.model.cameras[0].fieldOfView,this.onResize(),this.update()}}const Ir=[{name:"Red",color:"#ff0402"},{name:"Blue",color:"#0042ff"},{name:"Teal",color:"#1be6ba"},{name:"Purple",color:"#540081"},{name:"Yellow",color:"#fffc00"},{name:"Orange",color:"#ff8a0d"},{name:"Green",color:"#20c000"},{name:"Pink",color:"#e45bb0"},{name:"Gray",color:"#949697"},{name:"Light Blue",color:"#7ebff1"},{name:"Dark Green",color:"#106247"},{name:"Brown",color:"#4f2a05"},{name:"Maroon",color:"#9c0000"},{name:"Navy",color:"#0000c3"},{name:"Turquoise",color:"#00ebff"},{name:"Violet",color:"#bd00ff"},{name:"Wheat",color:"#eccd86"},{name:"Peach",color:"#f7a48b"},{name:"Mint",color:"#c0ff80"},{name:"Lavender",color:"#dcb9ec"},{name:"Coal",color:"#4f4f55"},{name:"Snow",color:"#ecf0ff"},{name:"Emerald",color:"#00781e"},{name:"Peanut",color:"#a46f33"},{name:"Neutral",color:"#2e2d2e"}];class fh extends ye{constructor(e,t){super({...t,className:"viewer-controls"}),this.viewer=e;let i=A({container:this.container});A({textContent:"Team color:",container:i}),this.teamColorElement=A({tagName:"div",className:"controls teamcolor",style:"background-color:red",container:i}),this.teamColorsElement=A({tagName:"select",className:"controls",onchange:()=>{this.viewer.setTeamColor(this.teamColorsElement.selectedIndex),this.teamColorElement.style.backgroundColor=Ir[this.teamColorsElement.selectedIndex].color},container:i});for(let s of Ir)this.teamColorsElement.add(A({tagName:"option",textContent:s.name}));i=A({container:this.container}),A({textContent:"Show extents:",container:i}),this.extentElement=A({tagName:"select",className:"controls",onchange:()=>this.viewer.updateExtents(),container:i}),this.extentElement.add(A({tagName:"option",textContent:"No"})),this.extentElement.add(A({tagName:"option",textContent:"Box"})),this.extentElement.add(A({tagName:"option",textContent:"Sphere"})),this.extentElement.add(A({tagName:"option",textContent:"Both"})),this.extentElement.selectedIndex=0,i=A({container:this.container}),A({textContent:"Show collisions:",container:i}),this.collisionsToggle=new Ae("No","Yes",s=>{this.viewer.showCollisions(s.clicked)},{className:"controls",container:i}),i=A({container:this.container}),A({textContent:"Run Animations:",container:i}),this.animationToggle=new Ae("Yes","No",s=>{s.clicked?this.viewer.viewer.frameTime=0:this.viewer.viewer.frameTime=1e3/60},{className:"controls",container:i}),i=A({container:this.container}),A({textContent:"Cycle Animations:",container:i}),this.cycleToggle=new Ae("Yes","No",null,{className:"controls",container:i}),i=A({container:this.container}),A({textContent:"Animations:",container:i}),this.sequencesElement=A({tagName:"select",className:"controls",onchange:()=>{this.cycleToggle.clicked||this.cycleToggle.toggle(),this.viewer.viewer.clearEmittedObjects(),this.viewer.setSequence(this.sequencesElement.selectedIndex-1)},container:i}),i=A({container:this.container}),A({textContent:"Frame:",container:i}),this.frameElement=A({container:i}),i=A({container:this.container}),A({textContent:"Camera:",container:i}),this.camerasElement=A({tagName:"select",className:"controls",onchange:()=>this.viewer.setCamera(this.camerasElement.selectedIndex-1),container:i}),i=A({container:this.container}),A({textContent:"Debug Mode:",container:i}),this.debugRenderSelect=A({tagName:"select",className:"controls",onchange:()=>{this.viewer.viewer.debugRenderMode=this.debugRenderSelect.selectedIndex},container:i}),this.debugRenderSelect.add(A({tagName:"option",textContent:"None"})),this.debugRenderSelect.add(A({tagName:"option",textContent:"Diffuse"})),this.debugRenderSelect.add(A({tagName:"option",textContent:"Normal map"})),this.debugRenderSelect.add(A({tagName:"option",textContent:"Occlusion"})),this.debugRenderSelect.add(A({tagName:"option",textContent:"Roughness"})),this.debugRenderSelect.add(A({tagName:"option",textContent:"Metallic"})),this.debugRenderSelect.add(A({tagName:"option",textContent:"TC Factor"})),this.debugRenderSelect.add(A({tagName:"option",textContent:"Emissive"})),this.debugRenderSelect.add(A({tagName:"option",textContent:"TexCoords"})),this.debugRenderSelect.add(A({tagName:"option",textContent:"Normals"})),this.debugRenderSelect.add(A({tagName:"option",textContent:"Tangents"}))}frame(e){this.frameElement.textContent=`${Math.floor(e)}`}updateInstance(e){is(this.sequencesElement),this.sequencesElement.add(A({tagName:"option",textContent:"None"}));for(let t of e.model.sequences)this.sequencesElement.add(A({tagName:"option",textContent:t.name}));is(this.camerasElement),this.camerasElement.add(A({tagName:"option",textContent:"None"}));for(let t of e.model.cameras)this.camerasElement.add(A({tagName:"option",textContent:t.name}))}setSequence(e){this.sequencesElement.options.length===1&&(e=-1),this.sequencesElement.selectedIndex=e+1}setCamera(e){this.camerasElement.selectedIndex=e+1}}function sn(n,e,t){let i,s,r,o=Le.Unshaded;t&&(i=t.lines,s=t.color,r=t.texture,t.twoSided&&(o|=Le.TwoSided));const a=new Je,l=a.extent,c=e.boundingRadius;l.min.fill(-c),l.max.fill(c),l.boundsRadius=c;const d=new Ye;d.path="PLACEHOLDER",a.textures[0]=d;const h=v=>v===a?a:r,u=new jt,p=new Kt;p.textureId=0,p.flags=o,u.layers[0]=p,a.materials[0]=u;const g=new Ht;g.vertices=e.vertices,g.uvSets[0]=e.uvs,g.matrixGroups=new Uint32Array([1]),g.matrixIndices=new Uint32Array([0]),g.vertexGroups=new Uint8Array(e.vertices.length/3);let m=4,w=e.faces;if(i&&(m=1,w=e.edges),g.faceTypeGroups=new Uint32Array([m]),g.faceGroups=new Uint32Array([w.length]),g.faces=w,a.geosets[0]=g,s){const v=new zt;v.geosetId=0,v.color=s,a.geosetAnimations[0]=v}const b=new vt;return b.objectId=0,a.bones[0]=b,n.load(a,h)}function uh(n,e){return{vertices:new Float32Array([-n,e,0,-n,-e,0,n,-e,0,n,e,0]),uvs:new Float32Array([0,0,0,1,1,1,1,0]),faces:new Uint16Array([0,1,2,0,2,3]),edges:new Uint16Array([0,1,1,2,2,3,3,0]),boundingRadius:Math.hypot(n,e)}}function ph(){return uh(1,1)}function gh(n,e,t){return{vertices:new Float32Array([-n,-e,-t,-n,-e,t,-n,e,-t,-n,e,t,n,e,-t,n,e,t,n,-e,-t,n,-e,t]),uvs:new Float32Array([0,0,0,1,.25,0,.25,1,.5,0,.5,1,.75,0,.75,1]),faces:new Uint16Array([0,1,2,1,3,2,2,3,4,3,5,4,4,5,6,5,7,6,6,7,0,7,1,0,0,2,4,0,4,6,1,5,3,1,7,5]),edges:new Uint16Array([0,1,2,3,4,5,6,7,0,2,2,4,4,6,6,0,1,3,3,5,5,7,7,1]),boundingRadius:Math.hypot(n,e,t)}}function mh(){return gh(1,1,1)}function bh(n,e,t){const i=(e+1)*(t+1),s=new Float32Array(i*3),r=new Float32Array(i*2),o=new Uint16Array(e*t*6),a=new Uint16Array(e*t*6);for(let l=0,c=0,d=0;l<=e;l++){const h=l*Math.PI/e,u=Math.sin(h),p=Math.cos(h);for(let g=0;g<=t;g+=1,c+=3,d+=2){const m=g*2*Math.PI/t,w=Math.sin(m),b=Math.cos(m);s[c+0]=b*u*n,s[c+1]=w*u*n,s[c+2]=p*n,r[d+0]=g/t,r[d+1]=1-l/e}}for(let l=0,c=0;l<e;l++)for(let d=0;d<t;d+=1,c+=6){const h=l*(t+1)+d,u=h+t+1;o[c+0]=h,o[c+1]=u,o[c+2]=h+1,o[c+3]=u,o[c+4]=u+1,o[c+5]=h+1,a[c+0]=h,a[c+1]=u,a[c+2]=h,a[c+3]=h+1,a[c+4]=u,a[c+5]=u+1}return{vertices:s,uvs:r,faces:o,edges:a,boundingRadius:n}}function wh(n,e){return bh(1,n,e)}class vh extends ye{constructor(e,t){super({...t,className:"viewer"}),this.tester=e,this.messages=[],this.canvas=A({tagName:"canvas",style:"width:100%;height:100%",container:this.container}),this.controls=new fh(this,{container:this.container});let i=new Fl(this.canvas),s=i.addScene();this.viewer=i,this.scene=s,this.visibleTest=null,this.teamColor=0,s.color.fill(.2),this.orbitCamera=hh(s,{onManualChange:()=>{this.setCamera(-1),this.controls.setCamera(-1)}}),i.on("loadstart",a=>{e.logger.log(`[Viewer] Loading ${a.fetchUrl}`)}),i.on("loadend",a=>{e.logger.log(`[Viewer] Loaded ${a.fetchUrl}`)}),i.on("error",a=>{a.fetchUrl?e.logger.error(`[Viewer] ${a.error}: ${a.fetchUrl}`):e.logger.error(`[Viewer] ${a.error}: ${a.reason}`)}),i.addHandler(pi,wt,!0),i.addHandler(nh),i.addHandler(oh),i.addHandler(ch),this.textureModel=null,this.boxModel=null,this.sphereModel=null,sn(i,ph(),{twoSided:!0}).then(a=>{this.textureModel=a}),sn(i,mh(),{lines:!0}).then(a=>{this.boxModel=a}),sn(i,wh(12,12),{lines:!0}).then(a=>{this.sphereModel=a});let r=performance.now(),o=()=>{requestAnimationFrame(o);let a=performance.now(),l=a-r;if(r=a,this.controls.animationToggle.clicked?i.updateAndRender(0):i.updateAndRender(l),this.visibleTest){let c=this.visibleTest.instance;if(c.sequenceEnded){let d=c.sequence;this.controls.cycleToggle.clicked||(d+=1,d===c.model.sequences.length&&(d=0),this.setSequence(d))}this.controls.frame(c.frame)}};o()}async load(e){const t=await this.viewer.load(e.parser,(s,r)=>s===e.parser?s:e.pathSolver?e.pathSolver(s,r):wt(s,r));if(!t)return;let i;if(t instanceof vr){i=t.addInstance(),i.setTeamColor(this.teamColor);let s=this.boxModel.addInstance();s.hide(),s.setScene(this.scene),s.setParent(i);let r=this.sphereModel.addInstance();r.hide(),r.setScene(this.scene),r.setParent(i),e.boundingBox=s,e.boundingSphere=r;for(let o of t.collisionShapes)if(o.type===0){const a=this.boxModel.addInstance(),[l,c]=o.vertices;let d=(c[0]+l[0])/2,h=(c[1]+l[1])/2,u=(c[2]+l[2])/2,p=(c[0]-l[0])/2,g=(c[1]-l[1])/2,m=(c[2]-l[2])/2;a.hide(),a.setLocation([d,h,u]),a.setScale([p,g,m]),a.dontInheritScaling=!1,a.setParent(i.nodes[o.index]),a.setScene(this.scene),e.collisions.push(a)}else if(o.type===2){const a=this.sphereModel.addInstance();a.hide(),a.setParent(i.nodes[o.index]),a.uniformScale(o.boundsRadius),a.setScene(this.scene),e.collisions.push(a)}else console.log("COLLISION SHAPE NOT SUPPOTED",o)}else i=this.textureModel.addInstance(),i.scale([t.width,t.height,1]),i.setTexture(0,t);i.hide(),i.setSequenceLoopMode(2),i.setScene(this.scene),e.resource=t,e.instance=i,this.tryToInjectCustomTextures(e),e===this.tester.visibleTest&&this.render(e)}render(e){if(e.instance){if(this.visibleTest){this.visibleTest.instance.hide(),this.visibleTest.boundingBox&&(this.visibleTest.boundingBox.hide(),this.visibleTest.boundingSphere.hide());for(const t of this.visibleTest.collisions)t.hide()}if(this.visibleTest=e,e.instance.model.sequences.length?(this.controls.updateInstance(e.instance),this.viewer.clearEmittedObjects(),e.instance.sequence===-1?this.setSequence(0):this.setSequence(e.instance.sequence),this.controls.show()):this.controls.hide(),e.instance.show(),this.updateExtents(),this.controls.collisionsToggle.clicked)for(const t of e.collisions)t.show()}}updateExtents(){if(this.visibleTest&&this.visibleTest.boundingBox){let e=this.controls.extentElement.selectedIndex;e===0||e===2?this.visibleTest.boundingBox.hide():this.visibleTest.boundingBox.show(),e===0||e===1?this.visibleTest.boundingSphere.hide():this.visibleTest.boundingSphere.show()}}showCollisions(e){if(this.visibleTest)for(const t of this.visibleTest.collisions)e?t.show():t.hide()}setSequence(e){if(this.visibleTest.instance.setSequence(e),this.visibleTest.boundingBox){let t;if(e===-1)t=this.visibleTest.parser.extent;else{t=this.visibleTest.parser.sequences[e].extent;let{max:h,min:u}=t;h[0]===0&&h[1]===0&&h[2]===0&&u[0]===0&&u[1]===0&&u[2]===0&&(t=this.visibleTest.parser.extent)}let{max:i,min:s}=t,r=(i[0]+s[0])/2,o=(i[1]+s[1])/2,a=(i[2]+s[2])/2,l=(i[0]-s[0])/2,c=(i[1]-s[1])/2,d=(i[2]-s[2])/2;this.visibleTest.boundingBox.setLocation([r,o,a]),this.visibleTest.boundingBox.setScale([l,c,d]),this.visibleTest.boundingSphere.setLocation([r,o,a]),this.visibleTest.boundingSphere.setUniformScale(t.boundsRadius)}this.controls.setSequence(e)}setCamera(e){e===-1?this.orbitCamera.instance=null:this.orbitCamera.applyInstanceCamera(this.visibleTest.instance)}setTeamColor(e){this.teamColor=e,this.visibleTest&&this.visibleTest.instance.setTeamColor(this.teamColor)}tryToInjectCustomTextures(e){if(e.resource instanceof ot){for(let t of this.tester.tests)if(t!==e&&t.instance&&t.resource instanceof Rs){let i=t.parser.textures;for(let s=0,r=i.length;s<r;s++){let o=ke(i[s].path).toLowerCase(),a=ke(e.name).toLowerCase();o===a&&(t.instance.setTexture(s,e.resource),this.tester.logger.info(`Injected ${e.name} as a custom texture for ${t.name}`))}}}else for(let t of this.tester.tests)if(t!==e&&t.instance)if(t.resource instanceof ot){let i=e.parser.textures;for(let s=0,r=i.length;s<r;s++){let o=ke(i[s].path).toLowerCase(),a=ke(t.name).toLowerCase();o===a&&(e.instance.setTexture(s,t.resource),this.tester.logger.info(`Injected ${t.name} as a custom texture for ${e.name}`))}}else{let i=t.parser.particleEmitters,s=ke(e.name).toLowerCase();for(let r=0,o=i.length;r<o;r++){let a=ke(i[r].path).toLowerCase();console.log("inject into other",s,a)}i=e.parser.particleEmitters,s=ke(e.name).toLowerCase();for(let r=0,o=i.length;r<o;r++){let a=ke(i[r].path).toLowerCase();console.log("inject from other",s,a)}}}}class yh extends ye{constructor(e){super({className:"client"}),this.tests=[],this.visibleTest=null;let t=A({className:"tests-header",container:this.container});A({tagName:"h1",textContent:"Tests",container:t,container:t});let i=A({className:"tests-body",container:this.container});this.searchTests=A({tagName:"input",placeholder:"Search tests",oninput:()=>this.filterTests(),container:i}),this.testsElement=A({className:"tests",container:i});let s=A({className:"results-header",container:this.container});A({tagName:"h1",textContent:"Test Results",container:s,container:s}),this.unusedToggle=new Ae("Hide Unused","Show Unused",()=>this.filterResults(),{container:s}),this.warningToggle=new Ae("Hide Warnings","Show Warnings",()=>this.filterResults(),{container:s}),this.severeToggler=new Ae("Hide Severe","Show Severe",()=>this.filterResults(),{container:s}),this.errorToggler=new Ae("Hide Errors","Show Errors",()=>this.filterResults(),{container:s}),this.resultsBody=A({className:"results-body",container:this.container});let r=A({className:"viewer-and-mdl-header",container:this.container}),o=A({tagName:"h1",textContent:"3D View",container:r}),a=A({className:"viewer-and-mdl-body",container:this.container}),l=A({className:"viewer-and-console",container:a});this.mdl=A({className:"mdl hidden",container:a}),new Ae("View in MDL","View in 3D",c=>{c.clicked?(o.textContent="MDL View",Ai(l),Ti(this.mdl),this.viewer.controls.animationToggle.clicked||this.viewer.controls.animationToggle.toggle()):(o.textContent="3D View",Ti(l),this.viewer.orbitCamera.onResize(),Ai(this.mdl))},{container:r}),this.logger=new cl({container:l}),this.viewer=new vh(this,{container:l}),e.appendChild(this.container)}filterTests(){let e=this.searchTests.value.toLowerCase();for(let t of this.tests)t.name.toLowerCase().includes(e)?t.meta.show():t.meta.hide()}filterResults(){this.visibleTest&&this.visibleTest.results&&this.visibleTest.results.filter(this.unusedToggle.clicked,this.warningToggle.clicked,this.severeToggler.clicked,this.errorToggler.clicked)}test(e,t,i,s){this.logger.info(`Parsing ${e}`);let r;try{r=new ll(this,e,t,s)}catch(o){this.logger.error(`An error occured before the test could finish: ${o.stack}`)}this.tests.push(r),this.testsElement.appendChild(r.meta.container),r.meta.container.scrollIntoView(),r.results&&this.resultsBody.appendChild(r.results.container),r.mdl&&this.mdl.appendChild(r.mdl.container),this.viewer.load(r),i?this.render(r):r.hide()}render(e){e!==this.visibleTest&&(this.visibleTest&&this.visibleTest.hide(),this.visibleTest=e,this.filterResults(),e.show(),this.viewer.render(e))}loadMap(e,t){this.logger.info(`Parsing ${e}`);let i=new ko;try{i.load(t)}catch(o){this.logger.error(`Failed to parse ${e}: ${o}`);return}let s=(o,a)=>{let l=i.get(o);return l?l.bytes():wt(o,a)},r=!0;for(let o of i.getImportNames()){let a=ze(o);if(a===".mdx"||a===".mdl"||a===".blp"||a===".dds"||a===".tga"){let l=i.get(o);l?(a===".mdx"?this.test(`${e}:${o}`,l.arrayBuffer(),r,s):a===".mdl"?this.test(`${e}:${o}`,l.text(),r,s):(a===".blp"||a===".dds"||a===".tga")&&this.test(`${e}:${o}`,l.arrayBuffer(),r),r=!1):this.logger.error(`The map says it imports ${o} but it couldn't be found`)}}}async loadFile(e){let t=e.name,i=ze(t);if(i===".mdx"||i===".mdl"||i===".blp"||i===".dds"||i===".tga"||i===".w3x"||i===".w3m"){this.logger.info(`Reading ${t}`);let s=await ss(e,i===".mdl");i===".w3m"||i===".w3x"?this.loadMap(t,s):this.test(t,s,!0)}else this.logger.info(`${t} is not a supported file, skipping it`)}async loadDataTransfer(e){let t=await Fo(e),i=[],s=[];for(let c of t){let d=c.name,h=ze(d);h===".mdx"||h===".mdl"||h===".blp"||h===".dds"||h===".tga"||h===".w3x"||h===".w3m"?(this.logger.info(`Reading ${d}`),i.push(d.toLowerCase()),s.push(Mo(c,h===".mdl"))):this.logger.info(`${d} is not a supported file, skipping it`)}let r=await Promise.all(s),o=new Map;for(let c=0,d=i.length;c<d;c++)o.set(i[c],r[c]);let a=(c,d)=>{let h=o.get(mt(c).toLowerCase());return h||wt(c,d)},l=!0;for(let[c,d]of o.entries())c.endsWith(".w3m")||c.endsWith(".w3x")?this.loadMap(c,d):this.test(c,d,l,a),l=!1}loadAPI(e){if(e!==""){let t=[],i=new Map;for(let s of e.slice(1).split("&")){let[r,o]=s.split("=");o!==void 0&&(t.push(o),r.startsWith("override")&&i.set(r.slice(9,-1).replace(/\//g,"\\"),o))}if(t.length){let s=(o,a)=>{let l=i.get(mt(o).toLowerCase());return l||wt(o,a)},r=!0;for(let o of t)fetch(o).then(async a=>{let l;o.endsWith(".mdl")?l=await a.text():l=await a.arrayBuffer(),this.test(o,l,r,s),r=!1})}}}}const rn=new yh(document.body);document.addEventListener("dragover",n=>{n.preventDefault()}),document.addEventListener("dragend",n=>{n.preventDefault()}),document.addEventListener("drop",n=>{n.preventDefault(),rn.loadDataTransfer(n.dataTransfer)}),rn.loadAPI(window.location.search),window.tester=rn}));
