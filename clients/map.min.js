(function(Ie,f){typeof exports=="object"&&typeof module<"u"?f(require("events"),require("gl-matrix"),require("tga-js"),require("pako")):typeof define=="function"&&define.amd?define(["events","gl-matrix","tga-js","pako"],f):(Ie=typeof globalThis<"u"?globalThis:Ie||self,f(Ie.EventEmitter,Ie.glMatrix,Ie.TGA,Ie.pako))})(this,(function(Ie,f,or,Si){"use strict";function Kt(r){if(r&&r.length){let e=r.lastIndexOf("/");return e!==-1&&(r=r.slice(e+1)),e=r.lastIndexOf("\\"),e!==-1&&(r=r.slice(e+1)),r}return""}function Ii(r){if(r&&r.length){const e=r.lastIndexOf(".");return e!==-1&&(r=r.slice(e).toLowerCase()),r}return""}class ar{rows=[];load(e){if(!e.startsWith("ID"))throw new Error("WrongMagicNumber");const t=this.rows;let i=0,n=0;for(const s of e.split(`
`))if(s[0]!=="B")for(const o of s.split(";")){const a=o[0],l=o.substring(1).trim();let c;a==="X"?i=parseInt(l,10)-1:a==="Y"?n=parseInt(l,10)-1:a==="K"&&(t[n]||(t[n]=[]),l[0]==='"'?c=l.slice(1,-1):c=l,t[n][i]=c)}}save(){const e=this.rows,t=e.length,i=[];let n=0;for(let s=0;s<t;s++){const o=e[s],a=o.length;a>n&&(n=a);let l=!0;for(let c=0;c<a;c++){const d=o[c];if(d!==void 0){let h;typeof d=="string"?h=`"${d}"`:typeof d=="boolean"?d?h="TRUE":h="FALSE":h=`${d}`,l?(l=!1,i.push(`C;X${c+1};Y${s+1};K${h}`)):i.push(`C;X${c+1};K${h}`)}}}return`ID;P\r
B;X${n};Y${t}\r
${i.join(`\r
`)}\r
E`}}class lr{properties=new Map;sections=new Map;load(e){let t=this.properties;const i=this.sections;for(const n of e.split(`\r
`))if(n.length&&!n.startsWith("//")&&!n.startsWith(";")){let s=n.match(/^\[(.+?)\]/);if(s){const o=s[1].trim();t=i.get(o),t||(t=new Map,i.set(o,t))}else if(s=n.match(/^(.+?)=(.*?)$/),s){let o=s[2];o[0]==='"'&&(o=o.slice(1,-1)),t.set(s[1],o)}}}save(){const e=[];for(const[t,i]of this.properties)e.push(`${t}=${i}`);for(const[t,i]of this.sections){e.push(`[${t}]`);for(const[n,s]of i)e.push(`${n}=${s}`)}return e.join(`\r
`)}getSection(e){return this.sections.get(e)}}class $t{map={};set(e,t){typeof t!="string"&&(t=t.toString()),this.map[e.toLowerCase()]=t}string(e){return this.map[e.toLowerCase()]}number(e){const t=this.string(e);return t?parseFloat(t):0}}class xe{map={};constructor(e){e&&this.load(e)}load(e){if(e.startsWith("ID;")){const t=new ar;t.load(e);const i=t.rows,n=i[0],s=this.map;for(let o=1,a=i.length;o<a;o++){const l=i[o];if(l){const c=l[0];if(c&&c!=="_"){s[c]||(s[c]=new $t);const d=s[c];for(let h=0,u=n.length;h<u;h++){let p=n[h];p===void 0&&(p=`column${h}`),d.map[p.toLowerCase()]=l[h]}}}}}else{const t=new lr;t.load(e);const i=t.sections,n=this.map;for(const[s,o]of i.entries()){n[s]||(n[s]=new $t);const a=n[s];for(const[l,c]of o)a.map[l.toLowerCase()]=c}}}getRow(e){return this.map[e]}getProperty(e,t){return this.map[e].map[t]}setRow(e,t){this.map[e]=t}findRow(e,t){for(const i of Object.values(this.map))if(i.string(e)===t)return i}}async function Bi(r,e){if(e==="image")return new Promise(t=>{const i=new Image;i.onload=()=>{t({ok:!0,data:i})},i.onerror=n=>{t({ok:!1,error:"Image Error",data:n})},i.src=r});{let t;try{t=await fetch(r)}catch(i){return{ok:!1,error:"Network Error",data:i}}if(!t.ok)return{ok:!1,error:"Http Error",data:t};try{let i=null;return e==="text"?i=await t.text():e==="arrayBuffer"||e==="bytes"?i=await t.arrayBuffer():e==="blob"&&(i=await t.blob()),e==="bytes"&&(i=new Uint8Array(i)),{ok:!0,data:i}}catch(i){return{ok:!1,error:"Data Error",data:i}}}}class cr{gl;buffer;size=0;arrayBuffer=null;byteView=null;floatView=null;constructor(e,t=4){this.gl=e,this.buffer=e.createBuffer(),this.reserve(t)}reserve(e){if(this.size<e){const t=this.gl;this.size=Math.ceil(e/4)*4,t.bindBuffer(t.ARRAY_BUFFER,this.buffer),t.bufferData(t.ARRAY_BUFFER,this.size,t.DYNAMIC_DRAW),this.arrayBuffer=new ArrayBuffer(this.size),this.byteView=new Uint8Array(this.arrayBuffer),this.floatView=new Float32Array(this.arrayBuffer)}}bindAndUpdate(e=this.size){const t=this.gl,i=this.byteView;t.bindBuffer(t.ARRAY_BUFFER,this.buffer),t.bufferSubData(t.ARRAY_BUFFER,0,i.subarray(0,e))}}class hr{gl;texture;width=0;height=0;arrayBuffer=new ArrayBuffer(0);byteView=null;floatView=null;constructor(e,t=1,i=1){this.gl=e,this.texture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),this.reserve(t,i)}reserve(e,t){if(this.width<e||this.height<t){const i=this.gl;this.width=Math.max(this.width,e),this.height=Math.max(this.height,t),i.bindTexture(i.TEXTURE_2D,this.texture),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,this.width,this.height,0,i.RGBA,i.FLOAT,null),this.arrayBuffer=new ArrayBuffer(this.width*this.height*16),this.byteView=new Uint8Array(this.arrayBuffer),this.floatView=new Float32Array(this.arrayBuffer)}}bindAndUpdate(e=this.width,t=this.height){const i=this.gl;i.bindTexture(i.TEXTURE_2D,this.texture),i.texSubImage2D(i.TEXTURE_2D,0,0,0,e,t,i.RGBA,i.FLOAT,this.byteView)}}class Ci{gl;texture;format;width=0;height=0;constructor(e,t=4,i=1,n=1){this.gl=e,this.texture=e.createTexture(),this.format=t===3?e.RGB:e.RGBA,e.bindTexture(e.TEXTURE_2D,this.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),this.reserve(i,n)}reserve(e,t){if(this.width<e||this.height<t){const i=this.gl;this.width=Math.max(this.width,e),this.height=Math.max(this.height,t),i.bindTexture(i.TEXTURE_2D,this.texture),i.texImage2D(i.TEXTURE_2D,0,this.format,this.width,this.height,0,this.format,i.FLOAT,null)}}bindAndUpdate(e,t=this.width,i=this.height){const n=this.gl;n.bindTexture(n.TEXTURE_2D,this.texture),n.texSubImage2D(n.TEXTURE_2D,0,0,0,t,i,this.format,n.FLOAT,e)}bind(e){const t=this.gl;t.activeTexture(t.TEXTURE0+e),t.bindTexture(t.TEXTURE_2D,this.texture)}}class dr{webgl;program;uniforms={};attribs={};attribsCount=0;constructor(e,t){this.webgl=e,this.program=t;const i=e.gl;for(let n=0,s=i.getProgramParameter(t,i.ACTIVE_UNIFORMS);n<s;n++){const o=i.getActiveUniform(t,n);if(o)if(o.size===1)this.uniforms[o.name]=i.getUniformLocation(t,o.name);else{const a=o.name.substr(0,o.name.length-3);for(let l=0;l<o.size;l++){const c=a+"["+l+"]";this.uniforms[c]=i.getUniformLocation(t,c)}}}for(let n=0,s=i.getProgramParameter(t,i.ACTIVE_ATTRIBUTES);n<s;n++){const o=i.getActiveAttrib(t,n);if(o)if(this.attribsCount+=o.size,o.size===1)this.attribs[o.name]=i.getAttribLocation(t,o.name);else{const a=o.name.substr(0,o.name.length-3);for(let l=0;l<o.size;l++){const c=a+"["+l+"]";this.attribs[c]=i.getAttribLocation(t,c)}}}}use(){this.webgl.useShader(this)}}class fr{gl;currentShader=null;emptyTexture;extensions={};constructor(e,t={alpha:!1}){let i=e.getContext("webgl",t);if(i||(i=e.getContext("experimental-webgl",t)),!i)throw new Error("WebGL: Failed to create a WebGL context!");const n=new Uint8ClampedArray(16).fill(255),s=i.createTexture();i.bindTexture(i.TEXTURE_2D,s),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,2,2,0,i.RGBA,i.UNSIGNED_BYTE,n),this.gl=i,this.emptyTexture=s}ensureExtension(e){const t=this.gl.getExtension(e);return t?(this.extensions[e]=t,!0):!1}createShader(e,t){const i=this.gl,n=i.createShader(i.VERTEX_SHADER);i.shaderSource(n,e),i.compileShader(n);const s=i.createShader(i.FRAGMENT_SHADER);i.shaderSource(s,t),i.compileShader(s);const o=i.createProgram();if(i.attachShader(o,n),i.attachShader(o,s),i.linkProgram(o),!i.getProgramParameter(o,i.LINK_STATUS)){let a="Shader failed to link:";const l=i.getShaderInfoLog(n);l&&l.length&&(a+=` Vertex shader: ${l}`);const c=i.getShaderInfoLog(s);throw c&&c.length&&(a+=` Fragment shader: ${c}`),new Error(a)}return new dr(this,o)}enableVertexAttribs(e,t){const i=this.gl;for(let n=e;n<t;n++)i.enableVertexAttribArray(n)}disableVertexAttribs(e,t){const i=this.gl;for(let n=e;n<t;n++)i.disableVertexAttribArray(n)}useShader(e){if(e&&e!==this.currentShader){let t=0;const i=e.attribsCount;this.currentShader&&(t=this.currentShader.attribsCount),this.gl.useProgram(e.program),i>t?this.enableVertexAttribs(t,i):i<t&&this.disableVertexAttribs(i,t),this.currentShader=e}}bindTexture(e,t){const i=this.gl;i.activeTexture(i.TEXTURE0+t),e?i.bindTexture(i.TEXTURE_2D,e.webglResource):i.bindTexture(i.TEXTURE_2D,this.emptyTexture)}bindTextureAndWrap(e,t,i,n){const s=this.gl;s.activeTexture(s.TEXTURE0+t),e?s.bindTexture(s.TEXTURE_2D,e.webglResource):s.bindTexture(s.TEXTURE_2D,this.emptyTexture),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,i),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,n)}setTextureMode(e,t,i,n){const s=this.gl;s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,e),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,t),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,i),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,n)}createClientBuffer(e=4){return new cr(this.gl,e)}createDataTexture(e=4,t=1,i=1){return new Ci(this.gl,e,t,i)}createClientDataTexture(e=1,t=1){return new hr(this.gl,e,t)}}const zt=f.vec3.fromValues(1,0,0),Li=f.vec3.fromValues(0,1,0),Be=f.vec3.fromValues(0,0,1),Ne=f.vec3.create(),Xt=f.vec3.fromValues(1,1,1);f.quat.fromValues(0,0,0,0);const Yt=f.quat.create(),_e=f.vec4.create();function Ri(r,e,t,i){const n=2*(e[0]-i[0])/i[2]-1,s=1-2*(e[1]-i[1])/i[3],o=2*e[2]-1;return f.vec4.set(_e,n,s,o,1),f.vec4.transformMat4(_e,_e,t),f.vec3.set(r,_e[0]/_e[3],_e[1]/_e[3],_e[2]/_e[3]),r}function gt(r,e,t){return r[0]*e+r[1]*t+r[3]}function Fi(r,e,t,i){return r[0]*e+r[1]*t+r[2]*i+r[3]}function ur(r,e,t,i,n,s){s===-1&&(s=0);for(let o=0;o<6;o++){const a=(s+o)%6;if(Fi(r[a],e,t,i)<=-n)return a}return-1}function pr(r,e,t,i,n,s){s===-1&&(s=0);for(let o=0;o<6;o++){const a=(s+o)%6,l=r[a];if(gt(l,e,i)<0&&gt(l,e,n)<0&&gt(l,t,n)<0&&gt(l,t,i)<0)return a}return-1}function gr(r){return Math.hypot(r[0],r[1],r[2])}function Ve(r,e){const t=gr(e);r[0]=e[0]/t,r[1]=e[1]/t,r[2]=e[2]/t,r[3]=e[3]/t}function vr(r,e){const t=e[0],i=e[4],n=e[8],s=e[12],o=e[1],a=e[5],l=e[9],c=e[13],d=e[2],h=e[6],u=e[10],p=e[14],g=e[3],v=e[7],b=e[11],w=e[15];let m;m=r[0],m[0]=g+t,m[1]=v+i,m[2]=b+n,m[3]=w+s,m=r[1],m[0]=g-t,m[1]=v-i,m[2]=b-n,m[3]=w-s,m=r[2],m[0]=g-o,m[1]=v-a,m[2]=b-l,m[3]=w-c,m=r[3],m[0]=g+o,m[1]=v+a,m[2]=b+l,m[3]=w+c,m=r[4],m[0]=g+d,m[1]=v+h,m[2]=b+u,m[3]=w+p,m=r[5],m[0]=g-d,m[1]=v-h,m[2]=b-u,m[3]=w-p,Ve(r[0],r[0]),Ve(r[1],r[1]),Ve(r[2],r[2]),Ve(r[3],r[3]),Ve(r[4],r[4]),Ve(r[5],r[5])}const Q=f.vec3.create(),ie=f.vec3.create(),le=f.vec3.create();function Ui(r,e,t,i){f.vec3.normalize(Q,f.vec3.sub(Q,t,e)),f.vec3.normalize(ie,f.vec3.cross(ie,i,Q)),f.vec3.cross(le,ie,Q);const n=ie[0]+le[2]+Q[1];if(n>0){const s=.5/Math.sqrt(n+1);r[3]=.25/s,r[0]=(le[1]-Q[2])*s,r[2]=(Q[0]-ie[1])*s,r[1]=(ie[2]-le[0])*s}else if(ie[0]>le[2]&&ie[0]>Q[1]){const s=2*Math.sqrt(1+ie[0]-le[2]-Q[1]);r[3]=(le[1]-Q[2])/s,r[0]=.25*s,r[2]=(le[0]+ie[2])/s,r[1]=(Q[0]+ie[1])/s}else if(le[2]>Q[1]){const s=2*Math.sqrt(1+le[2]-ie[0]-Q[1]);r[3]=(Q[0]-ie[1])/s,r[0]=(le[0]+ie[2])/s,r[2]=.25*s,r[1]=(Q[2]+le[1])/s}else{const s=2*Math.sqrt(1+Q[1]-ie[0]-le[2]);r[3]=(ie[2]-le[0])/s,r[0]=(Q[0]+ie[1])/s,r[2]=(Q[2]+le[1])/s,r[1]=.25*s}return r}const it=f.vec3.create(),wr=f.vec3.create(),br=f.vec3.create(),mr=f.quat.create(),Ar=f.quat.setAxisAngle(f.quat.create(),zt,Math.PI/2);let yr=class{isPerspective=!0;fov=0;aspect=0;isOrtho=!1;leftClipPlane=0;rightClipPlane=0;bottomClipPlane=0;topClipPlane=0;nearClipPlane=0;farClipPlane=0;location=f.vec3.create();rotation=f.quat.create();inverseRotation=f.quat.create();viewMatrix=f.mat4.create();projectionMatrix=f.mat4.create();viewProjectionMatrix=f.mat4.create();inverseViewMatrix=f.mat4.create();inverseViewProjectionMatrix=f.mat4.create();directionX=f.vec3.create();directionY=f.vec3.create();directionZ=f.vec3.create();vectors=[f.vec3.fromValues(-1,-1,0),f.vec3.fromValues(-1,1,0),f.vec3.fromValues(1,1,0),f.vec3.fromValues(1,-1,0),f.vec3.fromValues(1,0,0),f.vec3.fromValues(0,1,0),f.vec3.fromValues(0,0,1)];billboardedVectors=[f.vec3.create(),f.vec3.create(),f.vec3.create(),f.vec3.create(),f.vec3.create(),f.vec3.create(),f.vec3.create()];planes=[f.vec4.create(),f.vec4.create(),f.vec4.create(),f.vec4.create(),f.vec4.create(),f.vec4.create()];perspective(e,t,i,n){this.isPerspective=!0,this.isOrtho=!1,this.fov=e,this.aspect=t,this.nearClipPlane=i,this.farClipPlane=n,this.update()}ortho(e,t,i,n,s,o){this.isPerspective=!1,this.isOrtho=!0,this.leftClipPlane=e,this.rightClipPlane=t,this.bottomClipPlane=i,this.topClipPlane=n,this.nearClipPlane=s,this.farClipPlane=o,this.update()}setLocation(e){f.vec3.copy(this.location,e),this.update()}move(e){f.vec3.add(this.location,this.location,e),this.update()}setRotation(e){f.quat.copy(this.rotation,e),this.update()}rotate(e){f.quat.mul(this.rotation,this.rotation,e),this.update()}face(e,t){f.quat.mul(this.rotation,Ar,Ui(mr,e,this.location,t)),this.update()}moveToAndFace(e,t,i){f.vec3.copy(this.location,e),this.face(t,i)}reset(){f.vec3.set(this.location,0,0,0),f.quat.identity(this.rotation),this.update()}update(){const e=this.location,t=this.rotation,i=this.inverseRotation,n=this.viewMatrix,s=this.projectionMatrix,o=this.viewProjectionMatrix,a=this.vectors,l=this.billboardedVectors;this.isPerspective?f.mat4.perspective(s,this.fov,this.aspect,this.nearClipPlane,this.farClipPlane):f.mat4.ortho(s,this.leftClipPlane,this.rightClipPlane,this.bottomClipPlane,this.topClipPlane,this.nearClipPlane,this.farClipPlane),f.mat4.fromQuat(n,t),f.mat4.translate(n,n,f.vec3.negate(it,e)),f.mat4.mul(o,s,n),f.mat4.invert(this.inverseViewMatrix,n),f.mat4.invert(this.inverseViewProjectionMatrix,o),vr(this.planes,o),f.quat.conjugate(i,t),f.vec3.transformQuat(this.directionX,zt,i),f.vec3.transformQuat(this.directionY,Li,i),f.vec3.transformQuat(this.directionZ,Be,i);for(let c=0;c<7;c++)f.vec3.transformQuat(l[c],a[c],i)}cameraToWorld(e,t){return f.vec3.transformMat4(e,t,this.inverseViewMatrix)}worldToCamera(e,t){return f.vec3.transformMat4(e,t,this.viewMatrix)}worldToScreen(e,t,i){return f.vec3.transformMat4(it,t,this.viewProjectionMatrix),e[0]=Math.round((it[0]+1)/2*i[2]),e[1]=Math.round((it[1]+1)/2*i[3]),e}screenToWorldRay(e,t,i){const n=it,s=wr,o=br,a=t[0],l=t[1],c=this.inverseViewProjectionMatrix;return Ri(n,f.vec3.set(o,a,l,0),c,i),Ri(s,f.vec3.set(o,a,l,1),c,i),e.set(n,0),e.set(s,3),e}};class Tr{left;right;bottom;top;plane=-1;instances=[];visible=!1;constructor(e,t,i,n){this.left=e,this.right=t,this.bottom=i,this.top=n}add(e){this.instances.push(e)}remove(e){const t=this.instances.indexOf(e);this.instances.splice(t,1)}clear(){this.instances.length=0}isVisible(e){return this.plane=pr(e.planes,this.left,this.right,this.bottom,this.top,this.plane),this.plane===-1}}class Pi{x;y;width;depth;cellWidth;cellDepth;columns;rows;cells=[];constructor(e,t,i,n,s,o){const a=i/s,l=n/o;this.x=e,this.y=t,this.width=i,this.depth=n,this.cellWidth=s,this.cellDepth=o,this.columns=a,this.rows=l;for(let c=0;c<l;c++)for(let d=0;d<a;d++){const h=e+d*s,u=h+s,p=t+c*o,g=p+o;this.cells[c*a+d]=new Tr(h,u,p,g)}}add(e){const t=this.cells,i=this.columns,n=e.left,s=e.right+1,o=e.bottom,a=e.top+1;if(n!==-1)for(let l=o;l<a;l++)for(let c=n;c<s;c++)t[l*i+c].add(e)}remove(e){const t=this.cells,i=this.columns,n=e.left,s=e.right+1,o=e.bottom,a=e.top+1;if(n!==-1){e.left=-1;for(let l=o;l<a;l++)for(let c=n;c<s;c++)t[l*i+c].remove(e)}}moved(e){const t=this.cellWidth,i=this.cellDepth,n=e.model.bounds,s=e.worldLocation[0]+n.x-this.x,o=e.worldLocation[1]+n.y-this.y,a=n.r,l=e.worldScale;let c=Math.floor((s-a*l[0])/t),d=Math.floor((s+a*l[0])/t),h=Math.floor((o-a*l[1])/i),u=Math.floor((o+a*l[1])/i);d<0||c>this.columns-1||u<0||h>this.rows-1?this.remove(e):(c=Math.max(c,0),d=Math.min(d,this.columns-1),h=Math.max(h,0),u=Math.min(u,this.rows-1),(c!==e.left||d!==e.right||h!==e.bottom||u!==e.top)&&(this.remove(e),e.left=c,e.right=d,e.bottom=h,e.top=u,this.add(e)))}clear(){for(const e of this.cells)e.clear()}}class xr{objects=[];alive=0;add(e){this.objects[this.alive++]=e}update(e){const t=this.objects;for(let i=0;i<this.alive;i++){const n=t[i];n.update(e*n.emitter.instance.timeScale),n.health<=0&&(this.alive-=1,n.emitter.kill(n),i!==this.alive&&(t[i]=t[this.alive],i-=1))}}}class _r{viewer;camera=new yr;grid=new Pi(-1e5,-1e5,2e5,2e5,2e5,2e5);visibleCells=0;visibleInstances=0;updatedParticles=0;audioEnabled=!1;audioContext=null;instances=[];emittedObjectUpdater=new xr;alpha=!1;color=f.vec3.create();viewport=f.vec4.create();lightPosition=f.vec3.fromValues(0,0,1e4);constructor(e){this.viewer=e;const t=e.canvas,i=t.width,n=t.height;this.viewport[2]=i,this.viewport[3]=n,this.camera.perspective(Math.PI/4,i/n,8,1e4)}async enableAudio(){return typeof AudioContext=="function"?(this.audioContext||(this.audioContext=new AudioContext),this.audioContext.state!=="suspended"&&await this.audioContext.resume(),this.audioEnabled=this.audioContext.state==="running",this.audioEnabled):!1}disableAudio(){this.audioContext&&this.audioContext.suspend(),this.audioEnabled=!1}addInstance(e){return e.scene!==this?(e.scene&&e.scene.removeInstance(e),e.scene=this,this.grid.moved(e),!0):!1}removeInstance(e){return e.scene===this?(this.grid.remove(e),e.scene=null,!0):!1}clear(){for(const e of this.grid.cells)for(const t of e.instances)t.scene=null;this.grid.clear()}detach(){return this.viewer?this.viewer.removeScene(this):!1}update(e){const t=this.camera;if(this.audioContext){const s=this.audioContext.listener,o=t.location,a=t.directionY,l=t.directionZ;s.positionX.value=-o[0],s.positionY.value=-o[1],s.positionZ.value=-o[2],s.forwardX.value=a[0],s.forwardY.value=a[1],s.forwardZ.value=a[2],s.upX.value=l[0],s.upY.value=l[1],s.upZ.value=l[2]}const i=this.viewer.frame,n=this.instances;this.visibleCells=0,this.visibleInstances=0;for(const s of this.grid.cells)if(s.isVisible(t)){this.visibleCells+=1;for(const o of s.instances)o.rendered&&o.updateFrame<i&&!o.parent&&(o.updateFrame=i,o.update(e))}n.length=this.visibleInstances,n.sort((s,o)=>s.depth-o.depth),this.emittedObjectUpdater.update(e),this.updatedParticles=this.emittedObjectUpdater.alive}renderInstance(e){this.instances[this.visibleInstances++]=e}startFrame(){const e=this.viewer.gl,t=this.viewport;if(e.viewport(t[0],t[1],t[2],t[3]),e.scissor(t[0],t[1],t[2],t[3]),!this.alpha){const i=this.color;e.depthMask(!0),e.clearColor(i[0],i[1],i[2],1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)}}renderOpaque(){const e=this.instances;for(let t=0,i=e.length;t<i;t++)e[t].renderOpaque()}renderTranslucent(){const e=this.instances;for(let t=e.length-1;t>=0;t--)e[t].renderTranslucent()}render(){this.startFrame(),this.renderOpaque(),this.renderTranslucent()}clearEmittedObjects(){for(const e of this.emittedObjectUpdater.objects)e.health=0}}class Wt{viewer;fetchUrl;blockers=[];constructor(e){this.viewer=e.viewer,this.fetchUrl=e.fetchUrl}detach(){return this.viewer.unload(this)}}class Er extends Wt{data=null;constructor(e,t){super(t),this.data=e}}function Di(r){return r*(Math.PI/180)}function Ce(r,e){return r+Math.random()*(e-r)}function Sr(r,e,t){return r+t*(e-r)}function Ir(r,e,t,i,n){const s=n*n,o=s*(2*n-3)+1,a=s*(n-2)+n,l=s*(n-1),c=s*(3-2*n);return r*o+e*a+t*l+i*c}function Br(r,e,t,i,n){const s=1-n,o=n*n,a=s*s,l=a*s,c=3*n*a,d=3*o*s,h=o*n;return r*l+e*c+t*d+i*h}function Cr(r){return r--,r|=r>>1,r|=r>>2,r|=r>>4,r|=r>>8,r|=r>>16,r++,r}function Ge(r){return r===0?!1:(r&r-1)===0}function Lr(r){return r instanceof ArrayBuffer&&(r=new Uint8Array(r)),r instanceof Uint8Array&&r[0]===137&&r[1]===80&&r[2]===78&&r[3]===71&&r[4]===13&&r[5]===10&&r[6]===26&&r[7]===10}function Rr(r){return r instanceof ArrayBuffer&&(r=new Uint8Array(r)),r instanceof Uint8Array&&r[0]===255&&r[1]===216&&r[r.length-2]===255&&r[r.length-1]===217}function Fr(r){return r instanceof ArrayBuffer&&(r=new Uint8Array(r)),r instanceof Uint8Array&&r[0]===71&&r[1]===73&&r[2]===70&&r[3]===56&&(r[4]===55||r[4]===57)&&r[5]===97}function Ur(r){return r instanceof ArrayBuffer&&(r=new Uint8Array(r)),r instanceof Uint8Array&&r[0]===82&&r[1]===73&&r[2]===70&&r[3]===70&&r[8]===87&&r[9]===69&&r[10]===66&&r[11]===80}class ki extends Wt{pathSolver;constructor(e){super(e),this.pathSolver=e.pathSolver}}let vt=class extends ki{webglResource=null;width=0;height=0};function Pr(r){return r instanceof ImageData||r instanceof HTMLImageElement||r instanceof HTMLCanvasElement||r instanceof HTMLVideoElement}function Dr(r){return Lr(r)?"image/png":Rr(r)?"image/jpeg":Fr(r)?"image/gif":Ur(r)?"image/webp":""}class Oi extends vt{constructor(e,t){super(t);const i=this.viewer.gl;this.webglResource=i.createTexture(),i.bindTexture(i.TEXTURE_2D,this.webglResource),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),Ge(e.width)&&Ge(e.height)?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR_MIPMAP_LINEAR),i.generateMipmap(i.TEXTURE_2D)):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE)),this.width=e.width,this.height=e.height}}let Mi,Ni;typeof window=="object"&&(Mi=document.createElement("canvas"),Mi.getContext("2d"),Ni=document.createElement("canvas"),Ni.getContext("2d"));function kr(r){return new Promise((e,t)=>{const i=URL.createObjectURL(r),n=new Image;n.onload=()=>{e(n)},n.onerror=s=>{t(s)},n.src=i})}var D=(r=>(r[r.None=0]="None",r[r.Diffuse=1]="Diffuse",r[r.NormalMap=2]="NormalMap",r[r.Occlusion=3]="Occlusion",r[r.Roughness=4]="Roughness",r[r.Metallic=5]="Metallic",r[r.TCFactor=6]="TCFactor",r[r.Emissive=7]="Emissive",r[r.TexCoords=8]="TexCoords",r[r.Normals=9]="Normals",r[r.Tangents=10]="Tangents",r))(D||{});class Or extends Ie.EventEmitter{canvas;gl;webgl;resources=[];resourceMap=new Map;promiseMap=new Map;handlers=new Set;scenes=[];frame=0;visibleCells=0;visibleInstances=0;updatedParticles=0;audioEnabled=!1;buffer;sharedCache=new Map;debugRenderMode=0;directLoadId=0;constructor(e,t){super();const i=new fr(e,t),n=i.gl;this.canvas=e,this.gl=n,this.webgl=i,this.buffer=i.createClientBuffer(),n.depthFunc(n.LEQUAL),n.enable(n.DEPTH_TEST),n.enable(n.SCISSOR_TEST)}enableAudio(){return typeof AudioContext=="function"?(this.audioEnabled=!0,!0):!1}addHandler(e,...t){if(e){const i=this.handlers;if(!i.has(e)){if(!e.isValidSource)return this.emit("error",{viewer:this,error:"Handler missing the isValidSource function",handler:e}),!1;if(e.load)try{e.load(this,...t)}catch(n){return this.emit("error",{viewer:this,error:"Handler failed to load",handler:e,reason:n}),!1}return i.add(e),!0}}return!1}addScene(){const e=new _r(this);return this.scenes.push(e),e}removeScene(e){const t=this.scenes,i=t.indexOf(e);return i!==-1?(t.splice(i,1),!0):!1}clear(){this.scenes.length=0}async load(e,t,i){let n,s="",o;if(t)try{n=t(e,i)}catch(a){this.emit("error",{viewer:this,error:"Path solver failed",src:e,reason:a,pathSolver:t,solverParams:i});return}else n=e;if(n){if(n instanceof Promise&&(n=await n),n instanceof Wt)return n;if(typeof n=="string"&&!this.detectFormat(n)){if(s=n,o=this.promiseMap.get(s),o)return o;const a=this.resourceMap.get(s);if(a)return a;o=Bi(s,"arrayBuffer").then(l=>{if(l.ok)return l.data;this.emit("error",{viewer:this,error:`Failed to fetch a resource: ${l.error}`,fetchUrl:s,reason:l.data})})}else s=`__DIRECT_LOAD_${this.directLoadId++}`,o=Promise.resolve(n);return o=o.then(async a=>{if(a){if(a instanceof ArrayBuffer&&(a=new Uint8Array(a)),Pr(a))return new Oi(a,{viewer:this,fetchUrl:s,pathSolver:t});if(a instanceof Uint8Array){const c=Dr(a);if(c.length)return new Oi(await kr(new Blob([a.buffer],{type:c})),{viewer:this,fetchUrl:s,pathSolver:t})}const l=this.detectFormat(a);if(l)try{const c=new l.resource(a,{viewer:this,fetchUrl:s,pathSolver:t});return await Promise.all(c.blockers),c.blockers.length=0,c}catch(c){this.emit("error",{viewer:this,error:"Failed to create a resource",fetchUrl:s,src:e,reason:c})}else this.emit("error",{viewer:this,error:"Source has no matching handler",fetchUrl:s,src:e})}}).then(a=>(this.promiseMap.delete(s),a&&(this.resourceMap.set(s,a),this.resources.push(a),this.emit("load",{viewer:this,fetchUrl:s,resource:a})),this.emit("loadend",{viewer:this,fetchUrl:s,resource:a}),this.checkLoadingStatus(),a)),this.promiseMap.set(s,o),this.emit("loadstart",{viewer:this,fetchUrl:s,promise:o}),o}}detectFormat(e){for(const t of this.handlers)if(t.isValidSource(e))return t}has(e){return this.resourceMap.has(e)}get(e){return this.resourceMap.get(e)}async loadGeneric(e,t,i){const n=this.promiseMap.get(e);if(n)return n;const s=this.resourceMap.get(e);if(s)return s;const o=Bi(e,t).then(async a=>{this.promiseMap.delete(e);let l;if(a.ok){let c=a.data;i&&(c=await i(c)),l=new Er(c,{viewer:this,fetchUrl:e}),this.resourceMap.set(e,l),this.resources.push(l),this.emit("load",{viewer:this,fetchUrl:e,resource:l})}else this.emit("error",{viewer:this,error:"Failed to fetch a generic resource",fetchUrl:e});return this.emit("loadend",{viewer:this,fetchUrl:e,resource:l}),this.checkLoadingStatus(),l});return this.promiseMap.set(e,o),this.emit("loadstart",{viewer:this,fetchUrl:e}),o}unload(e){const t=e.fetchUrl;t!==""&&this.resourceMap.delete(t);const i=this.resources,n=i.indexOf(e);return n!==-1?(i.splice(n,1),!0):!1}promise(){const e=Promise.resolve(void 0),t=`${performance.now()}`;return this.promiseMap.set(t,e),()=>{this.promiseMap.delete(t),this.checkLoadingStatus()}}checkLoadingStatus(){this.promiseMap.size===0&&setTimeout(()=>this.emit("idle"),0)}whenAllLoaded(e){const t=new Promise(i=>{this.promiseMap.size===0?i(this):this.once("idle",()=>i(this))});if(e)t.then(()=>e(this));else return t}toBlob(e){const t=new Promise(i=>this.canvas.toBlob(n=>i(n)));if(e)t.then(i=>e(i));else return t}updateAndRender(e=1e3/60){this.update(e),this.startFrame(),this.render()}update(e=1e3/60){e*=.001,this.frame+=1,this.visibleCells=0,this.visibleInstances=0,this.updatedParticles=0;for(const t of this.scenes)t.update(e),this.visibleCells+=t.visibleCells,this.visibleInstances+=t.visibleInstances,this.updatedParticles+=t.updatedParticles}startFrame(){const e=this.gl;e.depthMask(!0),e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)}render(){for(const e of this.scenes)e.render()}clearEmittedObjects(){for(const e of this.scenes)e.clearEmittedObjects()}}let Zt;typeof OfflineAudioContext=="function"&&(Zt=new OfflineAudioContext(1,1,48e3));async function Mr(r){if(Zt)return Zt.decodeAudioData(r)}const Nr=new TextDecoder,Vr=new TextEncoder;function wt(r){return Nr.decode(r)}function Qt(r){return Vr.encode(r)}function j(r){let e=r.length;for(let t=r.length-1;t>=0;t--){const i=r.charCodeAt(t);i>127&&i<=2047?e++:i>2047&&i<=65535&&(e+=2),i>=56320&&i<=57343&&t--}return e}function Ue(r){return r instanceof Uint8Array?r:typeof r=="string"?Qt(r):new Uint8Array(r)}function Vi(r,e,t=0,i=1/0){const n=Math.max(t,0),s=Math.min(n+i,r.length);let o=0,a=e.charCodeAt(0);for(let l=n;l<s;l++)if(r[l]===a){if(o+=1,o===e.length)return!0;a=e.charCodeAt(o)}else o>0&&(o=0,a=e.charCodeAt(0));return!1}function Gr(r,e,t=0,i=1/0){const n=Math.max(t,0),s=Math.min(n+i,r.length);let o=0,a=e[0];for(let l=n;l<s;l++)if(r[l]===a){if(o+=1,o===e.length)return!0;a=e[o]}else o>0&&(o=0,a=e[0]);return!1}function jr(r,e,t=0,i=1/0){const n=Math.max(t,0),s=Math.min(n+i,r.length);for(let o=n;o<s;o++)if(r[o]===e)return o;return-1}const Le=new ArrayBuffer(8),Gi=new Int8Array(Le),ji=new Int16Array(Le),Hi=new Int32Array(Le),R=new Uint8Array(Le),qi=new Uint16Array(Le),bt=new Uint32Array(Le),Ki=new Float32Array(Le),$i=new Float64Array(Le);function zi(r){return R[0]=r,Gi[0]}function Xi(r,e){return R[0]=r,R[1]=e,ji[0]}function Yi(r,e,t,i){return R[0]=r,R[1]=e,R[2]=t,R[3]=i,Hi[0]}function Wi(r,e){return R[0]=r,R[1]=e,qi[0]}function Zi(r,e,t,i){return R[0]=r,R[1]=e,R[2]=t,R[3]=i,bt[0]}function Qi(r,e,t,i){return R[0]=r,R[1]=e,R[2]=t,R[3]=i,Ki[0]}function Ji(r,e,t,i,n,s,o,a){return R[0]=r,R[1]=e,R[2]=t,R[3]=i,R[4]=n,R[5]=s,R[6]=o,R[7]=a,$i[0]}function en(r){return R[0]=r,Gi[0]}function tn(r,e){return ji[0]=e,r[0]=R[0],r[1]=R[1],r}function nn(r,e){return Hi[0]=e,r[0]=R[0],r[1]=R[1],r[2]=R[2],r[3]=R[3],r}function sn(r,e){return qi[0]=e,r[0]=R[0],r[1]=R[1],r}function rn(r,e){return bt[0]=e,r[0]=R[0],r[1]=R[1],r[2]=R[2],r[3]=R[3],r}function on(r,e){return Ki[0]=e,r[0]=R[0],r[1]=R[1],r[2]=R[2],r[3]=R[3],r}function an(r,e){return $i[0]=e,r[0]=R[0],r[1]=R[1],r[2]=R[2],r[3]=R[3],r[4]=R[4],r[5]=R[5],r[6]=R[6],r[7]=R[7],r}function ln(r){return bt[0]=r,bt[0]}function Hr(r){const e=[];for(;r>0;)e.push(String.fromCharCode(r%256)),r=Math.floor(r/256);return e.reverse().join("")}const I=new Uint8Array(8);class q{buffer;uint8array;index=0;byteLength;remaining;constructor(e,t,i){const n=Ue(e);t=t||0,i=i||n.length,this.buffer=e,this.uint8array=n.subarray(t,t+i),this.byteLength=i,this.remaining=i}substream(e){if(this.remaining<e)throw new Error(`ByteStream: substream: want ${e} bytes but have ${this.remaining}`);const t=this.index;return this.index+=e,new q(this.uint8array.subarray(t,t+e))}skip(e){if(this.remaining<e)throw new Error(`ByteStream: skip: premature end - want ${e} bytes but have ${this.remaining}`);this.index+=e,this.remaining-=e}seek(e){this.index=e,this.remaining=this.byteLength-e}read(e){if(this.remaining<e)throw new Error(`ByteStream: read: premature end - want ${e} bytes but have ${this.remaining}`);const t=this.uint8array,i=this.index;let n=jr(t,0,i,e);return n===-1&&(n=i+e),this.index+=e,this.remaining-=e,wt(t.subarray(i,n))}readNull(){if(this.remaining<1)throw new Error("ByteStream: readNull: premature end - want at least 1 byte but have 0");const e=this.uint8array,t=this.index;let i=e.indexOf(0,t);i===-1&&(i=e.length-1);const n=i-t+1;return this.index+=n,this.remaining-=n,wt(e.subarray(t,i))}readBinary(e){if(this.remaining<e)throw new Error(`ByteStream: readBinary: premature end - want ${e} bytes but have ${this.remaining}`);const t=this.uint8array,i=this.index;let n="";for(let s=0;s<e;s++)n+=String.fromCharCode(t[i+s]);return this.index+=e,this.remaining-=e,n}readInt8(){if(this.remaining<1)throw new Error(`ByteStream: readInt8: premature end - want 1 byte but have ${this.remaining}`);const e=this.index,t=this.uint8array,i=zi(t[e]);return this.index+=1,this.remaining-=1,i}readInt16(){if(this.remaining<2)throw new Error(`ByteStream: readInt16: premature end - want 2 bytes but have ${this.remaining}`);const e=this.index,t=this.uint8array,i=Xi(t[e],t[e+1]);return this.index+=2,this.remaining-=2,i}readInt32(){if(this.remaining<4)throw new Error(`ByteStream: readInt32: premature end - want 4 bytes but have ${this.remaining}`);const e=this.index,t=this.uint8array,i=Yi(t[e],t[e+1],t[e+2],t[e+3]);return this.index+=4,this.remaining-=4,i}readUint8(){if(this.remaining<1)throw new Error(`ByteStream: readUint8: premature end - want 1 byte but have ${this.remaining}`);const e=this.uint8array[this.index];return this.index+=1,this.remaining-=1,e}readUint16(){if(this.remaining<2)throw new Error(`ByteStream: readUint16: premature end - want 2 bytes but have ${this.remaining}`);const e=this.index,t=this.uint8array,i=Wi(t[e],t[e+1]);return this.index+=2,this.remaining-=2,i}readUint32(){if(this.remaining<4)throw new Error(`ByteStream: readUint32: premature end - want 4 bytes but have ${this.remaining}`);const e=this.index,t=this.uint8array,i=Zi(t[e],t[e+1],t[e+2],t[e+3]);return this.index+=4,this.remaining-=4,i}readFloat32(){if(this.remaining<4)throw new Error(`ByteStream: readFloat32: premature end - want 4 bytes but have ${this.remaining}`);const e=this.index,t=this.uint8array,i=Qi(t[e],t[e+1],t[e+2],t[e+3]);return this.index+=4,this.remaining-=4,i}readFloat64(){if(this.remaining<8)throw new Error(`ByteStream: readFloat64: premature end - want 8 bytes but have ${this.remaining}`);const e=this.index,t=this.uint8array,i=Ji(t[e],t[e+1],t[e+2],t[e+3],t[e+4],t[e+5],t[e+6],t[e+7]);return this.index+=8,this.remaining-=8,i}readInt8Array(e){if(ArrayBuffer.isView(e)||(e=new Int8Array(e)),this.remaining<e.byteLength)throw new Error(`ByteStream: readInt8Array: premature end - want ${e.byteLength} bytes but have ${this.remaining}`);const t=this.index,i=this.uint8array;for(let n=0,s=e.length;n<s;n++)e[n]=zi(i[t+n]);return this.index+=e.byteLength,this.remaining-=e.byteLength,e}readInt16Array(e){if(ArrayBuffer.isView(e)||(e=new Int16Array(e)),this.remaining<e.byteLength)throw new Error(`ByteStream: readInt16Array: premature end - want ${e.byteLength} bytes but have ${this.remaining}`);const t=this.index,i=this.uint8array;for(let n=0,s=e.length;n<s;n++){const o=t+n*2;e[n]=Xi(i[o],i[o+1])}return this.index+=e.byteLength,this.remaining-=e.byteLength,e}readInt32Array(e){if(ArrayBuffer.isView(e)||(e=new Int32Array(e)),this.remaining<e.byteLength)throw new Error(`ByteStream: readInt32Array: premature end - want ${e.byteLength} bytes but have ${this.remaining}`);const t=this.index,i=this.uint8array;for(let n=0,s=e.length;n<s;n++){const o=t+n*4;e[n]=Yi(i[o],i[o+1],i[o+2],i[o+3])}return this.index+=e.byteLength,this.remaining-=e.byteLength,e}readUint8Array(e){if(ArrayBuffer.isView(e)||(e=new Uint8Array(e)),this.remaining<e.byteLength)throw new Error(`ByteStream: readUint8Array: premature end - want ${e.byteLength} bytes but have ${this.remaining}`);const t=this.index,i=this.uint8array;for(let n=0,s=e.length;n<s;n++)e[n]=i[t+n];return this.index+=e.byteLength,this.remaining-=e.byteLength,e}readUint16Array(e){if(ArrayBuffer.isView(e)||(e=new Uint16Array(e)),this.remaining<e.byteLength)throw new Error(`ByteStream: readUint16Array: premature end - want ${e.byteLength} bytes but have ${this.remaining}`);const t=this.index,i=this.uint8array;for(let n=0,s=e.length;n<s;n++){const o=t+n*2;e[n]=Wi(i[o],i[o+1])}return this.index+=e.byteLength,this.remaining-=e.byteLength,e}readUint32Array(e){if(ArrayBuffer.isView(e)||(e=new Uint32Array(e)),this.remaining<e.byteLength)throw new Error(`ByteStream: readUint32Array: premature end - want ${e.byteLength} bytes but have ${this.remaining}`);const t=this.index,i=this.uint8array;for(let n=0,s=e.length;n<s;n++){const o=t+n*4;e[n]=Zi(i[o],i[o+1],i[o+2],i[o+3])}return this.index+=e.byteLength,this.remaining-=e.byteLength,e}readFloat32Array(e){if(ArrayBuffer.isView(e)||(e=new Float32Array(e)),this.remaining<e.byteLength)throw new Error(`ByteStream: readFloat32Array: premature end - want ${e.byteLength} bytes but have ${this.remaining}`);const t=this.index,i=this.uint8array;for(let n=0,s=e.length;n<s;n++){const o=t+n*4;e[n]=Qi(i[o],i[o+1],i[o+2],i[o+3])}return this.index+=e.byteLength,this.remaining-=e.byteLength,e}readFloat64Array(e){if(ArrayBuffer.isView(e)||(e=new Float64Array(e)),this.remaining<e.byteLength)throw new Error(`ByteStream: readFloat64Array: premature end - want ${e.byteLength} bytes but have ${this.remaining}`);const t=this.index,i=this.uint8array;for(let n=0,s=e.length;n<s;n++){const o=t+n*8;e[n]=Ji(i[o],i[o+1],i[o+2],i[o+3],i[o+4],i[o+5],i[o+6],i[o+7])}return this.index+=e.byteLength,this.remaining-=e.byteLength,e}write(e){const t=Qt(e);return this.writeUint8Array(t),t.length}writeNull(e){const t=this.write(e);return this.index++,this.remaining--,t+1}writeBinary(e){const t=this.index,i=this.uint8array,n=e.length;for(let s=0;s<n;s++)i[t+s]=e.charCodeAt(s);this.index+=n}writeInt8(e){this.uint8array[this.index]=en(e),this.index+=1}writeInt16(e){const t=this.index,i=this.uint8array;tn(I,e),i[t]=I[0],i[t+1]=I[1],this.index+=2}writeInt32(e){const t=this.index,i=this.uint8array;nn(I,e),i[t]=I[0],i[t+1]=I[1],i[t+2]=I[2],i[t+3]=I[3],this.index+=4}writeUint8(e){this.uint8array[this.index]=e,this.index+=1}writeUint16(e){const t=this.index,i=this.uint8array;sn(I,e),i[t]=I[0],i[t+1]=I[1],this.index+=2}writeUint32(e){const t=this.index,i=this.uint8array;rn(I,e),i[t]=I[0],i[t+1]=I[1],i[t+2]=I[2],i[t+3]=I[3],this.index+=4}writeFloat32(e){const t=this.index,i=this.uint8array;on(I,e),i[t]=I[0],i[t+1]=I[1],i[t+2]=I[2],i[t+3]=I[3],this.index+=4}writeFloat64(e){const t=this.index,i=this.uint8array;an(I,e),i[t]=I[0],i[t+1]=I[1],i[t+2]=I[2],i[t+3]=I[3],i[t+4]=I[4],i[t+5]=I[5],i[t+6]=I[6],i[t+7]=I[7],this.index+=8}writeInt8Array(e){const t=this.index,i=this.uint8array;for(let n=0,s=e.length;n<s;n++)i[t+n]=en(e[n]);this.index+=e.byteLength}writeInt16Array(e){const t=this.index,i=this.uint8array;for(let n=0,s=e.length;n<s;n++){const o=t+n*2;tn(I,e[n]),i[o]=I[0],i[o+1]=I[1]}this.index+=e.byteLength}writeInt32Array(e){const t=this.index,i=this.uint8array;for(let n=0,s=e.length;n<s;n++){const o=t+n*4;nn(I,e[n]),i[o]=I[0],i[o+1]=I[1],i[o+2]=I[2],i[o+3]=I[3]}this.index+=e.byteLength}writeUint8Array(e){const t=this.index,i=this.uint8array;for(let n=0,s=e.length;n<s;n++)i[t+n]=e[n];this.index+=e.byteLength}writeUint16Array(e){const t=this.index,i=this.uint8array;for(let n=0,s=e.length;n<s;n++){const o=t+n*2;sn(I,e[n]),i[o]=I[0],i[o+1]=I[1]}this.index+=e.byteLength}writeUint32Array(e){const t=this.index,i=this.uint8array;for(let n=0,s=e.length;n<s;n++){const o=t+n*4;rn(I,e[n]),i[o]=I[0],i[o+1]=I[1],i[o+2]=I[2],i[o+3]=I[3]}this.index+=e.byteLength}writeFloat32Array(e){const t=this.index,i=this.uint8array;for(let n=0,s=e.length;n<s;n++){const o=t+n*4;on(I,e[n]),i[o]=I[0],i[o+1]=I[1],i[o+2]=I[2],i[o+3]=I[3]}this.index+=e.byteLength}writeFloat64Array(e){const t=this.index,i=this.uint8array;for(let n=0,s=e.length;n<s;n++){const o=t+n*8;an(I,e[n]),i[o]=I[0],i[o+1]=I[1],i[o+2]=I[2],i[o+3]=I[3],i[o+4]=I[4],i[o+5]=I[5],i[o+6]=I[6],i[o+7]=I[7]}this.index+=e.byteLength}}class Jt{buffer;index=0;ident=0;indentSpaces=4;precision=1e6;constructor(e){this.buffer=e||""}clear(){this.buffer="",this.index=0,this.ident=0}readToken(){const e=this.buffer,t=e.length;let i=!1,n=!1,s="";for(;this.index<t;){const o=e[this.index++];if(i)o===`
`&&(i=!1);else if(n)if(o==="\\")s+=o+e[this.index++];else if(o===`
`)s+="\\n";else if(o==="\r")s+="\\r";else{if(o==='"')return s;s+=o}else if(o===" "||o===","||o==="	"||o===`
`||o===":"||o==="\r"){if(s.length)return s}else{if(o==="{"||o==="}")return s.length?(this.index--,s):o;if(o==="/"&&e[this.index]==="/"){if(s.length)return this.index--,s;i=!0}else if(o==='"'){if(s.length)return this.index--,s;n=!0}else s+=o}}}read(){const e=this.readToken();if(e===void 0)throw new Error("End of stream reached prematurely");return e}peek(){const e=this.index,t=this.read();return this.index=e,t}readInt(){return parseInt(this.read())}readFloat(){return parseFloat(this.read())}readVector(e){this.read();for(let t=0,i=e.length;t<i;t++)e[t]=this.readFloat();return this.read(),e}readVectorsBlock(e,t){this.read();for(let i=0,n=e.length;i<n;i+=t)this.readVector(e.subarray(i,i+t));return this.read(),e}readColor(e){return this.read(),e[2]=this.readFloat(),e[1]=this.readFloat(),e[0]=this.readFloat(),this.read(),e}*readBlock(){this.read();let e=this.read();for(;e!=="}";)yield e,e=this.read()}writeLine(e){this.buffer+=`${" ".repeat(this.ident*this.indentSpaces)}${e}
`}writeFlag(e){this.writeLine(`${e},`)}writeFlagAttrib(e,t){this.writeLine(`${e} ${t},`)}writeNumberAttrib(e,t){this.writeLine(`${e} ${this.floatDecimals(t)},`)}writeStringAttrib(e,t){this.writeLine(`${e} "${t}",`)}writeVectorAttrib(e,t){this.writeLine(`${e} { ${this.floatArrayDecimals(t)} },`)}writeColor(e,t){const i=this.floatDecimals(t[0]),n=this.floatDecimals(t[1]),s=this.floatDecimals(t[2]);this.writeLine(`${e} { ${s}, ${n}, ${i} },`)}writeVector(e){this.writeLine(`{ ${this.floatArrayDecimals(e)} },`)}writeVectorArrayBlock(e,t,i){this.startBlock(e,t.length/i);for(let n=0,s=t.length;n<s;n+=i)this.writeVector(t.subarray(n,n+i));this.endBlock()}startBlock(e,...t){t.length&&(e=`${e} ${t.join(" ")}`),this.writeLine(`${e} {`),this.ident+=1}startObjectBlock(e,t){this.writeLine(`${e} "${t.replace(/"/g,'\\"')}" {`),this.ident+=1}endBlock(){this.ident-=1,this.writeLine("}")}endBlockComma(){this.ident-=1,this.writeLine("},")}indent(){this.ident+=1}unindent(){this.ident-=1}floatDecimals(e){return`${Math.trunc(e*this.precision)/this.precision}`}floatArrayDecimals(e){if(e instanceof Float32Array){const t=[];for(let i=0,n=e.length;i<n;i++)t[i]=this.floatDecimals(e[i]);return t.join(", ")}else return e.join(", ")}}class nt{boundsRadius=0;min=new Float32Array(3);max=new Float32Array(3);readMdx(e){this.boundsRadius=e.readFloat32(),e.readFloat32Array(this.min),e.readFloat32Array(this.max)}writeMdx(e){e.writeFloat32(this.boundsRadius),e.writeFloat32Array(this.min),e.writeFloat32Array(this.max)}writeMdl(e){(this.min[0]!==0||this.min[1]!==0||this.min[2]!==0)&&e.writeVectorAttrib("MinimumExtent",this.min),(this.max[0]!==0||this.max[1]!==0||this.max[2]!==0)&&e.writeVectorAttrib("MaximumExtent",this.max),this.boundsRadius!==0&&e.writeNumberAttrib("BoundsRadius",this.boundsRadius)}}let cn=class{name="";interval=new Uint32Array(2);moveSpeed=0;nonLooping=0;rarity=0;syncPoint=0;extent=new nt;readMdx(e){this.name=e.read(80),e.readUint32Array(this.interval),this.moveSpeed=e.readFloat32(),this.nonLooping=e.readUint32(),this.rarity=e.readFloat32(),this.syncPoint=e.readUint32(),this.extent.readMdx(e)}writeMdx(e){e.skip(80-e.write(this.name)),e.writeUint32Array(this.interval),e.writeFloat32(this.moveSpeed),e.writeUint32(this.nonLooping),e.writeFloat32(this.rarity),e.writeUint32(this.syncPoint),this.extent.writeMdx(e)}readMdl(e){this.name=e.read();for(const t of e.readBlock())if(t==="Interval")e.readVector(this.interval);else if(t==="NonLooping")this.nonLooping=1;else if(t==="MoveSpeed")this.moveSpeed=e.readFloat();else if(t==="Rarity")this.rarity=e.readFloat();else if(t==="MinimumExtent")e.readVector(this.extent.min);else if(t==="MaximumExtent")e.readVector(this.extent.max);else if(t==="BoundsRadius")this.extent.boundsRadius=e.readFloat();else throw new Error(`Unknown token in Sequence: "${t}"`)}writeMdl(e){e.startObjectBlock("Anim",this.name),e.writeVectorAttrib("Interval",this.interval),this.nonLooping===1&&e.writeFlag("NonLooping"),this.moveSpeed!==0&&e.writeNumberAttrib("MoveSpeed",this.moveSpeed),this.rarity!==0&&e.writeNumberAttrib("Rarity",this.rarity),this.extent.writeMdl(e),e.endBlock()}};var J=(r=>(r[r.DontInterp=0]="DontInterp",r[r.Linear=1]="Linear",r[r.Hermite=2]="Hermite",r[r.Bezier=3]="Bezier",r))(J||{});class mt{name="";interpolationType=0;globalSequenceId=-1;frames=[];values=[];inTans=[];outTans=[];readMdx(e,t){const i=this.frames,n=this.values,s=this.inTans,o=this.outTans,a=e.readUint32(),l=e.readUint32();this.name=t,this.interpolationType=l,this.globalSequenceId=e.readInt32();for(let c=0;c<a;c++)i.push(e.readInt32()),n.push(this.readMdxValue(e)),l>1&&(s.push(this.readMdxValue(e)),o.push(this.readMdxValue(e)))}writeMdx(e){const t=this.interpolationType,i=this.frames,n=this.values,s=this.inTans,o=this.outTans,a=i.length;e.writeBinary(this.name),e.writeUint32(a),e.writeUint32(t),e.writeInt32(this.globalSequenceId);for(let l=0;l<a;l++)e.writeInt32(i[l]),this.writeMdxValue(e,n[l]),t>1&&(this.writeMdxValue(e,s[l]),this.writeMdxValue(e,o[l]))}readMdl(e,t){const i=this.frames,n=this.values,s=this.inTans,o=this.outTans;this.name=t;const a=e.readInt();e.read();let l=0;const c=e.read();c==="DontInterp"?l=0:c==="Linear"?l=1:c==="Hermite"?l=2:c==="Bezier"&&(l=3),this.interpolationType=l,e.peek()==="GlobalSeqId"&&(e.read(),this.globalSequenceId=e.readInt());for(let d=0;d<a;d++)i[d]=e.readInt(),n[d]=this.readMdlValue(e),l>1&&(e.read(),s[d]=this.readMdlValue(e),e.read(),o[d]=this.readMdlValue(e));e.read()}writeMdl(e,t){const i=this.interpolationType,n=this.frames,s=this.values,o=this.inTans,a=this.outTans,l=n.length;e.startBlock(t,this.frames.length);let c="";this.interpolationType===0?c="DontInterp":this.interpolationType===1?c="Linear":this.interpolationType===2?c="Hermite":this.interpolationType===3&&(c="Bezier"),e.writeFlag(c),this.globalSequenceId!==-1&&e.writeNumberAttrib("GlobalSeqId",this.globalSequenceId);for(let d=0;d<l;d++)this.writeMdlValue(e,`${n[d]}:`,s[d]),i>1&&(e.indent(),this.writeMdlValue(e,"InTan",o[d]),this.writeMdlValue(e,"OutTan",a[d]),e.unindent());e.endBlock()}getByteLength(){const e=this.frames.length;let t=16;if(e){const i=this.values[0].byteLength;let n=1;this.interpolationType>1&&(n=3),t+=(4+n*i)*e}return t}}class At extends mt{readMdxValue(e){return e.readUint32Array(1)}writeMdxValue(e,t){e.writeUint32(t[0])}readMdlValue(e){return new Uint32Array([e.readInt()])}writeMdlValue(e,t,i){e.writeNumberAttrib(t,i[0])}}class M extends mt{readMdxValue(e){return e.readFloat32Array(1)}writeMdxValue(e,t){e.writeFloat32(t[0])}readMdlValue(e){return new Float32Array([e.readFloat()])}writeMdlValue(e,t,i){e.writeNumberAttrib(t,i[0])}}class he extends mt{readMdxValue(e){return e.readFloat32Array(3)}writeMdxValue(e,t){e.writeFloat32Array(t)}readMdlValue(e){return e.readVector(new Float32Array(3))}writeMdlValue(e,t,i){e.writeVectorAttrib(t,i)}}class hn extends mt{readMdxValue(e){return e.readFloat32Array(4)}writeMdxValue(e,t){e.writeFloat32Array(t)}readMdlValue(e){return e.readVector(new Float32Array(4))}writeMdlValue(e,t,i){e.writeVectorAttrib(t,i)}}const ei={KMTF:["TextureID",At],KMTA:["Alpha",M],KMTE:["EmissiveGain",M],KFC3:["FresnelColor",he],KFCA:["FresnelOpacity",M],KFTC:["FresnelTeamColor",At],KTAT:["Translation",he],KTAR:["Rotation",hn],KTAS:["Scaling",he],KGAO:["Alpha",M],KGAC:["Color",he],KGTR:["Translation",he],KGRT:["Rotation",hn],KGSC:["Scaling",he],KLAS:["AttenuationStart",M],KLAE:["AttenuationEnd",M],KLAC:["Color",he],KLAI:["Intensity",M],KLBI:["AmbIntensity",M],KLBC:["AmbColor",he],KLAV:["Visibility",M],KATV:["Visibility",M],KPEE:["EmissionRate",M],KPEG:["Gravity",M],KPLN:["Longitude",M],KPLT:["Latitude",M],KPEL:["LifeSpan",M],KPES:["InitVelocity",M],KPEV:["Visibility",M],KP2S:["Speed",M],KP2R:["Variation",M],KP2L:["Latitude",M],KP2G:["Gravity",M],KP2E:["EmissionRate",M],KP2N:["Width",M],KP2W:["Length",M],KP2V:["Visibility",M],KPPA:["Alpha",M],KPPC:["Color",he],KPPE:["EmissionRate",M],KPPL:["LifeSpan",M],KPPS:["Speed",M],KPPV:["Visibility",M],KRHA:["HeightAbove",M],KRHB:["HeightBelow",M],KRAL:["Alpha",M],KRCO:["Color",he],KRTX:["TextureSlot",At],KRVS:["Visibility",M],KCTR:["Translation",he],KTTR:["Translation",he],KCRL:["Rotation",M]};let st=class{animations=[];readAnimations(e,t){const i=e.index+t;for(;e.index<i;){const n=e.readBinary(4),s=new ei[n][1];s.readMdx(e,n),this.animations.push(s)}}writeAnimations(e){for(const t of this.animations)t.writeMdx(e)}*readAnimatedBlock(e){for(const t of e.readBlock())t==="static"?yield`static ${e.read()}`:yield t}readAnimation(e,t){const i=new ei[t][1];i.readMdl(e,t),this.animations.push(i)}writeAnimation(e,t){for(const i of this.animations)if(i.name===t)return i.writeMdl(e,ei[t][0]),!0;return!1}getByteLength(e=0){let t=0;for(const i of this.animations)t+=i.getByteLength();return t}};var ve=(r=>(r[r.None=0]="None",r[r.Transparent=1]="Transparent",r[r.Blend=2]="Blend",r[r.Additive=3]="Additive",r[r.AddAlpha=4]="AddAlpha",r[r.Modulate=5]="Modulate",r[r.Modulate2x=6]="Modulate2x",r))(ve||{}),Pe=(r=>(r[r.None=0]="None",r[r.Unshaded=1]="Unshaded",r[r.SphereEnvMap=2]="SphereEnvMap",r[r.TwoSided=16]="TwoSided",r[r.Unfogged=32]="Unfogged",r[r.NoDepthTest=64]="NoDepthTest",r[r.NoDepthSet=128]="NoDepthSet",r[r.Unlit=256]="Unlit",r))(Pe||{});function qr(r){return r==="None"?0:r==="Transparent"?1:r==="Blend"?2:r==="Additive"?3:r==="AddAlpha"?4:r==="Modulate"?5:r==="Modulate2x"?6:0}function Kr(r){return r===0?"None":r===1?"Transparent":r===2?"Blend":r===3?"Additive":r===4?"AddAlpha":r===5?"Modulate":r===6?"Modulate2x":"None"}let dn=class extends st{filterMode=0;flags=0;textureId=-1;textureAnimationId=-1;coordId=0;alpha=1;emissiveGain=1;fresnelColor=new Float32Array([1,1,1]);fresnelOpacity=0;fresnelTeamColor=0;readMdx(e,t){const i=e.index,n=e.readUint32();this.filterMode=e.readUint32(),this.flags=e.readUint32(),this.textureId=e.readInt32(),this.textureAnimationId=e.readInt32(),this.coordId=e.readUint32(),this.alpha=e.readFloat32(),t>800&&(this.emissiveGain=e.readFloat32(),e.readFloat32Array(this.fresnelColor),this.fresnelOpacity=e.readFloat32(),this.fresnelTeamColor=e.readFloat32()),this.readAnimations(e,n-(e.index-i))}writeMdx(e,t){e.writeUint32(this.getByteLength(t)),e.writeUint32(this.filterMode),e.writeUint32(this.flags),e.writeInt32(this.textureId),e.writeInt32(this.textureAnimationId),e.writeUint32(this.coordId),e.writeFloat32(this.alpha),t>800&&(e.writeFloat32(this.emissiveGain),e.writeFloat32Array(this.fresnelColor),e.writeFloat32(this.fresnelOpacity),e.writeFloat32(this.fresnelTeamColor)),this.writeAnimations(e)}readMdl(e){for(const t of super.readAnimatedBlock(e))if(t==="FilterMode")this.filterMode=qr(e.read());else if(t==="Unshaded")this.flags|=1;else if(t==="SphereEnvMap")this.flags|=2;else if(t==="TwoSided")this.flags|=16;else if(t==="Unfogged")this.flags|=32;else if(t==="NoDepthTest")this.flags|=64;else if(t==="NoDepthSet")this.flags|=128;else if(t==="Unlit")this.flags|=256;else if(t==="static TextureID")this.textureId=e.readInt();else if(t==="TextureID")this.readAnimation(e,"KMTF");else if(t==="TVertexAnimId")this.textureAnimationId=e.readInt();else if(t==="CoordId")this.coordId=e.readInt();else if(t==="static Alpha")this.alpha=e.readFloat();else if(t==="Alpha")this.readAnimation(e,"KMTA");else if(t==="static EmissiveGain")this.emissiveGain=e.readFloat();else if(t==="EmissiveGain")this.readAnimation(e,"KMTE");else if(t==="static FresnelColor")e.readVector(this.fresnelColor);else if(t==="FresnelColor")this.readAnimation(e,"KFC3");else if(t==="static FresnelOpacity")this.fresnelOpacity=e.readFloat();else if(t==="FresnelOpacity")this.readAnimation(e,"KFCA");else if(t==="static FresnelTeamColor")this.fresnelTeamColor=e.readFloat();else if(t==="FresnelTeamColor")this.readAnimation(e,"KFTC");else throw new Error(`Unknown token in Layer: "${t}"`)}writeMdl(e,t){e.startBlock("Layer"),e.writeFlagAttrib("FilterMode",Kr(this.filterMode)),this.flags&1&&e.writeFlag("Unshaded"),this.flags&2&&e.writeFlag("SphereEnvMap"),this.flags&16&&e.writeFlag("TwoSided"),this.flags&32&&e.writeFlag("Unfogged"),this.flags&64&&e.writeFlag("NoDepthTest"),this.flags&128&&e.writeFlag("NoDepthSet"),t>800&&this.flags&256&&e.writeFlag("Unlit"),this.writeAnimation(e,"KMTF")||e.writeNumberAttrib("static TextureID",this.textureId),this.textureAnimationId!==-1&&e.writeNumberAttrib("TVertexAnimId",this.textureAnimationId),this.coordId!==0&&e.writeNumberAttrib("CoordId",this.coordId),!this.writeAnimation(e,"KMTA")&&this.alpha!==1&&e.writeNumberAttrib("static Alpha",this.alpha),t>800&&(!this.writeAnimation(e,"KMTE")&&this.emissiveGain!==1&&e.writeNumberAttrib("static EmissiveGain",this.emissiveGain),!this.writeAnimation(e,"KFC3")&&(this.fresnelColor[0]!==1||this.fresnelColor[1]!==1||this.fresnelColor[2]!==1)&&e.writeVectorAttrib("static FresnelColor",this.fresnelColor),!this.writeAnimation(e,"KFCA")&&this.fresnelOpacity!==0&&e.writeNumberAttrib("static FresnelOpacity",this.fresnelOpacity),!this.writeAnimation(e,"KFTC")&&this.fresnelTeamColor!==0&&e.writeNumberAttrib("static FresnelTeamColor",this.fresnelTeamColor)),e.endBlock()}getByteLength(e){let t=28+super.getByteLength();return e>800&&(t+=24),t}},fn=class{priorityPlane=0;flags=0;shader="";layers=[];readMdx(e,t){e.readUint32(),this.priorityPlane=e.readInt32(),this.flags=e.readUint32(),t>800&&(this.shader=e.read(80)),e.skip(4);for(let i=0,n=e.readUint32();i<n;i++){const s=new dn;s.readMdx(e,t),this.layers.push(s)}}writeMdx(e,t){e.writeUint32(this.getByteLength(t)),e.writeInt32(this.priorityPlane),e.writeUint32(this.flags),t>800&&e.skip(80-e.write(this.shader)),e.writeBinary("LAYS"),e.writeUint32(this.layers.length);for(const i of this.layers)i.writeMdx(e,t)}readMdl(e){for(const t of e.readBlock())if(t==="ConstantColor")this.flags|=1;else if(t==="TwoSided")this.flags|=2;else if(t==="SortPrimsNearZ")this.flags|=8;else if(t==="SortPrimsFarZ")this.flags|=16;else if(t==="FullResolution")this.flags|=32;else if(t==="PriorityPlane")this.priorityPlane=e.readInt();else if(t==="Shader")this.shader=e.read();else if(t==="Layer"){const i=new dn;i.readMdl(e),this.layers.push(i)}else throw new Error(`Unknown token in Material: "${t}"`)}writeMdl(e,t){e.startBlock("Material"),this.flags&1&&e.writeFlag("ConstantColor"),t>800&&this.flags&2&&e.writeFlag("TwoSided"),this.flags&8&&e.writeFlag("SortPrimsNearZ"),this.flags&16&&e.writeFlag("SortPrimsFarZ"),this.flags&32&&e.writeFlag("FullResolution"),this.priorityPlane!==0&&e.writeNumberAttrib("PriorityPlane",this.priorityPlane),t>800&&e.writeStringAttrib("Shader",this.shader);for(const i of this.layers)i.writeMdl(e,t);e.endBlock()}getByteLength(e){let t=20;e>800&&(t+=80);for(const i of this.layers)t+=i.getByteLength(e);return t}};var De=(r=>(r[r.RepeatBoth=0]="RepeatBoth",r[r.WrapWidth=1]="WrapWidth",r[r.WrapHeight=2]="WrapHeight",r[r.WrapBoth=3]="WrapBoth",r))(De||{});class un{replaceableId=0;path="";wrapMode=0;readMdx(e){this.replaceableId=e.readUint32(),this.path=e.read(260),this.wrapMode=e.readUint32()}writeMdx(e){e.writeUint32(this.replaceableId),e.skip(260-e.write(this.path)),e.writeUint32(this.wrapMode)}readMdl(e){for(const t of e.readBlock())if(t==="Image")this.path=e.read();else if(t==="ReplaceableId")this.replaceableId=e.readInt();else if(t==="WrapWidth")this.wrapMode|=1;else if(t==="WrapHeight")this.wrapMode|=2;else throw new Error(`Unknown token in Texture: "${t}"`)}writeMdl(e){e.startBlock("Bitmap"),this.path.length&&e.writeStringAttrib("Image",this.path),this.replaceableId!==0&&e.writeNumberAttrib("ReplaceableId",this.replaceableId),this.wrapMode&1&&e.writeFlag("WrapWidth"),this.wrapMode&2&&e.writeFlag("WrapHeight"),e.endBlock()}}let pn=class extends st{readMdx(e){const t=e.readUint32();this.readAnimations(e,t-4)}writeMdx(e){e.writeUint32(this.getByteLength()),this.writeAnimations(e)}readMdl(e){for(const t of e.readBlock())if(t==="Translation")this.readAnimation(e,"KTAT");else if(t==="Rotation")this.readAnimation(e,"KTAR");else if(t==="Scaling")this.readAnimation(e,"KTAS");else throw new Error(`Unknown token in TextureAnimation: "${t}"`)}writeMdl(e){e.startBlock("TVertexAnim "),this.writeAnimation(e,"KTAT"),this.writeAnimation(e,"KTAR"),this.writeAnimation(e,"KTAS"),e.endBlock()}getByteLength(){return 4+super.getByteLength()}},gn=class{vertices=new Float32Array(0);normals=new Float32Array(0);faceTypeGroups=new Uint32Array(0);faceGroups=new Uint32Array(0);faces=new Uint16Array(0);vertexGroups=new Uint8Array(0);matrixGroups=new Uint32Array(0);matrixIndices=new Uint32Array(0);materialId=0;selectionGroup=0;selectionFlags=0;lod=-1;lodName="";extent=new nt;sequenceExtents=[];tangents=new Float32Array(0);skin=new Uint8Array(0);uvSets=[];readMdx(e,t){e.readUint32(),e.skip(4),this.vertices=e.readFloat32Array(e.readUint32()*3),e.skip(4),this.normals=e.readFloat32Array(e.readUint32()*3),e.skip(4),this.faceTypeGroups=e.readUint32Array(e.readUint32()),e.skip(4),this.faceGroups=e.readUint32Array(e.readUint32()),e.skip(4),this.faces=e.readUint16Array(e.readUint32()),e.skip(4),this.vertexGroups=e.readUint8Array(e.readUint32()),e.skip(4),this.matrixGroups=e.readUint32Array(e.readUint32()),e.skip(4),this.matrixIndices=e.readUint32Array(e.readUint32()),this.materialId=e.readUint32(),this.selectionGroup=e.readUint32(),this.selectionFlags=e.readUint32(),t>800&&(this.lod=e.readInt32(),this.lodName=e.read(80)),this.extent.readMdx(e);for(let i=0,n=e.readUint32();i<n;i++){const s=new nt;s.readMdx(e),this.sequenceExtents.push(s)}t>800&&(e.readBinary(4)==="TANG"?this.tangents=e.readFloat32Array(e.readUint32()*4):e.skip(-4),e.readBinary(4)==="SKIN"?this.skin=e.readUint8Array(e.readUint32()):e.skip(-4)),e.skip(4);for(let i=0,n=e.readUint32();i<n;i++)e.skip(4),this.uvSets.push(e.readFloat32Array(e.readUint32()*2))}writeMdx(e,t){e.writeUint32(this.getByteLength(t)),e.writeBinary("VRTX"),e.writeUint32(this.vertices.length/3),e.writeFloat32Array(this.vertices),e.writeBinary("NRMS"),e.writeUint32(this.normals.length/3),e.writeFloat32Array(this.normals),e.writeBinary("PTYP"),e.writeUint32(this.faceTypeGroups.length),e.writeUint32Array(this.faceTypeGroups),e.writeBinary("PCNT"),e.writeUint32(this.faceGroups.length),e.writeUint32Array(this.faceGroups),e.writeBinary("PVTX"),e.writeUint32(this.faces.length),e.writeUint16Array(this.faces),e.writeBinary("GNDX"),e.writeUint32(this.vertexGroups.length),e.writeUint8Array(this.vertexGroups),e.writeBinary("MTGC"),e.writeUint32(this.matrixGroups.length),e.writeUint32Array(this.matrixGroups),e.writeBinary("MATS"),e.writeUint32(this.matrixIndices.length),e.writeUint32Array(this.matrixIndices),e.writeUint32(this.materialId),e.writeUint32(this.selectionGroup),e.writeUint32(this.selectionFlags),t>800&&(e.writeInt32(this.lod),e.skip(80-e.write(this.lodName))),this.extent.writeMdx(e),e.writeUint32(this.sequenceExtents.length);for(const i of this.sequenceExtents)i.writeMdx(e);t>800&&(this.tangents.length&&(e.writeBinary("TANG"),e.writeUint32(this.tangents.length/4),e.writeFloat32Array(this.tangents)),this.skin.length&&(e.writeBinary("SKIN"),e.writeUint32(this.skin.length),e.writeUint8Array(this.skin))),e.writeBinary("UVAS"),e.writeUint32(this.uvSets.length);for(const i of this.uvSets)e.writeBinary("UVBS"),e.writeUint32(i.length/2),e.writeFloat32Array(i)}readMdl(e){for(let t of e.readBlock())if(t==="Vertices")this.vertices=e.readVectorsBlock(new Float32Array(e.readInt()*3),3);else if(t==="Normals")this.normals=e.readVectorsBlock(new Float32Array(e.readInt()*3),3);else if(t==="TVertices")this.uvSets.push(e.readVectorsBlock(new Float32Array(e.readInt()*2),2));else if(t==="VertexGroup"){const i=[];for(const n of e.readBlock())i.push(parseInt(n));this.vertexGroups=new Uint8Array(i)}else if(t==="Tangents")this.tangents=e.readVectorsBlock(new Float32Array(e.readInt()*4),4);else if(t==="SkinWeights")this.skin=e.readVector(new Uint8Array(e.readInt()*8));else if(t==="Faces"){this.faceTypeGroups=new Uint32Array([4]);const i=e.readInt(),n=e.readInt();e.read(),e.read(),this.faces=e.readVectorsBlock(new Uint16Array(n),n/i),this.faceGroups=new Uint32Array([n]),e.read()}else if(t==="Groups"){const i=[],n=[];e.readInt(),e.readInt();for(const s of e.readBlock()){let o=0;for(const a of e.readBlock())i.push(parseInt(a)),o+=1;n.push(o)}this.matrixIndices=new Uint32Array(i),this.matrixGroups=new Uint32Array(n)}else if(t==="MinimumExtent")e.readVector(this.extent.min);else if(t==="MaximumExtent")e.readVector(this.extent.max);else if(t==="BoundsRadius")this.extent.boundsRadius=e.readFloat();else if(t==="Anim"){const i=new nt;for(t of e.readBlock())t==="MinimumExtent"?e.readVector(i.min):t==="MaximumExtent"?e.readVector(i.max):t==="BoundsRadius"&&(i.boundsRadius=e.readFloat());this.sequenceExtents.push(i)}else if(t==="MaterialID")this.materialId=e.readInt();else if(t==="SelectionGroup")this.selectionGroup=e.readInt();else if(t==="Unselectable")this.selectionFlags=4;else if(t==="LevelOfDetail")this.lod=e.readInt();else if(t==="Name")this.lodName=e.read();else throw new Error(`Unknown token in Geoset: "${t}"`)}writeMdl(e,t){e.startBlock("Geoset"),e.writeVectorArrayBlock("Vertices",this.vertices,3),e.writeVectorArrayBlock("Normals",this.normals,3);for(const n of this.uvSets)e.writeVectorArrayBlock("TVertices",n,2);if(t>800&&this.tangents.length&&e.writeVectorArrayBlock("Tangents",this.tangents,4),this.vertexGroups.length){e.startBlock("VertexGroup");for(let n=0,s=this.vertexGroups.length;n<s;n++)e.writeLine(`${this.vertexGroups[n]},`);e.endBlock()}if(t>800&&this.skin.length){e.startBlock("SkinWeights",this.skin.length/8);for(let n=0,s=this.skin.length;n<s;n+=8)e.writeLine(`${this.skin.subarray(n,n+8).join(", ")},`);e.endBlock()}e.startBlock("Faces",1,this.faces.length),e.startBlock("Triangles"),e.writeVector(this.faces),e.endBlock(),e.endBlock(),e.startBlock("Groups",this.matrixGroups.length,this.matrixIndices.length);let i=0;for(const n of this.matrixGroups)e.writeVectorAttrib("Matrices",this.matrixIndices.subarray(i,i+n)),i+=n;e.endBlock(),this.extent.writeMdl(e);for(const n of this.sequenceExtents)e.startBlock("Anim"),n.writeMdl(e),e.endBlock();e.writeNumberAttrib("MaterialID",this.materialId),e.writeNumberAttrib("SelectionGroup",this.selectionGroup),this.selectionFlags===4&&e.writeFlag("Unselectable"),t>800&&(e.writeNumberAttrib("LevelOfDetail",this.lod),this.lodName.length&&e.writeStringAttrib("Name",this.lodName)),e.endBlock()}getByteLength(e){let t=120+this.vertices.byteLength+this.normals.byteLength+this.faceTypeGroups.byteLength+this.faceGroups.byteLength+this.faces.byteLength+this.vertexGroups.byteLength+this.matrixGroups.byteLength+this.matrixIndices.byteLength+this.sequenceExtents.length*28;e>800&&(t+=84,this.tangents.length&&(t+=8+this.tangents.byteLength),this.skin.length&&(t+=8+this.skin.byteLength));for(const i of this.uvSets)t+=8+i.byteLength;return t}},vn=class extends st{alpha=1;flags=0;color=new Float32Array([1,1,1]);geosetId=-1;readMdx(e){const t=e.readUint32();this.alpha=e.readFloat32(),this.flags=e.readUint32(),e.readFloat32Array(this.color),this.geosetId=e.readInt32(),this.readAnimations(e,t-28)}writeMdx(e){e.writeUint32(this.getByteLength()),e.writeFloat32(this.alpha),e.writeUint32(this.flags),e.writeFloat32Array(this.color),e.writeInt32(this.geosetId),this.writeAnimations(e)}readMdl(e){for(const t of super.readAnimatedBlock(e))if(t==="DropShadow")this.flags|=1;else if(t==="static Alpha")this.alpha=e.readFloat();else if(t==="Alpha")this.readAnimation(e,"KGAO");else if(t==="static Color")this.flags|=2,e.readColor(this.color);else if(t==="Color")this.flags|=2,this.readAnimation(e,"KGAC");else if(t==="GeosetId")this.geosetId=e.readInt();else throw new Error(`Unknown token in GeosetAnimation: "${t}"`)}writeMdl(e){e.startBlock("GeosetAnim"),this.flags&1&&e.writeFlag("DropShadow"),this.writeAnimation(e,"KGAO")||e.writeNumberAttrib("static Alpha",this.alpha),this.flags&2&&!this.writeAnimation(e,"KGAC")&&(this.color[0]!==1||this.color[1]!==1||this.color[2]!==1)&&e.writeColor("static Color ",this.color),e.writeNumberAttrib("GeosetId",this.geosetId),e.endBlock()}getByteLength(){return 28+super.getByteLength()}};var Ee=(r=>(r[r.None=0]="None",r[r.DontInheritTranslation=1]="DontInheritTranslation",r[r.DontInheritScaling=2]="DontInheritScaling",r[r.DontInheritRotation=4]="DontInheritRotation",r[r.Billboarded=8]="Billboarded",r[r.BillboardedLockX=16]="BillboardedLockX",r[r.BillboardedLockY=32]="BillboardedLockY",r[r.BillboardedLockZ=64]="BillboardedLockZ",r[r.CameraAnchored=128]="CameraAnchored",r))(Ee||{});let we=class extends st{name="";objectId=-1;parentId=-1;flags;constructor(e=0){super(),this.flags=e}readMdx(e){const t=e.readUint32();this.name=e.read(80),this.objectId=e.readInt32(),this.parentId=e.readInt32(),this.flags=e.readUint32(),this.readAnimations(e,t-96)}writeMdx(e){e.writeUint32(this.getGenericByteLength()),e.skip(80-e.write(this.name)),e.writeInt32(this.objectId),e.writeInt32(this.parentId),e.writeUint32(this.flags);for(const t of this.eachAnimation(!0))t.writeMdx(e)}writeNonGenericAnimationChunks(e){for(const t of this.eachAnimation(!1))t.writeMdx(e)}*readGenericBlock(e){this.name=e.read();for(let t of this.readAnimatedBlock(e))if(t==="ObjectId")this.objectId=e.readInt();else if(t==="Parent")this.parentId=e.readInt();else if(t==="BillboardedLockZ")this.flags|=64;else if(t==="BillboardedLockY")this.flags|=32;else if(t==="BillboardedLockX")this.flags|=16;else if(t==="Billboarded")this.flags|=8;else if(t==="CameraAnchored")this.flags|=128;else if(t==="DontInherit")for(t of e.readBlock())t==="Rotation"?this.flags|=4:t==="Translation"?this.flags|=1:t==="Scaling"&&(this.flags|=2);else t==="Translation"?this.readAnimation(e,"KGTR"):t==="Rotation"?this.readAnimation(e,"KGRT"):t==="Scaling"?this.readAnimation(e,"KGSC"):yield t}writeGenericHeader(e){e.writeNumberAttrib("ObjectId",this.objectId),this.parentId!==-1&&e.writeNumberAttrib("Parent",this.parentId),this.flags&64&&e.writeFlag("BillboardedLockZ"),this.flags&32&&e.writeFlag("BillboardedLockY"),this.flags&16&&e.writeFlag("BillboardedLockX"),this.flags&8&&e.writeFlag("Billboarded"),this.flags&128&&e.writeFlag("CameraAnchored"),this.flags&4&&e.writeFlag("DontInherit { Rotation }"),this.flags&1&&e.writeFlag("DontInherit { Translation }"),this.flags&2&&e.writeFlag("DontInherit { Scaling }")}writeGenericAnimations(e){this.writeAnimation(e,"KGTR"),this.writeAnimation(e,"KGRT"),this.writeAnimation(e,"KGSC")}*eachAnimation(e){for(const t of this.animations){const i=t.name,n=i==="KGTR"||i==="KGRT"||i==="KGSC";(e&&n||!e&&!n)&&(yield t)}}getGenericByteLength(){let e=96;for(const t of this.eachAnimation(!0))e+=t.getByteLength();return e}getByteLength(){return 96+super.getByteLength()}},wn=class extends we{geosetId=-1;geosetAnimationId=-1;constructor(){super(256)}readMdx(e){super.readMdx(e),this.geosetId=e.readInt32(),this.geosetAnimationId=e.readInt32()}writeMdx(e){super.writeMdx(e),e.writeInt32(this.geosetId),e.writeInt32(this.geosetAnimationId)}readMdl(e){for(let t of super.readGenericBlock(e))if(t==="GeosetId")t=e.read(),t==="Multiple"?this.geosetId=-1:this.geosetId=parseInt(t);else if(t==="GeosetAnimId")t=e.read(),t==="None"?this.geosetAnimationId=-1:this.geosetAnimationId=parseInt(t);else throw new Error(`Unknown token in Bone ${this.name}: "${t}"`)}writeMdl(e){e.startObjectBlock("Bone",this.name),this.writeGenericHeader(e),this.geosetId===-1?e.writeFlagAttrib("GeosetId","Multiple"):e.writeNumberAttrib("GeosetId",this.geosetId),this.geosetAnimationId===-1?e.writeFlagAttrib("GeosetAnimId","None"):e.writeNumberAttrib("GeosetAnimId",this.geosetAnimationId),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 8+super.getByteLength()}},bn=class extends we{type=-1;attenuation=new Float32Array(2);color=new Float32Array(3);intensity=0;ambientColor=new Float32Array(3);ambientIntensity=0;constructor(){super(512)}readMdx(e){const t=e.index,i=e.readUint32();super.readMdx(e),this.type=e.readUint32(),e.readFloat32Array(this.attenuation),e.readFloat32Array(this.color),this.intensity=e.readFloat32(),e.readFloat32Array(this.ambientColor),this.ambientIntensity=e.readFloat32(),this.readAnimations(e,i-(e.index-t))}writeMdx(e){e.writeUint32(this.getByteLength()),super.writeMdx(e),e.writeUint32(this.type),e.writeFloat32Array(this.attenuation),e.writeFloat32Array(this.color),e.writeFloat32(this.intensity),e.writeFloat32Array(this.ambientColor),e.writeFloat32(this.ambientIntensity),this.writeNonGenericAnimationChunks(e)}readMdl(e){for(const t of super.readGenericBlock(e))if(t==="Omnidirectional")this.type=0;else if(t==="Directional")this.type=1;else if(t==="Ambient")this.type=2;else if(t==="static AttenuationStart")this.attenuation[0]=e.readFloat();else if(t==="AttenuationStart")this.readAnimation(e,"KLAS");else if(t==="static AttenuationEnd")this.attenuation[1]=e.readFloat();else if(t==="AttenuationEnd")this.readAnimation(e,"KLAE");else if(t==="static Intensity")this.intensity=e.readFloat();else if(t==="Intensity")this.readAnimation(e,"KLAI");else if(t==="static Color")e.readColor(this.color);else if(t==="Color")this.readAnimation(e,"KLAC");else if(t==="static AmbIntensity")this.ambientIntensity=e.readFloat();else if(t==="AmbIntensity")this.readAnimation(e,"KLBI");else if(t==="static AmbColor")e.readColor(this.ambientColor);else if(t==="AmbColor")this.readAnimation(e,"KLBC");else if(t==="Visibility")this.readAnimation(e,"KLAV");else throw new Error(`Unknown token in Light: "${t}"`)}writeMdl(e){e.startObjectBlock("Light",this.name),this.writeGenericHeader(e),this.type===0?e.writeFlag("Omnidirectional"):this.type===1?e.writeFlag("Directional"):this.type===2&&e.writeFlag("Ambient"),this.writeAnimation(e,"KLAS")||e.writeNumberAttrib("static AttenuationStart",this.attenuation[0]),this.writeAnimation(e,"KLAE")||e.writeNumberAttrib("static AttenuationEnd",this.attenuation[1]),this.writeAnimation(e,"KLAI")||e.writeNumberAttrib("static Intensity",this.intensity),this.writeAnimation(e,"KLAC")||e.writeColor("static Color",this.color),this.writeAnimation(e,"KLBI")||e.writeNumberAttrib("static AmbIntensity",this.ambientIntensity),this.writeAnimation(e,"KLBC")||e.writeColor("static AmbColor",this.ambientColor),this.writeAnimation(e,"KLAV"),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 48+super.getByteLength()}},mn=class extends we{readMdl(e){for(const t of super.readGenericBlock(e))throw new Error(`Unknown token in Helper: "${t}"`)}writeMdl(e){e.startObjectBlock("Helper",this.name),this.writeGenericHeader(e),this.writeGenericAnimations(e),e.endBlock()}},An=class extends we{path="";attachmentId=0;constructor(){super(2048)}readMdx(e){const t=e.index,i=e.readUint32();super.readMdx(e),this.path=e.read(260),this.attachmentId=e.readInt32(),this.readAnimations(e,i-(e.index-t))}writeMdx(e){e.writeUint32(this.getByteLength()),super.writeMdx(e),e.skip(260-e.write(this.path)),e.writeInt32(this.attachmentId),this.writeNonGenericAnimationChunks(e)}readMdl(e){for(const t of super.readGenericBlock(e))if(t==="AttachmentID")this.attachmentId=e.readInt();else if(t==="Path")this.path=e.read();else if(t==="Visibility")this.readAnimation(e,"KATV");else throw new Error(`Unknown token in Attachment ${this.name}: "${t}"`)}writeMdl(e){e.startObjectBlock("Attachment",this.name),this.writeGenericHeader(e),e.writeNumberAttrib("AttachmentID",this.attachmentId),this.path.length&&e.writeStringAttrib("Path",this.path),this.writeAnimation(e,"KATV"),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 268+super.getByteLength()}},yn=class extends we{emissionRate=0;gravity=0;longitude=0;latitude=0;path="";lifeSpan=0;speed=0;constructor(){super(4096)}readMdx(e){const t=e.index,i=e.readUint32();super.readMdx(e),this.emissionRate=e.readFloat32(),this.gravity=e.readFloat32(),this.longitude=e.readFloat32(),this.latitude=e.readFloat32(),this.path=e.read(260),this.lifeSpan=e.readFloat32(),this.speed=e.readFloat32(),this.readAnimations(e,i-(e.index-t))}writeMdx(e){e.writeUint32(this.getByteLength()),super.writeMdx(e),e.writeFloat32(this.emissionRate),e.writeFloat32(this.gravity),e.writeFloat32(this.longitude),e.writeFloat32(this.latitude),e.skip(260-e.write(this.path)),e.writeFloat32(this.lifeSpan),e.writeFloat32(this.speed),this.writeNonGenericAnimationChunks(e)}readMdl(e){for(let t of super.readGenericBlock(e))if(t==="EmitterUsesMDL")this.flags|=32768;else if(t==="EmitterUsesTGA")this.flags|=65536;else if(t==="static EmissionRate")this.emissionRate=e.readFloat();else if(t==="EmissionRate")this.readAnimation(e,"KPEE");else if(t==="static Gravity")this.gravity=e.readFloat();else if(t==="Gravity")this.readAnimation(e,"KPEG");else if(t==="static Longitude")this.longitude=e.readFloat();else if(t==="Longitude")this.readAnimation(e,"KPLN");else if(t==="static Latitude")this.latitude=e.readFloat();else if(t==="Latitude")this.readAnimation(e,"KPLT");else if(t==="Visibility")this.readAnimation(e,"KPEV");else if(t==="Particle")for(t of this.readAnimatedBlock(e))t==="static LifeSpan"?this.lifeSpan=e.readFloat():t==="LifeSpan"?this.readAnimation(e,"KPEL"):t==="static InitVelocity"?this.speed=e.readFloat():t==="InitVelocity"?this.readAnimation(e,"KPES"):t==="Path"&&(this.path=e.read());else throw new Error(`Unknown token in ParticleEmitter: "${t}"`)}writeMdl(e){e.startObjectBlock("ParticleEmitter",this.name),this.writeGenericHeader(e),this.flags&32768&&e.writeFlag("EmitterUsesMDL"),this.flags&65536&&e.writeFlag("EmitterUsesTGA"),this.writeAnimation(e,"KPEE")||e.writeNumberAttrib("static EmissionRate",this.emissionRate),this.writeAnimation(e,"KPEG")||e.writeNumberAttrib("static Gravity",this.gravity),this.writeAnimation(e,"KPLN")||e.writeNumberAttrib("static Longitude",this.longitude),this.writeAnimation(e,"KPLT")||e.writeNumberAttrib("static Latitude",this.latitude),this.writeAnimation(e,"KPEV"),e.startBlock("Particle"),this.writeAnimation(e,"KPEL")||e.writeNumberAttrib("static LifeSpan",this.lifeSpan),this.writeAnimation(e,"KPES")||e.writeNumberAttrib("static InitVelocity",this.speed),(this.flags&32768||this.flags&65536)&&e.writeStringAttrib("Path",this.path),e.endBlock(),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 288+super.getByteLength()}};var rt=(r=>(r[r.Unshaded=32768]="Unshaded",r[r.SortPrimsFarZ=65536]="SortPrimsFarZ",r[r.LineEmitter=131072]="LineEmitter",r[r.Unfogged=262144]="Unfogged",r[r.ModelSpace=524288]="ModelSpace",r[r.XYQuad=1048576]="XYQuad",r))(rt||{}),je=(r=>(r[r.Blend=0]="Blend",r[r.Additive=1]="Additive",r[r.Modulate=2]="Modulate",r[r.Modulate2x=3]="Modulate2x",r[r.AlphaKey=4]="AlphaKey",r))(je||{}),He=(r=>(r[r.Head=0]="Head",r[r.Tail=1]="Tail",r[r.Both=2]="Both",r))(He||{});let Tn=class extends we{speed=0;variation=0;latitude=0;gravity=0;lifeSpan=0;emissionRate=0;width=0;length=0;filterMode=0;rows=0;columns=0;headOrTail=0;tailLength=0;timeMiddle=0;segmentColors=[new Float32Array(3),new Float32Array(3),new Float32Array(3)];segmentAlphas=new Uint8Array(3);segmentScaling=new Float32Array(3);headIntervals=[new Uint32Array(3),new Uint32Array(3)];tailIntervals=[new Uint32Array(3),new Uint32Array(3)];textureId=-1;squirt=0;priorityPlane=0;replaceableId=0;readMdx(e){const t=e.index,i=e.readUint32();super.readMdx(e),this.speed=e.readFloat32(),this.variation=e.readFloat32(),this.latitude=e.readFloat32(),this.gravity=e.readFloat32(),this.lifeSpan=e.readFloat32(),this.emissionRate=e.readFloat32(),this.width=e.readFloat32(),this.length=e.readFloat32(),this.filterMode=e.readUint32(),this.rows=e.readUint32(),this.columns=e.readUint32(),this.headOrTail=e.readUint32(),this.tailLength=e.readFloat32(),this.timeMiddle=e.readFloat32(),e.readFloat32Array(this.segmentColors[0]),e.readFloat32Array(this.segmentColors[1]),e.readFloat32Array(this.segmentColors[2]),e.readUint8Array(this.segmentAlphas),e.readFloat32Array(this.segmentScaling),e.readUint32Array(this.headIntervals[0]),e.readUint32Array(this.headIntervals[1]),e.readUint32Array(this.tailIntervals[0]),e.readUint32Array(this.tailIntervals[1]),this.textureId=e.readInt32(),this.squirt=e.readUint32(),this.priorityPlane=e.readInt32(),this.replaceableId=e.readUint32(),this.readAnimations(e,i-(e.index-t))}writeMdx(e){e.writeUint32(this.getByteLength()),super.writeMdx(e),e.writeFloat32(this.speed),e.writeFloat32(this.variation),e.writeFloat32(this.latitude),e.writeFloat32(this.gravity),e.writeFloat32(this.lifeSpan),e.writeFloat32(this.emissionRate),e.writeFloat32(this.width),e.writeFloat32(this.length),e.writeUint32(this.filterMode),e.writeUint32(this.rows),e.writeUint32(this.columns),e.writeUint32(this.headOrTail),e.writeFloat32(this.tailLength),e.writeFloat32(this.timeMiddle),e.writeFloat32Array(this.segmentColors[0]),e.writeFloat32Array(this.segmentColors[1]),e.writeFloat32Array(this.segmentColors[2]),e.writeUint8Array(this.segmentAlphas),e.writeFloat32Array(this.segmentScaling),e.writeUint32Array(this.headIntervals[0]),e.writeUint32Array(this.headIntervals[1]),e.writeUint32Array(this.tailIntervals[0]),e.writeUint32Array(this.tailIntervals[1]),e.writeInt32(this.textureId),e.writeUint32(this.squirt),e.writeInt32(this.priorityPlane),e.writeUint32(this.replaceableId),this.writeNonGenericAnimationChunks(e)}readMdl(e){for(const t of super.readGenericBlock(e))if(t==="SortPrimsFarZ")this.flags|=65536;else if(t==="Unshaded")this.flags|=32768;else if(t==="LineEmitter")this.flags|=131072;else if(t==="Unfogged")this.flags|=262144;else if(t==="ModelSpace")this.flags|=524288;else if(t==="XYQuad")this.flags|=1048576;else if(t==="static Speed")this.speed=e.readFloat();else if(t==="Speed")this.readAnimation(e,"KP2S");else if(t==="static Variation")this.variation=e.readFloat();else if(t==="Variation")this.readAnimation(e,"KP2R");else if(t==="static Latitude")this.latitude=e.readFloat();else if(t==="Latitude")this.readAnimation(e,"KP2L");else if(t==="static Gravity")this.gravity=e.readFloat();else if(t==="Gravity")this.readAnimation(e,"KP2G");else if(t==="Visibility")this.readAnimation(e,"KP2V");else if(t==="Squirt")this.squirt=1;else if(t==="LifeSpan")this.lifeSpan=e.readFloat();else if(t==="static EmissionRate")this.emissionRate=e.readFloat();else if(t==="EmissionRate")this.readAnimation(e,"KP2E");else if(t==="static Width")this.width=e.readFloat();else if(t==="Width")this.readAnimation(e,"KP2N");else if(t==="static Length")this.length=e.readFloat();else if(t==="Length")this.readAnimation(e,"KP2W");else if(t==="Blend")this.filterMode=0;else if(t==="Additive")this.filterMode=1;else if(t==="Modulate")this.filterMode=2;else if(t==="Modulate2x")this.filterMode=3;else if(t==="AlphaKey")this.filterMode=4;else if(t==="Rows")this.rows=e.readInt();else if(t==="Columns")this.columns=e.readInt();else if(t==="Head")this.headOrTail=0;else if(t==="Tail")this.headOrTail=1;else if(t==="Both")this.headOrTail=2;else if(t==="TailLength")this.tailLength=e.readFloat();else if(t==="Time")this.timeMiddle=e.readFloat();else if(t==="SegmentColor"){e.read();for(let i=0;i<3;i++)e.read(),e.readColor(this.segmentColors[i]);e.read()}else if(t==="Alpha")e.readVector(this.segmentAlphas);else if(t==="ParticleScaling")e.readVector(this.segmentScaling);else if(t==="LifeSpanUVAnim")e.readVector(this.headIntervals[0]);else if(t==="DecayUVAnim")e.readVector(this.headIntervals[1]);else if(t==="TailUVAnim")e.readVector(this.tailIntervals[0]);else if(t==="TailDecayUVAnim")e.readVector(this.tailIntervals[1]);else if(t==="TextureID")this.textureId=e.readInt();else if(t==="ReplaceableId")this.replaceableId=e.readInt();else if(t==="PriorityPlane")this.priorityPlane=e.readInt();else throw new Error(`Unknown token in ParticleEmitter2: "${t}"`)}writeMdl(e){e.startObjectBlock("ParticleEmitter2",this.name),this.writeGenericHeader(e),this.flags&65536&&e.writeFlag("SortPrimsFarZ"),this.flags&32768&&e.writeFlag("Unshaded"),this.flags&131072&&e.writeFlag("LineEmitter"),this.flags&262144&&e.writeFlag("Unfogged"),this.flags&524288&&e.writeFlag("ModelSpace"),this.flags&1048576&&e.writeFlag("XYQuad"),this.writeAnimation(e,"KP2S")||e.writeNumberAttrib("static Speed",this.speed),this.writeAnimation(e,"KP2R")||e.writeNumberAttrib("static Variation",this.variation),this.writeAnimation(e,"KP2L")||e.writeNumberAttrib("static Latitude",this.latitude),this.writeAnimation(e,"KP2G")||e.writeNumberAttrib("static Gravity",this.gravity),this.writeAnimation(e,"KP2V"),this.squirt&&e.writeFlag("Squirt"),e.writeNumberAttrib("LifeSpan",this.lifeSpan),this.writeAnimation(e,"KP2E")||e.writeNumberAttrib("static EmissionRate",this.emissionRate),this.writeAnimation(e,"KP2N")||e.writeNumberAttrib("static Width",this.width),this.writeAnimation(e,"KP2W")||e.writeNumberAttrib("static Length",this.length),this.filterMode===0?e.writeFlag("Blend"):this.filterMode===1?e.writeFlag("Additive"):this.filterMode===2?e.writeFlag("Modulate"):this.filterMode===3?e.writeFlag("Modulate2x"):this.filterMode===4&&e.writeFlag("AlphaKey"),e.writeNumberAttrib("Rows",this.rows),e.writeNumberAttrib("Columns",this.columns),this.headOrTail===0?e.writeFlag("Head"):this.headOrTail===1?e.writeFlag("Tail"):this.headOrTail===2&&e.writeFlag("Both"),e.writeNumberAttrib("TailLength",this.tailLength),e.writeNumberAttrib("Time",this.timeMiddle),e.startBlock("SegmentColor"),e.writeColor("Color",this.segmentColors[0]),e.writeColor("Color",this.segmentColors[1]),e.writeColor("Color",this.segmentColors[2]),e.endBlockComma(),e.writeVectorAttrib("Alpha",this.segmentAlphas),e.writeVectorAttrib("ParticleScaling",this.segmentScaling),e.writeVectorAttrib("LifeSpanUVAnim",this.headIntervals[0]),e.writeVectorAttrib("DecayUVAnim",this.headIntervals[1]),e.writeVectorAttrib("TailUVAnim",this.tailIntervals[0]),e.writeVectorAttrib("TailDecayUVAnim",this.tailIntervals[1]),e.writeNumberAttrib("TextureID",this.textureId),this.replaceableId!==0&&e.writeNumberAttrib("ReplaceableId",this.replaceableId),this.priorityPlane!==0&&e.writeNumberAttrib("PriorityPlane",this.priorityPlane),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 175+super.getByteLength()}};class xn extends we{lifeSpan=0;emissionRate=0;speed=0;color=new Float32Array(3);alpha=1;replaceableId=0;path="";animationVisiblityGuide="";readMdx(e){const t=e.index,i=e.readUint32();super.readMdx(e),this.lifeSpan=e.readFloat32(),this.emissionRate=e.readFloat32(),this.speed=e.readFloat32(),e.readFloat32Array(this.color),this.alpha=e.readFloat32(),this.replaceableId=e.readUint32(),this.path=e.read(260),this.animationVisiblityGuide=e.read(260),this.readAnimations(e,i-(e.index-t))}writeMdx(e){e.writeUint32(this.getByteLength()),super.writeMdx(e),e.writeFloat32(this.lifeSpan),e.writeFloat32(this.emissionRate),e.writeFloat32(this.speed),e.writeFloat32Array(this.color),e.writeFloat32(this.alpha),e.writeUint32(this.replaceableId),e.skip(260-e.write(this.path)),e.skip(260-e.write(this.animationVisiblityGuide)),this.writeNonGenericAnimationChunks(e)}readMdl(e){for(const t of super.readGenericBlock(e))if(t==="SortPrimsFarZ")this.flags|=65536;else if(t==="Unshaded")this.flags|=32768;else if(t==="Unfogged")this.flags|=262144;else if(t==="static LifeSpan")this.lifeSpan=e.readFloat();else if(t==="LifeSpan")this.readAnimation(e,"KPPL");else if(t==="static EmissionRate")this.emissionRate=e.readFloat();else if(t==="EmissionRate")this.readAnimation(e,"KPPE");else if(t==="static Speed")this.speed=e.readFloat();else if(t==="Speed")this.readAnimation(e,"KPPS");else if(t==="static Color")e.readVector(this.color);else if(t==="Color")this.readAnimation(e,"KPPC");else if(t==="static Alpha")this.alpha=e.readFloat();else if(t==="Alpha")this.readAnimation(e,"KPPA");else if(t==="Visibility")this.readAnimation(e,"KPPV");else if(t==="ReplaceableId")this.replaceableId=e.readInt();else if(t==="Path")this.path=e.read();else if(t==="AnimVisibilityGuide")this.animationVisiblityGuide=e.read();else throw new Error(`Unknown token in ParticleEmitterPopcorn: "${t}"`)}writeMdl(e){e.startObjectBlock("ParticleEmitterPopcorn",this.name),this.writeGenericHeader(e),this.flags&65536&&e.writeFlag("SortPrimsFarZ"),this.flags&32768&&e.writeFlag("Unshaded"),this.flags&262144&&e.writeFlag("Unfogged"),this.writeAnimation(e,"KPPL")||e.writeNumberAttrib("static LifeSpan",this.lifeSpan),this.writeAnimation(e,"KPPE")||e.writeNumberAttrib("static EmissionRate",this.emissionRate),this.writeAnimation(e,"KPPS")||e.writeNumberAttrib("static Speed",this.speed),this.writeAnimation(e,"KPPC")||e.writeVectorAttrib("static Color",this.color),this.writeAnimation(e,"KPPA")||e.writeNumberAttrib("static Alpha",this.alpha),this.writeAnimation(e,"KPPV"),this.replaceableId!==0&&e.writeNumberAttrib("ReplaceableId",this.replaceableId),this.path.length&&e.writeStringAttrib("Path",this.path),this.animationVisiblityGuide.length&&e.writeStringAttrib("AnimVisibilityGuide",this.animationVisiblityGuide),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 556+super.getByteLength()}}let _n=class extends we{heightAbove=0;heightBelow=0;alpha=0;color=new Float32Array(3);lifeSpan=0;textureSlot=0;emissionRate=0;rows=0;columns=0;materialId=0;gravity=0;constructor(){super(16384)}readMdx(e){const t=e.index,i=e.readUint32();super.readMdx(e),this.heightAbove=e.readFloat32(),this.heightBelow=e.readFloat32(),this.alpha=e.readFloat32(),e.readFloat32Array(this.color),this.lifeSpan=e.readFloat32(),this.textureSlot=e.readUint32(),this.emissionRate=e.readUint32(),this.rows=e.readUint32(),this.columns=e.readUint32(),this.materialId=e.readInt32(),this.gravity=e.readFloat32(),this.readAnimations(e,i-(e.index-t))}writeMdx(e){e.writeUint32(this.getByteLength()),super.writeMdx(e),e.writeFloat32(this.heightAbove),e.writeFloat32(this.heightBelow),e.writeFloat32(this.alpha),e.writeFloat32Array(this.color),e.writeFloat32(this.lifeSpan),e.writeUint32(this.textureSlot),e.writeUint32(this.emissionRate),e.writeUint32(this.rows),e.writeUint32(this.columns),e.writeInt32(this.materialId),e.writeFloat32(this.gravity),this.writeNonGenericAnimationChunks(e)}readMdl(e){for(const t of super.readGenericBlock(e))if(t==="static HeightAbove")this.heightAbove=e.readFloat();else if(t==="HeightAbove")this.readAnimation(e,"KRHA");else if(t==="static HeightBelow")this.heightBelow=e.readFloat();else if(t==="HeightBelow")this.readAnimation(e,"KRHB");else if(t==="static Alpha")this.alpha=e.readFloat();else if(t==="Alpha")this.readAnimation(e,"KRAL");else if(t==="static Color")e.readColor(this.color);else if(t==="Color")this.readAnimation(e,"KRCO");else if(t==="static TextureSlot")this.textureSlot=e.readInt();else if(t==="TextureSlot")this.readAnimation(e,"KRTX");else if(t==="Visibility")this.readAnimation(e,"KRVS");else if(t==="EmissionRate")this.emissionRate=e.readInt();else if(t==="LifeSpan")this.lifeSpan=e.readFloat();else if(t==="Gravity")this.gravity=e.readFloat();else if(t==="Rows")this.rows=e.readInt();else if(t==="Columns")this.columns=e.readInt();else if(t==="MaterialID")this.materialId=e.readInt();else throw new Error(`Unknown token in RibbonEmitter: "${t}"`)}writeMdl(e){e.startObjectBlock("RibbonEmitter",this.name),this.writeGenericHeader(e),this.writeAnimation(e,"KRHA")||e.writeNumberAttrib("static HeightAbove",this.heightAbove),this.writeAnimation(e,"KRHB")||e.writeNumberAttrib("static HeightBelow",this.heightBelow),this.writeAnimation(e,"KRAL")||e.writeNumberAttrib("static Alpha",this.alpha),this.writeAnimation(e,"KRCO")||e.writeColor("static Color",this.color),this.writeAnimation(e,"KRTX")||e.writeNumberAttrib("static TextureSlot",this.textureSlot),this.writeAnimation(e,"KRVS"),e.writeNumberAttrib("EmissionRate",this.emissionRate),e.writeNumberAttrib("LifeSpan",this.lifeSpan),this.gravity!==0&&e.writeNumberAttrib("Gravity",this.gravity),e.writeNumberAttrib("Rows",this.rows),e.writeNumberAttrib("Columns",this.columns),e.writeNumberAttrib("MaterialID",this.materialId),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 56+super.getByteLength()}},En=class extends st{name="";position=new Float32Array(3);fieldOfView=0;farClippingPlane=0;nearClippingPlane=0;targetPosition=new Float32Array(3);readMdx(e){const t=e.readUint32();this.name=e.read(80),e.readFloat32Array(this.position),this.fieldOfView=e.readFloat32(),this.farClippingPlane=e.readFloat32(),this.nearClippingPlane=e.readFloat32(),e.readFloat32Array(this.targetPosition),this.readAnimations(e,t-120)}writeMdx(e){e.writeUint32(this.getByteLength()),e.skip(80-e.write(this.name)),e.writeFloat32Array(this.position),e.writeFloat32(this.fieldOfView),e.writeFloat32(this.farClippingPlane),e.writeFloat32(this.nearClippingPlane),e.writeFloat32Array(this.targetPosition),this.writeAnimations(e)}readMdl(e){this.name=e.read();for(let t of e.readBlock())if(t==="Position")e.readVector(this.position);else if(t==="Translation")this.readAnimation(e,"KCTR");else if(t==="Rotation")this.readAnimation(e,"KCRL");else if(t==="FieldOfView")this.fieldOfView=e.readFloat();else if(t==="FarClip")this.farClippingPlane=e.readFloat();else if(t==="NearClip")this.nearClippingPlane=e.readFloat();else if(t==="Target")for(t of e.readBlock())if(t==="Position")e.readVector(this.targetPosition);else if(t==="Translation")this.readAnimation(e,"KTTR");else throw new Error(`Unknown token in Camera ${this.name}'s Target: "${t}"`);else throw new Error(`Unknown token in Camera ${this.name}: "${t}"`)}writeMdl(e){e.startObjectBlock("Camera",this.name),e.writeVectorAttrib("Position",this.position),this.writeAnimation(e,"KCTR"),this.writeAnimation(e,"KCRL"),e.writeNumberAttrib("FieldOfView",this.fieldOfView),e.writeNumberAttrib("FarClip",this.farClippingPlane),e.writeNumberAttrib("NearClip",this.nearClippingPlane),e.startBlock("Target"),e.writeVectorAttrib("Position",this.targetPosition),this.writeAnimation(e,"KTTR"),e.endBlock(),e.endBlock()}getByteLength(){return 120+super.getByteLength()}};class Sn extends we{globalSequenceId=-1;tracks=new Uint32Array(0);constructor(){super(1024)}readMdx(e){super.readMdx(e),e.skip(4);const t=e.readUint32();this.globalSequenceId=e.readInt32(),this.tracks=e.readUint32Array(t)}writeMdx(e){super.writeMdx(e),e.writeBinary("KEVT"),e.writeUint32(this.tracks.length),e.writeInt32(this.globalSequenceId),e.writeUint32Array(this.tracks)}readMdl(e){for(const t of super.readGenericBlock(e))if(t==="EventTrack"){const i=e.readInt();this.tracks=new Uint32Array(i),e.read(),e.peek()==="GlobalSeqId"&&(e.read(),this.globalSequenceId=e.readInt());for(let n=0;n<i;n++)this.tracks[n]=e.readInt();e.read()}else throw new Error(`Unknown token in EventObject: "${t}"`)}writeMdl(e){e.startObjectBlock("EventObject",this.name),this.writeGenericHeader(e),e.startBlock("EventTrack",this.tracks.length),this.globalSequenceId!==-1&&e.writeNumberAttrib("GlobalSeqId",this.globalSequenceId);for(const t of this.tracks)e.writeFlag(`${t}`);e.endBlock(),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){return 12+this.tracks.byteLength+super.getByteLength()}}let In=class extends we{type=0;vertices=[new Float32Array(3),new Float32Array(3)];boundsRadius=0;constructor(){super(8192)}readMdx(e){super.readMdx(e),this.type=e.readUint32(),e.readFloat32Array(this.vertices[0]),this.type!==2&&e.readFloat32Array(this.vertices[1]),(this.type===2||this.type===3)&&(this.boundsRadius=e.readFloat32())}writeMdx(e){super.writeMdx(e),e.writeUint32(this.type),e.writeFloat32Array(this.vertices[0]),this.type!==2&&e.writeFloat32Array(this.vertices[1]),(this.type===2||this.type===3)&&e.writeFloat32(this.boundsRadius)}readMdl(e){for(const t of super.readGenericBlock(e))if(t==="Box")this.type=0;else if(t==="Plane")this.type=1;else if(t==="Sphere")this.type=2;else if(t==="Cylinder")this.type=3;else if(t==="Vertices"){const i=e.readInt();e.read(),e.readVector(this.vertices[0]),i===2&&e.readVector(this.vertices[1]),e.read()}else if(t==="BoundsRadius")this.boundsRadius=e.readFloat();else throw new Error(`Unknown token in CollisionShape: "${t}"`)}writeMdl(e){e.startObjectBlock("CollisionShape",this.name),this.writeGenericHeader(e);let t="",i=2,n=!1;this.type===0?t="Box":this.type===1?t="Plane":this.type===2?(t="Sphere",i=1,n=!0):this.type===3&&(t="Cylinder",n=!0),e.writeFlag(t),e.startBlock("Vertices",i),e.writeVector(this.vertices[0]),i===2&&e.writeVector(this.vertices[1]),e.endBlock(),n&&e.writeNumberAttrib("BoundsRadius",this.boundsRadius),this.writeGenericAnimations(e),e.endBlock()}getByteLength(){let e=16+super.getByteLength();return this.type!==2&&(e+=12),(this.type===2||this.type===3)&&(e+=4),e}};class Bn{type="";path="";readMdx(e){this.type=e.read(80),this.path=e.read(260)}writeMdx(e){e.skip(80-e.write(this.type)),e.skip(260-e.write(this.path))}readMdl(e){this.type=e.read();for(const t of e.readBlock())if(t==="Path")this.path=e.read();else throw new Error(`Unknown token in FaceEffect: "${t}"`)}writeMdl(e){e.startObjectBlock("FaceFX",this.type),e.writeStringAttrib("Path",this.path),e.endBlock()}}class $r{tag;chunk;constructor(e,t,i){this.tag=i,this.chunk=e.readUint8Array(new Uint8Array(t))}writeMdx(e){e.writeBinary(this.tag),e.writeUint32(this.chunk.byteLength),e.writeUint8Array(this.chunk)}getByteLength(){return 8+this.chunk.byteLength}}function Cn(r){return r instanceof ArrayBuffer&&(r=new Uint8Array(r)),!!(r instanceof Uint8Array&&r[0]===77&&r[1]===68&&r[2]===76&&r[3]===88||typeof r=="string"&&r.startsWith("MDLX"))}function Ln(r){return r instanceof ArrayBuffer&&(r=new Uint8Array(r)),!!(r instanceof Uint8Array&&Vi(r,"FormatVersion",0,4096)||typeof r=="string"&&Gr(r,"FormatVersion",0,4096))}let yt=class{version=800;name="";animationFile="";extent=new nt;blendTime=0;sequences=[];globalSequences=[];materials=[];textures=[];textureAnimations=[];geosets=[];geosetAnimations=[];bones=[];lights=[];helpers=[];attachments=[];pivotPoints=[];particleEmitters=[];particleEmitters2=[];particleEmittersPopcorn=[];ribbonEmitters=[];cameras=[];eventObjects=[];collisionShapes=[];faceEffects=[];bindPose=[];unknownChunks=[];load(e){if(Cn(e))typeof e=="string"&&(e=Qt(e)),this.loadMdx(e);else if(Ln(e))typeof e!="string"&&(e=wt(e)),this.loadMdl(e);else throw new Error("Not a valid MDX/MDL buffer")}loadMdx(e){const t=new q(e);let i,n;for(t.skip(4);t.remaining>0;)i=t.readBinary(4),n=t.readUint32(),i==="VERS"?this.loadVersionChunk(t):i==="MODL"?this.loadModelChunk(t):i==="SEQS"?this.loadStaticObjects(this.sequences,cn,t,n/132):i==="GLBS"?this.loadGlobalSequenceChunk(t,n):i==="MTLS"?this.loadDynamicObjects(this.materials,fn,t,n):i==="TEXS"?this.loadStaticObjects(this.textures,un,t,n/268):i==="TXAN"?this.loadDynamicObjects(this.textureAnimations,pn,t,n):i==="GEOS"?this.loadDynamicObjects(this.geosets,gn,t,n):i==="GEOA"?this.loadDynamicObjects(this.geosetAnimations,vn,t,n):i==="BONE"?this.loadDynamicObjects(this.bones,wn,t,n):i==="LITE"?this.loadDynamicObjects(this.lights,bn,t,n):i==="HELP"?this.loadDynamicObjects(this.helpers,mn,t,n):i==="ATCH"?this.loadDynamicObjects(this.attachments,An,t,n):i==="PIVT"?this.loadPivotPointChunk(t,n):i==="PREM"?this.loadDynamicObjects(this.particleEmitters,yn,t,n):i==="PRE2"?this.loadDynamicObjects(this.particleEmitters2,Tn,t,n):i==="CORN"?this.loadDynamicObjects(this.particleEmittersPopcorn,xn,t,n):i==="RIBB"?this.loadDynamicObjects(this.ribbonEmitters,_n,t,n):i==="CAMS"?this.loadDynamicObjects(this.cameras,En,t,n):i==="EVTS"?this.loadDynamicObjects(this.eventObjects,Sn,t,n):i==="CLID"?this.loadDynamicObjects(this.collisionShapes,In,t,n):i==="FAFX"?this.loadStaticObjects(this.faceEffects,Bn,t,n/340):i==="BPOS"?this.loadBindPoseChunk(t,n):this.unknownChunks.push(new $r(t,n,i))}loadVersionChunk(e){this.version=e.readUint32()}loadModelChunk(e){this.name=e.read(80),this.animationFile=e.read(260),this.extent.readMdx(e),this.blendTime=e.readUint32()}loadStaticObjects(e,t,i,n){for(let s=0;s<n;s++){const o=new t;o.readMdx(i),e.push(o)}}loadGlobalSequenceChunk(e,t){for(let i=0,n=t/4;i<n;i++)this.globalSequences.push(e.readUint32())}loadDynamicObjects(e,t,i,n){const s=i.index+n;for(;i.index<s;){const o=new t;o.readMdx(i,this.version),e.push(o)}}loadPivotPointChunk(e,t){for(let i=0,n=t/12;i<n;i++)this.pivotPoints.push(e.readFloat32Array(3))}loadBindPoseChunk(e,t){for(let i=0,n=e.readUint32();i<n;i++)this.bindPose[i]=e.readFloat32Array(12)}saveMdx(){const e=new q(new ArrayBuffer(this.getByteLength()));e.writeBinary("MDLX"),this.saveVersionChunk(e),this.saveModelChunk(e),this.saveStaticObjectChunk(e,"SEQS",this.sequences,132),this.saveGlobalSequenceChunk(e),this.saveDynamicObjectChunk(e,"MTLS",this.materials),this.saveStaticObjectChunk(e,"TEXS",this.textures,268),this.saveDynamicObjectChunk(e,"TXAN",this.textureAnimations),this.saveDynamicObjectChunk(e,"GEOS",this.geosets),this.saveDynamicObjectChunk(e,"GEOA",this.geosetAnimations),this.saveDynamicObjectChunk(e,"BONE",this.bones),this.saveDynamicObjectChunk(e,"LITE",this.lights),this.saveDynamicObjectChunk(e,"HELP",this.helpers),this.saveDynamicObjectChunk(e,"ATCH",this.attachments),this.savePivotPointChunk(e),this.saveDynamicObjectChunk(e,"PREM",this.particleEmitters),this.saveDynamicObjectChunk(e,"PRE2",this.particleEmitters2),this.version>800&&this.saveDynamicObjectChunk(e,"CORN",this.particleEmittersPopcorn),this.saveDynamicObjectChunk(e,"RIBB",this.ribbonEmitters),this.saveDynamicObjectChunk(e,"CAMS",this.cameras),this.saveDynamicObjectChunk(e,"EVTS",this.eventObjects),this.saveDynamicObjectChunk(e,"CLID",this.collisionShapes),this.version>800&&(this.saveStaticObjectChunk(e,"FAFX",this.faceEffects,340),this.saveBindPoseChunk(e));for(const t of this.unknownChunks)t.writeMdx(e);return e.uint8array}saveVersionChunk(e){e.writeBinary("VERS"),e.writeUint32(4),e.writeUint32(this.version)}saveModelChunk(e){e.writeBinary("MODL"),e.writeUint32(372),e.skip(80-e.write(this.name)),e.skip(260-e.write(this.animationFile)),this.extent.writeMdx(e),e.writeUint32(this.blendTime)}saveStaticObjectChunk(e,t,i,n){if(i.length){e.writeBinary(t),e.writeUint32(i.length*n);for(const s of i)s.writeMdx(e)}}saveGlobalSequenceChunk(e){if(this.globalSequences.length){e.writeBinary("GLBS"),e.writeUint32(this.globalSequences.length*4);for(const t of this.globalSequences)e.writeUint32(t)}}saveDynamicObjectChunk(e,t,i){if(i.length){e.writeBinary(t),e.writeUint32(this.getObjectsByteLength(i));for(const n of i)n.writeMdx(e,this.version)}}savePivotPointChunk(e){if(this.pivotPoints.length){e.writeBinary("PIVT"),e.writeUint32(this.pivotPoints.length*12);for(const t of this.pivotPoints)e.writeFloat32Array(t)}}saveBindPoseChunk(e){if(this.bindPose.length){e.writeBinary("BPOS"),e.writeUint32(4+this.bindPose.length*48),e.writeUint32(this.bindPose.length);for(const t of this.bindPose)e.writeFloat32Array(t)}}loadMdl(e){let t;const i=new Jt(e);for(;t=i.readToken();)if(t==="Version")this.loadVersionBlock(i);else if(t==="Model")this.loadModelBlock(i);else if(t==="Sequences")this.loadNumberedObjectBlock(this.sequences,cn,"Anim",i);else if(t==="GlobalSequences")this.loadGlobalSequenceBlock(i);else if(t==="Textures")this.loadNumberedObjectBlock(this.textures,un,"Bitmap",i);else if(t==="Materials")this.loadNumberedObjectBlock(this.materials,fn,"Material",i);else if(t==="TextureAnims")this.loadNumberedObjectBlock(this.textureAnimations,pn,"TVertexAnim",i);else if(t==="Geoset")this.loadObject(this.geosets,gn,i);else if(t==="GeosetAnim")this.loadObject(this.geosetAnimations,vn,i);else if(t==="Bone")this.loadObject(this.bones,wn,i);else if(t==="Light")this.loadObject(this.lights,bn,i);else if(t==="Helper")this.loadObject(this.helpers,mn,i);else if(t==="Attachment")this.loadObject(this.attachments,An,i);else if(t==="PivotPoints")this.loadPivotPointBlock(i);else if(t==="ParticleEmitter")this.loadObject(this.particleEmitters,yn,i);else if(t==="ParticleEmitter2")this.loadObject(this.particleEmitters2,Tn,i);else if(t==="ParticleEmitterPopcorn")this.loadObject(this.particleEmittersPopcorn,xn,i);else if(t==="RibbonEmitter")this.loadObject(this.ribbonEmitters,_n,i);else if(t==="Camera")this.loadObject(this.cameras,En,i);else if(t==="EventObject")this.loadObject(this.eventObjects,Sn,i);else if(t==="CollisionShape")this.loadObject(this.collisionShapes,In,i);else if(t==="FaceFX")this.loadObject(this.faceEffects,Bn,i);else if(t==="BindPose")this.loadBindPoseBlock(i);else throw new Error(`Unsupported block: ${t}`)}loadVersionBlock(e){for(const t of e.readBlock())if(t==="FormatVersion")this.version=e.readInt();else throw new Error(`Unknown token in Version: "${t}"`)}loadModelBlock(e){this.name=e.read();for(const t of e.readBlock())if(t.startsWith("Num"))e.read();else if(t==="BlendTime")this.blendTime=e.readInt();else if(t==="MinimumExtent")e.readVector(this.extent.min);else if(t==="MaximumExtent")e.readVector(this.extent.max);else if(t==="BoundsRadius")this.extent.boundsRadius=e.readFloat();else if(t==="AnimationFile")this.animationFile=e.read();else throw new Error(`Unknown token in Model: "${t}"`)}loadNumberedObjectBlock(e,t,i,n){n.read();for(const s of n.readBlock())if(s===i){const o=new t;o.readMdl(n),e.push(o)}else throw new Error(`Unknown token in ${i}: "${s}"`)}loadGlobalSequenceBlock(e){e.read();for(const t of e.readBlock())if(t==="Duration")this.globalSequences.push(e.readInt());else throw new Error(`Unknown token in GlobalSequences: "${t}"`)}loadObject(e,t,i){const n=new t;n.readMdl(i),e.push(n)}loadPivotPointBlock(e){const t=e.readInt();e.read();for(let i=0;i<t;i++)this.pivotPoints.push(e.readVector(new Float32Array(3)));e.read()}loadBindPoseBlock(e){for(const t of e.readBlock())if(t==="Matrices"){const i=e.readInt();e.read();for(let n=0;n<i;n++)this.bindPose[n]=e.readVector(new Float32Array(12));e.read()}else throw new Error(`Unknown token in BindPose: "${t}"`)}saveMdl(){const e=new Jt;return this.saveVersionBlock(e),this.saveModelBlock(e),this.saveStaticObjectsBlock(e,"Sequences",this.sequences),this.saveGlobalSequenceBlock(e),this.saveStaticObjectsBlock(e,"Textures",this.textures),this.saveStaticObjectsBlock(e,"Materials",this.materials),this.saveStaticObjectsBlock(e,"TextureAnims",this.textureAnimations),this.saveObjects(e,this.geosets),this.saveObjects(e,this.geosetAnimations),this.saveObjects(e,this.bones),this.saveObjects(e,this.lights),this.saveObjects(e,this.helpers),this.saveObjects(e,this.attachments),this.savePivotPointBlock(e),this.saveObjects(e,this.particleEmitters),this.saveObjects(e,this.particleEmitters2),this.version>800&&this.saveObjects(e,this.particleEmittersPopcorn),this.saveObjects(e,this.ribbonEmitters),this.saveObjects(e,this.cameras),this.saveObjects(e,this.eventObjects),this.saveObjects(e,this.collisionShapes),this.version>800&&(this.saveObjects(e,this.faceEffects),this.saveBindPoseBlock(e)),e.buffer}saveVersionBlock(e){e.startBlock("Version"),e.writeNumberAttrib("FormatVersion",this.version),e.endBlock()}saveModelBlock(e){e.startObjectBlock("Model",this.name),e.writeNumberAttrib("BlendTime",this.blendTime),this.extent.writeMdl(e),this.animationFile.length&&e.writeStringAttrib("AnimationFile",this.animationFile),e.endBlock()}saveStaticObjectsBlock(e,t,i){if(i.length){e.startBlock(t,i.length);for(const n of i)n.writeMdl(e,this.version);e.endBlock()}}saveGlobalSequenceBlock(e){if(this.globalSequences.length){e.startBlock("GlobalSequences",this.globalSequences.length);for(const t of this.globalSequences)e.writeNumberAttrib("Duration",t);e.endBlock()}}saveObjects(e,t){for(const i of t)i.writeMdl(e,this.version)}savePivotPointBlock(e){if(this.pivotPoints.length){e.startBlock("PivotPoints",this.pivotPoints.length);for(const t of this.pivotPoints)e.writeVector(t);e.endBlock()}}saveBindPoseBlock(e){if(this.bindPose.length){e.startBlock("BindPose"),e.startBlock("Matrices",this.bindPose.length);for(const t of this.bindPose)e.writeVector(t);e.endBlock(),e.endBlock()}}getByteLength(){let e=396;return e+=this.getStaticObjectsChunkByteLength(this.sequences,132),e+=this.getStaticObjectsChunkByteLength(this.globalSequences,4),e+=this.getDynamicObjectsChunkByteLength(this.materials),e+=this.getStaticObjectsChunkByteLength(this.textures,268),e+=this.getDynamicObjectsChunkByteLength(this.textureAnimations),e+=this.getDynamicObjectsChunkByteLength(this.geosets),e+=this.getDynamicObjectsChunkByteLength(this.geosetAnimations),e+=this.getDynamicObjectsChunkByteLength(this.bones),e+=this.getDynamicObjectsChunkByteLength(this.lights),e+=this.getDynamicObjectsChunkByteLength(this.helpers),e+=this.getDynamicObjectsChunkByteLength(this.attachments),e+=this.getStaticObjectsChunkByteLength(this.pivotPoints,12),e+=this.getDynamicObjectsChunkByteLength(this.particleEmitters),e+=this.getDynamicObjectsChunkByteLength(this.particleEmitters2),this.version>800&&(e+=this.getDynamicObjectsChunkByteLength(this.particleEmittersPopcorn)),e+=this.getDynamicObjectsChunkByteLength(this.ribbonEmitters),e+=this.getDynamicObjectsChunkByteLength(this.cameras),e+=this.getDynamicObjectsChunkByteLength(this.eventObjects),e+=this.getDynamicObjectsChunkByteLength(this.collisionShapes),this.version>800&&(e+=this.getStaticObjectsChunkByteLength(this.faceEffects,340),e+=this.getBindPoseChunkByteLength()),e+=this.getObjectsByteLength(this.unknownChunks),e}getObjectsByteLength(e){let t=0;for(const i of e)t+=i.getByteLength(this.version);return t}getDynamicObjectsChunkByteLength(e){return e.length?8+this.getObjectsByteLength(e):0}getStaticObjectsChunkByteLength(e,t){return e.length?8+e.length*t:0}getBindPoseChunkByteLength(){return this.bindPose.length?12+this.bindPose.length*48:0}};class Rn{x=0;y=0;z=0;r=0;fromExtents(e,t){const i=e[0],n=e[1],s=e[2],o=t[0]-i,a=t[1]-n,l=t[2]-s;this.x=i+o/2,this.y=n+a/2,this.z=s+l/2,this.r=Math.max(0,Math.max(o,a,l)/2)}}class zr{name;interval;nonLooping;rarity;bounds;constructor(e){this.name=e.name,this.interval=e.interval,this.nonLooping=e.nonLooping,this.rarity=e.rarity,this.bounds=new Rn;const t=e.extent;this.bounds.fromExtents(t.min,t.max)}}class Xr extends ki{bounds=new Rn}class Fn{sd;start;end;frames=[];values=[];inTans=[];outTans=[];constant=!1;constructor(e,t,i,n,s){this.sd=e,this.start=t,this.end=i;const o=e.interpolationType,a=n.frames,l=n.values,c=n.inTans,d=n.outTans,h=e.defval;s&&a[0]>i&&(this.frames[0]=a[0],this.values[0]=l[0]);for(let p=0,g=a.length;p<g;p++){const v=a[p];v>=t&&v<=i&&(this.frames.push(v),this.values.push(l[p]),o>1&&(this.inTans.push(c[p]),this.outTans.push(d[p])))}const u=this.frames.length;if(u===0)this.constant=!0,this.frames[0]=t,this.values[0]=h;else if(u===1)this.constant=!0;else{const p=this.values[0];this.constant=this.values.every(g=>p.every((v,b)=>v===g[b]))}}getValue(e,t){const n=this.frames.length;if(this.constant||t<this.start)return this.sd.copy(e,this.values[0]),-1;{let s=-1,o=-1;const a=n-1;if(t<this.frames[0]||t>=this.frames[a])s=a,o=0;else for(let u=1;u<n;u++)if(this.frames[u]>t){s=u-1,o=u;break}let l=this.frames[s];const c=this.frames[o];let d=c-l;d<0&&(d+=this.end-this.start,t<l&&(l=c));const h=d==0?0:(t-l)/d;return this.sd.interpolate(e,this.values,this.inTans,this.outTans,s,o,h),s}}}const Yr={KLAV:J.DontInterp,KATV:J.DontInterp,KPEV:J.DontInterp,KP2V:J.DontInterp,KRVS:J.DontInterp},Y=new Float32Array(1),Wr=new Uint32Array(1),qe=new Float32Array([1]),ot=f.vec3.create(),Un=f.quat.create(),Pn=f.vec3.fromValues(1,1,1),Dn=qe,Tt=ot,Zr={KMTF:Y,KMTA:Dn,KTAT:ot,KTAR:Un,KTAS:Pn,KGAO:Dn,KGAC:Tt,KLAS:Y,KLAE:Y,KLAC:Tt,KLAI:Y,KLBI:Y,KLBC:Tt,KLAV:qe,KATV:qe,KPEE:Y,KPEG:Y,KPLN:Y,KPLT:Y,KPEL:Y,KPES:Y,KPEV:qe,KP2S:Y,KP2R:Y,KP2L:Y,KP2G:Y,KP2E:Y,KP2N:Y,KP2W:Y,KP2V:qe,KRHA:Y,KRHB:Y,KRAL:new Float32Array([0]),KRCO:Tt,KRTX:Y,KRVS:qe,KCTR:ot,KTTR:ot,KCRL:Wr,KGTR:ot,KGRT:Un,KGSC:Pn};class ti{defval;model;name;globalSequence=null;sequences=[];interpolationType;constructor(e,t){const i=e.globalSequences,n=t.globalSequenceId,s=Yr[t.name];if(this.model=e,this.name=t.name,this.defval=Zr[t.name],this.interpolationType=s!==void 0?s:t.interpolationType,n!==-1&&i)this.globalSequence=new Fn(this,0,i[n],t,!0);else for(const o of e.sequences){const a=o.interval;this.sequences.push(new Fn(this,a[0],a[1],t,!1))}}getValue(e,t,i,n){return this.globalSequence?this.globalSequence.getValue(e,n%this.globalSequence.end):this.sequences[t].getValue(e,i)}isVariant(e){return this.globalSequence?!this.globalSequence.constant:!this.sequences[e].constant}}class Qr extends ti{copy(e,t){e[0]=t[0]}interpolate(e,t,i,n,s,o,a){const l=this.interpolationType,c=t[s][0];l===J.DontInterp?e[0]=c:l===J.Linear?e[0]=Sr(c,t[o][0],a):l===J.Hermite?e[0]=Ir(c,n[s][0],i[o][0],t[o][0],a):l===J.Bezier&&(e[0]=Br(c,n[s][0],i[o][0],t[o][0],a))}}class Jr extends ti{copy(e,t){f.vec3.copy(e,t)}interpolate(e,t,i,n,s,o,a){const l=this.interpolationType;l===J.DontInterp?f.vec3.copy(e,t[s]):l===J.Linear?f.vec3.lerp(e,t[s],t[o],a):l===J.Hermite?f.vec3.hermite(e,t[s],n[s],i[o],t[o],a):l===J.Bezier&&f.vec3.bezier(e,t[s],n[s],i[o],t[o],a)}}class eo extends ti{copy(e,t){f.quat.copy(e,t)}interpolate(e,t,i,n,s,o,a){const l=this.interpolationType;l===J.DontInterp?f.quat.copy(e,t[s]):l===J.Linear?f.quat.slerp(e,t[s],t[o],a):(l===J.Hermite||l===J.Bezier)&&f.quat.sqlerp(e,t[s],n[s],i[o],t[o],a)}}function to(r,e){return e instanceof At||e instanceof M?new Qr(r,e):e instanceof he?new Jr(r,e):new eo(r,e)}class at{model;animations=new Map;variants={};constructor(e,t){this.model=e;for(const i of t.animations)this.animations.set(i.name,to(e,i))}getScalarValue(e,t,i,n,s,o){if(i!==-1){const a=this.animations.get(t);if(a)return a.getValue(e,i,n,s)}return e[0]=o,-1}getVectorValue(e,t,i,n,s,o){if(i!==-1){const a=this.animations.get(t);if(a)return a.getValue(e,i,n,s)}return e[0]=o[0],e[1]=o[1],e[2]=o[2],-1}getQuatValue(e,t,i,n,s,o){if(i!==-1){const a=this.animations.get(t);if(a)return a.getValue(e,i,n,s)}return e[0]=o[0],e[1]=o[1],e[2]=o[2],e[3]=o[3],-1}addVariants(e,t){const i=this.animations.get(e),n=this.model.sequences.length,s=new Uint8Array(n);if(i)for(let o=0;o<n;o++)i.isVariant(o)&&(s[o]=1);this.variants[t]=s}addVariantIntersection(e,t){const i=this.model.sequences.length,n=new Uint8Array(i);for(let s=0;s<i;s++)for(const o of e)this.variants[o][s]&&(n[s]=1);this.variants[t]=n}}class io extends at{constructor(e,t){super(e,t),this.addVariants("KTAT","translation"),this.addVariants("KTAR","rotation"),this.addVariants("KTAS","scale")}getTranslation(e,t,i,n){return this.getVectorValue(e,"KTAT",t,i,n,Ne)}getRotation(e,t,i,n){return this.getQuatValue(e,"KTAR",t,i,n,Yt)}getScale(e,t,i,n){return this.getVectorValue(e,"KTAS",t,i,n,Xt)}}function no(r,e){return r===ve.Blend?[e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA]:r===ve.Additive?[e.SRC_ALPHA,e.ONE]:r===ve.AddAlpha?[e.SRC_ALPHA,e.ONE]:r===ve.Modulate?[e.ZERO,e.SRC_COLOR]:r===ve.Modulate2x?[e.DST_COLOR,e.SRC_COLOR]:[0,0]}function kn(r,e){return r===je.Blend?[e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA]:r===je.Additive?[e.SRC_ALPHA,e.ONE]:r===je.Modulate?[e.ZERO,e.SRC_COLOR]:r===je.Modulate2x?[e.DST_COLOR,e.SRC_COLOR]:r===je.AlphaKey?[e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA]:[0,0]}class so extends at{index;priorityPlane;filterMode;textureId=0;coordId;alpha;unshaded;sphereEnvironmentMap;twoSided;unfogged;noDepthTest;noDepthSet;depthMaskValue;blendSrc=0;blendDst=0;blended=!1;textureAnimation=null;constructor(e,t,i,n){super(e,t);let s=t.filterMode;const o=t.textureAnimationId,a=e.viewer.gl;this.index=i,this.priorityPlane=n,s>ve.Modulate2x&&(s=ve.Blend),this.filterMode=s,t.textureId!==-1&&(this.textureId=t.textureId),this.coordId=t.coordId,this.alpha=t.alpha;const l=t.flags;if(this.unshaded=l&Pe.Unshaded,this.sphereEnvironmentMap=l&Pe.SphereEnvMap,this.twoSided=l&Pe.TwoSided,this.unfogged=l&Pe.Unfogged,this.noDepthTest=l&Pe.NoDepthTest,this.noDepthSet=l&Pe.NoDepthSet,this.depthMaskValue=s===ve.None||s===ve.Transparent,s>ve.Transparent&&(this.blended=!0,[this.blendSrc,this.blendDst]=no(s,a)),o!==-1){const c=e.textureAnimations[o];c&&(this.textureAnimation=c)}this.addVariants("KMTA","alpha"),this.addVariants("KMTF","textureId")}bind(e){const t=this.model.viewer.gl;t.uniform1f(e.uniforms.u_filterMode,this.filterMode),this.blended?(t.enable(t.BLEND),t.blendFunc(this.blendSrc,this.blendDst)):t.disable(t.BLEND),this.twoSided?t.disable(t.CULL_FACE):t.enable(t.CULL_FACE),this.noDepthTest?t.disable(t.DEPTH_TEST):t.enable(t.DEPTH_TEST),this.noDepthSet?t.depthMask(!1):t.depthMask(this.depthMaskValue)}getAlpha(e,t,i,n){return this.getScalarValue(e,"KMTA",t,i,n,this.alpha)}getTextureId(e,t,i,n){return this.getScalarValue(e,"KMTF",t,i,n,this.textureId)}}class ro{model;shader;layers;constructor(e,t,i){this.model=e,this.shader=t,this.layers=i}}class oo extends at{alpha;color;geosetId;constructor(e,t){super(e,t);const i=t.color;this.alpha=t.alpha,this.color=f.vec3.fromValues(i[2],i[1],i[0]),this.geosetId=t.geosetId,this.addVariants("KGAO","alpha"),this.addVariants("KGAC","color")}getAlpha(e,t,i,n){return this.getScalarValue(e,"KGAO",t,i,n,this.alpha)}getColor(e,t,i,n){return this.getVectorValue(e,"KGAC",t,i,n,this.color)}}const On={1:"TeamColor/TeamColor00",2:"TeamGlow/TeamGlow00",11:"Cliff/Cliff0",21:"",31:"LordaeronTree/LordaeronSummerTree",32:"AshenvaleTree/AshenTree",33:"BarrensTree/BarrensTree",34:"NorthrendTree/NorthTree",35:"Mushroom/MushroomTree",36:"RuinsTree/RuinsTree",37:"OutlandMushroomTree/MushroomTree"};class be extends at{index;name;objectId;parentId;pivot;dontInheritTranslation;dontInheritRotation;dontInheritScaling;billboarded;billboardedX;billboardedY;billboardedZ;cameraAnchored;anyBillboarding;constructor(e,t,i){super(e,t),this.index=i,this.name=t.name,this.objectId=t.objectId,this.parentId=t.parentId,this.pivot=e.pivotPoints[t.objectId]||f.vec3.create();const n=t.flags;this.dontInheritTranslation=(n&Ee.DontInheritTranslation)>0,this.dontInheritRotation=(n&Ee.DontInheritRotation)>0,this.dontInheritScaling=(n&Ee.DontInheritScaling)>0,this.billboarded=(n&Ee.Billboarded)>0,this.billboardedX=(n&Ee.BillboardedLockX)>0,this.billboardedY=(n&Ee.BillboardedLockY)>0,this.billboardedZ=(n&Ee.BillboardedLockZ)>0,this.cameraAnchored=(n&Ee.CameraAnchored)>0,this.anyBillboarding=this.billboarded||this.billboardedX||this.billboardedY||this.billboardedZ,t.objectId===t.parentId&&(this.parentId=-1),this.addVariants("KGTR","translation"),this.addVariants("KGRT","rotation"),this.addVariants("KGSC","scale"),this.addVariantIntersection(["translation","rotation","scale"],"generic")}getVisibility(e,t,i,n){return e[0]=1,-1}getTranslation(e,t,i,n){return this.getVectorValue(e,"KGTR",t,i,n,Ne)}getRotation(e,t,i,n){return this.getQuatValue(e,"KGRT",t,i,n,Yt)}getScale(e,t,i,n){return this.getVectorValue(e,"KGSC",t,i,n,Xt)}}class ao extends be{geosetAnimation;constructor(e,t,i){super(e,t,i),this.geosetAnimation=e.geosetAnimations[t.geosetAnimationId]}getVisibility(e,t,i,n){return this.geosetAnimation?this.geosetAnimation.getAlpha(e,t,i,n):(e[0]=1,-1)}}class lo extends be{type;attenuation;color;intensity;ambientColor;ambientIntensity;constructor(e,t,i){super(e,t,i),this.type=t.type,this.attenuation=t.attenuation,this.color=t.color,this.intensity=t.intensity,this.ambientColor=t.ambientColor,this.ambientIntensity=t.ambientIntensity}getAttenuationStart(e,t,i,n){return this.getScalarValue(e,"KLAS",t,i,n,this.attenuation[0])}getAttenuationEnd(e,t,i,n){return this.getScalarValue(e,"KLAE",t,i,n,this.attenuation[1])}getIntensity(e,t,i,n){return this.getScalarValue(e,"KLAI",t,i,n,this.intensity)}getColor(e,t,i,n){return this.getVectorValue(e,"KLAC",t,i,n,this.color)}getAmbientIntensity(e,t,i,n){return this.getScalarValue(e,"KLBI",t,i,n,this.ambientIntensity)}getAmbientColor(e,t,i,n){return this.getVectorValue(e,"KLBC",t,i,n,this.ambientColor)}}class co extends be{}class ho extends be{path;attachmentId;internalModel=null;constructor(e,t,i){super(e,t,i);const n=t.path.replace(/\\/g,"/").toLowerCase().replace(".mdl",".mdx");if(this.path=n,this.attachmentId=t.attachmentId,n!==""&&n.indexOf(".mdx")!=-1){const s=e.viewer.load(n,e.pathSolver,e.solverParams);s.then(o=>{o&&(this.internalModel=o)}),e.blockers.push(s)}}getVisibility(e,t,i,n){return this.getScalarValue(e,"KATV",t,i,n,1)}}class fo extends be{internalModel=null;speed;latitude;longitude;lifeSpan;gravity;emissionRate;ok=!1;constructor(e,t,i){super(e,t,i),this.speed=t.speed,this.latitude=t.latitude,this.longitude=t.longitude,this.lifeSpan=t.lifeSpan,this.gravity=t.gravity,this.emissionRate=t.emissionRate,e.viewer.load(t.path.replace(/\\/g,"/").toLowerCase().replace(".mdl",".mdx"),e.pathSolver,e.solverParams).then(n=>{n&&(this.internalModel=n,this.ok=!0)})}getSpeed(e,t,i,n){return this.getScalarValue(e,"KPES",t,i,n,this.speed)}getLatitude(e,t,i,n){return this.getScalarValue(e,"KPLTV",t,i,n,this.latitude)}getLongitude(e,t,i,n){return this.getScalarValue(e,"KPLN",t,i,n,this.longitude)}getLifeSpan(e,t,i,n){return this.getScalarValue(e,"KPEL",t,i,n,this.lifeSpan)}getGravity(e,t,i,n){return this.getScalarValue(e,"KPEG",t,i,n,this.gravity)}getEmissionRate(e,t,i,n){return this.getScalarValue(e,"KPEE",t,i,n,this.emissionRate)}getVisibility(e,t,i,n){return this.getScalarValue(e,"KPEV",t,i,n,1)}}const uo=f.vec3.create(),po=f.vec3.create(),go=f.vec3.create(),ue=60,ii=ue>>2,Mn=0,vo=12,wo=24,bo=36,Nn=48,Vn=52,Gn=56,ni=57,si=Mn>>2,jn=Nn>>2,mo=ni,Hn=0,ri=1,qn=2,Ao=3,Kn=1e3,oi=1e4,$n=2;function yo(r,e){const t=r.instance,i=r.objects,n=e.byteView,s=e.floatView,o=r.emitterObject,a=o.modelSpace,l=o.tailLength,c=r.node,d=t.teamColor;let h=0;for(const u of i){const p=h*ue,g=h*ii,v=g+si;let b=u.location;const w=u.scale,m=u.tail;if(m===He.Head)a&&(b=f.vec3.transformMat4(uo,b,c.worldMatrix)),s[v+0]=b[0],s[v+1]=b[1],s[v+2]=b[2],s[v+3]=u.facing;else{const E=u.velocity;let x=po,y=b;x[0]=y[0]-l*E[0],x[1]=y[1]-l*E[1],x[2]=y[2]-l*E[2],a&&(x=f.vec3.transformMat4(x,x,c.worldMatrix),y=f.vec3.transformMat4(go,y,c.worldMatrix)),s[v+0]=x[0],s[v+1]=x[1],s[v+2]=x[2],s[v+3]=y[0],s[v+4]=y[1],s[v+5]=y[2]}s[v+6]=w[0],s[v+7]=w[0],s[v+8]=w[0],s[g+jn]=u.health,n[p+Gn]=m,n[p+mo]=d,h+=1}}function To(r,e){const t=r.instance,i=t.textureOverrides,s=t.scene.camera,o=r.emitterObject,a=o.model,l=a.viewer,c=l.gl,d=l.sharedCache.get("mdx"),h=e.uniforms,u=o.colors,p=o.intervals,g=o.replaceableId;let v,b=o.internalTexture;c.blendFunc(o.blendSrc,o.blendDst),c.uniform1f(h.u_filterMode,o.filterMode),o.internalTexture?b=o.internalTexture:g===1?b=d.teamColors[t.teamColor]:g===2?b=d.teamGlows[t.teamColor]:b=a.textures[o.textureId];let w=i.get(Kn+o.index);w||(g===0&&(w=i.get(o.textureId)),w||(w=b.texture)),l.webgl.bindTextureAndWrap(w,0,b.wrapS,b.wrapT),o.xYQuad?v=s.vectors:v=s.billboardedVectors,c.uniform1f(h.u_lifeSpan,o.lifeSpan),c.uniform1f(h.u_timeMiddle,o.timeMiddle),c.uniform1f(h.u_columns,o.columns),c.uniform1f(h.u_rows,o.rows),c.uniform1f(h.u_teamColored,o.teamColored),c.uniform3fv(h["u_intervals[0]"],p[0]),c.uniform3fv(h["u_intervals[1]"],p[1]),c.uniform3fv(h["u_intervals[2]"],p[2]),c.uniform3fv(h["u_intervals[3]"],p[3]),c.uniform4fv(h["u_colors[0]"],u[0]),c.uniform4fv(h["u_colors[1]"],u[1]),c.uniform4fv(h["u_colors[2]"],u[2]),c.uniform3fv(h.u_scaling,o.scaling),o.head&&(c.uniform3fv(h["u_vertices[0]"],v[0]),c.uniform3fv(h["u_vertices[1]"],v[1]),c.uniform3fv(h["u_vertices[2]"],v[2]),c.uniform3fv(h["u_vertices[3]"],v[3])),o.tail&&c.uniform3fv(h.u_cameraZ,s.directionZ)}function xo(r,e){let t=r.first;const i=e.byteView,n=e.floatView,o=r.emitterObject.columns,l=1/(r.alive-1);let c=0;for(;t.next;){const d=t.next.vertices,h=c*ue,p=c*ii+si,g=h+Vn,v=h+ni,b=(t.slot%o+(1-c*l-l))/o,w=t.slot/o,m=b+l,E=t.vertices,x=t.color;n[p+0]=E[0],n[p+1]=E[1],n[p+2]=E[2],n[p+3]=E[3],n[p+4]=E[4],n[p+5]=E[5],n[p+6]=d[3],n[p+7]=d[4],n[p+8]=d[5],n[p+9]=d[0],n[p+10]=d[1],n[p+11]=d[2],i[g+0]=x[0],i[g+1]=x[1],i[g+2]=x[2],i[g+3]=x[3],i[v+0]=b*255,i[v+1]=m*255,i[v+2]=w*255,t=t.next,c+=1}}function _o(r,e){const t=r.instance.textureOverrides,i=r.emitterObject,n=i.layer,s=i.model,o=s.viewer.gl,a=e.uniforms,l=s.textures[n.textureId],c=t.get(n.textureId)||l.texture;n.bind(e),o.uniform1f(a.u_filterMode,n.filterMode),s.viewer.webgl.bindTextureAndWrap(c,0,l.wrapS,l.wrapT),o.uniform1f(a.u_columns,i.columns),o.uniform1f(a.u_rows,i.rows)}function zn(r,e){const t=r.objects,i=e.floatView;let n=0;for(const s of t){const o=n*ii,a=o+si,l=s.vertices;i[a+0]=l[0],i[a+1]=l[1],i[a+2]=l[2],i[a+3]=l[3],i[a+4]=l[4],i[a+5]=l[5],i[a+6]=l[6],i[a+7]=l[7],i[a+8]=l[8],i[a+9]=l[9],i[a+10]=l[10],i[a+11]=l[11],i[o+jn]=s.health,n+=1}}function Eo(r,e){const t=r.instance.textureOverrides,i=r.emitterObject,n=i.intervalTimes,s=i.intervals,o=i.colors,a=i.model,l=a.viewer.gl,c=e.uniforms,d=i.internalTexture,h=t.get(oi+i.index)||d.texture;l.blendFunc(i.blendSrc,i.blendDst),a.viewer.webgl.bindTextureAndWrap(h,0,d.wrapS,d.wrapT),l.uniform1f(c.u_lifeSpan,i.lifeSpan),l.uniform1f(c.u_columns,i.columns),l.uniform1f(c.u_rows,i.rows),l.uniform3f(c.u_intervalTimes,n[0],n[1],0),l.uniform3fv(c["u_intervals[0]"],s[0]),l.uniform3fv(c["u_intervals[1]"],s[1]),l.uniform4fv(c["u_colors[0]"],o[0]),l.uniform4fv(c["u_colors[1]"],o[1]),l.uniform4fv(c["u_colors[2]"],o[2])}function So(r,e){const t=r.instance.textureOverrides,i=r.emitterObject,n=i.intervalTimes,s=i.colors,o=i.model,l=o.viewer.gl,c=e.uniforms,d=i.internalTexture,h=t.get(oi+i.index)||d.texture;l.blendFunc(i.blendSrc,i.blendDst),o.viewer.webgl.bindTextureAndWrap(h,0,d.wrapS,d.wrapT),l.uniform1f(c.u_lifeSpan,i.lifeSpan),l.uniform1f(c.u_columns,i.columns),l.uniform1f(c.u_rows,i.rows),l.uniform3fv(c.u_intervalTimes,n),l.uniform4fv(c["u_colors[0]"],s[0]),l.uniform4fv(c["u_colors[1]"],s[1]),l.uniform4fv(c["u_colors[2]"],s[2])}function Io(r,e){let t=r.alive;const n=r.emitterObject.geometryEmitterType;if(n===ri&&(t-=1),t>0){const s=r.instance.model.viewer,o=s.buffer,a=s.gl,l=s.webgl.extensions.ANGLE_instanced_arrays,c=t*ue,d=e.attribs;o.reserve(c),n===Hn?(yo(r,o),To(r,e)):n===ri?(xo(r,o),_o(r,e)):n===qn?(zn(r,o),Eo(r,e)):(zn(r,o),So(r,e)),o.bindAndUpdate(c),a.uniform1i(e.uniforms.u_emitter,n),a.vertexAttribPointer(d.a_p0,3,a.FLOAT,!1,ue,Mn),a.vertexAttribPointer(d.a_p1,3,a.FLOAT,!1,ue,vo),a.vertexAttribPointer(d.a_p2,3,a.FLOAT,!1,ue,wo),a.vertexAttribPointer(d.a_p3,3,a.FLOAT,!1,ue,bo),a.vertexAttribPointer(d.a_health,1,a.FLOAT,!1,ue,Nn),a.vertexAttribPointer(d.a_color,4,a.UNSIGNED_BYTE,!0,ue,Vn),a.vertexAttribPointer(d.a_tail,1,a.UNSIGNED_BYTE,!1,ue,Gn),a.vertexAttribPointer(d.a_leftRightTop,3,a.UNSIGNED_BYTE,!1,ue,ni),l.drawArraysInstancedANGLE(a.TRIANGLES,0,6,t)}}class lt{texture=null;replaceableId;wrapS=33071;wrapT=33071;constructor(e,t){this.replaceableId=e,t&De.WrapWidth&&(this.wrapS=10497),t&De.WrapHeight&&(this.wrapT=10497)}}class Xn extends be{geometryEmitterType=Hn;width;length;speed;latitude;gravity;emissionRate;squirt;lifeSpan;variation;tailLength;timeMiddle;columns;rows;teamColored=0;internalTexture=null;replaceableId;textureId;head;tail;cellWidth;cellHeight;colors=[];scaling;intervals;filterMode;blendSrc;blendDst;priorityPlane;lineEmitter;unfogged;modelSpace;xYQuad;ok=!0;constructor(e,t,i){super(e,t,i),this.width=t.width,this.length=t.length,this.speed=t.speed,this.latitude=t.latitude,this.gravity=t.gravity,this.emissionRate=t.emissionRate*$n,this.squirt=t.squirt,this.lifeSpan=t.lifeSpan,this.variation=t.variation,this.tailLength=t.tailLength,this.timeMiddle=t.timeMiddle;const n=t.flags;this.lineEmitter=n&rt.LineEmitter,this.unfogged=n&rt.Unfogged,this.modelSpace=n&rt.ModelSpace,this.xYQuad=n&rt.XYQuad;const s=t.replaceableId;if(this.columns=t.columns,this.rows=t.rows,s===1||s===2)this.teamColored=1;else if(s>2){const u=e.reforged?".dds":".blp";this.internalTexture=new lt(s,De.RepeatBoth),e.viewer.load(`ReplaceableTextures\\${On[s]}${u}`,e.pathSolver,e.solverParams).then(p=>{p&&(this.internalTexture.texture=p)})}this.replaceableId=t.replaceableId,this.textureId=t.textureId;const o=t.headOrTail;this.head=o===He.Head||o===He.Both,this.tail=o===He.Tail||o===He.Both,this.cellWidth=1/t.columns,this.cellHeight=1/t.rows;const a=t.segmentColors,l=t.segmentAlphas;for(let u=0;u<3;u++){const p=a[u];this.colors[u]=new Float32Array([p[0],p[1],p[2],l[u]/255])}this.scaling=t.segmentScaling;const c=t.headIntervals,d=t.tailIntervals;this.intervals=[new Float32Array(c[0]),new Float32Array(c[1]),new Float32Array(d[0]),new Float32Array(d[1])];const h=kn(t.filterMode,this.model.viewer.gl);this.filterMode=t.filterMode,this.blendSrc=h[0],this.blendDst=h[1],this.priorityPlane=t.priorityPlane}getWidth(e,t,i,n){return this.getScalarValue(e,"KP2N",t,i,n,this.width)}getLength(e,t,i,n){return this.getScalarValue(e,"KP2W",t,i,n,this.length)}getSpeed(e,t,i,n){return this.getScalarValue(e,"KP2S",t,i,n,this.speed)}getLatitude(e,t,i,n){return this.getScalarValue(e,"KP2L",t,i,n,this.latitude)}getGravity(e,t,i,n){return this.getScalarValue(e,"KP2G",t,i,n,this.gravity)}getEmissionRate(e,t,i,n){return this.getScalarValue(e,"KP2E",t,i,n,this.emissionRate)}getVariation(e,t,i,n){return this.getScalarValue(e,"KP2R",t,i,n,this.variation)}getVisibility(e,t,i,n){return this.getScalarValue(e,"KP2V",t,i,n,1)}}class Yn extends be{geometryEmitterType=ri;layer;heightAbove;heightBelow;alpha;color;lifeSpan;textureSlot;emissionRate;gravity;columns;rows;ok=!0;constructor(e,t,i){super(e,t,i),this.layer=e.materials[t.materialId].layers[0],this.heightAbove=t.heightAbove,this.heightBelow=t.heightBelow,this.alpha=t.alpha,this.color=t.color,this.lifeSpan=t.lifeSpan,this.textureSlot=t.textureSlot,this.emissionRate=t.emissionRate*$n,this.gravity=t.gravity,this.columns=t.columns,this.rows=t.rows}getHeightBelow(e,t,i,n){return this.getScalarValue(e,"KRHB",t,i,n,this.heightBelow)}getHeightAbove(e,t,i,n){return this.getScalarValue(e,"KRHA",t,i,n,this.heightAbove)}getTextureSlot(e,t,i,n){return this.getScalarValue(e,"KRTX",t,i,n,0)}getColor(e,t,i,n){return this.getVectorValue(e,"KRCO",t,i,n,this.color)}getAlpha(e,t,i,n){return this.getScalarValue(e,"KRAL",t,i,n,this.alpha)}getVisibility(e,t,i,n){const s=this.getAlpha(e,t,i,n);return e[0]===0?s:this.getScalarValue(e,"KRVS",t,i,n,1)}}class Bo extends at{name;position;fieldOfView;farClippingPlane;nearClippingPlane;targetPosition;constructor(e,t){super(e,t),this.name=t.name,this.position=t.position,this.fieldOfView=t.fieldOfView,this.farClippingPlane=t.farClippingPlane,this.nearClippingPlane=t.nearClippingPlane,this.targetPosition=t.targetPosition}getTranslation(e,t,i,n){return this.getVectorValue(e,"KCTR",t,i,n,Ne)}getTargetTranslation(e,t,i,n){return this.getVectorValue(e,"KTTR",t,i,n,Ne)}getRotation(e,t,i,n){return this.getScalarValue(e,"KCRL",t,i,n,0)}}class Co extends be{geometryEmitterType=-1;type;id;tracks;globalSequence=-1;defval=new Uint32Array(1);internalModel=null;internalTexture=null;colors=[];intervalTimes=new Float32Array(3);scale=0;columns=0;rows=0;lifeSpan=0;blendSrc=0;blendDst=0;intervals=[];distanceCutoff=0;maxDistance=0;minDistance=0;pitch=0;pitchVariance=0;volume=0;decodedBuffers=[];ok=!1;constructor(e,t,i){super(e,t,i);const n=e.viewer,s=t.name;let o=s.substring(0,3);const a=s.substring(4);o==="FPT"&&(o="SPL"),o==="SPL"?this.geometryEmitterType=qn:o==="UBR"&&(this.geometryEmitterType=Ao),this.type=o,this.id=a,this.tracks=t.tracks;const l=t.globalSequenceId;if(l!==-1&&(this.globalSequence=e.globalSequences[l]),o==="SND"&&!n.audioEnabled)return;const c=n.promise();Bt.getEventObjectData(n,o,a,e.hd).then(d=>{if(c(),d){const{row:h,resources:u}=d;if(this.ok=!0,o==="SPN")this.internalModel=u[0];else if(o==="SPL"||o==="UBR"){this.internalTexture=new lt(0,De.WrapBoth),this.internalTexture.texture=u[0],this.scale=h.number("Scale"),this.colors[0]=new Float32Array([h.number("StartR"),h.number("StartG"),h.number("StartB"),h.number("StartA")]),this.colors[1]=new Float32Array([h.number("MiddleR"),h.number("MiddleG"),h.number("MiddleB"),h.number("MiddleA")]),this.colors[2]=new Float32Array([h.number("EndR"),h.number("EndG"),h.number("EndB"),h.number("EndA")]),o==="SPL"?(this.columns=h.number("Columns"),this.rows=h.number("Rows"),this.lifeSpan=h.number("Lifespan")+h.number("Decay"),this.intervalTimes[0]=h.number("Lifespan"),this.intervalTimes[1]=h.number("Decay"),this.intervals[0]=new Float32Array([h.number("UVLifespanStart"),h.number("UVLifespanEnd"),h.number("LifespanRepeat")]),this.intervals[1]=new Float32Array([h.number("UVDecayStart"),h.number("UVDecayEnd"),h.number("DecayRepeat")])):(this.columns=1,this.rows=1,this.lifeSpan=h.number("BirthTime")+h.number("PauseTime")+h.number("Decay"),this.intervalTimes[0]=h.number("BirthTime"),this.intervalTimes[1]=h.number("PauseTime"),this.intervalTimes[2]=h.number("Decay"));const p=kn(h.number("BlendMode"),n.gl);this.blendSrc=p[0],this.blendDst=p[1]}else{this.distanceCutoff=h.number("DistanceCutoff"),this.maxDistance=h.number("MaxDistance"),this.minDistance=h.number("MinDistance"),this.pitch=h.number("Pitch"),this.pitchVariance=h.number("PitchVariance"),this.volume=h.number("Volume");for(const p of u)this.decodedBuffers.push(p.data)}}})}getValue(e,t){if(this.globalSequence!==-1){const i=this.globalSequence;return this.getValueAtTime(e,t.counter%i,0,i)}else if(t.sequence!==-1){const i=this.model.sequences[t.sequence].interval;return this.getValueAtTime(e,t.frame,i[0],i[1])}else return e[0]=this.defval[0],-1}getValueAtTime(e,t,i,n){const s=this.tracks;if(t>=i&&t<=n)for(let o=s.length-1;o>-1;o--){if(s[o]<i)return e[0]=0,o;if(s[o]<=t)return e[0]=1,o}return e[0]=0,-1}}class Lo extends be{type;vertices;boundsRadius;constructor(e,t,i){super(e,t,i),this.type=t.type,this.vertices=t.vertices,this.boundsRadius=t.boundsRadius}}var ee=(r=>(r[r.VertexGroups=0]="VertexGroups",r[r.ExtendedVertexGroups=1]="ExtendedVertexGroups",r[r.Skin=2]="Skin",r))(ee||{});class Ke{index;geoset;layer;material;skinningType;isHd;constructor(e,t,i,n,s){let o,a;s?(o=i,a=o.layers[0]):(o=null,a=i),this.index=e,this.geoset=t,this.skinningType=n,this.isHd=s,this.layer=a,this.material=o}}class Ro{model;index;positionOffset;normalOffset;uvOffset;tangentOffset;skinOffset;faceOffset;vertices;elements;faceType;geosetAnimation=null;constructor(e,t,i,n,s,o,a,l,c,d,h){this.model=e,this.index=t,this.positionOffset=i,this.normalOffset=n,this.uvOffset=s,this.tangentOffset=o,this.skinOffset=a,this.faceOffset=l,this.vertices=c,this.elements=d,this.faceType=h;for(const u of e.geosetAnimations)u.geosetId===t&&(this.geosetAnimation=u)}bindShared(e,t,i){e.vertexAttribPointer(t.a_position,3,e.FLOAT,!1,0,this.positionOffset),e.vertexAttribPointer(t.a_normal,3,e.FLOAT,!1,0,this.normalOffset),e.vertexAttribPointer(t.a_uv,2,e.FLOAT,!1,0,this.uvOffset+i*this.vertices*8)}bindVertexGroups(e,t){const i=this.model,n=i.skinDataType,s=i.bytesPerSkinElement;e.vertexAttribPointer(t.a_bones,4,n,!1,5*s,this.skinOffset),e.vertexAttribPointer(t.a_boneNumber,1,n,!1,5*s,this.skinOffset+4*s)}bindVertexGroupsExtended(e,t){const i=this.model,n=i.skinDataType,s=i.bytesPerSkinElement;e.vertexAttribPointer(t.a_bones,4,n,!1,9*s,this.skinOffset),e.vertexAttribPointer(t.a_extendedBones,4,n,!1,9*s,this.skinOffset+4*s),e.vertexAttribPointer(t.a_boneNumber,1,n,!1,9*s,this.skinOffset+8*s)}bindSkin(e,t){e.vertexAttribPointer(t.a_bones,4,e.UNSIGNED_BYTE,!1,8,this.skinOffset),e.vertexAttribPointer(t.a_weights,4,e.UNSIGNED_BYTE,!0,8,this.skinOffset+4)}bind(e,t){const i=this.model.viewer.gl,n=e.attribs;this.bindShared(i,n,t),n.a_weights!==void 0?this.bindSkin(i,n):this.bindVertexGroups(i,n)}bindExtended(e,t){const i=this.model.viewer.gl,n=e.attribs;this.bindShared(i,n,t),this.bindVertexGroupsExtended(i,n)}bindHd(e,t,i){const n=this.model.viewer.gl,s=e.attribs;this.bindShared(n,s,i),n.vertexAttribPointer(s.a_tangent,4,n.FLOAT,!1,0,this.tangentOffset),t===ee.Skin?this.bindSkin(n,s):t===ee.ExtendedVertexGroups?this.bindVertexGroupsExtended(n,s):this.bindVertexGroups(n,s)}render(){const e=this.model.viewer.gl;e.drawElements(this.faceType,this.elements,e.UNSIGNED_SHORT,this.faceOffset)}}function Fo(r,e){if(e.length>0){const t=r.viewer.gl;let i=0,n=0,s=0,o=0,a=0,l=0;const c=[];for(let m=0,E=e.length;m<E;m++){const x=e[m];if(x.lod===0||x.lod===-1){const y=x.vertices.length/3;if(i+=y*12,n+=y*12,s+=x.uvSets.length*y*8,x.tangents.length&&(o+=y*16),x.skin.length)a+=y*8,c[m]=ee.Skin;else{let A=0;for(const U of x.matrixGroups)U>A&&(A=U);A>4?(a+=y*9,c[m]=ee.ExtendedVertexGroups):(a+=y*5,c[m]=ee.VertexGroups)}l+=x.faces.byteLength}}let d=0,h=d+i,u=h+n,p=u+s,g=p+o,v=0,b=Uint8Array,w=t.UNSIGNED_BYTE;r.bones.length>255&&(a*=2,b=Uint16Array,w=t.UNSIGNED_SHORT),r.skinDataType=w,r.bytesPerSkinElement=b.BYTES_PER_ELEMENT,r.arrayBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,r.arrayBuffer),t.bufferData(t.ARRAY_BUFFER,g+a,t.STATIC_DRAW),r.elementBuffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,r.elementBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,l,t.STATIC_DRAW);for(let m=0,E=e.length;m<E;m++){const x=e[m];if(x.lod===0||x.lod===-1){const y=x.vertices,A=x.normals,U=x.uvSets,G=x.tangents,T=x.faces;let H;const re=x.vertices.length/3,k=c[m];if(k===ee.Skin)H=x.skin;else{const N=x.matrixIndices,C=x.vertexGroups,F=[];let O=0,P=4;k===ee.ExtendedVertexGroups&&(P=8),H=new b(re*(P+1));for(const K of x.matrixGroups)F.push(N.subarray(O,O+K)),O+=K;for(let K=0;K<re;K++){const W=F[C[K]];if(O=K*(P+1),W){const $=Math.min(W.length,P);for(let S=0;S<$;S++)H[O+S]=W[S]+1;H[O+P]=$}}}const z=new Ro(r,r.geosets.length,d,h,u,p,g,v,re,T.length,x.faceTypeGroups[0]);r.geosets.push(z);const B=r.materials[x.materialId];if(B.shader==="Shader_HD_DefaultUnit")r.batches.push(new Ke(r.batches.length,z,B,k,!0));else for(const N of B.layers)r.batches.push(new Ke(r.batches.length,z,N,k,!1));t.bufferSubData(t.ARRAY_BUFFER,d,y),d+=y.byteLength,t.bufferSubData(t.ARRAY_BUFFER,h,A),h+=A.byteLength;for(const N of U)t.bufferSubData(t.ARRAY_BUFFER,u,N),u+=N.byteLength;G.length&&(t.bufferSubData(t.ARRAY_BUFFER,p,G),p+=G.byteLength),t.bufferSubData(t.ARRAY_BUFFER,g,H),g+=H.byteLength,t.bufferSubData(t.ELEMENT_ARRAY_BUFFER,v,T),v+=T.byteLength}}}}class Wn{model;skinningType;isHd;objects=[];constructor(e,t,i){this.model=e,this.skinningType=t,this.isHd=i}render(e){const t=e.scene,i=t.camera,n=e.textureOverrides,s=e.layerAlphas,o=this.model,a=o.textures,l=o.batches,c=o.viewer,d=c.sharedCache.get("mdx"),h=c.gl,u=c.webgl,p=this.skinningType,g=this.isHd,v=d.teamColors,b=d.teamGlows,w=Bt.getBatchShader(c,p,g);w.use();const m=w.uniforms;h.uniformMatrix4fv(m.u_VP,!1,i.viewProjectionMatrix);const E=e.boneTexture;if(E?(E.bind(15),h.uniform1f(m.u_hasBones,1),h.uniform1i(m.u_boneMap,15),h.uniform1f(m.u_vectorSize,1/E.width),h.uniform1f(m.u_rowSize,1)):h.uniform1f(m.u_hasBones,0),h.uniform3fv(m.u_lightPos,t.lightPosition),h.bindBuffer(h.ARRAY_BUFFER,o.arrayBuffer),h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,o.elementBuffer),g){h.uniform1i(m.u_diffuseMap,0),h.uniform1i(m.u_normalsMap,1),h.uniform1i(m.u_ormMap,2),h.uniform1i(m.u_emissiveMap,3),h.uniform1i(m.u_teamColorMap,4),h.uniform1i(m.u_environmentMap,5),h.disable(h.BLEND),h.enable(h.DEPTH_TEST),h.depthMask(!0),h.uniformMatrix4fv(m.u_MV,!1,i.viewMatrix),h.uniform3fv(m.u_eyePos,i.location);for(const x of this.objects){const y=l[x],A=y.geoset,U=y.material,[G,T,H,re,k,z]=U.layers,B=s[G.index];if(B>0){h.uniform1f(m.u_layerAlpha,B),h.uniform1f(m.u_filterMode,G.filterMode);const _=G.textureId,N=T.textureId,C=H.textureId,F=re.textureId,O=k.textureId,P=z.textureId,K=a[_],W=a[N],$=a[C],S=a[F];let L=a[O];const V=a[P];(L.replaceableId===0||L.replaceableId===1)&&(L=v[e.teamColor]);const te=n.get(_)||K.texture,X=n.get(N)||W.texture,oe=n.get(C)||$.texture,ce=n.get(F)||S.texture,ae=n.get(O)||L.texture,pt=n.get(P)||V.texture;u.bindTextureAndWrap(te,0,K.wrapS,K.wrapT),u.bindTextureAndWrap(X,1,W.wrapS,W.wrapT),u.bindTextureAndWrap(oe,2,$.wrapS,$.wrapT),u.bindTextureAndWrap(ce,3,S.wrapS,S.wrapT),u.bindTextureAndWrap(ae,4,L.wrapS,L.wrapT),u.bindTextureAndWrap(pt,5,V.wrapS,V.wrapT),A.bindHd(w,y.skinningType,G.coordId),A.render()}}}else{const x=e.geosetColors,y=e.layerTextures,A=e.uvAnims;h.uniform4fv(m.u_vertexColor,e.vertexColor),h.uniform1i(m.u_texture,0);for(const U of this.objects){const G=l[U],T=G.geoset,H=G.layer,re=T.index,k=H.index,z=x[re],B=s[k];if(z[3]>.01&&B>.01){const _=y[k],N=a[_],C=A[k];h.uniform4fv(m.u_geosetColor,z),h.uniform1f(m.u_layerAlpha,B),h.uniform1f(m.u_unshaded,H.unshaded),h.uniform2f(m.u_uvTrans,C[0],C[1]),h.uniform2f(m.u_uvRot,C[2],C[3]),h.uniform1f(m.u_uvScale,C[4]),H.bind(w);let F=n.get(_);if(!F){const O=N.replaceableId;let P;O===1?P=v[e.teamColor]:O===2?P=b[e.teamColor]:P=N,P&&(F=P.texture)}u.bindTextureAndWrap(F,0,N.wrapS,N.wrapT),p===ee.ExtendedVertexGroups?T.bindExtended(w,H.coordId):T.bind(w,H.coordId),T.render()}}}}}class Uo{model;objects=[];constructor(e){this.model=e}render(e){const t=e.scene,i=e.nodes,s=e.model.viewer,o=s.gl,a=s.webgl.extensions.ANGLE_instanced_arrays,l=s.sharedCache.get("mdx"),c=l.particlesShader,d=c.uniforms,h=c.attribs,u=l.rectBuffer;o.depthMask(!1),o.enable(o.BLEND),o.disable(o.CULL_FACE),o.enable(o.DEPTH_TEST),c.use(),o.uniformMatrix4fv(d.u_VP,!1,t.camera.viewProjectionMatrix),o.uniform1i(d.u_texture,0),a.vertexAttribDivisorANGLE(h.a_position,0),o.bindBuffer(o.ARRAY_BUFFER,u),o.vertexAttribPointer(h.a_position,1,o.UNSIGNED_BYTE,!1,0,0),a.vertexAttribDivisorANGLE(h.a_p0,1),a.vertexAttribDivisorANGLE(h.a_p1,1),a.vertexAttribDivisorANGLE(h.a_p2,1),a.vertexAttribDivisorANGLE(h.a_p3,1),a.vertexAttribDivisorANGLE(h.a_health,1),a.vertexAttribDivisorANGLE(h.a_color,1),a.vertexAttribDivisorANGLE(h.a_tail,1),a.vertexAttribDivisorANGLE(h.a_leftRightTop,1);for(const p of this.objects)Io(i[p].object,c);a.vertexAttribDivisorANGLE(h.a_leftRightTop,0),a.vertexAttribDivisorANGLE(h.a_tail,0),a.vertexAttribDivisorANGLE(h.a_color,0),a.vertexAttribDivisorANGLE(h.a_health,0),a.vertexAttribDivisorANGLE(h.a_p3,0),a.vertexAttribDivisorANGLE(h.a_p2,0),a.vertexAttribDivisorANGLE(h.a_p1,0),a.vertexAttribDivisorANGLE(h.a_p0,0)}}function Zn(r){return r instanceof Ke||r instanceof Yn?r.layer.priorityPlane:r instanceof Xn?r.priorityPlane:0}function Qn(r,e){return r instanceof Wn?e instanceof Ke&&e.skinningType===r.skinningType&&e.isHd===r.isHd:e instanceof be}function Jn(r,e){return e instanceof Ke?new Wn(r,e.skinningType,e.isHd):new Uo(r)}function Po(r){const e=[];let t=[];for(const a of r.batches)a.layer.filterMode<2?e.push(a):t.push(a);const i=r.opaqueGroups,n=r.translucentGroups;let s=null;for(const a of e)(!s||!Qn(s,a))&&(s=Jn(r,a),i.push(s)),s.objects.push(a.index);t=t.sort((a,l)=>a.layer.filterMode-l.layer.filterMode);const o=[...t,...r.eventObjects,...r.particleEmitters2,...r.ribbonEmitters].sort((a,l)=>Zn(a)-Zn(l));s=null;for(const a of o)(a instanceof Ke||a.geometryEmitterType!==-1)&&((!s||!Qn(s,a))&&(s=Jn(r,a),n.push(s)),s.objects.push(a.index))}const Do=f.vec3.create(),ko=f.quat.create(),Oo=f.vec3.create();class Mo{pivot=f.vec3.create();localLocation=f.vec3.create();localRotation=f.quat.create();localScale=f.vec3.fromValues(1,1,1);worldLocation=f.vec3.create();worldRotation=f.quat.create();worldScale=f.vec3.fromValues(1,1,1);inverseWorldLocation=f.vec3.create();inverseWorldRotation=f.quat.create();inverseWorldScale=f.vec3.fromValues(1,1,1);localMatrix=f.mat4.create();worldMatrix=f.mat4.create();dontInheritTranslation=!1;dontInheritRotation=!1;dontInheritScaling=!0;parent=null;children=[];setPivot(e){return f.vec3.copy(this.pivot,e),this.recalculateTransformation(),this}setLocation(e){return f.vec3.copy(this.localLocation,e),this.recalculateTransformation(),this}setRotation(e){return f.quat.copy(this.localRotation,e),this.recalculateTransformation(),this}setScale(e){return f.vec3.copy(this.localScale,e),this.recalculateTransformation(),this}setUniformScale(e){return f.vec3.set(this.localScale,e,e,e),this.recalculateTransformation(),this}setTransformation(e,t,i){const n=this.localLocation,s=this.localRotation,o=this.localScale;return n[0]=e[0],n[1]=e[1],n[2]=e[2],s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],o[0]=i[0],o[1]=i[1],o[2]=i[2],this.recalculateTransformation(),this}resetTransformation(){return f.vec3.copy(this.pivot,Ne),f.vec3.copy(this.localLocation,Ne),f.quat.copy(this.localRotation,Yt),f.vec3.copy(this.localScale,Xt),this.recalculateTransformation(),this}movePivot(e){return f.vec3.add(this.pivot,this.pivot,e),this.recalculateTransformation(),this}move(e){return f.vec3.add(this.localLocation,this.localLocation,e),this.recalculateTransformation(),this}rotate(e){return f.quat.mul(this.localRotation,this.localRotation,e),this.recalculateTransformation(),this}rotateLocal(e){return f.quat.mul(this.localRotation,e,this.localRotation),this.recalculateTransformation(),this}scale(e){return f.vec3.mul(this.localScale,this.localScale,e),this.recalculateTransformation(),this}uniformScale(e){return f.vec3.scale(this.localScale,this.localScale,e),this.recalculateTransformation(),this}face(e,t){return f.quat.conjugate(this.localRotation,Ui(this.localRotation,this.localLocation,e,t)),this.recalculateTransformation(),this}setParent(e){if(this.parent){const t=this.parent.children,i=t.indexOf(this);i!==-1&&t.splice(i,1)}return this.parent=e||null,e&&e.children.push(this),this.recalculateTransformation(),this}recalculateTransformation(){const e=this.parent,t=this.localMatrix,i=this.localLocation,n=this.localRotation,s=this.localScale,o=this.worldMatrix,a=this.worldLocation,l=this.worldRotation,c=this.worldScale,d=this.inverseWorldLocation,h=this.inverseWorldRotation,u=this.inverseWorldScale;if(e){const p=Do,g=e.pivot;let v,b;if(p[0]=i[0]+g[0],p[1]=i[1]+g[1],p[2]=i[2]+g[2],this.dontInheritRotation?(v=ko,f.quat.mul(v,n,e.inverseWorldRotation)):v=n,this.dontInheritScaling){b=Oo;const w=e.inverseWorldScale;b[0]=w[0]*s[0],b[1]=w[1]*s[1],b[2]=w[2]*s[2],c[0]=s[0],c[1]=s[1],c[2]=s[2]}else{b=s;const w=e.worldScale;c[0]=w[0]*s[0],c[1]=w[1]*s[1],c[2]=w[2]*s[2]}f.mat4.fromRotationTranslationScale(t,v,p,b),f.mat4.mul(o,e.worldMatrix,t),f.quat.mul(l,e.worldRotation,v)}else f.mat4.fromRotationTranslationScale(t,n,i,s),o[0]=t[0],o[1]=t[1],o[2]=t[2],o[3]=t[3],o[4]=t[4],o[5]=t[5],o[6]=t[6],o[7]=t[7],o[8]=t[8],o[9]=t[9],o[10]=t[10],o[11]=t[11],o[12]=t[12],o[13]=t[13],o[14]=t[14],o[15]=t[15],l[0]=n[0],l[1]=n[1],l[2]=n[2],l[3]=n[3],c[0]=s[0],c[1]=s[1],c[2]=s[2];h[0]=-l[0],h[1]=-l[1],h[2]=-l[2],h[3]=l[3],u[0]=1/c[0],u[1]=1/c[1],u[2]=1/c[2],a[0]=o[12],a[1]=o[13],a[2]=o[14],d[0]=-a[0],d[1]=-a[1],d[2]=-a[2];for(const p of this.children)p.recalculateTransformation()}update(e){for(const t of this.children)t.update(e)}}class No extends Mo{scene=null;left=-1;right=-1;bottom=-1;top=-1;plane=-1;depth=0;updateFrame=0;model;timeScale=1;rendered=!0;textureOverrides=new Map;constructor(e){super(),this.model=e}show(){this.rendered=!0}hide(){this.rendered=!1}shown(){return this.rendered}hidden(){return!this.rendered}detach(){return this.scene?this.scene.removeInstance(this):!1}overrideTexture(e,t){t?this.textureOverrides.set(e,t):this.textureOverrides.delete(e)}getBounds(){return this.model.bounds}clearEmittedObjects(){}setScene(e){return e.addInstance(this)}recalculateTransformation(){super.recalculateTransformation(),this.scene&&this.scene.grid.moved(this)}update(e){const t=this.scene;t&&this.rendered&&this.isVisible(t.camera)&&(t.renderInstance(this),this.updateAnimations(e*this.timeScale),super.update(e))}updateAnimations(e){}renderOpaque(){}renderTranslucent(){}isVisible(e){const[t,i,n]=this.worldLocation,[s,o,a]=this.worldScale,l=this.getBounds(),c=e.planes;let d=s;return o>d&&(d=o),a>d&&(d=a),this.plane=ur(c,t+l.x,i+l.y,n+l.z,l.r*d,this.plane),this.plane===-1?(this.depth=Fi(c[4],t,i,n),!0):!1}}const $e=f.vec3.create(),ai=f.quat.create(),Vo=f.vec3.create(),ke=f.vec3.create(),pe=f.quat.create();class es{pivot;localLocation;localRotation;localScale;worldLocation;worldRotation;worldScale;inverseWorldLocation;inverseWorldRotation;inverseWorldScale;localMatrix;worldMatrix;dontInheritTranslation=!1;dontInheritRotation=!1;dontInheritScaling=!1;billboarded=!1;billboardedX=!1;billboardedY=!1;billboardedZ=!1;dirty=!0;wasDirty=!1;parent=null;children=[];object=null;constructor(e,t,i,n,s,o,a,l,c,d,h,u){this.pivot=e,this.localLocation=t,this.localRotation=i,this.localScale=n,this.worldLocation=s,this.worldRotation=o,this.worldScale=a,this.inverseWorldLocation=l,this.inverseWorldRotation=c,this.inverseWorldScale=d,this.localMatrix=h,this.worldMatrix=u,this.localRotation[3]=1,this.localScale.fill(1),this.localMatrix[0]=1,this.localMatrix[5]=1,this.localMatrix[10]=1,this.localMatrix[15]=1}recalculateTransformation(e){const t=e.scene,i=this.localMatrix,n=this.localLocation,s=this.localRotation,o=this.localScale,a=this.worldMatrix,l=this.worldLocation,c=this.worldRotation,d=this.worldScale,h=this.pivot,u=this.inverseWorldLocation,p=this.inverseWorldRotation,g=this.inverseWorldScale,v=this.parent;let b,w,m;if(this.dontInheritTranslation?(f.vec3.add($e,v.inverseWorldLocation,l),b=f.vec3.add($e,$e,n)):b=n,this.dontInheritScaling?(f.vec3.mul($e,v.inverseWorldScale,e.worldScale),m=f.vec3.mul($e,$e,o)):m=o,this.billboarded)w=ai,f.quat.copy(w,v.inverseWorldRotation),f.quat.mul(w,w,t.camera.inverseRotation),this.convertBasis(w),f.quat.mul(w,w,s);else{const{billboardedX:U,billboardedY:G,billboardedZ:T}=this;U||G||T?(U&&(m===o&&(m=Vo,f.vec3.copy(m,o)),m[2]*=-1),pe[0]=-s[0],pe[1]=-s[1],pe[2]=-s[2],f.quat.mul(pe,pe,v.inverseWorldRotation),f.vec3.transformQuat(ke,t.camera.billboardedVectors[6],pe),U?f.quat.setAxisAngle(pe,zt,Math.atan2(ke[2],ke[1])):G?f.quat.setAxisAngle(pe,Li,Math.atan2(-ke[2],ke[0])):f.quat.setAxisAngle(pe,Be,Math.atan2(ke[1],ke[0])),w=ai,f.quat.mul(w,s,pe)):w=s}this.dontInheritRotation&&(f.quat.mul(pe,v.inverseWorldRotation,e.worldRotation),w=f.quat.mul(ai,pe,w)),f.mat4.fromRotationTranslationScaleOrigin(i,w,b,m,h),f.mat4.mul(a,v.worldMatrix,i);const E=h[0],x=h[1],y=h[2];l[0]=a[0]*E+a[4]*x+a[8]*y+a[12],l[1]=a[1]*E+a[5]*x+a[9]*y+a[13],l[2]=a[2]*E+a[6]*x+a[10]*y+a[14],u[0]=-l[0],u[1]=-l[1],u[2]=-l[2],f.quat.mul(c,v.worldRotation,w),p[0]=-c[0],p[1]=-c[1],p[2]=-c[2],p[3]=c[3];const A=v.worldScale;d[0]=A[0]*m[0],d[1]=A[1]*m[1],d[2]=A[2]*m[2],g[0]=1/d[0],g[1]=1/d[1],g[2]=1/d[2]}convertBasis(e){}}const Go=65;function jo(r,e=es){const t=new Float32Array(r*Go),i=[];let n=0;const s=r*3,o=r*4,a=r*16,l=t.subarray(n,n+s);n+=s;const c=t.subarray(n,n+s);n+=s;const d=t.subarray(n,n+o);n+=o;const h=t.subarray(n,n+s);n+=s;const u=t.subarray(n,n+s);n+=s;const p=t.subarray(n,n+o);n+=o;const g=t.subarray(n,n+s);n+=s;const v=t.subarray(n,n+s);n+=s;const b=t.subarray(n,n+o);n+=o;const w=t.subarray(n,n+s);n+=s;const m=t.subarray(n,n+a);n+=a;const E=t.subarray(n,n+a);for(let x=0;x<r;x++){const y=x*3,A=y+3,U=x*4,G=U+4,T=x*16,H=T+16;i[x]=new e(l.subarray(y,A),c.subarray(y,A),d.subarray(U,G),h.subarray(y,A),u.subarray(y,A),p.subarray(U,G),g.subarray(y,A),v.subarray(y,A),b.subarray(U,G),w.subarray(y,A),m.subarray(T,H),E.subarray(T,H))}return{data:t,nodes:i,pivots:l,localLocations:c,localRotations:d,localScales:h,worldLocations:u,worldRotations:p,worldScales:g,inverseWorldLocations:v,invereseWorldRotations:b,inverseWorldScales:w,localMatrices:m,worldMatrices:E}}class Ho extends es{convertBasis(e){f.quat.rotateY(e,e,-Math.PI/2),f.quat.rotateX(e,e,-Math.PI/2)}}const ts=new Float32Array(1);class qo{instance;attachment;internalInstance;constructor(e,t){const n=t.internalModel.addInstance();n.setSequenceLoopMode(2),n.dontInheritScaling=!1,n.hide(),n.setParent(e.nodes[t.objectId]),this.instance=e,this.attachment=t,this.internalInstance=n}update(){const e=this.instance,t=this.internalInstance;e.scene&&e.sequence!==-1&&(this.attachment.getVisibility(ts,e.sequence,e.frame,e.counter),ts[0]>.1?(e.scene.addInstance(t),t.hidden()&&(t.show(),t.setSequence(0))):t.hide())}}class Ko{instance;objects=[];alive=0;currentEmission=0;constructor(e){this.instance=e}update(e){this.updateEmission(e);const t=this.currentEmission;if(t>=1)for(let i=0;i<t;i+=1)this.emit()}clear(){const e=this.objects;for(let t=0,i=this.alive;t<i;t++){const n=e[t];n.health=0}this.currentEmission=0}emitObject(e){const t=this.objects;this.alive===t.length&&t.push(this.createObject());const i=t[this.alive];return i.index=this.alive,i.bind(e),this.alive+=1,this.currentEmission-=1,this.instance.scene.emittedObjectUpdater.add(i),i}kill(e){const t=this.objects;this.alive-=1;const i=t[this.alive];t[e.index]=i,t[this.alive]=e,i.index=e.index,e.index=-1}}class xt extends Ko{emitterObject;constructor(e,t){super(e),this.emitterObject=t}update(e){this.emitterObject.ok&&super.update(e)}}class ze{emitter;index=-1;health=0;constructor(e){this.emitter=e}}const Oe=f.quat.create(),$o=f.vec3.create(),li=new Float32Array(1),is=new Float32Array(1),ns=new Float32Array(1),ss=new Float32Array(1);class zo extends ze{internalInstance;velocity=f.vec3.create();gravity=0;constructor(e){super(e);const i=e.emitterObject.internalModel;this.internalInstance=i.addInstance()}bind(){const e=this.emitter,t=e.instance,i=t.sequence,n=t.frame,s=t.counter,o=t.scene,a=e.emitterObject,l=t.nodes[a.index],c=this.internalInstance,d=l.worldScale,h=this.velocity;a.getLatitude(li,i,n,s),a.getLifeSpan(is,i,n,s),a.getGravity(ns,i,n,s),a.getSpeed(ss,i,n,s),this.health=is[0],this.gravity=ns[0]*d[2],f.quat.identity(Oe),f.quat.rotateZ(Oe,Oe,Ce(-Math.PI,Math.PI)),f.quat.rotateY(Oe,Oe,Ce(-li[0],li[0])),f.vec3.transformQuat(h,Be,Oe),f.vec3.transformQuat(h,h,l.worldRotation),f.vec3.scale(h,h,ss[0]),f.vec3.mul(h,h,d),c.setScene(o),c.setSequence(0),c.setTransformation(l.worldLocation,f.quat.setAxisAngle(Oe,Be,Ce(0,Math.PI*2)),l.worldScale),c.show()}update(e){const t=this.internalInstance;if(this.health-=e,this.health>0){const i=this.velocity;i[2]-=this.gravity*e,t.move(f.vec3.scale($o,i,e))}else t.hide()}}const rs=new Float32Array(1);class Xo extends xt{updateEmission(e){const t=this.instance;t.allowParticleSpawn&&(this.emitterObject.getEmissionRate(rs,t.sequence,t.frame,t.counter),this.currentEmission+=rs[0]*e)}emit(){this.emitObject()}createObject(){return new zo(this)}}const me=f.quat.create(),os=new Float32Array(1),as=new Float32Array(1),ls=new Float32Array(1),cs=new Float32Array(1),hs=new Float32Array(1),ds=new Float32Array(1);class Yo extends ze{tail=0;gravity=0;location=f.vec3.create();velocity=f.vec3.create();scale=f.vec3.create();facing=0;bind(e){const t=this.emitter,i=t.instance,n=i.sequence,s=i.frame,o=i.counter,a=t.emitterObject;a.getWidth(os,n,s,o),a.getLength(as,n,s,o),a.getLatitude(ls,n,s,o),a.getVariation(cs,n,s,o),a.getSpeed(hs,n,s,o),a.getGravity(ds,n,s,o);const l=t.node,c=l.pivot,d=l.worldScale,h=os[0]*.5,u=as[0]*.5,p=Di(ls[0]),g=cs[0],v=hs[0],b=this.location,w=this.velocity;this.health=a.lifeSpan,this.tail=e,this.gravity=ds[0]*d[2],f.vec3.copy(this.scale,d),b[0]=c[0]+Ce(-h,h),b[1]=c[1]+Ce(-u,u),b[2]=c[2],a.modelSpace||f.vec3.transformMat4(b,b,l.worldMatrix),f.quat.identity(me),f.quat.rotateZ(me,me,Math.PI/2),f.quat.rotateY(me,me,Ce(-p,p)),a.lineEmitter||f.quat.rotateX(me,me,Ce(-p,p)),a.modelSpace||f.quat.mul(me,l.worldRotation,me),f.vec3.transformQuat(w,Be,me),f.vec3.scale(w,w,v*(1+Ce(-g,g))),a.modelSpace||f.vec3.mul(w,w,d),a.xYQuad&&(this.facing=Math.atan2(w[1],w[0])-Math.PI+Math.PI/8)}update(e){if(this.health-=e,this.health>0){const t=this.location,i=this.velocity;i[2]-=this.gravity*e,t[0]+=i[0]*e,t[1]+=i[1]*e,t[2]+=i[2]*e}}}const ci=new Float32Array(1);class Wo extends xt{node;lastEmissionKey=-1;constructor(e,t){super(e,t),this.node=e.nodes[t.index]}updateEmission(e){const t=this.instance;if(t.allowParticleSpawn){const i=this.emitterObject,n=i.getEmissionRate(ci,t.sequence,t.frame,t.counter);i.squirt?(n!==this.lastEmissionKey&&(this.currentEmission+=ci[0]),this.lastEmissionKey=n):this.currentEmission+=ci[0]*e}}emit(){const e=this.emitterObject;e.head&&this.emitObject(0),e.tail&&this.emitObject(1)}createObject(){return new Yo(this)}}const Ae=f.vec3.create(),ye=f.vec3.create(),_t=new Float32Array(3),fs=new Float32Array(1),us=new Uint32Array(1);class Zo extends ze{vertices=new Float32Array(6);color=new Uint8Array(4);slot=0;prev=null;next=null;bind(){const e=this.emitter,t=e.instance,i=t.sequence,n=t.frame,s=t.counter,o=e.emitterObject,a=t.nodes[o.index],[l,c,d]=a.pivot,h=a.worldMatrix,u=this.vertices;this.health=e.emitterObject.lifeSpan,o.getHeightBelow(Ae,i,n,s),o.getHeightAbove(ye,i,n,s),Ae[1]=c-Ae[0],Ae[0]=l,Ae[2]=d,ye[1]=c+ye[0],ye[0]=l,ye[2]=d,f.vec3.transformMat4(Ae,Ae,h),f.vec3.transformMat4(ye,ye,h),u[0]=ye[0],u[1]=ye[1],u[2]=ye[2],u[3]=Ae[0],u[4]=Ae[1],u[5]=Ae[2]}update(e){if(this.health-=e,this.health>0){const t=this.emitter,i=t.instance,n=i.sequence,s=i.frame,o=i.counter,a=t.emitterObject,l=this.color,c=this.vertices,d=a.gravity*e*e;a.getColor(_t,n,s,o),a.getAlpha(fs,n,s,o),a.getTextureSlot(us,n,s,o),c[1]-=d,c[4]-=d,l[0]=_t[0]*255,l[1]=_t[1]*255,l[2]=_t[2]*255,l[3]=fs[0]*255,this.slot=us[0]}}}class Qo extends xt{first=null;last=null;updateEmission(e){if(this.instance.allowParticleSpawn){const i=this.emitterObject;this.currentEmission+=i.emissionRate*e}}emit(){const e=this.emitObject(),t=this.last;t?(t.next=e,e.prev=t):this.first=e,this.last=e}kill(e){super.kill(e);const t=e.prev,i=e.next;e===this.first&&(this.first=i),e===this.last&&(this.first=null,this.last=null),t&&(t.next=i),i&&(i.prev=t),e.prev=null,e.next=null}createObject(){return new Zo(this)}}const ps=new Uint32Array(1);class Et extends xt{lastValue=0;updateEmission(e){const t=this.instance;if(t.allowParticleSpawn){this.emitterObject.getValue(ps,t);const n=ps[0];n===1&&n!==this.lastValue&&(this.currentEmission+=1),this.lastValue=n}}emit(){this.emitObject()}}class Jo extends ze{internalInstance;constructor(e){super(e);const i=e.emitterObject.internalModel;this.internalInstance=i.addInstance()}bind(){const e=this.emitter,t=e.instance,i=t.scene,n=t.nodes[e.emitterObject.index],s=this.internalInstance;s.setScene(i),s.setSequence(0),s.setTransformation(n.worldLocation,n.worldRotation,n.worldScale),s.show(),this.health=1}update(e){const t=this.internalInstance,i=t.model;t.frame>=i.sequences[0].interval[1]&&(this.health=0,t.hide())}}class ea extends Et{createObject(){return new Jo(this)}}const se=f.vec3.create();class gs extends ze{vertices=new Float32Array(12);bind(){const e=this.emitter,t=e.instance,i=e.emitterObject,n=this.vertices,s=i.scale,{worldLocation:o,worldRotation:a}=t.nodes[i.index];this.health=i.lifeSpan,f.vec3.set(se,s,s,0),f.vec3.transformQuat(se,se,a),f.vec3.add(n.subarray(0,2),se,o),f.vec3.set(se,-s,s,0),f.vec3.transformQuat(se,se,a),f.vec3.add(n.subarray(3,5),se,o),f.vec3.set(se,-s,-s,0),f.vec3.transformQuat(se,se,a),f.vec3.add(n.subarray(6,8),se,o),f.vec3.set(se,s,-s,0),f.vec3.transformQuat(se,se,a),f.vec3.add(n.subarray(9,11),se,o)}update(e){this.health-=e}}class ta extends Et{createObject(){return new gs(this)}}class ia extends Et{createObject(){return new gs(this)}}class na extends ze{bind(){const e=this.emitter,t=e.instance,i=t.model.viewer,n=t.scene;if(i.audioEnabled&&n.audioEnabled){const s=e.emitterObject,o=t.nodes[s.index],a=n.audioContext,l=s.decodedBuffers,c=a.createPanner(),d=a.createBufferSource(),h=o.worldLocation;c.positionX.value=h[0],c.positionY.value=h[1],c.positionZ.value=h[2],c.maxDistance=s.distanceCutoff,c.refDistance=s.minDistance,c.connect(a.destination),d.buffer=l[Math.random()*l.length|0],d.connect(c),d.start(0)}}update(e){}}class sa extends Et{createObject(){return new na(this)}}const vs=new Float32Array(1),hi=f.vec3.create(),di=f.quat.create(),ws=f.vec3.create(),St=new Float32Array(3),It=new Float32Array(1),bs=new Uint32Array(1);class ra extends No{attachments=[];particleEmitters=[];particleEmitters2=[];ribbonEmitters=[];eventObjectEmitters=[];nodes=[];sortedNodes=[];frame=0;counter=0;sequence=-1;sequenceLoopMode=0;sequenceEnded=!1;teamColor=0;vertexColor=new Float32Array([1,1,1,1]);allowParticleSpawn=!1;forced=!0;geosetColors=[];layerAlphas=[];layerTextures=[];uvAnims=[];worldMatrices=null;boneTexture=null;constructor(e){super(e);for(let o=0,a=e.geosets.length;o<a;o++)this.geosetColors[o]=new Float32Array(4);for(let o=0,a=e.layers.length;o<a;o++)this.layerAlphas[o]=0,this.layerTextures[o]=0,this.uvAnims[o]=new Float32Array(5);const t=jo(e.genericObjects.length,Ho),i=t.nodes;let n=0;this.nodes.push(...i),this.worldMatrices=t.worldMatrices;for(const o of e.bones)this.initNode(i,i[n++],o);for(const o of e.lights)this.initNode(i,i[n++],o);for(const o of e.helpers)this.initNode(i,i[n++],o);for(const o of e.attachments){let a;o.internalModel&&(a=new qo(this,o),this.attachments.push(a)),this.initNode(i,i[n++],o,a)}for(const o of e.particleEmitters){const a=new Xo(this,o);this.particleEmitters.push(a),this.initNode(i,i[n++],o,a)}for(const o of e.particleEmitters2){const a=new Wo(this,o);this.particleEmitters2.push(a),this.initNode(i,i[n++],o,a)}for(const o of e.ribbonEmitters){const a=new Qo(this,o);this.ribbonEmitters.push(a),this.initNode(i,i[n++],o,a)}for(const o of e.eventObjects){const a=o.type;let l;a==="SPN"?l=new ea(this,o):a==="SPL"?l=new ta(this,o):a==="UBR"?l=new ia(this,o):l=new sa(this,o),this.eventObjectEmitters.push(l),this.initNode(i,i[n++],o,l)}for(const o of e.collisionShapes)this.initNode(i,i[n++],o);const s=e.hierarchy;for(let o=0,a=i.length;o<a;o++)this.sortedNodes[o]=i[s[o]];e.bones.length&&(this.boneTexture=new Ci(e.viewer.gl,4,e.bones.length*4,1))}setTexture(e,t){this.overrideTexture(e,t)}setParticle2Texture(e,t){this.overrideTexture(Kn+e,t)}setEventTexture(e,t){this.overrideTexture(oi+e,t)}clearEmittedObjects(){for(const e of this.particleEmitters)e.clear();for(const e of this.particleEmitters2)e.clear();for(const e of this.ribbonEmitters)e.clear();for(const e of this.eventObjectEmitters)e.clear()}initNode(e,t,i,n){f.vec3.copy(t.pivot,i.pivot),i.parentId===-1?t.parent=this:t.parent=e[i.parentId],t.dontInheritTranslation=i.dontInheritTranslation,t.dontInheritRotation=i.dontInheritRotation,t.dontInheritScaling=i.dontInheritScaling,i.billboarded?t.billboarded=!0:i.billboardedX?t.billboardedX=!0:i.billboardedY?t.billboardedY=!0:i.billboardedZ&&(t.billboardedZ=!0),n&&(t.object=n)}hide(){super.hide(),this.resetAttachments()}updateNodes(e,t){const i=this.sequence,n=this.frame,s=this.counter,o=this.sortedNodes,l=this.model.sortedGenericObjects;for(let c=0,d=o.length;c<d;c++){const h=l[c],u=o[c],p=u.parent;let g=t||p.wasDirty||h.anyBillboarding;const v=h.variants;(t||v.generic[i])&&(g=!0,(t||v.translation[i])&&h.getTranslation(u.localLocation,i,n,s),(t||v.rotation[i])&&h.getRotation(u.localRotation,i,n,s),(t||v.scale[i])&&h.getScale(u.localScale,i,n,s)),u.wasDirty=g,g&&u.recalculateTransformation(this),u.object&&(h.getVisibility(vs,i,n,s),vs[0]>0&&u.object.update(e));for(const b of u.children)g&&b.recalculateTransformation(),b.update(e)}}recalculateTransformation(){super.recalculateTransformation(),this.forced=!0}updateBatches(e){const t=this.sequence,i=this.frame,n=this.counter,s=this.model,o=s.geosets,a=s.layers,l=this.geosetColors,c=this.layerAlphas,d=this.layerTextures,h=this.uvAnims;for(let u=0,p=o.length;u<p;u++){const v=o[u].geosetAnimation,b=l[u];v?((e||v.variants.color[t])&&(v.getColor(St,t,i,n),b[0]=St[0],b[1]=St[1],b[2]=St[2]),(e||v.variants.alpha[t])&&(v.getAlpha(It,t,i,n),b[3]=It[0])):e&&(b[0]=1,b[1]=1,b[2]=1,b[3]=1)}for(let u=0,p=a.length;u<p;u++){const g=a[u],v=g.textureAnimation,b=h[u];(e||g.variants.alpha[t])&&(g.getAlpha(It,t,i,n),c[u]=It[0]),(e||g.variants.textureId[t])&&(g.getTextureId(bs,t,i,n),d[u]=bs[0]),v?((e||v.variants.translation[t])&&(v.getTranslation(hi,t,i,n),b[0]=hi[0],b[1]=hi[1]),(e||v.variants.rotation[t])&&(v.getRotation(di,t,i,n),b[2]=di[2],b[3]=di[3]),(e||v.variants.scale[t])&&(v.getScale(ws,t,i,n),b[4]=ws[0])):e&&(b[0]=0,b[1]=0,b[2]=0,b[3]=1,b[4]=1)}}updateBoneTexture(){this.boneTexture&&this.boneTexture.bindAndUpdate(this.worldMatrices)}renderOpaque(){const e=this.model;for(const t of e.opaqueGroups)t.render(this)}renderTranslucent(){const e=this.model;for(const t of e.translucentGroups)t.render(this)}updateAnimations(e){const t=this.model,i=this.sequence;if(i!==-1){const s=t.sequences[i],o=s.interval,a=e*1e3;this.frame+=a,this.counter+=a,this.allowParticleSpawn=!0,this.frame>=o[1]?(this.sequenceLoopMode===2||this.sequenceLoopMode===0&&s.nonLooping===0?(this.frame=o[0],this.resetEventEmitters()):(this.frame=o[1],this.counter-=a,this.allowParticleSpawn=!1),this.sequenceEnded=!0):this.sequenceEnded=!1}const n=this.forced;(i!==-1||n)&&(this.updateNodes(e,n),this.updateBoneTexture(),this.updateBatches(n)),this.forced=!1}setTeamColor(e){return this.teamColor=e,this}setVertexColor(e){return this.vertexColor.set(e),this}setSequence(e){const i=this.model.sequences;return this.sequence=e,e<0||e>i.length-1?(this.sequence=-1,this.frame=0,this.allowParticleSpawn=!1):this.frame=i[e].interval[0],this.resetEventEmitters(),this.resetAttachments(),this.forced=!0,this}getBounds(){const e=this.model;if(this.sequence===-1)return e.bounds;const t=e.sequences[this.sequence].bounds;return t.r===0?e.bounds:t}setSequenceLoopMode(e){return this.sequenceLoopMode=e,this}getAttachment(e){const i=this.model.attachments[e];if(i)return this.nodes[i.index]}resetEventEmitters(){for(const e of this.eventObjectEmitters)e.lastValue=0}resetAttachments(){for(const e of this.attachments)e.internalInstance.hide()}}class oa extends Xr{reforged=!1;hd=!1;solverParams={};name="";sequences=[];globalSequences=[];materials=[];layers=[];textures=[];textureAnimations=[];geosets=[];geosetAnimations=[];bones=[];lights=[];helpers=[];attachments=[];pivotPoints=[];particleEmitters=[];particleEmitters2=[];ribbonEmitters=[];cameras=[];eventObjects=[];collisionShapes=[];hasLayerAnims=!1;hasGeosetAnims=!1;batches=[];genericObjects=[];sortedGenericObjects=[];hierarchy=[];opaqueGroups=[];translucentGroups=[];arrayBuffer=null;elementBuffer=null;skinDataType=0;bytesPerSkinElement=1;constructor(e,t){super(t);let i;if(e instanceof yt)i=e;else{i=new yt;try{i.load(e)}catch{}}const n=this.viewer,s=this.pathSolver,o=this.solverParams,a=i.version>800,l=a?".dds":".blp";let c=!1;this.reforged=a,this.name=i.name;const d=i.extent;this.bounds.fromExtents(d.min,d.max);for(const g of i.sequences)this.sequences.push(new zr(g));for(const g of i.globalSequences)this.globalSequences.push(g);for(const g of i.textureAnimations)this.textureAnimations.push(new io(this,g));let h=0;for(const g of i.materials){const v=[];for(const b of g.layers){const w=new so(this,b,h++,g.priorityPlane);v.push(w),this.layers.push(w)}this.materials.push(new ro(this,g.shader,v)),g.shader!==""&&(this.hd=!0)}a&&(o.reforged=!0),this.hd&&(o.hd=!0);const u=i.textures;for(let g=0,v=u.length;g<v;g++){const b=u[g];let w=b.path;const m=b.replaceableId,E=b.wrapMode;w===""&&m!==0&&(w=`ReplaceableTextures\\${On[m]}${l}`,(m===1||m===2)&&(c=!0));const x=new lt(m,E);n.load(w,s,o).then(y=>{y&&(x.texture=y)}),this.textures[g]=x}for(const g of i.geosetAnimations)this.geosetAnimations.push(new oo(this,g));this.pivotPoints=i.pivotPoints;let p=0;for(const g of i.bones)this.bones.push(new ao(this,g,p++));for(const g of i.lights)this.lights.push(new lo(this,g,p++));for(const g of i.helpers)this.helpers.push(new co(this,g,p++));for(const g of i.attachments)this.attachments.push(new ho(this,g,p++));for(const g of i.particleEmitters)this.particleEmitters.push(new fo(this,g,p++));for(const g of i.particleEmitters2){const v=new Xn(this,g,p++);this.particleEmitters2.push(v),v.teamColored&&(c=!0)}for(const g of i.ribbonEmitters)this.ribbonEmitters.push(new Yn(this,g,p++));for(const g of i.cameras)this.cameras.push(new Bo(this,g));for(const g of i.eventObjects)this.eventObjects.push(new Co(this,g,p++));for(const g of i.collisionShapes)this.collisionShapes.push(new Lo(this,g,p++));this.genericObjects.push(...this.bones,...this.lights,...this.helpers,...this.attachments,...this.particleEmitters,...this.particleEmitters2,...this.ribbonEmitters,...this.eventObjects,...this.collisionShapes),Fo(this,i.geosets),Po(this),this.setupHierarchy(-1);for(let g=0,v=this.genericObjects.length;g<v;g++)this.sortedGenericObjects[g]=this.genericObjects[this.hierarchy[g]];c&&Bt.loadTeamTextures(n)}addInstance(){return new ra(this)}setupHierarchy(e){for(let t=0,i=this.genericObjects.length;t<i;t++){const n=this.genericObjects[t];n.parentId===e&&(this.hierarchy.push(t),this.setupHierarchy(n.objectId))}}}const ms=`
uniform sampler2D u_boneMap;
uniform float u_vectorSize;
uniform float u_rowSize;

mat4 fetchMatrix(float column, float row) {
  column *= u_vectorSize * 4.0;
  row *= u_rowSize;
  // Add in half a texel, to sample in the middle of the texel.
  // Otherwise, since the sample is directly on the boundary, floating point errors can cause the sample to get the wrong pixel.
  // This is most noticeable with NPOT textures, which the bone maps are.
  column += 0.5 * u_vectorSize;
  row += 0.5 * u_rowSize;

  return mat4(texture2D(u_boneMap, vec2(column, row)),
              texture2D(u_boneMap, vec2(column + u_vectorSize, row)),
              texture2D(u_boneMap, vec2(column + u_vectorSize * 2.0, row)),
              texture2D(u_boneMap, vec2(column + u_vectorSize * 3.0, row)));
}
`,As=`
#ifdef SKIN
attribute vec4 a_bones;
attribute vec4 a_weights;

void transformSkin(inout vec3 position, inout vec3 normal, inout vec3 tangent, inout vec3 binormal) {
  mat4 bone;

  bone += fetchMatrix(a_bones[0], 0.0) * a_weights[0];
  bone += fetchMatrix(a_bones[1], 0.0) * a_weights[1];
  bone += fetchMatrix(a_bones[2], 0.0) * a_weights[2];
  bone += fetchMatrix(a_bones[3], 0.0) * a_weights[3];

  mat3 rotation = mat3(bone);

  position = vec3(bone * vec4(position, 1.0));
  normal = rotation * normal;
  tangent = rotation * tangent;
  binormal = rotation * binormal;
}
#else
attribute vec4 a_bones;
#ifdef EXTENDED_BONES
attribute vec4 a_extendedBones;
#endif
attribute float a_boneNumber;

mat4 getVertexGroupMatrix() {
  mat4 bone;

  // For the broken models out there, since the game supports this.
  if (a_boneNumber > 0.0) {
    for (int i = 0; i < 4; i++) {
      if (a_bones[i] > 0.0) {
        bone += fetchMatrix(a_bones[i] - 1.0, 0.0);
      }
    }

    #ifdef EXTENDED_BONES
      for (int i = 0; i < 4; i++) {
        if (a_extendedBones[i] > 0.0) {
          bone += fetchMatrix(a_extendedBones[i] - 1.0, 0.0);
        }
      }
    #endif
  }

  return bone / a_boneNumber;
}

void transformVertexGroups(inout vec3 position, inout vec3 normal) {
  mat4 bone = getVertexGroupMatrix();
  mat3 rotation = mat3(bone);

  position = vec3(bone * vec4(position, 1.0));
  normal = normalize(rotation * normal);
}

void transformVertexGroupsHD(inout vec3 position, inout vec3 normal, inout vec3 tangent, inout vec3 binormal) {
  mat4 bone = getVertexGroupMatrix();
  mat3 rotation = mat3(bone);

  position = vec3(bone * vec4(position, 1.0));
  normal = normalize(rotation * normal);
  tangent = normalize(rotation * tangent);
  binormal = normalize(rotation * binormal);
}
#endif
`,Xe=`
uniform mat4 u_VP;
uniform vec3 u_lightPos;
uniform vec4 u_vertexColor;
uniform vec4 u_geosetColor;
uniform float u_layerAlpha;
uniform vec2 u_uvTrans;
uniform vec2 u_uvRot;
uniform float u_uvScale;
uniform bool u_hasBones;

attribute vec3 a_position;
attribute vec3 a_normal;
attribute vec2 a_uv;

varying vec2 v_uv;
varying vec3 v_normal;
varying vec4 v_color;
varying vec4 v_uvTransRot;
varying float v_uvScale;
varying vec3 v_lightDir;

${ms}
${As}

void main() {
  vec3 position = a_position;
  vec3 normal = a_normal;

  if (u_hasBones) {
    #ifdef SKIN
      vec3 tangent = vec3(0.0);
      vec3 binormal = vec3(0.0);
      transformSkin(position, normal, tangent, binormal);
    #else
      transformVertexGroups(position, normal);
    #endif
  }

  v_uv = a_uv;
  v_normal = normal;
  v_color = u_vertexColor * u_geosetColor.bgra * vec4(1.0, 1.0, 1.0, u_layerAlpha);
  v_uvTransRot = vec4(u_uvTrans, u_uvRot);
  v_uvScale = u_uvScale;
  v_lightDir = normalize(u_lightPos - position);

  gl_Position = u_VP * vec4(position, 1.0);
}
`,Ye=`
#ifdef GL_FRAGMENT_PRECISION_HIGH
precision highp float;
#else
precision mediump float;
#endif
`,We=`
${Ye}


// A 2D quaternion*vector.
// q is the zw components of the original quaternion.
vec2 quat_transform(vec2 q, vec2 v) {
  vec2 uv = vec2(-q.x * v.y, q.x * v.x);
  vec2 uuv = vec2(-q.x * uv.y, q.x * uv.x);

  return v + 2.0 * (uv * q.y + uuv);
}


uniform sampler2D u_texture;
uniform float u_filterMode;
uniform bool u_unshaded;

varying vec2 v_uv;
varying vec3 v_normal;
varying vec4 v_color;
varying vec4 v_uvTransRot;
varying float v_uvScale;
varying vec3 v_lightDir;

vec4 getDiffuseColor() {
  vec2 uv = v_uv;

  // Translation animation
  uv += v_uvTransRot.xy;

  // Rotation animation
  uv = quat_transform(v_uvTransRot.zw, uv - 0.5) + 0.5;

  // Scale animation
  uv = v_uvScale * (uv - 0.5) + 0.5;

  vec4 texel = texture2D(u_texture, uv);
  vec4 color = texel * v_color;

  // 1bit Alpha
  if (u_filterMode == 1.0 && color.a < 0.75) {
    discard;
  }

  // "Close to 0 alpha"
  if (u_filterMode >= 5.0 && color.a < 0.02) {
    discard;
  }

  return color;
}

void onlyTexCoords() {
  gl_FragColor = vec4(v_uv, 0.0, 1.0);
}

void onlyNormals() {
  gl_FragColor = vec4(v_normal, 1.0);
}

void onlyDiffuse() {
  gl_FragColor = getDiffuseColor();
}

void lambert() {
  vec4 color = getDiffuseColor();

  if (!u_unshaded) {
    float lambertFactor = clamp(dot(v_normal, v_lightDir), 0.0, 1.0);
    lambertFactor = clamp(lambertFactor + 0.7, 0.0, 1.0);

    color.rgb *= lambertFactor;
  }

  gl_FragColor = color;
}

void main() {
  #if defined(ONLY_DIFFUSE)
  onlyDiffuse();
  #elif defined(ONLY_TEXCOORDS)
  onlyTexCoords();
  #elif defined(ONLY_NORMALS)
  onlyNormals();
  #else
  lambert();
  #endif
}
`,de=`
uniform mat4 u_VP;
uniform mat4 u_MV;
uniform vec3 u_eyePos;
uniform vec3 u_lightPos;
uniform float u_layerAlpha;
uniform bool u_hasBones;

attribute vec3 a_position;
attribute vec3 a_normal;
attribute vec2 a_uv;
attribute vec4 a_tangent;

varying vec2 v_uv;
varying float v_layerAlpha;
varying vec3 v_lightDir;
varying vec3 v_eyeVec;
varying vec3 v_normal;
// varying vec3 v_lightDirWorld;

#if defined(ONLY_TANGENTS)
varying vec3 v_tangent;
#endif

${ms}
${As}

vec3 TBN(vec3 vector, vec3 tangent, vec3 binormal, vec3 normal) {
  return vec3(dot(vector, tangent), dot(vector, binormal), dot(vector, normal));
}

void main() {
  vec3 position = a_position;
  vec3 normal = a_normal;
  vec3 tangent = a_tangent.xyz;

  // Re-orthogonalize the tangent in case it wasnt normalized.
  // See "One last thing" at https://learnopengl.com/Advanced-Lighting/Normal-Mapping
  tangent = normalize(tangent - dot(tangent, normal) * normal);

  vec3 binormal = cross(normal, tangent) * a_tangent.w;

  if (u_hasBones) {
    #ifdef SKIN
      transformSkin(position, normal, tangent, binormal);
    #else
      transformVertexGroupsHD(position, normal, tangent, binormal);
    #endif
  }

  vec3 position_mv = vec3(u_MV * vec4(position, 1));

  mat3 mv = mat3(u_MV);
  vec3 t = normalize(mv * tangent);
  vec3 b = normalize(mv * binormal);
  vec3 n = normalize(mv * normal);

  v_eyeVec = normalize(u_eyePos - position_mv);

  vec3 lightDir = normalize(u_lightPos - position_mv);
  v_lightDir = normalize(TBN(lightDir, t, b, n));
  
  v_uv = a_uv;
  v_layerAlpha = u_layerAlpha;

  v_normal = normal;
  // v_lightDirWorld = normalize(lightDir);

  #if defined(ONLY_TANGENTS)
  v_tangent = tangent;
  #endif

  gl_Position = u_VP * vec4(position, 1.0);
}
`,fe=`
${Ye}

uniform sampler2D u_diffuseMap;
uniform sampler2D u_normalsMap;
uniform sampler2D u_ormMap;
uniform sampler2D u_emissiveMap;
uniform sampler2D u_teamColorMap;
uniform sampler2D u_environmentMap;
uniform float u_filterMode;

// uniform sampler2D u_lutMap;
// uniform sampler2D u_envDiffuseMap;
// uniform sampler2D u_envSpecularMap;

varying vec2 v_uv;
varying float v_layerAlpha;
varying vec3 v_lightDir;
varying vec3 v_eyeVec;
varying vec3 v_normal;
// varying vec3 v_lightDirWorld;

#if defined(ONLY_TANGENTS)
varying vec3 v_tangent;
#endif

vec3 decodeNormal() {
  vec2 xy = texture2D(u_normalsMap, v_uv).xy * 2.0 - 1.0;
  
  return vec3(xy, sqrt(1.0 - dot(xy, xy)));
}

const vec2 invAtan = vec2(0.1591, 0.3183);
vec2 sampleEnvironmentMap(vec3 normal) {
  vec2 uv = vec2(atan(normal.x, normal.y), -asin(normal.z));
  uv *= invAtan;
  uv += 0.5;
  return uv;
}

vec4 getDiffuseColor() {
  vec4 color = texture2D(u_diffuseMap, v_uv);

  // 1bit Alpha
  if (u_filterMode == 1.0 && color.a < 0.75) {
    discard;
  }

  return color;
}

vec4 getOrmColor() {
  return texture2D(u_ormMap, v_uv);
}

vec3 getEmissiveColor() {
  return texture2D(u_emissiveMap, v_uv).rgb;
}

vec3 getTeamColor() {
  return texture2D(u_teamColorMap, v_uv).rgb;
}

// const float PI = 3.14159265359;
// const float RECIPROCAL_PI = 0.31830988618;
// const float RECIPROCAL_PI2 = 0.15915494;
// const float LN2 = 0.6931472;
// const float ENV_LODS = 6.0;
// vec4 SRGBtoLinear(vec4 srgb) {
//     vec3 linOut = pow(srgb.xyz, vec3(2.2));
//     return vec4(linOut, srgb.w);;
// }
// vec4 RGBMToLinear(in vec4 value) {
//     float maxRange = 6.0;
//     return vec4(value.xyz * value.w * maxRange, 1.0);
// }
// vec3 linearToSRGB(vec3 color) {
//     return pow(color, vec3(1.0 / 2.2));
// }
// // vec3 getNormal() {
// //     vec3 pos_dx = dFdx(vMPos.xyz);
// //     vec3 pos_dy = dFdy(vMPos.xyz);
// //     vec2 tex_dx = dFdx(vUv);
// //     vec2 tex_dy = dFdy(vUv);
// //     vec3 t = normalize(pos_dx * tex_dy.t - pos_dy * tex_dx.t);
// //     vec3 b = normalize(-pos_dx * tex_dy.s + pos_dy * tex_dx.s);
// //     mat3 tbn = mat3(t, b, normalize(vNormal));
// //     vec3 n = texture2D(tNormal, vUv * uNormalUVScale).rgb * 2.0 - 1.0;
// //     n.xy *= uNormalScale;
// //     vec3 normal = normalize(tbn * n);
// //     // Get world normal from view normal (normalMatrix * normal)
// //     return normalize((vec4(normal, 0.0) * viewMatrix).xyz);
// // }
// vec3 specularReflection(vec3 specularEnvR0, vec3 specularEnvR90, float VdH) {
//     return specularEnvR0 + (specularEnvR90 - specularEnvR0) * pow(clamp(1.0 - VdH, 0.0, 1.0), 5.0);
// }
// float geometricOcclusion(float NdL, float NdV, float roughness) {
//     float r = roughness;
//     float attenuationL = 2.0 * NdL / (NdL + sqrt(r * r + (1.0 - r * r) * (NdL * NdL)));
//     float attenuationV = 2.0 * NdV / (NdV + sqrt(r * r + (1.0 - r * r) * (NdV * NdV)));
//     return attenuationL * attenuationV;
// }
// float microfacetDistribution(float roughness, float NdH) {
//     float roughnessSq = roughness * roughness;
//     float f = (NdH * roughnessSq - NdH) * NdH + 1.0;
//     return roughnessSq / (PI * f * f);
// }
// vec2 cartesianToPolar(vec3 n) {
//     vec2 uv;
//     uv.x = atan(n.z, n.x) * RECIPROCAL_PI2 + 0.5;
//     uv.y = asin(n.y) * RECIPROCAL_PI + 0.5;
//     return uv;
// }
// void getIBLContribution(inout vec3 diffuse, inout vec3 specular, float NdV, float roughness, vec3 n, vec3 reflection, vec3 diffuseColor, vec3 specularColor) {
//   vec3 brdf = SRGBtoLinear(texture2D(u_lutMap, vec2(NdV, roughness))).rgb;
//   vec3 diffuseLight = RGBMToLinear(texture2D(u_envDiffuseMap, sampleEnvironmentMap(n))).rgb;
//   // Sample 2 levels and mix between to get smoother degradation
//   float blend = roughness * ENV_LODS;
//   float level0 = floor(blend);
//   float level1 = min(ENV_LODS, level0 + 1.0);
//   blend -= level0;
  
//   // Sample the specular env map atlas depending on the roughness value
//   vec2 uvSpec = sampleEnvironmentMap(reflection);
//   uvSpec.y /= 2.0;
//   vec2 uv0 = uvSpec;
//   vec2 uv1 = uvSpec;
//   uv0 /= pow(2.0, level0);
//   uv0.y += 1.0 - exp(-LN2 * level0);
//   uv1 /= pow(2.0, level1);
//   uv1.y += 1.0 - exp(-LN2 * level1);
//   vec3 specular0 = RGBMToLinear(texture2D(u_envSpecularMap, uv0)).rgb;
//   vec3 specular1 = RGBMToLinear(texture2D(u_envSpecularMap, uv1)).rgb;
//   vec3 specularLight = mix(specular0, specular1, blend);
//   diffuse = diffuseLight * diffuseColor;
  
//   // Bit of extra reflection for smooth materials
//   float reflectivity = pow((1.0 - roughness), 2.0) * 0.05;
//   specular = specularLight * (specularColor * brdf.x + brdf.y + reflectivity);
//   // specular *= uEnvSpecular;
// }

// void PBR() {
//   vec4 baseDiffuseColor = getDiffuseColor();
//   vec3 baseColor = baseDiffuseColor.rgb;
//   vec4 orm = getOrmColor();
//   vec3 tc = getTeamColor();
//   float tcFactor = getOrmColor().a;

//   if (tcFactor > 0.1) {
//     baseColor *= tc * tcFactor;
//   }

//   float roughness = clamp(orm.g, 0.04, 1.0);
//   float metallic = clamp(orm.b, 0.04, 1.0);

//   vec3 f0 = vec3(0.04);
//   vec3 diffuseColor = baseColor * (vec3(1.0) - f0) * (1.0 - metallic);
//   vec3 specularColor = mix(f0, baseColor, metallic);
//   vec3 specularEnvR0 = specularColor;
//   vec3 specularEnvR90 = vec3(clamp(max(max(specularColor.r, specularColor.g), specularColor.b) * 25.0, 0.0, 1.0));

//   vec3 N = v_normal;
//   vec3 V = normalize(v_eyeVec);
//   vec3 L = normalize(v_lightDirWorld);
//   vec3 H = normalize(L + V);
//   vec3 reflection = normalize(reflect(-V, N));

//   float NdL = clamp(dot(N, L), 0.001, 1.0);
//   float NdV = clamp(abs(dot(N, V)), 0.001, 1.0);
//   float NdH = clamp(dot(N, H), 0.0, 1.0);
//   float LdH = clamp(dot(L, H), 0.0, 1.0);
//   float VdH = clamp(dot(V, H), 0.0, 1.0);

//   vec3 F = specularReflection(specularEnvR0, specularEnvR90, VdH);
//   float G = geometricOcclusion(NdL, NdV, roughness);
//   float D = microfacetDistribution(roughness, NdH);

//   vec3 diffuseContrib = (1.0 - F) * (diffuseColor / PI);
//   vec3 specContrib = F * G * D / (4.0 * NdL * NdV);
  
//   // Shading based off lights
//   // vec3 color = NdL * uLightColor * (diffuseContrib + specContrib);
//   vec3 color = NdL * (diffuseContrib + specContrib);

//   // Calculate IBL lighting
//   vec3 diffuseIBL;
//   vec3 specularIBL;
//   getIBLContribution(diffuseIBL, specularIBL, NdV, roughness, N, reflection, diffuseColor, specularColor);

//   // Add IBL on top of color
//   color +=  specularIBL;

//   color *= orm.r;

//   color += getEmissiveColor();

//   // Convert to sRGB to display
//   gl_FragColor.rgb = color;
//   gl_FragColor.a = baseDiffuseColor.a;
// }

void onlyDiffuse() {
  vec4 baseColor = getDiffuseColor();
  vec3 tc = getTeamColor();
  float tcFactor = getOrmColor().a;

  if (tcFactor > 0.1) {
    baseColor.rgb *= tc * tcFactor;
  }

  gl_FragColor = baseColor;
}

void onlyNormalMap() {
  gl_FragColor = vec4(decodeNormal(), 1.0);
}

void onlyOcclusion() {
  gl_FragColor = vec4(getOrmColor().rrr, 1.0);
}

void onlyRoughness() {
  gl_FragColor = vec4(getOrmColor().ggg, 1.0);
}

void onlyMetallic() {
  gl_FragColor = vec4(getOrmColor().bbb, 1.0);
}

void onlyTeamColorFactor() {
  gl_FragColor = vec4(getOrmColor().aaa, 1.0);
}

void onlyEmissiveMap() {
  gl_FragColor = vec4(getEmissiveColor(), 1.0);
}

void onlyTexCoords() {
  gl_FragColor = vec4(v_uv, 0.0, 1.0);
}

void onlyNormals() {
  gl_FragColor = vec4(v_normal, 1.0);
}

#if defined(ONLY_TANGENTS)
void onlyTangents() {
  gl_FragColor = vec4(v_tangent, 1.0);
}
#endif

void lambert() {
  vec4 baseColor = getDiffuseColor();
  vec3 normal = decodeNormal();
  vec4 orm = getOrmColor();
  vec3 emissive = getEmissiveColor();
  vec3 tc = getTeamColor();
  float aoFactor = orm.r;
  float tcFactor = orm.a;
  float lambertFactor = clamp(dot(normal, v_lightDir), 0.0, 1.0);
  vec3 color = baseColor.rgb;

  if (tcFactor > 0.1) {
    color *= tc * tcFactor;
  }
  
  color *= clamp(lambertFactor * aoFactor + 0.1, 0.0, 1.0);
  color += emissive;

  gl_FragColor = vec4(color, baseColor.a);
}

void main() {
  #if defined(ONLY_DIFFUSE)
  onlyDiffuse();
  #elif defined(ONLY_NORMAL_MAP)
  onlyNormalMap();
  #elif defined(ONLY_OCCLUSION)
  onlyOcclusion();
  #elif defined(ONLY_ROUGHNESS)
  onlyRoughness();
  #elif defined(ONLY_METALLIC)
  onlyMetallic();
  #elif defined(ONLY_TC_FACTOR)
  onlyTeamColorFactor();
  #elif defined(ONLY_EMISSIVE)
  onlyEmissiveMap();
  #elif defined(ONLY_TEXCOORDS)
  onlyTexCoords();
  #elif defined(ONLY_NORMALS)
  onlyNormals();
  #elif defined(ONLY_TANGENTS)
  onlyTangents();
  #else
  lambert();
  #endif
}
`,aa=`
#define EMITTER_PARTICLE2 0
#define EMITTER_RIBBON 1
#define EMITTER_SPLAT 2
#define EMITTER_UBERSPLAT 3
#define HEAD 0.0

uniform mat4 u_VP;
uniform int u_emitter;

// Shared
uniform vec4 u_colors[3];
uniform vec3 u_vertices[4];
uniform vec3 u_intervals[4];
uniform float u_lifeSpan;
uniform float u_columns;
uniform float u_rows;

// Particle2
uniform vec3 u_scaling;
uniform vec3 u_cameraZ;
uniform float u_timeMiddle;
uniform bool u_teamColored;

// Splat and Uber.
uniform vec3 u_intervalTimes;

// Vertices
attribute float a_position;

// Instances
attribute vec3 a_p0;
attribute vec3 a_p1;
attribute vec3 a_p2;
attribute vec3 a_p3;
attribute float a_health;
attribute vec4 a_color;
attribute float a_tail;
attribute vec3 a_leftRightTop;

varying vec2 v_texcoord;
varying vec4 v_color;

float getCell(vec3 interval, float factor) {
  float start = interval[0];
  float end = interval[1];
  float repeat = interval[2];
  float spriteCount = end - start;

  if (spriteCount > 0.0) {
    // Repeating speeds up the sprite animation, which makes it effectively run N times in its interval.
    // E.g. if repeat is 4, the sprite animation will be seen 4 times, and thus also run 4 times as fast.
    // The sprite index is limited to the number of actual sprites.
    return min(start + mod(floor(spriteCount * repeat * factor), spriteCount), u_columns * u_rows - 1.0);
  }

  return start;
}

void particle2() {
  float factor = (u_lifeSpan - a_health) / u_lifeSpan;
  int index = 0;

  if (factor < u_timeMiddle) {
    factor = factor / u_timeMiddle;
    index = 0;
  } else {
    factor = (factor - u_timeMiddle) / (1.0 - u_timeMiddle);
    index = 1;
  }

  factor = min(factor, 1.0);

  float scale = mix(u_scaling[index], u_scaling[index + 1], factor);
  vec4 color = mix(u_colors[index], u_colors[index + 1], factor);

  float cell = 0.0;

  if (u_teamColored) {
    cell = a_leftRightTop[0];
  } else {
    vec3 interval;

    if (a_tail == HEAD) {
      interval = u_intervals[index];
    } else {
      interval = u_intervals[index + 2];
    }

    cell = getCell(interval, factor);
  }

  float left = floor(mod(cell, u_columns));
  float top = floor(cell / u_columns);
  float right = left + 1.0;
  float bottom = top + 1.0;

  left /= u_columns;
  right /= u_columns;
  top /= u_rows;
  bottom /= u_rows;

  if (a_position == 0.0) {
    v_texcoord = vec2(right, top);
  } else if (a_position == 1.0) {
    v_texcoord = vec2(left, top);
  } else if (a_position == 2.0) {
    v_texcoord = vec2(left, bottom);
  } else if (a_position == 3.0) {
    v_texcoord = vec2(right, bottom);
  }

  v_color = color;
  
  if (a_tail == HEAD) {
    vec3 v = u_vertices[int(a_position)];
    float cs = cos(a_p1.x);
    float sn = sin(a_p1.x);

    float x = v.x * cs - v.y * sn;
    float y = v.x * sn + v.y * cs;

    vec3 fv = vec3(
      v.x * cs - v.y * sn,
      v.x * sn + v.y * cs,
      v.z);

    gl_Position = u_VP * vec4(a_p0 + fv * scale, 1.0);
  } else {
    // Get the normal to the tail in camera space.
    // This allows to build a 2D rectangle around the 3D tail.
    vec3 normal = cross(u_cameraZ, normalize(a_p1 - a_p0));
    vec3 boundary = normal * scale * a_p2[0];
    vec3 position;

    if (a_position == 0.0) {
      position = a_p0 - boundary;
    } else if (a_position == 1.0) {
      position = a_p1 - boundary;
    } else if (a_position == 2.0) {
      position = a_p1 + boundary;
    } else if (a_position == 3.0) {
      position = a_p0 + boundary;
    }

    gl_Position = u_VP * vec4(position, 1.0);
  }
}

void ribbon() {
  vec3 position;
  float left = a_leftRightTop[0] / 255.0;
  float right = a_leftRightTop[1] / 255.0;
  float top = a_leftRightTop[2] / 255.0;
  float bottom = top + 1.0;

  if (a_position == 0.0) {
    v_texcoord = vec2(right, top);
    position = a_p0;
  } else if (a_position == 1.0) {
    v_texcoord = vec2(right, bottom);
    position = a_p1;
  } else if (a_position == 2.0) {
    v_texcoord = vec2(left, bottom);
    position = a_p2;
  } else if (a_position == 3.0) {
    v_texcoord = vec2(left, top);
    position = a_p3;
  }

  v_texcoord[0] /= u_columns;
  v_texcoord[1] /= u_rows;

  v_color = a_color;

  gl_Position = u_VP * vec4(position, 1.0);
}

void splat() {
  float factor = u_lifeSpan - a_health;
  int index;

  if (factor < u_intervalTimes[0]) {
    factor = factor / u_intervalTimes[0];
    index = 0;
  } else {
    factor = (factor - u_intervalTimes[0]) / u_intervalTimes[1];
    index = 1;
  }

  float cell = getCell(u_intervals[index], factor);
  float left = floor(mod(cell, u_columns));
  float top = floor(cell / u_columns);
  float right = left + 1.0;
  float bottom = top + 1.0;
  vec3 position;

  if (a_position == 0.0) {
    v_texcoord = vec2(left, top);
    position = a_p0;
  } else if (a_position == 1.0) {
    v_texcoord = vec2(left, bottom);
    position = a_p1;
  } else if (a_position == 2.0) {
    v_texcoord = vec2(right, bottom);
    position = a_p2;
  } else if (a_position == 3.0) {
    v_texcoord = vec2(right, top);
    position = a_p3;
  }

  v_texcoord[0] /= u_columns;
  v_texcoord[1] /= u_rows;

  v_color = mix(u_colors[index], u_colors[index + 1], factor) / 255.0;

  gl_Position = u_VP * vec4(position, 1.0);
}

void ubersplat() {
  float factor = u_lifeSpan - a_health;
  vec4 color;

  if (factor < u_intervalTimes[0]) {
    color = mix(u_colors[0], u_colors[1], factor / u_intervalTimes[0]);
  } else if (factor < u_intervalTimes[0] + u_intervalTimes[1]) {
    color = u_colors[1];
  } else {
    color = mix(u_colors[1], u_colors[2], (factor - u_intervalTimes[0] - u_intervalTimes[1]) / u_intervalTimes[2]);
  }

  vec3 position;

  if (a_position == 0.0) {
    v_texcoord = vec2(0.0, 0.0);
    position = a_p0;
  } else if (a_position == 1.0) {
    v_texcoord = vec2(0.0, 1.0);
    position = a_p1;
  } else if (a_position == 2.0) {
    v_texcoord = vec2(1.0, 1.0);
    position = a_p2;
  } else if (a_position == 3.0) {
    v_texcoord = vec2(1.0, 0.0);
    position = a_p3;
  }

  v_color = color / 255.0;

  gl_Position = u_VP * vec4(position, 1.0);
}

void main() {
  if (u_emitter == EMITTER_PARTICLE2) {
    particle2();
  } else if (u_emitter == EMITTER_RIBBON) {
    ribbon();
  } else if (u_emitter == EMITTER_SPLAT) {
    splat();
  } else if (u_emitter == EMITTER_UBERSPLAT) {
    ubersplat();
  }
}
`,la=`
${Ye}

#define EMITTER_PARTICLE2 0
#define EMITTER_RIBBON 1

uniform sampler2D u_texture;
uniform highp int u_emitter;
uniform float u_filterMode;

varying vec2 v_texcoord;
varying vec4 v_color;

void main() {
  vec4 texel = texture2D(u_texture, v_texcoord);
  vec4 color = texel * v_color;

  // 1bit Alpha, used by ribbon emitters.
  if (u_emitter == EMITTER_RIBBON && u_filterMode == 1.0 && color.a < 0.75) {
    discard;
  }

  // "Close to 0 alpha"
  if (u_emitter == EMITTER_PARTICLE2 && (u_filterMode == 2.0 || u_filterMode == 3.0) && color.a < 0.02) {
    discard;
  }

  // Alpha key.
  if (u_emitter == EMITTER_PARTICLE2 && (u_filterMode == 4.0) && color.a < 0.75) {
    discard;
  }

  gl_FragColor = color;
}
`,ca=r=>new xe(r),ha=r=>Mr(r),Bt={load(r,e,t=!1){const i=r.gl,n=r.webgl;if(!n.ensureExtension("OES_texture_float"))throw new Error("MDX: No float texture support!");if(!n.ensureExtension("ANGLE_instanced_arrays"))throw new Error("MDX: No instanced rendering support!");const s=`#define EXTENDED_BONES
`+Xe,o=`#define ONLY_DIFFUSE
`+We,a=`#define ONLY_TEXCOORDS
`+We,l=`#define ONLY_NORMALS
`+We,c=`#define EXTENDED_BONES
`+de,d=`#define SKIN
`+de,h=`#define ONLY_DIFFUSE
`+fe,u=`#define ONLY_NORMAL_MAP
`+fe,p=`#define ONLY_OCCLUSION
`+fe,g=`#define ONLY_ROUGHNESS
`+fe,v=`#define ONLY_METALLIC
`+fe,b=`#define ONLY_TC_FACTOR
`+fe,w=`#define ONLY_EMISSIVE
`+fe,m=`#define ONLY_TEXCOORDS
`+fe,E=`#define ONLY_NORMALS
`+fe,x=`#define ONLY_TANGENTS
`+fe,y=n.createShader(Xe,We),A=n.createShader(s,We),U=`#define SKIN
`+Xe,G=n.createShader(U,We),T=n.createShader(de,fe),H=n.createShader(c,fe),re=n.createShader(d,fe),k=n.createShader(aa,la),z=[],B=[];let _=[];_[D.Diffuse]=n.createShader(Xe,o),_[D.TexCoords]=n.createShader(Xe,a),_[D.Normals]=n.createShader(Xe,l),z[ee.VertexGroups]=_,_=[],_[D.Diffuse]=n.createShader(s,o),_[D.TexCoords]=n.createShader(s,a),_[D.Normals]=n.createShader(s,l),z[ee.ExtendedVertexGroups]=_,_=[],_[D.Diffuse]=n.createShader(de,h),_[D.NormalMap]=n.createShader(de,u),_[D.Occlusion]=n.createShader(de,p),_[D.Roughness]=n.createShader(de,g),_[D.Metallic]=n.createShader(de,v),_[D.TCFactor]=n.createShader(de,b),_[D.Emissive]=n.createShader(de,w),_[D.TexCoords]=n.createShader(de,m),_[D.Normals]=n.createShader(de,E),_[D.Tangents]=n.createShader(`#define ONLY_TANGENTS
`+de,x),B[ee.VertexGroups]=_,_=[],_[D.Diffuse]=n.createShader(c,h),_[D.NormalMap]=n.createShader(c,u),_[D.Occlusion]=n.createShader(c,p),_[D.Roughness]=n.createShader(c,g),_[D.Metallic]=n.createShader(c,v),_[D.TCFactor]=n.createShader(c,b),_[D.Emissive]=n.createShader(c,w),_[D.TexCoords]=n.createShader(c,m),_[D.Normals]=n.createShader(c,E),_[D.Tangents]=n.createShader(`#define ONLY_TANGENTS
`+c,x),B[ee.ExtendedVertexGroups]=_,_=[],_[D.Diffuse]=n.createShader(d,h),_[D.NormalMap]=n.createShader(d,u),_[D.Occlusion]=n.createShader(d,p),_[D.Roughness]=n.createShader(d,g),_[D.Metallic]=n.createShader(d,v),_[D.TCFactor]=n.createShader(d,b),_[D.Emissive]=n.createShader(d,w),_[D.TexCoords]=n.createShader(d,m),_[D.Normals]=n.createShader(d,E),_[D.Tangents]=n.createShader(`#define ONLY_TANGENTS
`+d,x),B[ee.Skin]=_;const N=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,N),i.bufferData(i.ARRAY_BUFFER,new Uint8Array([0,1,2,0,2,3]),i.STATIC_DRAW);const C={pathSolver:e,reforged:t,sdShader:y,sdSkinShader:G,sdExtendedShader:A,hdShader:T,hdExtendedShader:H,hdSkinShader:re,particlesShader:k,sdDebugShaders:z,hdDebugShaders:B,rectBuffer:N,teamColors:[],teamGlows:[],eventObjectTables:{}};r.sharedCache.set("mdx",C)},isValidSource(r){return r instanceof yt?!0:Cn(r)||Ln(r)},resource:oa,loadTeamTextures(r){const{pathSolver:e,reforged:t,teamColors:i,teamGlows:n}=r.sharedCache.get("mdx");if(i.length===0){const s=t?28:16,o=t?"dds":"blp",a=t?{reforged:!0}:void 0;for(let l=0;l<s;l++){const d=`${`${l}`.padStart(2,"0")}.${o}`,h=new lt(1,De.WrapBoth),u=new lt(2,De.WrapBoth);r.load(`ReplaceableTextures\\TeamColor\\TeamColor${d}`,e,a).then(p=>h.texture=p),r.load(`ReplaceableTextures\\TeamGlow\\TeamGlow${d}`,e,a).then(p=>u.texture=p),i[l]=h,n[l]=u}}},getEventObjectSoundFile(r,e,t,i){if(!e||Ii(r)===".flac")return r;for(let n=1,s=i.length;n<s;n++){const o=i[n].data.getRow(r);if(o){const a=o.string("Flags"),l=o.string("Filepath");if(a==="SD_ONLY"){if(!t)return l}else if(a==="HD_ONLY"){if(t)return l}else return l}}},async getEventObjectData(r,e,t,i){if(e!=="SPN"&&e!=="SPL"&&e!=="UBR"&&e!=="SND")return;const{pathSolver:n,reforged:s,eventObjectTables:o}=r.sharedCache.get("mdx"),a=s?{reforged:!0}:{},l=(p,g)=>n?n(p,g):p;if(!o[e]){const p=[];e==="SPN"?p.push("Splats\\SpawnData.slk"):e==="SPL"?p.push("Splats\\SplatData.slk"):e==="UBR"?p.push("Splats\\UberSplatData.slk"):e==="SND"&&(p.push("UI\\SoundInfo\\AnimSounds.slk"),s?p.push("UI\\SoundInfo\\DialogueHumanBase.slk","UI\\SoundInfo\\DialogueOrcBase.slk","UI\\SoundInfo\\DialogueUndeadBase.slk","UI\\SoundInfo\\DialogueNightElfBase.slk","UI\\SoundInfo\\DialogueNagaBase.slk","UI\\SoundInfo\\DialogueDemonBase.slk","UI\\SoundInfo\\DialogueCreepsBase.slk"):p.push("UI\\SoundInfo\\AnimLookups.slk"));const g=p.map(b=>r.loadGeneric(l(b,a),"text",ca)),v=await Promise.all(g);for(const b of v)if(!b)return;o[e]=v}const c=o[e],d=c[0].data;let h;const u=[];if(e==="SND"){if(s)h=d.findRow("AnimationEventCode",t);else{const p=c[1].data.getRow(t);p&&(h=d.getRow(p.string("SoundLabel")))}if(h)for(const p of h.string("FileNames").split(",")){const g=this.getEventObjectSoundFile(p,s,i,c);g&&u.push(r.loadGeneric(l(g,a),"arrayBuffer",ha))}}else h=d.getRow(t),h&&(e==="SPN"?u.push(r.load(h.string("Model").replace(".mdl",".mdx"),l,a)):(e==="SPL"||e==="UBR")&&u.push(r.load(`ReplaceableTextures\\Splats\\${h.string("file")}${s?".dds":".blp"}`,l,a)));if(h&&u.length){const g=(await Promise.all(u)).filter(v=>v);if(g.length)return{row:h,resources:g}}},getBatchShader(r,e,t){const i=r.sharedCache.get("mdx"),n=r.debugRenderMode;if(t){if(n!==D.None){const s=i.hdDebugShaders[e];if(s){const o=s[n];if(o)return o}}return e===ee.Skin?i.hdSkinShader:e===ee.VertexGroups?i.hdShader:i.hdExtendedShader}else{if(n!==D.None){const s=i.sdDebugShaders[e];if(s){const o=s[n];if(o)return o}}return e===ee.Skin?i.sdSkinShader:e===ee.VertexGroups?i.sdShader:i.sdExtendedShader}}};class da{buffer;uint8array;index=0;byteLength;bitBuffer=0;bits=0;constructor(e,t,i){const n=Ue(e);t=t||0,i=i||n.length,this.buffer=e,this.uint8array=n.subarray(t,t+i),this.byteLength=e.byteLength}peekBits(e){return this.loadBits(e),this.bitBuffer&(1<<e)-1}readBits(e){const t=this.peekBits(e);return this.bitBuffer>>>=e,this.bits-=e,t}skipBits(e){this.loadBits(e),this.bitBuffer>>>=e,this.bits-=e}loadBits(e){for(;this.bits<e;)this.bitBuffer+=this.uint8array[this.index]<<this.bits,this.bits+=8,this.index+=1}}function Ct(r,e){return((1<<e)-1)/((1<<r)-1)}const fa=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(r){return typeof r}:function(r){return r&&typeof Symbol=="function"&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r},Se=(function(){function e(t){this.message="JPEG error: "+t}return e.prototype=new Error,e.prototype.name="JpegError",e.constructor=e,e})(),ct=new Uint8Array([0,1,8,16,9,2,3,10,17,24,32,25,18,11,4,5,12,19,26,33,40,48,41,34,27,20,13,6,7,14,21,28,35,42,49,56,57,50,43,36,29,22,15,23,30,37,44,51,58,59,52,45,38,31,39,46,53,60,61,54,47,55,62,63]),Lt=4017,Rt=799,Ft=3406,Ut=2276,Pt=1567,Dt=3784,Ze=5793,kt=2896;function ua(r,e){let t=0,i=[],n,s,o=16;for(;o>0&&!r[o-1];)o--;i.push({children:[],index:0});let a=i[0],l;for(n=0;n<o;n++){for(s=0;s<r[n];s++){for(a=i.pop(),a.children[a.index]=e[t];a.index>0;)a=i.pop();for(a.index++,i.push(a);i.length<=n;)i.push(l={children:[],index:0}),a.children[a.index]=l.children,a=l;t++}n+1<o&&(i.push(l={children:[],index:0}),a.children[a.index]=l.children,a=l)}return i[0].children}function Ot(r,e,t){return 64*((r.blocksPerLine+1)*e+t)}function pa(r,e,t,i,n,s,o,a,l){const c=t.mcusPerLine,d=t.progressive;let h=e,u=0,p=0;function g(){if(p>0)return p--,u>>p&1;if(u=r[e++],u===255){const S=r[e++];if(S)throw new Se("unexpected marker "+(u<<8|S).toString(16))}return p=7,u>>>7}function v(S){let L=S;for(;;){if(L=L[g()],typeof L=="number")return L;if((typeof L>"u"?"undefined":fa(L))!=="object")throw new Se("invalid huffman sequence")}}function b(S){let L=0;for(;S>0;)L=L<<1|g(),S--;return L}function w(S){if(S===1)return g()===1?1:-1;const L=b(S);return L>=1<<S-1?L:L+(-1<<S)+1}function m(S,L){const V=v(S.huffmanTableDC),te=V===0?0:w(V);S.blockData[L]=S.pred+=te;let X=1;for(;X<64;){const oe=v(S.huffmanTableAC),ce=oe&15,ae=oe>>4;if(ce===0){if(ae<15)break;X+=16;continue}X+=ae;const pt=ct[X];S.blockData[L+pt]=w(ce),X++}}function E(S,L){const V=v(S.huffmanTableDC),te=V===0?0:w(V)<<l;S.blockData[L]=S.pred+=te}function x(S,L){S.blockData[L]|=g()<<l}let y=0;function A(S,L){if(y>0){y--;return}let V=s,te=o;for(;V<=te;){const X=v(S.huffmanTableAC),oe=X&15,ce=X>>4;if(oe===0){if(ce<15){y=b(ce)+(1<<ce)-1;break}V+=16;continue}V+=ce;const ae=ct[V];S.blockData[L+ae]=w(oe)*(1<<l),V++}}let U=0,G;function T(S,L){let V=s;const te=o;let X=0,oe,ce;for(;V<=te;){const ae=ct[V];switch(U){case 0:if(ce=v(S.huffmanTableAC),oe=ce&15,X=ce>>4,oe===0)X<15?(y=b(X)+(1<<X),U=4):(X=16,U=1);else{if(oe!==1)throw new Se("invalid ACn encoding");G=w(oe),U=X?2:3}continue;case 1:case 2:S.blockData[L+ae]?S.blockData[L+ae]+=g()<<l:(X--,X===0&&(U=U===2?3:0));break;case 3:S.blockData[L+ae]?S.blockData[L+ae]+=g()<<l:(S.blockData[L+ae]=G<<l,U=0);break;case 4:S.blockData[L+ae]&&(S.blockData[L+ae]+=g()<<l);break}V++}U===4&&(y--,y===0&&(U=0))}function H(S,L,V,te,X){const oe=V/c|0,ce=V%c,ae=oe*S.v+te,pt=ce*S.h+X,Sc=Ot(S,ae,pt);L(S,Sc)}function re(S,L,V){const te=V/S.blocksPerLine|0,X=V%S.blocksPerLine,oe=Ot(S,te,X);L(S,oe)}const k=i.length;let z,B,_,N,C,F;d?s===0?F=a===0?E:x:F=a===0?A:T:F=m;let O=0,P,K;k===1?K=i[0].blocksPerLine*i[0].blocksPerColumn:K=c*t.mcusPerColumn;let W,$;for(;O<K;){const S=n?Math.min(K-O,n):K;for(B=0;B<k;B++)i[B].pred=0;if(y=0,k===1)for(z=i[0],C=0;C<S;C++)re(z,F,O),O++;else for(C=0;C<S;C++){for(B=0;B<k;B++)for(z=i[B],W=z.h,$=z.v,_=0;_<$;_++)for(N=0;N<W;N++)H(z,F,O,_,N);O++}p=0,P=fi(r,e),P&&P.invalid&&(e=P.offset);const L=P&&P.marker;if(!L||L<=65280)throw new Se("marker was not found");if(L>=65488&&L<=65495)e+=2;else break}return P=fi(r,e),P&&P.invalid&&(e=P.offset),e-h}function ga(r,e,t){const i=r.quantizationTable,n=r.blockData;let s,o,a,l,c,d,h,u,p,g,v,b,w,m,E,x,y;if(!i)throw new Se("missing required Quantization Table.");for(let A=0;A<64;A+=8){if(p=n[e+A],g=n[e+A+1],v=n[e+A+2],b=n[e+A+3],w=n[e+A+4],m=n[e+A+5],E=n[e+A+6],x=n[e+A+7],p*=i[A],(g|v|b|w|m|E|x)===0){y=Ze*p+512>>10,t[A]=y,t[A+1]=y,t[A+2]=y,t[A+3]=y,t[A+4]=y,t[A+5]=y,t[A+6]=y,t[A+7]=y;continue}g*=i[A+1],v*=i[A+2],b*=i[A+3],w*=i[A+4],m*=i[A+5],E*=i[A+6],x*=i[A+7],s=Ze*p+128>>8,o=Ze*w+128>>8,a=v,l=E,c=kt*(g-x)+128>>8,u=kt*(g+x)+128>>8,d=b<<4,h=m<<4,s=s+o+1>>1,o=s-o,y=a*Dt+l*Pt+128>>8,a=a*Pt-l*Dt+128>>8,l=y,c=c+h+1>>1,h=c-h,u=u+d+1>>1,d=u-d,s=s+l+1>>1,l=s-l,o=o+a+1>>1,a=o-a,y=c*Ut+u*Ft+2048>>12,c=c*Ft-u*Ut+2048>>12,u=y,y=d*Rt+h*Lt+2048>>12,d=d*Lt-h*Rt+2048>>12,h=y,t[A]=s+u,t[A+7]=s-u,t[A+1]=o+h,t[A+6]=o-h,t[A+2]=a+d,t[A+5]=a-d,t[A+3]=l+c,t[A+4]=l-c}for(let A=0;A<8;++A){if(p=t[A],g=t[A+8],v=t[A+16],b=t[A+24],w=t[A+32],m=t[A+40],E=t[A+48],x=t[A+56],(g|v|b|w|m|E|x)===0){y=Ze*p+8192>>14,y=y<-2040?0:y>=2024?255:y+2056>>4,n[e+A]=y,n[e+A+8]=y,n[e+A+16]=y,n[e+A+24]=y,n[e+A+32]=y,n[e+A+40]=y,n[e+A+48]=y,n[e+A+56]=y;continue}s=Ze*p+2048>>12,o=Ze*w+2048>>12,a=v,l=E,c=kt*(g-x)+2048>>12,u=kt*(g+x)+2048>>12,d=b,h=m,s=(s+o+1>>1)+4112,o=s-o,y=a*Dt+l*Pt+2048>>12,a=a*Pt-l*Dt+2048>>12,l=y,c=c+h+1>>1,h=c-h,u=u+d+1>>1,d=u-d,s=s+l+1>>1,l=s-l,o=o+a+1>>1,a=o-a,y=c*Ut+u*Ft+2048>>12,c=c*Ft-u*Ut+2048>>12,u=y,y=d*Rt+h*Lt+2048>>12,d=d*Lt-h*Rt+2048>>12,h=y,p=s+u,x=s-u,g=o+h,E=o-h,v=a+d,m=a-d,b=l+c,w=l-c,p=p<16?0:p>=4080?255:p>>4,g=g<16?0:g>=4080?255:g>>4,v=v<16?0:v>=4080?255:v>>4,b=b<16?0:b>=4080?255:b>>4,w=w<16?0:w>=4080?255:w>>4,m=m<16?0:m>=4080?255:m>>4,E=E<16?0:E>=4080?255:E>>4,x=x<16?0:x>=4080?255:x>>4,n[e+A]=p,n[e+A+8]=g,n[e+A+16]=v,n[e+A+24]=b,n[e+A+32]=w,n[e+A+40]=m,n[e+A+48]=E,n[e+A+56]=x}}function va(r,e){const t=e.blocksPerLine,i=e.blocksPerColumn,n=new Int16Array(64);for(let s=0;s<i;s++)for(let o=0;o<t;o++){const a=Ot(e,s,o);ga(e,a,n)}return e.blockData}function fi(r,e,t){function i(l){return r[l]<<8|r[l+1]}const n=r.length-1;let s=t<e?t:e;if(e>=n)return null;const o=i(e);if(o>=65472&&o<=65534)return{invalid:null,marker:o,offset:e};let a=i(s);for(;!(a>=65472&&a<=65534);){if(++s>=n)return null;a=i(s)}return{invalid:o.toString(16),marker:a,offset:s}}class wa{constructor(){this.decodeTransform=null,this.colorTransform=-1,this.width=0,this.height=0}parse(e){function t(){const C=e[s]<<8|e[s+1];return s+=2,C}function i(){const C=t();let F=s+C-2;const O=fi(e,F,s);O&&O.invalid&&(F=O.offset);const P=e.subarray(s,F);return s+=P.length,P}function n(C){const F=Math.ceil(C.samplesPerLine/8/C.maxH),O=Math.ceil(C.scanLines/8/C.maxV);for(let P=0;P<C.components.length;P++){k=C.components[P];const K=Math.ceil(Math.ceil(C.samplesPerLine/8)*k.h/C.maxH),W=Math.ceil(Math.ceil(C.scanLines/8)*k.v/C.maxV),$=F*k.h,L=64*(O*k.v)*($+1);k.blockData=new Int16Array(L),k.blocksPerLine=K,k.blocksPerColumn=W}C.mcusPerLine=F,C.mcusPerColumn=O}var s=0;let o=null,a=null,l,c;const d=[],h=[],u=[];let p=t();if(p!==65496)throw new Se("SOI not found");for(p=t();p!==65497;){var g,v,b;switch(p){case 65504:case 65505:case 65506:case 65507:case 65508:case 65509:case 65510:case 65511:case 65512:case 65513:case 65514:case 65515:case 65516:case 65517:case 65518:case 65519:case 65534:var w=i();p===65504&&w[0]===74&&w[1]===70&&w[2]===73&&w[3]===70&&w[4]===0&&(o={version:{major:w[5],minor:w[6]},densityUnits:w[7],xDensity:w[8]<<8|w[9],yDensity:w[10]<<8|w[11],thumbWidth:w[12],thumbHeight:w[13],thumbData:w.subarray(14,14+3*w[12]*w[13])}),p===65518&&w[0]===65&&w[1]===100&&w[2]===111&&w[3]===98&&w[4]===101&&(a={version:w[5]<<8|w[6],flags0:w[7]<<8|w[8],flags1:w[9]<<8|w[10],transformCode:w[11]});break;case 65499:for(var m=t(),E=m+s-2,x;s<E;){const C=e[s++],F=new Uint16Array(64);if(C>>4===0)for(v=0;v<64;v++)x=ct[v],F[x]=e[s++];else if(C>>4===1)for(v=0;v<64;v++)x=ct[v],F[x]=t();else throw new Se("DQT - invalid table spec");d[C&15]=F}break;case 65472:case 65473:case 65474:if(l)throw new Se("Only single frame JPEGs supported");t(),l={},l.extended=p===65473,l.progressive=p===65474,l.precision=e[s++],l.scanLines=t(),l.samplesPerLine=t(),l.components=[],l.componentIds={};var y=e[s++],A,U=0,G=0;for(g=0;g<y;g++){A=e[s];const C=e[s+1]>>4,F=e[s+1]&15;U<C&&(U=C),G<F&&(G=F);const O=e[s+2];b=l.components.push({h:C,v:F,quantizationId:O,quantizationTable:null}),l.componentIds[A]=b-1,s+=3}l.maxH=U,l.maxV=G,n(l);break;case 65476:var T=t();for(g=2;g<T;){const C=e[s++],F=new Uint8Array(16);let O=0;for(v=0;v<16;v++,s++)O+=F[v]=e[s];const P=new Uint8Array(O);for(v=0;v<O;v++,s++)P[v]=e[s];g+=17+O,(C>>4===0?u:h)[C&15]=ua(F,P)}break;case 65501:t(),c=t();break;case 65498:t();var H=e[s++],re=[],k;for(g=0;g<H;g++){const C=l.componentIds[e[s++]];k=l.components[C];const F=e[s++];k.huffmanTableDC=u[F>>4],k.huffmanTableAC=h[F&15],re.push(k)}var z=e[s++],B=e[s++],_=e[s++],N=pa(e,s,l,re,c,z,B,_>>4,_&15);s+=N;break;case 65535:e[s]!==255&&s--;break;default:if(e[s-3]===255&&e[s-2]>=192&&e[s-2]<=254){s-=3;break}throw new Se("unknown marker "+p.toString(16))}p=t()}for(this.width=l.samplesPerLine,this.height=l.scanLines,this.jfif=o,this.adobe=a,this.components=[],g=0;g<l.components.length;g++){k=l.components[g];const C=d[k.quantizationId];C&&(k.quantizationTable=C),this.components.push({output:va(l,k),scaleX:k.h/l.maxH,scaleY:k.v/l.maxV,blocksPerLine:k.blocksPerLine,blocksPerColumn:k.blocksPerColumn})}this.numComponents=this.components.length}getData(e){const t=e.data,i=this.components,n=new Uint8Array((i[0].blocksPerLine<<3)*i[0].blocksPerColumn*8);[i[0],i[2]]=[i[2],i[0]];for(let l=0,c=i.length;l<c;l++){const d=i[l],h=d.blocksPerLine,u=d.blocksPerColumn,p=h<<3;var s,o,a=0;for(let v=0;v<u;v++){const b=v<<3;for(let w=0;w<h;w++){const m=Ot(d,v,w);let E=0,x=w<<3;for(s=0;s<8;s++){var a=(b+s)*p;for(o=0;o<8;o++)n[a+x+o]=d.output[m+E++]}}}let g=l;for(let v=0;v<this.height;v++)for(let b=0;b<this.width;b++)t[g]=n[v*p+b],g+=c}return t}}const ba=827345986,ys=0;class ui{content=0;alphaBits=0;width=0;height=0;type=0;hasMipmaps=!1;mipmapOffsets=new Uint32Array(16);mipmapSizes=new Uint32Array(16);uint8array=null;jpgHeader=null;pallete=null;load(e){const t=Ue(e),i=new Int32Array(t.buffer,0,40);if(i[0]!==ba)throw new Error("WrongMagicNumber");this.content=i[1],this.alphaBits=i[2],this.width=i[3],this.height=i[4],this.type=i[5],this.hasMipmaps=i[6]!==0;for(let n=0;n<16;n++)this.mipmapOffsets[n]=i[7+n],this.mipmapSizes[n]=i[23+n];this.uint8array=t,this.content===ys?this.jpgHeader=t.subarray(160,160+i[39]):this.pallete=t.subarray(156,1180)}getMipmap(e){const t=this.uint8array,i=this.mipmapOffsets[e],n=this.mipmapSizes[e];let s;if(this.content===ys){const o=this.jpgHeader,a=new Uint8Array(o.length+n),l=new wa;a.set(o),a.set(t.subarray(i,i+n),o.length),l.parse(a),s=new ImageData(l.width,l.height),l.getData(s)}else{const o=this.pallete,a=Math.max(this.width/(1<<e),1),l=Math.max(this.height/(1<<e),1),c=a*l;let d=this.alphaBits,h,u=0;s=new ImageData(a,l),d>0&&(d>8&&(d=8),h=new da(t.buffer,i+c,Math.ceil(c*d/8)),u=Ct(d,8));const p=s.data;for(let g=0;g<c;g++){const v=g*4,b=t[i+g]*4;p[v]=o[b+2],p[v+1]=o[b+1],p[v+2]=o[b],d>0?p[v+3]=h.readBits(d)*u:p[v+3]=255}}return s}mipmaps(){let e=0;for(const t of this.mipmapSizes)t>0&&(e+=1);return e}fakeMipmaps(){const e=this.mipmapOffsets;let t=0;for(let i=0;i<16;i++){const n=e[i];if(n>0){for(let s=i+1;s<16;s++)if(n===e[s]){t+=1;break}}}return t}}function ma(r){return r instanceof ArrayBuffer&&(r=new Uint8Array(r)),r instanceof Uint8Array&&r[0]===66&&r[1]===76&&r[2]===80&&r[3]===49}class Aa extends vt{constructor(e,t){super(t);let i;e instanceof ui?i=e:(i=new ui,i.load(e));const s=this.viewer.gl,o=s.createTexture();s.bindTexture(s.TEXTURE_2D,o),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.LINEAR);const a=Ge(i.width)&&Ge(i.height);a||(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE));const l=i.mipmaps();if(l===1||i.fakeMipmaps()||!a){const c=i.getMipmap(0);s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,c)}else{s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR_MIPMAP_LINEAR);let c=i.width,d=i.height;for(let h=0;h<l;h++){const u=i.getMipmap(h);s.texImage2D(s.TEXTURE_2D,h,s.RGBA,c,d,0,s.RGBA,s.UNSIGNED_BYTE,u.data),c=Math.ceil(c/2),d=Math.ceil(d/2)}}this.width=i.width,this.height=i.height,this.webglResource=o}}const ya={isValidSource(r){return r instanceof ui?!0:ma(r)},resource:Aa};class pi{width=0;height=0;data=null;load(e){const t=Ue(e),i=new or;i.load(t);const n=i.header;this.width=n.width,this.height=n.height,this.data=new ImageData(n.width,n.height),i.getImageData(this.data)}}function Ta(r){return r instanceof ArrayBuffer&&(r=new Uint8Array(r)),!!(r instanceof Uint8Array&&Vi(r,"TRUEVISION-XFILE.\0",r.length-18))}class xa extends vt{constructor(e,t){super(t);let i;e instanceof pi?i=e:(i=new pi,i.load(e));const n=i.width,s=i.height,o=this.viewer.gl,a=o.createTexture();o.bindTexture(o.TEXTURE_2D,a),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,i.data),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,o.LINEAR),Ge(n)&&Ge(s)?(o.generateMipmap(o.TEXTURE_2D),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.LINEAR_MIPMAP_LINEAR)):o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.LINEAR),this.webglResource=a,this.width=n,this.height=s}}const _a={isValidSource(r){return r instanceof pi?!0:Ta(r)},resource:xa},Ea=Ct(4,8),Re=Ct(5,8),Mt=Ct(6,8),ht=new Uint8Array(16),Fe=new Uint8Array(12),Ts=new Uint8Array(8),xs=new Uint8Array(8),_s=new Uint8Array(8);function Sa(r,e,t){const i=(e>>11&31)*Re,n=(e>>5&63)*Mt,s=(e&31)*Re,o=(t>>11&31)*Re,a=(t>>5&63)*Mt,l=(t&31)*Re;r[0]=i,r[1]=n,r[2]=s,r[3]=255,r[4]=o,r[5]=a,r[6]=l,r[7]=255,e>t?(r[8]=5*i+3*o>>3,r[9]=5*n+3*a>>3,r[10]=5*s+3*l>>3,r[11]=255,r[12]=5*o+3*i>>3,r[13]=5*a+3*n>>3,r[14]=5*l+3*s>>3,r[15]=255):(r[8]=i+o>>1,r[9]=n+a>>1,r[10]=s+l>>1,r[11]=255,r[12]=0,r[13]=0,r[14]=0,r[15]=0)}function Es(r,e,t){const i=(e>>11&31)*Re,n=(e>>5&63)*Mt,s=(e&31)*Re,o=(t>>11&31)*Re,a=(t>>5&63)*Mt,l=(t&31)*Re;r[0]=i,r[1]=n,r[2]=s,r[3]=o,r[4]=a,r[5]=l,r[6]=5*i+3*o>>3,r[7]=5*n+3*a>>3,r[8]=5*s+3*l>>3,r[9]=5*o+3*i>>3,r[10]=5*a+3*n>>3,r[11]=5*l+3*s>>3}function Ia(r,e,t){r[0]=e,r[1]=t,e>t?(r[2]=54*e+9*t>>6,r[3]=45*e+18*t>>6,r[4]=36*e+27*t>>6,r[5]=27*e+36*t>>6,r[6]=18*e+45*t>>6,r[7]=9*e+54*t>>6):(r[2]=12*e+3*t>>4,r[3]=9*e+6*t>>4,r[4]=6*e+9*t>>4,r[5]=3*e+12*t>>4,r[6]=0,r[7]=255)}function Ss(r,e,t){r[0]=e,r[1]=t,e>t?(r[2]=(6*e+1*t)/7,r[3]=(5*e+2*t)/7,r[4]=(4*e+3*t)/7,r[5]=(3*e+4*t)/7,r[6]=(2*e+5*t)/7,r[7]=(1*e+6*t)/7):(r[2]=(4*e+1*t)/5,r[3]=(3*e+2*t)/5,r[4]=(2*e+3*t)/5,r[5]=(1*e+4*t)/5,r[6]=0,r[7]=1)}function Ba(r,e,t){const i=new Uint8Array(e*t*4);for(let n=0,s=t/4;n<s;n++)for(let o=0,a=e/4;o<a;o++){const l=8*(n*a+o);Sa(ht,r[l]+256*r[l+1],r[l+2]+256*r[l+3]);const c=n*16*e+o*16,d=r[l+4]|r[l+5]<<8|r[l+6]<<16|r[l+7]<<24;for(let h=0;h<4;h++){const u=h*8,p=c+h*e*4;for(let g=0;g<4;g++){const v=p+g*4,b=(d>>u+g*2&3)*4;i[v+0]=ht[b+0],i[v+1]=ht[b+1],i[v+2]=ht[b+2],i[v+3]=ht[b+3]}}}return i}function Ca(r,e,t){const i=new Uint8Array(e*t*4),n=e*4;for(let s=0,o=t/4;s<o;s++)for(let a=0,l=e/4;a<l;a++){const c=16*(s*l+a);Es(Fe,r[c+8]+256*r[c+9],r[c+10]+256*r[c+11]);let d=s*16*e+a*16;for(let h=0;h<4;h++){const u=r[c+h*2]+256*r[c+1+h*2],p=r[c+12+h];for(let g=0;g<4;g++){const v=d+g*4,b=(p>>g*2&3)*3;i[v+0]=Fe[b+0],i[v+1]=Fe[b+1],i[v+2]=Fe[b+2],i[v+3]=(u>>g*4&15)*Ea}d+=n}}return i}function La(r,e,t){const i=new Uint8Array(e*t*4),n=e*4;for(let s=0,o=t/4;s<o;s++)for(let a=0,l=e/4;a<l;a++){const c=16*(s*l+a);Ia(Ts,r[c],r[c+1]),Es(Fe,r[c+8]+256*r[c+9],r[c+10]+256*r[c+11]);let d=s*16*e+a*16;for(let h=0;h<2;h++){const u=c+2+h*3,p=c+12+h*2,g=r[u]+256*(r[u+1]+256*r[u+2]);for(let v=0;v<2;v++){const b=r[p+v];for(let w=0;w<4;w++){const m=d+w*4,E=(b>>w*2&3)*3,x=g>>v*12+w*3&7;i[m+0]=Fe[E+0],i[m+1]=Fe[E+1],i[m+2]=Fe[E+2],i[m+3]=Ts[x]}d+=n}}}return i}function Ra(r,e,t){const i=new Uint8Array(e*t*2),n=e*2;for(let s=0,o=t/4;s<o;s++)for(let a=0,l=e/4;a<l;a++){const c=16*(s*l+a);Ss(xs,r[c],r[c+1]),Ss(_s,r[c+8],r[c+9]);let d=s*8*e+a*8;for(let h=0;h<2;h++){const u=c+h*3,p=r[u+2]+256*(r[u+3]+256*r[u+4]),g=r[u+10]+256*(r[u+11]+256*r[u+12]);for(let v=0;v<2;v++){const b=v*4;for(let w=0;w<4;w++){const m=d+w*2,E=3*(b+w);i[m+1]=xs[p>>E&7],i[m+2]=_s[g>>E&7]}d+=n}}}return i}const Fa=542327876,Ua=131072,Pa=4,Me=827611204,dt=861165636,ft=894720068,gi=843666497,Da=808540228,ka=71,Oa=74,Ma=77,Na=83;class vi{width=0;height=0;format=0;mipmapWidths=[];mipmapHeights=[];mipmapDatas=[];load(e){const t=Ue(e),i=new Int32Array(t.buffer,0,31);let n=128;if(i[0]!==Fa)throw new Error("Wrong magic number");if(!(i[20]&Pa))throw new Error("Not FourCC");let s=i[21];if(s!==Me&&s!==dt&&s!==ft&&s!==gi)if(s===Da){n+=20;const d=new Int32Array(t.buffer,128,5),h=d[0];if(h===ka)s=Me;else if(h===Oa)s=dt;else if(h===Ma)s=ft;else if(h===Na)s=gi;else throw new Error(`Unsupported DXGI format: ${h}`);console.log(d)}else throw new Error(`Unsupported FourCC: ${Hr(s)}`);this.format=s;let o=1;i[2]&Ua&&(o=Math.max(1,i[7]));let a=i[4],l=i[3],c=16;s===Me&&(c=8),this.width=a,this.height=l;for(let d=0;d<o;d++){const h=Math.max(4,a)/4*Math.max(4,l)/4*c;this.mipmapWidths[d]=a,this.mipmapHeights[d]=l,this.mipmapDatas[d]=t.subarray(n,n+h),n+=h,a=Math.max(a/2,1),l=Math.max(l/2,1)}}mipmaps(){return this.mipmapDatas.length}getMipmap(e,t=!1){const i=this.mipmapWidths[e],n=this.mipmapHeights[e],s=this.mipmapDatas[e];let o;return t?o=s:this.format===Me?o=Ba(s,i,n):this.format===dt?o=Ca(s,i,n):this.format===ft?o=La(s,i,n):o=Ra(s,i,n),{width:i,height:n,data:o}}}function Va(r){return r instanceof ArrayBuffer&&(r=new Uint8Array(r)),r instanceof Uint8Array&&r[0]===68&&r[1]===68&&r[2]===83&&r[3]===32}class Ga extends vt{constructor(e,t){super(t);let i;e instanceof vi?i=e:(i=new vi,i.load(e));const n=this.viewer,s=n.gl,a=n.webgl.extensions.WEBGL_compressed_texture_s3tc,l=i.format;let c=0;a&&(l===Me?c=a.COMPRESSED_RGB_S3TC_DXT1_EXT:l===dt?c=a.COMPRESSED_RGBA_S3TC_DXT3_EXT:l===ft&&(c=a.COMPRESSED_RGBA_S3TC_DXT5_EXT));const d=s.createTexture();this.width=i.width,this.height=i.height,this.webglResource=d,s.bindTexture(s.TEXTURE_2D,d);const h=i.mipmaps();(l===Me||l===gi)&&s.pixelStorei(s.UNPACK_ALIGNMENT,2);for(let u=0;u<h;u++){const{width:p,height:g,data:v}=i.getMipmap(u,c!==0);c?s.compressedTexImage2D(s.TEXTURE_2D,u,c,p,g,0,v):l===Me||l===dt||l===ft?s.texImage2D(s.TEXTURE_2D,u,s.RGBA,p,g,0,s.RGBA,s.UNSIGNED_BYTE,v):s.texImage2D(s.TEXTURE_2D,u,s.LUMINANCE_ALPHA,p,g,0,s.LUMINANCE_ALPHA,s.UNSIGNED_BYTE,v)}s.pixelStorei(s.UNPACK_ALIGNMENT,4),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.LINEAR),h>1?s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR_MIPMAP_LINEAR):s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR)}}const ja={load(r){r.webgl.ensureExtension("WEBGL_compressed_texture_s3tc")||console.warn("DDS: No compressed textures support! This might reduce performance.")},isValidSource(r){return r instanceof vi?!0:Va(r)},resource:Ga},Ha=`
uniform mat4 u_VP;
uniform sampler2D u_heightMap;
uniform vec2 u_size;
uniform vec2 u_offset;
uniform bool u_extended[14];
uniform float u_baseTileset;

attribute vec2 a_position;
attribute float a_InstanceID;
attribute vec4 a_textures;
attribute vec4 a_variations;

varying vec4 v_tilesets;
varying vec2 v_uv[4];
varying vec3 v_normal;

vec2 getCell(float variation) {
  if (variation < 16.0) {
    return vec2(mod(variation, 4.0), floor(variation / 4.0));
  } else {
    variation -= 16.0;

    return vec2(4.0 + mod(variation, 4.0), floor(variation / 4.0));
  }
}

vec2 getUV(vec2 position, bool extended, float variation) {
  vec2 cell = getCell(variation);
  vec2 cellSize = vec2(extended ? 0.125 : 0.25, 0.25);
  vec2 uv = vec2(position.x, 1.0 - position.y);
  vec2 pixelSize = vec2(1.0 / 512.0, 1.0 / 256.0); /// Note: hardcoded to 512x256 for now.

  return clamp((cell + uv) * cellSize, cell * cellSize + pixelSize, (cell + 1.0) * cellSize - pixelSize); 
}

void main() {
  vec4 textures = a_textures - u_baseTileset;
  
  if (textures[0] > 0.0 || textures[1] > 0.0 || textures[2] > 0.0 || textures[3] > 0.0) {
    v_tilesets = textures;

    v_uv[0] = getUV(a_position, u_extended[int(textures[0]) - 1], a_variations[0]);
    v_uv[1] = getUV(a_position, u_extended[int(textures[1]) - 1], a_variations[1]);
    v_uv[2] = getUV(a_position, u_extended[int(textures[2]) - 1], a_variations[2]);
    v_uv[3] = getUV(a_position, u_extended[int(textures[3]) - 1], a_variations[3]);

    vec2 corner = vec2(mod(a_InstanceID, u_size.x), floor(a_InstanceID / u_size.x));
    vec2 base = corner + a_position;
    float height = texture2D(u_heightMap, base / u_size).a;

    float hL = texture2D(u_heightMap, vec2(base - vec2(1.0, 0.0)) / (u_size)).a;
    float hR = texture2D(u_heightMap, vec2(base + vec2(1.0, 0.0)) / (u_size)).a;
    float hD = texture2D(u_heightMap, vec2(base - vec2(0.0, 1.0)) / (u_size)).a;
    float hU = texture2D(u_heightMap, vec2(base + vec2(0.0, 1.0)) / (u_size)).a;

    v_normal = normalize(vec3(hL - hR, hD - hU, 2.0));

    gl_Position = u_VP * vec4(base * 128.0 + u_offset, height * 128.0, 1.0);
  } else {
    v_tilesets = vec4(0.0);

    v_uv[0] = vec2(0.0);
    v_uv[1] = vec2(0.0);
    v_uv[2] = vec2(0.0);
    v_uv[3] = vec2(0.0);

    v_normal = vec3(0.0);

    gl_Position = vec4(0.0);
  }
}
`,qa=`
${Ye}

uniform sampler2D u_tilesets[15];

varying vec4 v_tilesets;
varying vec2 v_uv[4];
varying vec3 v_normal;

const vec3 lightDirection = normalize(vec3(-0.3, -0.3, 0.25));

vec4 sample(float tileset, vec2 uv) {
  // 1.0 - 1.0 == 0.0 is not always true.
  int i = int(tileset - 0.6);

  if (i == 0) {
    return texture2D(u_tilesets[0], uv);
  } else if (i == 1) {
    return texture2D(u_tilesets[1], uv);
  } else if (i == 2) {
    return texture2D(u_tilesets[2], uv);
  } else if (i == 3) {
    return texture2D(u_tilesets[3], uv);
  } else if (i == 4) {
    return texture2D(u_tilesets[4], uv);
  } else if (i == 5) {
    return texture2D(u_tilesets[5], uv);
  } else if (i == 6) {
    return texture2D(u_tilesets[6], uv);
  } else if (i == 7) {
    return texture2D(u_tilesets[7], uv);
  } else if (i == 8) {
    return texture2D(u_tilesets[8], uv);
  } else if (i == 9) {
    return texture2D(u_tilesets[9], uv);
  } else if (i == 10) {
    return texture2D(u_tilesets[10], uv);
  } else if (i == 11) {
    return texture2D(u_tilesets[11], uv);
  } else if (i == 12) {
    return texture2D(u_tilesets[12], uv);
  } else if (i == 13) {
    return texture2D(u_tilesets[13], uv);
  } else if (i == 14) {
    return texture2D(u_tilesets[14], uv);
  }
}

vec4 blend(vec4 color, float tileset, vec2 uv) {
  vec4 texel = sample(tileset, uv);

  return mix(color, texel, texel.a);
}

void main() {
  vec4 color = sample(v_tilesets[0], v_uv[0]);

  if (v_tilesets[1] > 0.5) {
    color = blend(color, v_tilesets[1], v_uv[1]);
  }

  if (v_tilesets[2] > 0.5) {
    color = blend(color, v_tilesets[2], v_uv[2]);
  }

  if (v_tilesets[3] > 0.5) {
    color = blend(color, v_tilesets[3], v_uv[3]);
  }

  //color *= clamp(dot(v_normal, lightDirection) + 0.45, 0.0, 1.0);

  gl_FragColor = vec4(color.rgb, 1.0);
}
`,Ka=`
uniform mat4 u_VP;
uniform sampler2D u_heightMap;
uniform sampler2D u_waterHeightMap;
uniform vec2 u_size;
uniform vec2 u_offset;
uniform float u_offsetHeight;
uniform vec4 u_minDeepColor;
uniform vec4 u_maxDeepColor;
uniform vec4 u_minShallowColor;
uniform vec4 u_maxShallowColor;

attribute vec2 a_position;
attribute float a_InstanceID;
attribute float a_isWater;

varying vec2 v_uv;
varying vec4 v_color;

const float minDepth = 10.0 / 128.0;
const float deepLevel = 64.0 / 128.0;
const float maxDepth = 72.0 / 128.0;

void main() {
  if (a_isWater > 0.5) {
    v_uv = a_position;

    vec2 corner = vec2(mod(a_InstanceID, u_size.x), floor(a_InstanceID / u_size.x));
    vec2 base = corner + a_position;
    float height = texture2D(u_heightMap, base / u_size).a;
    float waterHeight = texture2D(u_waterHeightMap, base / u_size).a + u_offsetHeight;
    float value = clamp(waterHeight - height, 0.0, 1.0);

    if (value <= deepLevel) {
      value = max(0.0, value - minDepth) / (deepLevel - minDepth);
      v_color = mix(u_minShallowColor, u_maxShallowColor, value) / 255.0;
    } else {
      value = clamp(value - deepLevel, 0.0, maxDepth - deepLevel) / (maxDepth - deepLevel);
      v_color = mix(u_minDeepColor, u_maxDeepColor, value) / 255.0;
    }

    gl_Position = u_VP * vec4(base * 128.0 + u_offset, waterHeight * 128.0, 1.0);
  } else {
    v_uv = vec2(0.0);
    v_color = vec4(0.0);

    gl_Position = vec4(0.0);
  }
}
`,$a=`
${Ye}

uniform sampler2D u_waterTexture;

varying vec2 v_uv;
varying vec4 v_color;

void main() {
  gl_FragColor = texture2D(u_waterTexture, v_uv) * v_color;
}
`,za=`
uniform mat4 u_VP;
uniform sampler2D u_heightMap;
uniform vec2 u_pixel;
uniform vec2 u_centerOffset;

attribute vec3 a_position;
attribute vec3 a_normal;
attribute vec2 a_uv;
attribute vec3 a_instancePosition;
attribute float a_instanceTexture;

varying vec3 v_normal;
varying vec2 v_uv;
varying float v_texture;
varying vec3 v_position;

void main() {
  // Half of a pixel in the cliff height map.
  vec2 halfPixel = u_pixel * 0.5;

  // The bottom left corner of the map tile this vertex is on.
  vec2 corner = floor((a_instancePosition.xy - vec2(1.0, 0.0) - u_centerOffset.xy) / 128.0);

  // Get the 4 closest heights in the height map.
  float bottomLeft = texture2D(u_heightMap, corner * u_pixel + halfPixel).a;
  float bottomRight = texture2D(u_heightMap, (corner + vec2(1.0, 0.0)) * u_pixel + halfPixel).a;
  float topLeft = texture2D(u_heightMap, (corner + vec2(0.0, 1.0)) * u_pixel + halfPixel).a;
  float topRight = texture2D(u_heightMap, (corner + vec2(1.0, 1.0)) * u_pixel + halfPixel).a;
  
  // Do a bilinear interpolation between the heights to get the final value.
  float bottom = mix(bottomRight, bottomLeft, -a_position.x / 128.0);
  float top = mix(topRight, topLeft, -a_position.x / 128.0);
  float height = mix(bottom, top, a_position.y / 128.0);

  v_normal = a_normal;
  v_uv = a_uv;
  v_texture = a_instanceTexture;
  v_position = a_position + vec3(a_instancePosition.xy, a_instancePosition.z + height * 128.0);

  gl_Position = u_VP * vec4(v_position, 1.0);
}
`,Xa=`
// #extension GL_OES_standard_derivatives : enable

${Ye}

uniform sampler2D u_texture1;
uniform sampler2D u_texture2;

varying vec3 v_normal;
varying vec2 v_uv;
varying float v_texture;
varying vec3 v_position;

// const vec3 lightDirection = normalize(vec3(-0.3, -0.3, 0.25));

vec4 sample(float texture, vec2 uv) {
  // int(0.0) == 0 is not always true.
  int i = int(texture + 0.1);

  if (i == 0) {
    return texture2D(u_texture1, uv);
  } else {
    return texture2D(u_texture2, uv);
  }
}

void main() {
  vec4 color = sample(v_texture, v_uv);

  // vec3 faceNormal = cross(dFdx(v_position), dFdy(v_position));
  // vec3 normal = normalize((faceNormal + v_normal) * 0.5);

  // color *= clamp(dot(normal, lightDirection) + 0.45, 0.1, 1.0);

  gl_FragColor = color;
}
`;function Ya(r){return r.reverse().filter((e,t,i)=>i.indexOf(e,t+1)===-1).reverse()}class Is{offset=0;compressedSize=0;normalSize=0;flags=0;load(e){this.offset=e[0],this.compressedSize=e[1],this.normalSize=e[2],this.flags=e[3]}save(e){e[0]=this.offset,e[1]=this.compressedSize,e[2]=this.normalSize,e[3]=this.flags}}const Wa=441536589,Bs=3283040112,Cs=0,Ls=1,Rs=2,Za=3,Nt=4294967294,Fs=4294967295,Us=3968054179,Qa=256,wi=512,bi=65536,Ps=131072,Ds=16777216,Vt=2147483648,Ja=1,el=2,tl=8,il=16,nl=64,sl=128;class rl{c;entries;constructor(e){this.c=e,this.entries=[]}add(e){const t=new Is;return t.normalSize=e.byteLength,this.entries.push(t),t}clear(){this.entries.length=0}addEmpties(e){for(let t=0;t<e;t++)this.entries.push(new Is)}load(e){const t=e.byteLength/16,i=new Uint32Array(this.c.decryptBlock(e,Us).buffer);let n=0;this.clear(),this.addEmpties(t);for(const s of this.entries)s.load(i.subarray(n,n+4)),n+=4}save(e){const t=new Uint32Array(this.entries.length*4);let i=0;for(const s of this.entries)s.save(t.subarray(i,i+4)),i+=4;const n=new Uint8Array(t.buffer);this.c.encryptBlock(n,Us),e.set(n)}}const ne=new Uint8Array(4),Gt=new Uint32Array(ne.buffer);class ol{cryptTable=new Uint32Array(1280);constructor(){let e=1048577,t=0,i=0;for(let n=0;n<256;n++)for(let s=n,o=0;o<5;o+=1,s+=256)e=(e*125+3)%2796203,t=(e&65535)<<16,e=(e*125+3)%2796203,i=e&65535,this.cryptTable[s]=t|i}hash(e,t){const i=this.cryptTable;let n=2146271213,s=4008636142;e=e.toUpperCase();for(let o=0;o<e.length;o++){const a=e.charCodeAt(o);n=i[(t<<8)+a]^n+s,s=a+n+s+(s<<5)+3}return n>>>0}decryptBlock(e,t){const i=this.cryptTable;let n=4008636142;const s=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);for(let o=0,a=e.byteLength>>>2;o<a;o++)n+=i[1024+(t&255)],ne[0]=s[o*4],ne[1]=s[o*4+1],ne[2]=s[o*4+2],ne[3]=s[o*4+3],Gt[0]^=t+n,t=(~t<<21)+286331153|t>>>11,n=Gt[0]+n+(n<<5)+3,s[o*4]=ne[0],s[o*4+1]=ne[1],s[o*4+2]=ne[2],s[o*4+3]=ne[3];return e}encryptBlock(e,t){const i=this.cryptTable;let n=4008636142;const s=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);for(let o=0,a=e.byteLength>>>2;o<a;o++){n+=i[1024+(t&255)],ne[0]=s[o*4],ne[1]=s[o*4+1],ne[2]=s[o*4+2],ne[3]=s[o*4+3];const l=Gt[0];Gt[0]^=t+n,t=(~t<<21)+286331153|t>>>11,n=l+n+(n<<5)+3,s[o*4]=ne[0],s[o*4+1]=ne[1],s[o*4+2]=ne[2],s[o*4+3]=ne[3]}return e}computeFileKey(e,t){const i=e.lastIndexOf("\\"),n=e.substring(i+1);let s=this.hash(n,Za);return t.flags&Ps&&(s=s+t.offset^t.normalSize),s}}const ks=0,al=1;class ll{ctype=0;outputPos=0;dsize_bits=0;dsize_mask=0;bit_buff=0;extra_bits=0;in_pos=0;in_buff;out_buff=[];constructor(e){this.in_buff=e}}const Os=0,cl=1,Ms=new Uint8Array([2,4,4,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8]),hl=new Uint8Array([3,13,5,25,9,17,1,62,30,46,14,54,22,38,6,58,26,42,10,50,18,34,66,2,124,60,92,28,108,44,76,12,116,52,84,20,100,36,68,4,120,56,88,24,104,40,72,8,240,112,176,48,208,80,144,16,224,96,160,32,192,64,128,0]),dl=new Uint8Array([0,0,0,0,0,0,0,0,1,2,3,4,5,6,7,8]),fl=new Uint16Array([0,1,2,3,4,5,6,7,8,10,14,22,38,70,134,262]),Ns=new Uint8Array([3,2,3,3,4,4,4,5,5,5,5,6,6,6,7,7]),ul=new Uint8Array([5,3,1,6,10,2,12,20,4,24,8,48,16,32,64,0]),ut=new Uint8Array([11,12,12,12,12,12,12,12,12,8,7,12,12,7,12,12,12,12,12,12,12,12,12,12,12,12,13,12,12,12,12,12,4,10,8,12,10,12,10,8,7,7,8,9,7,6,7,8,7,6,7,7,7,7,8,7,7,8,8,12,11,7,9,11,12,6,7,6,6,5,7,8,8,6,11,9,6,7,6,6,7,11,6,6,6,7,9,8,9,9,11,8,11,9,12,8,12,5,6,6,6,5,6,6,6,5,11,7,5,6,5,5,6,10,5,5,5,5,8,7,8,8,10,11,11,12,12,12,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,13,12,13,13,13,12,13,13,13,12,13,13,13,13,12,13,13,13,12,12,12,13,13,13,13,13,13,13,13,13,13,13]),Qe=new Uint16Array([1168,4064,2016,3040,992,3552,1504,2528,480,184,98,3808,1760,34,2784,736,3296,1248,2272,224,3936,1888,2912,864,3424,1376,4672,2400,352,3680,1632,2656,15,592,56,608,80,3168,912,216,66,2,88,432,124,41,60,152,92,9,28,108,44,76,24,12,116,232,104,1120,144,52,176,1808,2144,49,84,17,33,23,20,168,40,1,784,304,62,100,30,46,36,1296,14,54,22,68,48,200,464,208,272,72,1552,336,96,136,4e3,7,38,6,58,27,26,42,10,11,528,4,19,50,3,29,18,400,13,21,5,25,8,120,240,112,656,1040,16,1952,2976,928,576,7232,3136,5184,1088,6208,2112,4160,64,8064,3968,6016,1920,7040,2944,4992,896,7552,3456,5504,1408,6528,2432,4480,384,7808,3712,5760,1664,6784,2688,4736,640,7296,3200,5248,1152,6272,2176,4224,128,7936,3840,5888,1792,6912,2816,4864,3488,1440,2464,416,3744,1696,2720,672,3232,1184,2208,160,3872,1824,2848,800,3360,1312,2336,288,3616,1568,2592,544,3104,1056,2080,32,4032,1984,3008,960,3520,1472,2496,448,3776,1728,2752,704,3264,1216,2240,192,3904,1856,2880,832,768,3392,7424,3328,5376,1344,1280,6400,2304,2368,4352,256,7680,3584,320,5632,1536,6656,3648,1600,2624,2560,4608,512,7168,3072,5120,1024,6144,2048,4096,0]);let Vs=!1;const Gs=new Uint8Array(256),js=new Uint8Array(256);let Hs=!1;const mi=new Uint8Array(256),qs=new Uint8Array(256),Ks=new Uint8Array(128),$s=new Uint8Array(256);function zs(r,e,t){for(let i=0,n=e.length;i<n;i++){const s=1<<t[i];for(let o=e[i];o<256;o+=s)r[o]=i}}function pl(){let r=255,e,t;for(let i=255;r>=0;r--,i--){const n=i;let s=ut[n];if(s<=8){t=1<<s,e=Qe[r];do mi[e]=i,e+=t;while(e<256)}else if((e=Qe[r]&255)!=0)if(mi[e]=255,Qe[r]&63){s-=4,ut[n]=s,t=1<<s,e=Qe[r]>>4;do qs[e]=i,e+=t;while(e<256)}else{s-=6,ut[n]=s,t=1<<s,e=Qe[r]>>6;do Ks[e]=i,e+=t;while(e<128)}else{s-=8,ut[n]=s,t=1<<s,e=Qe[r]>>8;do $s[e]=i,e+=t;while(e<256)}}}function ge(r,e){return e<=r.extra_bits?(r.extra_bits-=e,r.bit_buff>>=e,Os):(r.bit_buff>>=r.extra_bits,r.in_pos===r.in_buff.byteLength?cl:(r.bit_buff|=r.in_buff[r.in_pos++]<<8,r.bit_buff>>=e-r.extra_bits,r.extra_bits=r.extra_bits-e+8,Os))}function gl(r){if(r.bit_buff&1){if(ge(r,1))return 774;let t=js[r.bit_buff&255];if(ge(r,Ns[t]))return 774;let i;if((i=dl[t])!=0){const n=r.bit_buff&(1<<i)-1;if(ge(r,i)&&t+n!=270)return 774;t=fl[t]+n}return t+256}if(ge(r,1))return 774;if(r.ctype==ks){const t=r.bit_buff&255;return ge(r,8)?774:t}let e;if(r.bit_buff&255){if(e=mi[r.bit_buff&255],e==255)if(r.bit_buff&63){if(ge(r,4))return 774;e=qs[r.bit_buff&255]}else{if(ge(r,6))return 774;e=Ks[r.bit_buff&127]}}else{if(ge(r,8))return 774;e=$s[r.bit_buff&255]}return ge(r,ut[e])?774:e}function vl(r,e){const t=Gs[r.bit_buff&255],i=Ms[t];if(ge(r,i))return 0;let n;if(e==2){if(n=t<<2|r.bit_buff&3,ge(r,2))return 0}else if(n=t<<r.dsize_bits|r.bit_buff&r.dsize_mask,ge(r,r.dsize_bits))return 0;return n+1}function wl(r){let e;for(;(e=gl(r))<773;)if(e>=256){let t=e-254,i;if((i=vl(r,t))==0)return 774;let n=r.outputPos,s=n-i;for(r.outputPos+=t;t-- >0;)r.out_buff[n++]=r.out_buff[s++]}else r.out_buff[r.outputPos++]=e;return e}function Xs(r){const e=new ll(r);if(e.in_buff.byteLength<=4)throw new Error("Bad data");if(e.ctype=e.in_buff[0],e.dsize_bits=e.in_buff[1],e.bit_buff=e.in_buff[2],e.extra_bits=0,e.in_pos=3,4>e.dsize_bits||e.dsize_bits>6)throw new Error("Invalid dictionary size");if(e.dsize_mask=65535>>16-e.dsize_bits,e.ctype!==ks){if(e.ctype!==al)throw new Error("Invalid mode");Hs||(pl(),Hs=!0)}if(Vs||(zs(js,ul,Ns),zs(Gs,hl,Ms),Vs=!0),wl(e)===774)throw new Error("Error while expanding");return new Uint8Array(e.out_buff)}function Ys(r){let e=-1;for(let t=0,i=Math.ceil(r.byteLength/512);t<i;t++){const n=t*512;r[n]===77&&r[n+1]===80&&r[n+2]===81&&r[n+3]===26&&(e=n)}return e}function bl(r){return r[0]===72&&r[1]===77&&r[2]===51&&r[3]===87?!0:Ys(r)!==-1}class Ws{archive;c;name;nameResolved;hash;block;rawBuffer=null;buffer=null;constructor(e,t,i,n,s){const o=e.headerOffset;this.archive=e,this.c=e.c,this.name=`File${`${t.blockIndex}`.padStart(8,"0")}`,this.nameResolved=!1,this.hash=t,this.block=i,n&&(this.rawBuffer=n.slice(o+i.offset,o+i.offset+i.compressedSize)),s&&(this.buffer=s)}bytes(){return this.buffer===null&&this.decode(),this.buffer}arrayBuffer(){return this.bytes().buffer}text(){return wt(this.bytes())}set(e){if(this.archive.readonly)return!1;const t=this.hash,i=this.block;return t.locale=0,t.platform=0,i.compressedSize=0,i.normalSize=e.byteLength,i.flags=0,this.buffer=e,this.rawBuffer=null,!0}delete(){if(this.archive.readonly)return!1;const e=this.archive,t=this.hash,i=t.blockIndex;t.delete();for(const n of e.hashTable.entries)n.blockIndex<Nt&&n.blockIndex>i&&(n.blockIndex-=1);return e.blockTable.entries.splice(i,1),e.files.splice(i,1),!0}rename(e){if(this.archive.readonly)return!1;const t=this.hash,i=t.locale,n=t.platform,s=t.blockIndex;t.delete();const o=this.archive.hashTable.add(e,s);return o.locale=i,o.platform=n,this.name=e,this.nameResolved=!0,this.hash=o,!0}decode(){if(!this.rawBuffer)throw new Error(`File ${this.name}: Nothing to decode`);const e=this.archive,t=this.block,i=e.c,n=i.computeFileKey(this.name,t),s=this.rawBuffer,o=t.flags;if(o===Vt)this.buffer=s.slice(0,t.normalSize);else if(o&Ds){let a;o&bi?a=i.decryptBlock(s.slice(0,t.compressedSize),n):a=s.subarray(0,t.compressedSize),o&wi?a=this.decompressSector(a,t.normalSize):a=a.slice(),this.buffer=a}else{const a=Math.ceil(t.normalSize/e.sectorSize),l=new Uint8Array(t.normalSize);let c=new Uint32Array(s.buffer,0,a+1);o&bi&&(c=i.decryptBlock(c.slice(),n-1));let d=c[0],h=c[1],u=0;for(let p=0;p<a;p++){let g;if(o&bi?g=i.decryptBlock(s.slice(d,h),n+p):g=s.subarray(d,h),o&wi){let v=e.sectorSize;t.normalSize-u<v&&(v=t.normalSize-u),g=this.decompressSector(g,v)}o&Qa&&(g=Xs(g)),l.set(g,u),u+=g.byteLength,p<a&&(d=h,h=c[p+2])}this.buffer=l}e.readonly&&(this.rawBuffer=null)}decompressSector(e,t){if(e.byteLength===t)return e;{const i=e[0];if(i&il)throw new Error(`File ${this.name}: compression type 'bzip2' not supported`);if(i&tl)try{e=Xs(e.subarray(1))}catch(n){throw new Error(`File ${this.name}: failed to decompress with 'explode': ${n}`)}if(i&el)try{e=Si.inflate(e.subarray(1))}catch(n){throw new Error(`File ${this.name}: failed to decompress with 'zlib': ${n}`)}if(i&Ja)throw new Error(`File ${this.name}: compression type 'huffman' not supported`);if(i&sl)throw new Error(`File ${this.name}: compression type 'adpcm stereo' not supported`);if(i&nl)throw new Error(`File ${this.name}: compression type 'adpcm mono' not supported`);return e}}encode(){if(this.buffer!==null&&this.rawBuffer===null){const e=this.buffer;if(bl(e))this.rawBuffer=this.buffer,this.block.compressedSize=this.buffer.byteLength,this.block.flags=Vt;else{const t=this.archive.sectorSize,i=Math.ceil(e.byteLength/t),n=new Uint32Array(i+1);let s=n.byteLength;const o=[],a=[];n[0]=s;for(let l=0;l<i;l++){const c=l*t;let d=e.subarray(c,c+t),h=d.byteLength;const u=Si.deflate(d);let p=!1;u.byteLength+1<h&&(d=u,h=u.byteLength+1,p=!0),s+=h,n[l+1]=s,o[l]=d,a[l]=p}if(s<e.byteLength){const l=new Uint8Array(s);l.set(new Uint8Array(n.buffer)),s=n.byteLength;for(let c=0;c<i;c++){a[c]&&(l[s]=2,s+=1);const d=o[c];l.set(d,s),s+=d.byteLength}this.rawBuffer=l,this.block.compressedSize=l.byteLength,this.block.flags=(Vt|wi)>>>0}else this.rawBuffer=this.buffer,this.block.compressedSize=this.buffer.byteLength,this.block.flags=Vt}}}reEncrypt(e){if(!this.rawBuffer)return!1;const t=this.archive,i=this.block,n=t.c,s=this.rawBuffer,o=i.flags,a=n.computeFileKey(this.name,i);i.offset=e;const l=n.computeFileKey(this.name,i);if(o&Ds)n.decryptBlock(s,a),n.encryptBlock(s,l);else{const c=Math.ceil(i.normalSize/t.sectorSize),d=new Uint32Array(s.buffer,0,c+1);n.decryptBlock(d,a-1);let h=d[0],u=d[1];for(let p=0;p<c;p++){const g=s.subarray(h,u);n.decryptBlock(g,a+p),n.encryptBlock(g,l+p),p<c&&(h=u,u=d[p+2])}n.encryptBlock(d,l-1)}return!0}offsetChanged(e){const t=this.block;return t.offset!==e&&t.flags&Ps?this.nameResolved?this.reEncrypt(e):!1:(t.offset=e,!0)}}class ml{nameA=4294967295;nameB=4294967295;locale=65535;platform=65535;blockIndex=Fs;load(e){const t=e[2];this.nameA=e[0],this.nameB=e[1],this.locale=t&65535,this.platform=t>>>16,this.blockIndex=e[3]}copy(e){this.nameA=e.nameA,this.nameB=e.nameB,this.locale=e.locale,this.platform=e.platform,this.blockIndex=e.blockIndex}save(e){e[0]=this.nameA,e[1]=this.nameB,e[2]=this.locale<<16|this.platform,e[3]=this.blockIndex}delete(){this.nameA=4294967295,this.nameB=4294967295,this.locale=65535,this.platform=65535,this.blockIndex=Nt}}class Al{c;entries;constructor(e){this.c=e,this.entries=[],this.addEmpties(4)}clear(){this.entries.length=0}addEmpties(e){for(let t=0;t<e;t++)this.entries.push(new ml)}getInsertionIndex(e){const t=this.entries,i=this.c.hash(e,Cs)&t.length-1;for(let n=0,s=t.length;n<s;n++){const o=(n+i)%s;if(t[o].platform===65535)return o}return-1}add(e,t){const i=this.getInsertionIndex(e);if(i!==-1){const n=this.entries[i];return n.nameA=this.c.hash(e,Ls),n.nameB=this.c.hash(e,Rs),n.locale=0,n.platform=0,n.blockIndex=t,n}}load(e){const t=e.byteLength/16,i=new Uint32Array(this.c.decryptBlock(e,Bs).buffer);let n=0;this.clear(),this.addEmpties(t);for(const s of this.entries)s.load(i.subarray(n,n+4)),n+=4}save(e){const t=new Uint32Array(this.entries.length*4);let i=0;for(const s of this.entries)s.save(t.subarray(i,i+4)),i+=4;const n=new Uint8Array(t.buffer);this.c.encryptBlock(n,Bs),e.set(n)}get(e){const t=this.c,i=this.entries,n=t.hash(e,Cs)&i.length-1,s=t.hash(e,Ls),o=t.hash(e,Rs);for(let a=0,l=i.length;a<l;a++){const c=i[(a+n)%l];if(s===c.nameA&&o===c.nameB)return c;if(c.blockIndex===4294967295)return null}return null}}class yl{headerOffset;sectorSize;c;hashTable;blockTable;files;readonly=!1;constructor(){this.headerOffset=0,this.sectorSize=4096,this.c=new ol,this.hashTable=new Al(this.c),this.blockTable=new rl(this.c),this.files=[]}load(e,t=!1){const i=Ue(e);this.readonly=t;const n=Ys(i);if(n===-1)throw new Error("No MPQ header");const s=new Uint32Array(i.buffer,n,8),o=s[3],a=ln(s[4]+n),l=ln(s[5]+n),c=s[6];let d=s[7];d>c&&(d=c),this.headerOffset=n,this.sectorSize=512*(1<<(o>>>16)),this.hashTable.load(i.slice(a,a+c*16)),this.blockTable.load(i.slice(l,l+d*16)),this.files.length=0;for(const u of this.hashTable.entries){const p=u.blockIndex;p<this.blockTable.entries.length&&(this.files[p]=new Ws(this,u,this.blockTable.entries[p],i,null))}const h=this.get("(listfile)");if(h){const u=h.text();if(u)for(const p of u.split(`\r
`))this.get(p)}}save(){if(this.readonly)return null;const e=32;this.delete("(attributes)"),this.saveMemory(),this.set("(listfile)",this.getFileNames().join(`\r
`));let t=e;for(const p of this.files)if(p){if(!p.offsetChanged(t))return null;p.encode(),t+=p.block.compressedSize}const i=this.hashTable,n=this.blockTable,s=i.entries.length,o=n.entries.length,a=t-e,l=e+a+s*16+o*16,c=e+a,d=c+s*16,h=new Uint8Array(l),u=new Uint32Array(h.buffer,0,8);u[0]=Wa,u[1]=e,u[2]=l,u[3]=Math.log2(this.sectorSize/512)<<16,u[4]=c,u[5]=d,u[6]=s,u[7]=o,t=e;for(const p of this.files)p&&(p.rawBuffer&&h.set(p.rawBuffer,t),t+=p.block.compressedSize);return i.save(h.subarray(t,t+i.entries.length*16)),t+=i.entries.length*16,n.save(h.subarray(t,t+n.entries.length*16)),h}saveMemory(){if(this.readonly)return 0;const e=this.blockTable.entries,t=this.hashTable.entries;let i=e.length,n=0;for(;i--;){const s=e[i];if(s.normalSize===0)this.removeBlock(i),n+=s.compressedSize;else{let o=!1;for(const a of t)if(a.blockIndex===i){o=!0;break}o||(this.removeBlock(i),n+=s.compressedSize)}}return n}removeBlock(e){for(const t of this.hashTable.entries)t.blockIndex<Nt&&t.blockIndex>e&&(t.blockIndex-=1);this.blockTable.entries.splice(e,1)}getFileNames(){const e=[];for(const t of this.files)t&&t.name!==""&&e.push(t.name);return e}countUnresolved(){let e=0;for(const t of this.files)t.nameResolved||e++;return e}applyListfile(e){for(const t of e)this.get(t)}set(e,t){if(this.readonly)return!1;const i=Ue(t);let n=this.get(e);if(n)n.set(i);else{const s=this.blockTable.entries.length,o=this.hashTable.add(e,s);if(!o)return!1;const a=this.blockTable.add(i);n=new Ws(this,o,a,null,i),n.name=e,n.nameResolved=!0,this.files[s]=n}return!0}get(e){const t=this.hashTable.get(e);if(t){const i=t.blockIndex;if(i<Nt){const n=this.files[i];if(n)return n.name=e,n.nameResolved=!0,n}}return null}has(e){return!!this.get(e)}delete(e){if(this.readonly)return!1;const t=this.get(e);return t?(t.delete(),!0):!1}rename(e,t){if(this.readonly)return!1;const i=this.get(e);return i?(i.rename(t),!0):!1}resizeHashtable(e){if(this.readonly)return!1;e=Math.max(4,Cr(e));const t=this.files;if(t.length>e)return!1;for(const o of t)if(!o.nameResolved)return!1;const i=this.hashTable,n=i.entries,s=n.slice();i.clear(),i.addEmpties(e);for(const o of s)if(o.blockIndex!==Fs){const a=t[o.blockIndex],l=i.getInsertionIndex(a.name);n[l].copy(o)}return!0}}class Zs{isCustom=0;path="";load(e){this.isCustom=e.readUint8(),this.path=e.readNull()}save(e){e.writeUint8(this.isCustom),e.writeNull(this.path)}getByteLength(){return 2+j(this.path)}}class Tl{version=1;entries=new Map;load(e){const t=new q(e);this.version=t.readUint32();for(let i=0,n=t.readUint32();i<n;i++){const s=new Zs;s.load(t),s.isCustom?this.entries.set(s.path,s):this.entries.set(`war3mapimported\\${s.path}`,s)}}save(){const e=new q(new ArrayBuffer(this.getByteLength()));e.writeUint32(this.version),e.writeUint32(this.entries.size);for(const t of this.entries.values())t.save(e);return e.uint8array}getByteLength(){let e=8;for(const t of this.entries.values())e+=t.getByteLength();return e}set(e){if(!this.entries.has(e)){const t=new Zs;return t.isCustom=10,t.path=e,this.entries.set(e,t),!0}return!1}has(e){return this.entries.has(e)}delete(e){return this.entries.delete(e)}rename(e,t){const i=this.entries.get(e);return i?(i.isCustom=10,i.path=t,!0):!1}}class xl{id="\0\0\0\0";variableType=0;levelOrVariation=0;dataPointer=0;value=0;u1=0;load(e,t){if(this.id=e.readBinary(4),this.variableType=e.readInt32(),t&&(this.levelOrVariation=e.readInt32(),this.dataPointer=e.readInt32()),this.variableType===0)this.value=e.readInt32();else if(this.variableType===1||this.variableType===2)this.value=e.readFloat32();else if(this.variableType===3)this.value=e.readNull();else throw new Error(`Modification: unknown variable type ${this.variableType}`);this.u1=e.readInt32()}save(e,t){if(e.writeBinary(this.id),e.writeInt32(this.variableType),t&&(e.writeInt32(this.levelOrVariation),e.writeInt32(this.dataPointer)),this.variableType===0)e.writeInt32(this.value);else if(this.variableType===1||this.variableType===2)e.writeFloat32(this.value);else if(this.variableType===3)e.writeNull(this.value);else throw new Error(`Modification: unknown variable type ${this.variableType}`);e.writeInt32(this.u1)}getByteLength(e){let t=12;return e&&(t+=8),this.variableType===3?t+=j(this.value)+1:t+=4,t}}class _l{oldId="\0\0\0\0";newId="\0\0\0\0";sets=1;setsFlag=[];modifications=[];load(e,t,i){this.oldId=e.readBinary(4),this.newId=e.readBinary(4),i>=3&&(this.sets=e.readUint32());for(let n=0;n<this.sets;n++){i>=3&&(this.setsFlag[n]=e.readUint32());for(let s=0,o=e.readUint32();s<o;s++){const a=new xl;a.load(e,t),this.modifications[s]=a}}}save(e,t,i){this.oldId!=="\0\0\0\0"?e.writeBinary(this.oldId):e.writeUint32(0),this.newId!=="\0\0\0\0"?e.writeBinary(this.newId):e.writeUint32(0),i>=3&&e.writeUint32(this.sets),e.writeUint32(this.modifications.length);for(let n=0;n<this.sets;n++){i>=3&&e.writeUint32(this.setsFlag[n]);for(const s of this.modifications)s.save(e,t)}}getByteLength(e,t){let i=t>=3?16:12;for(let n=0;n<this.sets;n++){t>=3&&(i+=4);for(const s of this.modifications)i+=s.getByteLength(e)}return i}}class jt{objects=[];load(e,t,i){for(let n=0,s=e.readUint32();n<s;n++){const o=new _l;o.load(e,t,i),this.objects[n]=o}}save(e,t,i){e.writeUint32(this.objects.length);for(const n of this.objects)n.save(e,t,i)}getByteLength(e,t){let i=4;for(const n of this.objects)i+=n.getByteLength(e,t);return i}}class El{version=0;originalTable=new jt;customTable=new jt;load(e){let t;e instanceof q?t=e:t=new q(e),this.version=t.readInt32(),this.originalTable.load(t,!0,this.version),this.customTable.load(t,!0,this.version)}save(){const e=new q(new ArrayBuffer(this.getByteLength()));return e.writeInt32(this.version),this.originalTable.save(e,!0,this.version),this.customTable.save(e,!0,this.version),e.uint8array}getByteLength(){return 4+this.originalTable.getByteLength(!0,this.version)+this.customTable.getByteLength(!0,this.version)}}class Sl{version=0;originalTable=new jt;customTable=new jt;load(e){let t;e instanceof q?t=e:t=new q(e),this.version=t.readInt32(),this.originalTable.load(t,!1,this.version),this.customTable.load(t,!1,this.version)}save(){const e=new q(new ArrayBuffer(this.getByteLength()));return e.writeInt32(this.version),this.originalTable.save(e,!1,this.version),this.customTable.save(e,!1,this.version),e.uint8array}getByteLength(){return 4+this.originalTable.getByteLength(!1,this.version)+this.customTable.getByteLength(!1,this.version)}}class Qs{text="";load(e){const t=e.readInt32();t&&(this.text=e.read(t-1),e.skip(1))}save(e){this.text.length?(e.writeInt32(j(this.text)+1),e.write(this.text),e.skip(1)):e.writeInt32(0)}getByteLength(){let e=4;return this.text.length&&(e+=j(this.text)+1),e}}class Il{version=0;comment="";trigger=new Qs;triggers=[];load(e){const t=new q(e);this.version=t.readInt32(),this.version===1&&(this.comment=t.readNull(),this.trigger.load(t));for(let i=0,n=t.readUint32();i<n;i++){const s=new Qs;s.load(t),this.triggers[i]=s}}save(){const e=new q(new ArrayBuffer(this.getByteLength()));e.writeInt32(this.version),this.version===1&&(e.writeNull(this.comment),this.trigger.save(e)),e.writeUint32(this.triggers.length);for(const t of this.triggers)t.save(e);return e.uint8array}getByteLength(){let e=8;this.version===1&&(e+=j(this.comment)+1+this.trigger.getByteLength());for(const t of this.triggers)e+=t.getByteLength();return e}}class Bl{id=0;name="";isComment=0;load(e,t){this.id=e.readInt32(),this.name=e.readNull(),t===7&&(this.isComment=e.readInt32())}save(e,t){e.writeInt32(this.id),e.writeNull(this.name),t===7&&e.writeInt32(this.isComment)}getByteLength(e){let t=5+j(this.name);return e===7&&(t+=4),t}}class Cl{name="";type="";u1=0;isArray=0;arraySize=0;isInitialized=0;initialValue="";load(e,t){this.name=e.readNull(),this.type=e.readNull(),this.u1=e.readInt32(),this.isArray=e.readInt32(),t===7&&(this.arraySize=e.readInt32()),this.isInitialized=e.readInt32(),this.initialValue=e.readNull()}save(e,t){e.writeNull(this.name),e.writeNull(this.type),e.writeInt32(this.u1),e.writeInt32(this.isArray),t===7&&e.writeInt32(this.arraySize),e.writeInt32(this.isInitialized),e.writeNull(this.initialValue)}getByteLength(e){let t=15+j(this.name)+j(this.type)+j(this.initialValue);return e===7&&(t+=4),t}}class Ll{type=0;name="";beginParameters=0;parameters=[];load(e,t,i){if(this.type=e.readInt32(),this.type<0||this.type>3)throw new Error(`SubParameters: Bad type: ${this.type}`);if(this.name=e.readNull(),this.name.length===0)throw new Error("SubParameters: Empty name");if(this.beginParameters=e.readInt32(),this.beginParameters){const n=i.getFunction(this.type,this.name);if(!n)throw new Error(`SubParameters "${this.name}:${this.type}": Unknown signature`);const s=n.args;for(let o=0,a=s.length;o<a;o++){const l=new Ht;try{l.load(e,t,i)}catch(c){throw new Error(`SubParameters "${this.name}": Parameter ${o}: ${c}`)}this.parameters[o]=l}}}save(e,t){e.writeInt32(this.type),e.writeNull(this.name),e.writeInt32(this.beginParameters);for(const i of this.parameters)i.save(e,t)}getByteLength(e){let t=9+j(this.name);if(this.parameters.length)for(const i of this.parameters)t+=i.getByteLength(e);return t}}class Ht{type=0;value="";subParameters=null;u1=0;isArray=0;arrayIndex=null;load(e,t,i){if(this.type=e.readInt32(),this.type<-1||this.type>3)throw new Error(`Parameter: Bad type: ${this.type}`);if(this.value=e.readNull(),e.readInt32()){const n=new Ll;try{n.load(e,t,i)}catch(s){throw new Error(`Parameter "${this.value}": SubParameters ${s}`)}this.subParameters=n}if((t===4&&this.type===2||t===7&&this.subParameters)&&(this.u1=e.readInt32()),(t===4&&this.type!==2||t===7)&&(this.isArray=e.readInt32()),this.isArray){const n=new Ht;try{n.load(e,t,i)}catch(s){throw new Error(`Parameter "${this.value}": ArrayIndex: ${s}`)}this.arrayIndex=n}}save(e,t){e.writeInt32(this.type),e.writeNull(this.value),this.subParameters?(e.writeInt32(1),this.subParameters.save(e,t)):e.writeInt32(0),(t===4&&this.type===2||t===7&&this.subParameters)&&e.writeInt32(this.u1),(t===4&&this.type!==2||t===7)&&e.writeInt32(this.isArray),this.isArray&&this.arrayIndex&&this.arrayIndex.save(e,t)}getByteLength(e){let t=9+j(this.value);return this.subParameters&&(t+=this.subParameters.getByteLength(e)),(e===4&&this.type===2||e===7&&this.subParameters)&&(t+=4),(e===4&&this.type!==2||e===7)&&(t+=4),this.isArray&&this.arrayIndex&&(t+=this.arrayIndex.getByteLength(e)),t}}class Ai{type=-1;group=-1;name="";isEnabled=0;parameters=[];ecas=[];load(e,t,i,n){if(this.type=e.readInt32(),this.type<0||this.type>3)throw new Error(`ECA: Bad type: ${this.type}`);if(i&&(this.group=e.readUint32()),this.name=e.readNull(),this.name.length===0)throw new Error("ECA: Empty name");this.isEnabled=e.readInt32();const s=n.getFunction(this.type,this.name);if(!s)throw new Error(`ECA "${this.name}:${this.type}": Unknown signature`);const o=s.args;for(let a=0,l=o.length;a<l;a++){const c=new Ht;try{c.load(e,t,n)}catch(d){throw new Error(`ECA "${this.name}": Parameter ${a}: ${d}`)}this.parameters[a]=c}if(t===7)for(let a=0,l=e.readUint32();a<l;a++){const c=new Ai;try{c.load(e,t,!0,n)}catch(d){throw new Error(`ECA "${this.name}": Child ECA ${a} ${d}`)}this.ecas[a]=c}}save(e,t){e.writeInt32(this.type),this.group!==-1&&e.writeInt32(this.group),e.writeNull(this.name),e.writeInt32(this.isEnabled);for(const i of this.parameters)i.save(e,t);if(t===7){e.writeUint32(this.ecas.length);for(const i of this.ecas)i.save(e,t)}}getByteLength(e){let t=9+j(this.name);this.group!==-1&&(t+=4);for(const i of this.parameters)t+=i.getByteLength(e);if(e===7){t+=4;for(const i of this.ecas)t+=i.getByteLength(e)}return t}}class Rl{name="";description="";isComment=0;isEnabled=0;isCustom=0;isInitiallyOff=0;runOnInitialization=0;category=0;ecas=[];load(e,t,i){this.name=e.readNull(),this.description=e.readNull(),t===7&&(this.isComment=e.readInt32()),this.isEnabled=e.readInt32(),this.isCustom=e.readInt32(),this.isInitiallyOff=e.readInt32(),this.runOnInitialization=e.readInt32(),this.category=e.readInt32();for(let n=0,s=e.readUint32();n<s;n++){const o=new Ai;try{o.load(e,t,!1,i)}catch(a){throw new Error(`Trigger "${this.name}": ECA ${n}: ${a}`)}this.ecas[n]=o}}save(e,t){e.writeNull(this.name),e.writeNull(this.description),t===7&&e.writeInt32(this.isComment),e.writeInt32(this.isEnabled),e.writeInt32(this.isCustom),e.writeInt32(this.isInitiallyOff),e.writeInt32(this.runOnInitialization),e.writeInt32(this.category),e.writeUint32(this.ecas.length);for(const i of this.ecas)i.save(e,t)}getByteLength(e){let t=26+j(this.name)+j(this.description);e===7&&(t+=4);for(const i of this.ecas)t+=i.getByteLength(e);return t}}class Fl{version=0;categories=[];u1=0;variables=[];triggers=[];load(e,t){const i=new q(e);if(i.readBinary(4)!=="WTG!")throw new Error("Not a WTG file");this.version=i.readInt32();for(let n=0,s=i.readUint32();n<s;n++){const o=new Bl;o.load(i,this.version),this.categories[n]=o}this.u1=i.readInt32();for(let n=0,s=i.readUint32();n<s;n++){const o=new Cl;o.load(i,this.version),this.variables[n]=o}for(let n=0,s=i.readUint32();n<s;n++){const o=new Rl;try{o.load(i,this.version,t)}catch(a){throw new Error(`Trigger ${n}: ${a}`)}this.triggers[n]=o}}save(){const e=new q(new ArrayBuffer(this.getByteLength()));e.writeBinary("WTG!"),e.writeInt32(this.version),e.writeUint32(this.categories.length);for(const t of this.categories)t.save(e,this.version);e.writeInt32(this.u1),e.writeUint32(this.variables.length);for(const t of this.variables)t.save(e,this.version);e.writeUint32(this.triggers.length);for(const t of this.triggers)t.save(e,this.version);return e.uint8array}getByteLength(){let e=24;const t=this.version;for(const i of this.categories)e+=i.getByteLength(t);for(const i of this.variables)e+=i.getByteLength(t);for(const i of this.triggers)e+=i.getByteLength(t);return e}}class Ul{stringMap=new Map;load(e){const t=new Jt(e);let i;const n=e.indexOf("STRING");if(n===-1)throw new Error("Not a valid war3map.wts buffer");for(t.index=n;i=t.readToken();)if(i==="STRING"){const s=t.readInt();t.read();const o=e.indexOf("}",t.index);if(o===-1)throw this.stringMap.set(s,e.slice(t.index,e.length).trim()),new Error(`WTS: missing data in string ${this.stringMap.size} (and maybe more)`);this.stringMap.set(s,e.slice(t.index,o).trim()),t.index=o}}save(){let e="";for(const[t,i]of this.stringMap)e+=`STRING ${t}\r
{\r
${i}\r
}\r
\r
`;return e}getString(e){if(typeof e=="string"){if(e.startsWith("TRIGSTR_"))return this.stringMap.get(parseInt(e.slice(8)))}else return this.stringMap.get(e)}setString(e,t){typeof e=="string"?e.startsWith("TRIGSTR_")&&this.stringMap.set(parseInt(e.slice(8)),t):this.stringMap.set(e,t)}}class Pl{flags=0;playerMasks=0;name="";load(e){this.flags=e.readUint32(),this.playerMasks=e.readUint32(),this.name=e.readNull()}save(e){e.writeUint32(this.flags),e.writeUint32(this.playerMasks),e.writeNull(this.name)}getByteLength(){return 9+j(this.name)}}class Dl{id=0;type=0;race=0;isFixedStartPosition=0;name="";startLocation=new Float32Array(2);allyLowPriorities=0;allyHighPriorities=0;unknown1=new Uint8Array(8);load(e,t){this.id=e.readInt32(),this.type=e.readInt32(),this.race=e.readInt32(),this.isFixedStartPosition=e.readInt32(),this.name=e.readNull(),e.readFloat32Array(this.startLocation),this.allyLowPriorities=e.readUint32(),this.allyHighPriorities=e.readUint32(),t>30&&e.readUint8Array(this.unknown1)}save(e,t){e.writeInt32(this.id),e.writeInt32(this.type),e.writeInt32(this.race),e.writeInt32(this.isFixedStartPosition),e.writeNull(this.name),e.writeFloat32Array(this.startLocation),e.writeUint32(this.allyLowPriorities),e.writeUint32(this.allyHighPriorities),t>30&&e.writeUint8Array(this.unknown1)}getByteLength(e){let t=33+j(this.name);return e>30&&(t+=8),t}}let kl=class{chance=0;id="\0\0\0\0";load(e){this.chance=e.readInt32(),this.id=e.readBinary(4)}save(e){e.writeInt32(this.chance),e.writeBinary(this.id)}},Ol=class{items=[];load(e){for(let t=0,i=e.readUint32();t<i;t++){const n=new kl;n.load(e),this.items[t]=n}}save(e){e.writeUint32(this.items.length);for(const t of this.items)t.save(e)}getByteLength(){return 4+this.items.length*8}};class Ml{id=0;name="";sets=[];load(e){this.id=e.readInt32(),this.name=e.readNull();for(let t=0,i=e.readUint32();t<i;t++){const n=new Ol;n.load(e),this.sets[t]=n}}save(e){e.writeInt32(this.id),e.writeNull(this.name),e.writeUint32(this.sets.length);for(const t of this.sets)t.save(e)}getByteLength(){let e=9+j(this.name);for(const t of this.sets)e+=t.getByteLength();return e}}let Nl=class{chance=0;ids=[];load(e,t){this.chance=e.readInt32();for(let i=0;i<t;i++)this.ids[i]=e.readBinary(4)}save(e){e.writeInt32(this.chance);for(const t of this.ids)e.writeBinary(t)}};class Vl{id=0;name="";positions=0;columnTypes=new Int32Array(0);units=[];load(e){this.id=e.readInt32(),this.name=e.readNull(),this.positions=e.readInt32(),this.columnTypes=e.readInt32Array(this.positions);for(let t=0,i=e.readUint32();t<i;t++){const n=new Nl;n.load(e,this.positions),this.units[t]=n}}save(e){e.writeInt32(this.id),e.writeNull(this.name),e.writeInt32(this.positions),e.writeInt32Array(this.columnTypes),e.writeUint32(this.units.length);for(const t of this.units)t.save(e)}getByteLength(){return 13+j(this.name)+this.columnTypes.byteLength+this.units.length*(4+4*this.positions)}}class Gl{playerFlags=0;id="\0\0\0\0";load(e){this.playerFlags=e.readUint32(),this.id=e.readBinary(4)}save(e){e.writeUint32(this.playerFlags),e.writeBinary(this.id)}}class jl{playerFlags=0;id="\0\0\0\0";levelAffected=0;availability=0;load(e){this.playerFlags=e.readUint32(),this.id=e.readBinary(4),this.levelAffected=e.readInt32(),this.availability=e.readInt32()}save(e){e.writeUint32(this.playerFlags),e.writeBinary(this.id),e.writeInt32(this.levelAffected),e.writeInt32(this.availability)}}class Js{version=0;saves=0;editorVersion=0;buildVersion=new Uint32Array(4);name="";author="";description="";recommendedPlayers="";cameraBounds=new Float32Array(8);cameraBoundsComplements=new Int32Array(4);playableSize=new Int32Array(2);flags=0;tileset="A";campaignBackground=0;loadingScreenModel="";loadingScreenText="";loadingScreenTitle="";loadingScreenSubtitle="";loadingScreen=0;prologueScreenModel="";prologueScreenText="";prologueScreenTitle="";prologueScreenSubtitle="";useTerrainFog=0;fogHeight=new Float32Array(2);fogDensity=0;fogColor=new Uint8Array(4);globalWeather=0;soundEnvironment="";lightEnvironmentTileset="\0";waterVertexColor=new Uint8Array(4);scriptMode=0;graphicsMode=0;defaultCameraZoom=0;maxCameraZoom=0;minCameraZoom=0;players=[];forces=[];upgradeAvailabilityChanges=[];techAvailabilityChanges=[];randomUnitTables=[];randomItemTables=[];unknown1=0;load(e){const t=new q(e);this.version=t.readInt32(),this.saves=t.readInt32(),this.editorVersion=t.readInt32(),this.version>27&&t.readUint32Array(this.buildVersion),this.name=t.readNull(),this.author=t.readNull(),this.description=t.readNull(),this.recommendedPlayers=t.readNull(),t.readFloat32Array(this.cameraBounds),t.readInt32Array(this.cameraBoundsComplements),t.readInt32Array(this.playableSize),this.flags=t.readUint32(),this.tileset=t.readBinary(1),this.campaignBackground=t.readInt32(),this.version>24&&(this.loadingScreenModel=t.readNull()),this.loadingScreenText=t.readNull(),this.loadingScreenTitle=t.readNull(),this.loadingScreenSubtitle=t.readNull(),this.loadingScreen=t.readInt32(),this.version>24&&(this.prologueScreenModel=t.readNull()),this.prologueScreenText=t.readNull(),this.prologueScreenTitle=t.readNull(),this.prologueScreenSubtitle=t.readNull(),this.version>24&&(this.useTerrainFog=t.readInt32(),t.readFloat32Array(this.fogHeight),this.fogDensity=t.readFloat32(),t.readUint8Array(this.fogColor),this.globalWeather=t.readInt32(),this.soundEnvironment=t.readNull(),this.lightEnvironmentTileset=t.readBinary(1),t.readUint8Array(this.waterVertexColor)),this.version>27&&(this.scriptMode=t.readUint32()),this.version>30&&(this.graphicsMode=t.readUint32(),this.unknown1=t.readUint32()),this.version>32&&(this.defaultCameraZoom=t.readUint32(),this.maxCameraZoom=t.readUint32(),this.minCameraZoom=t.readUint32());for(let i=0,n=t.readInt32();i<n;i++){const s=new Dl;s.load(t,this.version),this.players[i]=s}for(let i=0,n=t.readInt32();i<n;i++){const s=new Pl;s.load(t),this.forces[i]=s}for(let i=0,n=t.readInt32();i<n;i++){const s=new jl;s.load(t),this.upgradeAvailabilityChanges[i]=s}for(let i=0,n=t.readInt32();i<n;i++){const s=new Gl;s.load(t),this.techAvailabilityChanges[i]=s}for(let i=0,n=t.readInt32();i<n;i++){const s=new Vl;s.load(t),this.randomUnitTables[i]=s}if(this.version>24)for(let i=0,n=t.readInt32();i<n;i++){const s=new Ml;s.load(t),this.randomItemTables[i]=s}}save(){const e=new q(new ArrayBuffer(this.getByteLength()));e.writeInt32(this.version),e.writeInt32(this.saves),e.writeInt32(this.editorVersion),this.version>27&&e.writeUint32Array(this.buildVersion),e.writeNull(this.name),e.writeNull(this.author),e.writeNull(this.description),e.writeNull(this.recommendedPlayers),e.writeFloat32Array(this.cameraBounds),e.writeInt32Array(this.cameraBoundsComplements),e.writeInt32Array(this.playableSize),e.writeUint32(this.flags),e.writeBinary(this.tileset),e.writeInt32(this.campaignBackground),this.version>24&&e.writeNull(this.loadingScreenModel),e.writeNull(this.loadingScreenText),e.writeNull(this.loadingScreenTitle),e.writeNull(this.loadingScreenSubtitle),e.writeInt32(this.loadingScreen),this.version>24&&e.writeNull(this.prologueScreenModel),e.writeNull(this.prologueScreenText),e.writeNull(this.prologueScreenTitle),e.writeNull(this.prologueScreenSubtitle),this.version>24&&(e.writeInt32(this.useTerrainFog),e.writeFloat32Array(this.fogHeight),e.writeFloat32(this.fogDensity),e.writeUint8Array(this.fogColor),e.writeInt32(this.globalWeather),e.writeNull(this.soundEnvironment),e.writeBinary(this.lightEnvironmentTileset),e.writeUint8Array(this.waterVertexColor)),this.version>27&&e.writeUint32(this.scriptMode),this.version>30&&(e.writeUint32(this.graphicsMode),e.writeUint32(this.unknown1)),this.version>32&&(e.writeUint32(this.defaultCameraZoom),e.writeUint32(this.maxCameraZoom),e.writeUint32(this.minCameraZoom)),e.writeUint32(this.players.length);for(const t of this.players)t.save(e,this.version);e.writeUint32(this.forces.length);for(const t of this.forces)t.save(e);e.writeUint32(this.upgradeAvailabilityChanges.length);for(const t of this.upgradeAvailabilityChanges)t.save(e);e.writeUint32(this.techAvailabilityChanges.length);for(const t of this.techAvailabilityChanges)t.save(e);e.writeUint32(this.randomUnitTables.length);for(const t of this.randomUnitTables)t.save(e);if(this.version>24){e.writeUint32(this.randomItemTables.length);for(const t of this.randomItemTables)t.save(e)}return e.uint8array}getByteLength(){let e=111+j(this.name)+j(this.author)+j(this.description)+j(this.recommendedPlayers)+j(this.loadingScreenText)+j(this.loadingScreenTitle)+j(this.loadingScreenSubtitle)+j(this.prologueScreenText)+j(this.prologueScreenTitle)+j(this.prologueScreenSubtitle);for(const t of this.players)e+=t.getByteLength(this.version);for(const t of this.forces)e+=t.getByteLength();e+=this.upgradeAvailabilityChanges.length*16,e+=this.techAvailabilityChanges.length*8;for(const t of this.randomUnitTables)e+=t.getByteLength();if(this.version>24){e+=36+j(this.loadingScreenModel)+j(this.prologueScreenModel)+j(this.soundEnvironment);for(const t of this.randomItemTables)e+=t.getByteLength()}return this.version>27&&(e+=20),this.version>30&&(e+=8),e}getBuildVersion(){return this.buildVersion[0]*100+this.buildVersion[1]}}class Hl{u1=0;name="";flags=0;maxPlayers=0;archive=new yl;imports=new Tl;readonly=!1;load(e,t=!1){const i=new q(e);i.readBinary(4)==="HM3W"&&(this.u1=i.readUint32(),this.name=i.readNull(),this.flags=i.readUint32(),this.maxPlayers=i.readUint32()),this.readonly=t,this.archive.load(e,t),this.readImports()}save(){this.setImportsFile();const e=this.archive.save();if(!e)throw Error("Failed to save the map MPQ archive");const t=this.getMapInformation();if(!t||t.getBuildVersion()<131){const i=new Uint8Array(512+e.byteLength),n=new q(i);return n.writeBinary("HM3W"),n.writeUint32(this.u1),n.writeNull(this.name),n.writeUint32(this.flags),n.writeUint32(this.maxPlayers),i.set(e,512),i}else return e}getFileNames(){return this.archive.getFileNames()}getImportNames(){const e=[];for(const t of this.imports.entries.values()){const i=t.isCustom;i===10||i===13?e.push(t.path):e.push(`war3mapImported\\${t.path}`)}return e}setImportsFile(){return this.readonly?!1:this.imports.entries.size>0?this.set("war3map.imp",this.imports.save()):!1}import(e,t){return this.readonly?!1:this.archive.set(e,t)?(this.imports.set(e),!0):!1}set(e,t){return this.readonly?!1:this.archive.set(e,t)}get(e){return this.archive.get(e)}getScriptFile(){return this.get("war3map.j")||this.get("scripts\\war3map.j")||this.get("war3map.lua")||this.get("scripts\\war3map.lua")}has(e){return this.archive.has(e)}delete(e){return this.readonly?!1:(this.imports.delete(e),this.archive.delete(e))}rename(e,t){return this.readonly?!1:this.archive.rename(e,t)?(this.imports.rename(e,t),!0):!1}getMapInformation(){const e=this.archive.get("war3map.w3i");if(!e)throw new Error("File does not exist");const t=new Js;return t.load(e.bytes()),t}readImports(){const e=this.archive.get("war3map.imp");if(e){const t=e.arrayBuffer();t&&this.imports.load(t)}}readTriggers(e){const t=this.archive.get("war3map.wtg");if(t){const i=t.arrayBuffer();if(i){const n=new Fl;return n.load(i,e),n}}}readCustomTextTriggers(){const e=this.archive.get("war3map.wct");if(e){const t=e.arrayBuffer();if(t){const i=new Il;return i.load(t),i}}}readStringTable(){const e=this.archive.get("war3map.wts");if(e){const t=e.text();if(t){const i=new Ul;return i.load(t),i}}}readModifications(){const e={},t=["w3u","w3t","w3b","w3d","w3a","w3h","w3q"],i=[!1,!1,!1,!0,!0,!1,!0];for(let n=0,s=t.length;n<s;n++){const o=this.archive.get(`war3map.${t[n]}`);if(o){const a=o.arrayBuffer();if(a){let l;i[n]?l=new El:l=new Sl,l.load(a),e[t[n]]=l}}}return e}}class ql{groundHeight=0;waterHeight=0;mapEdge=0;ramp=0;blight=0;water=0;boundary=0;groundTexture=0;cliffVariation=0;groundVariation=0;cliffTexture=0;layerHeight=0;load(e){this.groundHeight=(e.readInt16()-8192)/512;const t=e.readInt16();this.waterHeight=((t&16383)-8192)/512,this.mapEdge=t&16384;const i=e.readUint8();this.ramp=i&16,this.blight=i&32,this.water=i&64,this.boundary=i&128,this.groundTexture=i&15;const n=e.readUint8();this.cliffVariation=(n&224)>>>5,this.groundVariation=n&31;const s=e.readUint8();this.cliffTexture=(s&240)>>>4,this.layerHeight=s&15}save(e){e.writeInt16(this.groundHeight*512+8192),e.writeInt16(this.waterHeight*512+8192+this.mapEdge<<14),e.writeUint8(this.ramp<<4|this.blight<<5|this.water<<6|this.boundary<<7|this.groundTexture),e.writeUint8(this.cliffVariation<<5|this.groundVariation),e.writeUint8((this.cliffTexture<<4)+this.layerHeight)}}class Kl{version=0;tileset="A";haveCustomTileset=0;groundTilesets=[];cliffTilesets=[];mapSize=new Int32Array(2);centerOffset=new Float32Array(2);corners=[];load(e){const t=new q(e);if(t.readBinary(4)==="W3E!"){this.version=t.readInt32(),this.tileset=t.readBinary(1),this.haveCustomTileset=t.readInt32();for(let i=0,n=t.readInt32();i<n;i++)this.groundTilesets[i]=t.readBinary(4);for(let i=0,n=t.readInt32();i<n;i++)this.cliffTilesets[i]=t.readBinary(4);t.readInt32Array(this.mapSize),t.readFloat32Array(this.centerOffset);for(let i=0,n=this.mapSize[1];i<n;i++){this.corners[i]=[];for(let s=0,o=this.mapSize[0];s<o;s++){const a=new ql;a.load(t),this.corners[i][s]=a}}}}save(){const e=new q(new ArrayBuffer(this.getByteLength()));e.writeBinary("W3E!"),e.writeInt32(this.version),e.writeBinary(this.tileset),e.writeInt32(this.haveCustomTileset),e.writeUint32(this.groundTilesets.length);for(const t of this.groundTilesets)e.writeBinary(t);e.writeUint32(this.cliffTilesets.length);for(const t of this.cliffTilesets)e.writeBinary(t);e.writeInt32Array(this.mapSize),e.writeFloat32Array(this.centerOffset);for(const t of this.corners)for(const i of t)i.save(e);return e.uint8array}getByteLength(){return 37+this.groundTilesets.length*4+this.cliffTilesets.length*4+this.mapSize[0]*this.mapSize[1]*7}}const $l={AAAB:1,AAAC:1,AABA:1,AABB:2,AABC:0,AACA:1,AACB:0,AACC:1,ABAA:1,ABAB:1,ABAC:0,ABBA:2,ABBB:1,ABBC:0,ABCA:0,ABCB:0,ABCC:0,ACAA:1,ACAB:0,ACAC:1,ACBA:0,ACBB:0,ACBC:0,ACCA:1,ACCB:0,ACCC:1,BAAA:1,BAAB:1,BAAC:0,BABA:1,BABB:1,BABC:0,BACA:0,BACB:0,BACC:0,BBAA:1,BBAB:1,BBAC:0,BBBA:1,BBCA:0,BCAA:0,BCAB:0,BCAC:0,BCBA:0,BCCA:0,CAAA:1,CAAB:0,CAAC:1,CABA:0,CABB:0,CABC:0,CACA:1,CACB:0,CACC:1,CBAA:0,CBAB:0,CBAC:0,CBBA:0,CBCA:0,CCAA:1,CCAB:0,CCAC:1,CCBA:0,CCCA:1},zl={AAAB:2,AAAC:1,AABA:1,AABB:3,AABC:0,AACA:1,AACB:0,AACC:3,ABAA:1,ABAB:2,ABAC:0,ABBA:3,ABBB:0,ABBC:0,ABCA:0,ABCB:0,ABCC:0,ACAA:1,ACAB:0,ACAC:2,ACBA:0,ACBB:0,ACBC:0,ACCA:3,ACCB:0,ACCC:1,BAAA:1,BAAB:3,BAAC:0,BABA:2,BABB:0,BABC:0,BACA:0,BACB:0,BACC:0,BBAA:3,BBAB:1,BBAC:0,BBBA:1,BBCA:0,BCAA:0,BCAB:0,BCAC:0,BCBA:0,BCCA:0,CAAA:1,CAAB:0,CAAC:3,CABA:0,CABB:0,CABC:0,CACA:2,CACB:0,CACC:1,CBAA:0,CBAB:0,CBAC:0,CBBA:0,CBCA:0,CCAA:3,CCAB:0,CCAC:1,CCBA:0,CCCA:1};function Xl(r,e,t){return r==="Cliffs"?Math.min(t,$l[e]):Math.min(t,zl[e])}class Yl{map;vertexBuffer;faceBuffer;normalsOffset;uvsOffset;elements;locationAndTextureBuffer;texturesOffset;instances;vao;constructor(e,t,i,n,s){const o=e.viewer.gl,a=e.viewer.webgl,l=a.extensions.ANGLE_instanced_arrays,c=a.extensions.OES_vertex_array_object,d=new yt;d.load(t);const h=d.geosets[0],u=h.vertices,p=h.normals,g=h.uvSets[0],v=h.faces,b=u.byteLength,w=b+p.byteLength;let m=null;const E=s.attribs;c&&(m=c.createVertexArrayOES(),c.bindVertexArrayOES(m));const x=o.createBuffer();o.bindBuffer(o.ARRAY_BUFFER,x),o.bufferData(o.ARRAY_BUFFER,w+g.byteLength,o.STATIC_DRAW),o.bufferSubData(o.ARRAY_BUFFER,0,u),o.bufferSubData(o.ARRAY_BUFFER,b,p),o.bufferSubData(o.ARRAY_BUFFER,w,g),c&&(o.vertexAttribPointer(E.a_position,3,o.FLOAT,!1,0,0),o.enableVertexAttribArray(E.a_position),o.vertexAttribPointer(E.a_normal,3,o.FLOAT,!1,0,b),o.enableVertexAttribArray(E.a_normal),o.vertexAttribPointer(E.a_uv,2,o.FLOAT,!1,0,w),o.enableVertexAttribArray(E.a_uv));const y=i.length*4,A=o.createBuffer();o.bindBuffer(o.ARRAY_BUFFER,A),o.bufferData(o.ARRAY_BUFFER,y+n.length,o.STATIC_DRAW),o.bufferSubData(o.ARRAY_BUFFER,0,new Float32Array(i)),o.bufferSubData(o.ARRAY_BUFFER,y,new Uint8Array(n)),c&&(o.vertexAttribPointer(E.a_instancePosition,3,o.FLOAT,!1,0,0),o.enableVertexAttribArray(E.a_instancePosition),l.vertexAttribDivisorANGLE(E.a_instancePosition,1),o.vertexAttribPointer(E.a_instanceTexture,1,o.UNSIGNED_BYTE,!1,0,y),o.enableVertexAttribArray(E.a_instanceTexture),l.vertexAttribDivisorANGLE(E.a_instanceTexture,1));const U=o.createBuffer();o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,U),o.bufferData(o.ELEMENT_ARRAY_BUFFER,v,o.STATIC_DRAW),c&&c.bindVertexArrayOES(null),this.map=e,this.vertexBuffer=x,this.faceBuffer=U,this.normalsOffset=b,this.uvsOffset=w,this.elements=v.length,this.locationAndTextureBuffer=A,this.texturesOffset=y,this.instances=i.length/3,this.vao=m}render(e){const t=this.map.viewer,i=t.gl,n=t.webgl,s=n.extensions.ANGLE_instanced_arrays,o=n.extensions.OES_vertex_array_object,a=e.attribs;o?o.bindVertexArrayOES(this.vao):(i.bindBuffer(i.ARRAY_BUFFER,this.locationAndTextureBuffer),i.vertexAttribPointer(a.a_instancePosition,3,i.FLOAT,!1,0,0),i.vertexAttribPointer(a.a_instanceTexture,1,i.UNSIGNED_BYTE,!1,0,this.texturesOffset),i.bindBuffer(i.ARRAY_BUFFER,this.vertexBuffer),i.vertexAttribPointer(a.a_position,3,i.FLOAT,!1,0,0),i.vertexAttribPointer(a.a_normal,3,i.FLOAT,!1,0,this.normalsOffset),i.vertexAttribPointer(a.a_uv,2,i.FLOAT,!1,0,this.uvsOffset),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this.faceBuffer)),s.drawElementsInstancedANGLE(i.TRIANGLES,this.elements,i.UNSIGNED_SHORT,0,this.instances),o&&o.bindVertexArrayOES(null)}}function Wl(r,e){return r.sequence.rarity-e.sequence.rarity}function Zl(r,e){const t=[];for(let i=0,n=e.length;i<n;i++){const s=e[i];s.name.split("-")[0].replace(/\d/g,"").trim().toLowerCase()===r&&t.push({sequence:s,index:i})}return t}function Ql(r,e){const t=Zl(r,e);let i,n;for(t.sort(Wl),i=0,n=t.length;i<n;i++){const c=t[i].sequence.rarity;if(c===0)break;if(Math.random()*10>c)return t[i]}const s=t.length-i,o=i+Math.floor(Math.random()*s);return t[o]}function Jl(r){const t=r.model.sequences,i=Ql("stand",t);i&&r.setSequence(i.index)}class er{instance;state=0;constructor(e,t){this.instance=t.addInstance(),this.instance.setScene(e.worldScene)}update(){(this.instance.sequenceEnded||this.instance.sequence===-1)&&this.state===0&&Jl(this.instance)}}const tr=f.vec3.create();let ec=class extends er{row;constructor(e,t,i,n){super(e,t);const s=this.instance;s.move(n.location),s.rotateLocal(f.quat.setAxisAngle(f.quat.create(),Be,n.angle)),s.scale(n.scale),s.setTeamColor(n.player),s.setScene(e.worldScene),i&&(tr[2]=i.number("moveHeight"),s.move(tr),s.setVertexColor([i.number("red")/255,i.number("green")/255,i.number("blue")/255,1]),s.uniformScale(i.number("modelScale"))),this.instance=s,this.row=i}},tc=class extends er{row;constructor(e,t,i,n){super(e,t);const s=this.instance;s.move(n.location),s.rotateLocal(f.quat.setAxisAngle(f.quat.create(),Be,n.angle)),s.scale(n.scale),s.setScene(e.worldScene),this.instance=s,this.row=i}};const yi=f.vec3.create();let ic=class{instance;row;constructor(e,t,i,n){const s=e.centerOffset,o=t.addInstance();yi[0]=n.location[0]*128+s[0]+128,yi[1]=n.location[1]*128+s[1]+128,o.move(yi),o.rotateLocal(f.quat.setAxisAngle(f.quat.create(),Be,Di(i.number("fixedRot")))),o.setScene(e.worldScene),this.instance=o,this.row=i}};class nc{id="\0\0\0\0";chance=0;load(e){this.id=e.readBinary(4),this.chance=e.readInt32()}save(e){e.writeBinary(this.id),e.writeInt32(this.chance)}}class sc{items=[];load(e){for(let t=0,i=e.readUint32();t<i;t++){const n=new nc;n.load(e),this.items.push(n)}}save(e){e.writeUint32(this.items.length);for(const t of this.items)t.save(e)}getByteLength(){return 4+this.items.length*8}}class rc{id="\0\0\0\0";variation=0;location=new Float32Array(3);angle=0;scale=new Float32Array([1,1,1]);skin="\0\0\0\0";flags=0;life=0;itemTable=-1;itemSets=[];editorId=0;u1=new Uint8Array(8);load(e,t,i){if(this.id=e.readBinary(4),this.variation=e.readInt32(),e.readFloat32Array(this.location),this.angle=e.readFloat32(),e.readFloat32Array(this.scale),i>131&&(this.skin=e.readBinary(4)),this.flags=e.readUint8(),this.life=e.readUint8(),t>7){this.itemTable=e.readUint32();for(let n=0,s=e.readUint32();n<s;n++){const o=new sc;o.load(e),this.itemSets.push(o)}}this.editorId=e.readInt32()}save(e,t,i){if(e.writeBinary(this.id),e.writeInt32(this.variation),e.writeFloat32Array(this.location),e.writeFloat32(this.angle),e.writeFloat32Array(this.scale),i>131&&e.writeBinary(this.skin),e.writeUint8(this.flags),e.writeUint8(this.life),t>7){e.writeUint32(this.itemTable),e.writeUint32(this.itemSets.length);for(const n of this.itemSets)n.save(e)}e.writeInt32(this.editorId)}getByteLength(e,t){let i=42;if(t>131&&(i+=4),e>7){i+=8;for(const n of this.itemSets)i+=n.getByteLength()}return i}}class oc{id="\0\0\0\0";u1=0;location=new Uint32Array(2);load(e,t){this.id=e.readBinary(4),this.u1=e.readUint32(),e.readUint32Array(this.location)}save(e,t){e.writeBinary(this.id),e.writeUint32(this.u1),e.writeUint32Array(this.location)}}class ac{version=0;u1=new Uint8Array(4);doodads=[];u2=new Uint8Array(4);terrainDoodads=[];load(e,t){const i=new q(e);if(i.readBinary(4)!=="W3do")throw new Error("Not a valid war3map.doo buffer");this.version=i.readInt32(),i.readUint8Array(this.u1);for(let n=0,s=i.readInt32();n<s;n++){const o=new rc;o.load(i,this.version,t),this.doodads.push(o)}i.readUint8Array(this.u2);for(let n=0,s=i.readInt32();n<s;n++){const o=new oc;o.load(i,this.version),this.terrainDoodads.push(o)}}save(e){const t=new q(new ArrayBuffer(this.getByteLength(e)));t.writeBinary("W3do"),t.writeInt32(this.version),t.writeUint8Array(this.u1),t.writeUint32(this.doodads.length);for(const i of this.doodads)i.save(t,this.version,e);t.writeUint8Array(this.u2),t.writeUint32(this.terrainDoodads.length);for(const i of this.terrainDoodads)i.save(t,this.version);return t.uint8array}getByteLength(e){let t=24+this.terrainDoodads.length*16;for(const i of this.doodads)t+=i.getByteLength(this.version,e);return t}}class lc{id="\0\0\0\0";chance=0;load(e){this.id=e.readBinary(4),this.chance=e.readInt32()}save(e){e.writeBinary(this.id),e.writeInt32(this.chance)}}class cc{items=[];load(e){for(let t=0,i=e.readInt32();t<i;t++){const n=new lc;n.load(e),this.items[t]=n}}save(e){e.writeInt32(this.items.length);for(const t of this.items)t.save(e)}getByteLength(){return 4+this.items.length*8}}class hc{slot=0;id="\0\0\0\0";load(e){this.slot=e.readInt32(),this.id=e.readBinary(4)}save(e){e.writeInt32(this.slot),e.writeBinary(this.id)}}class dc{id="\0\0\0\0";activeForAutocast=0;heroLevel=1;load(e){this.id=e.readBinary(4),this.activeForAutocast=e.readInt32(),this.heroLevel=e.readInt32()}save(e){e.writeBinary(this.id),e.writeInt32(this.activeForAutocast),e.writeInt32(this.heroLevel)}}class fc{id="\0\0\0\0";chance=0;load(e){this.id=e.readBinary(4),this.chance=e.readInt32()}save(e){e.writeBinary(this.id),e.writeInt32(this.chance)}}class uc{id="\0\0\0\0";variation=0;location=new Float32Array(3);angle=0;scale=new Float32Array([1,1,1]);skin="\0\0\0\0";flags=0;player=0;unknown=0;hitpoints=-1;mana=-1;droppedItemTable=0;droppedItemSets=[];goldAmount=0;targetAcquisition=0;heroLevel=0;heroStrength=0;heroAgility=0;heroIntelligence=0;itemsInInventory=[];modifiedAbilities=[];randomFlag=0;level=new Uint8Array(3);itemClass=0;unitGroup=0;positionInGroup=0;randomUnitTables=[];customTeamColor=0;waygate=0;creationNumber=0;load(e,t,i,n){this.id=e.readBinary(4),this.variation=e.readInt32(),e.readFloat32Array(this.location),this.angle=e.readFloat32(),e.readFloat32Array(this.scale),n>131&&(this.skin=e.readBinary(4)),this.flags=e.readUint8(),this.player=e.readInt32(),this.unknown=e.readUint16(),this.hitpoints=e.readInt32(),this.mana=e.readInt32(),i>10&&(this.droppedItemTable=e.readInt32());for(let s=0,o=e.readInt32();s<o;s++){const a=new cc;a.load(e),this.droppedItemSets[s]=a}this.goldAmount=e.readInt32(),this.targetAcquisition=e.readFloat32(),this.heroLevel=e.readInt32(),i>10&&(this.heroStrength=e.readInt32(),this.heroAgility=e.readInt32(),this.heroIntelligence=e.readInt32());for(let s=0,o=e.readInt32();s<o;s++){const a=new hc;a.load(e),this.itemsInInventory[s]=a}for(let s=0,o=e.readInt32();s<o;s++){const a=new dc;a.load(e),this.modifiedAbilities[s]=a}if(this.randomFlag=e.readInt32(),this.randomFlag===0)e.readUint8Array(this.level),this.itemClass=e.readUint8();else if(this.randomFlag===1)this.unitGroup=e.readUint32(),this.positionInGroup=e.readUint32();else if(this.randomFlag===2)for(let s=0,o=e.readInt32();s<o;s++){const a=new fc;a.load(e),this.randomUnitTables[s]=a}this.customTeamColor=e.readInt32(),this.waygate=e.readInt32(),this.creationNumber=e.readInt32()}save(e,t,i,n){e.writeBinary(this.id),e.writeInt32(this.variation),e.writeFloat32Array(this.location),e.writeFloat32(this.angle),e.writeFloat32Array(this.scale),n>131&&e.writeBinary(this.skin),e.writeUint8(this.flags),e.writeInt32(this.player),e.writeUint16(this.unknown),e.writeInt32(this.hitpoints),e.writeInt32(this.mana),i>10&&e.writeInt32(this.droppedItemTable),e.writeInt32(this.droppedItemSets.length);for(const s of this.droppedItemSets)s.save(e);e.writeInt32(this.goldAmount),e.writeFloat32(this.targetAcquisition),e.writeInt32(this.heroLevel),i>10&&(e.writeInt32(this.heroStrength),e.writeInt32(this.heroAgility),e.writeInt32(this.heroIntelligence)),e.writeInt32(this.itemsInInventory.length);for(const s of this.itemsInInventory)s.save(e);e.writeInt32(this.modifiedAbilities.length);for(const s of this.modifiedAbilities)s.save(e);if(e.writeInt32(this.randomFlag),this.randomFlag===0)e.writeUint8Array(this.level),e.writeUint8(this.itemClass);else if(this.randomFlag===1)e.writeUint32(this.unitGroup),e.writeUint32(this.positionInGroup);else if(this.randomFlag===2){e.writeInt32(this.randomUnitTables.length);for(const s of this.randomUnitTables)s.save(e)}e.writeInt32(this.customTeamColor),e.writeInt32(this.waygate),e.writeInt32(this.creationNumber)}getByteLength(e,t,i){let n=91;i>131&&(n+=4),t>10&&(n+=16);for(const s of this.droppedItemSets)n+=s.getByteLength();return n+=this.itemsInInventory.length*8,n+=this.modifiedAbilities.length*12,this.randomFlag===0?n+=4:this.randomFlag===1?n+=8:this.randomFlag===2&&(n+=4+this.randomUnitTables.length*8),n}}class pc{version=8;subversion=11;units=[];load(e,t){const i=new q(e);if(i.readBinary(4)!=="W3do")throw new Error("Not a valid war3mapUnits.doo buffer");this.version=i.readInt32(),this.subversion=i.readUint32();for(let n=0,s=i.readInt32();n<s;n++){const o=new uc;o.load(i,this.version,this.subversion,t),this.units[n]=o}}save(e){const t=new q(new ArrayBuffer(this.getByteLength(e)));t.writeBinary("W3do"),t.writeInt32(this.version),t.writeUint32(this.subversion),t.writeInt32(this.units.length);for(const i of this.units)i.save(t,this.version,this.subversion,e);return t.uint8array}getByteLength(e){let t=16;for(const i of this.units)t+=i.getByteLength(this.version,this.subversion,e);return t}}const Ti=f.vec3.create(),xi=f.vec3.create();class gc{viewer;map;pathSolver;buildVersion=0;solverParams={tileset:"a"};worldScene;waterIndex=0;waterIncreasePerFrame=0;waterHeightOffset=0;waterTextures=[];maxDeepColor=new Float32Array(4);minDeepColor=new Float32Array(4);maxShallowColor=new Float32Array(4);minShallowColor=new Float32Array(4);anyReady=!1;terrainReady=!1;cliffsReady=!1;doodads=[];terrainDoodads=[];doodadsReady=!1;units=[];unitsReady=!1;tilesetTextures=[];cliffTextures=[];cliffModels=[];corners=[];centerOffset=new Float32Array(2);mapSize=new Int32Array(2);tilesets=[];blightTextureIndex=-1;cliffTilesets=[];columns=0;rows=0;vertexBuffer=null;faceBuffer=null;instanceBuffer=null;textureBuffer=null;variationBuffer=null;waterBuffer=null;heightMap=null;waterHeightMap=null;cliffHeightMap=null;constructor(e,t){this.viewer=e,this.worldScene=e.addScene(),this.map=new Hl,this.map.load(t,!0),this.loadMapInformation(),this.pathSolver=(n,s)=>{if(typeof n=="string"){const o=n.replace(/\//g,"\\"),a=this.map.get(o);return a?a.arrayBuffer():e.wc3PathSolver(n,s)}return n},this.loadTerrainCliffsAndWater();const i=this.map.readModifications();this.applyModificationFile(e.doodadsData,e.doodadMetaData,i.w3d),this.applyModificationFile(e.doodadsData,e.destructableMetaData,i.w3b),this.applyModificationFile(e.unitsData,e.unitMetaData,i.w3u),this.applyModificationFile(e.unitsData,e.unitMetaData,i.w3t),this.loadDoodadsAndDestructibles(),this.loadUnitsAndItems()}die(){this.worldScene.detach()}load(e){return this.viewer.load(e,this.pathSolver,this.solverParams)}loadMapInformation(){const e=this.map.get("war3map.w3i");if(!e){console.warn("Attempted to load war3map.w3i but it is not there. Using default tileset A.");return}const t=new Js;try{t.load(e.bytes())}catch{console.warn("Failed to correctly parse the map information file")}this.solverParams.tileset=t.tileset.toLowerCase(),this.buildVersion=t.getBuildVersion(),this.buildVersion>131&&(this.solverParams.reforged=!0)}async loadTerrainCliffsAndWater(){const e=this.map.get("war3map.w3e");if(!e){console.warn("Attempted to load war3map.w3e, but it is not there.");return}const t=new Kl;try{t.load(e.bytes())}catch(B){console.warn(`Failed to load war3map.w3e: ${B}`);return}const i=this.viewer,n=t.centerOffset,s=t.mapSize;this.corners=t.corners,this.centerOffset.set(n),this.mapSize.set(s),this.worldScene.grid=new Pi(n[0],n[1],s[0]*128-128,s[1]*128-128,2048,2048);const o=this.solverParams.reforged?".dds":".blp",a=t.tileset,l=[],c=[],d=[];for(const B of t.groundTilesets){const _=i.terrainData.getRow(B);this.tilesets.push(_),l.push(this.load(`${_.string("dir")}\\${_.string("file")}${o}`))}const h={A:"Ashen",B:"Barrens",C:"Felwood",D:"Cave",F:"Lordf",G:"Dungeon",I:"Ice",J:"DRuins",K:"Citadel",L:"Lords",N:"North",O:"Outland",Q:"VillageFall",V:"Village",W:"Lordw",X:"Village",Y:"Village",Z:"Ruins"};this.blightTextureIndex=this.tilesetTextures.length,l.push(this.load(`TerrainArt\\Blight\\${h[a]}_Blight${o}`));for(const B of t.cliffTilesets){const _=i.cliffTypesData.getRow(B);this.cliffTilesets.push(_),c.push(this.load(`${_.string("texDir")}\\${_.string("texFile")}${o}`))}const u=i.waterData.getRow(`${a}Sha`);this.waterHeightOffset=u.number("height"),this.waterIncreasePerFrame=u.number("texRate")/60,this.waterTextures.length=0,this.maxDeepColor.set([u.number("Dmax_R"),u.number("Dmax_G"),u.number("Dmax_B"),u.number("Dmax_A")]),this.minDeepColor.set([u.number("Dmin_R"),u.number("Dmin_G"),u.number("Dmin_B"),u.number("Dmin_A")]),this.maxShallowColor.set([u.number("Smax_R"),u.number("Smax_G"),u.number("Smax_B"),u.number("Smax_A")]),this.minShallowColor.set([u.number("Smin_R"),u.number("Smin_G"),u.number("Smin_B"),u.number("Smin_A")]);for(let B=0,_=u.number("numTex");B<_;B++)d.push(this.load(`${u.string("texFile")}${B<10?"0":""}${B}${o}`));this.tilesetTextures=await Promise.all(l),this.cliffTextures=await Promise.all(c),this.waterTextures=await Promise.all(d);const p=t.corners,[g,v]=this.mapSize,b=(g-1)*(v-1),w=new Float32Array(g*v),m=new Float32Array(g*v),E=new Float32Array(g*v),x=new Uint8Array(b*4),y=new Uint8Array(b*4),A=new Uint8Array(b);let U=0;const G={};this.columns=g-1,this.rows=v-1;for(let B=0;B<v;B++)for(let _=0;_<g;_++){const N=p[B][_],C=B*g+_;if(w[C]=N.groundHeight,m[C]=N.groundHeight+N.layerHeight-2,E[C]=N.waterHeight,B<v-1&&_<g-1){if(A[U]=this.isWater(_,B),this.isCliff(_,B)){const F=N.layerHeight,O=p[B][_+1].layerHeight,P=p[B+1][_].layerHeight,K=p[B+1][_+1].layerHeight,W=Math.min(F,O,P,K),$=this.cliffFileName(F,O,P,K,W);if($!=="AAAA"){let S=N.cliffTexture;S===15&&(S=1);const V=this.cliffTilesets[S].string("cliffModelDir"),te=`Doodads\\Terrain\\${V}\\${V}${$}${Xl(V,$,N.cliffVariation)}.mdx`;G[te]||(G[te]={locations:[],textures:[]}),G[te].locations.push((_+1)*128+n[0],B*128+n[1],(W-2)*128),G[te].textures.push(S)}}else{const F=this.cornerTexture(_,B),O=this.cornerTexture(_+1,B),P=this.cornerTexture(_,B+1),K=this.cornerTexture(_+1,B+1),W=Ya([F,O,P,K]).sort();let $=W[0];x[U*4]=$+1,y[U*4]=this.getVariation($,N.groundVariation),W.shift();for(let S=0,L=W.length;S<L;S++){let V=0;$=W[S],O===$&&(V|=1),F===$&&(V|=2),K===$&&(V|=4),P===$&&(V|=8),x[U*4+1+S]=$+1,y[U*4+1+S]=V}}U+=1}}const T=this.viewer.gl,H=this.viewer.webgl;this.vertexBuffer=T.createBuffer(),T.bindBuffer(T.ARRAY_BUFFER,this.vertexBuffer),T.bufferData(T.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,1,1]),T.STATIC_DRAW),this.faceBuffer=T.createBuffer(),T.bindBuffer(T.ELEMENT_ARRAY_BUFFER,this.faceBuffer),T.bufferData(T.ELEMENT_ARRAY_BUFFER,new Uint8Array([0,1,2,1,3,2]),T.STATIC_DRAW),this.cliffHeightMap=T.createTexture(),T.bindTexture(T.TEXTURE_2D,this.cliffHeightMap),H.setTextureMode(T.CLAMP_TO_EDGE,T.CLAMP_TO_EDGE,T.NEAREST,T.NEAREST),T.texImage2D(T.TEXTURE_2D,0,T.ALPHA,g,v,0,T.ALPHA,T.FLOAT,w),this.heightMap=T.createTexture(),T.bindTexture(T.TEXTURE_2D,this.heightMap),H.setTextureMode(T.CLAMP_TO_EDGE,T.CLAMP_TO_EDGE,T.NEAREST,T.NEAREST),T.texImage2D(T.TEXTURE_2D,0,T.ALPHA,g,v,0,T.ALPHA,T.FLOAT,m),this.waterHeightMap=T.createTexture(),T.bindTexture(T.TEXTURE_2D,this.waterHeightMap),H.setTextureMode(T.CLAMP_TO_EDGE,T.CLAMP_TO_EDGE,T.NEAREST,T.NEAREST),T.texImage2D(T.TEXTURE_2D,0,T.ALPHA,g,v,0,T.ALPHA,T.FLOAT,E),this.instanceBuffer=T.createBuffer(),T.bindBuffer(T.ARRAY_BUFFER,this.instanceBuffer),T.bufferData(T.ARRAY_BUFFER,new Float32Array(b).map((B,_)=>_),T.STATIC_DRAW),this.textureBuffer=T.createBuffer(),T.bindBuffer(T.ARRAY_BUFFER,this.textureBuffer),T.bufferData(T.ARRAY_BUFFER,x,T.STATIC_DRAW),this.variationBuffer=T.createBuffer(),T.bindBuffer(T.ARRAY_BUFFER,this.variationBuffer),T.bufferData(T.ARRAY_BUFFER,y,T.STATIC_DRAW),this.waterBuffer=T.createBuffer(),T.bindBuffer(T.ARRAY_BUFFER,this.waterBuffer),T.bufferData(T.ARRAY_BUFFER,A,T.STATIC_DRAW),this.terrainReady=!0,this.anyReady=!0;const re=i.cliffShader,z=Object.entries(G).map(async B=>{const _=B[0],{locations:N,textures:C}=B[1],F=await i.loadBaseFile(_,"arrayBuffer");if(F)return new Yl(this,F.data,N,C,re)}).filter(B=>B);this.cliffModels=await Promise.all(z),this.cliffsReady=!0}loadDoodadsAndDestructibles(){const e=this.map.get("war3map.doo");if(!e){console.warn("Attempted to load war3map.doo but it is not there");return}const t=new ac;try{t.load(e.bytes(),this.buildVersion)}catch(i){console.warn(`Failed to load war3map.doo: ${i}`);return}for(const i of t.doodads)try{const n=this.viewer.doodadsData.getRow(i.id);if(n){let s=n.string("file");if(s){const o=n.number("numVar");s.endsWith(".mdl")&&(s=s.slice(0,-4));let a=s;s+=".mdx",o>1&&(a+=Math.min(i.variation,o-1)),a+=".mdx";const l=this.map.get(a)||this.map.get(s);let c;l?c=this.load(l.name):c=this.load(a),c.then(d=>{d&&this.doodads.push(new tc(this,d,n,i))})}else console.log("Unknown doodad ID",i.id,i)}}catch(n){console.warn(`Failed to load doodad/destructible ID ${i.id}: ${n}`)}for(const i of t.terrainDoodads)try{const n=this.viewer.doodadsData.getRow(i.id);this.load(`${n.string("file")}.mdx`).then(s=>{s&&this.terrainDoodads.push(new ic(this,s,n,i))})}catch(n){console.warn(`Failed to load cliff/terrain doodad ID ${i.id}: ${n}`)}this.doodadsReady=!0,this.anyReady=!0}loadUnitsAndItems(){const e=this.map.get("war3mapUnits.doo");if(!e){console.warn("Attempted to load war3mapUnits.doo but it is not there");return}const t=new pc;try{t.load(e.bytes(),this.buildVersion)}catch(i){console.warn(`Failed to load war3mapUnits.doo: ${i}`);return}for(const i of t.units)try{let n,s;i.id==="sloc"?s="Objects\\StartLocation\\StartLocation.mdx":(n=this.viewer.unitsData.getRow(i.id),n&&(s=n.string("file"),s&&(s.endsWith(".mdl")&&(s=s.slice(0,-4)),s+=".mdx"))),s?this.load(s).then(o=>{o&&this.units.push(new ec(this,o,n,i))}):console.log("Unknown unit ID",i.id,i)}catch(n){console.warn(`Failed to load unit/item ID ${i.id}: ${n}`)}this.unitsReady=!0,this.anyReady=!0}update(){if(this.anyReady){this.waterIndex+=this.waterIncreasePerFrame,this.waterIndex>=this.waterTextures.length&&(this.waterIndex=0);for(const e of this.doodads)e.update();for(const e of this.units)e.update()}}render(){if(this.anyReady){const e=this.worldScene;e.startFrame(),this.renderGround(),this.renderCliffs(),e.renderOpaque(),this.renderWater(),e.renderTranslucent()}}renderGround(){if(this.terrainReady){const e=this.viewer.gl,t=this.viewer.webgl,i=t.extensions.ANGLE_instanced_arrays,n=this.viewer.groundShader,s=n.uniforms,o=n.attribs,a=this.tilesetTextures,l=o.a_InstanceID,c=o.a_position,d=o.a_textures,h=o.a_variations,u=a.length;e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),t.useShader(n),e.uniformMatrix4fv(s.u_VP,!1,this.worldScene.camera.viewProjectionMatrix),e.uniform2fv(s.u_offset,this.centerOffset),e.uniform2f(s.u_size,this.columns,this.rows),e.uniform1i(s.u_heightMap,15),e.activeTexture(e.TEXTURE15),e.bindTexture(e.TEXTURE_2D,this.heightMap),e.bindBuffer(e.ARRAY_BUFFER,this.vertexBuffer),e.vertexAttribPointer(c,2,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,this.instanceBuffer),e.vertexAttribPointer(l,1,e.FLOAT,!1,0,0),i.vertexAttribDivisorANGLE(l,1),e.bindBuffer(e.ARRAY_BUFFER,this.textureBuffer),e.vertexAttribPointer(d,4,e.UNSIGNED_BYTE,!1,0,0),i.vertexAttribDivisorANGLE(d,1),e.bindBuffer(e.ARRAY_BUFFER,this.variationBuffer),e.vertexAttribPointer(h,4,e.UNSIGNED_BYTE,!1,0,0),i.vertexAttribDivisorANGLE(h,1),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.faceBuffer),e.uniform1f(s.u_baseTileset,0);for(let p=0,g=Math.min(u,15);p<g;p++){const v=a[p].width>a[p].height?1:0;e.uniform1f(s[`u_extended[${p}]`],v),e.uniform1i(s[`u_tilesets[${p}]`],p),t.bindTexture(a[p],p)}if(i.drawElementsInstancedANGLE(e.TRIANGLES,6,e.UNSIGNED_BYTE,0,this.rows*this.columns),u>15){e.uniform1f(s.u_baseTileset,15);for(let p=0,g=u-15;p<g;p++){const v=a[p+15].width>a[p+15].height?1:0;e.uniform1f(s[`u_extended[${p}]`],v),t.bindTexture(a[p+15],p)}i.drawElementsInstancedANGLE(e.TRIANGLES,6,e.UNSIGNED_BYTE,0,this.rows*this.columns)}i.vertexAttribDivisorANGLE(d,0),i.vertexAttribDivisorANGLE(h,0),i.vertexAttribDivisorANGLE(l,0)}}renderWater(){if(this.terrainReady){const e=this.viewer.gl,t=this.viewer.webgl,i=t.extensions.ANGLE_instanced_arrays,n=this.viewer.waterShader,s=n.uniforms,o=n.attribs,a=o.a_InstanceID,l=o.a_position,c=o.a_isWater;e.depthMask(!1),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),t.useShader(n),e.uniformMatrix4fv(s.u_VP,!1,this.worldScene.camera.viewProjectionMatrix),e.uniform2fv(s.u_offset,this.centerOffset),e.uniform2f(s.u_size,this.columns,this.rows),e.uniform1i(s.u_heightMap,0),e.uniform1i(s.u_waterHeightMap,1),e.uniform1i(s.u_waterTexture,2),e.uniform1f(s.u_offsetHeight,this.waterHeightOffset),e.uniform4fv(s.u_maxDeepColor,this.maxDeepColor),e.uniform4fv(s.u_minDeepColor,this.minDeepColor),e.uniform4fv(s.u_maxShallowColor,this.maxShallowColor),e.uniform4fv(s.u_minShallowColor,this.minShallowColor),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.heightMap),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this.waterHeightMap),t.bindTexture(this.waterTextures[this.waterIndex|0],2),e.bindBuffer(e.ARRAY_BUFFER,this.vertexBuffer),e.vertexAttribPointer(l,2,e.FLOAT,!1,8,0),e.bindBuffer(e.ARRAY_BUFFER,this.instanceBuffer),e.vertexAttribPointer(a,1,e.FLOAT,!1,4,0),i.vertexAttribDivisorANGLE(a,1),e.bindBuffer(e.ARRAY_BUFFER,this.waterBuffer),e.vertexAttribPointer(c,1,e.UNSIGNED_BYTE,!1,1,0),i.vertexAttribDivisorANGLE(c,1),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.faceBuffer),i.drawElementsInstancedANGLE(e.TRIANGLES,6,e.UNSIGNED_BYTE,0,this.rows*this.columns),i.vertexAttribDivisorANGLE(c,0),i.vertexAttribDivisorANGLE(a,0)}}renderCliffs(){if(this.cliffsReady){const e=this.viewer.gl,t=this.viewer.webgl,i=t.extensions.ANGLE_instanced_arrays,n=t.extensions.OES_vertex_array_object,s=this.viewer.cliffShader,o=s.attribs,a=s.uniforms;e.disable(e.BLEND),s.use(),e.uniformMatrix4fv(a.u_VP,!1,this.worldScene.camera.viewProjectionMatrix),e.uniform1i(a.u_heightMap,0),e.uniform2f(a.u_pixel,1/(this.columns+1),1/(this.rows+1)),e.uniform2fv(a.u_centerOffset,this.centerOffset),e.uniform1i(a.u_texture1,1),e.uniform1i(a.u_texture2,2),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.cliffHeightMap),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this.cliffTextures[0].webglResource),this.cliffTextures.length>1&&(e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,this.cliffTextures[1].webglResource)),n||(i.vertexAttribDivisorANGLE(o.a_instancePosition,1),i.vertexAttribDivisorANGLE(o.a_instanceTexture,1));for(const l of this.cliffModels)l.render(s);n||(i.vertexAttribDivisorANGLE(o.a_instancePosition,0),i.vertexAttribDivisorANGLE(o.a_instanceTexture,0))}}cliffFileName(e,t,i,n,s){return String.fromCharCode(65+e-s)+String.fromCharCode(65+i-s)+String.fromCharCode(65+n-s)+String.fromCharCode(65+t-s)}getVariation(e,t){const i=this.tilesetTextures[e];return i.width>i.height?t<16?16+t:t===16?15:0:t===0?0:15}isCliff(e,t){if(e<1||e>this.columns-1||t<1||t>this.rows-1)return!1;const i=this.corners,n=i[t][e].layerHeight,s=i[t][e+1].layerHeight,o=i[t+1][e].layerHeight,a=i[t+1][e+1].layerHeight;return n!==s||n!==o||n!==a}isWater(e,t){const i=this.corners;return i[t][e].water||i[t][e+1].water||i[t+1][e].water||i[t+1][e+1].water}cliffGroundIndex(e){const t=this.cliffTilesets[e].string("groundTile"),i=this.tilesets;for(let n=0,s=i.length;n<s;n++)if(i[n].string("tileID")===t)return n;return 0}cornerTexture(e,t){const i=this.corners,n=this.columns,s=this.rows;for(let a=-1;a<1;a++)for(let l=-1;l<1;l++)if(e+l>0&&e+l<n-1&&t+a>0&&t+a<s-1&&this.isCliff(e+l,t+a)){let c=i[t+a][e+l].cliffTexture;return c===15&&(c=1),this.cliffGroundIndex(c)}const o=i[t][e];return o.blight?this.blightTextureIndex:o.groundTexture}applyModificationFile(e,t,i){i&&(this.applyModificationTable(e,t,i.originalTable),this.applyModificationTable(e,t,i.customTable))}applyModificationTable(e,t,i){for(const n of i.objects){let s;n.newId!==""?(s=e.getRow(n.newId),s||(s=new $t,s.map=Object.assign({},e.getRow(n.oldId).map),e.setRow(n.newId,s))):s=e.getRow(n.oldId);for(const o of n.modifications){const a=t.getRow(o.id);a?s.set(a.string("field"),o.value):console.warn("Unknown modification ID",o)}}}groundNormal(e,t,i){const n=this.centerOffset,s=this.mapSize;t=(t-n[0])/128,i=(i-n[1])/128;const o=t|0,a=i|0;if(o>=0&&o<s[0]-1&&a>=0&&a<s[1]-1){const l=this.corners,c=l[a][o].groundHeight,d=l[a][o+1].groundHeight,h=l[a+1][o].groundHeight,u=l[a+1][o+1].groundHeight,p=t-o,g=i-a;p+g<1?(f.vec3.set(Ti,1,0,d-c),f.vec3.set(xi,0,1,h-c)):(f.vec3.set(Ti,-1,0,u-h),f.vec3.set(xi,0,1,u-d)),f.vec3.normalize(e,f.vec3.cross(e,Ti,xi))}else f.vec3.set(e,0,0,1);return e}}class vc extends Or{wc3PathSolver;isReforged;groundShader;waterShader;cliffShader;terrainData=new xe;cliffTypesData=new xe;waterData=new xe;doodadsData=new xe;doodadMetaData=new xe;destructableMetaData=new xe;unitsData=new xe;unitMetaData=new xe;loadedBaseFiles=!1;map=null;constructor(e,t,i){super(e);const n=this.webgl;if(!n.ensureExtension("OES_texture_float"))throw new Error("War3MapViewer: No float texture support!");n.ensureExtension("OES_vertex_array_object")||console.warn("War3MapViewer: No vertex array object support! This might reduce performance."),this.on("error",s=>console.log(s)),this.addHandler(Bt,t,i),this.addHandler(ya),this.addHandler(_a),this.addHandler(ja),this.wc3PathSolver=t,this.isReforged=i,this.groundShader=this.webgl.createShader(Ha,qa),this.waterShader=this.webgl.createShader(Ka,$a),this.cliffShader=this.webgl.createShader(za,Xa),this.loadBaseFiles()}async loadBaseFiles(){const e=[this.loadBaseFile("TerrainArt\\Terrain.slk","text"),this.loadBaseFile("TerrainArt\\CliffTypes.slk","text"),this.loadBaseFile("TerrainArt\\Water.slk","text"),this.loadBaseFile("Doodads\\Doodads.slk","text"),this.loadBaseFile("Doodads\\DoodadMetaData.slk","text"),this.loadBaseFile("Units\\DestructableData.slk","text"),this.loadBaseFile("Units\\DestructableMetaData.slk","text"),this.loadBaseFile("Units\\UnitData.slk","text"),this.loadBaseFile("Units\\unitUI.slk","text"),this.loadBaseFile("Units\\ItemData.slk","text"),this.loadBaseFile("Units\\UnitMetaData.slk","text")];let t;this.isReforged&&(t=[this.loadBaseFile("Doodads\\doodadSkins.txt","text"),this.loadBaseFile("Units\\destructableSkin.txt","text"),this.loadBaseFile("Units\\unitSkin.txt","text"),this.loadBaseFile("Units\\itemSkin.txt","text")]);const[i,n,s,o,a,l,c,d,h,u,p]=await Promise.all(e);if(!i||!n||!s||!o||!a||!l||!c||!d||!h||!u||!p)throw new Error("Failed to load the base files");if(this.terrainData.load(i.data),this.cliffTypesData.load(n.data),this.waterData.load(s.data),this.doodadsData.load(o.data),this.doodadMetaData.load(a.data),this.doodadsData.load(l.data),this.destructableMetaData.load(c.data),this.unitsData.load(d.data),this.unitsData.load(h.data),this.unitsData.load(u.data),this.unitMetaData.load(p.data),t){const[g,v,b,w]=await Promise.all(t);if(!g||!v||!b||!w)throw new Error("Failed to load the base Reforged files");this.doodadsData.load(g.data),this.doodadsData.load(v.data),this.unitsData.load(b.data),this.unitsData.load(w.data)}this.loadedBaseFiles=!0,this.emit("loadedbasefiles")}loadBaseFile(e,t){return super.loadGeneric(this.wc3PathSolver(e),t)}loadMap(e){this.loadedBaseFiles&&(this.map&&this.map.die(),this.map=new gc(this,e))}update(){this.map&&(super.update(),this.map.update())}render(){this.map&&this.map.render()}}function wc(r,e={}){return new bc(r,e)}const Z=f.vec3.create(),Je=f.vec3.create(),et=f.quat.create(),ir=new Float32Array(1);function nr(r,e){let t=e.clientX-r.clientX,i=e.clientY-r.clientY;return Math.sqrt(t*t+i*i)}const qt=-1,sr=0,rr=1;class bc{constructor(e,t={}){this.scene=e,this.canvas=e.viewer.canvas,this.camera=e.camera,this.moveSpeed=t.moveSpeed||2,this.rotationSpeed=t.rotationSpeed||Math.PI/180,this.zoomFactor=t.zoomFactor||.1,this.horizontalAngle=t.horizontalAngle||Math.PI/2,this.verticalAngle=t.verticalAngle||Math.PI/4,this.distance=t.distance||500,this.position=t.position||f.vec3.create(),this.target=t.target||f.vec3.create(),this.twist=t.twist||0,this.mouse={buttons:[!1,!1,!1],x:0,y:0,x2:0,y2:0},this.touchMode=qt,this.touches=[],this.instance=null,this.onManualChange=t.onManualChange||null,this.fov=t.fov||Math.PI/4,this.nearClipPlane=t.nearClipPlane||1,this.farClipPlane=t.farClipPlane||2e5,this.update(),window.addEventListener("resize",i=>this.onResize()),setTimeout(()=>this.onResize(),0),this.canvas.addEventListener("contextmenu",i=>i.preventDefault()),this.canvas.addEventListener("selectstart",i=>i.preventDefault()),this.canvas.addEventListener("mousedown",i=>{i.preventDefault(),this.mouse.buttons[i.button]=!0}),document.addEventListener("mouseup",i=>{i.preventDefault(),this.mouse.buttons[i.button]=!1}),window.addEventListener("mousemove",i=>{this.mouse.x2=this.mouse.x,this.mouse.y2=this.mouse.y,this.mouse.x=i.clientX,this.mouse.y=i.clientY;let n=this.mouse.x-this.mouse.x2,s=this.mouse.y-this.mouse.y2;this.mouse.buttons[0]&&this.rotate(n,s),this.mouse.buttons[2]&&this.move(-n,s)}),this.canvas.addEventListener("wheel",i=>{i.preventDefault();let n=i.deltaY;i.deltaMode===1&&(n=n/3*100),this.zoom(n/100)}),this.canvas.addEventListener("touchstart",i=>{i.preventDefault();let n=i.targetTouches;n.length===1?this.touchMode=sr:n.length==2?this.touchMode=rr:this.touchMode=qt,this.touches.length=0,this.touches.push(...n)}),this.canvas.addEventListener("touchend",i=>{i.preventDefault(),this.touchMode=qt}),this.canvas.addEventListener("touchcancel",i=>{i.preventDefault(),this.touchMode=qt}),this.canvas.addEventListener("touchmove",i=>{i.preventDefault();let n=i.targetTouches;if(this.touchMode===sr){let s=this.touches[0],o=n[0],a=o.clientX-s.clientX,l=o.clientY-s.clientY;this.rotate(a,l)}else if(this.touchMode===rr){let s=nr(this.touches[0],this.touches[1]),o=nr(n[0],n[1]);this.zoom((s-o)/50)}this.touches.length=0,this.touches.push(...n)})}update(){if(this.instance){let e=this.instance,t=e.model.cameras[0];t.getTranslation(Z,e.sequence,e.frame,e.counter),f.vec3.add(Z,Z,t.position),t.getTargetTranslation(Je,e.sequence,e.frame,e.counter),f.vec3.add(Je,Je,t.targetPosition),t.getRotation(ir,e.sequence,e.frame,e.counter),this.twist=ir[0],f.vec3.transformMat4(Z,Z,e.worldMatrix),f.vec3.transformMat4(Je,Je,e.worldMatrix),this.moveToAndFace(Z,Je)}else this.updateInternalCamera()}move(e,t){let i=this.camera.directionX,n=this.camera.directionY,s=this.canvas.width,o=this.canvas.height,a=s/o,l=e/s*this.distance*a,c=t/o*this.distance;f.vec3.add(this.target,this.target,f.vec3.scale(Z,f.vec3.normalize(Z,f.vec3.set(Z,i[0],i[1],0)),l)),f.vec3.add(this.target,this.target,f.vec3.scale(Z,f.vec3.normalize(Z,f.vec3.set(Z,n[0],n[1],0)),c)),this.manualChange()}rotate(e,t){this.horizontalAngle-=e*this.rotationSpeed,this.verticalAngle-=t*this.rotationSpeed,this.manualChange()}zoom(e){this.distance=Math.max(1,this.distance*(1+e*this.zoomFactor)),this.manualChange()}manualChange(){this.updateInternalCamera(),this.instance&&(this.instance=null,this.onManualChange&&this.onManualChange())}onResize(){let e=Math.max(this.canvas.clientWidth,1),t=Math.max(this.canvas.clientHeight,1);this.canvas.width=e,this.canvas.height=t,this.scene.viewport[2]=e,this.scene.viewport[3]=t,this.camera.perspective(this.fov,e/t,this.nearClipPlane,this.farClipPlane)}moveToAndFace(e,t){f.vec3.sub(Z,e,t);let i=f.vec3.length(Z),n=Math.atan2(Z[1],Z[0]),s=Math.acos(Z[2]/i);f.vec3.copy(this.target,t),this.verticalAngle=s,this.horizontalAngle=n+Math.PI/2,this.distance=i,this.updateInternalCamera()}updateInternalCamera(){this.verticalAngle=Math.min(Math.max(.01,this.verticalAngle),Math.PI-.01),f.quat.identity(et),f.quat.rotateZ(et,et,this.horizontalAngle),f.quat.rotateX(et,et,this.verticalAngle),f.vec3.set(this.position,0,0,1),f.vec3.transformQuat(this.position,this.position,et),f.vec3.scale(this.position,this.position,this.distance),f.vec3.add(this.position,this.position,this.target);let e=this.twist-Math.PI/2;f.vec3.set(Z,0,-Math.cos(e),-Math.sin(e)),this.camera.moveToAndFace(this.position,this.target,Z)}applyInstanceCamera(e){this.instance=e,this.fov=e.model.cameras[0].fieldOfView,this.onResize(),this.update()}}function mc(r,e){if(e){const t=Object.entries(e);if(t.length){const i=t.map(([s,o])=>`${s}=${o}`).join("&");let n="&";return r.indexOf("?")===-1&&(n="?"),`${r}${n}${i}`}}return r}function Ac(r,e){return r=r.toLowerCase(),window.location.hostname==="127.0.0.1"?mc(`${window.location.origin}/assets?path=${r}`,e):`https://www.hiveworkshop.com/casc-contents?path=${r}`}let _i=document.getElementById("status");_i.textContent="Initializing the viewer";let yc=document.getElementById("canvas"),Te=new vc(yc,Ac,!0),tt=[];function Ei(){tt.length?_i.textContent=`Loading ${tt.join(", ")}`:_i.textContent=""}for(let r of Te.promiseMap.keys())tt.push(Kt(r));Ei(),Te.on("loadstart",({fetchUrl:r})=>{tt.push(Kt(r)),Ei()}),Te.on("loadend",({fetchUrl:r})=>{let e=Kt(r),t=tt.indexOf(e);t!==-1&&(tt.splice(t,1),Ei())});let Tc=new FPSMeter({position:"absolute",right:"10px",top:"10px",left:"calc(100% - 130px)",theme:"transparent",heat:1,graph:1}),xc=document.getElementById("cells"),_c=document.getElementById("instances"),Ec=document.getElementById("particles");(function r(){requestAnimationFrame(r),Te.updateAndRender(),Tc.tick(),xc.textContent=`Cells: ${Te.visibleCells}`,_c.textContent=`Instances: ${Te.visibleInstances}`,Ec.textContent=`Particles: ${Te.updatedParticles}`})(),document.addEventListener("dragover",r=>{r.preventDefault()}),document.addEventListener("dragend",r=>{r.preventDefault()}),document.addEventListener("drop",r=>{if(r.preventDefault(),Te.loadedBaseFiles){let e=r.dataTransfer.files[0],t=e.name,i=Ii(t);if(i===".w3m"||i===".w3x"){let n=new FileReader;n.addEventListener("loadend",s=>{Te.loadMap(s.target.result),wc(Te.map.worldScene,{distance:3e3})}),n.readAsArrayBuffer(e)}}})}));
