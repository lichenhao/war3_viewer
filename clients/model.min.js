import{i as D,f as q,g as H,e as $,B as y,T as k}from"./tokenstream.min.js";class u{boundsRadius=0;min=new Float32Array(3);max=new Float32Array(3);readMdx(i){this.boundsRadius=i.readFloat32(),i.readFloat32Array(this.min),i.readFloat32Array(this.max)}writeMdx(i){i.writeFloat32(this.boundsRadius),i.writeFloat32Array(this.min),i.writeFloat32Array(this.max)}writeMdl(i){(this.min[0]!==0||this.min[1]!==0||this.min[2]!==0)&&i.writeVectorAttrib("MinimumExtent",this.min),(this.max[0]!==0||this.max[1]!==0||this.max[2]!==0)&&i.writeVectorAttrib("MaximumExtent",this.max),this.boundsRadius!==0&&i.writeNumberAttrib("BoundsRadius",this.boundsRadius)}}class B{name="";interval=new Uint32Array(2);moveSpeed=0;nonLooping=0;rarity=0;syncPoint=0;extent=new u;readMdx(i){this.name=i.read(80),i.readUint32Array(this.interval),this.moveSpeed=i.readFloat32(),this.nonLooping=i.readUint32(),this.rarity=i.readFloat32(),this.syncPoint=i.readUint32(),this.extent.readMdx(i)}writeMdx(i){i.skip(80-i.write(this.name)),i.writeUint32Array(this.interval),i.writeFloat32(this.moveSpeed),i.writeUint32(this.nonLooping),i.writeFloat32(this.rarity),i.writeUint32(this.syncPoint),this.extent.writeMdx(i)}readMdl(i){this.name=i.read();for(const t of i.readBlock())if(t==="Interval")i.readVector(this.interval);else if(t==="NonLooping")this.nonLooping=1;else if(t==="MoveSpeed")this.moveSpeed=i.readFloat();else if(t==="Rarity")this.rarity=i.readFloat();else if(t==="MinimumExtent")i.readVector(this.extent.min);else if(t==="MaximumExtent")i.readVector(this.extent.max);else if(t==="BoundsRadius")this.extent.boundsRadius=i.readFloat();else throw new Error(`Unknown token in Sequence: "${t}"`)}writeMdl(i){i.startObjectBlock("Anim",this.name),i.writeVectorAttrib("Interval",this.interval),this.nonLooping===1&&i.writeFlag("NonLooping"),this.moveSpeed!==0&&i.writeNumberAttrib("MoveSpeed",this.moveSpeed),this.rarity!==0&&i.writeNumberAttrib("Rarity",this.rarity),this.extent.writeMdl(i),i.endBlock()}}var z=(n=>(n[n.DontInterp=0]="DontInterp",n[n.Linear=1]="Linear",n[n.Hermite=2]="Hermite",n[n.Bezier=3]="Bezier",n))(z||{});class g{name="";interpolationType=0;globalSequenceId=-1;frames=[];values=[];inTans=[];outTans=[];readMdx(i,t){const e=this.frames,s=this.values,r=this.inTans,l=this.outTans,f=i.readUint32(),a=i.readUint32();this.name=t,this.interpolationType=a,this.globalSequenceId=i.readInt32();for(let h=0;h<f;h++)e.push(i.readInt32()),s.push(this.readMdxValue(i)),a>1&&(r.push(this.readMdxValue(i)),l.push(this.readMdxValue(i)))}writeMdx(i){const t=this.interpolationType,e=this.frames,s=this.values,r=this.inTans,l=this.outTans,f=e.length;i.writeBinary(this.name),i.writeUint32(f),i.writeUint32(t),i.writeInt32(this.globalSequenceId);for(let a=0;a<f;a++)i.writeInt32(e[a]),this.writeMdxValue(i,s[a]),t>1&&(this.writeMdxValue(i,r[a]),this.writeMdxValue(i,l[a]))}readMdl(i,t){const e=this.frames,s=this.values,r=this.inTans,l=this.outTans;this.name=t;const f=i.readInt();i.read();let a=0;const h=i.read();h==="DontInterp"?a=0:h==="Linear"?a=1:h==="Hermite"?a=2:h==="Bezier"&&(a=3),this.interpolationType=a,i.peek()==="GlobalSeqId"&&(i.read(),this.globalSequenceId=i.readInt());for(let d=0;d<f;d++)e[d]=i.readInt(),s[d]=this.readMdlValue(i),a>1&&(i.read(),r[d]=this.readMdlValue(i),i.read(),l[d]=this.readMdlValue(i));i.read()}writeMdl(i,t){const e=this.interpolationType,s=this.frames,r=this.values,l=this.inTans,f=this.outTans,a=s.length;i.startBlock(t,this.frames.length);let h="";this.interpolationType===0?h="DontInterp":this.interpolationType===1?h="Linear":this.interpolationType===2?h="Hermite":this.interpolationType===3&&(h="Bezier"),i.writeFlag(h),this.globalSequenceId!==-1&&i.writeNumberAttrib("GlobalSeqId",this.globalSequenceId);for(let d=0;d<a;d++)this.writeMdlValue(i,`${s[d]}:`,r[d]),e>1&&(i.indent(),this.writeMdlValue(i,"InTan",l[d]),this.writeMdlValue(i,"OutTan",f[d]),i.unindent());i.endBlock()}getByteLength(){const i=this.frames.length;let t=16;if(i){const e=this.values[0].byteLength;let s=1;this.interpolationType>1&&(s=3),t+=(4+s*e)*i}return t}}class p extends g{readMdxValue(i){return i.readUint32Array(1)}writeMdxValue(i,t){i.writeUint32(t[0])}readMdlValue(i){return new Uint32Array([i.readInt()])}writeMdlValue(i,t,e){i.writeNumberAttrib(t,e[0])}}class o extends g{readMdxValue(i){return i.readFloat32Array(1)}writeMdxValue(i,t){i.writeFloat32(t[0])}readMdlValue(i){return new Float32Array([i.readFloat()])}writeMdlValue(i,t,e){i.writeNumberAttrib(t,e[0])}}class c extends g{readMdxValue(i){return i.readFloat32Array(3)}writeMdxValue(i,t){i.writeFloat32Array(t)}readMdlValue(i){return i.readVector(new Float32Array(3))}writeMdlValue(i,t,e){i.writeVectorAttrib(t,e)}}class x extends g{readMdxValue(i){return i.readFloat32Array(4)}writeMdxValue(i,t){i.writeFloat32Array(t)}readMdlValue(i){return i.readVector(new Float32Array(4))}writeMdlValue(i,t,e){i.writeVectorAttrib(t,e)}}const b={KMTF:["TextureID",p],KMTA:["Alpha",o],KMTE:["EmissiveGain",o],KFC3:["FresnelColor",c],KFCA:["FresnelOpacity",o],KFTC:["FresnelTeamColor",p],KTAT:["Translation",c],KTAR:["Rotation",x],KTAS:["Scaling",c],KGAO:["Alpha",o],KGAC:["Color",c],KGTR:["Translation",c],KGRT:["Rotation",x],KGSC:["Scaling",c],KLAS:["AttenuationStart",o],KLAE:["AttenuationEnd",o],KLAC:["Color",c],KLAI:["Intensity",o],KLBI:["AmbIntensity",o],KLBC:["AmbColor",c],KLAV:["Visibility",o],KATV:["Visibility",o],KPEE:["EmissionRate",o],KPEG:["Gravity",o],KPLN:["Longitude",o],KPLT:["Latitude",o],KPEL:["LifeSpan",o],KPES:["InitVelocity",o],KPEV:["Visibility",o],KP2S:["Speed",o],KP2R:["Variation",o],KP2L:["Latitude",o],KP2G:["Gravity",o],KP2E:["EmissionRate",o],KP2N:["Width",o],KP2W:["Length",o],KP2V:["Visibility",o],KPPA:["Alpha",o],KPPC:["Color",c],KPPE:["EmissionRate",o],KPPL:["LifeSpan",o],KPPS:["Speed",o],KPPV:["Visibility",o],KRHA:["HeightAbove",o],KRHB:["HeightBelow",o],KRAL:["Alpha",o],KRCO:["Color",c],KRTX:["TextureSlot",p],KRVS:["Visibility",o],KCTR:["Translation",c],KTTR:["Translation",c],KCRL:["Rotation",o]};class A{animations=[];readAnimations(i,t){const e=i.index+t;for(;i.index<e;){const s=i.readBinary(4),r=new b[s][1];r.readMdx(i,s),this.animations.push(r)}}writeAnimations(i){for(const t of this.animations)t.writeMdx(i)}*readAnimatedBlock(i){for(const t of i.readBlock())t==="static"?yield`static ${i.read()}`:yield t}readAnimation(i,t){const e=new b[t][1];e.readMdl(i,t),this.animations.push(e)}writeAnimation(i,t){for(const e of this.animations)if(e.name===t)return e.writeMdl(i,b[t][0]),!0;return!1}getByteLength(i=0){let t=0;for(const e of this.animations)t+=e.getByteLength();return t}}var X=(n=>(n[n.None=0]="None",n[n.Transparent=1]="Transparent",n[n.Blend=2]="Blend",n[n.Additive=3]="Additive",n[n.AddAlpha=4]="AddAlpha",n[n.Modulate=5]="Modulate",n[n.Modulate2x=6]="Modulate2x",n))(X||{}),W=(n=>(n[n.None=0]="None",n[n.Unshaded=1]="Unshaded",n[n.SphereEnvMap=2]="SphereEnvMap",n[n.TwoSided=16]="TwoSided",n[n.Unfogged=32]="Unfogged",n[n.NoDepthTest=64]="NoDepthTest",n[n.NoDepthSet=128]="NoDepthSet",n[n.Unlit=256]="Unlit",n))(W||{});function Z(n){return n==="None"?0:n==="Transparent"?1:n==="Blend"?2:n==="Additive"?3:n==="AddAlpha"?4:n==="Modulate"?5:n==="Modulate2x"?6:0}function Y(n){return n===0?"None":n===1?"Transparent":n===2?"Blend":n===3?"Additive":n===4?"AddAlpha":n===5?"Modulate":n===6?"Modulate2x":"None"}class I extends A{filterMode=0;flags=0;textureId=-1;textureAnimationId=-1;coordId=0;alpha=1;emissiveGain=1;fresnelColor=new Float32Array([1,1,1]);fresnelOpacity=0;fresnelTeamColor=0;readMdx(i,t){const e=i.index,s=i.readUint32();this.filterMode=i.readUint32(),this.flags=i.readUint32(),this.textureId=i.readInt32(),this.textureAnimationId=i.readInt32(),this.coordId=i.readUint32(),this.alpha=i.readFloat32(),t>800&&(this.emissiveGain=i.readFloat32(),i.readFloat32Array(this.fresnelColor),this.fresnelOpacity=i.readFloat32(),this.fresnelTeamColor=i.readFloat32()),this.readAnimations(i,s-(i.index-e))}writeMdx(i,t){i.writeUint32(this.getByteLength(t)),i.writeUint32(this.filterMode),i.writeUint32(this.flags),i.writeInt32(this.textureId),i.writeInt32(this.textureAnimationId),i.writeUint32(this.coordId),i.writeFloat32(this.alpha),t>800&&(i.writeFloat32(this.emissiveGain),i.writeFloat32Array(this.fresnelColor),i.writeFloat32(this.fresnelOpacity),i.writeFloat32(this.fresnelTeamColor)),this.writeAnimations(i)}readMdl(i){for(const t of super.readAnimatedBlock(i))if(t==="FilterMode")this.filterMode=Z(i.read());else if(t==="Unshaded")this.flags|=1;else if(t==="SphereEnvMap")this.flags|=2;else if(t==="TwoSided")this.flags|=16;else if(t==="Unfogged")this.flags|=32;else if(t==="NoDepthTest")this.flags|=64;else if(t==="NoDepthSet")this.flags|=128;else if(t==="Unlit")this.flags|=256;else if(t==="static TextureID")this.textureId=i.readInt();else if(t==="TextureID")this.readAnimation(i,"KMTF");else if(t==="TVertexAnimId")this.textureAnimationId=i.readInt();else if(t==="CoordId")this.coordId=i.readInt();else if(t==="static Alpha")this.alpha=i.readFloat();else if(t==="Alpha")this.readAnimation(i,"KMTA");else if(t==="static EmissiveGain")this.emissiveGain=i.readFloat();else if(t==="EmissiveGain")this.readAnimation(i,"KMTE");else if(t==="static FresnelColor")i.readVector(this.fresnelColor);else if(t==="FresnelColor")this.readAnimation(i,"KFC3");else if(t==="static FresnelOpacity")this.fresnelOpacity=i.readFloat();else if(t==="FresnelOpacity")this.readAnimation(i,"KFCA");else if(t==="static FresnelTeamColor")this.fresnelTeamColor=i.readFloat();else if(t==="FresnelTeamColor")this.readAnimation(i,"KFTC");else throw new Error(`Unknown token in Layer: "${t}"`)}writeMdl(i,t){i.startBlock("Layer"),i.writeFlagAttrib("FilterMode",Y(this.filterMode)),this.flags&1&&i.writeFlag("Unshaded"),this.flags&2&&i.writeFlag("SphereEnvMap"),this.flags&16&&i.writeFlag("TwoSided"),this.flags&32&&i.writeFlag("Unfogged"),this.flags&64&&i.writeFlag("NoDepthTest"),this.flags&128&&i.writeFlag("NoDepthSet"),t>800&&this.flags&256&&i.writeFlag("Unlit"),this.writeAnimation(i,"KMTF")||i.writeNumberAttrib("static TextureID",this.textureId),this.textureAnimationId!==-1&&i.writeNumberAttrib("TVertexAnimId",this.textureAnimationId),this.coordId!==0&&i.writeNumberAttrib("CoordId",this.coordId),!this.writeAnimation(i,"KMTA")&&this.alpha!==1&&i.writeNumberAttrib("static Alpha",this.alpha),t>800&&(!this.writeAnimation(i,"KMTE")&&this.emissiveGain!==1&&i.writeNumberAttrib("static EmissiveGain",this.emissiveGain),!this.writeAnimation(i,"KFC3")&&(this.fresnelColor[0]!==1||this.fresnelColor[1]!==1||this.fresnelColor[2]!==1)&&i.writeVectorAttrib("static FresnelColor",this.fresnelColor),!this.writeAnimation(i,"KFCA")&&this.fresnelOpacity!==0&&i.writeNumberAttrib("static FresnelOpacity",this.fresnelOpacity),!this.writeAnimation(i,"KFTC")&&this.fresnelTeamColor!==0&&i.writeNumberAttrib("static FresnelTeamColor",this.fresnelTeamColor)),i.endBlock()}getByteLength(i){let t=28+super.getByteLength();return i>800&&(t+=24),t}}class S{priorityPlane=0;flags=0;shader="";layers=[];readMdx(i,t){i.readUint32(),this.priorityPlane=i.readInt32(),this.flags=i.readUint32(),t>800&&(this.shader=i.read(80)),i.skip(4);for(let e=0,s=i.readUint32();e<s;e++){const r=new I;r.readMdx(i,t),this.layers.push(r)}}writeMdx(i,t){i.writeUint32(this.getByteLength(t)),i.writeInt32(this.priorityPlane),i.writeUint32(this.flags),t>800&&i.skip(80-i.write(this.shader)),i.writeBinary("LAYS"),i.writeUint32(this.layers.length);for(const e of this.layers)e.writeMdx(i,t)}readMdl(i){for(const t of i.readBlock())if(t==="ConstantColor")this.flags|=1;else if(t==="TwoSided")this.flags|=2;else if(t==="SortPrimsNearZ")this.flags|=8;else if(t==="SortPrimsFarZ")this.flags|=16;else if(t==="FullResolution")this.flags|=32;else if(t==="PriorityPlane")this.priorityPlane=i.readInt();else if(t==="Shader")this.shader=i.read();else if(t==="Layer"){const e=new I;e.readMdl(i),this.layers.push(e)}else throw new Error(`Unknown token in Material: "${t}"`)}writeMdl(i,t){i.startBlock("Material"),this.flags&1&&i.writeFlag("ConstantColor"),t>800&&this.flags&2&&i.writeFlag("TwoSided"),this.flags&8&&i.writeFlag("SortPrimsNearZ"),this.flags&16&&i.writeFlag("SortPrimsFarZ"),this.flags&32&&i.writeFlag("FullResolution"),this.priorityPlane!==0&&i.writeNumberAttrib("PriorityPlane",this.priorityPlane),t>800&&i.writeStringAttrib("Shader",this.shader);for(const e of this.layers)e.writeMdl(i,t);i.endBlock()}getByteLength(i){let t=20;i>800&&(t+=80);for(const e of this.layers)t+=e.getByteLength(i);return t}}var Q=(n=>(n[n.RepeatBoth=0]="RepeatBoth",n[n.WrapWidth=1]="WrapWidth",n[n.WrapHeight=2]="WrapHeight",n[n.WrapBoth=3]="WrapBoth",n))(Q||{});class F{replaceableId=0;path="";wrapMode=0;readMdx(i){this.replaceableId=i.readUint32(),this.path=i.read(260),this.wrapMode=i.readUint32()}writeMdx(i){i.writeUint32(this.replaceableId),i.skip(260-i.write(this.path)),i.writeUint32(this.wrapMode)}readMdl(i){for(const t of i.readBlock())if(t==="Image")this.path=i.read();else if(t==="ReplaceableId")this.replaceableId=i.readInt();else if(t==="WrapWidth")this.wrapMode|=1;else if(t==="WrapHeight")this.wrapMode|=2;else throw new Error(`Unknown token in Texture: "${t}"`)}writeMdl(i){i.startBlock("Bitmap"),this.path.length&&i.writeStringAttrib("Image",this.path),this.replaceableId!==0&&i.writeNumberAttrib("ReplaceableId",this.replaceableId),this.wrapMode&1&&i.writeFlag("WrapWidth"),this.wrapMode&2&&i.writeFlag("WrapHeight"),i.endBlock()}}class M extends A{readMdx(i){const t=i.readUint32();this.readAnimations(i,t-4)}writeMdx(i){i.writeUint32(this.getByteLength()),this.writeAnimations(i)}readMdl(i){for(const t of i.readBlock())if(t==="Translation")this.readAnimation(i,"KTAT");else if(t==="Rotation")this.readAnimation(i,"KTAR");else if(t==="Scaling")this.readAnimation(i,"KTAS");else throw new Error(`Unknown token in TextureAnimation: "${t}"`)}writeMdl(i){i.startBlock("TVertexAnim "),this.writeAnimation(i,"KTAT"),this.writeAnimation(i,"KTAR"),this.writeAnimation(i,"KTAS"),i.endBlock()}getByteLength(){return 4+super.getByteLength()}}class U{vertices=new Float32Array(0);normals=new Float32Array(0);faceTypeGroups=new Uint32Array(0);faceGroups=new Uint32Array(0);faces=new Uint16Array(0);vertexGroups=new Uint8Array(0);matrixGroups=new Uint32Array(0);matrixIndices=new Uint32Array(0);materialId=0;selectionGroup=0;selectionFlags=0;lod=-1;lodName="";extent=new u;sequenceExtents=[];tangents=new Float32Array(0);skin=new Uint8Array(0);uvSets=[];readMdx(i,t){i.readUint32(),i.skip(4),this.vertices=i.readFloat32Array(i.readUint32()*3),i.skip(4),this.normals=i.readFloat32Array(i.readUint32()*3),i.skip(4),this.faceTypeGroups=i.readUint32Array(i.readUint32()),i.skip(4),this.faceGroups=i.readUint32Array(i.readUint32()),i.skip(4),this.faces=i.readUint16Array(i.readUint32()),i.skip(4),this.vertexGroups=i.readUint8Array(i.readUint32()),i.skip(4),this.matrixGroups=i.readUint32Array(i.readUint32()),i.skip(4),this.matrixIndices=i.readUint32Array(i.readUint32()),this.materialId=i.readUint32(),this.selectionGroup=i.readUint32(),this.selectionFlags=i.readUint32(),t>800&&(this.lod=i.readInt32(),this.lodName=i.read(80)),this.extent.readMdx(i);for(let e=0,s=i.readUint32();e<s;e++){const r=new u;r.readMdx(i),this.sequenceExtents.push(r)}t>800&&(i.readBinary(4)==="TANG"?this.tangents=i.readFloat32Array(i.readUint32()*4):i.skip(-4),i.readBinary(4)==="SKIN"?this.skin=i.readUint8Array(i.readUint32()):i.skip(-4)),i.skip(4);for(let e=0,s=i.readUint32();e<s;e++)i.skip(4),this.uvSets.push(i.readFloat32Array(i.readUint32()*2))}writeMdx(i,t){i.writeUint32(this.getByteLength(t)),i.writeBinary("VRTX"),i.writeUint32(this.vertices.length/3),i.writeFloat32Array(this.vertices),i.writeBinary("NRMS"),i.writeUint32(this.normals.length/3),i.writeFloat32Array(this.normals),i.writeBinary("PTYP"),i.writeUint32(this.faceTypeGroups.length),i.writeUint32Array(this.faceTypeGroups),i.writeBinary("PCNT"),i.writeUint32(this.faceGroups.length),i.writeUint32Array(this.faceGroups),i.writeBinary("PVTX"),i.writeUint32(this.faces.length),i.writeUint16Array(this.faces),i.writeBinary("GNDX"),i.writeUint32(this.vertexGroups.length),i.writeUint8Array(this.vertexGroups),i.writeBinary("MTGC"),i.writeUint32(this.matrixGroups.length),i.writeUint32Array(this.matrixGroups),i.writeBinary("MATS"),i.writeUint32(this.matrixIndices.length),i.writeUint32Array(this.matrixIndices),i.writeUint32(this.materialId),i.writeUint32(this.selectionGroup),i.writeUint32(this.selectionFlags),t>800&&(i.writeInt32(this.lod),i.skip(80-i.write(this.lodName))),this.extent.writeMdx(i),i.writeUint32(this.sequenceExtents.length);for(const e of this.sequenceExtents)e.writeMdx(i);t>800&&(this.tangents.length&&(i.writeBinary("TANG"),i.writeUint32(this.tangents.length/4),i.writeFloat32Array(this.tangents)),this.skin.length&&(i.writeBinary("SKIN"),i.writeUint32(this.skin.length),i.writeUint8Array(this.skin))),i.writeBinary("UVAS"),i.writeUint32(this.uvSets.length);for(const e of this.uvSets)i.writeBinary("UVBS"),i.writeUint32(e.length/2),i.writeFloat32Array(e)}readMdl(i){for(let t of i.readBlock())if(t==="Vertices")this.vertices=i.readVectorsBlock(new Float32Array(i.readInt()*3),3);else if(t==="Normals")this.normals=i.readVectorsBlock(new Float32Array(i.readInt()*3),3);else if(t==="TVertices")this.uvSets.push(i.readVectorsBlock(new Float32Array(i.readInt()*2),2));else if(t==="VertexGroup"){const e=[];for(const s of i.readBlock())e.push(parseInt(s));this.vertexGroups=new Uint8Array(e)}else if(t==="Tangents")this.tangents=i.readVectorsBlock(new Float32Array(i.readInt()*4),4);else if(t==="SkinWeights")this.skin=i.readVector(new Uint8Array(i.readInt()*8));else if(t==="Faces"){this.faceTypeGroups=new Uint32Array([4]);const e=i.readInt(),s=i.readInt();i.read(),i.read(),this.faces=i.readVectorsBlock(new Uint16Array(s),s/e),this.faceGroups=new Uint32Array([s]),i.read()}else if(t==="Groups"){const e=[],s=[];i.readInt(),i.readInt();for(const r of i.readBlock()){let l=0;for(const f of i.readBlock())e.push(parseInt(f)),l+=1;s.push(l)}this.matrixIndices=new Uint32Array(e),this.matrixGroups=new Uint32Array(s)}else if(t==="MinimumExtent")i.readVector(this.extent.min);else if(t==="MaximumExtent")i.readVector(this.extent.max);else if(t==="BoundsRadius")this.extent.boundsRadius=i.readFloat();else if(t==="Anim"){const e=new u;for(t of i.readBlock())t==="MinimumExtent"?i.readVector(e.min):t==="MaximumExtent"?i.readVector(e.max):t==="BoundsRadius"&&(e.boundsRadius=i.readFloat());this.sequenceExtents.push(e)}else if(t==="MaterialID")this.materialId=i.readInt();else if(t==="SelectionGroup")this.selectionGroup=i.readInt();else if(t==="Unselectable")this.selectionFlags=4;else if(t==="LevelOfDetail")this.lod=i.readInt();else if(t==="Name")this.lodName=i.read();else throw new Error(`Unknown token in Geoset: "${t}"`)}writeMdl(i,t){i.startBlock("Geoset"),i.writeVectorArrayBlock("Vertices",this.vertices,3),i.writeVectorArrayBlock("Normals",this.normals,3);for(const s of this.uvSets)i.writeVectorArrayBlock("TVertices",s,2);if(t>800&&this.tangents.length&&i.writeVectorArrayBlock("Tangents",this.tangents,4),this.vertexGroups.length){i.startBlock("VertexGroup");for(let s=0,r=this.vertexGroups.length;s<r;s++)i.writeLine(`${this.vertexGroups[s]},`);i.endBlock()}if(t>800&&this.skin.length){i.startBlock("SkinWeights",this.skin.length/8);for(let s=0,r=this.skin.length;s<r;s+=8)i.writeLine(`${this.skin.subarray(s,s+8).join(", ")},`);i.endBlock()}i.startBlock("Faces",1,this.faces.length),i.startBlock("Triangles"),i.writeVector(this.faces),i.endBlock(),i.endBlock(),i.startBlock("Groups",this.matrixGroups.length,this.matrixIndices.length);let e=0;for(const s of this.matrixGroups)i.writeVectorAttrib("Matrices",this.matrixIndices.subarray(e,e+s)),e+=s;i.endBlock(),this.extent.writeMdl(i);for(const s of this.sequenceExtents)i.startBlock("Anim"),s.writeMdl(i),i.endBlock();i.writeNumberAttrib("MaterialID",this.materialId),i.writeNumberAttrib("SelectionGroup",this.selectionGroup),this.selectionFlags===4&&i.writeFlag("Unselectable"),t>800&&(i.writeNumberAttrib("LevelOfDetail",this.lod),this.lodName.length&&i.writeStringAttrib("Name",this.lodName)),i.endBlock()}getByteLength(i){let t=120+this.vertices.byteLength+this.normals.byteLength+this.faceTypeGroups.byteLength+this.faceGroups.byteLength+this.faces.byteLength+this.vertexGroups.byteLength+this.matrixGroups.byteLength+this.matrixIndices.byteLength+this.sequenceExtents.length*28;i>800&&(t+=84,this.tangents.length&&(t+=8+this.tangents.byteLength),this.skin.length&&(t+=8+this.skin.byteLength));for(const e of this.uvSets)t+=8+e.byteLength;return t}}class v extends A{alpha=1;flags=0;color=new Float32Array([1,1,1]);geosetId=-1;readMdx(i){const t=i.readUint32();this.alpha=i.readFloat32(),this.flags=i.readUint32(),i.readFloat32Array(this.color),this.geosetId=i.readInt32(),this.readAnimations(i,t-28)}writeMdx(i){i.writeUint32(this.getByteLength()),i.writeFloat32(this.alpha),i.writeUint32(this.flags),i.writeFloat32Array(this.color),i.writeInt32(this.geosetId),this.writeAnimations(i)}readMdl(i){for(const t of super.readAnimatedBlock(i))if(t==="DropShadow")this.flags|=1;else if(t==="static Alpha")this.alpha=i.readFloat();else if(t==="Alpha")this.readAnimation(i,"KGAO");else if(t==="static Color")this.flags|=2,i.readColor(this.color);else if(t==="Color")this.flags|=2,this.readAnimation(i,"KGAC");else if(t==="GeosetId")this.geosetId=i.readInt();else throw new Error(`Unknown token in GeosetAnimation: "${t}"`)}writeMdl(i){i.startBlock("GeosetAnim"),this.flags&1&&i.writeFlag("DropShadow"),this.writeAnimation(i,"KGAO")||i.writeNumberAttrib("static Alpha",this.alpha),this.flags&2&&!this.writeAnimation(i,"KGAC")&&(this.color[0]!==1||this.color[1]!==1||this.color[2]!==1)&&i.writeColor("static Color ",this.color),i.writeNumberAttrib("GeosetId",this.geosetId),i.endBlock()}getByteLength(){return 28+super.getByteLength()}}var _=(n=>(n[n.None=0]="None",n[n.DontInheritTranslation=1]="DontInheritTranslation",n[n.DontInheritScaling=2]="DontInheritScaling",n[n.DontInheritRotation=4]="DontInheritRotation",n[n.Billboarded=8]="Billboarded",n[n.BillboardedLockX=16]="BillboardedLockX",n[n.BillboardedLockY=32]="BillboardedLockY",n[n.BillboardedLockZ=64]="BillboardedLockZ",n[n.CameraAnchored=128]="CameraAnchored",n))(_||{});class w extends A{name="";objectId=-1;parentId=-1;flags;constructor(i=0){super(),this.flags=i}readMdx(i){const t=i.readUint32();this.name=i.read(80),this.objectId=i.readInt32(),this.parentId=i.readInt32(),this.flags=i.readUint32(),this.readAnimations(i,t-96)}writeMdx(i){i.writeUint32(this.getGenericByteLength()),i.skip(80-i.write(this.name)),i.writeInt32(this.objectId),i.writeInt32(this.parentId),i.writeUint32(this.flags);for(const t of this.eachAnimation(!0))t.writeMdx(i)}writeNonGenericAnimationChunks(i){for(const t of this.eachAnimation(!1))t.writeMdx(i)}*readGenericBlock(i){this.name=i.read();for(let t of this.readAnimatedBlock(i))if(t==="ObjectId")this.objectId=i.readInt();else if(t==="Parent")this.parentId=i.readInt();else if(t==="BillboardedLockZ")this.flags|=64;else if(t==="BillboardedLockY")this.flags|=32;else if(t==="BillboardedLockX")this.flags|=16;else if(t==="Billboarded")this.flags|=8;else if(t==="CameraAnchored")this.flags|=128;else if(t==="DontInherit")for(t of i.readBlock())t==="Rotation"?this.flags|=4:t==="Translation"?this.flags|=1:t==="Scaling"&&(this.flags|=2);else t==="Translation"?this.readAnimation(i,"KGTR"):t==="Rotation"?this.readAnimation(i,"KGRT"):t==="Scaling"?this.readAnimation(i,"KGSC"):yield t}writeGenericHeader(i){i.writeNumberAttrib("ObjectId",this.objectId),this.parentId!==-1&&i.writeNumberAttrib("Parent",this.parentId),this.flags&64&&i.writeFlag("BillboardedLockZ"),this.flags&32&&i.writeFlag("BillboardedLockY"),this.flags&16&&i.writeFlag("BillboardedLockX"),this.flags&8&&i.writeFlag("Billboarded"),this.flags&128&&i.writeFlag("CameraAnchored"),this.flags&4&&i.writeFlag("DontInherit { Rotation }"),this.flags&1&&i.writeFlag("DontInherit { Translation }"),this.flags&2&&i.writeFlag("DontInherit { Scaling }")}writeGenericAnimations(i){this.writeAnimation(i,"KGTR"),this.writeAnimation(i,"KGRT"),this.writeAnimation(i,"KGSC")}*eachAnimation(i){for(const t of this.animations){const e=t.name,s=e==="KGTR"||e==="KGRT"||e==="KGSC";(i&&s||!i&&!s)&&(yield t)}}getGenericByteLength(){let i=96;for(const t of this.eachAnimation(!0))i+=t.getByteLength();return i}getByteLength(){return 96+super.getByteLength()}}class P extends w{geosetId=-1;geosetAnimationId=-1;constructor(){super(256)}readMdx(i){super.readMdx(i),this.geosetId=i.readInt32(),this.geosetAnimationId=i.readInt32()}writeMdx(i){super.writeMdx(i),i.writeInt32(this.geosetId),i.writeInt32(this.geosetAnimationId)}readMdl(i){for(let t of super.readGenericBlock(i))if(t==="GeosetId")t=i.read(),t==="Multiple"?this.geosetId=-1:this.geosetId=parseInt(t);else if(t==="GeosetAnimId")t=i.read(),t==="None"?this.geosetAnimationId=-1:this.geosetAnimationId=parseInt(t);else throw new Error(`Unknown token in Bone ${this.name}: "${t}"`)}writeMdl(i){i.startObjectBlock("Bone",this.name),this.writeGenericHeader(i),this.geosetId===-1?i.writeFlagAttrib("GeosetId","Multiple"):i.writeNumberAttrib("GeosetId",this.geosetId),this.geosetAnimationId===-1?i.writeFlagAttrib("GeosetAnimId","None"):i.writeNumberAttrib("GeosetAnimId",this.geosetAnimationId),this.writeGenericAnimations(i),i.endBlock()}getByteLength(){return 8+super.getByteLength()}}class C extends w{type=-1;attenuation=new Float32Array(2);color=new Float32Array(3);intensity=0;ambientColor=new Float32Array(3);ambientIntensity=0;constructor(){super(512)}readMdx(i){const t=i.index,e=i.readUint32();super.readMdx(i),this.type=i.readUint32(),i.readFloat32Array(this.attenuation),i.readFloat32Array(this.color),this.intensity=i.readFloat32(),i.readFloat32Array(this.ambientColor),this.ambientIntensity=i.readFloat32(),this.readAnimations(i,e-(i.index-t))}writeMdx(i){i.writeUint32(this.getByteLength()),super.writeMdx(i),i.writeUint32(this.type),i.writeFloat32Array(this.attenuation),i.writeFloat32Array(this.color),i.writeFloat32(this.intensity),i.writeFloat32Array(this.ambientColor),i.writeFloat32(this.ambientIntensity),this.writeNonGenericAnimationChunks(i)}readMdl(i){for(const t of super.readGenericBlock(i))if(t==="Omnidirectional")this.type=0;else if(t==="Directional")this.type=1;else if(t==="Ambient")this.type=2;else if(t==="static AttenuationStart")this.attenuation[0]=i.readFloat();else if(t==="AttenuationStart")this.readAnimation(i,"KLAS");else if(t==="static AttenuationEnd")this.attenuation[1]=i.readFloat();else if(t==="AttenuationEnd")this.readAnimation(i,"KLAE");else if(t==="static Intensity")this.intensity=i.readFloat();else if(t==="Intensity")this.readAnimation(i,"KLAI");else if(t==="static Color")i.readColor(this.color);else if(t==="Color")this.readAnimation(i,"KLAC");else if(t==="static AmbIntensity")this.ambientIntensity=i.readFloat();else if(t==="AmbIntensity")this.readAnimation(i,"KLBI");else if(t==="static AmbColor")i.readColor(this.ambientColor);else if(t==="AmbColor")this.readAnimation(i,"KLBC");else if(t==="Visibility")this.readAnimation(i,"KLAV");else throw new Error(`Unknown token in Light: "${t}"`)}writeMdl(i){i.startObjectBlock("Light",this.name),this.writeGenericHeader(i),this.type===0?i.writeFlag("Omnidirectional"):this.type===1?i.writeFlag("Directional"):this.type===2&&i.writeFlag("Ambient"),this.writeAnimation(i,"KLAS")||i.writeNumberAttrib("static AttenuationStart",this.attenuation[0]),this.writeAnimation(i,"KLAE")||i.writeNumberAttrib("static AttenuationEnd",this.attenuation[1]),this.writeAnimation(i,"KLAI")||i.writeNumberAttrib("static Intensity",this.intensity),this.writeAnimation(i,"KLAC")||i.writeColor("static Color",this.color),this.writeAnimation(i,"KLBI")||i.writeNumberAttrib("static AmbIntensity",this.ambientIntensity),this.writeAnimation(i,"KLBC")||i.writeColor("static AmbColor",this.ambientColor),this.writeAnimation(i,"KLAV"),this.writeGenericAnimations(i),i.endBlock()}getByteLength(){return 48+super.getByteLength()}}class L extends w{readMdl(i){for(const t of super.readGenericBlock(i))throw new Error(`Unknown token in Helper: "${t}"`)}writeMdl(i){i.startObjectBlock("Helper",this.name),this.writeGenericHeader(i),this.writeGenericAnimations(i),i.endBlock()}}class T extends w{path="";attachmentId=0;constructor(){super(2048)}readMdx(i){const t=i.index,e=i.readUint32();super.readMdx(i),this.path=i.read(260),this.attachmentId=i.readInt32(),this.readAnimations(i,e-(i.index-t))}writeMdx(i){i.writeUint32(this.getByteLength()),super.writeMdx(i),i.skip(260-i.write(this.path)),i.writeInt32(this.attachmentId),this.writeNonGenericAnimationChunks(i)}readMdl(i){for(const t of super.readGenericBlock(i))if(t==="AttachmentID")this.attachmentId=i.readInt();else if(t==="Path")this.path=i.read();else if(t==="Visibility")this.readAnimation(i,"KATV");else throw new Error(`Unknown token in Attachment ${this.name}: "${t}"`)}writeMdl(i){i.startObjectBlock("Attachment",this.name),this.writeGenericHeader(i),i.writeNumberAttrib("AttachmentID",this.attachmentId),this.path.length&&i.writeStringAttrib("Path",this.path),this.writeAnimation(i,"KATV"),this.writeGenericAnimations(i),i.endBlock()}getByteLength(){return 268+super.getByteLength()}}class E extends w{emissionRate=0;gravity=0;longitude=0;latitude=0;path="";lifeSpan=0;speed=0;constructor(){super(4096)}readMdx(i){const t=i.index,e=i.readUint32();super.readMdx(i),this.emissionRate=i.readFloat32(),this.gravity=i.readFloat32(),this.longitude=i.readFloat32(),this.latitude=i.readFloat32(),this.path=i.read(260),this.lifeSpan=i.readFloat32(),this.speed=i.readFloat32(),this.readAnimations(i,e-(i.index-t))}writeMdx(i){i.writeUint32(this.getByteLength()),super.writeMdx(i),i.writeFloat32(this.emissionRate),i.writeFloat32(this.gravity),i.writeFloat32(this.longitude),i.writeFloat32(this.latitude),i.skip(260-i.write(this.path)),i.writeFloat32(this.lifeSpan),i.writeFloat32(this.speed),this.writeNonGenericAnimationChunks(i)}readMdl(i){for(let t of super.readGenericBlock(i))if(t==="EmitterUsesMDL")this.flags|=32768;else if(t==="EmitterUsesTGA")this.flags|=65536;else if(t==="static EmissionRate")this.emissionRate=i.readFloat();else if(t==="EmissionRate")this.readAnimation(i,"KPEE");else if(t==="static Gravity")this.gravity=i.readFloat();else if(t==="Gravity")this.readAnimation(i,"KPEG");else if(t==="static Longitude")this.longitude=i.readFloat();else if(t==="Longitude")this.readAnimation(i,"KPLN");else if(t==="static Latitude")this.latitude=i.readFloat();else if(t==="Latitude")this.readAnimation(i,"KPLT");else if(t==="Visibility")this.readAnimation(i,"KPEV");else if(t==="Particle")for(t of this.readAnimatedBlock(i))t==="static LifeSpan"?this.lifeSpan=i.readFloat():t==="LifeSpan"?this.readAnimation(i,"KPEL"):t==="static InitVelocity"?this.speed=i.readFloat():t==="InitVelocity"?this.readAnimation(i,"KPES"):t==="Path"&&(this.path=i.read());else throw new Error(`Unknown token in ParticleEmitter: "${t}"`)}writeMdl(i){i.startObjectBlock("ParticleEmitter",this.name),this.writeGenericHeader(i),this.flags&32768&&i.writeFlag("EmitterUsesMDL"),this.flags&65536&&i.writeFlag("EmitterUsesTGA"),this.writeAnimation(i,"KPEE")||i.writeNumberAttrib("static EmissionRate",this.emissionRate),this.writeAnimation(i,"KPEG")||i.writeNumberAttrib("static Gravity",this.gravity),this.writeAnimation(i,"KPLN")||i.writeNumberAttrib("static Longitude",this.longitude),this.writeAnimation(i,"KPLT")||i.writeNumberAttrib("static Latitude",this.latitude),this.writeAnimation(i,"KPEV"),i.startBlock("Particle"),this.writeAnimation(i,"KPEL")||i.writeNumberAttrib("static LifeSpan",this.lifeSpan),this.writeAnimation(i,"KPES")||i.writeNumberAttrib("static InitVelocity",this.speed),(this.flags&32768||this.flags&65536)&&i.writeStringAttrib("Path",this.path),i.endBlock(),this.writeGenericAnimations(i),i.endBlock()}getByteLength(){return 288+super.getByteLength()}}var J=(n=>(n[n.Unshaded=32768]="Unshaded",n[n.SortPrimsFarZ=65536]="SortPrimsFarZ",n[n.LineEmitter=131072]="LineEmitter",n[n.Unfogged=262144]="Unfogged",n[n.ModelSpace=524288]="ModelSpace",n[n.XYQuad=1048576]="XYQuad",n))(J||{}),m=(n=>(n[n.Blend=0]="Blend",n[n.Additive=1]="Additive",n[n.Modulate=2]="Modulate",n[n.Modulate2x=3]="Modulate2x",n[n.AlphaKey=4]="AlphaKey",n))(m||{}),ii=(n=>(n[n.Head=0]="Head",n[n.Tail=1]="Tail",n[n.Both=2]="Both",n))(ii||{});class V extends w{speed=0;variation=0;latitude=0;gravity=0;lifeSpan=0;emissionRate=0;width=0;length=0;filterMode=0;rows=0;columns=0;headOrTail=0;tailLength=0;timeMiddle=0;segmentColors=[new Float32Array(3),new Float32Array(3),new Float32Array(3)];segmentAlphas=new Uint8Array(3);segmentScaling=new Float32Array(3);headIntervals=[new Uint32Array(3),new Uint32Array(3)];tailIntervals=[new Uint32Array(3),new Uint32Array(3)];textureId=-1;squirt=0;priorityPlane=0;replaceableId=0;readMdx(i){const t=i.index,e=i.readUint32();super.readMdx(i),this.speed=i.readFloat32(),this.variation=i.readFloat32(),this.latitude=i.readFloat32(),this.gravity=i.readFloat32(),this.lifeSpan=i.readFloat32(),this.emissionRate=i.readFloat32(),this.width=i.readFloat32(),this.length=i.readFloat32(),this.filterMode=i.readUint32(),this.rows=i.readUint32(),this.columns=i.readUint32(),this.headOrTail=i.readUint32(),this.tailLength=i.readFloat32(),this.timeMiddle=i.readFloat32(),i.readFloat32Array(this.segmentColors[0]),i.readFloat32Array(this.segmentColors[1]),i.readFloat32Array(this.segmentColors[2]),i.readUint8Array(this.segmentAlphas),i.readFloat32Array(this.segmentScaling),i.readUint32Array(this.headIntervals[0]),i.readUint32Array(this.headIntervals[1]),i.readUint32Array(this.tailIntervals[0]),i.readUint32Array(this.tailIntervals[1]),this.textureId=i.readInt32(),this.squirt=i.readUint32(),this.priorityPlane=i.readInt32(),this.replaceableId=i.readUint32(),this.readAnimations(i,e-(i.index-t))}writeMdx(i){i.writeUint32(this.getByteLength()),super.writeMdx(i),i.writeFloat32(this.speed),i.writeFloat32(this.variation),i.writeFloat32(this.latitude),i.writeFloat32(this.gravity),i.writeFloat32(this.lifeSpan),i.writeFloat32(this.emissionRate),i.writeFloat32(this.width),i.writeFloat32(this.length),i.writeUint32(this.filterMode),i.writeUint32(this.rows),i.writeUint32(this.columns),i.writeUint32(this.headOrTail),i.writeFloat32(this.tailLength),i.writeFloat32(this.timeMiddle),i.writeFloat32Array(this.segmentColors[0]),i.writeFloat32Array(this.segmentColors[1]),i.writeFloat32Array(this.segmentColors[2]),i.writeUint8Array(this.segmentAlphas),i.writeFloat32Array(this.segmentScaling),i.writeUint32Array(this.headIntervals[0]),i.writeUint32Array(this.headIntervals[1]),i.writeUint32Array(this.tailIntervals[0]),i.writeUint32Array(this.tailIntervals[1]),i.writeInt32(this.textureId),i.writeUint32(this.squirt),i.writeInt32(this.priorityPlane),i.writeUint32(this.replaceableId),this.writeNonGenericAnimationChunks(i)}readMdl(i){for(const t of super.readGenericBlock(i))if(t==="SortPrimsFarZ")this.flags|=65536;else if(t==="Unshaded")this.flags|=32768;else if(t==="LineEmitter")this.flags|=131072;else if(t==="Unfogged")this.flags|=262144;else if(t==="ModelSpace")this.flags|=524288;else if(t==="XYQuad")this.flags|=1048576;else if(t==="static Speed")this.speed=i.readFloat();else if(t==="Speed")this.readAnimation(i,"KP2S");else if(t==="static Variation")this.variation=i.readFloat();else if(t==="Variation")this.readAnimation(i,"KP2R");else if(t==="static Latitude")this.latitude=i.readFloat();else if(t==="Latitude")this.readAnimation(i,"KP2L");else if(t==="static Gravity")this.gravity=i.readFloat();else if(t==="Gravity")this.readAnimation(i,"KP2G");else if(t==="Visibility")this.readAnimation(i,"KP2V");else if(t==="Squirt")this.squirt=1;else if(t==="LifeSpan")this.lifeSpan=i.readFloat();else if(t==="static EmissionRate")this.emissionRate=i.readFloat();else if(t==="EmissionRate")this.readAnimation(i,"KP2E");else if(t==="static Width")this.width=i.readFloat();else if(t==="Width")this.readAnimation(i,"KP2N");else if(t==="static Length")this.length=i.readFloat();else if(t==="Length")this.readAnimation(i,"KP2W");else if(t==="Blend")this.filterMode=0;else if(t==="Additive")this.filterMode=1;else if(t==="Modulate")this.filterMode=2;else if(t==="Modulate2x")this.filterMode=3;else if(t==="AlphaKey")this.filterMode=4;else if(t==="Rows")this.rows=i.readInt();else if(t==="Columns")this.columns=i.readInt();else if(t==="Head")this.headOrTail=0;else if(t==="Tail")this.headOrTail=1;else if(t==="Both")this.headOrTail=2;else if(t==="TailLength")this.tailLength=i.readFloat();else if(t==="Time")this.timeMiddle=i.readFloat();else if(t==="SegmentColor"){i.read();for(let e=0;e<3;e++)i.read(),i.readColor(this.segmentColors[e]);i.read()}else if(t==="Alpha")i.readVector(this.segmentAlphas);else if(t==="ParticleScaling")i.readVector(this.segmentScaling);else if(t==="LifeSpanUVAnim")i.readVector(this.headIntervals[0]);else if(t==="DecayUVAnim")i.readVector(this.headIntervals[1]);else if(t==="TailUVAnim")i.readVector(this.tailIntervals[0]);else if(t==="TailDecayUVAnim")i.readVector(this.tailIntervals[1]);else if(t==="TextureID")this.textureId=i.readInt();else if(t==="ReplaceableId")this.replaceableId=i.readInt();else if(t==="PriorityPlane")this.priorityPlane=i.readInt();else throw new Error(`Unknown token in ParticleEmitter2: "${t}"`)}writeMdl(i){i.startObjectBlock("ParticleEmitter2",this.name),this.writeGenericHeader(i),this.flags&65536&&i.writeFlag("SortPrimsFarZ"),this.flags&32768&&i.writeFlag("Unshaded"),this.flags&131072&&i.writeFlag("LineEmitter"),this.flags&262144&&i.writeFlag("Unfogged"),this.flags&524288&&i.writeFlag("ModelSpace"),this.flags&1048576&&i.writeFlag("XYQuad"),this.writeAnimation(i,"KP2S")||i.writeNumberAttrib("static Speed",this.speed),this.writeAnimation(i,"KP2R")||i.writeNumberAttrib("static Variation",this.variation),this.writeAnimation(i,"KP2L")||i.writeNumberAttrib("static Latitude",this.latitude),this.writeAnimation(i,"KP2G")||i.writeNumberAttrib("static Gravity",this.gravity),this.writeAnimation(i,"KP2V"),this.squirt&&i.writeFlag("Squirt"),i.writeNumberAttrib("LifeSpan",this.lifeSpan),this.writeAnimation(i,"KP2E")||i.writeNumberAttrib("static EmissionRate",this.emissionRate),this.writeAnimation(i,"KP2N")||i.writeNumberAttrib("static Width",this.width),this.writeAnimation(i,"KP2W")||i.writeNumberAttrib("static Length",this.length),this.filterMode===0?i.writeFlag("Blend"):this.filterMode===1?i.writeFlag("Additive"):this.filterMode===2?i.writeFlag("Modulate"):this.filterMode===3?i.writeFlag("Modulate2x"):this.filterMode===4&&i.writeFlag("AlphaKey"),i.writeNumberAttrib("Rows",this.rows),i.writeNumberAttrib("Columns",this.columns),this.headOrTail===0?i.writeFlag("Head"):this.headOrTail===1?i.writeFlag("Tail"):this.headOrTail===2&&i.writeFlag("Both"),i.writeNumberAttrib("TailLength",this.tailLength),i.writeNumberAttrib("Time",this.timeMiddle),i.startBlock("SegmentColor"),i.writeColor("Color",this.segmentColors[0]),i.writeColor("Color",this.segmentColors[1]),i.writeColor("Color",this.segmentColors[2]),i.endBlockComma(),i.writeVectorAttrib("Alpha",this.segmentAlphas),i.writeVectorAttrib("ParticleScaling",this.segmentScaling),i.writeVectorAttrib("LifeSpanUVAnim",this.headIntervals[0]),i.writeVectorAttrib("DecayUVAnim",this.headIntervals[1]),i.writeVectorAttrib("TailUVAnim",this.tailIntervals[0]),i.writeVectorAttrib("TailDecayUVAnim",this.tailIntervals[1]),i.writeNumberAttrib("TextureID",this.textureId),this.replaceableId!==0&&i.writeNumberAttrib("ReplaceableId",this.replaceableId),this.priorityPlane!==0&&i.writeNumberAttrib("PriorityPlane",this.priorityPlane),this.writeGenericAnimations(i),i.endBlock()}getByteLength(){return 175+super.getByteLength()}}class G extends w{lifeSpan=0;emissionRate=0;speed=0;color=new Float32Array(3);alpha=1;replaceableId=0;path="";animationVisiblityGuide="";readMdx(i){const t=i.index,e=i.readUint32();super.readMdx(i),this.lifeSpan=i.readFloat32(),this.emissionRate=i.readFloat32(),this.speed=i.readFloat32(),i.readFloat32Array(this.color),this.alpha=i.readFloat32(),this.replaceableId=i.readUint32(),this.path=i.read(260),this.animationVisiblityGuide=i.read(260),this.readAnimations(i,e-(i.index-t))}writeMdx(i){i.writeUint32(this.getByteLength()),super.writeMdx(i),i.writeFloat32(this.lifeSpan),i.writeFloat32(this.emissionRate),i.writeFloat32(this.speed),i.writeFloat32Array(this.color),i.writeFloat32(this.alpha),i.writeUint32(this.replaceableId),i.skip(260-i.write(this.path)),i.skip(260-i.write(this.animationVisiblityGuide)),this.writeNonGenericAnimationChunks(i)}readMdl(i){for(const t of super.readGenericBlock(i))if(t==="SortPrimsFarZ")this.flags|=65536;else if(t==="Unshaded")this.flags|=32768;else if(t==="Unfogged")this.flags|=262144;else if(t==="static LifeSpan")this.lifeSpan=i.readFloat();else if(t==="LifeSpan")this.readAnimation(i,"KPPL");else if(t==="static EmissionRate")this.emissionRate=i.readFloat();else if(t==="EmissionRate")this.readAnimation(i,"KPPE");else if(t==="static Speed")this.speed=i.readFloat();else if(t==="Speed")this.readAnimation(i,"KPPS");else if(t==="static Color")i.readVector(this.color);else if(t==="Color")this.readAnimation(i,"KPPC");else if(t==="static Alpha")this.alpha=i.readFloat();else if(t==="Alpha")this.readAnimation(i,"KPPA");else if(t==="Visibility")this.readAnimation(i,"KPPV");else if(t==="ReplaceableId")this.replaceableId=i.readInt();else if(t==="Path")this.path=i.read();else if(t==="AnimVisibilityGuide")this.animationVisiblityGuide=i.read();else throw new Error(`Unknown token in ParticleEmitterPopcorn: "${t}"`)}writeMdl(i){i.startObjectBlock("ParticleEmitterPopcorn",this.name),this.writeGenericHeader(i),this.flags&65536&&i.writeFlag("SortPrimsFarZ"),this.flags&32768&&i.writeFlag("Unshaded"),this.flags&262144&&i.writeFlag("Unfogged"),this.writeAnimation(i,"KPPL")||i.writeNumberAttrib("static LifeSpan",this.lifeSpan),this.writeAnimation(i,"KPPE")||i.writeNumberAttrib("static EmissionRate",this.emissionRate),this.writeAnimation(i,"KPPS")||i.writeNumberAttrib("static Speed",this.speed),this.writeAnimation(i,"KPPC")||i.writeVectorAttrib("static Color",this.color),this.writeAnimation(i,"KPPA")||i.writeNumberAttrib("static Alpha",this.alpha),this.writeAnimation(i,"KPPV"),this.replaceableId!==0&&i.writeNumberAttrib("ReplaceableId",this.replaceableId),this.path.length&&i.writeStringAttrib("Path",this.path),this.animationVisiblityGuide.length&&i.writeStringAttrib("AnimVisibilityGuide",this.animationVisiblityGuide),this.writeGenericAnimations(i),i.endBlock()}getByteLength(){return 556+super.getByteLength()}}class O extends w{heightAbove=0;heightBelow=0;alpha=0;color=new Float32Array(3);lifeSpan=0;textureSlot=0;emissionRate=0;rows=0;columns=0;materialId=0;gravity=0;constructor(){super(16384)}readMdx(i){const t=i.index,e=i.readUint32();super.readMdx(i),this.heightAbove=i.readFloat32(),this.heightBelow=i.readFloat32(),this.alpha=i.readFloat32(),i.readFloat32Array(this.color),this.lifeSpan=i.readFloat32(),this.textureSlot=i.readUint32(),this.emissionRate=i.readUint32(),this.rows=i.readUint32(),this.columns=i.readUint32(),this.materialId=i.readInt32(),this.gravity=i.readFloat32(),this.readAnimations(i,e-(i.index-t))}writeMdx(i){i.writeUint32(this.getByteLength()),super.writeMdx(i),i.writeFloat32(this.heightAbove),i.writeFloat32(this.heightBelow),i.writeFloat32(this.alpha),i.writeFloat32Array(this.color),i.writeFloat32(this.lifeSpan),i.writeUint32(this.textureSlot),i.writeUint32(this.emissionRate),i.writeUint32(this.rows),i.writeUint32(this.columns),i.writeInt32(this.materialId),i.writeFloat32(this.gravity),this.writeNonGenericAnimationChunks(i)}readMdl(i){for(const t of super.readGenericBlock(i))if(t==="static HeightAbove")this.heightAbove=i.readFloat();else if(t==="HeightAbove")this.readAnimation(i,"KRHA");else if(t==="static HeightBelow")this.heightBelow=i.readFloat();else if(t==="HeightBelow")this.readAnimation(i,"KRHB");else if(t==="static Alpha")this.alpha=i.readFloat();else if(t==="Alpha")this.readAnimation(i,"KRAL");else if(t==="static Color")i.readColor(this.color);else if(t==="Color")this.readAnimation(i,"KRCO");else if(t==="static TextureSlot")this.textureSlot=i.readInt();else if(t==="TextureSlot")this.readAnimation(i,"KRTX");else if(t==="Visibility")this.readAnimation(i,"KRVS");else if(t==="EmissionRate")this.emissionRate=i.readInt();else if(t==="LifeSpan")this.lifeSpan=i.readFloat();else if(t==="Gravity")this.gravity=i.readFloat();else if(t==="Rows")this.rows=i.readInt();else if(t==="Columns")this.columns=i.readInt();else if(t==="MaterialID")this.materialId=i.readInt();else throw new Error(`Unknown token in RibbonEmitter: "${t}"`)}writeMdl(i){i.startObjectBlock("RibbonEmitter",this.name),this.writeGenericHeader(i),this.writeAnimation(i,"KRHA")||i.writeNumberAttrib("static HeightAbove",this.heightAbove),this.writeAnimation(i,"KRHB")||i.writeNumberAttrib("static HeightBelow",this.heightBelow),this.writeAnimation(i,"KRAL")||i.writeNumberAttrib("static Alpha",this.alpha),this.writeAnimation(i,"KRCO")||i.writeColor("static Color",this.color),this.writeAnimation(i,"KRTX")||i.writeNumberAttrib("static TextureSlot",this.textureSlot),this.writeAnimation(i,"KRVS"),i.writeNumberAttrib("EmissionRate",this.emissionRate),i.writeNumberAttrib("LifeSpan",this.lifeSpan),this.gravity!==0&&i.writeNumberAttrib("Gravity",this.gravity),i.writeNumberAttrib("Rows",this.rows),i.writeNumberAttrib("Columns",this.columns),i.writeNumberAttrib("MaterialID",this.materialId),this.writeGenericAnimations(i),i.endBlock()}getByteLength(){return 56+super.getByteLength()}}class K extends A{name="";position=new Float32Array(3);fieldOfView=0;farClippingPlane=0;nearClippingPlane=0;targetPosition=new Float32Array(3);readMdx(i){const t=i.readUint32();this.name=i.read(80),i.readFloat32Array(this.position),this.fieldOfView=i.readFloat32(),this.farClippingPlane=i.readFloat32(),this.nearClippingPlane=i.readFloat32(),i.readFloat32Array(this.targetPosition),this.readAnimations(i,t-120)}writeMdx(i){i.writeUint32(this.getByteLength()),i.skip(80-i.write(this.name)),i.writeFloat32Array(this.position),i.writeFloat32(this.fieldOfView),i.writeFloat32(this.farClippingPlane),i.writeFloat32(this.nearClippingPlane),i.writeFloat32Array(this.targetPosition),this.writeAnimations(i)}readMdl(i){this.name=i.read();for(let t of i.readBlock())if(t==="Position")i.readVector(this.position);else if(t==="Translation")this.readAnimation(i,"KCTR");else if(t==="Rotation")this.readAnimation(i,"KCRL");else if(t==="FieldOfView")this.fieldOfView=i.readFloat();else if(t==="FarClip")this.farClippingPlane=i.readFloat();else if(t==="NearClip")this.nearClippingPlane=i.readFloat();else if(t==="Target")for(t of i.readBlock())if(t==="Position")i.readVector(this.targetPosition);else if(t==="Translation")this.readAnimation(i,"KTTR");else throw new Error(`Unknown token in Camera ${this.name}'s Target: "${t}"`);else throw new Error(`Unknown token in Camera ${this.name}: "${t}"`)}writeMdl(i){i.startObjectBlock("Camera",this.name),i.writeVectorAttrib("Position",this.position),this.writeAnimation(i,"KCTR"),this.writeAnimation(i,"KCRL"),i.writeNumberAttrib("FieldOfView",this.fieldOfView),i.writeNumberAttrib("FarClip",this.farClippingPlane),i.writeNumberAttrib("NearClip",this.nearClippingPlane),i.startBlock("Target"),i.writeVectorAttrib("Position",this.targetPosition),this.writeAnimation(i,"KTTR"),i.endBlock(),i.endBlock()}getByteLength(){return 120+super.getByteLength()}}class j extends w{globalSequenceId=-1;tracks=new Uint32Array(0);constructor(){super(1024)}readMdx(i){super.readMdx(i),i.skip(4);const t=i.readUint32();this.globalSequenceId=i.readInt32(),this.tracks=i.readUint32Array(t)}writeMdx(i){super.writeMdx(i),i.writeBinary("KEVT"),i.writeUint32(this.tracks.length),i.writeInt32(this.globalSequenceId),i.writeUint32Array(this.tracks)}readMdl(i){for(const t of super.readGenericBlock(i))if(t==="EventTrack"){const e=i.readInt();this.tracks=new Uint32Array(e),i.read(),i.peek()==="GlobalSeqId"&&(i.read(),this.globalSequenceId=i.readInt());for(let s=0;s<e;s++)this.tracks[s]=i.readInt();i.read()}else throw new Error(`Unknown token in EventObject: "${t}"`)}writeMdl(i){i.startObjectBlock("EventObject",this.name),this.writeGenericHeader(i),i.startBlock("EventTrack",this.tracks.length),this.globalSequenceId!==-1&&i.writeNumberAttrib("GlobalSeqId",this.globalSequenceId);for(const t of this.tracks)i.writeFlag(`${t}`);i.endBlock(),this.writeGenericAnimations(i),i.endBlock()}getByteLength(){return 12+this.tracks.byteLength+super.getByteLength()}}class N extends w{type=0;vertices=[new Float32Array(3),new Float32Array(3)];boundsRadius=0;constructor(){super(8192)}readMdx(i){super.readMdx(i),this.type=i.readUint32(),i.readFloat32Array(this.vertices[0]),this.type!==2&&i.readFloat32Array(this.vertices[1]),(this.type===2||this.type===3)&&(this.boundsRadius=i.readFloat32())}writeMdx(i){super.writeMdx(i),i.writeUint32(this.type),i.writeFloat32Array(this.vertices[0]),this.type!==2&&i.writeFloat32Array(this.vertices[1]),(this.type===2||this.type===3)&&i.writeFloat32(this.boundsRadius)}readMdl(i){for(const t of super.readGenericBlock(i))if(t==="Box")this.type=0;else if(t==="Plane")this.type=1;else if(t==="Sphere")this.type=2;else if(t==="Cylinder")this.type=3;else if(t==="Vertices"){const e=i.readInt();i.read(),i.readVector(this.vertices[0]),e===2&&i.readVector(this.vertices[1]),i.read()}else if(t==="BoundsRadius")this.boundsRadius=i.readFloat();else throw new Error(`Unknown token in CollisionShape: "${t}"`)}writeMdl(i){i.startObjectBlock("CollisionShape",this.name),this.writeGenericHeader(i);let t="",e=2,s=!1;this.type===0?t="Box":this.type===1?t="Plane":this.type===2?(t="Sphere",e=1,s=!0):this.type===3&&(t="Cylinder",s=!0),i.writeFlag(t),i.startBlock("Vertices",e),i.writeVector(this.vertices[0]),e===2&&i.writeVector(this.vertices[1]),i.endBlock(),s&&i.writeNumberAttrib("BoundsRadius",this.boundsRadius),this.writeGenericAnimations(i),i.endBlock()}getByteLength(){let i=16+super.getByteLength();return this.type!==2&&(i+=12),(this.type===2||this.type===3)&&(i+=4),i}}class R{type="";path="";readMdx(i){this.type=i.read(80),this.path=i.read(260)}writeMdx(i){i.skip(80-i.write(this.type)),i.skip(260-i.write(this.path))}readMdl(i){this.type=i.read();for(const t of i.readBlock())if(t==="Path")this.path=i.read();else throw new Error(`Unknown token in FaceEffect: "${t}"`)}writeMdl(i){i.startObjectBlock("FaceFX",this.type),i.writeStringAttrib("Path",this.path),i.endBlock()}}class ti{tag;chunk;constructor(i,t,e){this.tag=e,this.chunk=i.readUint8Array(new Uint8Array(t))}writeMdx(i){i.writeBinary(this.tag),i.writeUint32(this.chunk.byteLength),i.writeUint8Array(this.chunk)}getByteLength(){return 8+this.chunk.byteLength}}function ei(n){return n instanceof ArrayBuffer&&(n=new Uint8Array(n)),!!(n instanceof Uint8Array&&n[0]===77&&n[1]===68&&n[2]===76&&n[3]===88||typeof n=="string"&&n.startsWith("MDLX"))}function ni(n){return n instanceof ArrayBuffer&&(n=new Uint8Array(n)),!!(n instanceof Uint8Array&&D(n,"FormatVersion",0,4096)||typeof n=="string"&&q(n,"FormatVersion",0,4096))}class oi{version=800;name="";animationFile="";extent=new u;blendTime=0;sequences=[];globalSequences=[];materials=[];textures=[];textureAnimations=[];geosets=[];geosetAnimations=[];bones=[];lights=[];helpers=[];attachments=[];pivotPoints=[];particleEmitters=[];particleEmitters2=[];particleEmittersPopcorn=[];ribbonEmitters=[];cameras=[];eventObjects=[];collisionShapes=[];faceEffects=[];bindPose=[];unknownChunks=[];load(i){if(ei(i))typeof i=="string"&&(i=H(i)),this.loadMdx(i);else if(ni(i))typeof i!="string"&&(i=$(i)),this.loadMdl(i);else throw new Error("Not a valid MDX/MDL buffer")}loadMdx(i){const t=new y(i);let e,s;for(t.skip(4);t.remaining>0;)e=t.readBinary(4),s=t.readUint32(),e==="VERS"?this.loadVersionChunk(t):e==="MODL"?this.loadModelChunk(t):e==="SEQS"?this.loadStaticObjects(this.sequences,B,t,s/132):e==="GLBS"?this.loadGlobalSequenceChunk(t,s):e==="MTLS"?this.loadDynamicObjects(this.materials,S,t,s):e==="TEXS"?this.loadStaticObjects(this.textures,F,t,s/268):e==="TXAN"?this.loadDynamicObjects(this.textureAnimations,M,t,s):e==="GEOS"?this.loadDynamicObjects(this.geosets,U,t,s):e==="GEOA"?this.loadDynamicObjects(this.geosetAnimations,v,t,s):e==="BONE"?this.loadDynamicObjects(this.bones,P,t,s):e==="LITE"?this.loadDynamicObjects(this.lights,C,t,s):e==="HELP"?this.loadDynamicObjects(this.helpers,L,t,s):e==="ATCH"?this.loadDynamicObjects(this.attachments,T,t,s):e==="PIVT"?this.loadPivotPointChunk(t,s):e==="PREM"?this.loadDynamicObjects(this.particleEmitters,E,t,s):e==="PRE2"?this.loadDynamicObjects(this.particleEmitters2,V,t,s):e==="CORN"?this.loadDynamicObjects(this.particleEmittersPopcorn,G,t,s):e==="RIBB"?this.loadDynamicObjects(this.ribbonEmitters,O,t,s):e==="CAMS"?this.loadDynamicObjects(this.cameras,K,t,s):e==="EVTS"?this.loadDynamicObjects(this.eventObjects,j,t,s):e==="CLID"?this.loadDynamicObjects(this.collisionShapes,N,t,s):e==="FAFX"?this.loadStaticObjects(this.faceEffects,R,t,s/340):e==="BPOS"?this.loadBindPoseChunk(t,s):this.unknownChunks.push(new ti(t,s,e))}loadVersionChunk(i){this.version=i.readUint32()}loadModelChunk(i){this.name=i.read(80),this.animationFile=i.read(260),this.extent.readMdx(i),this.blendTime=i.readUint32()}loadStaticObjects(i,t,e,s){for(let r=0;r<s;r++){const l=new t;l.readMdx(e),i.push(l)}}loadGlobalSequenceChunk(i,t){for(let e=0,s=t/4;e<s;e++)this.globalSequences.push(i.readUint32())}loadDynamicObjects(i,t,e,s){const r=e.index+s;for(;e.index<r;){const l=new t;l.readMdx(e,this.version),i.push(l)}}loadPivotPointChunk(i,t){for(let e=0,s=t/12;e<s;e++)this.pivotPoints.push(i.readFloat32Array(3))}loadBindPoseChunk(i,t){for(let e=0,s=i.readUint32();e<s;e++)this.bindPose[e]=i.readFloat32Array(12)}saveMdx(){const i=new y(new ArrayBuffer(this.getByteLength()));i.writeBinary("MDLX"),this.saveVersionChunk(i),this.saveModelChunk(i),this.saveStaticObjectChunk(i,"SEQS",this.sequences,132),this.saveGlobalSequenceChunk(i),this.saveDynamicObjectChunk(i,"MTLS",this.materials),this.saveStaticObjectChunk(i,"TEXS",this.textures,268),this.saveDynamicObjectChunk(i,"TXAN",this.textureAnimations),this.saveDynamicObjectChunk(i,"GEOS",this.geosets),this.saveDynamicObjectChunk(i,"GEOA",this.geosetAnimations),this.saveDynamicObjectChunk(i,"BONE",this.bones),this.saveDynamicObjectChunk(i,"LITE",this.lights),this.saveDynamicObjectChunk(i,"HELP",this.helpers),this.saveDynamicObjectChunk(i,"ATCH",this.attachments),this.savePivotPointChunk(i),this.saveDynamicObjectChunk(i,"PREM",this.particleEmitters),this.saveDynamicObjectChunk(i,"PRE2",this.particleEmitters2),this.version>800&&this.saveDynamicObjectChunk(i,"CORN",this.particleEmittersPopcorn),this.saveDynamicObjectChunk(i,"RIBB",this.ribbonEmitters),this.saveDynamicObjectChunk(i,"CAMS",this.cameras),this.saveDynamicObjectChunk(i,"EVTS",this.eventObjects),this.saveDynamicObjectChunk(i,"CLID",this.collisionShapes),this.version>800&&(this.saveStaticObjectChunk(i,"FAFX",this.faceEffects,340),this.saveBindPoseChunk(i));for(const t of this.unknownChunks)t.writeMdx(i);return i.uint8array}saveVersionChunk(i){i.writeBinary("VERS"),i.writeUint32(4),i.writeUint32(this.version)}saveModelChunk(i){i.writeBinary("MODL"),i.writeUint32(372),i.skip(80-i.write(this.name)),i.skip(260-i.write(this.animationFile)),this.extent.writeMdx(i),i.writeUint32(this.blendTime)}saveStaticObjectChunk(i,t,e,s){if(e.length){i.writeBinary(t),i.writeUint32(e.length*s);for(const r of e)r.writeMdx(i)}}saveGlobalSequenceChunk(i){if(this.globalSequences.length){i.writeBinary("GLBS"),i.writeUint32(this.globalSequences.length*4);for(const t of this.globalSequences)i.writeUint32(t)}}saveDynamicObjectChunk(i,t,e){if(e.length){i.writeBinary(t),i.writeUint32(this.getObjectsByteLength(e));for(const s of e)s.writeMdx(i,this.version)}}savePivotPointChunk(i){if(this.pivotPoints.length){i.writeBinary("PIVT"),i.writeUint32(this.pivotPoints.length*12);for(const t of this.pivotPoints)i.writeFloat32Array(t)}}saveBindPoseChunk(i){if(this.bindPose.length){i.writeBinary("BPOS"),i.writeUint32(4+this.bindPose.length*48),i.writeUint32(this.bindPose.length);for(const t of this.bindPose)i.writeFloat32Array(t)}}loadMdl(i){let t;const e=new k(i);for(;t=e.readToken();)if(t==="Version")this.loadVersionBlock(e);else if(t==="Model")this.loadModelBlock(e);else if(t==="Sequences")this.loadNumberedObjectBlock(this.sequences,B,"Anim",e);else if(t==="GlobalSequences")this.loadGlobalSequenceBlock(e);else if(t==="Textures")this.loadNumberedObjectBlock(this.textures,F,"Bitmap",e);else if(t==="Materials")this.loadNumberedObjectBlock(this.materials,S,"Material",e);else if(t==="TextureAnims")this.loadNumberedObjectBlock(this.textureAnimations,M,"TVertexAnim",e);else if(t==="Geoset")this.loadObject(this.geosets,U,e);else if(t==="GeosetAnim")this.loadObject(this.geosetAnimations,v,e);else if(t==="Bone")this.loadObject(this.bones,P,e);else if(t==="Light")this.loadObject(this.lights,C,e);else if(t==="Helper")this.loadObject(this.helpers,L,e);else if(t==="Attachment")this.loadObject(this.attachments,T,e);else if(t==="PivotPoints")this.loadPivotPointBlock(e);else if(t==="ParticleEmitter")this.loadObject(this.particleEmitters,E,e);else if(t==="ParticleEmitter2")this.loadObject(this.particleEmitters2,V,e);else if(t==="ParticleEmitterPopcorn")this.loadObject(this.particleEmittersPopcorn,G,e);else if(t==="RibbonEmitter")this.loadObject(this.ribbonEmitters,O,e);else if(t==="Camera")this.loadObject(this.cameras,K,e);else if(t==="EventObject")this.loadObject(this.eventObjects,j,e);else if(t==="CollisionShape")this.loadObject(this.collisionShapes,N,e);else if(t==="FaceFX")this.loadObject(this.faceEffects,R,e);else if(t==="BindPose")this.loadBindPoseBlock(e);else throw new Error(`Unsupported block: ${t}`)}loadVersionBlock(i){for(const t of i.readBlock())if(t==="FormatVersion")this.version=i.readInt();else throw new Error(`Unknown token in Version: "${t}"`)}loadModelBlock(i){this.name=i.read();for(const t of i.readBlock())if(t.startsWith("Num"))i.read();else if(t==="BlendTime")this.blendTime=i.readInt();else if(t==="MinimumExtent")i.readVector(this.extent.min);else if(t==="MaximumExtent")i.readVector(this.extent.max);else if(t==="BoundsRadius")this.extent.boundsRadius=i.readFloat();else if(t==="AnimationFile")this.animationFile=i.read();else throw new Error(`Unknown token in Model: "${t}"`)}loadNumberedObjectBlock(i,t,e,s){s.read();for(const r of s.readBlock())if(r===e){const l=new t;l.readMdl(s),i.push(l)}else throw new Error(`Unknown token in ${e}: "${r}"`)}loadGlobalSequenceBlock(i){i.read();for(const t of i.readBlock())if(t==="Duration")this.globalSequences.push(i.readInt());else throw new Error(`Unknown token in GlobalSequences: "${t}"`)}loadObject(i,t,e){const s=new t;s.readMdl(e),i.push(s)}loadPivotPointBlock(i){const t=i.readInt();i.read();for(let e=0;e<t;e++)this.pivotPoints.push(i.readVector(new Float32Array(3)));i.read()}loadBindPoseBlock(i){for(const t of i.readBlock())if(t==="Matrices"){const e=i.readInt();i.read();for(let s=0;s<e;s++)this.bindPose[s]=i.readVector(new Float32Array(12));i.read()}else throw new Error(`Unknown token in BindPose: "${t}"`)}saveMdl(){const i=new k;return this.saveVersionBlock(i),this.saveModelBlock(i),this.saveStaticObjectsBlock(i,"Sequences",this.sequences),this.saveGlobalSequenceBlock(i),this.saveStaticObjectsBlock(i,"Textures",this.textures),this.saveStaticObjectsBlock(i,"Materials",this.materials),this.saveStaticObjectsBlock(i,"TextureAnims",this.textureAnimations),this.saveObjects(i,this.geosets),this.saveObjects(i,this.geosetAnimations),this.saveObjects(i,this.bones),this.saveObjects(i,this.lights),this.saveObjects(i,this.helpers),this.saveObjects(i,this.attachments),this.savePivotPointBlock(i),this.saveObjects(i,this.particleEmitters),this.saveObjects(i,this.particleEmitters2),this.version>800&&this.saveObjects(i,this.particleEmittersPopcorn),this.saveObjects(i,this.ribbonEmitters),this.saveObjects(i,this.cameras),this.saveObjects(i,this.eventObjects),this.saveObjects(i,this.collisionShapes),this.version>800&&(this.saveObjects(i,this.faceEffects),this.saveBindPoseBlock(i)),i.buffer}saveVersionBlock(i){i.startBlock("Version"),i.writeNumberAttrib("FormatVersion",this.version),i.endBlock()}saveModelBlock(i){i.startObjectBlock("Model",this.name),i.writeNumberAttrib("BlendTime",this.blendTime),this.extent.writeMdl(i),this.animationFile.length&&i.writeStringAttrib("AnimationFile",this.animationFile),i.endBlock()}saveStaticObjectsBlock(i,t,e){if(e.length){i.startBlock(t,e.length);for(const s of e)s.writeMdl(i,this.version);i.endBlock()}}saveGlobalSequenceBlock(i){if(this.globalSequences.length){i.startBlock("GlobalSequences",this.globalSequences.length);for(const t of this.globalSequences)i.writeNumberAttrib("Duration",t);i.endBlock()}}saveObjects(i,t){for(const e of t)e.writeMdl(i,this.version)}savePivotPointBlock(i){if(this.pivotPoints.length){i.startBlock("PivotPoints",this.pivotPoints.length);for(const t of this.pivotPoints)i.writeVector(t);i.endBlock()}}saveBindPoseBlock(i){if(this.bindPose.length){i.startBlock("BindPose"),i.startBlock("Matrices",this.bindPose.length);for(const t of this.bindPose)i.writeVector(t);i.endBlock(),i.endBlock()}}getByteLength(){let i=396;return i+=this.getStaticObjectsChunkByteLength(this.sequences,132),i+=this.getStaticObjectsChunkByteLength(this.globalSequences,4),i+=this.getDynamicObjectsChunkByteLength(this.materials),i+=this.getStaticObjectsChunkByteLength(this.textures,268),i+=this.getDynamicObjectsChunkByteLength(this.textureAnimations),i+=this.getDynamicObjectsChunkByteLength(this.geosets),i+=this.getDynamicObjectsChunkByteLength(this.geosetAnimations),i+=this.getDynamicObjectsChunkByteLength(this.bones),i+=this.getDynamicObjectsChunkByteLength(this.lights),i+=this.getDynamicObjectsChunkByteLength(this.helpers),i+=this.getDynamicObjectsChunkByteLength(this.attachments),i+=this.getStaticObjectsChunkByteLength(this.pivotPoints,12),i+=this.getDynamicObjectsChunkByteLength(this.particleEmitters),i+=this.getDynamicObjectsChunkByteLength(this.particleEmitters2),this.version>800&&(i+=this.getDynamicObjectsChunkByteLength(this.particleEmittersPopcorn)),i+=this.getDynamicObjectsChunkByteLength(this.ribbonEmitters),i+=this.getDynamicObjectsChunkByteLength(this.cameras),i+=this.getDynamicObjectsChunkByteLength(this.eventObjects),i+=this.getDynamicObjectsChunkByteLength(this.collisionShapes),this.version>800&&(i+=this.getStaticObjectsChunkByteLength(this.faceEffects,340),i+=this.getBindPoseChunkByteLength()),i+=this.getObjectsByteLength(this.unknownChunks),i}getObjectsByteLength(i){let t=0;for(const e of i)t+=e.getByteLength(this.version);return t}getDynamicObjectsChunkByteLength(i){return i.length?8+this.getObjectsByteLength(i):0}getStaticObjectsChunkByteLength(i,t){return i.length?8+i.length*t:0}getBindPoseChunkByteLength(){return this.bindPose.length?12+this.bindPose.length*48:0}}export{g as A,P as B,K as C,u as E,m as F,w as G,ii as H,z as I,I as L,oi as M,E as P,O as R,B as S,F as T,p as U,c as V,Q as W,J as a,X as b,W as c,S as d,U as e,v as f,o as g,_ as h,ei as i,ni as j,R as k,A as l,M as m,C as n,L as o,T as p,V as q,G as r,j as s,N as t};
