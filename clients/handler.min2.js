import{a as F,b as Y,i as v}from"./tokenstream.min.js";import{N as X,T as P}from"./handler.min.js";import{i as y}from"./math.min.js";const z=X(4,8),D=X(5,8),M=X(6,8),x=new Uint8Array(16),_=new Uint8Array(12),G=new Uint8Array(8),L=new Uint8Array(8),B=new Uint8Array(8);function V(e,t,s){const i=(t>>11&31)*D,n=(t>>5&63)*M,a=(t&31)*D,r=(s>>11&31)*D,c=(s>>5&63)*M,f=(s&31)*D;e[0]=i,e[1]=n,e[2]=a,e[3]=255,e[4]=r,e[5]=c,e[6]=f,e[7]=255,t>s?(e[8]=5*i+3*r>>3,e[9]=5*n+3*c>>3,e[10]=5*a+3*f>>3,e[11]=255,e[12]=5*r+3*i>>3,e[13]=5*c+3*n>>3,e[14]=5*f+3*a>>3,e[15]=255):(e[8]=i+r>>1,e[9]=n+c>>1,e[10]=a+f>>1,e[11]=255,e[12]=0,e[13]=0,e[14]=0,e[15]=0)}function H(e,t,s){const i=(t>>11&31)*D,n=(t>>5&63)*M,a=(t&31)*D,r=(s>>11&31)*D,c=(s>>5&63)*M,f=(s&31)*D;e[0]=i,e[1]=n,e[2]=a,e[3]=r,e[4]=c,e[5]=f,e[6]=5*i+3*r>>3,e[7]=5*n+3*c>>3,e[8]=5*a+3*f>>3,e[9]=5*r+3*i>>3,e[10]=5*c+3*n>>3,e[11]=5*f+3*a>>3}function K(e,t,s){e[0]=t,e[1]=s,t>s?(e[2]=54*t+9*s>>6,e[3]=45*t+18*s>>6,e[4]=36*t+27*s>>6,e[5]=27*t+36*s>>6,e[6]=18*t+45*s>>6,e[7]=9*t+54*s>>6):(e[2]=12*t+3*s>>4,e[3]=9*t+6*s>>4,e[4]=6*t+9*s>>4,e[5]=3*t+12*s>>4,e[6]=0,e[7]=255)}function u(e,t,s){e[0]=t,e[1]=s,t>s?(e[2]=(6*t+1*s)/7,e[3]=(5*t+2*s)/7,e[4]=(4*t+3*s)/7,e[5]=(3*t+4*s)/7,e[6]=(2*t+5*s)/7,e[7]=(1*t+6*s)/7):(e[2]=(4*t+1*s)/5,e[3]=(3*t+2*s)/5,e[4]=(2*t+3*s)/5,e[5]=(1*t+4*s)/5,e[6]=0,e[7]=1)}function $(e,t,s){const i=new Uint8Array(t*s*4);for(let n=0,a=s/4;n<a;n++)for(let r=0,c=t/4;r<c;r++){const f=8*(n*c+r);V(x,e[f]+256*e[f+1],e[f+2]+256*e[f+3]);const g=n*16*t+r*16,d=e[f+4]|e[f+5]<<8|e[f+6]<<16|e[f+7]<<24;for(let l=0;l<4;l++){const o=l*8,h=g+l*t*4;for(let m=0;m<4;m++){const T=h+m*4,p=(d>>o+m*2&3)*4;i[T+0]=x[p+0],i[T+1]=x[p+1],i[T+2]=x[p+2],i[T+3]=x[p+3]}}}return i}function q(e,t,s){const i=new Uint8Array(t*s*4),n=t*4;for(let a=0,r=s/4;a<r;a++)for(let c=0,f=t/4;c<f;c++){const g=16*(a*f+c);H(_,e[g+8]+256*e[g+9],e[g+10]+256*e[g+11]);let d=a*16*t+c*16;for(let l=0;l<4;l++){const o=e[g+l*2]+256*e[g+1+l*2],h=e[g+12+l];for(let m=0;m<4;m++){const T=d+m*4,p=(h>>m*2&3)*3;i[T+0]=_[p+0],i[T+1]=_[p+1],i[T+2]=_[p+2],i[T+3]=(o>>m*4&15)*z}d+=n}}return i}function J(e,t,s){const i=new Uint8Array(t*s*4),n=t*4;for(let a=0,r=s/4;a<r;a++)for(let c=0,f=t/4;c<f;c++){const g=16*(a*f+c);K(G,e[g],e[g+1]),H(_,e[g+8]+256*e[g+9],e[g+10]+256*e[g+11]);let d=a*16*t+c*16;for(let l=0;l<2;l++){const o=g+2+l*3,h=g+12+l*2,m=e[o]+256*(e[o+1]+256*e[o+2]);for(let T=0;T<2;T++){const p=e[h+T];for(let E=0;E<4;E++){const I=d+E*4,w=(p>>E*2&3)*3,W=m>>T*12+E*3&7;i[I+0]=_[w+0],i[I+1]=_[w+1],i[I+2]=_[w+2],i[I+3]=G[W]}d+=n}}}return i}function Q(e,t,s){const i=new Uint8Array(t*s*2),n=t*2;for(let a=0,r=s/4;a<r;a++)for(let c=0,f=t/4;c<f;c++){const g=16*(a*f+c);u(L,e[g],e[g+1]),u(B,e[g+8],e[g+9]);let d=a*8*t+c*8;for(let l=0;l<2;l++){const o=g+l*3,h=e[o+2]+256*(e[o+3]+256*e[o+4]),m=e[o+10]+256*(e[o+11]+256*e[o+12]);for(let T=0;T<2;T++){const p=T*4;for(let E=0;E<4;E++){const I=d+E*2,w=3*(p+E);i[I+1]=L[h>>w&7],i[I+2]=B[m>>w&7]}d+=n}}}return i}const Z=542327876,j=131072,tt=4,R=827611204,U=861165636,A=894720068,C=843666497,et=808540228,st=71,it=74,at=77,nt=83;class b{width=0;height=0;format=0;mipmapWidths=[];mipmapHeights=[];mipmapDatas=[];load(t){const s=F(t),i=new Int32Array(s.buffer,0,31);let n=128;if(i[0]!==Z)throw new Error("Wrong magic number");if(!(i[20]&tt))throw new Error("Not FourCC");let a=i[21];if(a!==R&&a!==U&&a!==A&&a!==C)if(a===et){n+=20;const d=new Int32Array(s.buffer,128,5),l=d[0];if(l===st)a=R;else if(l===it)a=U;else if(l===at)a=A;else if(l===nt)a=C;else throw new Error(`Unsupported DXGI format: ${l}`);console.log(d)}else throw new Error(`Unsupported FourCC: ${Y(a)}`);this.format=a;let r=1;i[2]&j&&(r=Math.max(1,i[7]));let c=i[4],f=i[3],g=16;a===R&&(g=8),this.width=c,this.height=f;for(let d=0;d<r;d++){const l=Math.max(4,c)/4*Math.max(4,f)/4*g;this.mipmapWidths[d]=c,this.mipmapHeights[d]=f,this.mipmapDatas[d]=s.subarray(n,n+l),n+=l,c=Math.max(c/2,1),f=Math.max(f/2,1)}}mipmaps(){return this.mipmapDatas.length}getMipmap(t,s=!1){const i=this.mipmapWidths[t],n=this.mipmapHeights[t],a=this.mipmapDatas[t];let r;return s?r=a:this.format===R?r=$(a,i,n):this.format===U?r=q(a,i,n):this.format===A?r=J(a,i,n):r=Q(a,i,n),{width:i,height:n,data:r}}}function rt(e){return e instanceof ArrayBuffer&&(e=new Uint8Array(e)),e instanceof Uint8Array&&e[0]===68&&e[1]===68&&e[2]===83&&e[3]===32}const ot=0,ct=1,lt=3,k=9,ft=10,O=11,ht=0,S=2,gt=3,dt=4,mt=48;class Tt{_checkHeader(){const t=this.header;if(t.imageType===ot)throw Error("No data");if(t.hasColorMap){if(t.colorMapLength>256||t.colorMapDepth!==24||t.colorMapType!==1)throw Error("Invalid colormap for indexed type")}else if(t.colorMapType)throw Error("Why does the image contain a palette ?");if(!t.width||!t.height)throw Error("Invalid image size");if(t.pixelDepth!==8&&t.pixelDepth!==16&&t.pixelDepth!==24&&t.pixelDepth!==32)throw Error('Invalid pixel size "'+t.pixelDepth+'"')}_decodeRLE(t,s,i,n){const a=new Uint8Array(n),r=new Uint8Array(i);let c=0;for(;c<n;){const f=t[s++];let g=1+(127&f);if(128&f){for(let d=0;d<i;++d)r[d]=t[s+d];s+=i;for(let d=0;d<g;++d)a.set(r,c),c+=i}else{g*=i;for(let d=0;d<g;++d)a[c+d]=t[s+d];c+=g,s+=g}}return a}_getImageData8bits(t,s,i,n,a,r,c,f,g,d){for(let l=0,o=a;o!==c;o+=r)for(let h=f;h!==d;h+=g,l++){const m=s[l];t[4*(h+n*o)+3]=255,t[4*(h+n*o)+2]=i[3*m+0],t[4*(h+n*o)+1]=i[3*m+1],t[4*(h+n*o)+0]=i[3*m+2]}return t}_getImageData16bits(t,s,i,n,a,r,c,f,g,d){for(let l=0,o=a;o!==c;o+=r)for(let h=f;h!==d;h+=g,l+=2){const m=s[l+0]|s[l+1]<<8;t[4*(h+n*o)+0]=(31744&m)>>7,t[4*(h+n*o)+1]=(992&m)>>2,t[4*(h+n*o)+2]=(31&m)>>3,t[4*(h+n*o)+3]=32768&m?0:255}return t}_getImageData24bits(t,s,i,n,a,r,c,f,g,d){for(let l=0,o=a;o!==c;o+=r)for(let h=f;h!==d;h+=g,l+=3)t[4*(h+n*o)+3]=255,t[4*(h+n*o)+2]=s[l+0],t[4*(h+n*o)+1]=s[l+1],t[4*(h+n*o)+0]=s[l+2];return t}_getImageData32bits(t,s,i,n,a,r,c,f,g,d){for(let l=0,o=a;o!==c;o+=r)for(let h=f;h!==d;h+=g,l+=4)t[4*(h+n*o)+2]=s[l+0],t[4*(h+n*o)+1]=s[l+1],t[4*(h+n*o)+0]=s[l+2],t[4*(h+n*o)+3]=s[l+3];return t}_getImageDataGrey8bits(t,s,i,n,a,r,c,f,g,d){for(let l=0,o=a;o!==c;o+=r)for(let h=f;h!==d;h+=g,l++){const m=s[l];t[4*(h+n*o)+0]=m,t[4*(h+n*o)+1]=m,t[4*(h+n*o)+2]=m,t[4*(h+n*o)+3]=255}return t}_getImageDataGrey16bits(t,s,i,n,a,r,c,f,g,d){for(let l=0,o=a;o!==c;o+=r)for(let h=f;h!==d;h+=g,l+=2)t[4*(h+n*o)+0]=s[l+0],t[4*(h+n*o)+1]=s[l+0],t[4*(h+n*o)+2]=s[l+0],t[4*(h+n*o)+3]=s[l+1];return t}open(t,s){const i=new XMLHttpRequest;i.responseType="arraybuffer",i.open("GET",t,!0),i.onload=(()=>{i.status===200&&(this.load(new Uint8Array(i.response)),s&&s())}),i.send(null)}load(t){let s=0;if(t.length<18)throw Error("Not enough data to contain header");const i={idLength:t[s++],colorMapType:t[s++],imageType:t[s++],colorMapIndex:t[s++]|t[s++]<<8,colorMapLength:t[s++]|t[s++]<<8,colorMapDepth:t[s++],offsetX:t[s++]|t[s++]<<8,offsetY:t[s++]|t[s++]<<8,width:t[s++]|t[s++]<<8,height:t[s++]|t[s++]<<8,pixelDepth:t[s++],flags:t[s++]};if(i.hasEncoding=i.imageType===k||i.imageType===ft||i.imageType===O,i.hasColorMap=i.imageType===k||i.imageType===ct,i.isGreyColor=i.imageType===O||i.imageType===lt,this.header=i,this._checkHeader(),(s+=i.idLength)>=t.length)throw Error("No data");if(i.hasColorMap){const c=i.colorMapLength*(i.colorMapDepth>>3);this.palette=t.subarray(s,s+c),s+=c}const n=i.pixelDepth>>3,a=i.width*i.height,r=a*n;i.hasEncoding?this.imageData=this._decodeRLE(t,s,n,r):this.imageData=t.subarray(s,s+(i.hasColorMap?a:r))}getImageData(t){const{width:s,height:i,flags:n,pixelDepth:a,isGreyColor:r}=this.header,c=(n&mt)>>dt;let f,g,d,l,o,h,m;switch(t||(t=document?document.createElement("canvas").getContext("2d").createImageData(s,i):{width:s,height:i,data:new Uint8ClampedArray(s*i*4)}),c===S||c===gt?(l=0,o=1,h=i):(l=i-1,o=-1,h=-1),c===S||c===ht?(f=0,g=1,d=s):(f=s-1,g=-1,d=-1),a){case 8:m=r?this._getImageDataGrey8bits:this._getImageData8bits;break;case 16:m=r?this._getImageDataGrey16bits:this._getImageData16bits;break;case 24:m=this._getImageData24bits;break;case 32:m=this._getImageData32bits}return m.call(this,t.data,this.imageData,this.palette,s,l,o,h,f,g,d),t}getCanvas(){const{width:t,height:s}=this.header,i=document.createElement("canvas"),n=i.getContext("2d"),a=n.createImageData(t,s);return i.width=t,i.height=s,n.putImageData(this.getImageData(a),0,0),i}getDataURL(t){return this.getCanvas().toDataURL(t||"image/png")}}class N{width=0;height=0;data=null;load(t){const s=F(t),i=new Tt;i.load(s);const n=i.header;this.width=n.width,this.height=n.height,this.data=new ImageData(n.width,n.height),i.getImageData(this.data)}}function pt(e){return e instanceof ArrayBuffer&&(e=new Uint8Array(e)),!!(e instanceof Uint8Array&&v(e,"TRUEVISION-XFILE.\0",e.length-18))}class Et extends P{constructor(t,s){super(s);let i;t instanceof b?i=t:(i=new b,i.load(t));const n=this.viewer,a=n.gl,c=n.webgl.extensions.WEBGL_compressed_texture_s3tc,f=i.format;let g=0;c&&(f===R?g=c.COMPRESSED_RGB_S3TC_DXT1_EXT:f===U?g=c.COMPRESSED_RGBA_S3TC_DXT3_EXT:f===A&&(g=c.COMPRESSED_RGBA_S3TC_DXT5_EXT));const d=a.createTexture();this.width=i.width,this.height=i.height,this.webglResource=d,a.bindTexture(a.TEXTURE_2D,d);const l=i.mipmaps();(f===R||f===C)&&a.pixelStorei(a.UNPACK_ALIGNMENT,2);for(let o=0;o<l;o++){const{width:h,height:m,data:T}=i.getMipmap(o,g!==0);g?a.compressedTexImage2D(a.TEXTURE_2D,o,g,h,m,0,T):f===R||f===U||f===A?a.texImage2D(a.TEXTURE_2D,o,a.RGBA,h,m,0,a.RGBA,a.UNSIGNED_BYTE,T):a.texImage2D(a.TEXTURE_2D,o,a.LUMINANCE_ALPHA,h,m,0,a.LUMINANCE_ALPHA,a.UNSIGNED_BYTE,T)}a.pixelStorei(a.UNPACK_ALIGNMENT,4),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),l>1?a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR_MIPMAP_LINEAR):a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR)}}const wt={load(e){e.webgl.ensureExtension("WEBGL_compressed_texture_s3tc")||console.warn("DDS: No compressed textures support! This might reduce performance.")},isValidSource(e){return e instanceof b?!0:rt(e)},resource:Et};class Dt extends P{constructor(t,s){super(s);let i;t instanceof N?i=t:(i=new N,i.load(t));const n=i.width,a=i.height,r=this.viewer.gl,c=r.createTexture();r.bindTexture(r.TEXTURE_2D,c),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,i.data),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),y(n)&&y(a)?(r.generateMipmap(r.TEXTURE_2D),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR_MIPMAP_LINEAR)):r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),this.webglResource=c,this.width=n,this.height=a}}const xt={isValidSource(e){return e instanceof N?!0:pt(e)},resource:Dt};export{b as D,R as F,N as T,U as a,A as b,C as c,wt as d,xt as t};
