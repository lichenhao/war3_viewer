import{c as T,l as L}from"./math.min.js";import{c as C,e as S,A as k,D as _,r as E,E as A,S as N,v as q,F as B,H as U,I as V,J as R,K as P,L as D}from"./handler.min.js";class F{texture=null;wrapS=33071;wrapT=33071;constructor(e,s){e&&(this.wrapS=10497),s&&(this.wrapT=10497)}}const I={diffuse:1,decal:2,specular:3,gloss:4,emissive:5,emissive2:6,evio:7,evioMask:8,alphaMask:9,alphaMask2:10,normal:11,heightMap:12,lightMap:13,ao:14};class p{model;material;index;active=0;layer=null;gl;uniformMap;source="";texture=null;flags=0;colorChannels=0;type="";op=0;uvCoordinate=0;textureUnit=0;invert=0;clampResult=0;teamColorMode=0;constructor(e,s,t,o,n){const l=e.model;this.model=l,this.material=e,this.gl=e.gl,this.index=s;const a="u_"+o,r=a+"LayerSettings.";if(this.uniformMap={map:a+"Map",enabled:r+"enabled",op:r+"op",channels:r+"channels",teamColorMode:r+"teamColorMode",invert:r+"invert",clampResult:r+"clampResult",uvCoordinate:r+"uvCoordinate"},t.entries){const i=t.first();this.layer=i;const d=l.pathSolver,m=i.imagePath.get();if(m){const u=m.toLowerCase();if(u.length){this.source=u,this.active=1;const h=i.uvSource,f=i.flags;this.flags=f,this.colorChannels=i.colorChannelSetting,this.model=l,this.type=o,this.op=n;let c=0;h===1?c=1:h===9?c=2:h===10&&(c=3),this.uvCoordinate=c,this.textureUnit=I[o],this.invert=f&16,this.clampResult=f&32,o==="diffuse"&&(this.teamColorMode=1);const b=new F(!!(f&4),!!(f&8));l.viewer.load(u,d).then(M=>{M&&(b.texture=M)}),this.texture=b}}}}bind(e,s){const t=this.gl,o=this.uniformMap,n=e.uniforms,l=this.active;if(t.uniform1f(n[o.enabled],l),l){const a=this.texture,r=s.get(this.material.index*w+this.index)||a.texture,i=this.textureUnit;t.uniform1i(n[o.map],i),this.model.viewer.webgl.bindTextureAndWrap(r,i,a.wrapS,a.wrapT),t.uniform1f(n[o.op],this.op),t.uniform1f(n[o.channels],this.colorChannels),t.uniform1f(n[o.teamColorMode],this.teamColorMode),t.uniform1f(n[o.invert],this.invert),t.uniform1f(n[o.clampResult],this.clampResult),t.uniform1f(n[o.uvCoordinate],this.uvCoordinate)}}unbind(e){this.active&&this.gl.uniform1f(e.uniforms[this.uniformMap.enabled],0)}}const w=100;class z{model;gl;index;name;flags;blendMode;priority;specularity;specMult;emisMult;layerBlendType;emisBlendType;emisMode;doubleSided;layers;constructor(e,s,t){this.model=e,this.gl=e.viewer.gl,this.index=s,this.name=t.name.get(),this.flags=t.flags,this.blendMode=t.blendMode,this.priority=t.priority,this.specularity=t.specularity,this.specMult=t.specMult,this.emisMult=t.emisMult,this.layerBlendType=t.layerBlendType,this.emisBlendType=t.emisBlendType,this.emisMode=t.emisMode,this.doubleSided=t.flags&8,this.layers=[new p(this,0,t.diffuseLayer,"diffuse",2),new p(this,1,t.decalLayer,"decal",2),new p(this,2,t.specularLayer,"specular",2),new p(this,3,t.glossLayer,"gloss",2),new p(this,4,t.emissiveLayer,"emissive",t.emisBlendType),new p(this,5,t.emissive2Layer,"emissive2",t.emisMode),new p(this,6,t.evioLayer,"evio",2),new p(this,7,t.evioMaskLayer,"evioMask",2),new p(this,8,t.alphaMaskLayer,"alphaMask",2),new p(this,9,t.alphaMask2Layer,"alphaMask2",2),new p(this,10,t.normalLayer,"normal",2),new p(this,11,t.heightLayer,"heightMap",2),new p(this,12,t.lightMapLayer,"lightMap",2),new p(this,13,t.ambientOcclusionLayer,"ao",2)]}bindCommon(){const e=this.gl;this.blendMode===1||this.blendMode===2?(e.enable(e.BLEND),e.blendFunc(e.ONE,e.ONE)):e.disable(e.BLEND),this.doubleSided?e.disable(e.CULL_FACE):e.enable(e.CULL_FACE),e.enable(e.DEPTH_TEST),e.depthMask(!0)}bind(e,s){const t=this.gl;this.bindCommon(),t.uniform1f(e.uniforms.u_specularity,this.specularity),t.uniform1f(e.uniforms.u_specMult,this.specMult),t.uniform1f(e.uniforms.u_emisMult,this.emisMult),t.uniform4f(e.uniforms.u_lightAmbient,.02,.02,.02,0);const o=this.layers;o[0].bind(e,s),o[1].bind(e,s),o[2].bind(e,s),o[4].bind(e,s),o[5].bind(e,s),o[10].bind(e,s),o[12].bind(e,s)}unbind(e){const s=this.gl;s.disable(s.BLEND),s.enable(s.CULL_FACE);const t=this.layers;t[0].unbind(e),t[1].unbind(e),t[2].unbind(e),t[4].unbind(e),t[5].unbind(e),t[10].unbind(e),t[12].unbind(e)}}const v=C(),y=S();class H{keys;values;biggestKey;constructor(e){this.keys=e.keys.get(),this.values=e.values.get(),this.biggestKey=e.biggestKey}}class G{sd=[];addSds(e){for(const s of e)this.sd.push(new H(s))}getValueUnsafe(e,s,t,o){const n=this.sd[e];o&&(t=t%n.biggestKey);const l=n.keys,a=n.values;let r=l.length,i=0;for(;i!==l.length&&t>l[i];)r=i,i++;const d=l.length;if(r===d)return i===d?s.initValue:a[i];if(i===d||r>=i)return a[r];const m=T((t-l[r])/(l[i]-l[r]),0,1),u=a[r],h=a[i],f=s.interpolationType,c=u;return c.length===4?f===0?k(y,u):_(y,u,h,m):c.length===3?f===0?E(v,u):A(v,u,h,m):f===0?u:L(u,h,m)}}class Y extends N{convertBasis(e){const s=Math.PI/2;q(e,e,s),B(e,e,-s)}}class K{nodes;worldMatrices;instance;modelNodes;initialReference;sts;stc;stg;boneLookup;constructor(e){const s=e.model,t=s.bones,o=s.boneLookup,n=U(t.length,Y),l=n.nodes;this.nodes=l,this.worldMatrices=n.worldMatrices,this.instance=e,this.modelNodes=t,this.initialReference=s.initialReference,this.sts=s.sts,this.stc=s.stc,this.stg=s.stg,this.boneLookup=o;for(let a=0,r=t.length;a<r;a++){const i=t[a];i.parent===-1?l[a].parent=e:l[a].parent=l[i.parent],i.billboard1&&(l[a].billboarded=!0)}}update(e){const s=this.instance,t=this.nodes,o=this.modelNodes;for(let n=0,l=t.length;n<l;n++){const a=t[n],r=o[n];this.getValue4(a.localRotation,r.rotation,s),this.getValue3(a.localLocation,r.location,s),this.getValue3(a.localScale,r.scale,s),a.recalculateTransformation(s);for(const i of a.children)i.recalculateTransformation(),i.update(e)}}getValueUnsafe(e,s){const t=s.sequence;return t!==-1?this.stg[t].getValueUnsafe(e,s):e.initValue}getValue(e,s){return this.getValueUnsafe(e,s)}getValue2(e,s,t){const o=this.getValueUnsafe(s,t);return e[0]=o[0],e[1]=o[1],e}getValue3(e,s,t){const o=this.getValueUnsafe(s,t);return e[0]=o[0],e[1]=o[1],e[2]=o[2],e}getValue4(e,s,t){const o=this.getValueUnsafe(s,t);return e[0]=o[0],e[1]=o[1],e[2]=o[2],e[3]=o[3],e}}const x=V();class j extends R{skeleton=null;teamColor=0;vertexColor=new Float32Array([1,1,1,1]);sequence=-1;frame=0;sequenceLoopMode=0;sequenceEnded=!1;forced=!0;boneTexture=null;constructor(e){super(e),this.skeleton=new K(this),this.sequence!==-1&&this.setSequence(this.sequence),this.boneTexture=new P(e.viewer.gl,3,e.boneLookup.length*4,1)}setTexture(e,s,t){this.overrideTexture(e*w+s,t)}updateSkeletonAndBoneTexture(e){const s=this.model,o=s.viewer.buffer,n=s.boneLookup,l=this.skeleton,a=l.nodes,r=s.initialReference,i=n.length,d=this.sequence!==-1,m=this.boneTexture;l.update(e),o.reserve(i*48);const u=o.floatView;let h;d?h=x:h=this.worldMatrix;for(let f=0;f<i;f++){const c=f*12;if(d){const b=n[f];h=D(x,a[b].worldMatrix,r[b])}u[c+0]=h[0],u[c+1]=h[1],u[c+2]=h[2],u[c+3]=h[4],u[c+4]=h[5],u[c+5]=h[6],u[c+6]=h[8],u[c+7]=h[9],u[c+8]=h[10],u[c+9]=h[12],u[c+10]=h[13],u[c+11]=h[14]}m.bindAndUpdate(u,m.width,1)}renderOpaque(){const e=this.model,s=e.batches;if(s.length){const t=e.viewer,o=t.sharedCache.get("m3"),n=t.gl,l=e.vertexSize,a=e.uvSetCount,r=o.standardShaders[a-1],i=r.attribs,d=r.uniforms,m=this.scene,u=m.camera,h=this.textureOverrides,f=this.boneTexture;r.use(),n.uniform1f(d.u_teamColor,this.teamColor),n.uniform4fv(d.u_vertexColor,this.vertexColor),n.uniformMatrix4fv(d.u_VP,!1,u.viewProjectionMatrix),n.uniformMatrix4fv(d.u_MV,!1,u.viewMatrix),n.uniform3fv(d.u_eyePos,u.location),n.uniform3fv(d.u_lightPos,m.lightPosition),f.bind(15),n.uniform1i(d.u_boneMap,15),n.uniform1f(d.u_vectorSize,1/f.width),n.uniform1f(d.u_rowSize,1),n.bindBuffer(n.ARRAY_BUFFER,e.arrayBuffer),n.vertexAttribPointer(i.a_position,3,n.FLOAT,!1,l,0),n.vertexAttribPointer(i.a_weights,4,n.UNSIGNED_BYTE,!1,l,12),n.vertexAttribPointer(i.a_bones,4,n.UNSIGNED_BYTE,!1,l,16),n.vertexAttribPointer(i.a_normal,4,n.UNSIGNED_BYTE,!1,l,20);for(let c=0;c<a;c++)n.vertexAttribPointer(i[`a_uv${c}`],2,n.SHORT,!1,l,24+c*4);n.vertexAttribPointer(i.a_tangent,4,n.UNSIGNED_BYTE,!1,l,24+a*4),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,e.elementBuffer);for(const c of s){const b=c.material,M=c.region;b.bind(r,h),M.render(r),b.unbind(r)}}}updateAnimations(e){const s=this.sequence;if(s!==-1){const o=this.model.sequences[s],n=o.interval;this.frame+=e*1e3,this.frame>n[1]?(this.sequenceLoopMode===0&&!(o.flags&1)||this.sequenceLoopMode===2?this.frame=n[0]:this.frame=n[1],this.sequenceEnded=!0):this.sequenceEnded=!1}(this.forced||s!==-1)&&(this.forced=!1,this.updateSkeletonAndBoneTexture(e))}setTeamColor(e){return this.teamColor=e,this}setVertexColor(e){return this.vertexColor.set(e),this}setSequence(e){const s=this.model;return this.sequence=e,this.frame=0,(e<-1||e>s.sequences.length-1)&&(e=-1,this.sequence=e),this.forced=!0,this}setSequenceLoopMode(e){return this.sequenceLoopMode=e,this}getAttachment(e){const t=this.model.attachments[e];if(t)return this.skeleton.nodes[t.bone]}}export{G as M,z as a,j as b};
