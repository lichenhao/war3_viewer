(function(b){typeof define=="function"&&define.amd?define(b):b()})((function(){"use strict";function b(r){if(r&&r.length){const t=r.lastIndexOf(".");return t!==-1&&(r=r.slice(t).toLowerCase()),r}return""}const wt="5.13.0",gt=new TextDecoder,yt=new TextEncoder;function B(r){return gt.decode(r)}function F(r){return yt.encode(r)}function At(r){return r instanceof Uint8Array?r:typeof r=="string"?F(r):new Uint8Array(r)}function pt(r,t,i=0,e=1/0){const n=Math.max(i,0),o=Math.min(n+e,r.length);let s=0,c=t.charCodeAt(0);for(let d=n;d<o;d++)if(r[d]===c){if(s+=1,s===t.length)return!0;c=t.charCodeAt(s)}else s>0&&(s=0,c=t.charCodeAt(0));return!1}function bt(r,t,i=0,e=1/0){const n=Math.max(i,0),o=Math.min(n+e,r.length);let s=0,c=t[0];for(let d=n;d<o;d++)if(r[d]===c){if(s+=1,s===t.length)return!0;c=t[s]}else s>0&&(s=0,c=t[0]);return!1}function xt(r,t,i=0,e=1/0){const n=Math.max(i,0),o=Math.min(n+e,r.length);for(let s=n;s<o;s++)if(r[s]===t)return s;return-1}const y=new ArrayBuffer(8),U=new Int8Array(y),S=new Int16Array(y),L=new Int32Array(y),l=new Uint8Array(y),C=new Uint16Array(y),P=new Uint32Array(y),T=new Float32Array(y),E=new Float64Array(y);function V(r){return l[0]=r,U[0]}function O(r,t){return l[0]=r,l[1]=t,S[0]}function G(r,t,i,e){return l[0]=r,l[1]=t,l[2]=i,l[3]=e,L[0]}function v(r,t){return l[0]=r,l[1]=t,C[0]}function K(r,t,i,e){return l[0]=r,l[1]=t,l[2]=i,l[3]=e,P[0]}function j(r,t,i,e){return l[0]=r,l[1]=t,l[2]=i,l[3]=e,T[0]}function R(r,t,i,e,n,o,s,c){return l[0]=r,l[1]=t,l[2]=i,l[3]=e,l[4]=n,l[5]=o,l[6]=s,l[7]=c,E[0]}function N(r){return l[0]=r,U[0]}function D(r,t){return S[0]=t,r[0]=l[0],r[1]=l[1],r}function $(r,t){return L[0]=t,r[0]=l[0],r[1]=l[1],r[2]=l[2],r[3]=l[3],r}function q(r,t){return C[0]=t,r[0]=l[0],r[1]=l[1],r}function H(r,t){return P[0]=t,r[0]=l[0],r[1]=l[1],r[2]=l[2],r[3]=l[3],r}function z(r,t){return T[0]=t,r[0]=l[0],r[1]=l[1],r[2]=l[2],r[3]=l[3],r}function X(r,t){return E[0]=t,r[0]=l[0],r[1]=l[1],r[2]=l[2],r[3]=l[3],r[4]=l[4],r[5]=l[5],r[6]=l[6],r[7]=l[7],r}const a=new Uint8Array(8);class x{buffer;uint8array;index=0;byteLength;remaining;constructor(t,i,e){const n=At(t);i=i||0,e=e||n.length,this.buffer=t,this.uint8array=n.subarray(i,i+e),this.byteLength=e,this.remaining=e}substream(t){if(this.remaining<t)throw new Error(`ByteStream: substream: want ${t} bytes but have ${this.remaining}`);const i=this.index;return this.index+=t,new x(this.uint8array.subarray(i,i+t))}skip(t){if(this.remaining<t)throw new Error(`ByteStream: skip: premature end - want ${t} bytes but have ${this.remaining}`);this.index+=t,this.remaining-=t}seek(t){this.index=t,this.remaining=this.byteLength-t}read(t){if(this.remaining<t)throw new Error(`ByteStream: read: premature end - want ${t} bytes but have ${this.remaining}`);const i=this.uint8array,e=this.index;let n=xt(i,0,e,t);return n===-1&&(n=e+t),this.index+=t,this.remaining-=t,B(i.subarray(e,n))}readNull(){if(this.remaining<1)throw new Error("ByteStream: readNull: premature end - want at least 1 byte but have 0");const t=this.uint8array,i=this.index;let e=t.indexOf(0,i);e===-1&&(e=t.length-1);const n=e-i+1;return this.index+=n,this.remaining-=n,B(t.subarray(i,e))}readBinary(t){if(this.remaining<t)throw new Error(`ByteStream: readBinary: premature end - want ${t} bytes but have ${this.remaining}`);const i=this.uint8array,e=this.index;let n="";for(let o=0;o<t;o++)n+=String.fromCharCode(i[e+o]);return this.index+=t,this.remaining-=t,n}readInt8(){if(this.remaining<1)throw new Error(`ByteStream: readInt8: premature end - want 1 byte but have ${this.remaining}`);const t=this.index,i=this.uint8array,e=V(i[t]);return this.index+=1,this.remaining-=1,e}readInt16(){if(this.remaining<2)throw new Error(`ByteStream: readInt16: premature end - want 2 bytes but have ${this.remaining}`);const t=this.index,i=this.uint8array,e=O(i[t],i[t+1]);return this.index+=2,this.remaining-=2,e}readInt32(){if(this.remaining<4)throw new Error(`ByteStream: readInt32: premature end - want 4 bytes but have ${this.remaining}`);const t=this.index,i=this.uint8array,e=G(i[t],i[t+1],i[t+2],i[t+3]);return this.index+=4,this.remaining-=4,e}readUint8(){if(this.remaining<1)throw new Error(`ByteStream: readUint8: premature end - want 1 byte but have ${this.remaining}`);const t=this.uint8array[this.index];return this.index+=1,this.remaining-=1,t}readUint16(){if(this.remaining<2)throw new Error(`ByteStream: readUint16: premature end - want 2 bytes but have ${this.remaining}`);const t=this.index,i=this.uint8array,e=v(i[t],i[t+1]);return this.index+=2,this.remaining-=2,e}readUint32(){if(this.remaining<4)throw new Error(`ByteStream: readUint32: premature end - want 4 bytes but have ${this.remaining}`);const t=this.index,i=this.uint8array,e=K(i[t],i[t+1],i[t+2],i[t+3]);return this.index+=4,this.remaining-=4,e}readFloat32(){if(this.remaining<4)throw new Error(`ByteStream: readFloat32: premature end - want 4 bytes but have ${this.remaining}`);const t=this.index,i=this.uint8array,e=j(i[t],i[t+1],i[t+2],i[t+3]);return this.index+=4,this.remaining-=4,e}readFloat64(){if(this.remaining<8)throw new Error(`ByteStream: readFloat64: premature end - want 8 bytes but have ${this.remaining}`);const t=this.index,i=this.uint8array,e=R(i[t],i[t+1],i[t+2],i[t+3],i[t+4],i[t+5],i[t+6],i[t+7]);return this.index+=8,this.remaining-=8,e}readInt8Array(t){if(ArrayBuffer.isView(t)||(t=new Int8Array(t)),this.remaining<t.byteLength)throw new Error(`ByteStream: readInt8Array: premature end - want ${t.byteLength} bytes but have ${this.remaining}`);const i=this.index,e=this.uint8array;for(let n=0,o=t.length;n<o;n++)t[n]=V(e[i+n]);return this.index+=t.byteLength,this.remaining-=t.byteLength,t}readInt16Array(t){if(ArrayBuffer.isView(t)||(t=new Int16Array(t)),this.remaining<t.byteLength)throw new Error(`ByteStream: readInt16Array: premature end - want ${t.byteLength} bytes but have ${this.remaining}`);const i=this.index,e=this.uint8array;for(let n=0,o=t.length;n<o;n++){const s=i+n*2;t[n]=O(e[s],e[s+1])}return this.index+=t.byteLength,this.remaining-=t.byteLength,t}readInt32Array(t){if(ArrayBuffer.isView(t)||(t=new Int32Array(t)),this.remaining<t.byteLength)throw new Error(`ByteStream: readInt32Array: premature end - want ${t.byteLength} bytes but have ${this.remaining}`);const i=this.index,e=this.uint8array;for(let n=0,o=t.length;n<o;n++){const s=i+n*4;t[n]=G(e[s],e[s+1],e[s+2],e[s+3])}return this.index+=t.byteLength,this.remaining-=t.byteLength,t}readUint8Array(t){if(ArrayBuffer.isView(t)||(t=new Uint8Array(t)),this.remaining<t.byteLength)throw new Error(`ByteStream: readUint8Array: premature end - want ${t.byteLength} bytes but have ${this.remaining}`);const i=this.index,e=this.uint8array;for(let n=0,o=t.length;n<o;n++)t[n]=e[i+n];return this.index+=t.byteLength,this.remaining-=t.byteLength,t}readUint16Array(t){if(ArrayBuffer.isView(t)||(t=new Uint16Array(t)),this.remaining<t.byteLength)throw new Error(`ByteStream: readUint16Array: premature end - want ${t.byteLength} bytes but have ${this.remaining}`);const i=this.index,e=this.uint8array;for(let n=0,o=t.length;n<o;n++){const s=i+n*2;t[n]=v(e[s],e[s+1])}return this.index+=t.byteLength,this.remaining-=t.byteLength,t}readUint32Array(t){if(ArrayBuffer.isView(t)||(t=new Uint32Array(t)),this.remaining<t.byteLength)throw new Error(`ByteStream: readUint32Array: premature end - want ${t.byteLength} bytes but have ${this.remaining}`);const i=this.index,e=this.uint8array;for(let n=0,o=t.length;n<o;n++){const s=i+n*4;t[n]=K(e[s],e[s+1],e[s+2],e[s+3])}return this.index+=t.byteLength,this.remaining-=t.byteLength,t}readFloat32Array(t){if(ArrayBuffer.isView(t)||(t=new Float32Array(t)),this.remaining<t.byteLength)throw new Error(`ByteStream: readFloat32Array: premature end - want ${t.byteLength} bytes but have ${this.remaining}`);const i=this.index,e=this.uint8array;for(let n=0,o=t.length;n<o;n++){const s=i+n*4;t[n]=j(e[s],e[s+1],e[s+2],e[s+3])}return this.index+=t.byteLength,this.remaining-=t.byteLength,t}readFloat64Array(t){if(ArrayBuffer.isView(t)||(t=new Float64Array(t)),this.remaining<t.byteLength)throw new Error(`ByteStream: readFloat64Array: premature end - want ${t.byteLength} bytes but have ${this.remaining}`);const i=this.index,e=this.uint8array;for(let n=0,o=t.length;n<o;n++){const s=i+n*8;t[n]=R(e[s],e[s+1],e[s+2],e[s+3],e[s+4],e[s+5],e[s+6],e[s+7])}return this.index+=t.byteLength,this.remaining-=t.byteLength,t}write(t){const i=F(t);return this.writeUint8Array(i),i.length}writeNull(t){const i=this.write(t);return this.index++,this.remaining--,i+1}writeBinary(t){const i=this.index,e=this.uint8array,n=t.length;for(let o=0;o<n;o++)e[i+o]=t.charCodeAt(o);this.index+=n}writeInt8(t){this.uint8array[this.index]=N(t),this.index+=1}writeInt16(t){const i=this.index,e=this.uint8array;D(a,t),e[i]=a[0],e[i+1]=a[1],this.index+=2}writeInt32(t){const i=this.index,e=this.uint8array;$(a,t),e[i]=a[0],e[i+1]=a[1],e[i+2]=a[2],e[i+3]=a[3],this.index+=4}writeUint8(t){this.uint8array[this.index]=t,this.index+=1}writeUint16(t){const i=this.index,e=this.uint8array;q(a,t),e[i]=a[0],e[i+1]=a[1],this.index+=2}writeUint32(t){const i=this.index,e=this.uint8array;H(a,t),e[i]=a[0],e[i+1]=a[1],e[i+2]=a[2],e[i+3]=a[3],this.index+=4}writeFloat32(t){const i=this.index,e=this.uint8array;z(a,t),e[i]=a[0],e[i+1]=a[1],e[i+2]=a[2],e[i+3]=a[3],this.index+=4}writeFloat64(t){const i=this.index,e=this.uint8array;X(a,t),e[i]=a[0],e[i+1]=a[1],e[i+2]=a[2],e[i+3]=a[3],e[i+4]=a[4],e[i+5]=a[5],e[i+6]=a[6],e[i+7]=a[7],this.index+=8}writeInt8Array(t){const i=this.index,e=this.uint8array;for(let n=0,o=t.length;n<o;n++)e[i+n]=N(t[n]);this.index+=t.byteLength}writeInt16Array(t){const i=this.index,e=this.uint8array;for(let n=0,o=t.length;n<o;n++){const s=i+n*2;D(a,t[n]),e[s]=a[0],e[s+1]=a[1]}this.index+=t.byteLength}writeInt32Array(t){const i=this.index,e=this.uint8array;for(let n=0,o=t.length;n<o;n++){const s=i+n*4;$(a,t[n]),e[s]=a[0],e[s+1]=a[1],e[s+2]=a[2],e[s+3]=a[3]}this.index+=t.byteLength}writeUint8Array(t){const i=this.index,e=this.uint8array;for(let n=0,o=t.length;n<o;n++)e[i+n]=t[n];this.index+=t.byteLength}writeUint16Array(t){const i=this.index,e=this.uint8array;for(let n=0,o=t.length;n<o;n++){const s=i+n*2;q(a,t[n]),e[s]=a[0],e[s+1]=a[1]}this.index+=t.byteLength}writeUint32Array(t){const i=this.index,e=this.uint8array;for(let n=0,o=t.length;n<o;n++){const s=i+n*4;H(a,t[n]),e[s]=a[0],e[s+1]=a[1],e[s+2]=a[2],e[s+3]=a[3]}this.index+=t.byteLength}writeFloat32Array(t){const i=this.index,e=this.uint8array;for(let n=0,o=t.length;n<o;n++){const s=i+n*4;z(a,t[n]),e[s]=a[0],e[s+1]=a[1],e[s+2]=a[2],e[s+3]=a[3]}this.index+=t.byteLength}writeFloat64Array(t){const i=this.index,e=this.uint8array;for(let n=0,o=t.length;n<o;n++){const s=i+n*8;X(a,t[n]),e[s]=a[0],e[s+1]=a[1],e[s+2]=a[2],e[s+3]=a[3],e[s+4]=a[4],e[s+5]=a[5],e[s+6]=a[6],e[s+7]=a[7]}this.index+=t.byteLength}}class W{buffer;index=0;ident=0;indentSpaces=4;precision=1e6;constructor(t){this.buffer=t||""}clear(){this.buffer="",this.index=0,this.ident=0}readToken(){const t=this.buffer,i=t.length;let e=!1,n=!1,o="";for(;this.index<i;){const s=t[this.index++];if(e)s===`
`&&(e=!1);else if(n)if(s==="\\")o+=s+t[this.index++];else if(s===`
`)o+="\\n";else if(s==="\r")o+="\\r";else{if(s==='"')return o;o+=s}else if(s===" "||s===","||s==="	"||s===`
`||s===":"||s==="\r"){if(o.length)return o}else{if(s==="{"||s==="}")return o.length?(this.index--,o):s;if(s==="/"&&t[this.index]==="/"){if(o.length)return this.index--,o;e=!0}else if(s==='"'){if(o.length)return this.index--,o;n=!0}else o+=s}}}read(){const t=this.readToken();if(t===void 0)throw new Error("End of stream reached prematurely");return t}peek(){const t=this.index,i=this.read();return this.index=t,i}readInt(){return parseInt(this.read())}readFloat(){return parseFloat(this.read())}readVector(t){this.read();for(let i=0,e=t.length;i<e;i++)t[i]=this.readFloat();return this.read(),t}readVectorsBlock(t,i){this.read();for(let e=0,n=t.length;e<n;e+=i)this.readVector(t.subarray(e,e+i));return this.read(),t}readColor(t){return this.read(),t[2]=this.readFloat(),t[1]=this.readFloat(),t[0]=this.readFloat(),this.read(),t}*readBlock(){this.read();let t=this.read();for(;t!=="}";)yield t,t=this.read()}writeLine(t){this.buffer+=`${" ".repeat(this.ident*this.indentSpaces)}${t}
`}writeFlag(t){this.writeLine(`${t},`)}writeFlagAttrib(t,i){this.writeLine(`${t} ${i},`)}writeNumberAttrib(t,i){this.writeLine(`${t} ${this.floatDecimals(i)},`)}writeStringAttrib(t,i){this.writeLine(`${t} "${i}",`)}writeVectorAttrib(t,i){this.writeLine(`${t} { ${this.floatArrayDecimals(i)} },`)}writeColor(t,i){const e=this.floatDecimals(i[0]),n=this.floatDecimals(i[1]),o=this.floatDecimals(i[2]);this.writeLine(`${t} { ${o}, ${n}, ${e} },`)}writeVector(t){this.writeLine(`{ ${this.floatArrayDecimals(t)} },`)}writeVectorArrayBlock(t,i,e){this.startBlock(t,i.length/e);for(let n=0,o=i.length;n<o;n+=e)this.writeVector(i.subarray(n,n+e));this.endBlock()}startBlock(t,...i){i.length&&(t=`${t} ${i.join(" ")}`),this.writeLine(`${t} {`),this.ident+=1}startObjectBlock(t,i){this.writeLine(`${t} "${i.replace(/"/g,'\\"')}" {`),this.ident+=1}endBlock(){this.ident-=1,this.writeLine("}")}endBlockComma(){this.ident-=1,this.writeLine("},")}indent(){this.ident+=1}unindent(){this.ident-=1}floatDecimals(t){return`${Math.trunc(t*this.precision)/this.precision}`}floatArrayDecimals(t){if(t instanceof Float32Array){const i=[];for(let e=0,n=t.length;e<n;e++)i[e]=this.floatDecimals(t[e]);return i.join(", ")}else return t.join(", ")}}class A{boundsRadius=0;min=new Float32Array(3);max=new Float32Array(3);readMdx(t){this.boundsRadius=t.readFloat32(),t.readFloat32Array(this.min),t.readFloat32Array(this.max)}writeMdx(t){t.writeFloat32(this.boundsRadius),t.writeFloat32Array(this.min),t.writeFloat32Array(this.max)}writeMdl(t){(this.min[0]!==0||this.min[1]!==0||this.min[2]!==0)&&t.writeVectorAttrib("MinimumExtent",this.min),(this.max[0]!==0||this.max[1]!==0||this.max[2]!==0)&&t.writeVectorAttrib("MaximumExtent",this.max),this.boundsRadius!==0&&t.writeNumberAttrib("BoundsRadius",this.boundsRadius)}}class Z{name="";interval=new Uint32Array(2);moveSpeed=0;nonLooping=0;rarity=0;syncPoint=0;extent=new A;readMdx(t){this.name=t.read(80),t.readUint32Array(this.interval),this.moveSpeed=t.readFloat32(),this.nonLooping=t.readUint32(),this.rarity=t.readFloat32(),this.syncPoint=t.readUint32(),this.extent.readMdx(t)}writeMdx(t){t.skip(80-t.write(this.name)),t.writeUint32Array(this.interval),t.writeFloat32(this.moveSpeed),t.writeUint32(this.nonLooping),t.writeFloat32(this.rarity),t.writeUint32(this.syncPoint),this.extent.writeMdx(t)}readMdl(t){this.name=t.read();for(const i of t.readBlock())if(i==="Interval")t.readVector(this.interval);else if(i==="NonLooping")this.nonLooping=1;else if(i==="MoveSpeed")this.moveSpeed=t.readFloat();else if(i==="Rarity")this.rarity=t.readFloat();else if(i==="MinimumExtent")t.readVector(this.extent.min);else if(i==="MaximumExtent")t.readVector(this.extent.max);else if(i==="BoundsRadius")this.extent.boundsRadius=t.readFloat();else throw new Error(`Unknown token in Sequence: "${i}"`)}writeMdl(t){t.startObjectBlock("Anim",this.name),t.writeVectorAttrib("Interval",this.interval),this.nonLooping===1&&t.writeFlag("NonLooping"),this.moveSpeed!==0&&t.writeNumberAttrib("MoveSpeed",this.moveSpeed),this.rarity!==0&&t.writeNumberAttrib("Rarity",this.rarity),this.extent.writeMdl(t),t.endBlock()}}class k{name="";interpolationType=0;globalSequenceId=-1;frames=[];values=[];inTans=[];outTans=[];readMdx(t,i){const e=this.frames,n=this.values,o=this.inTans,s=this.outTans,c=t.readUint32(),d=t.readUint32();this.name=i,this.interpolationType=d,this.globalSequenceId=t.readInt32();for(let f=0;f<c;f++)e.push(t.readInt32()),n.push(this.readMdxValue(t)),d>1&&(o.push(this.readMdxValue(t)),s.push(this.readMdxValue(t)))}writeMdx(t){const i=this.interpolationType,e=this.frames,n=this.values,o=this.inTans,s=this.outTans,c=e.length;t.writeBinary(this.name),t.writeUint32(c),t.writeUint32(i),t.writeInt32(this.globalSequenceId);for(let d=0;d<c;d++)t.writeInt32(e[d]),this.writeMdxValue(t,n[d]),i>1&&(this.writeMdxValue(t,o[d]),this.writeMdxValue(t,s[d]))}readMdl(t,i){const e=this.frames,n=this.values,o=this.inTans,s=this.outTans;this.name=i;const c=t.readInt();t.read();let d=0;const f=t.read();f==="DontInterp"?d=0:f==="Linear"?d=1:f==="Hermite"?d=2:f==="Bezier"&&(d=3),this.interpolationType=d,t.peek()==="GlobalSeqId"&&(t.read(),this.globalSequenceId=t.readInt());for(let u=0;u<c;u++)e[u]=t.readInt(),n[u]=this.readMdlValue(t),d>1&&(t.read(),o[u]=this.readMdlValue(t),t.read(),s[u]=this.readMdlValue(t));t.read()}writeMdl(t,i){const e=this.interpolationType,n=this.frames,o=this.values,s=this.inTans,c=this.outTans,d=n.length;t.startBlock(i,this.frames.length);let f="";this.interpolationType===0?f="DontInterp":this.interpolationType===1?f="Linear":this.interpolationType===2?f="Hermite":this.interpolationType===3&&(f="Bezier"),t.writeFlag(f),this.globalSequenceId!==-1&&t.writeNumberAttrib("GlobalSeqId",this.globalSequenceId);for(let u=0;u<d;u++)this.writeMdlValue(t,`${n[u]}:`,o[u]),e>1&&(t.indent(),this.writeMdlValue(t,"InTan",s[u]),this.writeMdlValue(t,"OutTan",c[u]),t.unindent());t.endBlock()}getByteLength(){const t=this.frames.length;let i=16;if(t){const e=this.values[0].byteLength;let n=1;this.interpolationType>1&&(n=3),i+=(4+n*e)*t}return i}}class I extends k{readMdxValue(t){return t.readUint32Array(1)}writeMdxValue(t,i){t.writeUint32(i[0])}readMdlValue(t){return new Uint32Array([t.readInt()])}writeMdlValue(t,i,e){t.writeNumberAttrib(i,e[0])}}class h extends k{readMdxValue(t){return t.readFloat32Array(1)}writeMdxValue(t,i){t.writeFloat32(i[0])}readMdlValue(t){return new Float32Array([t.readFloat()])}writeMdlValue(t,i,e){t.writeNumberAttrib(i,e[0])}}class w extends k{readMdxValue(t){return t.readFloat32Array(3)}writeMdxValue(t,i){t.writeFloat32Array(i)}readMdlValue(t){return t.readVector(new Float32Array(3))}writeMdlValue(t,i,e){t.writeVectorAttrib(i,e)}}class Y extends k{readMdxValue(t){return t.readFloat32Array(4)}writeMdxValue(t,i){t.writeFloat32Array(i)}readMdlValue(t){return t.readVector(new Float32Array(4))}writeMdlValue(t,i,e){t.writeVectorAttrib(i,e)}}const M={KMTF:["TextureID",I],KMTA:["Alpha",h],KMTE:["EmissiveGain",h],KFC3:["FresnelColor",w],KFCA:["FresnelOpacity",h],KFTC:["FresnelTeamColor",I],KTAT:["Translation",w],KTAR:["Rotation",Y],KTAS:["Scaling",w],KGAO:["Alpha",h],KGAC:["Color",w],KGTR:["Translation",w],KGRT:["Rotation",Y],KGSC:["Scaling",w],KLAS:["AttenuationStart",h],KLAE:["AttenuationEnd",h],KLAC:["Color",w],KLAI:["Intensity",h],KLBI:["AmbIntensity",h],KLBC:["AmbColor",w],KLAV:["Visibility",h],KATV:["Visibility",h],KPEE:["EmissionRate",h],KPEG:["Gravity",h],KPLN:["Longitude",h],KPLT:["Latitude",h],KPEL:["LifeSpan",h],KPES:["InitVelocity",h],KPEV:["Visibility",h],KP2S:["Speed",h],KP2R:["Variation",h],KP2L:["Latitude",h],KP2G:["Gravity",h],KP2E:["EmissionRate",h],KP2N:["Width",h],KP2W:["Length",h],KP2V:["Visibility",h],KPPA:["Alpha",h],KPPC:["Color",w],KPPE:["EmissionRate",h],KPPL:["LifeSpan",h],KPPS:["Speed",h],KPPV:["Visibility",h],KRHA:["HeightAbove",h],KRHB:["HeightBelow",h],KRAL:["Alpha",h],KRCO:["Color",w],KRTX:["TextureSlot",I],KRVS:["Visibility",h],KCTR:["Translation",w],KTTR:["Translation",w],KCRL:["Rotation",h]};class p{animations=[];readAnimations(t,i){const e=t.index+i;for(;t.index<e;){const n=t.readBinary(4),o=new M[n][1];o.readMdx(t,n),this.animations.push(o)}}writeAnimations(t){for(const i of this.animations)i.writeMdx(t)}*readAnimatedBlock(t){for(const i of t.readBlock())i==="static"?yield`static ${t.read()}`:yield i}readAnimation(t,i){const e=new M[i][1];e.readMdl(t,i),this.animations.push(e)}writeAnimation(t,i){for(const e of this.animations)if(e.name===i)return e.writeMdl(t,M[i][0]),!0;return!1}getByteLength(t=0){let i=0;for(const e of this.animations)i+=e.getByteLength();return i}}function kt(r){return r==="None"?0:r==="Transparent"?1:r==="Blend"?2:r==="Additive"?3:r==="AddAlpha"?4:r==="Modulate"?5:r==="Modulate2x"?6:0}function Bt(r){return r===0?"None":r===1?"Transparent":r===2?"Blend":r===3?"Additive":r===4?"AddAlpha":r===5?"Modulate":r===6?"Modulate2x":"None"}class Q extends p{filterMode=0;flags=0;textureId=-1;textureAnimationId=-1;coordId=0;alpha=1;emissiveGain=1;fresnelColor=new Float32Array([1,1,1]);fresnelOpacity=0;fresnelTeamColor=0;readMdx(t,i){const e=t.index,n=t.readUint32();this.filterMode=t.readUint32(),this.flags=t.readUint32(),this.textureId=t.readInt32(),this.textureAnimationId=t.readInt32(),this.coordId=t.readUint32(),this.alpha=t.readFloat32(),i>800&&(this.emissiveGain=t.readFloat32(),t.readFloat32Array(this.fresnelColor),this.fresnelOpacity=t.readFloat32(),this.fresnelTeamColor=t.readFloat32()),this.readAnimations(t,n-(t.index-e))}writeMdx(t,i){t.writeUint32(this.getByteLength(i)),t.writeUint32(this.filterMode),t.writeUint32(this.flags),t.writeInt32(this.textureId),t.writeInt32(this.textureAnimationId),t.writeUint32(this.coordId),t.writeFloat32(this.alpha),i>800&&(t.writeFloat32(this.emissiveGain),t.writeFloat32Array(this.fresnelColor),t.writeFloat32(this.fresnelOpacity),t.writeFloat32(this.fresnelTeamColor)),this.writeAnimations(t)}readMdl(t){for(const i of super.readAnimatedBlock(t))if(i==="FilterMode")this.filterMode=kt(t.read());else if(i==="Unshaded")this.flags|=1;else if(i==="SphereEnvMap")this.flags|=2;else if(i==="TwoSided")this.flags|=16;else if(i==="Unfogged")this.flags|=32;else if(i==="NoDepthTest")this.flags|=64;else if(i==="NoDepthSet")this.flags|=128;else if(i==="Unlit")this.flags|=256;else if(i==="static TextureID")this.textureId=t.readInt();else if(i==="TextureID")this.readAnimation(t,"KMTF");else if(i==="TVertexAnimId")this.textureAnimationId=t.readInt();else if(i==="CoordId")this.coordId=t.readInt();else if(i==="static Alpha")this.alpha=t.readFloat();else if(i==="Alpha")this.readAnimation(t,"KMTA");else if(i==="static EmissiveGain")this.emissiveGain=t.readFloat();else if(i==="EmissiveGain")this.readAnimation(t,"KMTE");else if(i==="static FresnelColor")t.readVector(this.fresnelColor);else if(i==="FresnelColor")this.readAnimation(t,"KFC3");else if(i==="static FresnelOpacity")this.fresnelOpacity=t.readFloat();else if(i==="FresnelOpacity")this.readAnimation(t,"KFCA");else if(i==="static FresnelTeamColor")this.fresnelTeamColor=t.readFloat();else if(i==="FresnelTeamColor")this.readAnimation(t,"KFTC");else throw new Error(`Unknown token in Layer: "${i}"`)}writeMdl(t,i){t.startBlock("Layer"),t.writeFlagAttrib("FilterMode",Bt(this.filterMode)),this.flags&1&&t.writeFlag("Unshaded"),this.flags&2&&t.writeFlag("SphereEnvMap"),this.flags&16&&t.writeFlag("TwoSided"),this.flags&32&&t.writeFlag("Unfogged"),this.flags&64&&t.writeFlag("NoDepthTest"),this.flags&128&&t.writeFlag("NoDepthSet"),i>800&&this.flags&256&&t.writeFlag("Unlit"),this.writeAnimation(t,"KMTF")||t.writeNumberAttrib("static TextureID",this.textureId),this.textureAnimationId!==-1&&t.writeNumberAttrib("TVertexAnimId",this.textureAnimationId),this.coordId!==0&&t.writeNumberAttrib("CoordId",this.coordId),!this.writeAnimation(t,"KMTA")&&this.alpha!==1&&t.writeNumberAttrib("static Alpha",this.alpha),i>800&&(!this.writeAnimation(t,"KMTE")&&this.emissiveGain!==1&&t.writeNumberAttrib("static EmissiveGain",this.emissiveGain),!this.writeAnimation(t,"KFC3")&&(this.fresnelColor[0]!==1||this.fresnelColor[1]!==1||this.fresnelColor[2]!==1)&&t.writeVectorAttrib("static FresnelColor",this.fresnelColor),!this.writeAnimation(t,"KFCA")&&this.fresnelOpacity!==0&&t.writeNumberAttrib("static FresnelOpacity",this.fresnelOpacity),!this.writeAnimation(t,"KFTC")&&this.fresnelTeamColor!==0&&t.writeNumberAttrib("static FresnelTeamColor",this.fresnelTeamColor)),t.endBlock()}getByteLength(t){let i=28+super.getByteLength();return t>800&&(i+=24),i}}class _{priorityPlane=0;flags=0;shader="";layers=[];readMdx(t,i){t.readUint32(),this.priorityPlane=t.readInt32(),this.flags=t.readUint32(),i>800&&(this.shader=t.read(80)),t.skip(4);for(let e=0,n=t.readUint32();e<n;e++){const o=new Q;o.readMdx(t,i),this.layers.push(o)}}writeMdx(t,i){t.writeUint32(this.getByteLength(i)),t.writeInt32(this.priorityPlane),t.writeUint32(this.flags),i>800&&t.skip(80-t.write(this.shader)),t.writeBinary("LAYS"),t.writeUint32(this.layers.length);for(const e of this.layers)e.writeMdx(t,i)}readMdl(t){for(const i of t.readBlock())if(i==="ConstantColor")this.flags|=1;else if(i==="TwoSided")this.flags|=2;else if(i==="SortPrimsNearZ")this.flags|=8;else if(i==="SortPrimsFarZ")this.flags|=16;else if(i==="FullResolution")this.flags|=32;else if(i==="PriorityPlane")this.priorityPlane=t.readInt();else if(i==="Shader")this.shader=t.read();else if(i==="Layer"){const e=new Q;e.readMdl(t),this.layers.push(e)}else throw new Error(`Unknown token in Material: "${i}"`)}writeMdl(t,i){t.startBlock("Material"),this.flags&1&&t.writeFlag("ConstantColor"),i>800&&this.flags&2&&t.writeFlag("TwoSided"),this.flags&8&&t.writeFlag("SortPrimsNearZ"),this.flags&16&&t.writeFlag("SortPrimsFarZ"),this.flags&32&&t.writeFlag("FullResolution"),this.priorityPlane!==0&&t.writeNumberAttrib("PriorityPlane",this.priorityPlane),i>800&&t.writeStringAttrib("Shader",this.shader);for(const e of this.layers)e.writeMdl(t,i);t.endBlock()}getByteLength(t){let i=20;t>800&&(i+=80);for(const e of this.layers)i+=e.getByteLength(t);return i}}class J{replaceableId=0;path="";wrapMode=0;readMdx(t){this.replaceableId=t.readUint32(),this.path=t.read(260),this.wrapMode=t.readUint32()}writeMdx(t){t.writeUint32(this.replaceableId),t.skip(260-t.write(this.path)),t.writeUint32(this.wrapMode)}readMdl(t){for(const i of t.readBlock())if(i==="Image")this.path=t.read();else if(i==="ReplaceableId")this.replaceableId=t.readInt();else if(i==="WrapWidth")this.wrapMode|=1;else if(i==="WrapHeight")this.wrapMode|=2;else throw new Error(`Unknown token in Texture: "${i}"`)}writeMdl(t){t.startBlock("Bitmap"),this.path.length&&t.writeStringAttrib("Image",this.path),this.replaceableId!==0&&t.writeNumberAttrib("ReplaceableId",this.replaceableId),this.wrapMode&1&&t.writeFlag("WrapWidth"),this.wrapMode&2&&t.writeFlag("WrapHeight"),t.endBlock()}}class m extends p{readMdx(t){const i=t.readUint32();this.readAnimations(t,i-4)}writeMdx(t){t.writeUint32(this.getByteLength()),this.writeAnimations(t)}readMdl(t){for(const i of t.readBlock())if(i==="Translation")this.readAnimation(t,"KTAT");else if(i==="Rotation")this.readAnimation(t,"KTAR");else if(i==="Scaling")this.readAnimation(t,"KTAS");else throw new Error(`Unknown token in TextureAnimation: "${i}"`)}writeMdl(t){t.startBlock("TVertexAnim "),this.writeAnimation(t,"KTAT"),this.writeAnimation(t,"KTAR"),this.writeAnimation(t,"KTAS"),t.endBlock()}getByteLength(){return 4+super.getByteLength()}}class tt{vertices=new Float32Array(0);normals=new Float32Array(0);faceTypeGroups=new Uint32Array(0);faceGroups=new Uint32Array(0);faces=new Uint16Array(0);vertexGroups=new Uint8Array(0);matrixGroups=new Uint32Array(0);matrixIndices=new Uint32Array(0);materialId=0;selectionGroup=0;selectionFlags=0;lod=-1;lodName="";extent=new A;sequenceExtents=[];tangents=new Float32Array(0);skin=new Uint8Array(0);uvSets=[];readMdx(t,i){t.readUint32(),t.skip(4),this.vertices=t.readFloat32Array(t.readUint32()*3),t.skip(4),this.normals=t.readFloat32Array(t.readUint32()*3),t.skip(4),this.faceTypeGroups=t.readUint32Array(t.readUint32()),t.skip(4),this.faceGroups=t.readUint32Array(t.readUint32()),t.skip(4),this.faces=t.readUint16Array(t.readUint32()),t.skip(4),this.vertexGroups=t.readUint8Array(t.readUint32()),t.skip(4),this.matrixGroups=t.readUint32Array(t.readUint32()),t.skip(4),this.matrixIndices=t.readUint32Array(t.readUint32()),this.materialId=t.readUint32(),this.selectionGroup=t.readUint32(),this.selectionFlags=t.readUint32(),i>800&&(this.lod=t.readInt32(),this.lodName=t.read(80)),this.extent.readMdx(t);for(let e=0,n=t.readUint32();e<n;e++){const o=new A;o.readMdx(t),this.sequenceExtents.push(o)}i>800&&(t.readBinary(4)==="TANG"?this.tangents=t.readFloat32Array(t.readUint32()*4):t.skip(-4),t.readBinary(4)==="SKIN"?this.skin=t.readUint8Array(t.readUint32()):t.skip(-4)),t.skip(4);for(let e=0,n=t.readUint32();e<n;e++)t.skip(4),this.uvSets.push(t.readFloat32Array(t.readUint32()*2))}writeMdx(t,i){t.writeUint32(this.getByteLength(i)),t.writeBinary("VRTX"),t.writeUint32(this.vertices.length/3),t.writeFloat32Array(this.vertices),t.writeBinary("NRMS"),t.writeUint32(this.normals.length/3),t.writeFloat32Array(this.normals),t.writeBinary("PTYP"),t.writeUint32(this.faceTypeGroups.length),t.writeUint32Array(this.faceTypeGroups),t.writeBinary("PCNT"),t.writeUint32(this.faceGroups.length),t.writeUint32Array(this.faceGroups),t.writeBinary("PVTX"),t.writeUint32(this.faces.length),t.writeUint16Array(this.faces),t.writeBinary("GNDX"),t.writeUint32(this.vertexGroups.length),t.writeUint8Array(this.vertexGroups),t.writeBinary("MTGC"),t.writeUint32(this.matrixGroups.length),t.writeUint32Array(this.matrixGroups),t.writeBinary("MATS"),t.writeUint32(this.matrixIndices.length),t.writeUint32Array(this.matrixIndices),t.writeUint32(this.materialId),t.writeUint32(this.selectionGroup),t.writeUint32(this.selectionFlags),i>800&&(t.writeInt32(this.lod),t.skip(80-t.write(this.lodName))),this.extent.writeMdx(t),t.writeUint32(this.sequenceExtents.length);for(const e of this.sequenceExtents)e.writeMdx(t);i>800&&(this.tangents.length&&(t.writeBinary("TANG"),t.writeUint32(this.tangents.length/4),t.writeFloat32Array(this.tangents)),this.skin.length&&(t.writeBinary("SKIN"),t.writeUint32(this.skin.length),t.writeUint8Array(this.skin))),t.writeBinary("UVAS"),t.writeUint32(this.uvSets.length);for(const e of this.uvSets)t.writeBinary("UVBS"),t.writeUint32(e.length/2),t.writeFloat32Array(e)}readMdl(t){for(let i of t.readBlock())if(i==="Vertices")this.vertices=t.readVectorsBlock(new Float32Array(t.readInt()*3),3);else if(i==="Normals")this.normals=t.readVectorsBlock(new Float32Array(t.readInt()*3),3);else if(i==="TVertices")this.uvSets.push(t.readVectorsBlock(new Float32Array(t.readInt()*2),2));else if(i==="VertexGroup"){const e=[];for(const n of t.readBlock())e.push(parseInt(n));this.vertexGroups=new Uint8Array(e)}else if(i==="Tangents")this.tangents=t.readVectorsBlock(new Float32Array(t.readInt()*4),4);else if(i==="SkinWeights")this.skin=t.readVector(new Uint8Array(t.readInt()*8));else if(i==="Faces"){this.faceTypeGroups=new Uint32Array([4]);const e=t.readInt(),n=t.readInt();t.read(),t.read(),this.faces=t.readVectorsBlock(new Uint16Array(n),n/e),this.faceGroups=new Uint32Array([n]),t.read()}else if(i==="Groups"){const e=[],n=[];t.readInt(),t.readInt();for(const o of t.readBlock()){let s=0;for(const c of t.readBlock())e.push(parseInt(c)),s+=1;n.push(s)}this.matrixIndices=new Uint32Array(e),this.matrixGroups=new Uint32Array(n)}else if(i==="MinimumExtent")t.readVector(this.extent.min);else if(i==="MaximumExtent")t.readVector(this.extent.max);else if(i==="BoundsRadius")this.extent.boundsRadius=t.readFloat();else if(i==="Anim"){const e=new A;for(i of t.readBlock())i==="MinimumExtent"?t.readVector(e.min):i==="MaximumExtent"?t.readVector(e.max):i==="BoundsRadius"&&(e.boundsRadius=t.readFloat());this.sequenceExtents.push(e)}else if(i==="MaterialID")this.materialId=t.readInt();else if(i==="SelectionGroup")this.selectionGroup=t.readInt();else if(i==="Unselectable")this.selectionFlags=4;else if(i==="LevelOfDetail")this.lod=t.readInt();else if(i==="Name")this.lodName=t.read();else throw new Error(`Unknown token in Geoset: "${i}"`)}writeMdl(t,i){t.startBlock("Geoset"),t.writeVectorArrayBlock("Vertices",this.vertices,3),t.writeVectorArrayBlock("Normals",this.normals,3);for(const n of this.uvSets)t.writeVectorArrayBlock("TVertices",n,2);if(i>800&&this.tangents.length&&t.writeVectorArrayBlock("Tangents",this.tangents,4),this.vertexGroups.length){t.startBlock("VertexGroup");for(let n=0,o=this.vertexGroups.length;n<o;n++)t.writeLine(`${this.vertexGroups[n]},`);t.endBlock()}if(i>800&&this.skin.length){t.startBlock("SkinWeights",this.skin.length/8);for(let n=0,o=this.skin.length;n<o;n+=8)t.writeLine(`${this.skin.subarray(n,n+8).join(", ")},`);t.endBlock()}t.startBlock("Faces",1,this.faces.length),t.startBlock("Triangles"),t.writeVector(this.faces),t.endBlock(),t.endBlock(),t.startBlock("Groups",this.matrixGroups.length,this.matrixIndices.length);let e=0;for(const n of this.matrixGroups)t.writeVectorAttrib("Matrices",this.matrixIndices.subarray(e,e+n)),e+=n;t.endBlock(),this.extent.writeMdl(t);for(const n of this.sequenceExtents)t.startBlock("Anim"),n.writeMdl(t),t.endBlock();t.writeNumberAttrib("MaterialID",this.materialId),t.writeNumberAttrib("SelectionGroup",this.selectionGroup),this.selectionFlags===4&&t.writeFlag("Unselectable"),i>800&&(t.writeNumberAttrib("LevelOfDetail",this.lod),this.lodName.length&&t.writeStringAttrib("Name",this.lodName)),t.endBlock()}getByteLength(t){let i=120+this.vertices.byteLength+this.normals.byteLength+this.faceTypeGroups.byteLength+this.faceGroups.byteLength+this.faces.byteLength+this.vertexGroups.byteLength+this.matrixGroups.byteLength+this.matrixIndices.byteLength+this.sequenceExtents.length*28;t>800&&(i+=84,this.tangents.length&&(i+=8+this.tangents.byteLength),this.skin.length&&(i+=8+this.skin.byteLength));for(const e of this.uvSets)i+=8+e.byteLength;return i}}class it extends p{alpha=1;flags=0;color=new Float32Array([1,1,1]);geosetId=-1;readMdx(t){const i=t.readUint32();this.alpha=t.readFloat32(),this.flags=t.readUint32(),t.readFloat32Array(this.color),this.geosetId=t.readInt32(),this.readAnimations(t,i-28)}writeMdx(t){t.writeUint32(this.getByteLength()),t.writeFloat32(this.alpha),t.writeUint32(this.flags),t.writeFloat32Array(this.color),t.writeInt32(this.geosetId),this.writeAnimations(t)}readMdl(t){for(const i of super.readAnimatedBlock(t))if(i==="DropShadow")this.flags|=1;else if(i==="static Alpha")this.alpha=t.readFloat();else if(i==="Alpha")this.readAnimation(t,"KGAO");else if(i==="static Color")this.flags|=2,t.readColor(this.color);else if(i==="Color")this.flags|=2,this.readAnimation(t,"KGAC");else if(i==="GeosetId")this.geosetId=t.readInt();else throw new Error(`Unknown token in GeosetAnimation: "${i}"`)}writeMdl(t){t.startBlock("GeosetAnim"),this.flags&1&&t.writeFlag("DropShadow"),this.writeAnimation(t,"KGAO")||t.writeNumberAttrib("static Alpha",this.alpha),this.flags&2&&!this.writeAnimation(t,"KGAC")&&(this.color[0]!==1||this.color[1]!==1||this.color[2]!==1)&&t.writeColor("static Color ",this.color),t.writeNumberAttrib("GeosetId",this.geosetId),t.endBlock()}getByteLength(){return 28+super.getByteLength()}}class g extends p{name="";objectId=-1;parentId=-1;flags;constructor(t=0){super(),this.flags=t}readMdx(t){const i=t.readUint32();this.name=t.read(80),this.objectId=t.readInt32(),this.parentId=t.readInt32(),this.flags=t.readUint32(),this.readAnimations(t,i-96)}writeMdx(t){t.writeUint32(this.getGenericByteLength()),t.skip(80-t.write(this.name)),t.writeInt32(this.objectId),t.writeInt32(this.parentId),t.writeUint32(this.flags);for(const i of this.eachAnimation(!0))i.writeMdx(t)}writeNonGenericAnimationChunks(t){for(const i of this.eachAnimation(!1))i.writeMdx(t)}*readGenericBlock(t){this.name=t.read();for(let i of this.readAnimatedBlock(t))if(i==="ObjectId")this.objectId=t.readInt();else if(i==="Parent")this.parentId=t.readInt();else if(i==="BillboardedLockZ")this.flags|=64;else if(i==="BillboardedLockY")this.flags|=32;else if(i==="BillboardedLockX")this.flags|=16;else if(i==="Billboarded")this.flags|=8;else if(i==="CameraAnchored")this.flags|=128;else if(i==="DontInherit")for(i of t.readBlock())i==="Rotation"?this.flags|=4:i==="Translation"?this.flags|=1:i==="Scaling"&&(this.flags|=2);else i==="Translation"?this.readAnimation(t,"KGTR"):i==="Rotation"?this.readAnimation(t,"KGRT"):i==="Scaling"?this.readAnimation(t,"KGSC"):yield i}writeGenericHeader(t){t.writeNumberAttrib("ObjectId",this.objectId),this.parentId!==-1&&t.writeNumberAttrib("Parent",this.parentId),this.flags&64&&t.writeFlag("BillboardedLockZ"),this.flags&32&&t.writeFlag("BillboardedLockY"),this.flags&16&&t.writeFlag("BillboardedLockX"),this.flags&8&&t.writeFlag("Billboarded"),this.flags&128&&t.writeFlag("CameraAnchored"),this.flags&4&&t.writeFlag("DontInherit { Rotation }"),this.flags&1&&t.writeFlag("DontInherit { Translation }"),this.flags&2&&t.writeFlag("DontInherit { Scaling }")}writeGenericAnimations(t){this.writeAnimation(t,"KGTR"),this.writeAnimation(t,"KGRT"),this.writeAnimation(t,"KGSC")}*eachAnimation(t){for(const i of this.animations){const e=i.name,n=e==="KGTR"||e==="KGRT"||e==="KGSC";(t&&n||!t&&!n)&&(yield i)}}getGenericByteLength(){let t=96;for(const i of this.eachAnimation(!0))t+=i.getByteLength();return t}getByteLength(){return 96+super.getByteLength()}}class et extends g{geosetId=-1;geosetAnimationId=-1;constructor(){super(256)}readMdx(t){super.readMdx(t),this.geosetId=t.readInt32(),this.geosetAnimationId=t.readInt32()}writeMdx(t){super.writeMdx(t),t.writeInt32(this.geosetId),t.writeInt32(this.geosetAnimationId)}readMdl(t){for(let i of super.readGenericBlock(t))if(i==="GeosetId")i=t.read(),i==="Multiple"?this.geosetId=-1:this.geosetId=parseInt(i);else if(i==="GeosetAnimId")i=t.read(),i==="None"?this.geosetAnimationId=-1:this.geosetAnimationId=parseInt(i);else throw new Error(`Unknown token in Bone ${this.name}: "${i}"`)}writeMdl(t){t.startObjectBlock("Bone",this.name),this.writeGenericHeader(t),this.geosetId===-1?t.writeFlagAttrib("GeosetId","Multiple"):t.writeNumberAttrib("GeosetId",this.geosetId),this.geosetAnimationId===-1?t.writeFlagAttrib("GeosetAnimId","None"):t.writeNumberAttrib("GeosetAnimId",this.geosetAnimationId),this.writeGenericAnimations(t),t.endBlock()}getByteLength(){return 8+super.getByteLength()}}class nt extends g{type=-1;attenuation=new Float32Array(2);color=new Float32Array(3);intensity=0;ambientColor=new Float32Array(3);ambientIntensity=0;constructor(){super(512)}readMdx(t){const i=t.index,e=t.readUint32();super.readMdx(t),this.type=t.readUint32(),t.readFloat32Array(this.attenuation),t.readFloat32Array(this.color),this.intensity=t.readFloat32(),t.readFloat32Array(this.ambientColor),this.ambientIntensity=t.readFloat32(),this.readAnimations(t,e-(t.index-i))}writeMdx(t){t.writeUint32(this.getByteLength()),super.writeMdx(t),t.writeUint32(this.type),t.writeFloat32Array(this.attenuation),t.writeFloat32Array(this.color),t.writeFloat32(this.intensity),t.writeFloat32Array(this.ambientColor),t.writeFloat32(this.ambientIntensity),this.writeNonGenericAnimationChunks(t)}readMdl(t){for(const i of super.readGenericBlock(t))if(i==="Omnidirectional")this.type=0;else if(i==="Directional")this.type=1;else if(i==="Ambient")this.type=2;else if(i==="static AttenuationStart")this.attenuation[0]=t.readFloat();else if(i==="AttenuationStart")this.readAnimation(t,"KLAS");else if(i==="static AttenuationEnd")this.attenuation[1]=t.readFloat();else if(i==="AttenuationEnd")this.readAnimation(t,"KLAE");else if(i==="static Intensity")this.intensity=t.readFloat();else if(i==="Intensity")this.readAnimation(t,"KLAI");else if(i==="static Color")t.readColor(this.color);else if(i==="Color")this.readAnimation(t,"KLAC");else if(i==="static AmbIntensity")this.ambientIntensity=t.readFloat();else if(i==="AmbIntensity")this.readAnimation(t,"KLBI");else if(i==="static AmbColor")t.readColor(this.ambientColor);else if(i==="AmbColor")this.readAnimation(t,"KLBC");else if(i==="Visibility")this.readAnimation(t,"KLAV");else throw new Error(`Unknown token in Light: "${i}"`)}writeMdl(t){t.startObjectBlock("Light",this.name),this.writeGenericHeader(t),this.type===0?t.writeFlag("Omnidirectional"):this.type===1?t.writeFlag("Directional"):this.type===2&&t.writeFlag("Ambient"),this.writeAnimation(t,"KLAS")||t.writeNumberAttrib("static AttenuationStart",this.attenuation[0]),this.writeAnimation(t,"KLAE")||t.writeNumberAttrib("static AttenuationEnd",this.attenuation[1]),this.writeAnimation(t,"KLAI")||t.writeNumberAttrib("static Intensity",this.intensity),this.writeAnimation(t,"KLAC")||t.writeColor("static Color",this.color),this.writeAnimation(t,"KLBI")||t.writeNumberAttrib("static AmbIntensity",this.ambientIntensity),this.writeAnimation(t,"KLBC")||t.writeColor("static AmbColor",this.ambientColor),this.writeAnimation(t,"KLAV"),this.writeGenericAnimations(t),t.endBlock()}getByteLength(){return 48+super.getByteLength()}}class rt extends g{readMdl(t){for(const i of super.readGenericBlock(t))throw new Error(`Unknown token in Helper: "${i}"`)}writeMdl(t){t.startObjectBlock("Helper",this.name),this.writeGenericHeader(t),this.writeGenericAnimations(t),t.endBlock()}}class st extends g{path="";attachmentId=0;constructor(){super(2048)}readMdx(t){const i=t.index,e=t.readUint32();super.readMdx(t),this.path=t.read(260),this.attachmentId=t.readInt32(),this.readAnimations(t,e-(t.index-i))}writeMdx(t){t.writeUint32(this.getByteLength()),super.writeMdx(t),t.skip(260-t.write(this.path)),t.writeInt32(this.attachmentId),this.writeNonGenericAnimationChunks(t)}readMdl(t){for(const i of super.readGenericBlock(t))if(i==="AttachmentID")this.attachmentId=t.readInt();else if(i==="Path")this.path=t.read();else if(i==="Visibility")this.readAnimation(t,"KATV");else throw new Error(`Unknown token in Attachment ${this.name}: "${i}"`)}writeMdl(t){t.startObjectBlock("Attachment",this.name),this.writeGenericHeader(t),t.writeNumberAttrib("AttachmentID",this.attachmentId),this.path.length&&t.writeStringAttrib("Path",this.path),this.writeAnimation(t,"KATV"),this.writeGenericAnimations(t),t.endBlock()}getByteLength(){return 268+super.getByteLength()}}class ot extends g{emissionRate=0;gravity=0;longitude=0;latitude=0;path="";lifeSpan=0;speed=0;constructor(){super(4096)}readMdx(t){const i=t.index,e=t.readUint32();super.readMdx(t),this.emissionRate=t.readFloat32(),this.gravity=t.readFloat32(),this.longitude=t.readFloat32(),this.latitude=t.readFloat32(),this.path=t.read(260),this.lifeSpan=t.readFloat32(),this.speed=t.readFloat32(),this.readAnimations(t,e-(t.index-i))}writeMdx(t){t.writeUint32(this.getByteLength()),super.writeMdx(t),t.writeFloat32(this.emissionRate),t.writeFloat32(this.gravity),t.writeFloat32(this.longitude),t.writeFloat32(this.latitude),t.skip(260-t.write(this.path)),t.writeFloat32(this.lifeSpan),t.writeFloat32(this.speed),this.writeNonGenericAnimationChunks(t)}readMdl(t){for(let i of super.readGenericBlock(t))if(i==="EmitterUsesMDL")this.flags|=32768;else if(i==="EmitterUsesTGA")this.flags|=65536;else if(i==="static EmissionRate")this.emissionRate=t.readFloat();else if(i==="EmissionRate")this.readAnimation(t,"KPEE");else if(i==="static Gravity")this.gravity=t.readFloat();else if(i==="Gravity")this.readAnimation(t,"KPEG");else if(i==="static Longitude")this.longitude=t.readFloat();else if(i==="Longitude")this.readAnimation(t,"KPLN");else if(i==="static Latitude")this.latitude=t.readFloat();else if(i==="Latitude")this.readAnimation(t,"KPLT");else if(i==="Visibility")this.readAnimation(t,"KPEV");else if(i==="Particle")for(i of this.readAnimatedBlock(t))i==="static LifeSpan"?this.lifeSpan=t.readFloat():i==="LifeSpan"?this.readAnimation(t,"KPEL"):i==="static InitVelocity"?this.speed=t.readFloat():i==="InitVelocity"?this.readAnimation(t,"KPES"):i==="Path"&&(this.path=t.read());else throw new Error(`Unknown token in ParticleEmitter: "${i}"`)}writeMdl(t){t.startObjectBlock("ParticleEmitter",this.name),this.writeGenericHeader(t),this.flags&32768&&t.writeFlag("EmitterUsesMDL"),this.flags&65536&&t.writeFlag("EmitterUsesTGA"),this.writeAnimation(t,"KPEE")||t.writeNumberAttrib("static EmissionRate",this.emissionRate),this.writeAnimation(t,"KPEG")||t.writeNumberAttrib("static Gravity",this.gravity),this.writeAnimation(t,"KPLN")||t.writeNumberAttrib("static Longitude",this.longitude),this.writeAnimation(t,"KPLT")||t.writeNumberAttrib("static Latitude",this.latitude),this.writeAnimation(t,"KPEV"),t.startBlock("Particle"),this.writeAnimation(t,"KPEL")||t.writeNumberAttrib("static LifeSpan",this.lifeSpan),this.writeAnimation(t,"KPES")||t.writeNumberAttrib("static InitVelocity",this.speed),(this.flags&32768||this.flags&65536)&&t.writeStringAttrib("Path",this.path),t.endBlock(),this.writeGenericAnimations(t),t.endBlock()}getByteLength(){return 288+super.getByteLength()}}class at extends g{speed=0;variation=0;latitude=0;gravity=0;lifeSpan=0;emissionRate=0;width=0;length=0;filterMode=0;rows=0;columns=0;headOrTail=0;tailLength=0;timeMiddle=0;segmentColors=[new Float32Array(3),new Float32Array(3),new Float32Array(3)];segmentAlphas=new Uint8Array(3);segmentScaling=new Float32Array(3);headIntervals=[new Uint32Array(3),new Uint32Array(3)];tailIntervals=[new Uint32Array(3),new Uint32Array(3)];textureId=-1;squirt=0;priorityPlane=0;replaceableId=0;readMdx(t){const i=t.index,e=t.readUint32();super.readMdx(t),this.speed=t.readFloat32(),this.variation=t.readFloat32(),this.latitude=t.readFloat32(),this.gravity=t.readFloat32(),this.lifeSpan=t.readFloat32(),this.emissionRate=t.readFloat32(),this.width=t.readFloat32(),this.length=t.readFloat32(),this.filterMode=t.readUint32(),this.rows=t.readUint32(),this.columns=t.readUint32(),this.headOrTail=t.readUint32(),this.tailLength=t.readFloat32(),this.timeMiddle=t.readFloat32(),t.readFloat32Array(this.segmentColors[0]),t.readFloat32Array(this.segmentColors[1]),t.readFloat32Array(this.segmentColors[2]),t.readUint8Array(this.segmentAlphas),t.readFloat32Array(this.segmentScaling),t.readUint32Array(this.headIntervals[0]),t.readUint32Array(this.headIntervals[1]),t.readUint32Array(this.tailIntervals[0]),t.readUint32Array(this.tailIntervals[1]),this.textureId=t.readInt32(),this.squirt=t.readUint32(),this.priorityPlane=t.readInt32(),this.replaceableId=t.readUint32(),this.readAnimations(t,e-(t.index-i))}writeMdx(t){t.writeUint32(this.getByteLength()),super.writeMdx(t),t.writeFloat32(this.speed),t.writeFloat32(this.variation),t.writeFloat32(this.latitude),t.writeFloat32(this.gravity),t.writeFloat32(this.lifeSpan),t.writeFloat32(this.emissionRate),t.writeFloat32(this.width),t.writeFloat32(this.length),t.writeUint32(this.filterMode),t.writeUint32(this.rows),t.writeUint32(this.columns),t.writeUint32(this.headOrTail),t.writeFloat32(this.tailLength),t.writeFloat32(this.timeMiddle),t.writeFloat32Array(this.segmentColors[0]),t.writeFloat32Array(this.segmentColors[1]),t.writeFloat32Array(this.segmentColors[2]),t.writeUint8Array(this.segmentAlphas),t.writeFloat32Array(this.segmentScaling),t.writeUint32Array(this.headIntervals[0]),t.writeUint32Array(this.headIntervals[1]),t.writeUint32Array(this.tailIntervals[0]),t.writeUint32Array(this.tailIntervals[1]),t.writeInt32(this.textureId),t.writeUint32(this.squirt),t.writeInt32(this.priorityPlane),t.writeUint32(this.replaceableId),this.writeNonGenericAnimationChunks(t)}readMdl(t){for(const i of super.readGenericBlock(t))if(i==="SortPrimsFarZ")this.flags|=65536;else if(i==="Unshaded")this.flags|=32768;else if(i==="LineEmitter")this.flags|=131072;else if(i==="Unfogged")this.flags|=262144;else if(i==="ModelSpace")this.flags|=524288;else if(i==="XYQuad")this.flags|=1048576;else if(i==="static Speed")this.speed=t.readFloat();else if(i==="Speed")this.readAnimation(t,"KP2S");else if(i==="static Variation")this.variation=t.readFloat();else if(i==="Variation")this.readAnimation(t,"KP2R");else if(i==="static Latitude")this.latitude=t.readFloat();else if(i==="Latitude")this.readAnimation(t,"KP2L");else if(i==="static Gravity")this.gravity=t.readFloat();else if(i==="Gravity")this.readAnimation(t,"KP2G");else if(i==="Visibility")this.readAnimation(t,"KP2V");else if(i==="Squirt")this.squirt=1;else if(i==="LifeSpan")this.lifeSpan=t.readFloat();else if(i==="static EmissionRate")this.emissionRate=t.readFloat();else if(i==="EmissionRate")this.readAnimation(t,"KP2E");else if(i==="static Width")this.width=t.readFloat();else if(i==="Width")this.readAnimation(t,"KP2N");else if(i==="static Length")this.length=t.readFloat();else if(i==="Length")this.readAnimation(t,"KP2W");else if(i==="Blend")this.filterMode=0;else if(i==="Additive")this.filterMode=1;else if(i==="Modulate")this.filterMode=2;else if(i==="Modulate2x")this.filterMode=3;else if(i==="AlphaKey")this.filterMode=4;else if(i==="Rows")this.rows=t.readInt();else if(i==="Columns")this.columns=t.readInt();else if(i==="Head")this.headOrTail=0;else if(i==="Tail")this.headOrTail=1;else if(i==="Both")this.headOrTail=2;else if(i==="TailLength")this.tailLength=t.readFloat();else if(i==="Time")this.timeMiddle=t.readFloat();else if(i==="SegmentColor"){t.read();for(let e=0;e<3;e++)t.read(),t.readColor(this.segmentColors[e]);t.read()}else if(i==="Alpha")t.readVector(this.segmentAlphas);else if(i==="ParticleScaling")t.readVector(this.segmentScaling);else if(i==="LifeSpanUVAnim")t.readVector(this.headIntervals[0]);else if(i==="DecayUVAnim")t.readVector(this.headIntervals[1]);else if(i==="TailUVAnim")t.readVector(this.tailIntervals[0]);else if(i==="TailDecayUVAnim")t.readVector(this.tailIntervals[1]);else if(i==="TextureID")this.textureId=t.readInt();else if(i==="ReplaceableId")this.replaceableId=t.readInt();else if(i==="PriorityPlane")this.priorityPlane=t.readInt();else throw new Error(`Unknown token in ParticleEmitter2: "${i}"`)}writeMdl(t){t.startObjectBlock("ParticleEmitter2",this.name),this.writeGenericHeader(t),this.flags&65536&&t.writeFlag("SortPrimsFarZ"),this.flags&32768&&t.writeFlag("Unshaded"),this.flags&131072&&t.writeFlag("LineEmitter"),this.flags&262144&&t.writeFlag("Unfogged"),this.flags&524288&&t.writeFlag("ModelSpace"),this.flags&1048576&&t.writeFlag("XYQuad"),this.writeAnimation(t,"KP2S")||t.writeNumberAttrib("static Speed",this.speed),this.writeAnimation(t,"KP2R")||t.writeNumberAttrib("static Variation",this.variation),this.writeAnimation(t,"KP2L")||t.writeNumberAttrib("static Latitude",this.latitude),this.writeAnimation(t,"KP2G")||t.writeNumberAttrib("static Gravity",this.gravity),this.writeAnimation(t,"KP2V"),this.squirt&&t.writeFlag("Squirt"),t.writeNumberAttrib("LifeSpan",this.lifeSpan),this.writeAnimation(t,"KP2E")||t.writeNumberAttrib("static EmissionRate",this.emissionRate),this.writeAnimation(t,"KP2N")||t.writeNumberAttrib("static Width",this.width),this.writeAnimation(t,"KP2W")||t.writeNumberAttrib("static Length",this.length),this.filterMode===0?t.writeFlag("Blend"):this.filterMode===1?t.writeFlag("Additive"):this.filterMode===2?t.writeFlag("Modulate"):this.filterMode===3?t.writeFlag("Modulate2x"):this.filterMode===4&&t.writeFlag("AlphaKey"),t.writeNumberAttrib("Rows",this.rows),t.writeNumberAttrib("Columns",this.columns),this.headOrTail===0?t.writeFlag("Head"):this.headOrTail===1?t.writeFlag("Tail"):this.headOrTail===2&&t.writeFlag("Both"),t.writeNumberAttrib("TailLength",this.tailLength),t.writeNumberAttrib("Time",this.timeMiddle),t.startBlock("SegmentColor"),t.writeColor("Color",this.segmentColors[0]),t.writeColor("Color",this.segmentColors[1]),t.writeColor("Color",this.segmentColors[2]),t.endBlockComma(),t.writeVectorAttrib("Alpha",this.segmentAlphas),t.writeVectorAttrib("ParticleScaling",this.segmentScaling),t.writeVectorAttrib("LifeSpanUVAnim",this.headIntervals[0]),t.writeVectorAttrib("DecayUVAnim",this.headIntervals[1]),t.writeVectorAttrib("TailUVAnim",this.tailIntervals[0]),t.writeVectorAttrib("TailDecayUVAnim",this.tailIntervals[1]),t.writeNumberAttrib("TextureID",this.textureId),this.replaceableId!==0&&t.writeNumberAttrib("ReplaceableId",this.replaceableId),this.priorityPlane!==0&&t.writeNumberAttrib("PriorityPlane",this.priorityPlane),this.writeGenericAnimations(t),t.endBlock()}getByteLength(){return 175+super.getByteLength()}}class lt extends g{lifeSpan=0;emissionRate=0;speed=0;color=new Float32Array(3);alpha=1;replaceableId=0;path="";animationVisiblityGuide="";readMdx(t){const i=t.index,e=t.readUint32();super.readMdx(t),this.lifeSpan=t.readFloat32(),this.emissionRate=t.readFloat32(),this.speed=t.readFloat32(),t.readFloat32Array(this.color),this.alpha=t.readFloat32(),this.replaceableId=t.readUint32(),this.path=t.read(260),this.animationVisiblityGuide=t.read(260),this.readAnimations(t,e-(t.index-i))}writeMdx(t){t.writeUint32(this.getByteLength()),super.writeMdx(t),t.writeFloat32(this.lifeSpan),t.writeFloat32(this.emissionRate),t.writeFloat32(this.speed),t.writeFloat32Array(this.color),t.writeFloat32(this.alpha),t.writeUint32(this.replaceableId),t.skip(260-t.write(this.path)),t.skip(260-t.write(this.animationVisiblityGuide)),this.writeNonGenericAnimationChunks(t)}readMdl(t){for(const i of super.readGenericBlock(t))if(i==="SortPrimsFarZ")this.flags|=65536;else if(i==="Unshaded")this.flags|=32768;else if(i==="Unfogged")this.flags|=262144;else if(i==="static LifeSpan")this.lifeSpan=t.readFloat();else if(i==="LifeSpan")this.readAnimation(t,"KPPL");else if(i==="static EmissionRate")this.emissionRate=t.readFloat();else if(i==="EmissionRate")this.readAnimation(t,"KPPE");else if(i==="static Speed")this.speed=t.readFloat();else if(i==="Speed")this.readAnimation(t,"KPPS");else if(i==="static Color")t.readVector(this.color);else if(i==="Color")this.readAnimation(t,"KPPC");else if(i==="static Alpha")this.alpha=t.readFloat();else if(i==="Alpha")this.readAnimation(t,"KPPA");else if(i==="Visibility")this.readAnimation(t,"KPPV");else if(i==="ReplaceableId")this.replaceableId=t.readInt();else if(i==="Path")this.path=t.read();else if(i==="AnimVisibilityGuide")this.animationVisiblityGuide=t.read();else throw new Error(`Unknown token in ParticleEmitterPopcorn: "${i}"`)}writeMdl(t){t.startObjectBlock("ParticleEmitterPopcorn",this.name),this.writeGenericHeader(t),this.flags&65536&&t.writeFlag("SortPrimsFarZ"),this.flags&32768&&t.writeFlag("Unshaded"),this.flags&262144&&t.writeFlag("Unfogged"),this.writeAnimation(t,"KPPL")||t.writeNumberAttrib("static LifeSpan",this.lifeSpan),this.writeAnimation(t,"KPPE")||t.writeNumberAttrib("static EmissionRate",this.emissionRate),this.writeAnimation(t,"KPPS")||t.writeNumberAttrib("static Speed",this.speed),this.writeAnimation(t,"KPPC")||t.writeVectorAttrib("static Color",this.color),this.writeAnimation(t,"KPPA")||t.writeNumberAttrib("static Alpha",this.alpha),this.writeAnimation(t,"KPPV"),this.replaceableId!==0&&t.writeNumberAttrib("ReplaceableId",this.replaceableId),this.path.length&&t.writeStringAttrib("Path",this.path),this.animationVisiblityGuide.length&&t.writeStringAttrib("AnimVisibilityGuide",this.animationVisiblityGuide),this.writeGenericAnimations(t),t.endBlock()}getByteLength(){return 556+super.getByteLength()}}class ht extends g{heightAbove=0;heightBelow=0;alpha=0;color=new Float32Array(3);lifeSpan=0;textureSlot=0;emissionRate=0;rows=0;columns=0;materialId=0;gravity=0;constructor(){super(16384)}readMdx(t){const i=t.index,e=t.readUint32();super.readMdx(t),this.heightAbove=t.readFloat32(),this.heightBelow=t.readFloat32(),this.alpha=t.readFloat32(),t.readFloat32Array(this.color),this.lifeSpan=t.readFloat32(),this.textureSlot=t.readUint32(),this.emissionRate=t.readUint32(),this.rows=t.readUint32(),this.columns=t.readUint32(),this.materialId=t.readInt32(),this.gravity=t.readFloat32(),this.readAnimations(t,e-(t.index-i))}writeMdx(t){t.writeUint32(this.getByteLength()),super.writeMdx(t),t.writeFloat32(this.heightAbove),t.writeFloat32(this.heightBelow),t.writeFloat32(this.alpha),t.writeFloat32Array(this.color),t.writeFloat32(this.lifeSpan),t.writeUint32(this.textureSlot),t.writeUint32(this.emissionRate),t.writeUint32(this.rows),t.writeUint32(this.columns),t.writeInt32(this.materialId),t.writeFloat32(this.gravity),this.writeNonGenericAnimationChunks(t)}readMdl(t){for(const i of super.readGenericBlock(t))if(i==="static HeightAbove")this.heightAbove=t.readFloat();else if(i==="HeightAbove")this.readAnimation(t,"KRHA");else if(i==="static HeightBelow")this.heightBelow=t.readFloat();else if(i==="HeightBelow")this.readAnimation(t,"KRHB");else if(i==="static Alpha")this.alpha=t.readFloat();else if(i==="Alpha")this.readAnimation(t,"KRAL");else if(i==="static Color")t.readColor(this.color);else if(i==="Color")this.readAnimation(t,"KRCO");else if(i==="static TextureSlot")this.textureSlot=t.readInt();else if(i==="TextureSlot")this.readAnimation(t,"KRTX");else if(i==="Visibility")this.readAnimation(t,"KRVS");else if(i==="EmissionRate")this.emissionRate=t.readInt();else if(i==="LifeSpan")this.lifeSpan=t.readFloat();else if(i==="Gravity")this.gravity=t.readFloat();else if(i==="Rows")this.rows=t.readInt();else if(i==="Columns")this.columns=t.readInt();else if(i==="MaterialID")this.materialId=t.readInt();else throw new Error(`Unknown token in RibbonEmitter: "${i}"`)}writeMdl(t){t.startObjectBlock("RibbonEmitter",this.name),this.writeGenericHeader(t),this.writeAnimation(t,"KRHA")||t.writeNumberAttrib("static HeightAbove",this.heightAbove),this.writeAnimation(t,"KRHB")||t.writeNumberAttrib("static HeightBelow",this.heightBelow),this.writeAnimation(t,"KRAL")||t.writeNumberAttrib("static Alpha",this.alpha),this.writeAnimation(t,"KRCO")||t.writeColor("static Color",this.color),this.writeAnimation(t,"KRTX")||t.writeNumberAttrib("static TextureSlot",this.textureSlot),this.writeAnimation(t,"KRVS"),t.writeNumberAttrib("EmissionRate",this.emissionRate),t.writeNumberAttrib("LifeSpan",this.lifeSpan),this.gravity!==0&&t.writeNumberAttrib("Gravity",this.gravity),t.writeNumberAttrib("Rows",this.rows),t.writeNumberAttrib("Columns",this.columns),t.writeNumberAttrib("MaterialID",this.materialId),this.writeGenericAnimations(t),t.endBlock()}getByteLength(){return 56+super.getByteLength()}}class dt extends p{name="";position=new Float32Array(3);fieldOfView=0;farClippingPlane=0;nearClippingPlane=0;targetPosition=new Float32Array(3);readMdx(t){const i=t.readUint32();this.name=t.read(80),t.readFloat32Array(this.position),this.fieldOfView=t.readFloat32(),this.farClippingPlane=t.readFloat32(),this.nearClippingPlane=t.readFloat32(),t.readFloat32Array(this.targetPosition),this.readAnimations(t,i-120)}writeMdx(t){t.writeUint32(this.getByteLength()),t.skip(80-t.write(this.name)),t.writeFloat32Array(this.position),t.writeFloat32(this.fieldOfView),t.writeFloat32(this.farClippingPlane),t.writeFloat32(this.nearClippingPlane),t.writeFloat32Array(this.targetPosition),this.writeAnimations(t)}readMdl(t){this.name=t.read();for(let i of t.readBlock())if(i==="Position")t.readVector(this.position);else if(i==="Translation")this.readAnimation(t,"KCTR");else if(i==="Rotation")this.readAnimation(t,"KCRL");else if(i==="FieldOfView")this.fieldOfView=t.readFloat();else if(i==="FarClip")this.farClippingPlane=t.readFloat();else if(i==="NearClip")this.nearClippingPlane=t.readFloat();else if(i==="Target")for(i of t.readBlock())if(i==="Position")t.readVector(this.targetPosition);else if(i==="Translation")this.readAnimation(t,"KTTR");else throw new Error(`Unknown token in Camera ${this.name}'s Target: "${i}"`);else throw new Error(`Unknown token in Camera ${this.name}: "${i}"`)}writeMdl(t){t.startObjectBlock("Camera",this.name),t.writeVectorAttrib("Position",this.position),this.writeAnimation(t,"KCTR"),this.writeAnimation(t,"KCRL"),t.writeNumberAttrib("FieldOfView",this.fieldOfView),t.writeNumberAttrib("FarClip",this.farClippingPlane),t.writeNumberAttrib("NearClip",this.nearClippingPlane),t.startBlock("Target"),t.writeVectorAttrib("Position",this.targetPosition),this.writeAnimation(t,"KTTR"),t.endBlock(),t.endBlock()}getByteLength(){return 120+super.getByteLength()}}class ct extends g{globalSequenceId=-1;tracks=new Uint32Array(0);constructor(){super(1024)}readMdx(t){super.readMdx(t),t.skip(4);const i=t.readUint32();this.globalSequenceId=t.readInt32(),this.tracks=t.readUint32Array(i)}writeMdx(t){super.writeMdx(t),t.writeBinary("KEVT"),t.writeUint32(this.tracks.length),t.writeInt32(this.globalSequenceId),t.writeUint32Array(this.tracks)}readMdl(t){for(const i of super.readGenericBlock(t))if(i==="EventTrack"){const e=t.readInt();this.tracks=new Uint32Array(e),t.read(),t.peek()==="GlobalSeqId"&&(t.read(),this.globalSequenceId=t.readInt());for(let n=0;n<e;n++)this.tracks[n]=t.readInt();t.read()}else throw new Error(`Unknown token in EventObject: "${i}"`)}writeMdl(t){t.startObjectBlock("EventObject",this.name),this.writeGenericHeader(t),t.startBlock("EventTrack",this.tracks.length),this.globalSequenceId!==-1&&t.writeNumberAttrib("GlobalSeqId",this.globalSequenceId);for(const i of this.tracks)t.writeFlag(`${i}`);t.endBlock(),this.writeGenericAnimations(t),t.endBlock()}getByteLength(){return 12+this.tracks.byteLength+super.getByteLength()}}class ft extends g{type=0;vertices=[new Float32Array(3),new Float32Array(3)];boundsRadius=0;constructor(){super(8192)}readMdx(t){super.readMdx(t),this.type=t.readUint32(),t.readFloat32Array(this.vertices[0]),this.type!==2&&t.readFloat32Array(this.vertices[1]),(this.type===2||this.type===3)&&(this.boundsRadius=t.readFloat32())}writeMdx(t){super.writeMdx(t),t.writeUint32(this.type),t.writeFloat32Array(this.vertices[0]),this.type!==2&&t.writeFloat32Array(this.vertices[1]),(this.type===2||this.type===3)&&t.writeFloat32(this.boundsRadius)}readMdl(t){for(const i of super.readGenericBlock(t))if(i==="Box")this.type=0;else if(i==="Plane")this.type=1;else if(i==="Sphere")this.type=2;else if(i==="Cylinder")this.type=3;else if(i==="Vertices"){const e=t.readInt();t.read(),t.readVector(this.vertices[0]),e===2&&t.readVector(this.vertices[1]),t.read()}else if(i==="BoundsRadius")this.boundsRadius=t.readFloat();else throw new Error(`Unknown token in CollisionShape: "${i}"`)}writeMdl(t){t.startObjectBlock("CollisionShape",this.name),this.writeGenericHeader(t);let i="",e=2,n=!1;this.type===0?i="Box":this.type===1?i="Plane":this.type===2?(i="Sphere",e=1,n=!0):this.type===3&&(i="Cylinder",n=!0),t.writeFlag(i),t.startBlock("Vertices",e),t.writeVector(this.vertices[0]),e===2&&t.writeVector(this.vertices[1]),t.endBlock(),n&&t.writeNumberAttrib("BoundsRadius",this.boundsRadius),this.writeGenericAnimations(t),t.endBlock()}getByteLength(){let t=16+super.getByteLength();return this.type!==2&&(t+=12),(this.type===2||this.type===3)&&(t+=4),t}}class ut{type="";path="";readMdx(t){this.type=t.read(80),this.path=t.read(260)}writeMdx(t){t.skip(80-t.write(this.type)),t.skip(260-t.write(this.path))}readMdl(t){this.type=t.read();for(const i of t.readBlock())if(i==="Path")this.path=t.read();else throw new Error(`Unknown token in FaceEffect: "${i}"`)}writeMdl(t){t.startObjectBlock("FaceFX",this.type),t.writeStringAttrib("Path",this.path),t.endBlock()}}class Ft{tag;chunk;constructor(t,i,e){this.tag=e,this.chunk=t.readUint8Array(new Uint8Array(i))}writeMdx(t){t.writeBinary(this.tag),t.writeUint32(this.chunk.byteLength),t.writeUint8Array(this.chunk)}getByteLength(){return 8+this.chunk.byteLength}}function It(r){return r instanceof ArrayBuffer&&(r=new Uint8Array(r)),!!(r instanceof Uint8Array&&r[0]===77&&r[1]===68&&r[2]===76&&r[3]===88||typeof r=="string"&&r.startsWith("MDLX"))}function Mt(r){return r instanceof ArrayBuffer&&(r=new Uint8Array(r)),!!(r instanceof Uint8Array&&pt(r,"FormatVersion",0,4096)||typeof r=="string"&&bt(r,"FormatVersion",0,4096))}class Ut{version=800;name="";animationFile="";extent=new A;blendTime=0;sequences=[];globalSequences=[];materials=[];textures=[];textureAnimations=[];geosets=[];geosetAnimations=[];bones=[];lights=[];helpers=[];attachments=[];pivotPoints=[];particleEmitters=[];particleEmitters2=[];particleEmittersPopcorn=[];ribbonEmitters=[];cameras=[];eventObjects=[];collisionShapes=[];faceEffects=[];bindPose=[];unknownChunks=[];load(t){if(It(t))typeof t=="string"&&(t=F(t)),this.loadMdx(t);else if(Mt(t))typeof t!="string"&&(t=B(t)),this.loadMdl(t);else throw new Error("Not a valid MDX/MDL buffer")}loadMdx(t){const i=new x(t);let e,n;for(i.skip(4);i.remaining>0;)e=i.readBinary(4),n=i.readUint32(),e==="VERS"?this.loadVersionChunk(i):e==="MODL"?this.loadModelChunk(i):e==="SEQS"?this.loadStaticObjects(this.sequences,Z,i,n/132):e==="GLBS"?this.loadGlobalSequenceChunk(i,n):e==="MTLS"?this.loadDynamicObjects(this.materials,_,i,n):e==="TEXS"?this.loadStaticObjects(this.textures,J,i,n/268):e==="TXAN"?this.loadDynamicObjects(this.textureAnimations,m,i,n):e==="GEOS"?this.loadDynamicObjects(this.geosets,tt,i,n):e==="GEOA"?this.loadDynamicObjects(this.geosetAnimations,it,i,n):e==="BONE"?this.loadDynamicObjects(this.bones,et,i,n):e==="LITE"?this.loadDynamicObjects(this.lights,nt,i,n):e==="HELP"?this.loadDynamicObjects(this.helpers,rt,i,n):e==="ATCH"?this.loadDynamicObjects(this.attachments,st,i,n):e==="PIVT"?this.loadPivotPointChunk(i,n):e==="PREM"?this.loadDynamicObjects(this.particleEmitters,ot,i,n):e==="PRE2"?this.loadDynamicObjects(this.particleEmitters2,at,i,n):e==="CORN"?this.loadDynamicObjects(this.particleEmittersPopcorn,lt,i,n):e==="RIBB"?this.loadDynamicObjects(this.ribbonEmitters,ht,i,n):e==="CAMS"?this.loadDynamicObjects(this.cameras,dt,i,n):e==="EVTS"?this.loadDynamicObjects(this.eventObjects,ct,i,n):e==="CLID"?this.loadDynamicObjects(this.collisionShapes,ft,i,n):e==="FAFX"?this.loadStaticObjects(this.faceEffects,ut,i,n/340):e==="BPOS"?this.loadBindPoseChunk(i,n):this.unknownChunks.push(new Ft(i,n,e))}loadVersionChunk(t){this.version=t.readUint32()}loadModelChunk(t){this.name=t.read(80),this.animationFile=t.read(260),this.extent.readMdx(t),this.blendTime=t.readUint32()}loadStaticObjects(t,i,e,n){for(let o=0;o<n;o++){const s=new i;s.readMdx(e),t.push(s)}}loadGlobalSequenceChunk(t,i){for(let e=0,n=i/4;e<n;e++)this.globalSequences.push(t.readUint32())}loadDynamicObjects(t,i,e,n){const o=e.index+n;for(;e.index<o;){const s=new i;s.readMdx(e,this.version),t.push(s)}}loadPivotPointChunk(t,i){for(let e=0,n=i/12;e<n;e++)this.pivotPoints.push(t.readFloat32Array(3))}loadBindPoseChunk(t,i){for(let e=0,n=t.readUint32();e<n;e++)this.bindPose[e]=t.readFloat32Array(12)}saveMdx(){const t=new x(new ArrayBuffer(this.getByteLength()));t.writeBinary("MDLX"),this.saveVersionChunk(t),this.saveModelChunk(t),this.saveStaticObjectChunk(t,"SEQS",this.sequences,132),this.saveGlobalSequenceChunk(t),this.saveDynamicObjectChunk(t,"MTLS",this.materials),this.saveStaticObjectChunk(t,"TEXS",this.textures,268),this.saveDynamicObjectChunk(t,"TXAN",this.textureAnimations),this.saveDynamicObjectChunk(t,"GEOS",this.geosets),this.saveDynamicObjectChunk(t,"GEOA",this.geosetAnimations),this.saveDynamicObjectChunk(t,"BONE",this.bones),this.saveDynamicObjectChunk(t,"LITE",this.lights),this.saveDynamicObjectChunk(t,"HELP",this.helpers),this.saveDynamicObjectChunk(t,"ATCH",this.attachments),this.savePivotPointChunk(t),this.saveDynamicObjectChunk(t,"PREM",this.particleEmitters),this.saveDynamicObjectChunk(t,"PRE2",this.particleEmitters2),this.version>800&&this.saveDynamicObjectChunk(t,"CORN",this.particleEmittersPopcorn),this.saveDynamicObjectChunk(t,"RIBB",this.ribbonEmitters),this.saveDynamicObjectChunk(t,"CAMS",this.cameras),this.saveDynamicObjectChunk(t,"EVTS",this.eventObjects),this.saveDynamicObjectChunk(t,"CLID",this.collisionShapes),this.version>800&&(this.saveStaticObjectChunk(t,"FAFX",this.faceEffects,340),this.saveBindPoseChunk(t));for(const i of this.unknownChunks)i.writeMdx(t);return t.uint8array}saveVersionChunk(t){t.writeBinary("VERS"),t.writeUint32(4),t.writeUint32(this.version)}saveModelChunk(t){t.writeBinary("MODL"),t.writeUint32(372),t.skip(80-t.write(this.name)),t.skip(260-t.write(this.animationFile)),this.extent.writeMdx(t),t.writeUint32(this.blendTime)}saveStaticObjectChunk(t,i,e,n){if(e.length){t.writeBinary(i),t.writeUint32(e.length*n);for(const o of e)o.writeMdx(t)}}saveGlobalSequenceChunk(t){if(this.globalSequences.length){t.writeBinary("GLBS"),t.writeUint32(this.globalSequences.length*4);for(const i of this.globalSequences)t.writeUint32(i)}}saveDynamicObjectChunk(t,i,e){if(e.length){t.writeBinary(i),t.writeUint32(this.getObjectsByteLength(e));for(const n of e)n.writeMdx(t,this.version)}}savePivotPointChunk(t){if(this.pivotPoints.length){t.writeBinary("PIVT"),t.writeUint32(this.pivotPoints.length*12);for(const i of this.pivotPoints)t.writeFloat32Array(i)}}saveBindPoseChunk(t){if(this.bindPose.length){t.writeBinary("BPOS"),t.writeUint32(4+this.bindPose.length*48),t.writeUint32(this.bindPose.length);for(const i of this.bindPose)t.writeFloat32Array(i)}}loadMdl(t){let i;const e=new W(t);for(;i=e.readToken();)if(i==="Version")this.loadVersionBlock(e);else if(i==="Model")this.loadModelBlock(e);else if(i==="Sequences")this.loadNumberedObjectBlock(this.sequences,Z,"Anim",e);else if(i==="GlobalSequences")this.loadGlobalSequenceBlock(e);else if(i==="Textures")this.loadNumberedObjectBlock(this.textures,J,"Bitmap",e);else if(i==="Materials")this.loadNumberedObjectBlock(this.materials,_,"Material",e);else if(i==="TextureAnims")this.loadNumberedObjectBlock(this.textureAnimations,m,"TVertexAnim",e);else if(i==="Geoset")this.loadObject(this.geosets,tt,e);else if(i==="GeosetAnim")this.loadObject(this.geosetAnimations,it,e);else if(i==="Bone")this.loadObject(this.bones,et,e);else if(i==="Light")this.loadObject(this.lights,nt,e);else if(i==="Helper")this.loadObject(this.helpers,rt,e);else if(i==="Attachment")this.loadObject(this.attachments,st,e);else if(i==="PivotPoints")this.loadPivotPointBlock(e);else if(i==="ParticleEmitter")this.loadObject(this.particleEmitters,ot,e);else if(i==="ParticleEmitter2")this.loadObject(this.particleEmitters2,at,e);else if(i==="ParticleEmitterPopcorn")this.loadObject(this.particleEmittersPopcorn,lt,e);else if(i==="RibbonEmitter")this.loadObject(this.ribbonEmitters,ht,e);else if(i==="Camera")this.loadObject(this.cameras,dt,e);else if(i==="EventObject")this.loadObject(this.eventObjects,ct,e);else if(i==="CollisionShape")this.loadObject(this.collisionShapes,ft,e);else if(i==="FaceFX")this.loadObject(this.faceEffects,ut,e);else if(i==="BindPose")this.loadBindPoseBlock(e);else throw new Error(`Unsupported block: ${i}`)}loadVersionBlock(t){for(const i of t.readBlock())if(i==="FormatVersion")this.version=t.readInt();else throw new Error(`Unknown token in Version: "${i}"`)}loadModelBlock(t){this.name=t.read();for(const i of t.readBlock())if(i.startsWith("Num"))t.read();else if(i==="BlendTime")this.blendTime=t.readInt();else if(i==="MinimumExtent")t.readVector(this.extent.min);else if(i==="MaximumExtent")t.readVector(this.extent.max);else if(i==="BoundsRadius")this.extent.boundsRadius=t.readFloat();else if(i==="AnimationFile")this.animationFile=t.read();else throw new Error(`Unknown token in Model: "${i}"`)}loadNumberedObjectBlock(t,i,e,n){n.read();for(const o of n.readBlock())if(o===e){const s=new i;s.readMdl(n),t.push(s)}else throw new Error(`Unknown token in ${e}: "${o}"`)}loadGlobalSequenceBlock(t){t.read();for(const i of t.readBlock())if(i==="Duration")this.globalSequences.push(t.readInt());else throw new Error(`Unknown token in GlobalSequences: "${i}"`)}loadObject(t,i,e){const n=new i;n.readMdl(e),t.push(n)}loadPivotPointBlock(t){const i=t.readInt();t.read();for(let e=0;e<i;e++)this.pivotPoints.push(t.readVector(new Float32Array(3)));t.read()}loadBindPoseBlock(t){for(const i of t.readBlock())if(i==="Matrices"){const e=t.readInt();t.read();for(let n=0;n<e;n++)this.bindPose[n]=t.readVector(new Float32Array(12));t.read()}else throw new Error(`Unknown token in BindPose: "${i}"`)}saveMdl(){const t=new W;return this.saveVersionBlock(t),this.saveModelBlock(t),this.saveStaticObjectsBlock(t,"Sequences",this.sequences),this.saveGlobalSequenceBlock(t),this.saveStaticObjectsBlock(t,"Textures",this.textures),this.saveStaticObjectsBlock(t,"Materials",this.materials),this.saveStaticObjectsBlock(t,"TextureAnims",this.textureAnimations),this.saveObjects(t,this.geosets),this.saveObjects(t,this.geosetAnimations),this.saveObjects(t,this.bones),this.saveObjects(t,this.lights),this.saveObjects(t,this.helpers),this.saveObjects(t,this.attachments),this.savePivotPointBlock(t),this.saveObjects(t,this.particleEmitters),this.saveObjects(t,this.particleEmitters2),this.version>800&&this.saveObjects(t,this.particleEmittersPopcorn),this.saveObjects(t,this.ribbonEmitters),this.saveObjects(t,this.cameras),this.saveObjects(t,this.eventObjects),this.saveObjects(t,this.collisionShapes),this.version>800&&(this.saveObjects(t,this.faceEffects),this.saveBindPoseBlock(t)),t.buffer}saveVersionBlock(t){t.startBlock("Version"),t.writeNumberAttrib("FormatVersion",this.version),t.endBlock()}saveModelBlock(t){t.startObjectBlock("Model",this.name),t.writeNumberAttrib("BlendTime",this.blendTime),this.extent.writeMdl(t),this.animationFile.length&&t.writeStringAttrib("AnimationFile",this.animationFile),t.endBlock()}saveStaticObjectsBlock(t,i,e){if(e.length){t.startBlock(i,e.length);for(const n of e)n.writeMdl(t,this.version);t.endBlock()}}saveGlobalSequenceBlock(t){if(this.globalSequences.length){t.startBlock("GlobalSequences",this.globalSequences.length);for(const i of this.globalSequences)t.writeNumberAttrib("Duration",i);t.endBlock()}}saveObjects(t,i){for(const e of i)e.writeMdl(t,this.version)}savePivotPointBlock(t){if(this.pivotPoints.length){t.startBlock("PivotPoints",this.pivotPoints.length);for(const i of this.pivotPoints)t.writeVector(i);t.endBlock()}}saveBindPoseBlock(t){if(this.bindPose.length){t.startBlock("BindPose"),t.startBlock("Matrices",this.bindPose.length);for(const i of this.bindPose)t.writeVector(i);t.endBlock(),t.endBlock()}}getByteLength(){let t=396;return t+=this.getStaticObjectsChunkByteLength(this.sequences,132),t+=this.getStaticObjectsChunkByteLength(this.globalSequences,4),t+=this.getDynamicObjectsChunkByteLength(this.materials),t+=this.getStaticObjectsChunkByteLength(this.textures,268),t+=this.getDynamicObjectsChunkByteLength(this.textureAnimations),t+=this.getDynamicObjectsChunkByteLength(this.geosets),t+=this.getDynamicObjectsChunkByteLength(this.geosetAnimations),t+=this.getDynamicObjectsChunkByteLength(this.bones),t+=this.getDynamicObjectsChunkByteLength(this.lights),t+=this.getDynamicObjectsChunkByteLength(this.helpers),t+=this.getDynamicObjectsChunkByteLength(this.attachments),t+=this.getStaticObjectsChunkByteLength(this.pivotPoints,12),t+=this.getDynamicObjectsChunkByteLength(this.particleEmitters),t+=this.getDynamicObjectsChunkByteLength(this.particleEmitters2),this.version>800&&(t+=this.getDynamicObjectsChunkByteLength(this.particleEmittersPopcorn)),t+=this.getDynamicObjectsChunkByteLength(this.ribbonEmitters),t+=this.getDynamicObjectsChunkByteLength(this.cameras),t+=this.getDynamicObjectsChunkByteLength(this.eventObjects),t+=this.getDynamicObjectsChunkByteLength(this.collisionShapes),this.version>800&&(t+=this.getStaticObjectsChunkByteLength(this.faceEffects,340),t+=this.getBindPoseChunkByteLength()),t+=this.getObjectsByteLength(this.unknownChunks),t}getObjectsByteLength(t){let i=0;for(const e of t)i+=e.getByteLength(this.version);return i}getDynamicObjectsChunkByteLength(t){return t.length?8+this.getObjectsByteLength(t):0}getStaticObjectsChunkByteLength(t,i){return t.length?8+t.length*i:0}getBindPoseChunkByteLength(){return this.bindPose.length?12+this.bindPose.length*48:0}}console.log("Viewer version",wt),document.addEventListener("dragover",r=>{r.preventDefault()}),document.addEventListener("dragend",r=>{r.preventDefault()}),document.addEventListener("drop",r=>{r.preventDefault();for(let t of r.dataTransfer.files){let i=t.name,e=b(i);if(e===".mdx"||e===".mdl"){let n=new FileReader;n.addEventListener("loadend",o=>{let s=new Ut;s.load(o.target.result);let c,d;e===".mdl"?(c=s.saveMdx().buffer,d="application/octet-stream",e="mdx"):(c=s.saveMdl(),d="text/plain",e="mdl"),saveAs(new Blob([c],{type:d}),i.slice(0,-3)+e)}),e===".mdl"?n.readAsText(t):n.readAsArrayBuffer(t)}}})}));
